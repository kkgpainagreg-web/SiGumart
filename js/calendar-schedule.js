// js/calendar-schedule.js
// =====================================================
// KALENDER PENDIDIKAN & JADWAL PELAJARAN
// Dengan fitur kolaborasi dan validasi bentrok
// =====================================================

const CalendarSchedule = {
    calendarEvents: [],
    scheduleData: [],
    selectedMonth: new Date().getMonth(),
    selectedYear: new Date().getFullYear(),

    init: async () => {
        CalendarSchedule.renderCalendar();
        CalendarSchedule.renderSchedule();
        await CalendarSchedule.loadCalendarEvents();
        await CalendarSchedule.loadSchedule();
    },

    // ==================== KALENDER PENDIDIKAN ====================
    renderCalendar: () => {
        const container = document.getElementById('tab-calendar');
        container.innerHTML = `
            <div class="space-y-6">
                <!-- Header -->
                <div class="bg-white rounded-xl shadow p-6">
                    <div class="flex flex-wrap justify-between items-center gap-4">
                        <div class="flex items-center gap-4">
                            <button onclick="CalendarSchedule.prevMonth()" class="p-2 hover:bg-gray-100 rounded-lg">
                                ‚óÄÔ∏è
                            </button>
                            <h3 id="calendar-title" class="text-xl font-semibold"></h3>
                            <button onclick="CalendarSchedule.nextMonth()" class="p-2 hover:bg-gray-100 rounded-lg">
                                ‚ñ∂Ô∏è
                            </button>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="CalendarSchedule.showAddEventModal()" 
                                class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700">
                                ‚ûï Tambah Kegiatan
                            </button>
                            <button onclick="CalendarSchedule.printCalendar()" 
                                class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                üñ®Ô∏è Cetak
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">
                        üìå Kalender ini dapat dilihat oleh semua guru di sekolah dengan NPSN yang sama
                    </p>
                </div>

                <!-- Calendar Grid -->
                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <!-- Day Headers -->
                    <div class="grid grid-cols-7 bg-gray-50 border-b">
                        ${['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'].map(day => `
                            <div class="py-3 text-center text-sm font-medium text-gray-600 ${day === 'Min' ? 'text-red-500' : ''}">${day}</div>
                        `).join('')}
                    </div>
                    <!-- Calendar Days -->
                    <div id="calendar-grid" class="grid grid-cols-7">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <!-- Legend -->
                <div class="bg-white rounded-xl shadow p-4">
                    <h4 class="font-medium mb-3">Keterangan:</h4>
                    <div class="flex flex-wrap gap-4 text-sm">
                        <span class="flex items-center"><span class="w-4 h-4 bg-red-200 rounded mr-2"></span> Libur</span>
                        <span class="flex items-center"><span class="w-4 h-4 bg-blue-200 rounded mr-2"></span> Kegiatan Sekolah</span>
                        <span class="flex items-center"><span class="w-4 h-4 bg-green-200 rounded mr-2"></span> Ujian/Penilaian</span>
                        <span class="flex items-center"><span class="w-4 h-4 bg-yellow-200 rounded mr-2"></span> Pembagian Rapor</span>
                        <span class="flex items-center"><span class="w-4 h-4 bg-purple-200 rounded mr-2"></span> Lainnya</span>
                    </div>
                </div>

                <!-- Events List -->
                <div class="bg-white rounded-xl shadow p-6">
                    <h4 class="font-semibold mb-4">üìÖ Daftar Kegiatan Bulan Ini</h4>
                    <div id="events-list" class="space-y-2">
                        <p class="text-gray-400 text-center py-4">Tidak ada kegiatan</p>
                    </div>
                </div>

                <!-- Print Template -->
                <div id="calendar-print-template" class="hidden print-only">
                    <div class="doc-header">
                        <h1>KALENDER PENDIDIKAN</h1>
                        <p id="calendar-print-school"></p>
                        <p id="calendar-print-tahun"></p>
                    </div>
                    <div id="calendar-print-content"></div>
                </div>
            </div>

            <!-- Add Event Modal -->
            <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Tambah Kegiatan</h3>
                        <button onclick="CalendarSchedule.closeEventModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                    </div>
                    <form id="event-form" class="space-y-4">
                        <input type="hidden" id="event-edit-id">
                        <div>
                            <label class="block text-sm font-medium mb-1">Nama Kegiatan</label>
                            <input type="text" id="event-nama" required class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">Tanggal Mulai</label>
                                <input type="date" id="event-start" required class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Tanggal Selesai</label>
                                <input type="date" id="event-end" required class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Jenis Kegiatan</label>
                            <select id="event-type" required class="w-full px-3 py-2 border rounded-lg">
                                <option value="libur">Libur</option>
                                <option value="kegiatan">Kegiatan Sekolah</option>
                                <option value="ujian">Ujian/Penilaian</option>
                                <option value="rapor">Pembagian Rapor</option>
                                <option value="lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Keterangan</label>
                            <textarea id="event-desc" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
                        </div>
                        <div class="flex justify-end space-x-3 pt-2">
                            <button type="button" onclick="CalendarSchedule.closeEventModal()" 
                                class="px-4 py-2 border rounded-lg">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        document.getElementById('event-form').addEventListener('submit', CalendarSchedule.saveEvent);
        CalendarSchedule.renderCalendarGrid();
    },

    renderCalendarGrid: () => {
        const title = document.getElementById('calendar-title');
        title.textContent = `${Utils.getMonthName(CalendarSchedule.selectedMonth)} ${CalendarSchedule.selectedYear}`;

        const grid = document.getElementById('calendar-grid');
        const firstDay = new Date(CalendarSchedule.selectedYear, CalendarSchedule.selectedMonth, 1);
        const lastDay = new Date(CalendarSchedule.selectedYear, CalendarSchedule.selectedMonth + 1, 0);
        const startDayOfWeek = firstDay.getDay();
        const daysInMonth = lastDay.getDate();

        let html = '';
        
        // Empty cells before first day
        for (let i = 0; i < startDayOfWeek; i++) {
            html += '<div class="min-h-24 p-2 border-b border-r bg-gray-50"></div>';
        }

        // Days of month
        for (let day = 1; day <= daysInMonth; day++) {
            const currentDate = new Date(CalendarSchedule.selectedYear, CalendarSchedule.selectedMonth, day);
            const dateStr = currentDate.toISOString().split('T')[0];
            const dayOfWeek = currentDate.getDay();
            const isSunday = dayOfWeek === 0;
            
            // Get events for this day
            const dayEvents = CalendarSchedule.calendarEvents.filter(e => {
                const start = new Date(e.startDate);
                const end = new Date(e.endDate);
                return currentDate >= start && currentDate <= end;
            });

            const eventColors = {
                libur: 'bg-red-200',
                kegiatan: 'bg-blue-200',
                ujian: 'bg-green-200',
                rapor: 'bg-yellow-200',
                lainnya: 'bg-purple-200'
            };

            html += `
                <div class="min-h-24 p-2 border-b border-r hover:bg-gray-50 cursor-pointer ${isSunday ? 'bg-red-50' : ''}" 
                    onclick="CalendarSchedule.showDayDetail('${dateStr}')">
                    <div class="font-medium ${isSunday ? 'text-red-500' : ''}">${day}</div>
                    <div class="space-y-1 mt-1">
                        ${dayEvents.slice(0, 3).map(e => `
                            <div class="text-xs px-1 py-0.5 rounded truncate ${eventColors[e.type] || 'bg-gray-200'}" 
                                title="${e.nama}">
                                ${e.nama}
                            </div>
                        `).join('')}
                        ${dayEvents.length > 3 ? `<div class="text-xs text-gray-500">+${dayEvents.length - 3} lainnya</div>` : ''}
                    </div>
                </div>
            `;
        }

        // Empty cells after last day
        const remainingCells = (7 - ((startDayOfWeek + daysInMonth) % 7)) % 7;
        for (let i = 0; i < remainingCells; i++) {
            html += '<div class="min-h-24 p-2 border-b border-r bg-gray-50"></div>';
        }

        grid.innerHTML = html;
        CalendarSchedule.renderEventsList();
    },

    renderEventsList: () => {
        const container = document.getElementById('events-list');
        const monthEvents = CalendarSchedule.calendarEvents.filter(e => {
            const start = new Date(e.startDate);
            return start.getMonth() === CalendarSchedule.selectedMonth && 
                   start.getFullYear() === CalendarSchedule.selectedYear;
        });

        if (monthEvents.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-center py-4">Tidak ada kegiatan bulan ini</p>';
            return;
        }

        container.innerHTML = monthEvents.map(e => {
            const isOwner = e.userId === Auth.currentUser.uid;
            return `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                        <span class="font-medium">${e.nama}</span>
                        <span class="text-sm text-gray-500 ml-2">
                            ${Utils.formatDateShort(e.startDate)} - ${Utils.formatDateShort(e.endDate)}
                        </span>
                        <span class="text-xs px-2 py-0.5 rounded bg-${e.type === 'libur' ? 'red' : e.type === 'kegiatan' ? 'blue' : 'gray'}-100 ml-2">${e.type}</span>
                        ${!isOwner ? `<span class="text-xs text-gray-400 ml-2">(dibuat oleh guru lain)</span>` : ''}
                    </div>
                    ${isOwner ? `
                        <div class="flex space-x-2">
                            <button onclick="CalendarSchedule.editEvent('${e.id}')" class="text-blue-500">‚úèÔ∏è</button>
                            <button onclick="CalendarSchedule.deleteEvent('${e.id}')" class="text-red-500">üóëÔ∏è</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    },

    prevMonth: () => {
        CalendarSchedule.selectedMonth--;
        if (CalendarSchedule.selectedMonth < 0) {
            CalendarSchedule.selectedMonth = 11;
            CalendarSchedule.selectedYear--;
        }
        CalendarSchedule.renderCalendarGrid();
    },

    nextMonth: () => {
        CalendarSchedule.selectedMonth++;
        if (CalendarSchedule.selectedMonth > 11) {
            CalendarSchedule.selectedMonth = 0;
            CalendarSchedule.selectedYear++;
        }
        CalendarSchedule.renderCalendarGrid();
    },

    showAddEventModal: () => {
        document.getElementById('event-form').reset();
        document.getElementById('event-edit-id').value = '';
        document.getElementById('event-modal').classList.remove('hidden');
    },

    closeEventModal: () => {
        document.getElementById('event-modal').classList.add('hidden');
    },

    saveEvent: async (e) => {
        e.preventDefault();
        Utils.showLoading('Menyimpan...');

        const editId = document.getElementById('event-edit-id').value;
        const eventData = {
            npsn: Auth.userData.npsn, // Shared across school
            userId: Auth.currentUser.uid,
            nama: document.getElementById('event-nama').value.trim(),
            startDate: document.getElementById('event-start').value,
            endDate: document.getElementById('event-end').value,
            type: document.getElementById('event-type').value,
            description: document.getElementById('event-desc').value.trim(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            if (editId) {
                await db.collection(COLLECTIONS.CALENDAR).doc(editId).update(eventData);
            } else {
                eventData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                await db.collection(COLLECTIONS.CALENDAR).add(eventData);
            }

            Utils.showNotification('Kegiatan berhasil disimpan', 'success');
            CalendarSchedule.closeEventModal();
            await CalendarSchedule.loadCalendarEvents();
        } catch (error) {
            console.error('Error saving event:', error);
            Utils.showNotification('Gagal menyimpan', 'error');
        } finally {
            Utils.hideLoading();
        }
    },

    loadCalendarEvents: async () => {
        try {
            // Load events for the same school (NPSN) - collaboration feature
            const snapshot = await db.collection(COLLECTIONS.CALENDAR)
                .where('npsn', '==', Auth.userData.npsn)
                .orderBy('startDate')
                .get();

            CalendarSchedule.calendarEvents = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));

            CalendarSchedule.renderCalendarGrid();
        } catch (error) {
            console.error('Error loading calendar:', error);
        }
    },

    editEvent: (id) => {
        const event = CalendarSchedule.calendarEvents.find(e => e.id === id);
        if (!event || event.userId !== Auth.currentUser.uid) return;

        document.getElementById('event-edit-id').value = id;
        document.getElementById('event-nama').value = event.nama;
        document.getElementById('event-start').value = event.startDate;
        document.getElementById('event-end').value = event.endDate;
        document.getElementById('event-type').value = event.type;
        document.getElementById('event-desc').value = event.description || '';

        document.getElementById('event-modal').classList.remove('hidden');
    },

    deleteEvent: async (id) => {
        const event = CalendarSchedule.calendarEvents.find(e => e.id === id);
        if (!event || event.userId !== Auth.currentUser.uid) return;

        const confirm = await Utils.confirm('Hapus kegiatan ini?');
        if (!confirm) return;

        try {
            await db.collection(COLLECTIONS.CALENDAR).doc(id).delete();
            Utils.showNotification('Kegiatan dihapus', 'success');
            await CalendarSchedule.loadCalendarEvents();
        } catch (error) {
            console.error('Error deleting event:', error);
        }
    },

    showDayDetail: (dateStr) => {
        document.getElementById('event-start').value = dateStr;
        document.getElementById('event-end').value = dateStr;
        CalendarSchedule.showAddEventModal();
    },

    printCalendar: () => {
        document.getElementById('calendar-print-school').textContent = Auth.userData.namaSekolah;
        document.getElementById('calendar-print-tahun').textContent = `Tahun Ajaran ${Utils.getTahunAjaran()}`;
        
        // Generate full year calendar for print
        let content = '';
        for (let month = 0; month < 12; month++) {
            const monthName = Utils.getMonthName(month);
            const firstDay = new Date(CalendarSchedule.selectedYear, month, 1);
            const lastDay = new Date(CalendarSchedule.selectedYear, month + 1, 0);
            const startDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            content += `
                <div class="${month > 0 ? 'page-break' : ''}">
                    <h3 style="text-align: center; margin: 20px 0;">${monthName} ${CalendarSchedule.selectedYear}</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="border: 1px solid #000; padding: 5px; background: #f0f0f0; color: red;">Min</th>
                                <th style="border: 1px solid #000; padding: 5px; background: #f0f0f0;">Sen</th>
                                <th style="border: 1px solid #000; padding: 5px; background: #f0f0f0;">Sel</th>
                                <th style="border: 1px solid #000; padding: 5px; background: #f0f0f0;">Rab</th>
                                <th style="border: 1px solid #000; padding: 5px; background: #f0f0f0;">Kam</th>
                                <th style="border: 1px solid #000; padding: 5px; background: #f0f0f0;">Jum</th>
                                <th style="border: 1px solid #000; padding: 5px; background: #f0f0f0;">Sab</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            let dayCounter = 1;
            for (let week = 0; week < 6; week++) {
                if (dayCounter > daysInMonth) break;
                content += '<tr>';
                for (let dow = 0; dow < 7; dow++) {
                    if ((week === 0 && dow < startDayOfWeek) || dayCounter > daysInMonth) {
                        content += '<td style="border: 1px solid #000; padding: 5px; height: 60px;"></td>';
                    } else {
                        const currentDate = new Date(CalendarSchedule.selectedYear, month, dayCounter);
                        const dayEvents = CalendarSchedule.calendarEvents.filter(e => {
                            const start = new Date(e.startDate);
                            const end = new Date(e.endDate);
                            return currentDate >= start && currentDate <= end;
                        });
                        
                        const bgColor = dayEvents.some(e => e.type === 'libur') ? '#ffcccc' : 
                                       dayEvents.length > 0 ? '#e6f3ff' : '';
                        
                        content += `
                            <td style="border: 1px solid #000; padding: 5px; height: 60px; vertical-align: top; ${bgColor ? 'background:' + bgColor : ''}">
                                <div style="font-weight: bold; ${dow === 0 ? 'color: red;' : ''}">${dayCounter}</div>
                                ${dayEvents.map(e => `<div style="font-size: 8pt;">${e.nama}</div>`).join('')}
                            </td>
                        `;
                        dayCounter++;
                    }
                }
                content += '</tr>';
            }

            content += '</tbody></table></div>';
        }

        document.getElementById('calendar-print-content').innerHTML = content;
        Utils.printDocument('calendar-print-template', 'Kalender Pendidikan');
    },

    // ==================== JADWAL PELAJARAN ====================
    renderSchedule: () => {
        const container = document.getElementById('tab-schedule');
        container.innerHTML = `
            <div class="space-y-6">
                <!-- Header -->
                <div class="bg-white rounded-xl shadow p-6">
                    <div class="flex flex-wrap justify-between items-center gap-4">
                        <div class="flex gap-3">
                            <select id="schedule-rombel" class="px-4 py-2 border rounded-lg">
                                <option value="">Semua Rombel</option>
                            </select>
                            <select id="schedule-day" class="px-4 py-2 border rounded-lg">
                                <option value="">Semua Hari</option>
                                <option value="1">Senin</option>
                                <option value="2">Selasa</option>
                                <option value="3">Rabu</option>
                                <option value="4">Kamis</option>
                                <option value="5">Jumat</option>
                                <option value="6">Sabtu</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="CalendarSchedule.showAddScheduleModal()" 
                                class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700">
                                ‚ûï Tambah Jadwal
                            </button>
                            <button onclick="CalendarSchedule.printSchedule()" 
                                class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                üñ®Ô∏è Cetak
                            </button>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-sm text-yellow-800">
                            ‚ö†Ô∏è <strong>Validasi Bentrok Otomatis:</strong> Sistem akan mencegah jadwal bentrok 
                            (guru/rombel/jam yang sama) di seluruh sekolah dengan NPSN yang sama.
                        </p>
                    </div>
                </div>

                <!-- Schedule Table -->
                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full" id="schedule-table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-20">Jam Ke</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-24">Waktu</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Senin</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Selasa</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Rabu</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Kamis</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jumat</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Sabtu</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-table-body">
                                <!-- Generated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- My Schedule List -->
                <div class="bg-white rounded-xl shadow p-6">
                    <h4 class="font-semibold mb-4">üìã Jadwal Mengajar Saya</h4>
                    <div id="my-schedule-list" class="space-y-2">
                        <p class="text-gray-400 text-center py-4">Belum ada jadwal</p>
                    </div>
                </div>

                <!-- Print Template -->
                <div id="schedule-print-template" class="hidden print-only">
                    <div class="doc-header">
                        <h1>JADWAL PELAJARAN</h1>
                        <p id="schedule-print-school"></p>
                        <p id="schedule-print-tahun"></p>
                    </div>
                    <div id="schedule-print-content"></div>
                </div>
            </div>

            <!-- Add Schedule Modal -->
            <div id="schedule-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Tambah Jadwal</h3>
                        <button onclick="CalendarSchedule.closeScheduleModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                    </div>
                    <form id="schedule-form" class="space-y-4">
                        <input type="hidden" id="schedule-edit-id">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Hari</label>
                                <select id="schedule-hari" required class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Pilih Hari</option>
                                    <option value="1">Senin</option>
                                    <option value="2">Selasa</option>
                                    <option value="3">Rabu</option>
                                    <option value="4">Kamis</option>
                                    <option value="5">Jumat</option>
                                    <option value="6">Sabtu</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Rombel</label>
                                <select id="schedule-rombel-input" required class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Pilih Rombel</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Jam Mulai</label>
                                <input type="time" id="schedule-start" required class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Jam Selesai</label>
                                <input type="time" id="schedule-end" required class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Mata Pelajaran</label>
                            <select id="schedule-mapel" required class="w-full px-3 py-2 border rounded-lg">
                                <option value="">Pilih Mapel</option>
                            </select>
                        </div>
                        <div id="conflict-warning" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg">
                            <p class="text-red-600 text-sm">‚ö†Ô∏è <span id="conflict-message"></span></p>
                        </div>
                        <div class="flex justify-end space-x-3 pt-2">
                            <button type="button" onclick="CalendarSchedule.closeScheduleModal()" 
                                class="px-4 py-2 border rounded-lg">Batal</button>
                            <button type="submit" id="schedule-submit-btn" 
                                class="px-4 py-2 bg-primary text-white rounded-lg">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        document.getElementById('schedule-form').addEventListener('submit', CalendarSchedule.saveSchedule);
        document.getElementById('schedule-rombel').addEventListener('change', CalendarSchedule.filterSchedule);
        document.getElementById('schedule-day').addEventListener('change', CalendarSchedule.filterSchedule);
        
        // Conflict check listeners
        ['schedule-hari', 'schedule-rombel-input', 'schedule-start', 'schedule-end'].forEach(id => {
            document.getElementById(id).addEventListener('change', CalendarSchedule.checkConflict);
        });
    },

    showAddScheduleModal: () => {
        document.getElementById('schedule-form').reset();
        document.getElementById('schedule-edit-id').value = '';
        document.getElementById('conflict-warning').classList.add('hidden');
        
        // Populate dropdowns
        document.getElementById('schedule-rombel-input').innerHTML = '<option value="">Pilih Rombel</option>' + 
            MasterData.rombel.map(r => `<option value="${r.id}" data-nama="${r.nama}">${r.nama}</option>`).join('');
        document.getElementById('schedule-mapel').innerHTML = '<option value="">Pilih Mapel</option>' + 
            MasterData.subjects.map(s => `<option value="${s.id}" data-nama="${s.nama}">${s.nama}</option>`).join('');

        document.getElementById('schedule-modal').classList.remove('hidden');
    },

    closeScheduleModal: () => {
        document.getElementById('schedule-modal').classList.add('hidden');
    },

    checkConflict: async () => {
        const hari = document.getElementById('schedule-hari').value;
        const rombelId = document.getElementById('schedule-rombel-input').value;
        const startTime = document.getElementById('schedule-start').value;
        const endTime = document.getElementById('schedule-end').value;
        const editId = document.getElementById('schedule-edit-id').value;

        if (!hari || !rombelId || !startTime || !endTime) {
            document.getElementById('conflict-warning').classList.add('hidden');
            return;
        }

        const rombelNama = document.getElementById('schedule-rombel-input').selectedOptions[0].dataset.nama;

        // Check conflicts in the same school
        const conflicts = CalendarSchedule.scheduleData.filter(s => {
            if (editId && s.id === editId) return false; // Skip self when editing
            if (s.hari !== parseInt(hari)) return false;
            
            // Check time overlap
            const hasTimeOverlap = Utils.isTimeOverlap(startTime, endTime, s.startTime, s.endTime);
            if (!hasTimeOverlap) return false;

            // Conflict if same rombel OR same teacher
            return s.rombelId === rombelId || s.userId === Auth.currentUser.uid;
        });

        const conflictWarning = document.getElementById('conflict-warning');
        const conflictMessage = document.getElementById('conflict-message');
        const submitBtn = document.getElementById('schedule-submit-btn');

        if (conflicts.length > 0) {
            let messages = [];
            conflicts.forEach(c => {
                if (c.rombelId === rombelId) {
                    messages.push(`Rombel ${rombelNama} sudah ada jadwal ${c.mapelNama} pada jam tersebut`);
                }
                if (c.userId === Auth.currentUser.uid && c.rombelId !== rombelId) {
                    messages.push(`Anda sudah mengajar di ${c.rombelNama} pada jam tersebut`);
                }
            });
            conflictMessage.textContent = messages.join('. ');
            conflictWarning.classList.remove('hidden');
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            conflictWarning.classList.add('hidden');
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    },

    saveSchedule: async (e) => {
        e.preventDefault();
        
        // Double check for conflicts
        await CalendarSchedule.checkConflict();
        if (document.getElementById('schedule-submit-btn').disabled) {
            Utils.showNotification('Tidak bisa menyimpan karena ada bentrok jadwal', 'error');
            return;
        }

        Utils.showLoading('Menyimpan jadwal...');

        const editId = document.getElementById('schedule-edit-id').value;
        const rombelSelect = document.getElementById('schedule-rombel-input');
        const mapelSelect = document.getElementById('schedule-mapel');

        const scheduleData = {
            npsn: Auth.userData.npsn, // For conflict checking across school
            userId: Auth.currentUser.uid,
            teacherName: Auth.userData.nama,
            hari: parseInt(document.getElementById('schedule-hari').value),
            rombelId: rombelSelect.value,
            rombelNama: rombelSelect.selectedOptions[0].dataset.nama,
            mapelId: mapelSelect.value,
            mapelNama: mapelSelect.selectedOptions[0].dataset.nama,
            startTime: document.getElementById('schedule-start').value,
            endTime: document.getElementById('schedule-end').value,
            tahunAjaran: Utils.getTahunAjaran(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            if (editId) {
                await db.collection(COLLECTIONS.SCHEDULE).doc(editId).update(scheduleData);
            } else {
                scheduleData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                await db.collection(COLLECTIONS.SCHEDULE).add(scheduleData);
            }

            Utils.showNotification('Jadwal berhasil disimpan', 'success');
            CalendarSchedule.closeScheduleModal();
            await CalendarSchedule.loadSchedule();
        } catch (error) {
            console.error('Error saving schedule:', error);
            Utils.showNotification('Gagal menyimpan', 'error');
        } finally {
            Utils.hideLoading();
        }
    },

    loadSchedule: async () => {
        try {
            // Load all schedules for the same school (for conflict detection)
            const snapshot = await db.collection(COLLECTIONS.SCHEDULE)
                .where('npsn', '==', Auth.userData.npsn)
                .get();

            CalendarSchedule.scheduleData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));

            CalendarSchedule.renderScheduleTable();
            CalendarSchedule.renderMyScheduleList();
            CalendarSchedule.updateScheduleFilters();
        } catch (error) {
            console.error('Error loading schedule:', error);
        }
    },

    updateScheduleFilters: () => {
        document.getElementById('schedule-rombel').innerHTML = '<option value="">Semua Rombel</option>' + 
            MasterData.rombel.map(r => `<option value="${r.id}">${r.nama}</option>`).join('');
    },

    renderScheduleTable: (filteredData = null) => {
        const tbody = document.getElementById('schedule-table-body');
        const data = filteredData || CalendarSchedule.scheduleData;

        // Generate time slots (assuming 8 periods)
        const timeSlots = [
            { jam: 1, start: '07:00', end: '07:40' },
            { jam: 2, start: '07:40', end: '08:20' },
            { jam: 3, start: '08:20', end: '09:00' },
            { jam: 4, start: '09:15', end: '09:55' },
            { jam: 5, start: '09:55', end: '10:35' },
            { jam: 6, start: '10:35', end: '11:15' },
            { jam: 7, start: '11:15', end: '11:55' },
            { jam: 8, start: '12:30', end: '13:10' }
        ];

        tbody.innerHTML = timeSlots.map(slot => {
            let row = `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3 text-center font-medium">${slot.jam}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${slot.start}-${slot.end}</td>
            `;

            for (let day = 1; day <= 6; day++) {
                const daySchedules = data.filter(s => 
                    s.hari === day && 
                    Utils.isTimeOverlap(slot.start, slot.end, s.startTime, s.endTime)
                );

                if (daySchedules.length === 0) {
                    row += '<td class="px-4 py-3 text-center">-</td>';
                } else {
                    row += '<td class="px-2 py-2">';
                    daySchedules.forEach(s => {
                        const isOwn = s.userId === Auth.currentUser.uid;
                        row += `
                            <div class="text-xs p-1 rounded mb-1 ${isOwn ? 'bg-blue-100' : 'bg-gray-100'}">
                                <div class="font-medium">${s.mapelNama}</div>
                                <div class="text-gray-500">${s.rombelNama}</div>
                                ${!isOwn ? `<div class="text-gray-400">${s.teacherName}</div>` : ''}
                            </div>
                        `;
                    });
                    row += '</td>';
                }
            }

            row += '</tr>';
            return row;
        }).join('');
    },

    renderMyScheduleList: () => {
        const container = document.getElementById('my-schedule-list');
        const mySchedule = CalendarSchedule.scheduleData.filter(s => s.userId === Auth.currentUser.uid);

        if (mySchedule.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-center py-4">Belum ada jadwal mengajar</p>';
            return;
        }

        // Group by day
        const grouped = {};
        mySchedule.forEach(s => {
            if (!grouped[s.hari]) grouped[s.hari] = [];
            grouped[s.hari].push(s);
        });

        container.innerHTML = Object.entries(grouped)
            .sort((a, b) => parseInt(a[0]) - parseInt(b[0]))
            .map(([day, schedules]) => `
                <div class="border rounded-lg p-3">
                    <h5 class="font-medium text-gray-700 mb-2">${Utils.getDayName(parseInt(day))}</h5>
                    <div class="space-y-1">
                        ${schedules.sort((a, b) => a.startTime.localeCompare(b.startTime)).map(s => `
                            <div class="flex justify-between items-center text-sm bg-gray-50 p-2 rounded">
                                <div>
                                    <span class="font-medium">${s.mapelNama}</span>
                                    <span class="text-gray-500 mx-2">‚Ä¢</span>
                                    <span>${s.rombelNama}</span>
                                    <span class="text-gray-500 mx-2">‚Ä¢</span>
                                    <span class="text-gray-600">${s.startTime}-${s.endTime}</span>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="CalendarSchedule.editSchedule('${s.id}')" class="text-blue-500">‚úèÔ∏è</button>
                                    <button onclick="CalendarSchedule.deleteSchedule('${s.id}')" class="text-red-500">üóëÔ∏è</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
    },

    filterSchedule: () => {
        const rombelFilter = document.getElementById('schedule-rombel').value;
        const dayFilter = document.getElementById('schedule-day').value;

        let filtered = CalendarSchedule.scheduleData;
        if (rombelFilter) filtered = filtered.filter(s => s.rombelId === rombelFilter);
        if (dayFilter) filtered = filtered.filter(s => s.hari === parseInt(dayFilter));

        CalendarSchedule.renderScheduleTable(filtered);
    },

    editSchedule: (id) => {
        const schedule = CalendarSchedule.scheduleData.find(s => s.id === id);
        if (!schedule || schedule.userId !== Auth.currentUser.uid) return;

        document.getElementById('schedule-edit-id').value = id;
        
        // Populate dropdowns first
        document.getElementById('schedule-rombel-input').innerHTML = '<option value="">Pilih Rombel</option>' + 
            MasterData.rombel.map(r => `<option value="${r.id}" data-nama="${r.nama}">${r.nama}</option>`).join('');
        document.getElementById('schedule-mapel').innerHTML = '<option value="">Pilih Mapel</option>' + 
            MasterData.subjects.map(s => `<option value="${s.id}" data-nama="${s.nama}">${s.nama}</option>`).join('');

        // Set values
        document.getElementById('schedule-hari').value = schedule.hari;
        document.getElementById('schedule-rombel-input').value = schedule.rombelId;
        document.getElementById('schedule-mapel').value = schedule.mapelId;
        document.getElementById('schedule-start').value = schedule.startTime;
        document.getElementById('schedule-end').value = schedule.endTime;

        document.getElementById('conflict-warning').classList.add('hidden');
        document.getElementById('schedule-modal').classList.remove('hidden');
    },

    deleteSchedule: async (id) => {
        const schedule = CalendarSchedule.scheduleData.find(s => s.id === id);
        if (!schedule || schedule.userId !== Auth.currentUser.uid) return;

        const confirm = await Utils.confirm('Hapus jadwal ini?');
        if (!confirm) return;

        try {
            await db.collection(COLLECTIONS.SCHEDULE).doc(id).delete();
            Utils.showNotification('Jadwal dihapus', 'success');
            await CalendarSchedule.loadSchedule();
        } catch (error) {
            console.error('Error deleting schedule:', error);
        }
    },

    printSchedule: () => {
        const rombelFilter = document.getElementById('schedule-rombel').value;
        const rombel = rombelFilter ? MasterData.rombel.find(r => r.id === rombelFilter) : null;

        document.getElementById('schedule-print-school').textContent = Auth.userData.namaSekolah;
        document.getElementById('schedule-print-tahun').textContent = `Tahun Ajaran ${Utils.getTahunAjaran()}`;

        const data = rombelFilter ? 
            CalendarSchedule.scheduleData.filter(s => s.rombelId === rombelFilter) : 
            CalendarSchedule.scheduleData.filter(s => s.userId === Auth.currentUser.uid);

        let content = `
            <h3 style="text-align: center; margin-bottom: 15px;">
                ${rombel ? `Jadwal Kelas ${rombel.nama}` : `Jadwal Mengajar ${Auth.userData.nama}`}
            </h3>
            <table class="schedule-table">
                <thead>
                    <tr>
                        <th>Jam</th>
                        <th>Senin</th>
                        <th>Selasa</th>
                        <th>Rabu</th>
                        <th>Kamis</th>
                        <th>Jumat</th>
                        <th>Sabtu</th>
                    </tr>
                </thead>
                <tbody>
        `;

        for (let jam = 1; jam <= 8; jam++) {
            content += '<tr>';
            content += `<td style="text-align: center;">${jam}</td>`;
            for (let day = 1; day <= 6; day++) {
                const daySchedule = data.find(s => s.hari === day);
                content += `<td style="text-align: center;">
                    ${daySchedule ? `${daySchedule.mapelNama}<br><small>${daySchedule.rombelNama}</small>` : '-'}
                </td>`;
            }
            content += '</tr>';
        }

        content += '</tbody></table>';

        document.getElementById('schedule-print-content').innerHTML = content;
        Utils.printDocument('schedule-print-template', 'Jadwal Pelajaran');
    }
};