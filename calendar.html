<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalender Pendidikan - Admin Guru Super App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>* { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="max-w-6xl mx-auto p-4 lg:p-8">
        <!-- Back Button -->
        <a href="dashboard.html" class="inline-flex items-center text-purple-600 hover:text-purple-700 mb-6">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Kembali ke Dashboard
        </a>

        <h1 class="text-2xl lg:text-3xl font-bold text-gray-800 mb-6">ğŸ“… Kalender Pendidikan</h1>

        <!-- Settings Card -->
        <div class="bg-white rounded-xl p-6 shadow-sm border mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Pengaturan Semester</h2>
            
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tahun Ajaran</label>
                    <select id="tahunAjaran" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Awal Semester Ganjil</label>
                    <input type="date" id="awalGanjil" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Akhir Semester Ganjil</label>
                    <input type="date" id="akhirGanjil" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Awal Semester Genap</label>
                    <input type="date" id="awalGenap" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
            </div>

            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Akhir Semester Genap</label>
                    <input type="date" id="akhirGenap" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Akhir Kelas 6/9/12</label>
                    <input type="date" id="akhirKelasAkhir" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    <p class="text-xs text-gray-500 mt-1">Khusus kelas akhir jenjang</p>
                </div>
            </div>

            <button onclick="saveCalendarSettings()" class="px-6 py-2.5 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                Simpan Pengaturan
            </button>
        </div>

        <!-- Hari Libur Nasional (Baku) -->
        <div class="bg-white rounded-xl p-6 shadow-sm border mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">ğŸŒ Hari Libur Nasional (Tetap)</h2>
            <p class="text-sm text-gray-500 mb-4">Hari libur ini sudah ditetapkan dan tidak perlu diubah.</p>
            
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
                <div class="flex items-center p-3 bg-red-50 rounded-lg">
                    <span class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">ğŸ‡®ğŸ‡©</span>
                    <div>
                        <p class="font-medium text-gray-800">17 Agustus</p>
                        <p class="text-sm text-gray-500">Hari Kemerdekaan RI</p>
                    </div>
                </div>
                <div class="flex items-center p-3 bg-green-50 rounded-lg">
                    <span class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">ğŸ„</span>
                    <div>
                        <p class="font-medium text-gray-800">25 Desember</p>
                        <p class="text-sm text-gray-500">Hari Natal</p>
                    </div>
                </div>
                <div class="flex items-center p-3 bg-blue-50 rounded-lg">
                    <span class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">ğŸ‰</span>
                    <div>
                        <p class="font-medium text-gray-800">1 Januari</p>
                        <p class="text-sm text-gray-500">Tahun Baru</p>
                    </div>
                </div>
                <div class="flex items-center p-3 bg-yellow-50 rounded-lg">
                    <span class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center mr-3">ğŸ‘·</span>
                    <div>
                        <p class="font-medium text-gray-800">1 Mei</p>
                        <p class="text-sm text-gray-500">Hari Buruh</p>
                    </div>
                </div>
                <div class="flex items-center p-3 bg-orange-50 rounded-lg">
                    <span class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center mr-3">ğŸ¦…</span>
                    <div>
                        <p class="font-medium text-gray-800">1 Juni</p>
                        <p class="text-sm text-gray-500">Hari Lahir Pancasila</p>
                    </div>
                </div>
                <div class="flex items-center p-3 bg-purple-50 rounded-lg">
                    <span class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mr-3">ğŸ¤</span>
                    <div>
                        <p class="font-medium text-gray-800">28 Oktober</p>
                        <p class="text-sm text-gray-500">Hari Sumpah Pemuda</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hari Libur Khusus -->
        <div class="bg-white rounded-xl p-6 shadow-sm border mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-semibold text-gray-800">ğŸ“Œ Hari Libur Khusus / Tidak Tetap</h2>
                    <p class="text-sm text-gray-500">Tambahkan libur yang tanggalnya berubah setiap tahun (Hari Raya, dll)</p>
                </div>
                <button onclick="addLiburKhusus()" class="px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition-colors">
                    + Tambah
                </button>
            </div>

            <div id="liburKhususContainer" class="space-y-3">
                <!-- Dynamic entries -->
            </div>
        </div>

        <!-- Calendar Preview -->
        <div class="bg-white rounded-xl p-6 shadow-sm border">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“Š Ringkasan Minggu Efektif</h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-medium text-gray-700 mb-3">Semester Ganjil</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                            <span>Total Minggu</span>
                            <span id="mingguGanjil" class="font-bold">0</span>
                        </div>
                        <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                            <span>Minggu Efektif</span>
                            <span id="mingguEfektifGanjil" class="font-bold text-green-600">0</span>
                        </div>
                        <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                            <span>Minggu Tidak Efektif</span>
                            <span id="mingguTidakEfektifGanjil" class="font-bold text-red-600">0</span>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="font-medium text-gray-700 mb-3">Semester Genap</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                            <span>Total Minggu</span>
                            <span id="mingguGenap" class="font-bold">0</span>
                        </div>
                        <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                            <span>Minggu Efektif</span>
                            <span id="mingguEfektifGenap" class="font-bold text-green-600">0</span>
                        </div>
                        <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                            <span>Minggu Tidak Efektif</span>
                            <span id="mingguTidakEfektifGenap" class="font-bold text-red-600">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 hidden"></div>

    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let liburKhususCount = 0;

        // Initialize
        Auth.checkAuth(async (user) => {
            setupTahunAjaran();
            await loadCalendarSettings(user.uid);
            calculateWeeks();
        });

        function setupTahunAjaran() {
            const tahun = getTahunAjaran();
            const select = document.getElementById('tahunAjaran');
            tahun.options.forEach((opt, i) => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                if (opt === tahun.current) option.selected = true;
                select.appendChild(option);
            });

            // Set default dates based on tahun ajaran
            const year = parseInt(tahun.current.split('/')[0]);
            document.getElementById('awalGanjil').value = `${year}-07-15`;
            document.getElementById('akhirGanjil').value = `${year}-12-21`;
            document.getElementById('awalGenap').value = `${year + 1}-01-06`;
            document.getElementById('akhirGenap').value = `${year + 1}-06-21`;
            document.getElementById('akhirKelasAkhir').value = `${year + 1}-05-31`;
        }

        async function loadCalendarSettings(userId) {
            try {
                const doc = await db.collection('users').doc(userId).collection('settings').doc('calendar').get();
                if (doc.exists) {
                    const data = doc.data();
                    if (data.awalGanjil) document.getElementById('awalGanjil').value = data.awalGanjil;
                    if (data.akhirGanjil) document.getElementById('akhirGanjil').value = data.akhirGanjil;
                    if (data.awalGenap) document.getElementById('awalGenap').value = data.awalGenap;
                    if (data.akhirGenap) document.getElementById('akhirGenap').value = data.akhirGenap;
                    if (data.akhirKelasAkhir) document.getElementById('akhirKelasAkhir').value = data.akhirKelasAkhir;
                    
                    // Load libur khusus
                    if (data.liburKhusus && data.liburKhusus.length > 0) {
                        data.liburKhusus.forEach(libur => addLiburKhusus(libur));
                    }
                }

                // Add default libur khusus if empty
                if (document.getElementById('liburKhususContainer').children.length === 0) {
                    addLiburKhusus({ tanggal: '', nama: 'Hari Raya Idul Fitri' });
                    addLiburKhusus({ tanggal: '', nama: 'Hari Raya Idul Adha' });
                    addLiburKhusus({ tanggal: '', nama: 'Tahun Baru Islam' });
                    addLiburKhusus({ tanggal: '', nama: 'Maulid Nabi Muhammad SAW' });
                    addLiburKhusus({ tanggal: '', nama: 'Isra Miraj' });
                }

                calculateWeeks();
            } catch (error) {
                console.error('Error loading calendar settings:', error);
            }
        }

        function addLiburKhusus(data = null) {
            const container = document.getElementById('liburKhususContainer');
            const index = liburKhususCount++;

            const html = `
                <div id="libur-${index}" class="flex flex-wrap gap-3 items-center p-4 bg-gray-50 rounded-lg">
                    <div class="flex-1 min-w-[150px]">
                        <input type="date" name="liburTanggal[]" value="${data?.tanggal || ''}" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="calculateWeeks()">
                    </div>
                    <div class="flex-1 min-w-[200px]">
                        <input type="text" name="liburNama[]" value="${data?.nama || ''}" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Nama hari libur">
                    </div>
                    <button type="button" onclick="removeLibur(${index})" class="p-2 text-red-500 hover:bg-red-100 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function removeLibur(index) {
            const el = document.getElementById(`libur-${index}`);
            if (el) el.remove();
            calculateWeeks();
        }

        function calculateWeeks() {
            const awalGanjil = new Date(document.getElementById('awalGanjil').value);
            const akhirGanjil = new Date(document.getElementById('akhirGanjil').value);
            const awalGenap = new Date(document.getElementById('awalGenap').value);
            const akhirGenap = new Date(document.getElementById('akhirGenap').value);

            // Calculate weeks
            const mingguGanjil = Math.ceil((akhirGanjil - awalGanjil) / (7 * 24 * 60 * 60 * 1000));
            const mingguGenap = Math.ceil((akhirGenap - awalGenap) / (7 * 24 * 60 * 60 * 1000));

            // Count holidays
            const liburTanggal = document.getElementsByName('liburTanggal[]');
            let holidaysGanjil = 2; // MPLS & Pembagian Rapor
            let holidaysGenap = 2; // Libur semester & Pembagian Rapor

            liburTanggal.forEach(input => {
                if (input.value) {
                    const liburDate = new Date(input.value);
                    if (liburDate >= awalGanjil && liburDate <= akhirGanjil) holidaysGanjil++;
                    if (liburDate >= awalGenap && liburDate <= akhirGenap) holidaysGenap++;
                }
            });

            // Add STS and SAS weeks
            holidaysGanjil += 2; // STS + SAS
            holidaysGenap += 2; // STS + PAT

            document.getElementById('mingguGanjil').textContent = mingguGanjil;
            document.getElementById('mingguEfektifGanjil').textContent = Math.max(0, mingguGanjil - holidaysGanjil);
            document.getElementById('mingguTidakEfektifGanjil').textContent = holidaysGanjil;

            document.getElementById('mingguGenap').textContent = mingguGenap;
            document.getElementById('mingguEfektifGenap').textContent = Math.max(0, mingguGenap - holidaysGenap);
            document.getElementById('mingguTidakEfektifGenap').textContent = holidaysGenap;
        }

        async function saveCalendarSettings() {
            const user = auth.currentUser;
            if (!user) return;

            // Gather libur khusus
            const liburTanggal = document.getElementsByName('liburTanggal[]');
            const liburNama = document.getElementsByName('liburNama[]');
            const liburKhusus = [];
            
            for (let i = 0; i < liburTanggal.length; i++) {
                if (liburNama[i].value.trim()) {
                    liburKhusus.push({
                        tanggal: liburTanggal[i].value,
                        nama: liburNama[i].value.trim()
                    });
                }
            }

            const settings = {
                tahunAjaran: document.getElementById('tahunAjaran').value,
                awalGanjil: document.getElementById('awalGanjil').value,
                akhirGanjil: document.getElementById('akhirGanjil').value,
                awalGenap: document.getElementById('awalGenap').value,
                akhirGenap: document.getElementById('akhirGenap').value,
                akhirKelasAkhir: document.getElementById('akhirKelasAkhir').value,
                liburKhusus: liburKhusus,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('users').doc(user.uid).collection('settings').doc('calendar').set(settings);
                showToast('Pengaturan kalender berhasil disimpan!', 'success');
            } catch (error) {
                showToast('Gagal menyimpan: ' + error.message, 'error');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // Add event listeners for date changes
        ['awalGanjil', 'akhirGanjil', 'awalGenap', 'akhirGenap'].forEach(id => {
            document.getElementById(id).addEventListener('change', calculateWeeks);
        });
    </script>
</body>
</html>