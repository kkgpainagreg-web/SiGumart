<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perencanaan Prota & Promes - Admin PAI Satu Pintu</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Konfigurasi Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pai-hijau': {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        .sidebar-link { transition: all 0.3s ease; }
        .sidebar-link:hover { transform: translateX(5px); }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #16a34a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        
        /* Style untuk card TP */
        .tp-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .tp-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .tp-card.selected {
            border-color: #16a34a;
            background-color: #f0fdf4;
        }
        .tp-card.selected::before {
            content: '‚úì';
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #16a34a;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* Style untuk tab */
        .tab-btn.active {
            background-color: #16a34a;
            color: white;
        }
        
        /* Accordion style */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-content.open {
            max-height: 2000px;
        }
        
        /* Badge elemen */
        .badge-quran { background-color: #dbeafe; color: #1e40af; }
        .badge-akidah { background-color: #dcfce7; color: #166534; }
        .badge-akhlak { background-color: #f3e8ff; color: #7c3aed; }
        .badge-fikih { background-color: #ffedd5; color: #c2410c; }
        .badge-spi { background-color: #fee2e2; color: #b91c1c; }
    </style>
</head>

<body class="bg-gray-100 font-sans">
    
    <!-- Container Utama -->
    <div class="flex min-h-screen">
        
        <!-- ================================================
             SIDEBAR NAVIGASI
             ================================================ -->
        <aside id="sidebar" class="w-64 bg-pai-hijau-800 text-white fixed h-full z-50">
            
            <div class="p-6 border-b border-pai-hijau-700">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center">
                        <i class="fas fa-mosque text-pai-hijau-700 text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg leading-tight">Admin PAI</h1>
                        <p class="text-pai-hijau-300 text-xs">Satu Pintu</p>
                    </div>
                </div>
            </div>
            
            <nav class="p-4">
                <p class="text-pai-hijau-400 text-xs uppercase tracking-wider mb-4 px-3">Menu Utama</p>
                
                <ul class="space-y-2">
                    <li>
                        <a href="dashboard.html" class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-pai-hijau-700 text-pai-hijau-100">
                            <i class="fas fa-home w-5"></i>
                            <span class="ml-3">Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="profil.html" class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-pai-hijau-700 text-pai-hijau-100">
                            <i class="fas fa-user w-5"></i>
                            <span class="ml-3">Profil Guru</span>
                        </a>
                    </li>
                    <li>
                        <a href="kalender.html" class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-pai-hijau-700 text-pai-hijau-100">
                            <i class="fas fa-calendar-alt w-5"></i>
                            <span class="ml-3">Kalender Pendidikan</span>
                        </a>
                    </li>
                    <!-- Menu Aktif -->
                    <li>
                        <a href="perencanaan.html" class="sidebar-link flex items-center px-4 py-3 rounded-lg bg-pai-hijau-700 text-white">
                            <i class="fas fa-tasks w-5"></i>
                            <span class="ml-3">Perencanaan</span>
                            <span class="ml-auto bg-white/20 text-xs px-2 py-1 rounded-full">Prota/Promes</span>
                        </a>
                    </li>
                    <li>
                        <a href="modul-ajar.html" class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-pai-hijau-700 text-pai-hijau-100">
                            <i class="fas fa-book-open w-5"></i>
                            <span class="ml-3">Modul Ajar</span>
                        </a>
                    </li>
                    <li>
                        <a href="absensi.html" class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-pai-hijau-700 text-pai-hijau-100">
                            <i class="fas fa-clipboard-check w-5"></i>
                            <span class="ml-3">Absensi Siswa</span>
                        </a>
                    </li>
                    <li>
                        <a href="nilai.html" class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-pai-hijau-700 text-pai-hijau-100">
                            <i class="fas fa-chart-bar w-5"></i>
                            <span class="ml-3">Daftar Nilai</span>
                        </a>
                    </li>
                </ul>
                
                <p class="text-pai-hijau-400 text-xs uppercase tracking-wider mb-4 px-3 mt-8">Dokumen</p>
                <ul class="space-y-2">
                    <li>
                        <a href="cetak.html" class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-pai-hijau-700 text-pai-hijau-100">
                            <i class="fas fa-print w-5"></i>
                            <span class="ml-3">Cetak Dokumen</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-pai-hijau-700">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-pai-hijau-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="flex-1">
                        <p id="nama-guru-sidebar" class="text-sm font-medium truncate">Memuat...</p>
                        <p class="text-pai-hijau-400 text-xs">Guru PAI</p>
                    </div>
                    <button onclick="logoutUser()" class="text-pai-hijau-400 hover:text-white">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>
        
        <!-- ================================================
             KONTEN UTAMA
             ================================================ -->
        <main class="flex-1 ml-64">
            
            <!-- Header -->
            <header class="bg-white shadow-sm border-b border-gray-200 px-8 py-4 sticky top-0 z-40">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Perencanaan Pembelajaran</h2>
                        <p class="text-gray-500 text-sm">Susun Prota & Promes berdasarkan CP PAI 2025</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-sm text-gray-500">Tahun Ajaran</p>
                            <p id="display-tahun-ajaran" class="font-bold text-pai-hijau-600">-</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-500">Kelas Dipilih</p>
                            <p id="display-kelas" class="font-bold text-pai-hijau-600">-</p>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Area Konten -->
            <div class="p-8">
                
                <!-- ================================================
                     STEP 1: PILIH KELAS
                     ================================================ -->
                <div id="step-1" class="bg-white rounded-2xl shadow-md p-6 mb-6 fade-in">
                    
                    <div class="flex items-center mb-6 pb-4 border-b border-gray-200">
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mr-4">
                            <span class="text-blue-600 font-bold text-xl">1</span>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Pilih Kelas & Semester</h3>
                            <p class="text-sm text-gray-500">Tentukan kelas yang akan dibuatkan perencanaan</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        
                        <!-- Pilih Kelas -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-chalkboard text-gray-400 mr-2"></i>
                                Kelas <span class="text-red-500">*</span>
                            </label>
                            <select id="select-kelas" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pai-hijau-500 outline-none bg-white">
                                <option value="">-- Pilih Kelas --</option>
                                <!-- Akan diisi dari profil guru -->
                            </select>
                        </div>
                        
                        <!-- Pilih Semester -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-clock text-gray-400 mr-2"></i>
                                Semester <span class="text-red-500">*</span>
                            </label>
                            <select id="select-semester" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pai-hijau-500 outline-none bg-white">
                                <option value="">-- Pilih Semester --</option>
                                <option value="ganjil">Semester 1 (Ganjil)</option>
                                <option value="genap">Semester 2 (Genap)</option>
                            </select>
                        </div>
                        
                        <!-- Tombol Load -->
                        <div class="flex items-end">
                            <button type="button" 
                                    onclick="loadDataPerencanaan()"
                                    class="w-full px-6 py-3 bg-pai-hijau-600 text-white font-medium rounded-xl hover:bg-pai-hijau-700 transition-colors">
                                <i class="fas fa-arrow-right mr-2"></i>
                                Mulai Perencanaan
                            </button>
                        </div>
                        
                    </div>
                    
                    <!-- Info Fase -->
                    <div id="info-fase" class="mt-4 hidden">
                        <div class="bg-pai-hijau-50 border border-pai-hijau-200 rounded-xl p-4">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle text-pai-hijau-600 mr-3"></i>
                                <div>
                                    <p class="font-medium text-pai-hijau-800">
                                        <span id="nama-fase">-</span>
                                    </p>
                                    <p class="text-sm text-pai-hijau-600" id="deskripsi-fase">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- ================================================
                     STEP 2: INFORMASI MINGGU EFEKTIF
                     ================================================ -->
                <div id="step-2" class="bg-white rounded-2xl shadow-md p-6 mb-6 fade-in hidden">
                    
                    <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mr-4">
                                <span class="text-green-600 font-bold text-xl">2</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Informasi Waktu Tersedia</h3>
                                <p class="text-sm text-gray-500">Berdasarkan kalender pendidikan yang sudah diatur</p>
                            </div>
                        </div>
                        <a href="kalender.html" class="text-pai-hijau-600 hover:text-pai-hijau-700 text-sm">
                            <i class="fas fa-edit mr-1"></i> Edit Kalender
                        </a>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 text-white">
                            <p class="text-blue-100 text-sm">Minggu Efektif</p>
                            <p id="info-minggu-efektif" class="text-3xl font-bold">0</p>
                            <p class="text-blue-200 text-xs">minggu</p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 text-white">
                            <p class="text-green-100 text-sm">Total JP Tersedia</p>
                            <p id="info-total-jp" class="text-3xl font-bold">0</p>
                            <p class="text-green-200 text-xs">jam pelajaran</p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 text-white">
                            <p class="text-purple-100 text-sm">JP Sudah Dialokasi</p>
                            <p id="info-jp-terpakai" class="text-3xl font-bold">0</p>
                            <p class="text-purple-200 text-xs">jam pelajaran</p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-4 text-white">
                            <p class="text-orange-100 text-sm">JP Tersisa</p>
                            <p id="info-jp-sisa" class="text-3xl font-bold">0</p>
                            <p class="text-orange-200 text-xs">jam pelajaran</p>
                        </div>
                        
                    </div>
                    
                    <!-- Progress Bar Alokasi -->
                    <div class="mt-4">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>Progress Alokasi JP</span>
                            <span id="persen-alokasi">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div id="progress-alokasi" 
                                 class="bg-gradient-to-r from-pai-hijau-400 to-pai-hijau-600 h-3 rounded-full transition-all duration-500" 
                                 style="width: 0%"></div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- ================================================
                     STEP 3: PILIH TUJUAN PEMBELAJARAN
                     ================================================ -->
                <div id="step-3" class="bg-white rounded-2xl shadow-md p-6 mb-6 fade-in hidden">
                    
                    <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mr-4">
                                <span class="text-purple-600 font-bold text-xl">3</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Pilih Tujuan Pembelajaran (TP)</h3>
                                <p class="text-sm text-gray-500">Pilih TP yang akan diajarkan semester ini, lalu atur bulan pelaksanaannya</p>
                            </div>
                        </div>
                        
                        <!-- Filter Elemen -->
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-500">Filter:</span>
                            <select id="filter-elemen" 
                                    class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pai-hijau-500 outline-none">
                                <option value="semua">Semua Elemen</option>
                                <option value="AL_QURAN_HADIS">Al-Qur'an Hadis</option>
                                <option value="AKIDAH">Akidah</option>
                                <option value="AKHLAK">Akhlak</option>
                                <option value="FIKIH">Fikih</option>
                                <option value="SPI">Sejarah Islam</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Daftar TP per Elemen (Accordion) -->
                    <div id="daftar-tp-container" class="space-y-4">
                        <!-- Akan diisi oleh JavaScript -->
                    </div>
                    
                </div>
                
                <!-- ================================================
                     STEP 4: ALOKASI KE BULAN/MINGGU
                     ================================================ -->
                <div id="step-4" class="bg-white rounded-2xl shadow-md p-6 mb-6 fade-in hidden">
                    
                    <div class="flex items-center mb-6 pb-4 border-b border-gray-200">
                        <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center mr-4">
                            <span class="text-orange-600 font-bold text-xl">4</span>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Alokasi TP ke Bulan</h3>
                            <p class="text-sm text-gray-500">Tentukan bulan pelaksanaan untuk setiap TP yang dipilih</p>
                        </div>
                    </div>
                    
                    <!-- Tabel Alokasi -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-700 w-16">No</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-700">Kode TP</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-700">Tujuan Pembelajaran</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-700 w-24">JP</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-700 w-40">Bulan</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-700 w-32">Minggu Ke-</th>
                                </tr>
                            </thead>
                            <tbody id="tabel-alokasi">
                                <!-- Akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="pesan-tp-kosong" class="text-center py-8 text-gray-500 hidden">
                        <i class="fas fa-clipboard-list text-4xl mb-3"></i>
                        <p>Belum ada TP yang dipilih.</p>
                        <p class="text-sm">Silakan pilih TP dari daftar di atas.</p>
                    </div>
                    
                </div>
                
                <!-- ================================================
                     STEP 5: PREVIEW PROTA & PROMES
                     ================================================ -->
                <div id="step-5" class="fade-in hidden">
                    
                    <!-- Tab Navigation -->
                    <div class="flex space-x-2 mb-4">
                        <button onclick="showPreview('prota')" 
                                id="tab-prota"
                                class="tab-btn active px-6 py-3 rounded-xl font-medium transition-colors bg-gray-200 text-gray-700">
                            <i class="fas fa-calendar-alt mr-2"></i>
                            Preview PROTA
                        </button>
                        <button onclick="showPreview('promes')" 
                                id="tab-promes"
                                class="tab-btn px-6 py-3 rounded-xl font-medium transition-colors bg-gray-200 text-gray-700">
                            <i class="fas fa-list-alt mr-2"></i>
                            Preview PROMES
                        </button>
                    </div>
                    
                    <!-- Preview PROTA -->
                    <div id="preview-prota" class="bg-white rounded-2xl shadow-md p-6 mb-6">
                        
                        <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">PROGRAM TAHUNAN (PROTA)</h3>
                                <p class="text-sm text-gray-500">Pendidikan Agama Islam dan Budi Pekerti</p>
                            </div>
                            <button onclick="cetakProta()" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-print mr-2"></i>
                                Cetak PROTA
                            </button>
                        </div>
                        
                        <!-- Header Dokumen -->
                        <div class="bg-gray-50 rounded-xl p-4 mb-6">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p><span class="text-gray-500">Satuan Pendidikan:</span> <span id="prota-sekolah" class="font-medium">-</span></p>
                                    <p><span class="text-gray-500">Mata Pelajaran:</span> <span class="font-medium">Pendidikan Agama Islam & Budi Pekerti</span></p>
                                    <p><span class="text-gray-500">Kelas/Semester:</span> <span id="prota-kelas" class="font-medium">-</span></p>
                                </div>
                                <div>
                                    <p><span class="text-gray-500">Tahun Ajaran:</span> <span id="prota-tahun" class="font-medium">-</span></p>
                                    <p><span class="text-gray-500">Guru Pengampu:</span> <span id="prota-guru" class="font-medium">-</span></p>
                                    <p><span class="text-gray-500">NIP:</span> <span id="prota-nip" class="font-medium">-</span></p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabel PROTA -->
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300">
                                <thead>
                                    <tr class="bg-pai-hijau-600 text-white">
                                        <th class="border border-gray-300 px-4 py-3 text-center w-16">No</th>
                                        <th class="border border-gray-300 px-4 py-3 text-left">Elemen</th>
                                        <th class="border border-gray-300 px-4 py-3 text-left">Tujuan Pembelajaran</th>
                                        <th class="border border-gray-300 px-4 py-3 text-center w-20">JP</th>
                                        <th class="border border-gray-300 px-4 py-3 text-center w-32">Bulan</th>
                                        <th class="border border-gray-300 px-4 py-3 text-left">Keterangan</th>
                                    </tr>
                                </thead>
                                <tbody id="tabel-prota">
                                    <!-- Akan diisi JavaScript -->
                                </tbody>
                                <tfoot>
                                    <tr class="bg-gray-100 font-bold">
                                        <td colspan="3" class="border border-gray-300 px-4 py-3 text-right">Total JP</td>
                                        <td id="prota-total-jp" class="border border-gray-300 px-4 py-3 text-center">0</td>
                                        <td colspan="2" class="border border-gray-300 px-4 py-3"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <!-- Tanda Tangan -->
                        <div class="grid grid-cols-2 gap-8 mt-8 text-center text-sm">
                            <div>
                                <p>Mengetahui,</p>
                                <p>Kepala Sekolah</p>
                                <div class="h-20"></div>
                                <p class="font-medium border-b border-gray-400 pb-1 mx-8">...........................</p>
                                <p>NIP. ...........................</p>
                            </div>
                            <div>
                                <p id="prota-kota">................, ................</p>
                                <p>Guru PAI</p>
                                <div class="h-20"></div>
                                <p id="prota-ttd-guru" class="font-medium border-b border-gray-400 pb-1 mx-8">...........................</p>
                                <p id="prota-ttd-nip">NIP. ...........................</p>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Preview PROMES -->
                    <div id="preview-promes" class="bg-white rounded-2xl shadow-md p-6 mb-6 hidden">
                        
                        <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">PROGRAM SEMESTER (PROMES)</h3>
                                <p class="text-sm text-gray-500">Pendidikan Agama Islam dan Budi Pekerti</p>
                            </div>
                            <button onclick="cetakPromes()" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-print mr-2"></i>
                                Cetak PROMES
                            </button>
                        </div>
                        
                        <!-- Header Dokumen Promes -->
                        <div class="bg-gray-50 rounded-xl p-4 mb-6">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p><span class="text-gray-500">Satuan Pendidikan:</span> <span id="promes-sekolah" class="font-medium">-</span></p>
                                    <p><span class="text-gray-500">Mata Pelajaran:</span> <span class="font-medium">PAI & Budi Pekerti</span></p>
                                    <p><span class="text-gray-500">Kelas/Semester:</span> <span id="promes-kelas" class="font-medium">-</span></p>
                                </div>
                                <div>
                                    <p><span class="text-gray-500">Tahun Ajaran:</span> <span id="promes-tahun" class="font-medium">-</span></p>
                                    <p><span class="text-gray-500">Guru Pengampu:</span> <span id="promes-guru" class="font-medium">-</span></p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabel PROMES dengan Minggu -->
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300 text-sm">
                                <thead>
                                    <tr class="bg-pai-hijau-600 text-white">
                                        <th rowspan="2" class="border border-gray-300 px-2 py-2 text-center w-10">No</th>
                                        <th rowspan="2" class="border border-gray-300 px-2 py-2 text-left w-64">Tujuan Pembelajaran</th>
                                        <th rowspan="2" class="border border-gray-300 px-2 py-2 text-center w-12">JP</th>
                                        <th colspan="6" class="border border-gray-300 px-2 py-2 text-center" id="header-bulan-promes">
                                            Bulan
                                        </th>
                                        <th rowspan="2" class="border border-gray-300 px-2 py-2 text-center w-16">Ket</th>
                                    </tr>
                                    <tr class="bg-pai-hijau-500 text-white" id="header-minggu-promes">
                                        <!-- Akan diisi JavaScript -->
                                    </tr>
                                </thead>
                                <tbody id="tabel-promes">
                                    <!-- Akan diisi JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Keterangan -->
                        <div class="mt-4 text-sm text-gray-600">
                            <p class="font-medium mb-2">Keterangan:</p>
                            <div class="flex items-center space-x-6">
                                <div class="flex items-center">
                                    <div class="w-6 h-6 bg-pai-hijau-500 rounded mr-2"></div>
                                    <span>= Minggu Pembelajaran</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-6 h-6 bg-yellow-400 rounded mr-2"></div>
                                    <span>= PTS/PAS</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-6 h-6 bg-red-400 rounded mr-2"></div>
                                    <span>= Libur</span>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                </div>
                
                <!-- ================================================
                     TOMBOL SIMPAN
                     ================================================ -->
                <div id="tombol-simpan" class="flex justify-end gap-4 hidden">
                    <button type="button" 
                            onclick="resetPerencanaan()"
                            class="px-6 py-3 border border-gray-300 rounded-xl text-gray-700 hover:bg-gray-50 transition-colors">
                        <i class="fas fa-undo mr-2"></i>
                        Reset
                    </button>
                    
                    <button type="button" 
                            onclick="simpanPerencanaan()"
                            class="px-8 py-3 bg-pai-hijau-600 text-white font-bold rounded-xl hover:bg-pai-hijau-700 transition-colors shadow-lg">
                        <i class="fas fa-save mr-2"></i>
                        Simpan Prota & Promes
                    </button>
                </div>
                
            </div>
            
            <!-- Footer -->
            <footer class="bg-white border-t border-gray-200 px-8 py-4 text-center text-gray-500 text-sm">
                <p>¬© 2025 Admin PAI Satu Pintu - Berdasarkan Kepka BSKAP No. 046/H/KR/2025</p>
            </footer>
            
        </main>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-2xl text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600">Memproses data...</p>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/database.js"></script>
    <script src="js/master-cp.js"></script>
    
    <!-- ================================================
         SCRIPT HALAMAN PERENCANAAN
         ================================================ -->
    <script>
        /**
         * =====================================================
         * VARIABEL GLOBAL
         * =====================================================
         */
        
        // Data dari database
        let profilGuru = null;
        let dataKalender = null;
        
        // Data perencanaan yang sedang dikerjakan
        let kelasAktif = '';
        let semesterAktif = '';
        let faseAktif = '';
        let tpDipilih = [];  // Array TP yang dipilih beserta alokasinya
        
        // Konstanta bulan
        const BULAN_GANJIL = ['Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        const BULAN_GENAP = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni'];
        
        // Mapping warna untuk badge elemen
        const WARNA_ELEMEN = {
            'AL_QURAN_HADIS': 'badge-quran',
            'AKIDAH': 'badge-akidah',
            'AKHLAK': 'badge-akhlak',
            'FIKIH': 'badge-fikih',
            'SPI': 'badge-spi'
        };
        
        const NAMA_ELEMEN = {
            'AL_QURAN_HADIS': "Al-Qur'an Hadis",
            'AKIDAH': 'Akidah',
            'AKHLAK': 'Akhlak',
            'FIKIH': 'Fikih',
            'SPI': 'Sejarah Islam'
        };
        
        /**
         * =====================================================
         * INISIALISASI
         * =====================================================
         */
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthState();
            
            // Event listener filter
            document.getElementById('filter-elemen').addEventListener('change', filterTP);
        });
        
        /**
         * =====================================================
         * CEK AUTENTIKASI
         * =====================================================
         */
        function checkAuthState() {
            showLoading();
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    await loadInitialData(user.uid);
                    hideLoading();
                } else {
                    window.location.href = 'index.html';
                }
            });
        }
        
        /**
         * =====================================================
         * LOAD DATA AWAL
         * =====================================================
         */
        async function loadInitialData(userId) {
            try {
                // Load profil guru
                const profilDoc = await db.collection('users').doc(userId).get();
                if (profilDoc.exists) {
                    profilGuru = profilDoc.data();
                    
                    // Update sidebar
                    document.getElementById('nama-guru-sidebar').textContent = profilGuru.namaLengkap || 'Guru PAI';
                    
                    // Update display
                    document.getElementById('display-tahun-ajaran').textContent = 
                        profilGuru.tahunAjaran ? profilGuru.tahunAjaran.replace('-', '/') : '-';
                    
                    // Populate dropdown kelas dari profil
                    populateKelasDropdown(profilGuru.kelasAmpu || []);
                    
                    // Load kalender jika ada tahun ajaran
                    if (profilGuru.tahunAjaran) {
                        await loadKalender(userId, profilGuru.tahunAjaran);
                    }
                }
                
            } catch (error) {
                console.error("‚ùå Gagal load data awal:", error);
            }
        }
        
        /**
         * =====================================================
         * POPULATE DROPDOWN KELAS
         * =====================================================
         */
        function populateKelasDropdown(kelasAmpu) {
            const select = document.getElementById('select-kelas');
            select.innerHTML = '<option value="">-- Pilih Kelas --</option>';
            
            if (kelasAmpu.length === 0) {
                select.innerHTML += '<option value="" disabled>Belum ada kelas yang diampu</option>';
                return;
            }
            
            kelasAmpu.sort((a, b) => parseInt(a) - parseInt(b));
            
            kelasAmpu.forEach(kelas => {
                const fase = getFaseByKelas(kelas);
                const namaFase = MASTER_CP_PAI_2025[fase].nama;
                select.innerHTML += `<option value="${kelas}">Kelas ${kelas} (${namaFase})</option>`;
            });
        }
        
        /**
         * =====================================================
         * LOAD KALENDER
         * =====================================================
         */
        async function loadKalender(userId, tahunAjaran) {
            try {
                const kalenderDoc = await db.collection('users').doc(userId)
                    .collection('kalender')
                    .doc(tahunAjaran)
                    .get();
                
                if (kalenderDoc.exists) {
                    dataKalender = kalenderDoc.data();
                    console.log("üìÖ Kalender loaded:", dataKalender);
                }
                
            } catch (error) {
                console.error("‚ùå Gagal load kalender:", error);
            }
        }
        
        /**
         * =====================================================
         * LOAD DATA PERENCANAAN (dipanggil saat klik Mulai)
         * =====================================================
         */
        async function loadDataPerencanaan() {
            const kelas = document.getElementById('select-kelas').value;
            const semester = document.getElementById('select-semester').value;
            
            if (!kelas || !semester) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Data Belum Lengkap',
                    text: 'Silakan pilih kelas dan semester terlebih dahulu.',
                    confirmButtonColor: '#16a34a'
                });
                return;
            }
            
            // Validasi kalender
            if (!dataKalender) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Kalender Belum Diatur',
                    text: 'Silakan atur kalender pendidikan terlebih dahulu.',
                    confirmButtonColor: '#16a34a',
                    confirmButtonText: 'Atur Kalender'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = 'kalender.html';
                    }
                });
                return;
            }
            
            showLoading();
            
            // Set variabel aktif
            kelasAktif = kelas;
            semesterAktif = semester;
            faseAktif = getFaseByKelas(kelas);
            
            // Update display
            document.getElementById('display-kelas').textContent = `Kelas ${kelas}`;
            
            // Tampilkan info fase
            document.getElementById('info-fase').classList.remove('hidden');
            document.getElementById('nama-fase').textContent = `${MASTER_CP_PAI_2025[faseAktif].nama} (Kelas ${MASTER_CP_PAI_2025[faseAktif].kelas.join(' & ')})`;
            document.getElementById('deskripsi-fase').textContent = 'Capaian Pembelajaran sesuai Kepka BSKAP No. 046/H/KR/2025';
            
            // Update info waktu
            updateInfoWaktu();
            
            // Render daftar TP
            renderDaftarTP();
            
            // Cek apakah sudah ada data tersimpan
            await loadPerencanaanTersimpan();
            
            // Tampilkan step berikutnya
            document.getElementById('step-2').classList.remove('hidden');
            document.getElementById('step-3').classList.remove('hidden');
            document.getElementById('step-4').classList.remove('hidden');
            document.getElementById('step-5').classList.remove('hidden');
            document.getElementById('tombol-simpan').classList.remove('hidden');
            
            hideLoading();
            
            // Scroll ke step 2
            document.getElementById('step-2').scrollIntoView({ behavior: 'smooth' });
        }
        
        /**
         * =====================================================
         * UPDATE INFO WAKTU DARI KALENDER
         * =====================================================
         */
        function updateInfoWaktu() {
            if (!dataKalender) return;
            
            const dataSemester = dataKalender[semesterAktif];
            if (!dataSemester) return;
            
            const mingguEfektif = dataSemester.totalMingguEfektif || 0;
            const jpPerMinggu = dataKalender.jpPerMinggu || 4;
            const totalJP = dataSemester.totalJP || (mingguEfektif * jpPerMinggu);
            
            document.getElementById('info-minggu-efektif').textContent = mingguEfektif;
            document.getElementById('info-total-jp').textContent = totalJP;
            
            updateProgressAlokasi();
        }
        
        /**
         * =====================================================
         * UPDATE PROGRESS ALOKASI JP
         * =====================================================
         */
        function updateProgressAlokasi() {
            const dataSemester = dataKalender ? dataKalender[semesterAktif] : null;
            const totalJP = dataSemester ? dataSemester.totalJP : 0;
            
            let jpTerpakai = 0;
            tpDipilih.forEach(tp => {
                jpTerpakai += tp.alokasi_waktu || 0;
            });
            
            const jpSisa = totalJP - jpTerpakai;
            const persen = totalJP > 0 ? Math.round((jpTerpakai / totalJP) * 100) : 0;
            
            document.getElementById('info-jp-terpakai').textContent = jpTerpakai;
            document.getElementById('info-jp-sisa').textContent = jpSisa;
            document.getElementById('persen-alokasi').textContent = persen + '%';
            document.getElementById('progress-alokasi').style.width = Math.min(persen, 100) + '%';
            
            // Warna progress bar
            const progressBar = document.getElementById('progress-alokasi');
            if (persen > 100) {
                progressBar.classList.remove('from-pai-hijau-400', 'to-pai-hijau-600');
                progressBar.classList.add('from-red-400', 'to-red-600');
            } else {
                progressBar.classList.remove('from-red-400', 'to-red-600');
                progressBar.classList.add('from-pai-hijau-400', 'to-pai-hijau-600');
            }
        }
        
        /**
         * =====================================================
         * RENDER DAFTAR TP (ACCORDION PER ELEMEN)
         * =====================================================
         */
        function renderDaftarTP() {
            const container = document.getElementById('daftar-tp-container');
            container.innerHTML = '';
            
            const dataFase = MASTER_CP_PAI_2025[faseAktif];
            
            Object.keys(dataFase.elemen).forEach((elemenKey, idx) => {
                const elemen = dataFase.elemen[elemenKey];
                
                const accordionHTML = `
                    <div class="border border-gray-200 rounded-xl overflow-hidden" data-elemen="${elemenKey}">
                        <!-- Header Accordion -->
                        <button type="button" 
                                onclick="toggleAccordion('${elemenKey}')"
                                class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors">
                            <div class="flex items-center">
                                <span class="px-3 py-1 rounded-full text-xs font-medium ${WARNA_ELEMEN[elemenKey]} mr-3">
                                    ${elemen.nama}
                                </span>
                                <span class="text-gray-600 text-sm">
                                    ${elemen.tujuan_pembelajaran.length} Tujuan Pembelajaran
                                </span>
                            </div>
                            <div class="flex items-center">
                                <span class="text-sm text-gray-500 mr-3" id="count-${elemenKey}">
                                    0 dipilih
                                </span>
                                <i class="fas fa-chevron-down text-gray-400 transition-transform" id="icon-${elemenKey}"></i>
                            </div>
                        </button>
                        
                        <!-- Content Accordion -->
                        <div id="content-${elemenKey}" class="accordion-content">
                            <div class="p-4 space-y-3 bg-white">
                                <!-- Capaian Pembelajaran -->
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                                    <p class="text-xs font-medium text-blue-700 mb-1">Capaian Pembelajaran:</p>
                                    <p class="text-sm text-blue-800">${elemen.capaian_pembelajaran}</p>
                                </div>
                                
                                <!-- Daftar TP -->
                                ${elemen.tujuan_pembelajaran.map((tp, tpIdx) => `
                                    <div class="tp-card relative border-2 border-gray-200 rounded-xl p-4 ${isTpDipilih(tp.kode) ? 'selected' : ''}"
                                         onclick="toggleTP('${elemenKey}', ${tpIdx}, '${tp.kode}')"
                                         id="card-${tp.kode}">
                                        <div class="flex items-start justify-between">
                                            <div class="flex-1">
                                                <div class="flex items-center mb-2">
                                                    <span class="bg-gray-200 text-gray-700 px-2 py-1 rounded text-xs font-mono mr-2">
                                                        ${tp.kode}
                                                    </span>
                                                    <span class="text-xs text-gray-500">
                                                        ${tp.alokasi_waktu} JP
                                                    </span>
                                                </div>
                                                <p class="text-sm text-gray-700">${tp.deskripsi}</p>
                                            </div>
                                            <div class="ml-4">
                                                <div class="w-6 h-6 rounded-full border-2 ${isTpDipilih(tp.kode) ? 'bg-pai-hijau-500 border-pai-hijau-500' : 'border-gray-300'} flex items-center justify-center">
                                                    ${isTpDipilih(tp.kode) ? '<i class="fas fa-check text-white text-xs"></i>' : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                container.innerHTML += accordionHTML;
            });
            
            // Buka accordion pertama
            setTimeout(() => {
                toggleAccordion('AL_QURAN_HADIS');
            }, 100);
        }
        
        /**
         * =====================================================
         * TOGGLE ACCORDION
         * =====================================================
         */
        function toggleAccordion(elemenKey) {
            const content = document.getElementById(`content-${elemenKey}`);
            const icon = document.getElementById(`icon-${elemenKey}`);
            
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('open');
                icon.style.transform = 'rotate(180deg)';
            }
        }
        
        /**
         * =====================================================
         * CEK APAKAH TP SUDAH DIPILIH
         * =====================================================
         */
        function isTpDipilih(kode) {
            return tpDipilih.some(tp => tp.kode === kode);
        }
        
        /**
         * =====================================================
         * TOGGLE PILIHAN TP
         * =====================================================
         */
        function toggleTP(elemenKey, tpIdx, kode) {
            const dataFase = MASTER_CP_PAI_2025[faseAktif];
            const tp = dataFase.elemen[elemenKey].tujuan_pembelajaran[tpIdx];
            
            const existingIdx = tpDipilih.findIndex(t => t.kode === kode);
            
            if (existingIdx >= 0) {
                // Hapus dari pilihan
                tpDipilih.splice(existingIdx, 1);
            } else {
                // Tambah ke pilihan
                tpDipilih.push({
                    ...tp,
                    elemen: elemenKey,
                    namaElemen: NAMA_ELEMEN[elemenKey],
                    bulan: '',
                    mingguKe: ''
                });
            }
            
            // Update tampilan
            updateTPCard(kode);
            updateCountElemen(elemenKey);
            updateTabelAlokasi();
            updateProgressAlokasi();
            updatePreview();
        }
        
        /**
         * =====================================================
         * UPDATE TAMPILAN CARD TP
         * =====================================================
         */
        function updateTPCard(kode) {
            const card = document.getElementById(`card-${kode}`);
            if (!card) return;
            
            const isSelected = isTpDipilih(kode);
            
            if (isSelected) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
            
            // Update checkbox visual
            const checkbox = card.querySelector('.rounded-full');
            if (isSelected) {
                checkbox.classList.add('bg-pai-hijau-500', 'border-pai-hijau-500');
                checkbox.classList.remove('border-gray-300');
                checkbox.innerHTML = '<i class="fas fa-check text-white text-xs"></i>';
            } else {
                checkbox.classList.remove('bg-pai-hijau-500', 'border-pai-hijau-500');
                checkbox.classList.add('border-gray-300');
                checkbox.innerHTML = '';
            }
        }
        
        /**
         * =====================================================
         * UPDATE COUNT TP YANG DIPILIH PER ELEMEN
         * =====================================================
         */
        function updateCountElemen(elemenKey) {
            const count = tpDipilih.filter(tp => tp.elemen === elemenKey).length;
            const countEl = document.getElementById(`count-${elemenKey}`);
            if (countEl) {
                countEl.textContent = `${count} dipilih`;
                countEl.className = count > 0 ? 'text-sm text-pai-hijau-600 font-medium mr-3' : 'text-sm text-gray-500 mr-3';
            }
        }
        
        /**
         * =====================================================
         * FILTER TP BERDASARKAN ELEMEN
         * =====================================================
         */
        function filterTP() {
            const filter = document.getElementById('filter-elemen').value;
            const accordions = document.querySelectorAll('#daftar-tp-container > div');
            
            accordions.forEach(acc => {
                const elemenKey = acc.dataset.elemen;
                if (filter === 'semua' || elemenKey === filter) {
                    acc.classList.remove('hidden');
                } else {
                    acc.classList.add('hidden');
                }
            });
        }
        
        /**
         * =====================================================
         * UPDATE TABEL ALOKASI
         * =====================================================
         */
        function updateTabelAlokasi() {
            const tbody = document.getElementById('tabel-alokasi');
            const pesanKosong = document.getElementById('pesan-tp-kosong');
            
            if (tpDipilih.length === 0) {
                tbody.innerHTML = '';
                pesanKosong.classList.remove('hidden');
                return;
            }
            
            pesanKosong.classList.add('hidden');
            
            // Daftar bulan berdasarkan semester
            const daftarBulan = semesterAktif === 'ganjil' ? BULAN_GANJIL : BULAN_GENAP;
            
            // Sort TP berdasarkan elemen dan kode
            const tpSorted = [...tpDipilih].sort((a, b) => {
                if (a.elemen !== b.elemen) return a.elemen.localeCompare(b.elemen);
                return a.kode.localeCompare(b.kode);
            });
            
            tbody.innerHTML = tpSorted.map((tp, idx) => `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-3 text-center">${idx + 1}</td>
                    <td class="border border-gray-200 px-4 py-3">
                        <span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">${tp.kode}</span>
                    </td>
                    <td class="border border-gray-200 px-4 py-3 text-sm">${tp.deskripsi}</td>
                    <td class="border border-gray-200 px-4 py-3 text-center">
                        <input type="number" 
                               value="${tp.alokasi_waktu}"
                               min="1" max="20"
                               onchange="updateJP('${tp.kode}', this.value)"
                               class="w-16 px-2 py-1 border border-gray-300 rounded text-center text-sm">
                    </td>
                    <td class="border border-gray-200 px-4 py-3">
                        <select onchange="updateBulan('${tp.kode}', this.value)"
                                class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                            <option value="">Pilih Bulan</option>
                            ${daftarBulan.map(bulan => `
                                <option value="${bulan}" ${tp.bulan === bulan ? 'selected' : ''}>${bulan}</option>
                            `).join('')}
                        </select>
                    </td>
                    <td class="border border-gray-200 px-4 py-3">
                        <input type="text" 
                               value="${tp.mingguKe || ''}"
                               placeholder="Cth: 1-2"
                               onchange="updateMinggu('${tp.kode}', this.value)"
                               class="w-full px-2 py-1 border border-gray-300 rounded text-sm text-center">
                    </td>
                </tr>
            `).join('');
        }
        
        /**
         * =====================================================
         * UPDATE JP TP
         * =====================================================
         */
        function updateJP(kode, nilai) {
            const tp = tpDipilih.find(t => t.kode === kode);
            if (tp) {
                tp.alokasi_waktu = parseInt(nilai) || 0;
                updateProgressAlokasi();
                updatePreview();
            }
        }
        
        /**
         * =====================================================
         * UPDATE BULAN TP
         * =====================================================
         */
        function updateBulan(kode, bulan) {
            const tp = tpDipilih.find(t => t.kode === kode);
            if (tp) {
                tp.bulan = bulan;
                updatePreview();
            }
        }
        
        /**
         * =====================================================
         * UPDATE MINGGU TP
         * =====================================================
         */
        function updateMinggu(kode, minggu) {
            const tp = tpDipilih.find(t => t.kode === kode);
            if (tp) {
                tp.mingguKe = minggu;
                updatePreview();
            }
        }
        
        /**
         * =====================================================
         * SHOW PREVIEW (PROTA / PROMES)
         * =====================================================
         */
        function showPreview(jenis) {
            // Update tab
            document.getElementById('tab-prota').classList.remove('active');
            document.getElementById('tab-promes').classList.remove('active');
            document.getElementById(`tab-${jenis}`).classList.add('active');
            
            // Show/hide preview
            document.getElementById('preview-prota').classList.add('hidden');
            document.getElementById('preview-promes').classList.add('hidden');
            document.getElementById(`preview-${jenis}`).classList.remove('hidden');
        }
        
        /**
         * =====================================================
         * UPDATE PREVIEW PROTA & PROMES
         * =====================================================
         */
        function updatePreview() {
            updatePreviewProta();
            updatePreviewPromes();
        }
        
        /**
         * =====================================================
         * UPDATE PREVIEW PROTA
         * =====================================================
         */
        function updatePreviewProta() {
            // Update header
            document.getElementById('prota-sekolah').textContent = profilGuru?.namaSekolah || '-';
            document.getElementById('prota-kelas').textContent = `${kelasAktif} / ${semesterAktif === 'ganjil' ? '1 (Ganjil)' : '2 (Genap)'}`;
            document.getElementById('prota-tahun').textContent = profilGuru?.tahunAjaran?.replace('-', '/') || '-';
            document.getElementById('prota-guru').textContent = profilGuru?.namaLengkap || '-';
            document.getElementById('prota-nip').textContent = profilGuru?.nip || '-';
            
            // Update tanda tangan
            document.getElementById('prota-kota').textContent = `${profilGuru?.kabupaten || '................'}, ${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}`;
            document.getElementById('prota-ttd-guru').textContent = profilGuru?.namaLengkap || '...........................';
            document.getElementById('prota-ttd-nip').textContent = profilGuru?.nip ? `NIP. ${profilGuru.nip}` : 'NIP. ...........................';
            
            // Update tabel
            const tbody = document.getElementById('tabel-prota');
            
            if (tpDipilih.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="border border-gray-300 px-4 py-8 text-center text-gray-500">Belum ada TP yang dipilih</td></tr>';
                document.getElementById('prota-total-jp').textContent = '0';
                return;
            }
            
            // Sort berdasarkan bulan
            const daftarBulan = semesterAktif === 'ganjil' ? BULAN_GANJIL : BULAN_GENAP;
            const tpSorted = [...tpDipilih].sort((a, b) => {
                const idxA = daftarBulan.indexOf(a.bulan);
                const idxB = daftarBulan.indexOf(b.bulan);
                if (idxA !== idxB) return idxA - idxB;
                return a.kode.localeCompare(b.kode);
            });
            
            let totalJP = 0;
            
            tbody.innerHTML = tpSorted.map((tp, idx) => {
                totalJP += tp.alokasi_waktu;
                return `
                    <tr>
                        <td class="border border-gray-300 px-4 py-2 text-center">${idx + 1}</td>
                        <td class="border border-gray-300 px-4 py-2 text-sm">${tp.namaElemen}</td>
                        <td class="border border-gray-300 px-4 py-2 text-sm">${tp.deskripsi}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${tp.alokasi_waktu}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${tp.bulan || '-'}</td>
                        <td class="border border-gray-300 px-4 py-2 text-sm">${tp.mingguKe ? `Minggu ke-${tp.mingguKe}` : ''}</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('prota-total-jp').textContent = totalJP;
        }
        
        /**
         * =====================================================
         * UPDATE PREVIEW PROMES
         * =====================================================
         */
        function updatePreviewPromes() {
            // Update header
            document.getElementById('promes-sekolah').textContent = profilGuru?.namaSekolah || '-';
            document.getElementById('promes-kelas').textContent = `${kelasAktif} / ${semesterAktif === 'ganjil' ? '1' : '2'}`;
            document.getElementById('promes-tahun').textContent = profilGuru?.tahunAjaran?.replace('-', '/') || '-';
            document.getElementById('promes-guru').textContent = profilGuru?.namaLengkap || '-';
            
            // Generate header bulan dan minggu
            const daftarBulan = semesterAktif === 'ganjil' ? BULAN_GANJIL : BULAN_GENAP;
            
            document.getElementById('header-bulan-promes').setAttribute('colspan', daftarBulan.length);
            
            const headerMinggu = document.getElementById('header-minggu-promes');
            headerMinggu.innerHTML = daftarBulan.map(bulan => 
                `<th class="border border-gray-300 px-1 py-2 text-center text-xs">${bulan.substring(0, 3)}</th>`
            ).join('');
            
            // Update tabel
            const tbody = document.getElementById('tabel-promes');
            
            if (tpDipilih.length === 0) {
                const colSpan = 4 + daftarBulan.length;
                tbody.innerHTML = `<tr><td colspan="${colSpan}" class="border border-gray-300 px-4 py-8 text-center text-gray-500">Belum ada TP yang dipilih</td></tr>`;
                return;
            }
            
            // Urutkan TP
            const tpSorted = [...tpDipilih].sort((a, b) => {
                const idxA = daftarBulan.indexOf(a.bulan);
                const idxB = daftarBulan.indexOf(b.bulan);
                if (idxA !== idxB) return idxA - idxB;
                return a.kode.localeCompare(b.kode);
            });
            
            tbody.innerHTML = tpSorted.map((tp, idx) => {
                // Generate sel bulan
                const selBulan = daftarBulan.map(bulan => {
                    if (tp.bulan === bulan) {
                        return `<td class="border border-gray-300 px-1 py-2 text-center bg-pai-hijau-500 text-white text-xs">‚úì</td>`;
                    }
                    return `<td class="border border-gray-300 px-1 py-2"></td>`;
                }).join('');
                
                return `
                    <tr>
                        <td class="border border-gray-300 px-2 py-2 text-center text-xs">${idx + 1}</td>
                        <td class="border border-gray-300 px-2 py-2 text-xs">${tp.deskripsi}</td>
                        <td class="border border-gray-300 px-2 py-2 text-center text-xs">${tp.alokasi_waktu}</td>
                        ${selBulan}
                        <td class="border border-gray-300 px-2 py-2 text-center text-xs"></td>
                    </tr>
                `;
            }).join('');
        }
        
        /**
         * =====================================================
         * LOAD PERENCANAAN YANG SUDAH TERSIMPAN
         * =====================================================
         */
        async function loadPerencanaanTersimpan() {
            try {
                const user = auth.currentUser;
                if (!user) return;
                
                const docId = `${profilGuru.tahunAjaran}_${semesterAktif}_${kelasAktif}`;
                
                const doc = await db.collection('users').doc(user.uid)
                    .collection('perencanaan')
                    .doc(docId)
                    .get();
                
                if (doc.exists) {
                    const data = doc.data();
                    console.log("üìã Data perencanaan ditemukan:", data);
                    
                    if (data.tpDipilih && data.tpDipilih.length > 0) {
                        tpDipilih = data.tpDipilih;
                        
                        // Update tampilan
                        tpDipilih.forEach(tp => {
                            updateTPCard(tp.kode);
                            updateCountElemen(tp.elemen);
                        });
                        
                        updateTabelAlokasi();
                        updateProgressAlokasi();
                        updatePreview();
                        
                        Swal.fire({
                            icon: 'info',
                            title: 'Data Ditemukan',
                            text: 'Data perencanaan sebelumnya berhasil dimuat.',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    }
                }
                
            } catch (error) {
                console.error("‚ùå Gagal load perencanaan:", error);
            }
        }
        
        /**
         * =====================================================
         * SIMPAN PERENCANAAN
         * =====================================================
         */
        async function simpanPerencanaan() {
            if (tpDipilih.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Tidak Ada TP Dipilih',
                    text: 'Silakan pilih minimal satu Tujuan Pembelajaran.',
                    confirmButtonColor: '#16a34a'
                });
                return;
            }
            
            // Validasi bulan
            const tpTanpaBulan = tpDipilih.filter(tp => !tp.bulan);
            if (tpTanpaBulan.length > 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Bulan Belum Lengkap',
                    html: `<p>${tpTanpaBulan.length} TP belum ditentukan bulannya.</p><p class="text-sm text-gray-500 mt-2">Silakan lengkapi bulan pelaksanaan di tabel alokasi.</p>`,
                    confirmButtonColor: '#16a34a'
                });
                return;
            }
            
            showLoading();
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error("User tidak login");
                
                const docId = `${profilGuru.tahunAjaran}_${semesterAktif}_${kelasAktif}`;
                
                const dataPerencanaan = {
                    tahunAjaran: profilGuru.tahunAjaran,
                    semester: semesterAktif,
                    kelas: kelasAktif,
                    fase: faseAktif,
                    tpDipilih: tpDipilih,
                    totalJP: tpDipilih.reduce((sum, tp) => sum + (tp.alokasi_waktu || 0), 0),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(user.uid)
                    .collection('perencanaan')
                    .doc(docId)
                    .set(dataPerencanaan, { merge: true });
                
                hideLoading();
                
                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil Disimpan!',
                    html: `
                        <p>Prota & Promes untuk Kelas ${kelasAktif} Semester ${semesterAktif === 'ganjil' ? 'Ganjil' : 'Genap'} berhasil disimpan.</p>
                        <div class="mt-4 text-left bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">üìä <strong>Ringkasan:</strong></p>
                            <ul class="text-sm text-gray-600 mt-2">
                                <li>‚Ä¢ Total TP: ${tpDipilih.length} TP</li>
                                <li>‚Ä¢ Total JP: ${dataPerencanaan.totalJP} JP</li>
                            </ul>
                        </div>
                    `,
                    confirmButtonColor: '#16a34a',
                    confirmButtonText: 'Cetak Dokumen',
                    showCancelButton: true,
                    cancelButtonText: 'Tutup'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = 'cetak.html';
                    }
                });
                
                console.log("‚úÖ Perencanaan berhasil disimpan");
                
            } catch (error) {
                console.error("‚ùå Gagal menyimpan:", error);
                hideLoading();
                
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal Menyimpan',
                    text: 'Terjadi kesalahan. Silakan coba lagi.',
                    confirmButtonColor: '#16a34a'
                });
            }
        }
        
        /**
         * =====================================================
         * RESET PERENCANAAN
         * =====================================================
         */
        function resetPerencanaan() {
            Swal.fire({
                title: 'Reset Perencanaan?',
                text: 'Semua pilihan TP akan dihapus.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#16a34a',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ya, Reset',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Reset data
                    tpDipilih = [];
                    
                    // Re-render
                    renderDaftarTP();
                    updateTabelAlokasi();
                    updateProgressAlokasi();
                    updatePreview();
                    
                    Swal.fire({
                        icon: 'info',
                        title: 'Berhasil Direset',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        }
        
        /**
         * =====================================================
         * CETAK PROTA
         * =====================================================
         */
        function cetakProta() {
            showPreview('prota');
            setTimeout(() => {
                window.print();
            }, 500);
        }
        
        /**
         * =====================================================
         * CETAK PROMES
         * =====================================================
         */
        function cetakPromes() {
            showPreview('promes');
            setTimeout(() => {
                window.print();
            }, 500);
        }
        
        /**
         * =====================================================
         * LOGOUT
         * =====================================================
         */
        async function logoutUser() {
            const result = await Swal.fire({
                title: 'Keluar?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#16a34a',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ya, Keluar',
                cancelButtonText: 'Batal'
            });
            
            if (result.isConfirmed) {
                await auth.signOut();
                window.location.href = 'index.html';
            }
        }
        
        /**
         * =====================================================
         * LOADING HELPERS
         * =====================================================
         */
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
    </script>
    
    <!-- Print Styles -->
    <style media="print">
        body * {
            visibility: hidden;
        }
        #preview-prota, #preview-prota *, 
        #preview-promes, #preview-promes * {
            visibility: visible;
        }
        #preview-prota, #preview-promes {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
        .no-print {
            display: none !important;
        }
    </style>
    
</body>
</html>