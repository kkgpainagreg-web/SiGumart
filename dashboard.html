<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Admin Guru Super App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                        'arabic': ['Traditional Arabic', 'Scheherazade New', 'serif'],
                    },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        .rtl-text { direction: rtl; font-family: 'Traditional Arabic', 'Scheherazade New', serif; }
        .sidebar-item.active { background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%); border-left: 3px solid #3b82f6; }
        .sidebar-item:hover:not(.active) { background: rgba(59, 130, 246, 0.05); }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px -8px rgba(0,0,0,0.15); }
        .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        @media print {
            .no-print { display: none !important; }
            .print-content { padding: 0 !important; margin: 0 !important; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center hidden">
        <div class="bg-white rounded-2xl p-8 flex flex-col items-center space-y-4 shadow-2xl">
            <div class="loading-spinner"></div>
            <p class="text-gray-600 font-medium" id="loadingText">Memproses...</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 z-[100] transform translate-x-full transition-transform duration-300">
        <div id="toastContent" class="px-6 py-4 rounded-xl shadow-2xl flex items-center space-x-3">
            <i id="toastIcon" class="text-xl"></i>
            <span id="toastMessage" class="font-medium"></span>
        </div>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed left-0 top-0 h-full w-72 bg-white shadow-xl z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col">
        <!-- Logo -->
        <div class="p-6 border-b border-gray-100">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-gradient-to-br from-primary-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-chalkboard-teacher text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-800">Admin Guru</h1>
                    <p class="text-xs text-gray-500">Super App</p>
                </div>
            </div>
        </div>

        <!-- User Info Card -->
        <div class="p-4">
            <div class="bg-gradient-to-r from-primary-500 to-purple-600 rounded-xl p-4 text-white">
                <div class="flex items-center space-x-3">
                    <img id="userAvatar" src="https://ui-avatars.com/api/?name=User&background=ffffff&color=3b82f6" 
                         class="w-12 h-12 rounded-full border-2 border-white border-opacity-30" alt="Avatar">
                    <div class="flex-1 min-w-0">
                        <p id="userName" class="font-semibold truncate">Loading...</p>
                        <p id="userEmail" class="text-xs text-white text-opacity-80 truncate">Loading...</p>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-white border-opacity-20">
                    <div class="flex items-center justify-between">
                        <span id="subscriptionBadge" class="px-2 py-1 bg-white bg-opacity-20 rounded-full text-xs font-medium">
                            Free
                        </span>
                        <span id="academicYearBadge" class="text-xs text-white text-opacity-80">
                            2024/2025
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto px-3 py-2">
            <!-- Main Menu -->
            <div class="mb-6">
                <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Menu Utama</p>
                <a href="#" onclick="loadSection('dashboard')" class="sidebar-item active flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-home w-5 text-center text-primary-500"></i>
                    <span class="font-medium">Dashboard</span>
                </a>
                <a href="#" onclick="loadSection('profile')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-user w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Profil & Sekolah</span>
                </a>
            </div>

            <!-- Data Dasar -->
            <div class="mb-6">
                <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Data Dasar</p>
                <a href="#" onclick="loadSection('calendar')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-calendar-alt w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Kalender Pendidikan</span>
                </a>
                <a href="#" onclick="loadSection('schedule')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-clock w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Jadwal Pelajaran</span>
                </a>
                <a href="#" onclick="loadSection('students')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-users w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Data Siswa</span>
                </a>
            </div>

            <!-- Dokumen -->
            <div class="mb-6">
                <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Dokumen Pembelajaran</p>
                <a href="#" onclick="loadSection('cp')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-bullseye w-5 text-center text-gray-400"></i>
                    <span class="font-medium">CP & TP</span>
                </a>
                <a href="#" onclick="loadSection('atp')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-route w-5 text-center text-gray-400"></i>
                    <span class="font-medium">ATP</span>
                </a>
                <a href="#" onclick="loadSection('prota')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-calendar-check w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Prota</span>
                </a>
                <a href="#" onclick="loadSection('promes')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-calendar-week w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Promes</span>
                </a>
                <a href="#" onclick="loadSection('modul-ajar')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all premium-feature">
                    <i class="fas fa-book w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Modul Ajar</span>
                    <span class="ml-auto px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full">Premium</span>
                </a>
                <a href="#" onclick="loadSection('lkpd')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all premium-feature">
                    <i class="fas fa-file-alt w-5 text-center text-gray-400"></i>
                    <span class="font-medium">LKPD</span>
                    <span class="ml-auto px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full">Premium</span>
                </a>
            </div>

            <!-- Akademik -->
            <div class="mb-6">
                <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Akademik</p>
                <a href="#" onclick="loadSection('attendance')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-clipboard-check w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Absensi</span>
                </a>
                <a href="#" onclick="loadSection('journal')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-journal-whills w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Jurnal Pembelajaran</span>
                </a>
                <a href="#" onclick="loadSection('grades')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-star w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Daftar Nilai</span>
                </a>
                <a href="#" onclick="loadSection('bank-soal')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all premium-feature">
                    <i class="fas fa-question-circle w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Bank Soal</span>
                    <span class="ml-auto px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full">Premium</span>
                </a>
            </div>

            <!-- Tools -->
            <div class="mb-6">
                <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Tools</p>
                <a href="#" onclick="loadSection('ai-assistant')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-robot w-5 text-center text-gray-400"></i>
                    <span class="font-medium">AI Assistant</span>
                </a>
                <a href="#" onclick="loadSection('import-data')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-file-import w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Import Data</span>
                </a>
                <a href="#" onclick="loadSection('guide')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-book-open w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Panduan</span>
                </a>
            </div>
        </nav>

        <!-- Upgrade Banner -->
        <div id="upgradeBanner" class="p-4 border-t border-gray-100">
            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-4 border border-yellow-200">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-crown text-yellow-600"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">Upgrade Premium</p>
                        <p class="text-xs text-gray-500">Akses semua fitur</p>
                    </div>
                </div>
                <button onclick="showUpgradeModal()" class="w-full py-2 bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-semibold rounded-lg hover:from-yellow-600 hover:to-orange-600 transition-all text-sm">
                    Upgrade Sekarang
                </button>
            </div>
        </div>

        <!-- Logout -->
        <div class="p-4 border-t border-gray-100">
            <button onclick="logout()" class="w-full flex items-center justify-center space-x-2 py-3 text-red-600 hover:bg-red-50 rounded-lg transition-all font-medium">
                <i class="fas fa-sign-out-alt"></i>
                <span>Keluar</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="lg:ml-72 min-h-screen">
        <!-- Top Header -->
        <header class="bg-white shadow-sm sticky top-0 z-30 no-print">
            <div class="flex items-center justify-between px-4 lg:px-8 py-4">
                <!-- Mobile Menu Button -->
                <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <i class="fas fa-bars text-gray-600 text-xl"></i>
                </button>

                <!-- Page Title -->
                <div class="hidden lg:block">
                    <h1 id="pageTitle" class="text-xl font-bold text-gray-800">Dashboard</h1>
                    <p id="pageSubtitle" class="text-sm text-gray-500">Selamat datang kembali!</p>
                </div>

                <!-- Right Actions -->
                <div class="flex items-center space-x-4">
                    <!-- Academic Year Selector -->
                    <select id="academicYearSelect" onchange="changeAcademicYear(this.value)" 
                            class="px-4 py-2 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    </select>

                    <!-- Notifications -->
                    <button class="relative p-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fas fa-bell text-gray-600 text-lg"></i>
                        <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                    </button>

                    <!-- User Menu -->
                    <div class="relative">
                        <button onclick="toggleUserMenu()" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100 transition-colors">
                            <img id="headerUserAvatar" src="https://ui-avatars.com/api/?name=User&background=3b82f6&color=fff" 
                                 class="w-8 h-8 rounded-full" alt="Avatar">
                            <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                        </button>
                        <div id="userMenu" class="absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-xl border border-gray-100 hidden">
                            <a href="#" onclick="loadSection('profile')" class="flex items-center space-x-3 px-4 py-3 hover:bg-gray-50 transition-colors">
                                <i class="fas fa-user text-gray-400"></i>
                                <span class="text-gray-700">Profil</span>
                            </a>
                            <a href="#" onclick="loadSection('guide')" class="flex items-center space-x-3 px-4 py-3 hover:bg-gray-50 transition-colors">
                                <i class="fas fa-question-circle text-gray-400"></i>
                                <span class="text-gray-700">Bantuan</span>
                            </a>
                            <hr class="my-1">
                            <a href="#" onclick="logout()" class="flex items-center space-x-3 px-4 py-3 hover:bg-red-50 transition-colors text-red-600">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Keluar</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <div id="contentArea" class="p-4 lg:p-8">
            <!-- Content will be loaded here -->
        </div>
    </main>

    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i class="fas fa-crown text-white text-3xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">Upgrade ke Premium</h3>
                <p class="text-gray-500">Dapatkan akses penuh ke semua fitur aplikasi</p>
            </div>

            <div class="space-y-3 mb-6">
                <div class="flex items-center space-x-3 text-gray-700">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <span>Modul Ajar lengkap dengan LKPD</span>
                </div>
                <div class="flex items-center space-x-3 text-gray-700">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <span>Bank Soal terintegrasi ATP</span>
                </div>
                <div class="flex items-center space-x-3 text-gray-700">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <span>Export dokumen ke Word/PDF</span>
                </div>
                <div class="flex items-center space-x-3 text-gray-700">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <span>Support teks Arab (RTL)</span>
                </div>
                <div class="flex items-center space-x-3 text-gray-700">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <span>Prioritas dukungan teknis</span>
                </div>
            </div>

            <div class="space-y-3">
                <a id="whatsappUpgradeLink" href="#" target="_blank" 
                   class="block w-full py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-xl hover:from-green-600 hover:to-green-700 transition-all text-center">
                    <i class="fab fa-whatsapp mr-2"></i>
                    Hubungi via WhatsApp
                </a>
                <button onclick="closeUpgradeModal()" class="w-full py-3 border border-gray-200 text-gray-600 font-medium rounded-xl hover:bg-gray-50 transition-all">
                    Nanti Saja
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- Main Application Script -->
    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
        apiKey: "AIzaSyDe4ie2wSPEpNbAgWP-q03vTuHyxc9Jj3E",
        authDomain: "agsa-e5b08.firebaseapp.com",
        projectId: "agsa-e5b08",
        storageBucket: "agsa-e5b08.firebasestorage.app",
        messagingSenderId: "916052746331",
        appId: "1:916052746331:web:357cbadbfd8658f1689f7e",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ===== GLOBAL STATE =====
        let currentUser = null;
        let userData = null;
        let currentSection = 'dashboard';
        let whatsappAdmin = '6281234567890';

        // ===== CP DATA (PAI - Kepka BSKAP No. 046/H/KR/2025) =====
        const CP_DATA_PAI = {
            phases: {
                'A': {
                    name: 'Fase A',
                    grades: ['1', '2'],
                    level: 'SD',
                    elements: [
                        {
                            id: 'quran-hadis-a',
                            name: 'Al-Quran dan Hadis',
                            description: 'Mengenal huruf hijaiah dan membaca surah pendek',
                            tujuanPembelajaran: [
                                'Peserta didik mampu mengenal huruf hijaiah dengan benar',
                                'Peserta didik mampu membaca surah Al-Fatihah dengan tartil',
                                'Peserta didik mampu menghafal surah-surah pendek (An-Nas, Al-Falaq, Al-Ikhlas)',
                                'Peserta didik mampu mengenal hadis tentang kebersihan'
                            ]
                        },
                        {
                            id: 'akidah-a',
                            name: 'Akidah',
                            description: 'Mengenal rukun iman dan sifat Allah',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menyebutkan rukun iman dengan urut',
                                'Peserta didik mampu meyakini Allah sebagai pencipta',
                                'Peserta didik mampu mengenal sifat-sifat Allah (Ar-Rahman, Ar-Rahim)',
                                'Peserta didik mampu menunjukkan sikap syukur kepada Allah'
                            ]
                        },
                        {
                            id: 'akhlak-a',
                            name: 'Akhlak',
                            description: 'Akhlak terhadap diri sendiri dan keluarga',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menerapkan perilaku jujur dalam kehidupan sehari-hari',
                                'Peserta didik mampu menunjukkan sikap hormat kepada orang tua',
                                'Peserta didik mampu menjaga kebersihan diri',
                                'Peserta didik mampu berbicara dengan sopan'
                            ]
                        },
                        {
                            id: 'fikih-a',
                            name: 'Fikih',
                            description: 'Mengenal rukun Islam dan tata cara bersuci',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menyebutkan rukun Islam dengan urut',
                                'Peserta didik mampu mempraktikkan cara berwudhu',
                                'Peserta didik mampu mengenal gerakan shalat',
                                'Peserta didik mampu membedakan najis dan cara membersihkannya'
                            ]
                        },
                        {
                            id: 'sejarah-a',
                            name: 'Sejarah Peradaban Islam',
                            description: 'Mengenal kisah Nabi dan Rasul',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menceritakan kisah Nabi Adam AS',
                                'Peserta didik mampu menceritakan kisah Nabi Nuh AS',
                                'Peserta didik mampu meneladani sifat terpuji para Nabi',
                                'Peserta didik mampu menghargai perjuangan para Nabi'
                            ]
                        }
                    ]
                },
                'B': {
                    name: 'Fase B',
                    grades: ['3', '4'],
                    level: 'SD',
                    elements: [
                        {
                            id: 'quran-hadis-b',
                            name: 'Al-Quran dan Hadis',
                            description: 'Membaca ayat-ayat tentang shalat dan hadis pilihan',
                            tujuanPembelajaran: [
                                'Peserta didik mampu membaca ayat-ayat Al-Quran tentang shalat dengan tartil',
                                'Peserta didik mampu menghafal surah-surah pendek juz 30',
                                'Peserta didik mampu memahami kandungan ayat tentang perintah shalat',
                                'Peserta didik mampu menghafal hadis tentang shalat lima waktu'
                            ]
                        },
                        {
                            id: 'akidah-b',
                            name: 'Akidah',
                            description: 'Mengenal sifat-sifat Allah (Asmaul Husna)',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menyebutkan 10 Asmaul Husna',
                                'Peserta didik mampu memahami makna sifat-sifat Allah',
                                'Peserta didik mampu meyakini keesaan Allah',
                                'Peserta didik mampu menerapkan nilai-nilai Asmaul Husna dalam kehidupan'
                            ]
                        },
                        {
                            id: 'akhlak-b',
                            name: 'Akhlak',
                            description: 'Adab kepada orang tua dan guru',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menunjukkan sikap berbakti kepada orang tua',
                                'Peserta didik mampu menghormati guru',
                                'Peserta didik mampu menerapkan adab bergaul dengan teman',
                                'Peserta didik mampu menunjukkan sikap tolong-menolong'
                            ]
                        },
                        {
                            id: 'fikih-b',
                            name: 'Fikih',
                            description: 'Tata cara shalat dan puasa',
                            tujuanPembelajaran: [
                                'Peserta didik mampu mempraktikkan shalat lima waktu dengan benar',
                                'Peserta didik mampu memahami syarat sah shalat',
                                'Peserta didik mampu mengenal puasa Ramadhan',
                                'Peserta didik mampu memahami hikmah puasa'
                            ]
                        },
                        {
                            id: 'sejarah-b',
                            name: 'Sejarah Peradaban Islam',
                            description: 'Sirah Nabi periode Makkah',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menceritakan kelahiran Nabi Muhammad SAW',
                                'Peserta didik mampu menceritakan masa kanak-kanak Nabi',
                                'Peserta didik mampu memahami dakwah Nabi di Makkah',
                                'Peserta didik mampu meneladani akhlak Nabi Muhammad SAW'
                            ]
                        }
                    ]
                },
                'C': {
                    name: 'Fase C',
                    grades: ['5', '6'],
                    level: 'SD',
                    elements: [
                        {
                            id: 'quran-hadis-c',
                            name: 'Al-Quran dan Hadis',
                            description: 'Membaca ayat tentang keragaman dan toleransi',
                            tujuanPembelajaran: [
                                'Peserta didik mampu membaca QS. Al-Hujurat ayat 13 tentang keragaman',
                                'Peserta didik mampu memahami makna toleransi dalam Islam',
                                'Peserta didik mampu menghafal hadis tentang persaudaraan',
                                'Peserta didik mampu menerapkan nilai toleransi dalam kehidupan'
                            ]
                        },
                        {
                            id: 'akidah-c',
                            name: 'Akidah',
                            description: 'Iman kepada hari akhir dan qada qadar',
                            tujuanPembelajaran: [
                                'Peserta didik mampu memahami konsep hari akhir',
                                'Peserta didik mampu meyakini adanya qada dan qadar',
                                'Peserta didik mampu menjelaskan tanda-tanda hari kiamat',
                                'Peserta didik mampu mengambil hikmah dari iman kepada hari akhir'
                            ]
                        },
                        {
                            id: 'akhlak-c',
                            name: 'Akhlak',
                            description: 'Adab sosial dan bermasyarakat',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menerapkan adab bertetangga',
                                'Peserta didik mampu menunjukkan sikap peduli sosial',
                                'Peserta didik mampu menghargai perbedaan dalam masyarakat',
                                'Peserta didik mampu berpartisipasi dalam kegiatan sosial'
                            ]
                        },
                        {
                            id: 'fikih-c',
                            name: 'Fikih',
                            description: 'Zakat, infaq, dan shadaqah',
                            tujuanPembelajaran: [
                                'Peserta didik mampu memahami pengertian zakat fitrah',
                                'Peserta didik mampu membedakan infaq dan shadaqah',
                                'Peserta didik mampu menghitung zakat fitrah',
                                'Peserta didik mampu mempraktikkan pemberian infaq dan shadaqah'
                            ]
                        },
                        {
                            id: 'sejarah-c',
                            name: 'Sejarah Peradaban Islam',
                            description: 'Sirah Nabi periode Madinah',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menceritakan peristiwa hijrah ke Madinah',
                                'Peserta didik mampu memahami pembentukan masyarakat Madinah',
                                'Peserta didik mampu menceritakan perjanjian Hudaibiyah',
                                'Peserta didik mampu meneladani kepemimpinan Nabi di Madinah'
                            ]
                        }
                    ]
                },
                'D': {
                    name: 'Fase D',
                    grades: ['7', '8', '9'],
                    level: 'SMP',
                    elements: [
                        {
                            id: 'quran-hadis-d',
                            name: 'Al-Quran dan Hadis',
                            description: 'Memahami ayat-ayat tentang toleransi dan moderasi',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menganalisis QS. Al-Kafirun tentang toleransi',
                                'Peserta didik mampu memahami konsep moderasi beragama',
                                'Peserta didik mampu menghafal dan memahami hadis tentang toleransi',
                                'Peserta didik mampu menerapkan sikap moderat dalam beragama'
                            ]
                        },
                        {
                            id: 'akidah-d',
                            name: 'Akidah',
                            description: 'Pendalaman rukun iman',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menganalisis bukti-bukti keberadaan Allah',
                                'Peserta didik mampu memahami sifat wajib, mustahil, dan jaiz Allah',
                                'Peserta didik mampu menganalisis fungsi malaikat',
                                'Peserta didik mampu memahami hikmah beriman kepada kitab-kitab Allah'
                            ]
                        },
                        {
                            id: 'akhlak-d',
                            name: 'Akhlak',
                            description: 'Etika digital dan bermedia sosial',
                            tujuanPembelajaran: [
                                'Peserta didik mampu memahami etika dalam bermedia sosial',
                                'Peserta didik mampu menghindari konten negatif di internet',
                                'Peserta didik mampu menyebarkan konten positif',
                                'Peserta didik mampu bijak dalam menggunakan teknologi'
                            ]
                        },
                        {
                            id: 'fikih-d',
                            name: 'Fikih',
                            description: 'Sujud syukur, tilawah, dan ibadah haji',
                            tujuanPembelajaran: [
                                'Peserta didik mampu mempraktikkan sujud syukur',
                                'Peserta didik mampu mempraktikkan sujud tilawah',
                                'Peserta didik mampu memahami tata cara haji dan umrah',
                                'Peserta didik mampu menjelaskan hikmah ibadah haji'
                            ]
                        },
                        {
                            id: 'sejarah-d',
                            name: 'Sejarah Peradaban Islam',
                            description: 'Peradaban Islam dari Bani Umayyah hingga Mughal',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menganalisis perkembangan Dinasti Umayyah',
                                'Peserta didik mampu memahami kejayaan Dinasti Abbasiyah',
                                'Peserta didik mampu mengenal peradaban Islam di Andalusia',
                                'Peserta didik mampu menganalisis kerajaan Islam di India (Mughal)'
                            ]
                        }
                    ]
                },
                'E': {
                    name: 'Fase E',
                    grades: ['10'],
                    level: 'SMA/SMK',
                    elements: [
                        {
                            id: 'quran-hadis-e',
                            name: 'Al-Quran dan Hadis',
                            description: 'Kompetisi dalam kebaikan',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menganalisis QS. Al-Baqarah: 148 tentang fastabiqul khairat',
                                'Peserta didik mampu memahami konsep berlomba dalam kebaikan',
                                'Peserta didik mampu mengkaji hadis tentang amal terbaik',
                                'Peserta didik mampu menerapkan semangat kompetisi positif'
                            ]
                        },
                        {
                            id: 'akidah-e',
                            name: 'Akidah',
                            description: "Syu'ab al-Iman (cabang-cabang iman)",
                            tujuanPembelajaran: [
                                "Peserta didik mampu memahami konsep syu'ab al-iman",
                                'Peserta didik mampu mengidentifikasi cabang-cabang iman',
                                'Peserta didik mampu menganalisis hubungan iman dan amal',
                                'Peserta didik mampu menerapkan nilai-nilai iman dalam kehidupan'
                            ]
                        },
                        {
                            id: 'akhlak-e',
                            name: 'Akhlak',
                            description: 'Etika dalam bekerja dan berkarir',
                            tujuanPembelajaran: [
                                'Peserta didik mampu memahami etos kerja Islami',
                                'Peserta didik mampu menerapkan kejujuran dalam bekerja',
                                'Peserta didik mampu memahami konsep rezeki halal',
                                'Peserta didik mampu merencanakan karir sesuai nilai Islam'
                            ]
                        },
                        {
                            id: 'fikih-e',
                            name: 'Fikih',
                            description: 'Prinsip-prinsip hukum Islam',
                            tujuanPembelajaran: [
                                'Peserta didik mampu memahami sumber hukum Islam',
                                'Peserta didik mampu menganalisis metode istinbath hukum',
                                'Peserta didik mampu memahami prinsip maslahah',
                                'Peserta didik mampu mengaplikasikan fiqih dalam konteks kekinian'
                            ]
                        },
                        {
                            id: 'sejarah-e',
                            name: 'Sejarah Peradaban Islam',
                            description: 'Perkembangan Islam di Indonesia',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menganalisis masuknya Islam ke Indonesia',
                                'Peserta didik mampu memahami peran Walisongo',
                                'Peserta didik mampu mengkaji kerajaan-kerajaan Islam di Nusantara',
                                'Peserta didik mampu mengapresiasi kontribusi ulama Indonesia'
                            ]
                        }
                    ]
                },
                'F': {
                    name: 'Fase F',
                    grades: ['11', '12'],
                    level: 'SMA/SMK',
                    elements: [
                        {
                            id: 'quran-hadis-f',
                            name: 'Al-Quran dan Hadis',
                            description: 'Berpikir kritis dan mengkaji ayat-ayat kauniyah',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menganalisis ayat-ayat kauniyah dalam Al-Quran',
                                'Peserta didik mampu memahami integrasi sains dan Al-Quran',
                                'Peserta didik mampu mengkaji hadis tentang menuntut ilmu',
                                'Peserta didik mampu mengembangkan sikap ilmiah berbasis Al-Quran'
                            ]
                        },
                        {
                            id: 'akidah-f',
                            name: 'Akidah',
                            description: 'Pemikiran kalam klasik dan modern',
                            tujuanPembelajaran: [
                                'Peserta didik mampu memahami sejarah ilmu kalam',
                                'Peserta didik mampu menganalisis aliran-aliran dalam Islam',
                                'Peserta didik mampu memahami pemikiran Islam modern',
                                'Peserta didik mampu bersikap bijak terhadap perbedaan pemikiran'
                            ]
                        },
                        {
                            id: 'akhlak-f',
                            name: 'Akhlak',
                            description: 'Etika digital dan tanggung jawab global',
                            tujuanPembelajaran: [
                                'Peserta didik mampu memahami etika dalam era digital',
                                'Peserta didik mampu menerapkan literasi digital Islami',
                                'Peserta didik mampu berpartisipasi dalam isu global',
                                'Peserta didik mampu menjadi warga digital yang bertanggung jawab'
                            ]
                        },
                        {
                            id: 'fikih-f',
                            name: 'Fikih',
                            description: 'Mawaris dan muamalah kontemporer',
                            tujuanPembelajaran: [
                                'Peserta didik mampu memahami hukum waris dalam Islam',
                                'Peserta didik mampu menghitung pembagian waris',
                                'Peserta didik mampu menganalisis muamalah kontemporer',
                                'Peserta didik mampu memahami ekonomi syariah'
                            ]
                        },
                        {
                            id: 'sejarah-f',
                            name: 'Sejarah Peradaban Islam',
                            description: 'Organisasi Islam dunia dan isu kontemporer',
                            tujuanPembelajaran: [
                                'Peserta didik mampu mengenal organisasi Islam internasional',
                                'Peserta didik mampu menganalisis isu-isu kontemporer umat Islam',
                                'Peserta didik mampu memahami peran Indonesia di dunia Islam',
                                'Peserta didik mampu berkontribusi untuk kemajuan umat'
                            ]
                        }
                    ]
                }
            },
            dimensions: [
                'Keimanan dan Ketakwaan kepada Tuhan Yang Maha Esa',
                'Kewargaan',
                'Penalaran Kritis',
                'Kreativitas',
                'Bergotong Royong (Kolaborasi)',
                'Kemandirian',
                'Kesehatan Jasmani dan Rohani',
                'Berkomunikasi'
            ]
        };

        // ===== UTILITY FUNCTIONS =====
        function showLoading(text = 'Memproses...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastContent = document.getElementById('toastContent');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');

            const types = {
                success: { bg: 'bg-green-500', icon: 'fas fa-check-circle' },
                error: { bg: 'bg-red-500', icon: 'fas fa-exclamation-circle' },
                warning: { bg: 'bg-yellow-500', icon: 'fas fa-exclamation-triangle' },
                info: { bg: 'bg-blue-500', icon: 'fas fa-info-circle' }
            };

            toastContent.className = `${types[type].bg} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center space-x-3`;
            toastIcon.className = `${types[type].icon} text-xl`;
            toastMessage.textContent = message;

            toast.classList.remove('translate-x-full');
            setTimeout(() => toast.classList.add('translate-x-full'), 3000);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        function toggleUserMenu() {
            document.getElementById('userMenu').classList.toggle('hidden');
        }

        function getAcademicYearOptions() {
            const now = new Date();
            const month = now.getMonth() + 1;
            const year = now.getFullYear();
            
            let options = [];
            if (month >= 6) {
                options = [
                    `${year - 1}/${year}`,
                    `${year}/${year + 1}`
                ];
            } else {
                options = [
                    `${year - 1}/${year}`,
                    `${year}/${year + 1}`
                ];
            }
            return options;
        }

        function getCurrentAcademicYear() {
            const now = new Date();
            const month = now.getMonth() + 1;
            const year = now.getFullYear();
            
            if (month >= 7) {
                return `${year}/${year + 1}`;
            } else {
                return `${year - 1}/${year}`;
            }
        }

        function populateAcademicYearSelect() {
            const select = document.getElementById('academicYearSelect');
            const options = getAcademicYearOptions();
            const current = userData?.academicYear || getCurrentAcademicYear();
            
            select.innerHTML = options.map(opt => 
                `<option value="${opt}" ${opt === current ? 'selected' : ''}>${opt}</option>`
            ).join('');
        }

        async function changeAcademicYear(year) {
            if (!currentUser) return;
            
            showLoading('Mengubah tahun ajaran...');
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    academicYear: year
                });
                userData.academicYear = year;
                showToast('Tahun ajaran berhasil diubah', 'success');
                loadSection(currentSection);
            } catch (error) {
                console.error(error);
                showToast('Gagal mengubah tahun ajaran', 'error');
            }
            hideLoading();
        }

        function checkPremiumAccess(feature) {
            if (!userData) return false;
            if (userData.subscription === 'premium') return true;
            if (userData.subscriptionExpiry && new Date(userData.subscriptionExpiry.toDate()) > new Date()) {
                return true;
            }
            return false;
        }

        function showUpgradeModal() {
            const modal = document.getElementById('upgradeModal');
            const link = document.getElementById('whatsappUpgradeLink');
            link.href = `https://wa.me/${whatsappAdmin}?text=Halo, saya ingin upgrade ke Premium untuk Admin Guru Super App. Email: ${currentUser?.email}`;
            modal.classList.remove('hidden');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('hidden');
        }

        // ===== SECTION LOADERS =====
        function loadSection(section) {
            currentSection = section;
            
            // Update active sidebar item
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
                item.querySelector('i').classList.remove('text-primary-500');
                item.querySelector('i').classList.add('text-gray-400');
            });
            
            const activeItem = document.querySelector(`[onclick="loadSection('${section}')"]`);
            if (activeItem) {
                activeItem.classList.add('active');
                activeItem.querySelector('i').classList.remove('text-gray-400');
                activeItem.querySelector('i').classList.add('text-primary-500');
            }

            // Close mobile sidebar
            if (window.innerWidth < 1024) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebarOverlay').classList.add('hidden');
            }

            // Check premium features
            const premiumFeatures = ['modul-ajar', 'lkpd', 'bank-soal'];
            if (premiumFeatures.includes(section) && !checkPremiumAccess(section)) {
                showUpgradeModal();
                return;
            }

            // Load section content
            const contentArea = document.getElementById('contentArea');
            
            switch(section) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'profile':
                    loadProfile();
                    break;
                case 'calendar':
                    loadCalendar();
                    break;
                case 'schedule':
                    loadSchedule();
                    break;
                case 'students':
                    loadStudents();
                    break;
                case 'cp':
                    loadCP();
                    break;
                case 'atp':
                    loadATP();
                    break;
                case 'prota':
                    loadProta();
                    break;
                case 'promes':
                    loadPromes();
                    break;
                case 'modul-ajar':
                    loadModulAjar();
                    break;
                case 'lkpd':
                    loadLKPD();
                    break;
                case 'attendance':
                    loadAttendance();
                    break;
                case 'journal':
                    loadJournal();
                    break;
                case 'grades':
                    loadGrades();
                    break;
                case 'bank-soal':
                    loadBankSoal();
                    break;
                case 'ai-assistant':
                    loadAIAssistant();
                    break;
                case 'import-data':
                    loadImportData();
                    break;
                case 'guide':
                    loadGuide();
                    break;
                default:
                    loadDashboard();
            }
        }

        // ===== DASHBOARD SECTION =====
        function loadDashboard() {
            document.getElementById('pageTitle').textContent = 'Dashboard';
            document.getElementById('pageSubtitle').textContent = 'Selamat datang kembali!';
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Stats Cards -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-users text-blue-600 text-xl"></i>
                            </div>
                            <span class="text-xs text-green-600 font-medium bg-green-100 px-2 py-1 rounded-full">
                                <i class="fas fa-arrow-up mr-1"></i>12%
                            </span>
                        </div>
                        <h3 id="totalStudents" class="text-3xl font-bold text-gray-800">0</h3>
                        <p class="text-gray-500 text-sm">Total Siswa</p>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-sm card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-chalkboard text-purple-600 text-xl"></i>
                            </div>
                        </div>
                        <h3 id="totalClasses" class="text-3xl font-bold text-gray-800">0</h3>
                        <p class="text-gray-500 text-sm">Kelas Diampu</p>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-sm card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-book text-green-600 text-xl"></i>
                            </div>
                        </div>
                        <h3 id="totalModules" class="text-3xl font-bold text-gray-800">0</h3>
                        <p class="text-gray-500 text-sm">Modul Ajar</p>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-sm card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-calendar-check text-orange-600 text-xl"></i>
                            </div>
                        </div>
                        <h3 id="completedJournals" class="text-3xl font-bold text-gray-800">0</h3>
                        <p class="text-gray-500 text-sm">Jurnal Selesai</p>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-8">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">Aksi Cepat</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <button onclick="loadSection('attendance')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-primary-50 hover:border-primary-200 border border-transparent transition-all">
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mb-2">
                                <i class="fas fa-clipboard-check text-blue-600"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">Absensi</span>
                        </button>
                        <button onclick="loadSection('journal')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-primary-50 hover:border-primary-200 border border-transparent transition-all">
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mb-2">
                                <i class="fas fa-journal-whills text-purple-600"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">Jurnal</span>
                        </button>
                        <button onclick="loadSection('grades')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-primary-50 hover:border-primary-200 border border-transparent transition-all">
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mb-2">
                                <i class="fas fa-star text-green-600"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">Nilai</span>
                        </button>
                        <button onclick="loadSection('promes')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-primary-50 hover:border-primary-200 border border-transparent transition-all">
                            <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center mb-2">
                                <i class="fas fa-calendar-week text-orange-600"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">Promes</span>
                        </button>
                        <button onclick="loadSection('modul-ajar')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-primary-50 hover:border-primary-200 border border-transparent transition-all">
                            <div class="w-12 h-12 bg-pink-100 rounded-xl flex items-center justify-center mb-2">
                                <i class="fas fa-book text-pink-600"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">Modul Ajar</span>
                        </button>
                        <button onclick="loadSection('ai-assistant')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-primary-50 hover:border-primary-200 border border-transparent transition-all">
                            <div class="w-12 h-12 bg-cyan-100 rounded-xl flex items-center justify-center mb-2">
                                <i class="fas fa-robot text-cyan-600"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">AI Assistant</span>
                        </button>
                    </div>
                </div>

                <!-- Recent Activity & Schedule -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Today's Schedule -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-bold text-gray-800">Jadwal Hari Ini</h2>
                            <span class="text-sm text-gray-500">${new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' })}</span>
                        </div>
                        <div id="todaySchedule" class="space-y-3">
                            <div class="text-center py-8 text-gray-400">
                                <i class="fas fa-calendar-times text-4xl mb-2"></i>
                                <p>Belum ada jadwal untuk hari ini</p>
                                <button onclick="loadSection('schedule')" class="mt-2 text-primary-600 hover:text-primary-700 font-medium text-sm">
                                    Atur Jadwal <i class="fas fa-arrow-right ml-1"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Document Status -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">Status Dokumen</h2>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-check text-green-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800">Kalender</p>
                                        <p class="text-xs text-gray-500">Sudah diatur</p>
                                    </div>
                                </div>
                                <span id="calendarStatus" class="px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">Belum</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-check text-green-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800">Jadwal</p>
                                        <p class="text-xs text-gray-500">Sudah diatur</p>
                                    </div>
                                </div>
                                <span id="scheduleStatus" class="px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">Belum</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-route text-blue-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800">ATP</p>
                                        <p class="text-xs text-gray-500">Alur Tujuan Pembelajaran</p>
                                    </div>
                                </div>
                                <span id="atpStatus" class="px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">Belum</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-calendar-check text-purple-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800">Prota</p>
                                        <p class="text-xs text-gray-500">Program Tahunan</p>
                                    </div>
                                </div>
                                <span id="protaStatus" class="px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">Belum</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-calendar-week text-orange-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800">Promes</p>
                                        <p class="text-xs text-gray-500">Program Semester</p>
                                    </div>
                                </div>
                                <span id="promesStatus" class="px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">Belum</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            loadDashboardData();
        }

        async function loadDashboardData() {
            if (!currentUser) return;
            
            try {
                // Load stats
                const studentsSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('students').get();
                document.getElementById('totalStudents').textContent = studentsSnap.size;
                
                // Count unique classes
                const classes = new Set();
                studentsSnap.forEach(doc => {
                    const student = doc.data();
                    classes.add(`${student.kelas}-${student.rombel}`);
                });
                document.getElementById('totalClasses').textContent = classes.size;
                
                // Load modules count
                const modulesSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('moduls').get();
                document.getElementById('totalModules').textContent = modulesSnap.size;
                
                // Load journals count
                const journalsSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('journals').get();
                document.getElementById('completedJournals').textContent = journalsSnap.size;
                
                // Check document status
                const calendarSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('calendar').limit(1).get();
                if (!calendarSnap.empty) {
                    document.getElementById('calendarStatus').className = 'px-3 py-1 bg-green-100 text-green-600 text-xs rounded-full';
                    document.getElementById('calendarStatus').textContent = 'Sudah';
                }
                
                const scheduleSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('schedules').limit(1).get();
                if (!scheduleSnap.empty) {
                    document.getElementById('scheduleStatus').className = 'px-3 py-1 bg-green-100 text-green-600 text-xs rounded-full';
                    document.getElementById('scheduleStatus').textContent = 'Sudah';
                }
                
                const atpSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('atp').limit(1).get();
                if (!atpSnap.empty) {
                    document.getElementById('atpStatus').className = 'px-3 py-1 bg-green-100 text-green-600 text-xs rounded-full';
                    document.getElementById('atpStatus').textContent = 'Sudah';
                }
                
                const protaSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('prota').limit(1).get();
                if (!protaSnap.empty) {
                    document.getElementById('protaStatus').className = 'px-3 py-1 bg-green-100 text-green-600 text-xs rounded-full';
                    document.getElementById('protaStatus').textContent = 'Sudah';
                }
                
                const promesSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('promes').limit(1).get();
                if (!promesSnap.empty) {
                    document.getElementById('promesStatus').className = 'px-3 py-1 bg-green-100 text-green-600 text-xs rounded-full';
                    document.getElementById('promesStatus').textContent = 'Sudah';
                }
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // ===== PROFILE SECTION =====
        function loadProfile() {
            document.getElementById('pageTitle').textContent = 'Profil & Sekolah';
            document.getElementById('pageSubtitle').textContent = 'Kelola data profil dan satuan pendidikan';
            
            const profile = userData?.profile || {};
            const school = profile.school || {};
            const subjects = profile.subjects || [];
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Profile Card -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 text-center">
                            <div class="relative inline-block mb-4">
                                <img id="profileAvatar" src="${currentUser?.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser?.displayName || 'User')}&background=3b82f6&color=fff&size=128`}" 
                                     class="w-32 h-32 rounded-full border-4 border-primary-100 mx-auto" alt="Avatar">
                                <button class="absolute bottom-0 right-0 w-10 h-10 bg-primary-500 text-white rounded-full hover:bg-primary-600 transition-colors shadow-lg">
                                    <i class="fas fa-camera"></i>
                                </button>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800">${currentUser?.displayName || 'Nama Guru'}</h3>
                            <p class="text-gray-500">${currentUser?.email}</p>
                            <div class="mt-4 flex justify-center">
                                <span class="px-4 py-2 ${userData?.subscription === 'premium' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'} rounded-full text-sm font-medium">
                                    <i class="fas ${userData?.subscription === 'premium' ? 'fa-crown' : 'fa-user'} mr-1"></i>
                                    ${userData?.subscription === 'premium' ? 'Premium' : 'Free'}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Form -->
                    <div class="lg:col-span-2">
                        <form id="profileForm" class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                            <h3 class="text-lg font-bold text-gray-800 mb-6">Data Pribadi</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                    <input type="text" id="profileName" value="${currentUser?.displayName || ''}"
                                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">NIP</label>
                                    <input type="text" id="profileNIP" value="${profile.nip || ''}"
                                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                           placeholder="198x0x0x 20xx0x x 0xx">
                                </div>
                            </div>

                            <h3 class="text-lg font-bold text-gray-800 mb-6 mt-8">Mata Pelajaran yang Diampu</h3>
                            <div id="subjectsContainer" class="space-y-4 mb-4">
                                ${subjects.length > 0 ? subjects.map((subj, idx) => `
                                    <div class="subject-item flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                                        <div class="flex-1">
                                            <input type="text" value="${subj.name}" placeholder="Nama Mata Pelajaran"
                                                   class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500 subject-name">
                                        </div>
                                        <div class="w-32">
                                            <input type="number" value="${subj.hoursPerWeek}" placeholder="JP/Minggu" min="1"
                                                   class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500 subject-hours">
                                        </div>
                                        <button type="button" onclick="removeSubject(this)" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `).join('') : `
                                    <div class="subject-item flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                                        <div class="flex-1">
                                            <input type="text" placeholder="Nama Mata Pelajaran" value="Pendidikan Agama Islam dan Budi Pekerti"
                                                   class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500 subject-name">
                                        </div>
                                        <div class="w-32">
                                            <input type="number" placeholder="JP/Minggu" value="4" min="1"
                                                   class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500 subject-hours">
                                        </div>
                                        <button type="button" onclick="removeSubject(this)" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `}
                            </div>
                            <button type="button" onclick="addSubject()" class="flex items-center space-x-2 text-primary-600 hover:text-primary-700 font-medium">
                                <i class="fas fa-plus"></i>
                                <span>Tambah Mata Pelajaran</span>
                            </button>

                            <h3 class="text-lg font-bold text-gray-800 mb-6 mt-8">Data Satuan Pendidikan</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Sekolah</label>
                                    <input type="text" id="schoolName" value="${school.name || ''}"
                                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                           placeholder="SDN 1 Contoh">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">NPSN</label>
                                    <input type="text" id="schoolNPSN" value="${school.npsn || ''}"
                                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                           placeholder="20xxxxxx">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Jenjang</label>
                                    <select id="schoolLevel" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                        <option value="SD" ${school.level === 'SD' ? 'selected' : ''}>SD/MI</option>
                                        <option value="SMP" ${school.level === 'SMP' ? 'selected' : ''}>SMP/MTs</option>
                                        <option value="SMA" ${school.level === 'SMA' ? 'selected' : ''}>SMA/MA</option>
                                        <option value="SMK" ${school.level === 'SMK' ? 'selected' : ''}>SMK</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kota/Kabupaten (untuk TTD)</label>
                                    <input type="text" id="schoolCity" value="${school.city || ''}"
                                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                           placeholder="Kota Bandung">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Alamat Sekolah</label>
                                    <textarea id="schoolAddress" rows="2"
                                              class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                              placeholder="Jl. Contoh No. 123, Kelurahan, Kecamatan">${school.address || ''}</textarea>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kepala Sekolah</label>
                                    <input type="text" id="principalName" value="${school.principalName || ''}"
                                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                           placeholder="Drs. Nama Kepala Sekolah, M.Pd">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">NIP Kepala Sekolah</label>
                                    <input type="text" id="principalNIP" value="${school.principalNIP || ''}"
                                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                           placeholder="196x0x0x 198x0x x 0xx">
                                </div>
                            </div>

                            <div class="flex justify-end mt-8">
                                <button type="submit" class="px-8 py-3 bg-gradient-to-r from-primary-600 to-purple-600 text-white font-semibold rounded-xl hover:from-primary-700 hover:to-purple-700 transition-all shadow-lg">
                                    <i class="fas fa-save mr-2"></i>
                                    Simpan Profil
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Profile form submit handler
            document.getElementById('profileForm').addEventListener('submit', saveProfile);
        }

        function addSubject() {
            const container = document.getElementById('subjectsContainer');
            const div = document.createElement('div');
            div.className = 'subject-item flex items-center gap-4 p-4 bg-gray-50 rounded-xl';
            div.innerHTML = `
                <div class="flex-1">
                    <input type="text" placeholder="Nama Mata Pelajaran"
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500 subject-name">
                </div>
                <div class="w-32">
                    <input type="number" placeholder="JP/Minggu" value="2" min="1"
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500 subject-hours">
                </div>
                <button type="button" onclick="removeSubject(this)" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(div);
        }

        function removeSubject(btn) {
            const container = document.getElementById('subjectsContainer');
            if (container.children.length > 1) {
                btn.closest('.subject-item').remove();
            } else {
                showToast('Minimal harus ada satu mata pelajaran', 'warning');
            }
        }

        async function saveProfile(e) {
            e.preventDefault();
            if (!currentUser) return;
            
            showLoading('Menyimpan profil...');
            
            try {
                // Collect subjects
                const subjects = [];
                document.querySelectorAll('.subject-item').forEach(item => {
                    const name = item.querySelector('.subject-name').value.trim();
                    const hours = parseInt(item.querySelector('.subject-hours').value) || 2;
                    if (name) {
                        subjects.push({ name, hoursPerWeek: hours });
                    }
                });
                
                const profileData = {
                    nip: document.getElementById('profileNIP').value.trim(),
                    subjects: subjects,
                    school: {
                        name: document.getElementById('schoolName').value.trim(),
                        npsn: document.getElementById('schoolNPSN').value.trim(),
                        level: document.getElementById('schoolLevel').value,
                        address: document.getElementById('schoolAddress').value.trim(),
                        city: document.getElementById('schoolCity').value.trim(),
                        principalName: document.getElementById('principalName').value.trim(),
                        principalNIP: document.getElementById('principalNIP').value.trim()
                    }
                };
                
                await db.collection('users').doc(currentUser.uid).update({
                    displayName: document.getElementById('profileName').value.trim(),
                    profile: profileData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local data
                userData.profile = profileData;
                
                // Update display name in Firebase Auth
                await currentUser.updateProfile({
                    displayName: document.getElementById('profileName').value.trim()
                });
                
                showToast('Profil berhasil disimpan!', 'success');
                updateUserDisplay();
                
            } catch (error) {
                console.error(error);
                showToast('Gagal menyimpan profil', 'error');
            }
            
            hideLoading();
        }

        // ===== CALENDAR SECTION =====
        function loadCalendar() {
            document.getElementById('pageTitle').textContent = 'Kalender Pendidikan';
            document.getElementById('pageSubtitle').textContent = 'Atur kalender akademik semester';
            
            const academicYear = userData?.academicYear || getCurrentAcademicYear();
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Pengaturan Kalender</h3>
                            <p class="text-gray-500 text-sm">Tahun Ajaran: ${academicYear}</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="importCalendarCSV()" class="px-4 py-2 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 transition-all flex items-center space-x-2">
                                <i class="fas fa-file-csv"></i>
                                <span>Import CSV</span>
                            </button>
                            <button onclick="saveCalendar()" class="px-6 py-2 bg-gradient-to-r from-primary-600 to-purple-600 text-white font-semibold rounded-xl hover:from-primary-700 hover:to-purple-700 transition-all">
                                <i class="fas fa-save mr-2"></i>
                                Simpan
                            </button>
                        </div>
                    </div>

                    <!-- Semester Tabs -->
                    <div class="flex space-x-2 mb-6">
                        <button onclick="switchSemester(1)" id="sem1Tab" class="px-6 py-3 bg-primary-500 text-white font-medium rounded-xl transition-all">
                            Semester 1 (Ganjil)
                        </button>
                        <button onclick="switchSemester(2)" id="sem2Tab" class="px-6 py-3 bg-gray-100 text-gray-600 font-medium rounded-xl hover:bg-gray-200 transition-all">
                            Semester 2 (Genap)
                        </button>
                    </div>

                    <!-- Semester 1 -->
                    <div id="semester1Form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
                                <h4 class="font-semibold text-blue-800 mb-4"><i class="fas fa-calendar-day mr-2"></i>Periode Semester</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Awal Semester</label>
                                        <input type="date" id="sem1Start" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Akhir Semester</label>
                                        <input type="date" id="sem1End" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 bg-green-50 rounded-xl border border-green-100">
                                <h4 class="font-semibold text-green-800 mb-4"><i class="fas fa-book-reader mr-2"></i>Kegiatan Pembelajaran</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Awal Kegiatan</label>
                                        <input type="date" id="sem1ActivityStart" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Akhir Kegiatan</label>
                                        <input type="date" id="sem1ActivityEnd" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-4 bg-orange-50 rounded-xl border border-orange-100">
                                <h4 class="font-semibold text-orange-800 mb-4"><i class="fas fa-file-signature mr-2"></i>Pekan Ujian</h4>
                                <div id="sem1Exams" class="space-y-3">
                                    <div class="exam-item grid grid-cols-5 gap-2 items-center">
                                        <input type="text" value="PTS" placeholder="Nama Ujian" class="col-span-1 px-3 py-2 border border-gray-200 rounded-lg exam-name">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-start">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-end">
                                    </div>
                                    <div class="exam-item grid grid-cols-5 gap-2 items-center">
                                        <input type="text" value="PAS" placeholder="Nama Ujian" class="col-span-1 px-3 py-2 border border-gray-200 rounded-lg exam-name">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-start">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-end">
                                    </div>
                                </div>
                                <button type="button" onclick="addExam('sem1Exams')" class="mt-3 text-sm text-orange-600 hover:text-orange-700 font-medium">
                                    <i class="fas fa-plus mr-1"></i> Tambah Ujian
                                </button>
                            </div>
                            <div class="p-4 bg-red-50 rounded-xl border border-red-100">
                                <h4 class="font-semibold text-red-800 mb-4"><i class="fas fa-umbrella-beach mr-2"></i>Libur</h4>
                                <div id="sem1Holidays" class="space-y-3">
                                    <div class="holiday-item grid grid-cols-5 gap-2 items-center">
                                        <input type="text" placeholder="Keterangan" class="col-span-1 px-3 py-2 border border-gray-200 rounded-lg holiday-name">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg holiday-start">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg holiday-end">
                                    </div>
                                </div>
                                <button type="button" onclick="addHoliday('sem1Holidays')" class="mt-3 text-sm text-red-600 hover:text-red-700 font-medium">
                                    <i class="fas fa-plus mr-1"></i> Tambah Libur
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Semester 2 (Hidden by default) -->
                    <div id="semester2Form" class="space-y-6 hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
                                <h4 class="font-semibold text-blue-800 mb-4"><i class="fas fa-calendar-day mr-2"></i>Periode Semester</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Awal Semester</label>
                                        <input type="date" id="sem2Start" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Akhir Semester</label>
                                        <input type="date" id="sem2End" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 bg-green-50 rounded-xl border border-green-100">
                                <h4 class="font-semibold text-green-800 mb-4"><i class="fas fa-book-reader mr-2"></i>Kegiatan Pembelajaran</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Awal Kegiatan</label>
                                        <input type="date" id="sem2ActivityStart" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                    </div>
                                    <div>
                                              <label class="block text-sm font-medium text-gray-700 mb-1">Akhir Kegiatan</label>
                                        <input type="date" id="sem2ActivityEnd" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-4 bg-orange-50 rounded-xl border border-orange-100">
                                <h4 class="font-semibold text-orange-800 mb-4"><i class="fas fa-file-signature mr-2"></i>Pekan Ujian</h4>
                                <div id="sem2Exams" class="space-y-3">
                                    <div class="exam-item grid grid-cols-5 gap-2 items-center">
                                        <input type="text" value="PTS" placeholder="Nama Ujian" class="col-span-1 px-3 py-2 border border-gray-200 rounded-lg exam-name">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-start">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-end">
                                    </div>
                                    <div class="exam-item grid grid-cols-5 gap-2 items-center">
                                        <input type="text" value="PAT" placeholder="Nama Ujian" class="col-span-1 px-3 py-2 border border-gray-200 rounded-lg exam-name">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-start">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-end">
                                    </div>
                                </div>
                                <button type="button" onclick="addExam('sem2Exams')" class="mt-3 text-sm text-orange-600 hover:text-orange-700 font-medium">
                                    <i class="fas fa-plus mr-1"></i> Tambah Ujian
                                </button>
                            </div>
                            <div class="p-4 bg-red-50 rounded-xl border border-red-100">
                                <h4 class="font-semibold text-red-800 mb-4"><i class="fas fa-umbrella-beach mr-2"></i>Libur</h4>
                                <div id="sem2Holidays" class="space-y-3">
                                    <div class="holiday-item grid grid-cols-5 gap-2 items-center">
                                        <input type="text" placeholder="Keterangan" class="col-span-1 px-3 py-2 border border-gray-200 rounded-lg holiday-name">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg holiday-start">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg holiday-end">
                                    </div>
                                </div>
                                <button type="button" onclick="addHoliday('sem2Holidays')" class="mt-3 text-sm text-red-600 hover:text-red-700 font-medium">
                                    <i class="fas fa-plus mr-1"></i> Tambah Libur
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calendar Preview -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Preview Kalender</h3>
                    <div id="calendarPreview" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <!-- Calendar preview will be generated here -->
                    </div>
                </div>
            `;
            
            loadCalendarData();
        }

        function switchSemester(sem) {
            const sem1Tab = document.getElementById('sem1Tab');
            const sem2Tab = document.getElementById('sem2Tab');
            const sem1Form = document.getElementById('semester1Form');
            const sem2Form = document.getElementById('semester2Form');
            
            if (sem === 1) {
                sem1Tab.className = 'px-6 py-3 bg-primary-500 text-white font-medium rounded-xl transition-all';
                sem2Tab.className = 'px-6 py-3 bg-gray-100 text-gray-600 font-medium rounded-xl hover:bg-gray-200 transition-all';
                sem1Form.classList.remove('hidden');
                sem2Form.classList.add('hidden');
            } else {
                sem2Tab.className = 'px-6 py-3 bg-primary-500 text-white font-medium rounded-xl transition-all';
                sem1Tab.className = 'px-6 py-3 bg-gray-100 text-gray-600 font-medium rounded-xl hover:bg-gray-200 transition-all';
                sem2Form.classList.remove('hidden');
                sem1Form.classList.add('hidden');
            }
        }

        function addExam(containerId) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'exam-item grid grid-cols-5 gap-2 items-center';
            div.innerHTML = `
                <input type="text" placeholder="Nama Ujian" class="col-span-1 px-3 py-2 border border-gray-200 rounded-lg exam-name">
                <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-start">
                <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-end">
            `;
            container.appendChild(div);
        }

        function addHoliday(containerId) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'holiday-item grid grid-cols-5 gap-2 items-center';
            div.innerHTML = `
                <input type="text" placeholder="Keterangan" class="col-span-1 px-3 py-2 border border-gray-200 rounded-lg holiday-name">
                <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg holiday-start">
                <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg holiday-end">
            `;
            container.appendChild(div);
        }

        async function loadCalendarData() {
            if (!currentUser) return;
            
            try {
                const calendarDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('calendar').doc(userData?.academicYear || getCurrentAcademicYear()).get();
                
                if (calendarDoc.exists) {
                    const data = calendarDoc.data();
                    
                    // Semester 1
                    if (data.semester1) {
                        document.getElementById('sem1Start').value = data.semester1.start || '';
                        document.getElementById('sem1End').value = data.semester1.end || '';
                        document.getElementById('sem1ActivityStart').value = data.semester1.activityStart || '';
                        document.getElementById('sem1ActivityEnd').value = data.semester1.activityEnd || '';
                    }
                    
                    // Semester 2
                    if (data.semester2) {
                        document.getElementById('sem2Start').value = data.semester2.start || '';
                        document.getElementById('sem2End').value = data.semester2.end || '';
                        document.getElementById('sem2ActivityStart').value = data.semester2.activityStart || '';
                        document.getElementById('sem2ActivityEnd').value = data.semester2.activityEnd || '';
                    }
                    
                    generateCalendarPreview(data);
                }
            } catch (error) {
                console.error('Error loading calendar:', error);
            }
        }

        async function saveCalendar() {
            if (!currentUser) return;
            
            showLoading('Menyimpan kalender...');
            
            try {
                // Collect exam data for semester 1
                const sem1Exams = [];
                document.querySelectorAll('#sem1Exams .exam-item').forEach(item => {
                    const name = item.querySelector('.exam-name').value.trim();
                    const start = item.querySelector('.exam-start').value;
                    const end = item.querySelector('.exam-end').value;
                    if (name && start && end) {
                        sem1Exams.push({ name, start, end });
                    }
                });
                
                // Collect holiday data for semester 1
                const sem1Holidays = [];
                document.querySelectorAll('#sem1Holidays .holiday-item').forEach(item => {
                    const name = item.querySelector('.holiday-name').value.trim();
                    const start = item.querySelector('.holiday-start').value;
                    const end = item.querySelector('.holiday-end').value;
                    if (start && end) {
                        sem1Holidays.push({ name, start, end });
                    }
                });
                
                // Collect exam data for semester 2
                const sem2Exams = [];
                document.querySelectorAll('#sem2Exams .exam-item').forEach(item => {
                    const name = item.querySelector('.exam-name').value.trim();
                    const start = item.querySelector('.exam-start').value;
                    const end = item.querySelector('.exam-end').value;
                    if (name && start && end) {
                        sem2Exams.push({ name, start, end });
                    }
                });
                
                // Collect holiday data for semester 2
                const sem2Holidays = [];
                document.querySelectorAll('#sem2Holidays .holiday-item').forEach(item => {
                    const name = item.querySelector('.holiday-name').value.trim();
                    const start = item.querySelector('.holiday-start').value;
                    const end = item.querySelector('.holiday-end').value;
                    if (start && end) {
                        sem2Holidays.push({ name, start, end });
                    }
                });
                
                const calendarData = {
                    academicYear: userData?.academicYear || getCurrentAcademicYear(),
                    semester1: {
                        start: document.getElementById('sem1Start').value,
                        end: document.getElementById('sem1End').value,
                        activityStart: document.getElementById('sem1ActivityStart').value,
                        activityEnd: document.getElementById('sem1ActivityEnd').value,
                        exams: sem1Exams,
                        holidays: sem1Holidays
                    },
                    semester2: {
                        start: document.getElementById('sem2Start').value,
                        end: document.getElementById('sem2End').value,
                        activityStart: document.getElementById('sem2ActivityStart').value,
                        activityEnd: document.getElementById('sem2ActivityEnd').value,
                        exams: sem2Exams,
                        holidays: sem2Holidays
                    },
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(currentUser.uid)
                    .collection('calendar')
                    .doc(calendarData.academicYear)
                    .set(calendarData);
                
                showToast('Kalender berhasil disimpan!', 'success');
                generateCalendarPreview(calendarData);
                
            } catch (error) {
                console.error(error);
                showToast('Gagal menyimpan kalender', 'error');
            }
            
            hideLoading();
        }

        function generateCalendarPreview(data) {
            const preview = document.getElementById('calendarPreview');
            if (!preview) return;
            
            const months = ['Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember', 
                           'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni'];
            
            let html = '';
            months.forEach(month => {
                html += `
                    <div class="p-3 bg-gray-50 rounded-xl text-center">
                        <p class="font-semibold text-gray-700">${month}</p>
                        <p class="text-2xl font-bold text-primary-600">4</p>
                        <p class="text-xs text-gray-500">Minggu Efektif</p>
                    </div>
                `;
            });
            
            preview.innerHTML = html;
        }

        function importCalendarCSV() {
            showToast('Fitur import CSV akan segera tersedia', 'info');
        }

        // ===== SCHEDULE SECTION =====
        function loadSchedule() {
            document.getElementById('pageTitle').textContent = 'Jadwal Pelajaran';
            document.getElementById('pageSubtitle').textContent = 'Atur jadwal mengajar Anda';
            
            const level = userData?.profile?.school?.level || 'SD';
            const defaultDuration = level === 'SD' ? 35 : 45;
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Pengaturan Jadwal</h3>
                            <p class="text-gray-500 text-sm">Durasi default: ${defaultDuration} menit per jam pelajaran</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="showTimeSlotsConfig()" class="px-4 py-2 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 transition-all flex items-center space-x-2">
                                <i class="fas fa-clock"></i>
                                <span>Atur Jam</span>
                            </button>
                            <button onclick="saveSchedule()" class="px-6 py-2 bg-gradient-to-r from-primary-600 to-purple-600 text-white font-semibold rounded-xl hover:from-primary-700 hover:to-purple-700 transition-all">
                                <i class="fas fa-save mr-2"></i>
                                Simpan
                            </button>
                        </div>
                    </div>

                    <!-- Time Slots Configuration (Hidden by default) -->
                    <div id="timeSlotsConfig" class="hidden mb-6 p-4 bg-gray-50 rounded-xl">
                        <h4 class="font-semibold text-gray-800 mb-4">Konfigurasi Jam Pelajaran</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3" id="timeSlotsList">
                            <!-- Will be populated -->
                        </div>
                        <button onclick="addTimeSlot()" class="mt-4 text-primary-600 hover:text-primary-700 font-medium">
                            <i class="fas fa-plus mr-1"></i> Tambah Jam
                        </button>
                    </div>

                    <!-- Add Schedule Form -->
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6 p-4 bg-blue-50 rounded-xl">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Hari</label>
                            <select id="scheduleDay" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                <option value="Senin">Senin</option>
                                <option value="Selasa">Selasa</option>
                                <option value="Rabu">Rabu</option>
                                <option value="Kamis">Kamis</option>
                                <option value="Jumat">Jumat</option>
                                <option value="Sabtu">Sabtu</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Jam Ke</label>
                            <select id="scheduleHour" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                ${Array.from({length: 10}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Durasi (JP)</label>
                            <select id="scheduleDuration" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                <option value="1">1 JP</option>
                                <option value="2" selected>2 JP</option>
                                <option value="3">3 JP</option>
                                <option value="4">4 JP</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                            <select id="scheduleClass" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                ${generateClassOptions(level)}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Rombel</label>
                            <select id="scheduleRombel" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="addScheduleItem()" class="w-full px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-all">
                                <i class="fas fa-plus mr-1"></i> Tambah
                            </button>
                        </div>
                    </div>

                    <!-- Schedule Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 rounded-l-lg">Jam</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Senin</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Selasa</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Rabu</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Kamis</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Jumat</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 rounded-r-lg">Sabtu</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTableBody">
                                <!-- Will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Schedule List -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Daftar Jadwal Anda</h3>
                    <div id="scheduleList" class="space-y-3">
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-calendar-plus text-4xl mb-2"></i>
                            <p>Belum ada jadwal. Tambahkan jadwal pertama Anda.</p>
                        </div>
                    </div>
                </div>
            `;
            
            loadScheduleData();
        }

        function generateClassOptions(level) {
            let grades = [];
            switch(level) {
                case 'SD':
                    grades = ['1', '2', '3', '4', '5', '6'];
                    break;
                case 'SMP':
                    grades = ['7', '8', '9'];
                    break;
                case 'SMA':
                case 'SMK':
                    grades = ['10', '11', '12'];
                    break;
                default:
                    grades = ['1', '2', '3', '4', '5', '6'];
            }
            return grades.map(g => `<option value="${g}">Kelas ${g}</option>`).join('');
        }

        let scheduleItems = [];
        let timeSlots = [];

        async function loadScheduleData() {
            if (!currentUser) return;
            
            try {
                // Load time slots
                const timeSlotsDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('settings').doc('timeSlots').get();
                
                if (timeSlotsDoc.exists) {
                    timeSlots = timeSlotsDoc.data().slots || generateDefaultTimeSlots();
                } else {
                    timeSlots = generateDefaultTimeSlots();
                }
                
                // Load schedules
                const schedulesSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('schedules')
                    .where('academicYear', '==', userData?.academicYear || getCurrentAcademicYear())
                    .get();
                
                scheduleItems = [];
                schedulesSnap.forEach(doc => {
                    scheduleItems.push({ id: doc.id, ...doc.data() });
                });
                
                renderScheduleTable();
                renderScheduleList();
                
            } catch (error) {
                console.error('Error loading schedule:', error);
            }
        }

        function generateDefaultTimeSlots() {
            const level = userData?.profile?.school?.level || 'SD';
            const duration = level === 'SD' ? 35 : 45;
            let startTime = 7 * 60; // 07:00 in minutes
            
            const slots = [];
            for (let i = 1; i <= 10; i++) {
                const startHour = Math.floor(startTime / 60);
                const startMin = startTime % 60;
                const endTime = startTime + duration;
                const endHour = Math.floor(endTime / 60);
                const endMin = endTime % 60;
                
                slots.push({
                    number: i,
                    start: `${String(startHour).padStart(2, '0')}:${String(startMin).padStart(2, '0')}`,
                    end: `${String(endHour).padStart(2, '0')}:${String(endMin).padStart(2, '0')}`,
                    duration: duration
                });
                
                startTime = endTime + (i === 3 || i === 6 ? 15 : 0); // Break after 3rd and 6th hour
            }
            
            return slots;
        }

        function showTimeSlotsConfig() {
            const config = document.getElementById('timeSlotsConfig');
            config.classList.toggle('hidden');
            
            if (!config.classList.contains('hidden')) {
                renderTimeSlots();
            }
        }

        function renderTimeSlots() {
            const container = document.getElementById('timeSlotsList');
            container.innerHTML = timeSlots.map((slot, idx) => `
                <div class="flex items-center space-x-2 p-2 bg-white rounded-lg">
                    <span class="font-medium text-gray-600">JP ${slot.number}</span>
                    <input type="time" value="${slot.start}" class="px-2 py-1 border rounded text-sm time-slot-start" data-idx="${idx}">
                    <span>-</span>
                    <input type="time" value="${slot.end}" class="px-2 py-1 border rounded text-sm time-slot-end" data-idx="${idx}">
                </div>
            `).join('');
        }

        function renderScheduleTable() {
            const tbody = document.getElementById('scheduleTableBody');
            const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            
            let html = '';
            for (let i = 0; i < 10; i++) {
                const slot = timeSlots[i] || { number: i + 1, start: '00:00', end: '00:00' };
                html += `<tr class="border-b border-gray-100">`;
                html += `<td class="px-4 py-3 text-sm text-gray-600">
                    <div class="font-medium">JP ${slot.number}</div>
                    <div class="text-xs text-gray-400">${slot.start} - ${slot.end}</div>
                </td>`;
                
                days.forEach(day => {
                    const schedule = scheduleItems.find(s => s.day === day && s.hourStart <= (i + 1) && (s.hourStart + s.duration - 1) >= (i + 1));
                    if (schedule && schedule.hourStart === (i + 1)) {
                        html += `<td class="px-2 py-2" rowspan="${schedule.duration}">
                            <div class="bg-primary-100 text-primary-700 rounded-lg p-2 text-center text-sm">
                                <div class="font-medium">${schedule.class}-${schedule.rombel}</div>
                                <div class="text-xs">${schedule.duration} JP</div>
                            </div>
                        </td>`;
                    } else if (!schedule || schedule.hourStart !== (i + 1)) {
                        const isOccupied = scheduleItems.some(s => s.day === day && s.hourStart < (i + 1) && (s.hourStart + s.duration - 1) >= (i + 1));
                        if (!isOccupied) {
                            html += `<td class="px-2 py-2 text-center text-gray-300">-</td>`;
                        }
                    }
                });
                
                html += `</tr>`;
            }
            
            tbody.innerHTML = html;
        }

        function renderScheduleList() {
            const container = document.getElementById('scheduleList');
            
            if (scheduleItems.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-calendar-plus text-4xl mb-2"></i>
                        <p>Belum ada jadwal. Tambahkan jadwal pertama Anda.</p>
                    </div>
                `;
                return;
            }
            
            // Group by day
            const grouped = {};
            scheduleItems.forEach(item => {
                if (!grouped[item.day]) grouped[item.day] = [];
                grouped[item.day].push(item);
            });
            
            let html = '';
            const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            
            days.forEach(day => {
                if (grouped[day] && grouped[day].length > 0) {
                    html += `<div class="mb-4">
                        <h4 class="font-semibold text-gray-700 mb-2">${day}</h4>
                        <div class="space-y-2">`;
                    
                    grouped[day].sort((a, b) => a.hourStart - b.hourStart).forEach(item => {
                        html += `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                                        <span class="font-bold text-primary-600">${item.class}${item.rombel}</span>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800">Kelas ${item.class}-${item.rombel}</p>
                                        <p class="text-sm text-gray-500">Jam ke-${item.hourStart} s/d ${item.hourStart + item.duration - 1} (${item.duration} JP)</p>
                                    </div>
                                </div>
                                <button onclick="deleteScheduleItem('${item.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                }
            });
            
            container.innerHTML = html;
        }

        async function addScheduleItem() {
            if (!currentUser) return;
            
            const day = document.getElementById('scheduleDay').value;
            const hourStart = parseInt(document.getElementById('scheduleHour').value);
            const duration = parseInt(document.getElementById('scheduleDuration').value);
            const classNum = document.getElementById('scheduleClass').value;
            const rombel = document.getElementById('scheduleRombel').value;
            
            // Validation: Check for conflicts
            const conflict = scheduleItems.find(s => {
                if (s.day !== day) return false;
                const existingStart = s.hourStart;
                const existingEnd = s.hourStart + s.duration - 1;
                const newStart = hourStart;
                const newEnd = hourStart + duration - 1;
                
                // Check time overlap
                if (newStart <= existingEnd && newEnd >= existingStart) {
                    return true;
                }
                return false;
            });
            
            if (conflict) {
                showToast('Jadwal bentrok! Anda sudah memiliki jadwal di jam tersebut.', 'error');
                return;
            }
            
            showLoading('Menyimpan jadwal...');
            
            try {
                const scheduleData = {
                    day,
                    hourStart,
                    duration,
                    class: classNum,
                    rombel,
                    academicYear: userData?.academicYear || getCurrentAcademicYear(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('users').doc(currentUser.uid)
                    .collection('schedules').add(scheduleData);
                
                scheduleItems.push({ id: docRef.id, ...scheduleData });
                
                renderScheduleTable();
                renderScheduleList();
                
                showToast('Jadwal berhasil ditambahkan!', 'success');
                
            } catch (error) {
                console.error(error);
                showToast('Gagal menyimpan jadwal', 'error');
            }
            
            hideLoading();
        }

        async function deleteScheduleItem(id) {
            if (!currentUser || !confirm('Hapus jadwal ini?')) return;
            
            showLoading('Menghapus jadwal...');
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('schedules').doc(id).delete();
                
                scheduleItems = scheduleItems.filter(s => s.id !== id);
                
                renderScheduleTable();
                renderScheduleList();
                
                showToast('Jadwal berhasil dihapus', 'success');
                
            } catch (error) {
                console.error(error);
                showToast('Gagal menghapus jadwal', 'error');
            }
            
            hideLoading();
        }

        async function saveSchedule() {
            showToast('Semua jadwal sudah tersimpan otomatis', 'info');
        }

        // ===== STUDENTS SECTION =====
        function loadStudents() {
            document.getElementById('pageTitle').textContent = 'Data Siswa';
            document.getElementById('pageSubtitle').textContent = 'Kelola data siswa per kelas';
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Daftar Siswa</h3>
                            <p class="text-gray-500 text-sm">Import dari CSV atau tambah manual</p>
                        </div>
                        <div class="flex gap-3 flex-wrap">
                            <button onclick="showImportStudentsModal()" class="px-4 py-2 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 transition-all flex items-center space-x-2">
                                <i class="fas fa-file-csv"></i>
                                <span>Import CSV</span>
                            </button>
                            <button onclick="showAddStudentModal()" class="px-6 py-2 bg-gradient-to-r from-primary-600 to-purple-600 text-white font-semibold rounded-xl hover:from-primary-700 hover:to-purple-700 transition-all">
                                <i class="fas fa-plus mr-2"></i>
                                Tambah Siswa
                            </button>
                        </div>
                    </div>

                    <!-- Filter -->
                    <div class="flex flex-wrap gap-4 mb-6">
                        <select id="filterClass" onchange="filterStudents()" class="px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                            <option value="">Semua Kelas</option>
                        </select>
                        <select id="filterRombel" onchange="filterStudents()" class="px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                            <option value="">Semua Rombel</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                        <div class="flex-1">
                            <input type="text" id="searchStudent" onkeyup="filterStudents()" placeholder="Cari nama siswa..." 
                                   class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                        </div>
                    </div>

                    <!-- Students Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 rounded-l-lg">No</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">NISN</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama Siswa</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">L/P</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Kelas</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Rombel</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 rounded-r-lg">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                <tr>
                                    <td colspan="7" class="px-4 py-8 text-center text-gray-400">
                                        <i class="fas fa-users text-4xl mb-2"></i>
                                        <p>Belum ada data siswa</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            loadStudentsData();
        }

        let allStudents = [];

        async function loadStudentsData() {
            if (!currentUser) return;
            
            try {
                const studentsSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('students')
                    .orderBy('kelas')
                    .orderBy('nama')
                    .get();
                
                allStudents = [];
                studentsSnap.forEach(doc => {
                    allStudents.push({ id: doc.id, ...doc.data() });
                });
                
                // Populate class filter
                const classes = [...new Set(allStudents.map(s => s.kelas))].sort((a, b) => parseInt(a) - parseInt(b));
                const filterClass = document.getElementById('filterClass');
                filterClass.innerHTML = '<option value="">Semua Kelas</option>' + 
                    classes.map(c => `<option value="${c}">Kelas ${c}</option>`).join('');
                
                renderStudentsTable(allStudents);
                
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        function filterStudents() {
            const classFilter = document.getElementById('filterClass').value;
            const rombelFilter = document.getElementById('filterRombel').value;
            const search = document.getElementById('searchStudent').value.toLowerCase();
            
            let filtered = allStudents;
            
            if (classFilter) {
                filtered = filtered.filter(s => s.kelas === classFilter);
            }
            if (rombelFilter) {
                filtered = filtered.filter(s => s.rombel === rombelFilter);
            }
            if (search) {
                filtered = filtered.filter(s => s.nama.toLowerCase().includes(search));
            }
            
            renderStudentsTable(filtered);
        }

        function renderStudentsTable(students) {
            const tbody = document.getElementById('studentsTableBody');
            
            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-400">
                            <i class="fas fa-users text-4xl mb-2"></i>
                            <p>Tidak ada data siswa</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = students.map((student, idx) => `
                <tr class="border-b border-gray-50 hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-600">${idx + 1}</td>
                    <td class="px-4 py-3 text-sm text-gray-800">${student.nisn || '-'}</td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-800">${student.nama}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 ${student.jk === 'L' ? 'bg-blue-100 text-blue-700' : 'bg-pink-100 text-pink-700'} text-xs font-medium rounded-full">
                            ${student.jk}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center text-sm text-gray-600">${student.kelas}</td>
                    <td class="px-4 py-3 text-center text-sm text-gray-600">${student.rombel}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="editStudent('${student.id}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteStudent('${student.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function showAddStudentModal() {
            const level = userData?.profile?.school?.level || 'SD';
            
            const modal = document.createElement('div');
            modal.id = 'studentModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Tambah Siswa</h3>
                        <button onclick="closeStudentModal()" class="p-2 hover:bg-gray-100 rounded-lg">
                            <i class="fas fa-times text-gray-400"></i>
                        </button>
                    </div>
                    <form id="addStudentForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">NISN</label>
                            <input type="text" id="studentNISN" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500" placeholder="10 digit NISN">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap *</label>
                            <input type="text" id="studentName" required class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500" placeholder="Nama lengkap siswa">
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">L/P *</label>
                                <select id="studentGender" required class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                    <option value="L">Laki-laki</option>
                                    <option value="P">Perempuan</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas *</label>
                                <select id="studentClass" required class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                    ${generateClassOptions(level)}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Rombel *</label>
                                <select id="studentRombel" required class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeStudentModal()" class="px-6 py-2 border border-gray-200 text-gray-600 rounded-xl hover:bg-gray-50">
                                Batal
                            </button>
                            <button type="submit" class="px-6 py-2 bg-primary-500 text-white rounded-xl hover:bg-primary-600">
                                Simpan
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveStudent();
            });
        }

        function closeStudentModal() {
            const modal = document.getElementById('studentModal');
            if (modal) modal.remove();
        }

        async function saveStudent() {
            if (!currentUser) return;
            
            showLoading('Menyimpan data siswa...');
            
            try {
                const studentData = {
                    nisn: document.getElementById('studentNISN').value.trim(),
                    nama: document.getElementById('studentName').value.trim(),
                    jk: document.getElementById('studentGender').value,
                    kelas: document.getElementById('studentClass').value,
                    rombel: document.getElementById('studentRombel').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(currentUser.uid)
                    .collection('students').add(studentData);
                
                closeStudentModal();
                showToast('Siswa berhasil ditambahkan!', 'success');
                loadStudentsData();
                
            } catch (error) {
                console.error(error);
                showToast('Gagal menyimpan data siswa', 'error');
            }
            
            hideLoading();
        }

        async function deleteStudent(id) {
            if (!currentUser || !confirm('Hapus siswa ini?')) return;
            
            showLoading('Menghapus siswa...');
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('students').doc(id).delete();
                
                showToast('Siswa berhasil dihapus', 'success');
                loadStudentsData();
                
            } catch (error) {
                console.error(error);
                showToast('Gagal menghapus siswa', 'error');
            }
            
            hideLoading();
        }

        function showImportStudentsModal() {
            const modal = document.createElement('div');
            modal.id = 'importModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Import Data Siswa</h3>
                        <button onclick="closeImportModal()" class="p-2 hover:bg-gray-100 rounded-lg">
                            <i class="fas fa-times text-gray-400"></i>
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <p class="text-gray-600 mb-4">Import data siswa dari Google Spreadsheet yang sudah dipublikasikan sebagai CSV.</p>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
                            <h4 class="font-semibold text-blue-800 mb-2"><i class="fas fa-info-circle mr-2"></i>Format CSV</h4>
                            <p class="text-sm text-blue-700 mb-2">Header kolom yang diperlukan:</p>
                            <code class="text-xs bg-blue-100 px-2 py-1 rounded">nisn,nama,jk,kelas,rombel</code>
                            <p class="text-xs text-blue-600 mt-2">Contoh: 0012345678,Ahmad Fadhil,L,7,A</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">URL Google Spreadsheet (CSV)</label>
                            <input type="url" id="csvUrl" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500"
                                   placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
                            <p class="text-xs text-gray-500 mt-1">File > Share > Publish to web > CSV</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button onclick="closeImportModal()" class="px-6 py-2 border border-gray-200 text-gray-600 rounded-xl hover:bg-gray-50">
                            Batal
                        </button>
                        <button onclick="importStudentsFromCSV()" class="px-6 py-2 bg-primary-500 text-white rounded-xl hover:bg-primary-600">
                            <i class="fas fa-file-import mr-2"></i>Import
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeImportModal() {
            const modal = document.getElementById('importModal');
            if (modal) modal.remove();
        }

        async function importStudentsFromCSV() {
            const url = document.getElementById('csvUrl').value.trim();
            
            if (!url) {
                showToast('Masukkan URL CSV', 'warning');
                return;
            }
            
            showLoading('Mengimpor data siswa...');
            
            try {
                const response = await fetch(url);
                const csvText = await response.text();
                
                const lines = csvText.split('\n');
                const headers = lines[0].toLowerCase().split(',').map(h => h.trim());
                
                // Validate headers
                const requiredHeaders = ['nisn', 'nama', 'jk', 'kelas', 'rombel'];
                const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                
                if (missingHeaders.length > 0 && !headers.includes('nama')) {
                    showToast(`Header tidak lengkap: ${missingHeaders.join(', ')}`, 'error');
                    hideLoading();
                    return;
                }
                
                const batch = db.batch();
                let count = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    if (values.length < headers.length || !values[headers.indexOf('nama')]) continue;
                    
                    const studentData = {
                        nisn: values[headers.indexOf('nisn')] || '',
                        nama: values[headers.indexOf('nama')],
                        jk: values[headers.indexOf('jk')] || 'L',
                        kelas: values[headers.indexOf('kelas')] || '1',
                        rombel: values[headers.indexOf('rombel')] || 'A',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    const docRef = db.collection('users').doc(currentUser.uid)
                        .collection('students').doc();
                    batch.set(docRef, studentData);
                    count++;
                }
                
                await batch.commit();
                
                closeImportModal();
                showToast(`${count} siswa berhasil diimpor!`, 'success');
                loadStudentsData();
                
            } catch (error) {
                console.error(error);
                showToast('Gagal mengimpor data. Pastikan URL valid dan dapat diakses.', 'error');
            }
            
            hideLoading();
        }

        // ===== CP & TP SECTION =====
        function loadCP() {
            document.getElementById('pageTitle').textContent = 'Capaian Pembelajaran & Tujuan Pembelajaran';
            document.getElementById('pageSubtitle').textContent = 'Kelola CP dan TP untuk mata pelajaran';
            
            const level = userData?.profile?.school?.level || 'SD';
            const subjects = userData?.profile?.subjects || [{ name: 'Pendidikan Agama Islam dan Budi Pekerti' }];
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Pengaturan CP & TP</h3>
                            <p class="text-gray-500 text-sm">Berdasarkan Kepka BSKAP No. 046/H/KR/2025</p>
                        </div>
                        <div class="flex gap-3">
                            <select id="cpSubject" onchange="loadCPForSubject()" class="px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                ${subjects.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <!-- Phase Selection -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6" id="phaseButtons">
                        ${generatePhaseButtons(level)}
                    </div>

                    <!-- CP Content -->
                    <div id="cpContent">
                        <div class="text-center py-12 text-gray-400">
                            <i class="fas fa-bullseye text-5xl mb-4"></i>
                            <p>Pilih fase untuk melihat Capaian Pembelajaran</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function generatePhaseButtons(level) {
            const phaseMap = {
                'SD': ['A', 'B', 'C'],
                'SMP': ['D'],
                'SMA': ['E', 'F'],
                'SMK': ['E', 'F']
            };
            
            const phases = phaseMap[level] || ['A', 'B', 'C'];
            
            return phases.map(phase => {
                const phaseData = CP_DATA_PAI.phases[phase];
                return `
                    <button onclick="loadPhaseCP('${phase}')" class="p-4 border-2 border-gray-200 rounded-xl hover:border-primary-500 hover:bg-primary-50 transition-all phase-btn" data-phase="${phase}">
                        <div class="text-2xl font-bold text-primary-600 mb-1">Fase ${phase}</div>
                        <div class="text-sm text-gray-500">Kelas ${phaseData.grades.join('-')}</div>
                    </button>
                `;
            }).join('');
        }

        function loadPhaseCP(phase) {
            // Update active button
            document.querySelectorAll('.phase-btn').forEach(btn => {
                btn.classList.remove('border-primary-500', 'bg-primary-50');
                btn.classList.add('border-gray-200');
            });
            document.querySelector(`[data-phase="${phase}"]`).classList.add('border-primary-500', 'bg-primary-50');
            document.querySelector(`[data-phase="${phase}"]`).classList.remove('border-gray-200');
            
            const phaseData = CP_DATA_PAI.phases[phase];
            const subject = document.getElementById('cpSubject').value;
            
            let html = '';
            
            if (subject.toLowerCase().includes('agama islam')) {
                // Show PAI CP Data
                html = `
                    <div class="space-y-6">
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 border border-green-200">
                            <h4 class="font-bold text-green-800 mb-2">
                                <i class="fas fa-info-circle mr-2"></i>Informasi Fase ${phase}
                            </h4>
                            <p class="text-green-700">Jenjang: ${phaseData.level} | Kelas: ${phaseData.grades.join(', ')}</p>
                        </div>
                        
                        ${phaseData.elements.map((element, idx) => `
                            <div class="border border-gray-200 rounded-xl overflow-hidden">
                                <div class="bg-gray-50 px-4 py-3 flex items-center justify-between cursor-pointer" onclick="toggleElement('element-${idx}')">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-primary-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-book-quran text-primary-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-gray-800">${element.name}</h4>
                                            <p class="text-sm text-gray-500">${element.description}</p>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-down text-gray-400 element-arrow" id="arrow-element-${idx}"></i>
                                </div>
                                <div class="hidden p-4 border-t border-gray-100" id="element-${idx}">
                                    <h5 class="font-semibold text-gray-700 mb-3">Tujuan Pembelajaran:</h5>
                                    <div class="space-y-2">
                                        ${element.tujuanPembelajaran.map((tp, tpIdx) => `
                                            <div class="flex items-start space-x-3 p-3 bg-blue-50 rounded-lg">
                                                <span class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">
                                                    ${tpIdx + 1}
                                                </span>
                                                <p class="text-gray-700">${tp}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div class="mt-4 flex justify-end">
                                        <button onclick="addToATP('${phase}', '${element.id}')" class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-all text-sm">
                                            <i class="fas fa-plus mr-1"></i> Tambahkan ke ATP
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                // Show custom CP input for non-PAI subjects
                html = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
                        <h4 class="font-semibold text-yellow-800 mb-2">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Mata Pelajaran Non-PAI
                        </h4>
                        <p class="text-yellow-700">Untuk mata pelajaran selain PAI, silakan input CP dan TP secara manual atau import dari CSV.</p>
                    </div>
                    
                    <div class="bg-white border border-gray-200 rounded-xl p-6">
                        <h4 class="font-semibold text-gray-800 mb-4">Tambah Capaian Pembelajaran</h4>
                        <form id="customCPForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nama Elemen/Materi</label>
                                <input type="text" id="cpElementName" required class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi CP</label>
                                <textarea id="cpDescription" rows="3" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tujuan Pembelajaran (satu per baris)</label>
                                <textarea id="cpTujuan" rows="5" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500" placeholder="TP 1&#10;TP 2&#10;TP 3"></textarea>
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="px-6 py-2 bg-primary-500 text-white rounded-xl hover:bg-primary-600">
                                    <i class="fas fa-save mr-2"></i>Simpan CP
                                </button>
                            </div>
                        </form>
                    </div>
                `;
            }
            
            document.getElementById('cpContent').innerHTML = html;
        }

        function toggleElement(elementId) {
            const element = document.getElementById(elementId);
            const arrow = document.getElementById('arrow-' + elementId);
            
            element.classList.toggle('hidden');
            arrow.classList.toggle('rotate-180');
        }

        // ===== ATP SECTION =====
        function loadATP() {
            document.getElementById('pageTitle').textContent = 'Alur Tujuan Pembelajaran (ATP)';
            document.getElementById('pageSubtitle').textContent = 'Susun alur pembelajaran berdasarkan TP';
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Alur Tujuan Pembelajaran</h3>
                            <p class="text-gray-500 text-sm">Sinkron dengan Kalender dan Jadwal</p>
                        </div>
                        <div class="flex gap-3 flex-wrap">
                            <select id="atpClass" onchange="loadATPForClass()" class="px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                <option value="">Pilih Kelas</option>
                            </select>
                            <button onclick="generateATP()" class="px-4 py-2 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 transition-all">
                                <i class="fas fa-magic mr-2"></i>Generate Otomatis
                            </button>
                            <button onclick="printATP()" class="px-4 py-2 bg-primary-500 text-white rounded-xl hover:bg-primary-600 transition-all">
                                <i class="fas fa-print mr-2"></i>Cetak
                            </button>
                        </div>
                    </div>

                    <!-- ATP Table -->
                    <div class="overflow-x-auto" id="atpContainer">
                        <div class="text-center py-12 text-gray-400">
                            <i class="fas fa-route text-5xl mb-4"></i>
                            <p>Pilih kelas untuk melihat ATP</p>
                        </div>
                    </div>
                </div>
            `;
            
            populateATPClassSelect();
        }

        async function populateATPClassSelect() {
            if (!currentUser) return;
            
            try {
                const schedulesSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('schedules')
                    .where('academicYear', '==', userData?.academicYear || getCurrentAcademicYear())
                    .get();
                
                const classes = new Set();
                schedulesSnap.forEach(doc => {
                    const data = doc.data();
                    classes.add(`${data.class}-${data.rombel}`);
                });
                
                const select = document.getElementById('atpClass');
                select.innerHTML = '<option value="">Pilih Kelas</option>' + 
                    Array.from(classes).sort().map(c => `<option value="${c}">Kelas ${c}</option>`).join('');
                
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        async function loadATPForClass() {
            const classRombel = document.getElementById('atpClass').value;
            if (!classRombel) return;
            
            const [kelas, rombel] = classRombel.split('-');
            const level = userData?.profile?.school?.level || 'SD';
            
            // Determine phase based on class
            let phase = 'A';
            const kelasNum = parseInt(kelas);
            if (level === 'SD') {
                if (kelasNum <= 2) phase = 'A';
                else if (kelasNum <= 4) phase = 'B';
                else phase = 'C';
            } else if (level === 'SMP') {
                phase = 'D';
            } else {
                if (kelasNum === 10) phase = 'E';
                else phase = 'F';
            }
            
            const phaseData = CP_DATA_PAI.phases[phase];
            
            const container = document.getElementById('atpContainer');
            container.innerHTML = `
                <div class="mb-4 p-4 bg-blue-50 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="font-semibold text-blue-800">Kelas ${kelas}-${rombel}</span>
                            <span class="text-blue-600 ml-2">| Fase ${phase}</span>
                        </div>
                        <span class="text-sm text-blue-600">Tahun Ajaran: ${userData?.academicYear || getCurrentAcademicYear()}</span>
                    </div>
                </div>
                
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold">No</th>
                            <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold">Elemen</th>
                            <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold">Tujuan Pembelajaran</th>
                            <th class="border border-gray-300 px-4 py-3 text-center text-sm font-semibold">JP</th>
                            <th class="border border-gray-300 px-4 py-3 text-center text-sm font-semibold">Semester</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generateATPRows(phaseData)}
                    </tbody>
                </table>
            `;
        }

        function generateATPRows(phaseData) {
            let html = '';
            let no = 1;
            
            phaseData.elements.forEach(element => {
                element.tujuanPembelajaran.forEach((tp, idx) => {
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-300 px-4 py-2 text-sm">${no}</td>
                            <td class="border border-gray-300 px-4 py-2 text-sm">${idx === 0 ? element.name : ''}</td>
                            <td class="border border-gray-300 px-4 py-2 text-sm">${tp}</td>
                            <td class="border border-gray-300 px-4 py-2 text-center">
                                <input type="number" value="4" min="1" class="w-16 px-2 py-1 border rounded text-center text-sm">
                            </td>
                            <td class="border border-gray-300 px-4 py-2 text-center">
                                <select class="px-2 py-1 border rounded text-sm">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                </select>
                            </td>
                        </tr>
                    `;
                    no++;
                });
            });
            
            return html;
        }

        // ===== PROTA SECTION =====
        function loadProta() {
            document.getElementById('pageTitle').textContent = 'Program Tahunan (Prota)';
            document.getElementById('pageSubtitle').textContent = 'Sinkron dengan Kalender & ATP';
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Program Tahunan</h3>
                            <p class="text-gray-500 text-sm">Otomatis dari ATP dan Kalender</p>
                        </div>
                        <div class="flex gap-3 flex-wrap">
                            <select id="protaClass" onchange="loadProtaForClass()" class="px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                <option value="">Pilih Kelas</option>
                            </select>
                            <button onclick="printProta()" class="px-4 py-2 bg-primary-500 text-white rounded-xl hover:bg-primary-600 transition-all">
                                <i class="fas fa-print mr-2"></i>Cetak
                            </button>
                        </div>
                    </div>

                    <div id="protaContainer">
                        <div class="text-center py-12 text-gray-400">
                            <i class="fas fa-calendar-check text-5xl mb-4"></i>
                            <p>Pilih kelas untuk melihat Program Tahunan</p>
                        </div>
                    </div>
                </div>
            `;
            
            populateProtaClassSelect();
        }

        async function populateProtaClassSelect() {
            if (!currentUser) return;
            
            try {
                const schedulesSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('schedules')
                    .where('academicYear', '==', userData?.academicYear || getCurrentAcademicYear())
                    .get();
                
                const classes = new Set();
                schedulesSnap.forEach(doc => {
                    const data = doc.data();
                    classes.add(`${data.class}-${data.rombel}`);
                });
                
                const select = document.getElementById('protaClass');
                select.innerHTML = '<option value="">Pilih Kelas</option>' + 
                    Array.from(classes).sort().map(c => `<option value="${c}">Kelas ${c}</option>`).join('');
                
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        async function loadProtaForClass() {
            const classRombel = document.getElementById('protaClass').value;
            if (!classRombel) return;
            
            const [kelas, rombel] = classRombel.split('-');
            const school = userData?.profile?.school || {};
            const teacherName = userData?.displayName || currentUser?.displayName || '';
            
            const container = document.getElementById('protaContainer');
            container.innerHTML = `
                <!-- Header -->
                <div class="text-center mb-8 print:mb-4">
                    <h2 class="text-xl font-bold">PROGRAM TAHUNAN</h2>
                    <p class="text-gray-600">Tahun Pelajaran ${userData?.academicYear || getCurrentAcademicYear()}</p>
                </div>

                <!-- Info -->
                <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                    <div>
                        <table class="w-full">
                            <tr><td class="py-1 w-40">Satuan Pendidikan</td><td>: ${school.name || '-'}</td></tr>
                            <tr><td class="py-1">Mata Pelajaran</td><td>: ${userData?.profile?.subjects?.[0]?.name || 'Pendidikan Agama Islam dan Budi Pekerti'}</td></tr>
                            <tr><td class="py-1">Kelas / Semester</td><td>: ${kelas} / 1 & 2</td></tr>
                        </table>
                    </div>
                    <div>
                        <table class="w-full">
                            <tr><td class="py-1 w-40">Tahun Pelajaran</td><td>: ${userData?.academicYear || getCurrentAcademicYear()}</td></tr>
                            <tr><td class="py-1">Guru Pengampu</td><td>: ${teacherName}</td></tr>
                        </table>
                    </div>
                </div>

                <!-- Semester 1 -->
                <h3 class="font-bold text-lg mb-4 bg-primary-100 text-primary-700 px-4 py-2 rounded">SEMESTER 1 (GANJIL)</h3>
                <table class="w-full border-collapse mb-8">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 px-3 py-2 text-sm">No</th>
                            <th class="border border-gray-300 px-3 py-2 text-sm">Tujuan Pembelajaran</th>
                            <th class="border border-gray-300 px-3 py-2 text-sm">Alokasi Waktu</th>
                            <th class="border border-gray-300 px-3 py-2 text-sm">Keterangan</th>
                        </tr>
                    </thead>
                    <tbody id="protaSem1Body">
                        <!-- Content -->
                    </tbody>
                </table>

                <!-- Semester 2 -->
                <h3 class="font-bold text-lg mb-4 bg-primary-100 text-primary-700 px-4 py-2 rounded">SEMESTER 2 (GENAP)</h3>
                <table class="w-full border-collapse mb-8">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 px-3 py-2 text-sm">No</th>
                            <th class="border border-gray-300 px-3 py-2 text-sm">Tujuan Pembelajaran</th>
                            <th class="border border-gray-300 px-3 py-2 text-sm">Alokasi Waktu</th>
                            <th class="border border-gray-300 px-3 py-2 text-sm">Keterangan</th>
                        </tr>
                    </thead>
                    <tbody id="protaSem2Body">
                        <!-- Content -->
                    </tbody>
                </table>

                <!-- Signatures -->
                <div class="grid grid-cols-2 gap-8 mt-12 text-center text-sm">
                    <div>
                        <p>Mengetahui,</p>
                        <p>Kepala ${school.name || 'Sekolah'}</p>
                        <div class="h-20"></div>
                        <p class="font-semibold underline">${school.principalName || '.........................'}</p>
                        <p>NIP. ${school.principalNIP || '.........................'}</p>
                    </div>
                    <div>
                        <p>${school.city || '.............'}, .................... 20.....</p>
                        <p>Guru Mata Pelajaran</p>
                        <div class="h-20"></div>
                        <p class="font-semibold underline">${teacherName || '.........................'}</p>
                        <p>NIP. ${userData?.profile?.nip || '.........................'}</p>
                    </div>
                </div>
            `;
            
            // Load ATP data and populate prota
            loadProtaContent(kelas);
        }

        function loadProtaContent(kelas) {
            const level = userData?.profile?.school?.level || 'SD';
            let phase = 'A';
            const kelasNum = parseInt(kelas);
            
            if (level === 'SD') {
                if (kelasNum <= 2) phase = 'A';
                else if (kelasNum <= 4) phase = 'B';
                else phase = 'C';
            } else if (level === 'SMP') {
                phase = 'D';
            } else {
                if (kelasNum === 10) phase = 'E';
                else phase = 'F';
            }
            
            const phaseData = CP_DATA_PAI.phases[phase];
            const allTP = [];
            
            phaseData.elements.forEach(element => {
                element.tujuanPembelajaran.forEach(tp => {
                    allTP.push({ element: element.name, tp });
                });
            });
            
            // Split into 2 semesters
            const midPoint = Math.ceil(allTP.length / 2);
            const sem1TP = allTP.slice(0, midPoint);
            const sem2TP = allTP.slice(midPoint);
            
            // Populate Semester 1
            const sem1Body = document.getElementById('protaSem1Body');
            sem1Body.innerHTML = sem1TP.map((item, idx) => `
                <tr>
                    <td class="border border-gray-300 px-3 py-2 text-center text-sm">${idx + 1}</td>
                    <td class="border border-gray-300 px-3 py-2 text-sm">${item.tp}</td>
                    <td class="border border-gray-300 px-3 py-2 text-center text-sm">4 JP</td>
                    <td class="border border-gray-300 px-3 py-2 text-sm">${item.element}</td>
                </tr>
            `).join('');
            
            // Populate Semester 2
            const sem2Body = document.getElementById('protaSem2Body');
            sem2Body.innerHTML = sem2TP.map((item, idx) => `
                <tr>
                    <td class="border border-gray-300 px-3 py-2 text-center text-sm">${idx + 1}</td>
                    <td class="border border-gray-300 px-3 py-2 text-sm">${item.tp}</td>
                    <td class="border border-gray-300 px-3 py-2 text-center text-sm">4 JP</td>
                    <td class="border border-gray-300 px-3 py-2 text-sm">${item.element}</td>
                </tr>
            `).join('');
        }

        // ===== PROMES SECTION =====
        function loadPromes() {
            document.getElementById('pageTitle').textContent = 'Program Semester (Promes)';
            document.getElementById('pageSubtitle').textContent = 'Detail jadwal per minggu dengan tanggal';
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Program Semester</h3>
                            <p class="text-gray-500 text-sm">Detail dengan tanggal dan jam pelajaran</p>
                        </div>
                        <div class="flex gap-3 flex-wrap">
                            <select id="promesClass" onchange="loadPromesForClass()" class="px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                <option value="">Pilih Kelas</option>
                            </select>
                            <select id="promesSemester" onchange="loadPromesForClass()" class="px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                            </select>
                            <button onclick="printPromes()" class="px-4 py-2 bg-primary-500 text-white rounded-xl hover:bg-primary-600 transition-all">
                                <i class="fas fa-print mr-2"></i>Cetak
                            </button>
                        </div>
                    </div>

                    <div id="promesContainer">
                        <div class="text-center py-12 text-gray-400">
                            <i class="fas fa-calendar-week text-5xl mb-4"></i>
                            <p>Pilih kelas dan semester untuk melihat Program Semester</p>
                        </div>
                    </div>
                </div>
            `;
            
            populatePromesClassSelect();
        }

        async function populatePromesClassSelect() {
            if (!currentUser) return;
            
            try {
                const schedulesSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('schedules')
                    .where('academicYear', '==', userData?.academicYear || getCurrentAcademicYear())
                    .get();
                
                const classes = new Set();
                schedulesSnap.forEach(doc => {
                    const data = doc.data();
                    classes.add(`${data.class}-${data.rombel}`);
                });
                
                const select = document.getElementById('promesClass');
                select.innerHTML = '<option value="">Pilih Kelas</option>' + 
                    Array.from(classes).sort().map(c => `<option value="${c}">Kelas ${c}</option>`).join('');
                
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        async function loadPromesForClass() {
            const classRombel = document.getElementById('promesClass').value;
            const semester = document.getElementById('promesSemester').value;
            if (!classRombel) return;
            
            const [kelas, rombel] = classRombel.split('-');
            const school = userData?.profile?.school || {};
            const months = semester === '1' 
                ? ['Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember']
                : ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni'];
            
            const container = document.getElementById('promesContainer');
            container.innerHTML = `
                <!-- Header -->
                <div class="text-center mb-6">
                    <h2 class="text-xl font-bold">PROGRAM SEMESTER ${semester === '1' ? 'GANJIL' : 'GENAP'}</h2>
                    <p class="text-gray-600">Tahun Pelajaran ${userData?.academicYear || getCurrentAcademicYear()}</p>
                </div>

                <!-- Info -->
                <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                    <div>
                        <table class="w-full">
                            <tr><td class="py-1 w-40">Satuan Pendidikan</td><td>: ${school.name || '-'}</td></tr>
                            <tr><td class="py-1">Kelas / Semester</td><td>: ${kelas} / ${semester}</td></tr>
                        </table>
                    </div>
                    <div>
                        <table class="w-full">
                            <tr><td class="py-1 w-40">Mata Pelajaran</td><td>: ${userData?.profile?.subjects?.[0]?.name || 'PAI'}</td></tr>
                            <tr><td class="py-1">Tahun Pelajaran</td><td>: ${userData?.academicYear || getCurrentAcademicYear()}</td></tr>
                        </table>
                    </div>
                </div>

                <!-- Promes Table -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse text-sm">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 px-2 py-2" rowspan="2">No</th>
                                <th class="border border-gray-300 px-2 py-2" rowspan="2">Tujuan Pembelajaran</th>
                                <th class="border border-gray-300 px-2 py-2" rowspan="2">JP</th>
                                ${months.map(m => `<th class="border border-gray-300 px-2 py-2" colspan="4">${m}</th>`).join('')}
                            </tr>
                            <tr class="bg-gray-50">
                                ${months.map(() => `
                                    <th class="border border-gray-300 px-1 py-1 text-xs">1</th>
                                    <th class="border border-gray-300 px-1 py-1 text-xs">2</th>
                                    <th class="border border-gray-300 px-1 py-1 text-xs">3</th>
                                    <th class="border border-gray-300 px-1 py-1 text-xs">4</th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody id="promesTableBody">
                            <!-- Content will be loaded -->
                        </tbody>
                    </table>
                </div>

                <!-- Signatures -->
                <div class="grid grid-cols-2 gap-8 mt-12 text-center text-sm">
                    <div>
                        <p>Mengetahui,</p>
                        <p>Kepala ${school.name || 'Sekolah'}</p>
                        <div class="h-20"></div>
                        <p class="font-semibold underline">${school.principalName || '.........................'}</p>
                        <p>NIP. ${school.principalNIP || '.........................'}</p>
                    </div>
                    <div>
                        <p>${school.city || '.............'}, .................... 20.....</p>
                        <p>Guru Mata Pelajaran</p>
                        <div class="h-20"></div>
                        <p class="font-semibold underline">${userData?.displayName || '.........................'}</p>
                        <p>NIP. ${userData?.profile?.nip || '.........................'}</p>
                    </div>
                </div>
            `;
            
            loadPromesContent(kelas, semester);
        }

        function loadPromesContent(kelas, semester) {
            const level = userData?.profile?.school?.level || 'SD';
            let phase = 'A';
            const kelasNum = parseInt(kelas);
            
            if (level === 'SD') {
                if (kelasNum <= 2) phase = 'A';
                else if (kelasNum <= 4) phase = 'B';
                else phase = 'C';
            } else if (level === 'SMP') {
                phase = 'D';
            } else {
                if (kelasNum === 10) phase = 'E';
                else phase = 'F';
            }
            
            const phaseData = CP_DATA_PAI.phases[phase];
            const allTP = [];
            
            phaseData.elements.forEach(element => {
                element.tujuanPembelajaran.forEach(tp => {
                    allTP.push({ element: element.name, tp });
                });
            });
            
            // Get TP for selected semester
            const midPoint = Math.ceil(allTP.length / 2);
            const semesterTP = semester === '1' ? allTP.slice(0, midPoint) : allTP.slice(midPoint);
            
            const tbody = document.getElementById('promesTableBody');
            let weekCounter = 0;
            
            tbody.innerHTML = semesterTP.map((item, idx) => {
                // Determine which weeks this TP spans
                const startWeek = weekCounter;
                const jpCount = 4; // Default 4 JP per TP
                const weeksNeeded = Math.ceil(jpCount / 2); // Assuming 2 JP per week
                weekCounter += weeksNeeded;
                
                // Generate week markers
                let weekCells = '';
                for (let m = 0; m < 6; m++) { // 6 months
                    for (let w = 0; w < 4; w++) { // 4 weeks per month
                        const weekNum = m * 4 + w;
                        const isActive = weekNum >= startWeek && weekNum < startWeek + weeksNeeded;
                        weekCells += `<td class="border border-gray-300 px-1 py-1 text-center ${isActive ? 'bg-primary-200' : ''}">${isActive ? '' : ''}</td>`;
                    }
                }
                
                return `
                    <tr>
                        <td class="border border-gray-300 px-2 py-2 text-center">${idx + 1}</td>
                        <td class="border border-gray-300 px-2 py-2">${item.tp}</td>
                        <td class="border border-gray-300 px-2 py-2 text-center">${jpCount}</td>
                        ${weekCells}
                    </tr>
                `;
            }).join('');
        }

        // ===== JOURNAL SECTION =====
        function loadJournal() {
            document.getElementById('pageTitle').textContent = 'Jurnal Pembelajaran';
            document.getElementById('pageSubtitle').textContent = 'Sinkron dengan Promes dan Absensi';
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Jurnal Pembelajaran</h3>
                            <p class="text-gray-500 text-sm">Otomatis terisi dari Promes</p>
                        </div>
                        <div class="flex gap-3 flex-wrap">
                            <select id="journalClass" onchange="loadJournalForClass()" class="px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                <option value="">Pilih Kelas</option>
                            </select>
                            <select id="journalSemester" class="px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                            </select>
                            <button onclick="addJournalEntry()" class="px-4 py-2 bg-primary-500 text-white rounded-xl hover:bg-primary-600 transition-all">
                                <i class="fas fa-plus mr-2"></i>Tambah
                            </button>
                            <button onclick="printJournal()" class="px-4 py-2 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 transition-all">
                                <i class="fas fa-print mr-2"></i>Cetak
                            </button>
                        </div>
                    </div>

                    <div id="journalContainer">
                        <div class="text-center py-12 text-gray-400">
                            <i class="fas fa-journal-whills text-5xl mb-4"></i>
                            <p>Pilih kelas untuk melihat jurnal</p>
                        </div>
                    </div>
                </div>
            `;
            
            populateJournalClassSelect();
        }

        async function populateJournalClassSelect() {
            if (!currentUser) return;
            
            try {
                const schedulesSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('schedules')
                    .where('academicYear', '==', userData?.academicYear || getCurrentAcademicYear())
                    .get();
                
                const classes = new Set();
                schedulesSnap.forEach(doc => {
                    const data = doc.data();
                    classes.add(`${data.class}-${data.rombel}`);
                });
                
                const select = document.getElementById('journalClass');
                select.innerHTML = '<option value="">Pilih Kelas</option>' + 
                    Array.from(classes).sort().map(c => `<option value="${c}">Kelas ${c}</option>`).join('');
                
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        async function loadJournalForClass() {
            const classRombel = document.getElementById('journalClass').value;
            if (!classRombel) return;
            
            const [kelas, rombel] = classRombel.split('-');
            const semester = document.getElementById('journalSemester').value;
            const school = userData?.profile?.school || {};
            
            const container = document.getElementById('journalContainer');
            container.innerHTML = `
                <!-- Header -->
                <div class="text-center mb-6">
                    <h2 class="text-xl font-bold">JURNAL PEMBELAJARAN</h2>
                </div>

                <!-- Info -->
                <div class="mb-6 text-sm">
                    <table class="w-full max-w-md">
                        <tr><td class="py-1 w-40">Mata Pelajaran</td><td>: ${userData?.profile?.subjects?.[0]?.name || 'Pendidikan Agama Islam dan Budi Pekerti'}</td></tr>
                        <tr><td class="py-1">Semester</td><td>: ${semester}</td></tr>
                        <tr><td class="py-1">Tahun Pelajaran</td><td>: ${userData?.academicYear || getCurrentAcademicYear()}</td></tr>
                    </table>
                </div>

                <!-- Journal Table -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 px-3 py-2 text-sm">No</th>
                                <th class="border border-gray-300 px-3 py-2 text-sm">Kelas</th>
                                <th class="border border-gray-300 px-3 py-2 text-sm">Materi</th>
                                <th class="border border-gray-300 px-3 py-2 text-sm">Tujuan Pembelajaran</th>
                                <th class="border border-gray-300 px-3 py-2 text-sm">Kehadiran</th>
                                <th class="border border-gray-300 px-3 py-2 text-sm">Hari/Tanggal</th>
                                <th class="border border-gray-300 px-3 py-2 text-sm">Hasil Pembelajaran</th>
                            </tr>
                        </thead>
                        <tbody id="journalTableBody">
                            <tr>
                                <td colspan="7" class="border border-gray-300 px-3 py-8 text-center text-gray-400">
                                    Belum ada data jurnal
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Signatures -->
                <div class="grid grid-cols-2 gap-8 mt-12 text-center text-sm">
                    <div>
                        <p>Mengetahui,</p>
                        <p>Kepala ${school.name || 'Sekolah'}</p>
                        <div class="h-20"></div>
                        <p class="font-semibold underline">${school.principalName || '.........................'}</p>
                        <p>NIP. ${school.principalNIP || '.........................'}</p>
                    </div>
                    <div>
                        <p>${school.city || '.............'}, .................... 20.....</p>
                        <p>Guru Mata Pelajaran</p>
                        <div class="h-20"></div>
                        <p class="font-semibold underline">${userData?.displayName || '.........................'}</p>
                        <p>NIP. ${userData?.profile?.nip || '.........................'}</p>
                    </div>
                </div>
            `;
            
            // Load journal entries
            loadJournalEntries(kelas, rombel, semester);
        }

        async function loadJournalEntries(kelas, rombel, semester) {
            if (!currentUser) return;
            
            try {
                const journalsSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('journals')
                    .where('kelas', '==', kelas)
                    .where('rombel', '==', rombel)
                    .where('semester', '==', semester)
                    .orderBy('tanggal', 'desc')
                    .get();
                
                const tbody = document.getElementById('journalTableBody');
                
                if (journalsSnap.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="border border-gray-300 px-3 py-8 text-center text-gray-400">
                                Belum ada data jurnal. Klik "Tambah" untuk menambahkan.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                let no = 1;
                journalsSnap.forEach(doc => {
                    const j = doc.data();
                    html += `
                        <tr>
                            <td class="border border-gray-300 px-3 py-2 text-center text-sm">${no++}</td>
                            <td class="border border-gray-300 px-3 py-2 text-sm">${j.kelas}-${j.rombel}</td>
                            <td class="border border-gray-300 px-3 py-2 text-sm">${j.materi || '-'}</td>
                            <td class="border border-gray-300 px-3 py-2 text-sm">${j.tp || '-'}</td>
                            <td class="border border-gray-300 px-3 py-2 text-sm text-center">${j.kehadiran || '-'}</td>
                            <td class="border border-gray-300 px-3 py-2 text-sm">${j.tanggal || '-'}</td>
                            <td class="border border-gray-300 px-3 py-2 text-sm">${j.hasil || '-'}</td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading journals:', error);
            }
        }

        // ===== ATTENDANCE SECTION =====
        function loadAttendance() {
            document.getElementById('pageTitle').textContent = 'Absensi Siswa';
            document.getElementById('pageSubtitle').textContent = 'Kelola kehadiran siswa';
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Absensi</h3>
                            <p class="text-gray-500 text-sm">Otomatis masuk ke jurnal</p>
                        </div>
                        <div class="flex gap-3 flex-wrap">
                            <select id="attendanceClass" onchange="loadAttendanceForClass()" class="px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                <option value="">Pilih Kelas</option>
                            </select>
                            <input type="date" id="attendanceDate" value="${new Date().toISOString().split('T')[0]}" onchange="loadAttendanceForClass()" 
                                   class="px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                            <button onclick="saveAttendance()" class="px-4 py-2 bg-primary-500 text-white rounded-xl hover:bg-primary-600 transition-all">
                                <i class="fas fa-save mr-2"></i>Simpan
                            </button>
                        </div>
                    </div>

                    <div id="attendanceContainer">
                        <div class="text-center py-12 text-gray-400">
                            <i class="fas fa-clipboard-check text-5xl mb-4"></i>
                            <p>Pilih kelas dan tanggal untuk mengisi absensi</p>
                        </div>
                    </div>
                </div>
            `;
            
            populateAttendanceClassSelect();
        }

        async function populateAttendanceClassSelect() {
            if (!currentUser) return;
            
            try {
                const schedulesSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('schedules')
                    .where('academicYear', '==', userData?.academicYear || getCurrentAcademicYear())
                    .get();
                
                const classes = new Set();
                schedulesSnap.forEach(doc => {
                    const data = doc.data();
                    classes.add(`${data.class}-${data.rombel}`);
                });
                
                const select = document.getElementById('attendanceClass');
                select.innerHTML = '<option value="">Pilih Kelas</option>' + 
                    Array.from(classes).sort().map(c => `<option value="${c}">Kelas ${c}</option>`).join('');
                
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        async function loadAttendanceForClass() {
            const classRombel = document.getElementById('attendanceClass').value;
            const date = document.getElementById('attendanceDate').value;
            if (!classRombel || !date) return;
            
            const [kelas, rombel] = classRombel.split('-');
            
            try {
                // Load students for this class
                const studentsSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('students')
                    .where('kelas', '==', kelas)
                    .where('rombel', '==', rombel)
                    .orderBy('nama')
                    .get();
                
                const students = [];
                studentsSnap.forEach(doc => {
                    students.push({ id: doc.id, ...doc.data() });
                });
                
                // Load existing attendance for this date
                const attendanceDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('attendance')
                    .doc(`${kelas}-${rombel}-${date}`)
                    .get();
                
                const existingAttendance = attendanceDoc.exists ? attendanceDoc.data().records : {};
                
                const container = document.getElementById('attendanceContainer');
                
                if (students.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-400">
                            <i class="fas fa-users text-5xl mb-4"></i>
                            <p>Belum ada siswa di kelas ini</p>
                            <button onclick="loadSection('students')" class="mt-4 text-primary-600 hover:text-primary-700 font-medium">
                                Tambah Data Siswa <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <div class="mb-4 flex items-center justify-between">
                        <div>
                            <span class="font-semibold">Kelas ${kelas}-${rombel}</span>
                            <span class="text-gray-500 ml-2">| ${new Date(date).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</span>
                        </div>
                        <div class="flex gap-4 text-sm">
                            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full">Hadir: <span id="countH">0</span></span>
                            <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full">Izin: <span id="countI">0</span></span>
                            <span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full">Sakit: <span id="countS">0</span></span>
                            <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full">Alpha: <span id="countA">0</span></span>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-4 py-3 text-left text-sm font-semibold">No</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Nama Siswa</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold">L/P</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold">Hadir</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold">Izin</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold">Sakit</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold">Alpha</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${students.map((student, idx) => {
                                    const status = existingAttendance[student.id] || 'H';
                                    return `
                                        <tr class="border-b border-gray-100">
                                            <td class="px-4 py-3 text-sm">${idx + 1}</td>
                                            <td class="px-4 py-3 text-sm font-medium">${student.nama}</td>
                                            <td class="px-4 py-3 text-center text-sm">${student.jk}</td>
                                            <td class="px-4 py-3 text-center">
                                                <input type="radio" name="att-${student.id}" value="H" ${status === 'H' ? 'checked' : ''} onchange="updateAttendanceCount()" class="w-4 h-4 text-green-600">
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <input type="radio" name="att-${student.id}" value="I" ${status === 'I' ? 'checked' : ''} onchange="updateAttendanceCount()" class="w-4 h-4 text-yellow-600">
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <input type="radio" name="att-${student.id}" value="S" ${status === 'S' ? 'checked' : ''} onchange="updateAttendanceCount()" class="w-4 h-4 text-orange-600">
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <input type="radio" name="att-${student.id}" value="A" ${status === 'A' ? 'checked' : ''} onchange="updateAttendanceCount()" class="w-4 h-4 text-red-600">
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                updateAttendanceCount();
                
            } catch (error) {
                console.error('Error loading attendance:', error);
            }
        }

        function updateAttendanceCount() {
            const counts = { H: 0, I: 0, S: 0, A: 0 };
            document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                counts[radio.value]++;
            });
            
            document.getElementById('countH').textContent = counts.H;
            document.getElementById('countI').textContent = counts.I;
            document.getElementById('countS').textContent = counts.S;
            document.getElementById('countA').textContent = counts.A;
        }

        async function saveAttendance() {
            const classRombel = document.getElementById('attendanceClass').value;
            const date = document.getElementById('attendanceDate').value;
            if (!classRombel || !date) {
                showToast('Pilih kelas dan tanggal terlebih dahulu', 'warning');
                return;
            }
            
            const [kelas, rombel] = classRombel.split('-');
            
            showLoading('Menyimpan absensi...');
            
            try {
                const records = {};
                document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                    const studentId = radio.name.replace('att-', '');
                    records[studentId] = radio.value;
                });
                
                await db.collection('users').doc(currentUser.uid)
                    .collection('attendance')
                    .doc(`${kelas}-${rombel}-${date}`)
                    .set({
                        kelas,
                        rombel,
                        tanggal: date,
                        records,
                        academicYear: userData?.academicYear || getCurrentAcademicYear(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                showToast('Absensi berhasil disimpan!', 'success');
                
            } catch (error) {
                console.error(error);
                showToast('Gagal menyimpan absensi', 'error');
            }
            
            hideLoading();
        }

        // ===== GRADES SECTION =====
        function loadGrades() {
            document.getElementById('pageTitle').textContent = 'Daftar Nilai';
            document.getElementById('pageSubtitle').textContent = 'Kelola nilai siswa';
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Daftar Nilai</h3>
                            <p class="text-gray-500 text-sm">PH, PTS, PAS, dan Nilai Raport</p>
                        </div>
                        <div class="flex gap-3 flex-wrap">
                            <select id="gradesClass" onchange="loadGradesForClass()" class="px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                <option value="">Pilih Kelas</option>
                            </select>
                            <select id="gradesSemester" onchange="loadGradesForClass()" class="px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                            </select>
                            <button onclick="saveGrades()" class="px-4 py-2 bg-primary-500 text-white rounded-xl hover:bg-primary-600 transition-all">
                                <i class="fas fa-save mr-2"></i>Simpan
                            </button>
                        </div>
                    </div>

                    <!-- Grade Types Config -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-xl">
                        <h4 class="font-medium text-gray-700 mb-3">Jenis Penilaian:</h4>
                        <div id="gradeTypes" class="flex flex-wrap gap-2">
                            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">PH1</span>
                            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">PH2</span>
                            <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm">PTS</span>
                            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">PAS</span>
                            <button onclick="addGradeType()" class="px-3 py-1 border border-dashed border-gray-300 text-gray-500 rounded-full text-sm hover:border-gray-400">
                                <i class="fas fa-plus mr-1"></i>Tambah
                            </button>
                        </div>
                    </div>

                    <div id="gradesContainer">
                        <div class="text-center py-12 text-gray-400">
                            <i class="fas fa-star text-5xl mb-4"></i>
                            <p>Pilih kelas untuk melihat daftar nilai</p>
                        </div>
                    </div>
                </div>
            `;
            
            populateGradesClassSelect();
        }

        async function populateGradesClassSelect() {
            if (!currentUser) return;
            
            try {
                const schedulesSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('schedules')
                    .where('academicYear', '==', userData?.academicYear || getCurrentAcademicYear())
                    .get();
                
                const classes = new Set();
                schedulesSnap.forEach(doc => {
                    const data = doc.data();
                    classes.add(`${data.class}-${data.rombel}`);
                });
                
                const select = document.getElementById('gradesClass');
                select.innerHTML = '<option value="">Pilih Kelas</option>' + 
                    Array.from(classes).sort().map(c => `<option value="${c}">Kelas ${c}</option>`).join('');
                
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        async function loadGradesForClass() {
            const classRombel = document.getElementById('gradesClass').value;
            const semester = document.getElementById('gradesSemester').value;
            if (!classRombel) return;
            
            const [kelas, rombel] = classRombel.split('-');
            
            try {
                // Load students
                const studentsSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('students')
                    .where('kelas', '==', kelas)
                    .where('rombel', '==', rombel)
                    .orderBy('nama')
                    .get();
                
                const students = [];
                studentsSnap.forEach(doc => {
                    students.push({ id: doc.id, ...doc.data() });
                });
                
                const container = document.getElementById('gradesContainer');
                
                if (students.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-400">
                            <p>Belum ada siswa di kelas ini</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-3 py-2 text-left text-sm font-semibold">No</th>
                                    <th class="px-3 py-2 text-left text-sm font-semibold">Nama</th>
                                    <th class="px-3 py-2 text-center text-sm font-semibold">PH1</th>
                                    <th class="px-3 py-2 text-center text-sm font-semibold">PH2</th>
                                    <th class="px-3 py-2 text-center text-sm font-semibold">PTS</th>
                                    <th class="px-3 py-2 text-center text-sm font-semibold">PAS</th>
                                    <th class="px-3 py-2 text-center text-sm font-semibold bg-green-100">NA</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${students.map((student, idx) => `
                                    <tr class="border-b border-gray-100" data-student="${student.id}">
                                        <td class="px-3 py-2 text-sm">${idx + 1}</td>
                                        <td class="px-3 py-2 text-sm font-medium">${student.nama}</td>
                                        <td class="px-3 py-2"><input type="number" class="w-16 px-2 py-1 border rounded text-center text-sm grade-input" data-type="PH1" min="0" max="100"></td>
                                        <td class="px-3 py-2"><input type="number" class="w-16 px-2 py-1 border rounded text-center text-sm grade-input" data-type="PH2" min="0" max="100"></td>
                                        <td class="px-3 py-2"><input type="number" class="w-16 px-2 py-1 border rounded text-center text-sm grade-input" data-type="PTS" min="0" max="100"></td>
                                        <td class="px-3 py-2"><input type="number" class="w-16 px-2 py-1 border rounded text-center text-sm grade-input" data-type="PAS" min="0" max="100"></td>
                                        <td class="px-3 py-2 text-center font-bold text-green-700 na-value">-</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Add event listeners for auto-calculation
                document.querySelectorAll('.grade-input').forEach(input => {
                    input.addEventListener('input', calculateNA);
                });
                
            } catch (error) {
                console.error('Error loading grades:', error);
            }
        }

        function calculateNA() {
            document.querySelectorAll('tbody tr').forEach(row => {
                const inputs = row.querySelectorAll('.grade-input');
                let total = 0;
                let count = 0;
                
                inputs.forEach(input => {
                    const val = parseFloat(input.value);
                    if (!isNaN(val)) {
                        total += val;
                        count++;
                    }
                });
                
                const na = count > 0 ? Math.round(total / count) : '-';
                row.querySelector('.na-value').textContent = na;
            });
        }

        // ===== MODUL AJAR SECTION (PREMIUM) =====
        function loadModulAjar() {
            document.getElementById('pageTitle').textContent = 'Modul Ajar';
            document.getElementById('pageSubtitle').textContent = 'Sinkron dengan Promes dan terintegrasi dengan Jurnal & LKPD';
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Modul Ajar</h3>
                            <p class="text-gray-500 text-sm">Support teks Arab (RTL)</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="createNewModul()" class="px-6 py-2 bg-gradient-to-r from-primary-600 to-purple-600 text-white font-semibold rounded-xl hover:from-primary-700 hover:to-purple-700 transition-all">
                                <i class="fas fa-plus mr-2"></i>Buat Modul Baru
                            </button>
                        </div>
                    </div>

                    <div id="modulList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="col-span-full text-center py-12 text-gray-400">
                            <i class="fas fa-book text-5xl mb-4"></i>
                            <p>Belum ada modul ajar</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== LKPD SECTION (PREMIUM) =====
        function loadLKPD() {
            document.getElementById('pageTitle').textContent = 'LKPD';
            document.getElementById('pageSubtitle').textContent = 'Lembar Kerja Peserta Didik';
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">LKPD</h3>
                            <p class="text-gray-500 text-sm">Terintegrasi dengan Modul Ajar</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="createNewLKPD()" class="px-6 py-2 bg-primary-500 text-white rounded-xl hover:bg-primary-600 transition-all">
                                <i class="fas fa-plus mr-2"></i>Buat LKPD Baru
                            </button>
                        </div>
                    </div>

                    <div id="lkpdList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="col-span-full text-center py-12 text-gray-400">
                            <i class="fas fa-file-alt text-5xl mb-4"></i>
                            <p>Belum ada LKPD</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== BANK SOAL SECTION (PREMIUM) =====
        function loadBankSoal() {
            document.getElementById('pageTitle').textContent = 'Bank Soal';
            document.getElementById('pageSubtitle').textContent = 'Terintegrasi dengan ATP, support teks Arab';
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Bank Soal</h3>
                            <p class="text-gray-500 text-sm">Support teks Arab (RTL)</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="addNewQuestion()" class="px-6 py-2 bg-primary-500 text-white rounded-xl hover:bg-primary-600 transition-all">
                                <i class="fas fa-plus mr-2"></i>Tambah Soal
                            </button>
                        </div>
                    </div>

                    <div id="bankSoalContainer" class="space-y-4">
                        <div class="text-center py-12 text-gray-400">
                            <i class="fas fa-question-circle text-5xl mb-4"></i>
                            <p>Belum ada soal</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== AI ASSISTANT SECTION =====
        function loadAIAssistant() {
            document.getElementById('pageTitle').textContent = 'AI Assistant';
            document.getElementById('pageSubtitle').textContent = 'Bantu format data untuk import';
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Prompt Generator -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-magic mr-2 text-purple-500"></i>Generator Prompt AI
                        </h3>
                        <p class="text-gray-600 mb-6">Pilih jenis data yang ingin Anda format, lalu gunakan prompt yang dihasilkan di ChatGPT/Claude untuk mengubah materi Anda menjadi format CSV yang dapat diimport.</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Data</label>
                                <select id="aiDataType" onchange="generateAIPrompt()" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                    <option value="">Pilih jenis data...</option>
                                    <option value="students">Data Siswa</option>
                                    <option value="calendar">Kalender Pendidikan</option>
                                    <option value="cp">Capaian Pembelajaran (CP)</option>
                                    <option value="tp">Tujuan Pembelajaran (TP)</option>
                                    <option value="soal">Bank Soal</option>
                                </select>
                            </div>
                            
                            <div id="aiPromptResult" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prompt untuk AI</label>
                                <div class="relative">
                                    <textarea id="aiPromptText" readonly rows="10" class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 text-sm"></textarea>
                                    <button onclick="copyPrompt()" class="absolute top-2 right-2 px-3 py-1 bg-primary-500 text-white rounded-lg text-sm hover:bg-primary-600">
                                        <i class="fas fa-copy mr-1"></i>Copy
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>Cara Penggunaan
                        </h3>
                        
                        <div class="space-y-4">
                            <div class="flex items-start space-x-3">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="font-bold text-blue-600">1</span>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-800">Pilih Jenis Data</h4>
                                    <p class="text-sm text-gray-600">Pilih jenis data yang ingin Anda format dari dropdown di atas</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start space-x-3">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="font-bold text-blue-600">2</span>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-800">Copy Prompt</h4>
                                    <p class="text-sm text-gray-600">Salin prompt yang dihasilkan dengan klik tombol "Copy"</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start space-x-3">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="font-bold text-blue-600">3</span>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-800">Paste ke ChatGPT/Claude</h4>
                                    <p class="text-sm text-gray-600">Buka ChatGPT atau Claude, paste prompt dan tambahkan data mentah Anda</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start space-x-3">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="font-bold text-blue-600">4</span>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-800">Import Hasil</h4>
                                    <p class="text-sm text-gray-600">Copy hasil CSV dari AI, publish ke Google Sheets, lalu import ke aplikasi</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-xl">
                            <h4 class="font-medium text-yellow-800 mb-2"><i class="fas fa-lightbulb mr-2"></i>Tips</h4>
                            <ul class="text-sm text-yellow-700 list-disc list-inside space-y-1">
                                <li>Untuk data siswa, Anda bisa copy dari Excel atau ketik manual</li>
                                <li>AI akan membantu memformat data menjadi CSV yang siap import</li>
                                <li>Gunakan Google Sheets untuk mempublish CSV secara online</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateAIPrompt() {
            const dataType = document.getElementById('aiDataType').value;
            const resultDiv = document.getElementById('aiPromptResult');
            const promptText = document.getElementById('aiPromptText');
            
            if (!dataType) {
                resultDiv.classList.add('hidden');
                return;
            }
            
            const prompts = {
                                students: `Saya ingin mengubah data siswa menjadi format CSV untuk diimport ke aplikasi administrasi guru.

Format CSV yang dibutuhkan:
nisn,nama,jk,kelas,rombel

Keterangan:
- nisn: Nomor Induk Siswa Nasional (10 digit)
- nama: Nama lengkap siswa
- jk: Jenis kelamin (L untuk Laki-laki, P untuk Perempuan)
- kelas: Angka kelas (1-6 untuk SD, 7-9 untuk SMP, 10-12 untuk SMA)
- rombel: Huruf rombongan belajar (A, B, C, dst)

Contoh output:
nisn,nama,jk,kelas,rombel
0012345678,Ahmad Fadhil,L,7,A
0012345679,Siti Aisyah,P,7,A

Tolong ubah data berikut ke format CSV di atas:
[PASTE DATA SISWA ANDA DI SINI]`,

                calendar: `Saya ingin mengubah data kalender pendidikan menjadi format CSV.

Format CSV yang dibutuhkan:
jenis,nama,tanggal_mulai,tanggal_selesai

Keterangan:
- jenis: semester/kegiatan/libur/ujian
- nama: Keterangan kegiatan
- tanggal_mulai: Format YYYY-MM-DD
- tanggal_selesai: Format YYYY-MM-DD

Contoh output:
jenis,nama,tanggal_mulai,tanggal_selesai
semester,Semester 1,2024-07-15,2024-12-20
ujian,PTS Semester 1,2024-09-23,2024-09-28
libur,Libur Hari Raya,2024-04-10,2024-04-12

Tolong ubah data kalender berikut ke format CSV di atas:
[PASTE DATA KALENDER ANDA DI SINI]`,

                cp: `Saya ingin mengubah Capaian Pembelajaran (CP) menjadi format CSV.

Format CSV yang dibutuhkan:
fase,elemen,deskripsi

Keterangan:
- fase: Huruf fase (A, B, C, D, E, F)
- elemen: Nama elemen CP
- deskripsi: Deskripsi capaian pembelajaran

Contoh output:
fase,elemen,deskripsi
A,Al-Quran dan Hadis,Mengenal huruf hijaiah dan membaca surah pendek
A,Akidah,Mengenal rukun iman dan sifat Allah

Tolong ubah data CP berikut ke format CSV di atas:
[PASTE DATA CP ANDA DI SINI]`,

                tp: `Saya ingin mengubah Tujuan Pembelajaran (TP) menjadi format CSV.

Format CSV yang dibutuhkan:
fase,elemen,nomor_tp,tujuan_pembelajaran,alokasi_jp

Keterangan:
- fase: Huruf fase (A, B, C, D, E, F)
- elemen: Nama elemen
- nomor_tp: Nomor urut TP
- tujuan_pembelajaran: Deskripsi tujuan pembelajaran
- alokasi_jp: Jumlah jam pelajaran

Contoh output:
fase,elemen,nomor_tp,tujuan_pembelajaran,alokasi_jp
A,Al-Quran dan Hadis,1,Peserta didik mampu mengenal huruf hijaiah,4
A,Al-Quran dan Hadis,2,Peserta didik mampu membaca surah Al-Fatihah,4

Tolong ubah data TP berikut ke format CSV di atas:
[PASTE DATA TP ANDA DI SINI]`,

                soal: `Saya ingin mengubah soal-soal menjadi format CSV untuk bank soal.

Format CSV yang dibutuhkan:
fase,elemen,tipe,soal,opsi_a,opsi_b,opsi_c,opsi_d,jawaban,pembahasan

Keterangan:
- fase: Huruf fase (A-F)
- elemen: Nama elemen terkait
- tipe: PG (Pilihan Ganda) atau Uraian
- soal: Teks soal (gunakan tanda kutip jika ada koma)
- opsi_a sampai opsi_d: Pilihan jawaban (kosongkan jika uraian)
- jawaban: Kunci jawaban (A/B/C/D untuk PG, teks untuk uraian)
- pembahasan: Penjelasan jawaban

Untuk teks Arab, tulis apa adanya, sistem mendukung RTL.

Contoh output:
fase,elemen,tipe,soal,opsi_a,opsi_b,opsi_c,opsi_d,jawaban,pembahasan
A,Al-Quran,PG,"Huruf pertama dalam Al-Fatihah adalah...",Alif,Ba,Ta,Jim,A,"Alif adalah huruf pertama"

Tolong ubah soal-soal berikut ke format CSV di atas:
[PASTE SOAL-SOAL ANDA DI SINI]`
            };
            
            promptText.value = prompts[dataType] || '';
            resultDiv.classList.remove('hidden');
        }

        function copyPrompt() {
            const promptText = document.getElementById('aiPromptText');
            promptText.select();
            document.execCommand('copy');
            showToast('Prompt berhasil disalin!', 'success');
        }

        // ===== IMPORT DATA SECTION =====
        function loadImportData() {
            document.getElementById('pageTitle').textContent = 'Import Data';
            document.getElementById('pageSubtitle').textContent = 'Import data massal dari CSV';
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Import Options -->
                    <div class="space-y-6">
                        <!-- Import Siswa -->
                        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-users text-blue-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-800">Import Data Siswa</h3>
                                    <p class="text-sm text-gray-500">Dari Google Spreadsheet (CSV)</p>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <input type="url" id="importStudentsUrl" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv"
                                       class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                <button onclick="importDataFromCSV('students')" class="w-full py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-all">
                                    <i class="fas fa-file-import mr-2"></i>Import Siswa
                                </button>
                            </div>
                        </div>

                        <!-- Import Kalender -->
                        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-calendar-alt text-green-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-800">Import Kalender</h3>
                                    <p class="text-sm text-gray-500">Dari Google Spreadsheet (CSV)</p>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <input type="url" id="importCalendarUrl" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv"
                                       class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                <button onclick="importDataFromCSV('calendar')" class="w-full py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all">
                                    <i class="fas fa-file-import mr-2"></i>Import Kalender
                                </button>
                            </div>
                        </div>

                        <!-- Import TP -->
                        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-bullseye text-purple-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-800">Import Tujuan Pembelajaran</h3>
                                    <p class="text-sm text-gray-500">Dari Google Spreadsheet (CSV)</p>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <input type="url" id="importTPUrl" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv"
                                       class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                <button onclick="importDataFromCSV('tp')" class="w-full py-2 bg-purple-500 text-white rounded-xl hover:bg-purple-600 transition-all">
                                    <i class="fas fa-file-import mr-2"></i>Import TP
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>Panduan Import CSV
                        </h3>
                        
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-2">Langkah 1: Siapkan Data di Google Sheets</h4>
                                <p class="text-sm text-gray-600">Buat spreadsheet baru di Google Sheets dan masukkan data sesuai format yang ditentukan.</p>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-2">Langkah 2: Publish sebagai CSV</h4>
                                <ol class="text-sm text-gray-600 list-decimal list-inside space-y-1">
                                    <li>Klik menu <strong>File</strong>  <strong>Share</strong>  <strong>Publish to web</strong></li>
                                    <li>Pilih sheet yang ingin dipublish</li>
                                    <li>Ubah format ke <strong>Comma-separated values (.csv)</strong></li>
                                    <li>Klik <strong>Publish</strong></li>
                                    <li>Copy link yang muncul</li>
                                </ol>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-2">Langkah 3: Paste URL dan Import</h4>
                                <p class="text-sm text-gray-600">Paste URL yang sudah dicopy ke field di kiri, lalu klik tombol Import.</p>
                            </div>

                            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                                <h4 class="font-semibold text-blue-800 mb-2">Format Header CSV</h4>
                                <div class="text-sm text-blue-700 space-y-2">
                                    <p><strong>Siswa:</strong> nisn, nama, jk, kelas, rombel</p>
                                    <p><strong>Kalender:</strong> jenis, nama, tanggal_mulai, tanggal_selesai</p>
                                    <p><strong>TP:</strong> fase, elemen, nomor_tp, tujuan_pembelajaran, alokasi_jp</p>
                                </div>
                            </div>

                            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                                <h4 class="font-semibold text-yellow-800 mb-2"><i class="fas fa-lightbulb mr-2"></i>Tips</h4>
                                <p class="text-sm text-yellow-700">Gunakan menu AI Assistant untuk membantu memformat data mentah Anda menjadi format CSV yang benar.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function importDataFromCSV(type) {
            const urlInputs = {
                students: 'importStudentsUrl',
                calendar: 'importCalendarUrl',
                tp: 'importTPUrl'
            };
            
            const url = document.getElementById(urlInputs[type]).value.trim();
            
            if (!url) {
                showToast('Masukkan URL CSV', 'warning');
                return;
            }
            
            showLoading(`Mengimpor data ${type}...`);
            
            try {
                const response = await fetch(url);
                const csvText = await response.text();
                
                const lines = csvText.split('\n');
                const headers = lines[0].toLowerCase().split(',').map(h => h.trim().replace(/"/g, ''));
                
                const batch = db.batch();
                let count = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const values = parseCSVLine(lines[i]);
                    if (values.length < headers.length) continue;
                    
                    let docData = {};
                    headers.forEach((header, idx) => {
                        docData[header] = values[idx] || '';
                    });
                    
                    let collectionName = '';
                    switch(type) {
                        case 'students':
                            collectionName = 'students';
                            docData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                            break;
                        case 'calendar':
                            collectionName = 'calendarEvents';
                            break;
                        case 'tp':
                            collectionName = 'customTP';
                            break;
                    }
                    
                    const docRef = db.collection('users').doc(currentUser.uid)
                        .collection(collectionName).doc();
                    batch.set(docRef, docData);
                    count++;
                }
                
                await batch.commit();
                
                showToast(`${count} data berhasil diimpor!`, 'success');
                
            } catch (error) {
                console.error(error);
                showToast('Gagal mengimpor data. Pastikan URL valid.', 'error');
            }
            
            hideLoading();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // ===== GUIDE SECTION =====
        function loadGuide() {
            document.getElementById('pageTitle').textContent = 'Panduan Penggunaan';
            document.getElementById('pageSubtitle').textContent = 'Cara menggunakan Admin Guru Super App';
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <!-- Welcome -->
                    <div class="bg-gradient-to-r from-primary-500 to-purple-600 rounded-2xl p-8 text-white mb-8">
                        <h2 class="text-2xl font-bold mb-2">Selamat Datang di Admin Guru Super App!</h2>
                        <p class="text-white text-opacity-90">Aplikasi ini dirancang untuk membantu guru mengotomatisasi administrasi mengajar dengan konsep <strong>Single Input  Multi Output</strong>.</p>
                    </div>

                    <!-- Quick Start -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-rocket mr-2 text-primary-500"></i>Quick Start
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="text-center p-4 bg-gray-50 rounded-xl">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <span class="text-2xl font-bold text-blue-600">1</span>
                                </div>
                                <h4 class="font-semibold text-gray-800 mb-2">Lengkapi Profil</h4>
                                <p class="text-sm text-gray-600">Isi data diri dan data sekolah di menu Profil</p>
                            </div>
                            <div class="text-center p-4 bg-gray-50 rounded-xl">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <span class="text-2xl font-bold text-green-600">2</span>
                                </div>
                                <h4 class="font-semibold text-gray-800 mb-2">Atur Kalender</h4>
                                <p class="text-sm text-gray-600">Tentukan periode semester, ujian, dan libur</p>
                            </div>
                            <div class="text-center p-4 bg-gray-50 rounded-xl">
                                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <span class="text-2xl font-bold text-purple-600">3</span>
                                </div>
                                <h4 class="font-semibold text-gray-800 mb-2">Input Jadwal</h4>
                                <p class="text-sm text-gray-600">Atur jadwal mengajar per kelas</p>
                            </div>
                        </div>
                    </div>

                    <!-- Features Guide -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-book-open mr-2 text-primary-500"></i>Panduan Fitur
                        </h3>
                        
                        <div class="space-y-4">
                            <!-- Accordion Items -->
                            <div class="border border-gray-200 rounded-xl overflow-hidden">
                                <button onclick="toggleGuideSection('guide-profile')" class="w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100 transition-colors">
                                    <span class="font-medium text-gray-800">Profil & Sekolah</span>
                                    <i class="fas fa-chevron-down text-gray-400"></i>
                                </button>
                                <div id="guide-profile" class="hidden px-4 py-3 text-sm text-gray-600">
                                    <ul class="list-disc list-inside space-y-2">
                                        <li><strong>Data Diri:</strong> Isi nama lengkap dan NIP Anda</li>
                                        <li><strong>Mata Pelajaran:</strong> Tambahkan mata pelajaran yang diampu beserta jumlah JP per minggu</li>
                                        <li><strong>Data Sekolah:</strong> Lengkapi nama sekolah, NPSN, alamat, dan nama kepala sekolah</li>
                                        <li><strong>Kota/Kabupaten:</strong> Digunakan untuk label tanda tangan pada dokumen</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="border border-gray-200 rounded-xl overflow-hidden">
                                <button onclick="toggleGuideSection('guide-calendar')" class="w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100 transition-colors">
                                    <span class="font-medium text-gray-800">Kalender Pendidikan</span>
                                    <i class="fas fa-chevron-down text-gray-400"></i>
                                </button>
                                <div id="guide-calendar" class="hidden px-4 py-3 text-sm text-gray-600">
                                    <ul class="list-disc list-inside space-y-2">
                                        <li><strong>Periode Semester:</strong> Atur tanggal awal dan akhir semester</li>
                                        <li><strong>Kegiatan Pembelajaran:</strong> Tentukan periode efektif belajar mengajar</li>
                                        <li><strong>Pekan Ujian:</strong> Tambahkan PTS, PAS/PAT dan ujian lainnya</li>
                                        <li><strong>Libur:</strong> Input periode libur (hari besar, semester, dll)</li>
                                        <li>Kalender akan otomatis menghitung minggu efektif untuk Prota dan Promes</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="border border-gray-200 rounded-xl overflow-hidden">
                                <button onclick="toggleGuideSection('guide-schedule')" class="w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100 transition-colors">
                                    <span class="font-medium text-gray-800">Jadwal Pelajaran</span>
                                    <i class="fas fa-chevron-down text-gray-400"></i>
                                </button>
                                <div id="guide-schedule" class="hidden px-4 py-3 text-sm text-gray-600">
                                    <ul class="list-disc list-inside space-y-2">
                                        <li><strong>Konfigurasi Jam:</strong> Atur waktu mulai dan selesai tiap jam pelajaran</li>
                                        <li><strong>Durasi Default:</strong> SD = 35 menit, SMP/SMA = 45 menit</li>
                                        <li><strong>Tambah Jadwal:</strong> Pilih hari, jam ke, durasi (JP), kelas, dan rombel</li>
                                        <li><strong>Validasi Bentrok:</strong> Sistem otomatis mengecek jadwal yang bentrok</li>
                                        <li>Jadwal akan tersinkron dengan Promes dan Jurnal</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="border border-gray-200 rounded-xl overflow-hidden">
                                <button onclick="toggleGuideSection('guide-documents')" class="w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100 transition-colors">
                                    <span class="font-medium text-gray-800">Dokumen (ATP, Prota, Promes)</span>
                                    <i class="fas fa-chevron-down text-gray-400"></i>
                                </button>
                                <div id="guide-documents" class="hidden px-4 py-3 text-sm text-gray-600">
                                    <ul class="list-disc list-inside space-y-2">
                                        <li><strong>CP & TP:</strong> Untuk PAI sudah tersedia data default sesuai Kepka BSKAP</li>
                                        <li><strong>ATP:</strong> Alur Tujuan Pembelajaran - disusun dari TP dengan alokasi JP</li>
                                        <li><strong>Prota:</strong> Program Tahunan - otomatis dari ATP dan Kalender</li>
                                        <li><strong>Promes:</strong> Program Semester - detail dengan minggu dan tanggal pelaksanaan</li>
                                        <li>Semua dokumen dapat dicetak dengan format standar</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="border border-gray-200 rounded-xl overflow-hidden">
                                <button onclick="toggleGuideSection('guide-academic')" class="w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100 transition-colors">
                                    <span class="font-medium text-gray-800">Akademik (Absensi, Jurnal, Nilai)</span>
                                    <i class="fas fa-chevron-down text-gray-400"></i>
                                </button>
                                <div id="guide-academic" class="hidden px-4 py-3 text-sm text-gray-600">
                                    <ul class="list-disc list-inside space-y-2">
                                        <li><strong>Absensi:</strong> Input kehadiran siswa per tanggal, otomatis masuk ke jurnal</li>
                                        <li><strong>Jurnal:</strong> Catatan pembelajaran harian, TP terisi dari Promes</li>
                                        <li><strong>Daftar Nilai:</strong> Input PH, PTS, PAS dengan kalkulasi otomatis</li>
                                        <li>Semua dokumen dilengkapi tanda tangan guru dan kepala sekolah</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="border border-gray-200 rounded-xl overflow-hidden">
                                <button onclick="toggleGuideSection('guide-import')" class="w-full px-4 py-3 bg-gray-50 flex items-center justify-between hover:bg-gray-100 transition-colors">
                                    <span class="font-medium text-gray-800">Import Data & AI Assistant</span>
                                    <i class="fas fa-chevron-down text-gray-400"></i>
                                </button>
                                <div id="guide-import" class="hidden px-4 py-3 text-sm text-gray-600">
                                    <ul class="list-disc list-inside space-y-2">
                                        <li><strong>Import CSV:</strong> Import data siswa, kalender dari Google Spreadsheet</li>
                                        <li><strong>AI Assistant:</strong> Generate prompt untuk memformat data dengan AI</li>
                                        <li><strong>Cara Publish CSV:</strong> Google Sheets  File  Share  Publish to web  CSV</li>
                                        <li>Format header harus sesuai dengan ketentuan aplikasi</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- FAQ -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-question-circle mr-2 text-primary-500"></i>FAQ
                        </h3>
                        
                        <div class="space-y-4">
                            <div class="p-4 bg-gray-50 rounded-xl">
                                <h4 class="font-semibold text-gray-800 mb-2">Apa perbedaan Free dan Premium?</h4>
                                <p class="text-sm text-gray-600">Free: Kalender, Jadwal, ATP, Prota. Premium: Semua fitur + Modul Ajar, LKPD, Bank Soal, Export dokumen.</p>
                            </div>
                            <div class="p-4 bg-gray-50 rounded-xl">
                                <h4 class="font-semibold text-gray-800 mb-2">Bagaimana cara upgrade ke Premium?</h4>
                                <p class="text-sm text-gray-600">Klik menu Upgrade di sidebar atau hubungi admin via WhatsApp.</p>
                            </div>
                            <div class="p-4 bg-gray-50 rounded-xl">
                                <h4 class="font-semibold text-gray-800 mb-2">Apakah data saya aman?</h4>
                                <p class="text-sm text-gray-600">Ya, data disimpan di Firebase dengan enkripsi dan hanya dapat diakses oleh akun Anda.</p>
                            </div>
                            <div class="p-4 bg-gray-50 rounded-xl">
                                <h4 class="font-semibold text-gray-800 mb-2">Bagaimana jika lupa password?</h4>
                                <p class="text-sm text-gray-600">Gunakan fitur "Lupa Password" di halaman login untuk reset via email.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Contact -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-headset mr-2 text-primary-500"></i>Butuh Bantuan?
                        </h3>
                        <p class="text-gray-600 mb-4">Jika Anda mengalami kendala atau memiliki pertanyaan, silakan hubungi kami:</p>
                        <a href="https://wa.me/${whatsappAdmin}" target="_blank" 
                           class="inline-flex items-center space-x-2 px-6 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all">
                            <i class="fab fa-whatsapp text-xl"></i>
                            <span>Chat via WhatsApp</span>
                        </a>
                    </div>
                </div>
            `;
        }

        function toggleGuideSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('hidden');
        }

        // ===== PRINT FUNCTIONS =====
        function printATP() {
            window.print();
        }

        function printProta() {
            window.print();
        }

        function printPromes() {
            window.print();
        }

        function printJournal() {
            window.print();
        }

        // ===== USER DISPLAY UPDATE =====
        function updateUserDisplay() {
            if (!currentUser || !userData) return;
            
            // Update sidebar
            document.getElementById('userName').textContent = userData.displayName || currentUser.displayName || 'User';
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userAvatar').src = currentUser.photoURL || 
                `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.displayName || 'User')}&background=ffffff&color=3b82f6`;
            
            // Update subscription badge
            const subBadge = document.getElementById('subscriptionBadge');
            if (userData.subscription === 'premium') {
                subBadge.innerHTML = '<i class="fas fa-crown mr-1"></i>Premium';
                subBadge.className = 'px-2 py-1 bg-yellow-400 text-yellow-900 rounded-full text-xs font-medium';
                document.getElementById('upgradeBanner').classList.add('hidden');
            } else {
                subBadge.textContent = 'Free';
                document.getElementById('upgradeBanner').classList.remove('hidden');
            }
            
            // Update academic year
            document.getElementById('academicYearBadge').textContent = userData.academicYear || getCurrentAcademicYear();
            
            // Update header
            document.getElementById('headerUserAvatar').src = currentUser.photoURL || 
                `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.displayName || 'User')}&background=3b82f6&color=fff`;
        }

        // ===== LOGOUT =====
        async function logout() {
            if (confirm('Yakin ingin keluar?')) {
                showLoading('Keluar...');
                try {
                    await auth.signOut();
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error(error);
                    showToast('Gagal keluar', 'error');
                }
                hideLoading();
            }
        }

        // ===== AUTH STATE LISTENER =====
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                
                // Load user data
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        userData = userDoc.data();
                        
                        // Get WhatsApp admin number
                        if (userData.settings?.whatsappAdmin) {
                            whatsappAdmin = userData.settings.whatsappAdmin;
                        }
                        
                        // Update last login
                        await db.collection('users').doc(user.uid).update({
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } else {
                        // Create user document if not exists
                        const academicYear = getCurrentAcademicYear();
                        userData = {
                            uid: user.uid,
                            email: user.email,
                            displayName: user.displayName,
                            photoURL: user.photoURL,
                            subscription: 'free',
                            academicYear: academicYear,
                            profile: {
                                nip: '',
                                subjects: [],
                                school: {}
                            }
                        };
                        await db.collection('users').doc(user.uid).set({
                            ...userData,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    updateUserDisplay();
                    populateAcademicYearSelect();
                    loadSection('dashboard');
                    
                } catch (error) {
                    console.error('Error loading user data:', error);
                    showToast('Gagal memuat data pengguna', 'error');
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            const userMenu = document.getElementById('userMenu');
            if (!e.target.closest('#userMenu') && !e.target.closest('[onclick="toggleUserMenu()"]')) {
                userMenu.classList.add('hidden');
            }
        });
    </script>
</body>

</html>
