<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Guru Super App - SaaS Kolaboratif</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“š</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' },
                        accent: { 500: '#10b981', 600: '#059669' }
                    }
                }
            }
        }
    </script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; }
        .gradient-hero { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #06b6d4 100%); }
        .gradient-card { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); }
        .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .page-transition { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-custom { animation: pulse 2s infinite; }
        .paper-preview { background: white; margin: 20px auto; padding: 15mm; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 210mm; min-height: 297mm; }
        .paper-preview.landscape { max-width: 297mm; min-height: 210mm; }
        .doc-table { width: 100%; border-collapse: collapse; font-size: 10pt; }
        .doc-table th, .doc-table td { border: 1px solid #374151; padding: 6px; text-align: left; vertical-align: top; }
        .doc-table th { background: #f1f5f9; font-weight: 600; text-align: center; }
        [contenteditable="true"]:hover { background: #fef9c3; outline: 1px dashed #eab308; }
        .signature-area { display: flex; justify-content: space-between; margin-top: 30px; padding: 0 5%; }
        .signature-box { text-align: center; font-size: 11pt; min-width: 200px; }
        .signature-name { text-decoration: underline; font-weight: bold; margin-top: 70px; }
        .event-cell { vertical-align: middle !important; text-align: center !important; background: #fca5a5 !important; padding: 2px !important; }
        .vertical-text { writing-mode: vertical-rl; transform: rotate(180deg); font-size: 7pt; font-weight: bold; }
        .csv-info { padding: 8px; background: #059669; border-radius: 6px; font-size: 0.75rem; color: white; margin-top: 8px; }
        .csv-info.error { background: #dc2626; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; padding: 1rem; }
        .modal-content { background: white; width: 100%; max-width: 700px; border-radius: 12px; padding: 24px; max-height: 90vh; overflow-y: auto; }
        .btn-primary { @apply bg-primary-600 hover:bg-primary-700 text-white font-semibold py-2 px-4 rounded-lg transition shadow; }
        .btn-secondary { @apply bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg transition shadow; }
        .input-field { @apply w-full bg-white border border-slate-300 rounded-lg p-3 focus:border-primary-500 focus:ring-2 focus:ring-primary-200 outline-none transition; }
        .nav-item { @apply flex items-center gap-3 px-4 py-3 rounded-lg transition cursor-pointer; }
        .nav-item:hover { @apply bg-slate-700; }
        .nav-item.active { @apply bg-primary-600 text-white; }
        .card { @apply bg-white rounded-xl shadow-lg p-6 border border-slate-100; }
        .badge-pro { @apply bg-gradient-to-r from-amber-500 to-orange-500 text-white text-xs px-2 py-0.5 rounded-full font-bold; }
        .badge-free { @apply bg-accent-500 text-white text-xs px-2 py-0.5 rounded-full font-bold; }
        @media print {
            body { background: white; }
            #app-sidebar, #app-header, .no-print { display: none !important; }
            .paper-preview { margin: 0; padding: 10mm; box-shadow: none; page-break-after: always; }
            @page { size: A4; margin: 10mm; }
            @page landscape { size: A4 landscape; }
        }
        @media (max-width: 768px) {
            .paper-preview { padding: 5mm; font-size: 9pt; }
            .paper-preview.landscape { max-width: 100%; }
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

<!-- ==================== LANDING PAGE ==================== -->
<div id="landing-page" class="min-h-screen">
    <!-- Navbar -->
    <nav class="fixed top-0 left-0 right-0 z-50 glass border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">ğŸ“š</span>
                    <span class="font-bold text-xl text-slate-800">Admin Guru</span>
                    <span class="badge-pro hidden sm:inline">SUPER APP</span>
                </div>
                <div class="flex items-center gap-4">
                    <a href="#fitur" class="text-slate-600 hover:text-primary-600 hidden sm:block">Fitur</a>
                    <a href="#pricing" class="text-slate-600 hover:text-primary-600 hidden sm:block">Harga</a>
                    <button onclick="AuthSystem.showLoginModal()" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                        Masuk
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="gradient-hero min-h-screen flex items-center pt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20">
            <div class="grid lg:grid-cols-2 gap-12 items-center">
                <div class="text-white">
                    <span class="inline-block bg-white/20 px-4 py-2 rounded-full text-sm font-medium mb-6">
                        ğŸš€ Platform #1 Administrasi Guru Indonesia
                    </span>
                    <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold leading-tight mb-6">
                        Otomatisasi<br>
                        <span class="text-cyan-300">Administrasi Guru</span><br>
                        Dalam Hitungan Detik
                    </h1>
                    <p class="text-xl text-blue-100 mb-8 leading-relaxed">
                        Generate ATP, Prota, Promes, Modul Ajar, LKPD, Jurnal, Absensi, KKTP, Bank Soal 
                        secara otomatis berbasis Kurikulum Merdeka dengan AI Assistant.
                    </p>
                    <div class="flex flex-wrap gap-4">
                        <button onclick="AuthSystem.showLoginModal()" class="bg-white text-primary-700 px-8 py-4 rounded-xl font-bold text-lg hover:bg-slate-100 transition shadow-xl">
                            ğŸ¯ Mulai Gratis Sekarang
                        </button>
                        <a href="#fitur" class="border-2 border-white/50 text-white px-8 py-4 rounded-xl font-bold text-lg hover:bg-white/10 transition">
                            Pelajari Fitur â†’
                        </a>
                    </div>
                    <div class="mt-8 flex items-center gap-6 text-sm text-blue-200">
                        <span>âœ“ Gratis Selamanya</span>
                        <span>âœ“ Tanpa Kartu Kredit</span>
                        <span>âœ“ Setup 2 Menit</span>
                    </div>
                </div>
                <div class="hidden lg:block">
                    <div class="bg-white/10 rounded-2xl p-8 backdrop-blur-sm border border-white/20">
                        <div class="bg-white rounded-xl p-6 shadow-2xl">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-3 h-3 rounded-full bg-red-400"></div>
                                <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                                <div class="w-3 h-3 rounded-full bg-green-400"></div>
                            </div>
                            <div class="space-y-3">
                                <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                                <div class="h-4 bg-primary-200 rounded w-1/2"></div>
                                <div class="h-20 bg-slate-100 rounded mt-4"></div>
                                <div class="grid grid-cols-3 gap-2 mt-4">
                                    <div class="h-8 bg-accent-100 rounded"></div>
                                    <div class="h-8 bg-primary-100 rounded"></div>
                                    <div class="h-8 bg-amber-100 rounded"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section id="fitur" class="py-20 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <h2 class="text-3xl sm:text-4xl font-bold text-slate-800 mb-4">Fitur Lengkap untuk Guru Modern</h2>
                <p class="text-xl text-slate-600 max-w-3xl mx-auto">Semua yang Anda butuhkan untuk mengelola administrasi pembelajaran dalam satu platform terintegrasi.</p>
            </div>
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card hover:shadow-xl transition group">
                    <div class="w-12 h-12 bg-primary-100 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition">ğŸ“‹</div>
                    <h3 class="font-bold text-lg mb-2">ATP & Prota</h3>
                    <p class="text-slate-600 text-sm">Generate otomatis berdasarkan CP Kurikulum Merdeka</p>
                    <span class="badge-free mt-3 inline-block">GRATIS</span>
                </div>
                <div class="card hover:shadow-xl transition group">
                    <div class="w-12 h-12 bg-accent-100 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition">ğŸ“…</div>
                    <h3 class="font-bold text-lg mb-2">Kalender Pendidikan</h3>
                    <p class="text-slate-600 text-sm">Kelola jadwal & libur nasional otomatis</p>
                    <span class="badge-free mt-3 inline-block">GRATIS</span>
                </div>
                <div class="card hover:shadow-xl transition group">
                    <div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition">ğŸ“–</div>
                    <h3 class="font-bold text-lg mb-2">Modul Ajar</h3>
                    <p class="text-slate-600 text-sm">Langkah KBM detail siap cetak</p>
                    <span class="badge-pro mt-3 inline-block">PRO</span>
                </div>
                <div class="card hover:shadow-xl transition group">
                    <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition">ğŸ¯</div>
                    <h3 class="font-bold text-lg mb-2">Bank Soal AI</h3>
                    <p class="text-slate-600 text-sm">Generate soal berbasis TP dengan AI</p>
                    <span class="badge-pro mt-3 inline-block">PRO</span>
                </div>
                <div class="card hover:shadow-xl transition group">
                    <div class="w-12 h-12 bg-rose-100 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition">ğŸ“Š</div>
                    <h3 class="font-bold text-lg mb-2">KKTP & Nilai</h3>
                    <p class="text-slate-600 text-sm">Kriteria ketercapaian & rekapitulasi nilai</p>
                    <span class="badge-pro mt-3 inline-block">PRO</span>
                </div>
                <div class="card hover:shadow-xl transition group">
                    <div class="w-12 h-12 bg-cyan-100 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition">ğŸ“</div>
                    <h3 class="font-bold text-lg mb-2">Jurnal & Absensi</h3>
                    <p class="text-slate-600 text-sm">Dokumentasi pembelajaran harian</p>
                    <span class="badge-pro mt-3 inline-block">PRO</span>
                </div>
                <div class="card hover:shadow-xl transition group">
                    <div class="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition">ğŸ«</div>
                    <h3 class="font-bold text-lg mb-2">Kolaborasi Sekolah</h3>
                    <p class="text-slate-600 text-sm">Multi-guru dalam satu NPSN</p>
                    <span class="badge-pro mt-3 inline-block">PRO</span>
                </div>
                <div class="card hover:shadow-xl transition group">
                    <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition">ğŸ¤–</div>
                    <h3 class="font-bold text-lg mb-2">AI Assistant</h3>
                    <p class="text-slate-600 text-sm">Prompt generator & panduan cerdas</p>
                    <span class="badge-pro mt-3 inline-block">PRO</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Pricing Section -->
    <section id="pricing" class="py-20 bg-slate-50">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <h2 class="text-3xl sm:text-4xl font-bold text-slate-800 mb-4">Pilih Paket Anda</h2>
                <p class="text-xl text-slate-600">Mulai gratis, upgrade kapan saja</p>
            </div>
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Free Plan -->
                <div class="bg-white rounded-2xl p-8 border-2 border-slate-200 hover:border-primary-300 transition">
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold text-slate-800">Gratis</h3>
                        <p class="text-slate-500">Untuk memulai</p>
                    </div>
                    <div class="mb-6">
                        <span class="text-5xl font-extrabold text-slate-800">Rp 0</span>
                        <span class="text-slate-500">/selamanya</span>
                    </div>
                    <ul class="space-y-3 mb-8">
                        <li class="flex items-center gap-2"><span class="text-accent-500">âœ“</span> Kalender Pendidikan</li>
                        <li class="flex items-center gap-2"><span class="text-accent-500">âœ“</span> Jadwal Pelajaran</li>
                        <li class="flex items-center gap-2"><span class="text-accent-500">âœ“</span> ATP (Alur Tujuan Pembelajaran)</li>
                        <li class="flex items-center gap-2"><span class="text-accent-500">âœ“</span> Prota (Program Tahunan)</li>
                        <li class="flex items-center gap-2 text-slate-400"><span>âœ—</span> Promes</li>
                        <li class="flex items-center gap-2 text-slate-400"><span>âœ—</span> Modul Ajar & LKPD</li>
                    </ul>
                    <button onclick="AuthSystem.showLoginModal()" class="w-full py-3 border-2 border-primary-600 text-primary-600 font-bold rounded-xl hover:bg-primary-50 transition">
                        Mulai Gratis
                    </button>
                </div>
                <!-- Pro Plan -->
                <div class="bg-gradient-to-br from-primary-600 to-primary-800 rounded-2xl p-8 text-white relative overflow-hidden">
                    <div class="absolute top-4 right-4 bg-amber-400 text-amber-900 px-3 py-1 rounded-full text-xs font-bold">
                        POPULER
                    </div>
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold">Pro</h3>
                        <p class="text-blue-200">Fitur lengkap</p>
                    </div>
                    <div class="mb-6">
                        <span class="text-5xl font-extrabold">Rp 99K</span>
                        <span class="text-blue-200">/tahun</span>
                    </div>
                    <ul class="space-y-3 mb-8">
                        <li class="flex items-center gap-2"><span class="text-cyan-300">âœ“</span> Semua fitur Gratis</li>
                        <li class="flex items-center gap-2"><span class="text-cyan-300">âœ“</span> Promes (Landscape A4/F4)</li>
                        <li class="flex items-center gap-2"><span class="text-cyan-300">âœ“</span> Modul Ajar & LKPD</li>
                        <li class="flex items-center gap-2"><span class="text-cyan-300">âœ“</span> Jurnal & Absensi</li>
                        <li class="flex items-center gap-2"><span class="text-cyan-300">âœ“</span> KKTP & Nilai</li>
                        <li class="flex items-center gap-2"><span class="text-cyan-300">âœ“</span> Bank Soal dengan AI</li>
                        <li class="flex items-center gap-2"><span class="text-cyan-300">âœ“</span> Kolaborasi Sekolah</li>
                    </ul>
                    <button onclick="SubscriptionSystem.showUpgradeModal()" class="w-full py-3 bg-white text-primary-700 font-bold rounded-xl hover:bg-slate-100 transition">
                        Upgrade Sekarang
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-400 py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <div class="flex items-center justify-center gap-2 mb-4">
                <span class="text-2xl">ğŸ“š</span>
                <span class="font-bold text-xl text-white">Admin Guru Super App</span>
            </div>
            <p class="mb-4">Platform Administrasi Guru Berbasis AI untuk Kurikulum Merdeka</p>
            <p class="text-sm">Â© 2025 Admin Guru Super App. All rights reserved.</p>
        </div>
    </footer>
</div>

<!-- ==================== MAIN APP ==================== -->
<div id="main-app" class="hidden">
    <!-- Mobile Header -->
    <header id="app-header" class="lg:hidden fixed top-0 left-0 right-0 z-40 bg-white border-b border-slate-200 h-16 flex items-center justify-between px-4">
        <button onclick="UISystem.toggleSidebar()" class="p-2 hover:bg-slate-100 rounded-lg">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
        <span class="font-bold text-slate-800">Admin Guru</span>
        <button onclick="UISystem.showAIAssistant()" class="p-2 hover:bg-slate-100 rounded-lg text-primary-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
        </button>
    </header>

    <!-- Sidebar -->
    <aside id="app-sidebar" class="fixed left-0 top-0 bottom-0 w-72 bg-slate-900 text-slate-300 z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col">
        <div class="p-5 border-b border-slate-700 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="text-2xl">ğŸ“š</span>
                <span class="font-bold text-white">Admin Guru</span>
            </div>
            <span id="user-badge" class="badge-free">FREE</span>
        </div>
        
        <div class="flex-1 overflow-y-auto sidebar-scroll p-4">
            <nav class="space-y-1">
                <div onclick="UISystem.navigateTo('dashboard')" class="nav-item active" data-page="dashboard">
                    <span>ğŸ“Š</span><span>Dashboard</span>
                </div>
                <div onclick="UISystem.navigateTo('profil-guru')" class="nav-item" data-page="profil-guru">
                    <span>ğŸ‘¤</span><span>Profil Guru</span>
                </div>
                <div onclick="UISystem.navigateTo('profil-sekolah')" class="nav-item" data-page="profil-sekolah">
                    <span>ğŸ«</span><span>Profil Sekolah</span>
                </div>
                <div onclick="UISystem.navigateTo('data-siswa')" class="nav-item" data-page="data-siswa">
                    <span>ğŸ‘¥</span><span>Data Siswa</span>
                </div>
                <div onclick="UISystem.navigateTo('kurikulum')" class="nav-item" data-page="kurikulum">
                    <span>ğŸ“š</span><span>Kurikulum & Mapel</span>
                </div>
                <div onclick="UISystem.navigateTo('kalender')" class="nav-item" data-page="kalender">
                    <span>ğŸ“…</span><span>Kalender</span>
                    <span class="badge-free ml-auto text-[10px]">FREE</span>
                </div>
                
                <div class="pt-4 pb-2">
                    <span class="text-xs text-slate-500 uppercase font-bold">Generate Dokumen</span>
                </div>
                
                <div onclick="UISystem.navigateTo('doc-atp')" class="nav-item" data-page="doc-atp">
                    <span>ğŸ“‹</span><span>ATP & Prota</span>
                    <span class="badge-free ml-auto text-[10px]">FREE</span>
                </div>
                <div onclick="UISystem.navigateTo('doc-promes')" class="nav-item" data-page="doc-promes">
                    <span>ğŸ“†</span><span>Promes</span>
                    <span class="badge-pro ml-auto text-[10px]">PRO</span>
                </div>
                <div onclick="UISystem.navigateTo('doc-modul')" class="nav-item" data-page="doc-modul">
                    <span>ğŸ“–</span><span>Modul & LKPD</span>
                    <span class="badge-pro ml-auto text-[10px]">PRO</span>
                </div>
                <div onclick="UISystem.navigateTo('doc-jurnal')" class="nav-item" data-page="doc-jurnal">
                    <span>ğŸ“</span><span>Jurnal</span>
                    <span class="badge-pro ml-auto text-[10px]">PRO</span>
                </div>
                <div onclick="UISystem.navigateTo('doc-absensi')" class="nav-item" data-page="doc-absensi">
                    <span>âœ…</span><span>Absensi</span>
                    <span class="badge-pro ml-auto text-[10px]">PRO</span>
                </div>
                <div onclick="UISystem.navigateTo('doc-kktp')" class="nav-item" data-page="doc-kktp">
                    <span>ğŸ¯</span><span>KKTP & Nilai</span>
                    <span class="badge-pro ml-auto text-[10px]">PRO</span>
                </div>
                <div onclick="UISystem.navigateTo('bank-soal')" class="nav-item" data-page="bank-soal">
                    <span>â“</span><span>Bank Soal</span>
                    <span class="badge-pro ml-auto text-[10px]">PRO</span>
                </div>
                
                <div class="pt-4 pb-2">
                    <span class="text-xs text-slate-500 uppercase font-bold">Pengaturan</span>
                </div>
                
                <div onclick="UISystem.navigateTo('subscription')" class="nav-item" data-page="subscription">
                    <span>ğŸ’</span><span>Subscription</span>
                </div>
                <div id="nav-superadmin" onclick="UISystem.navigateTo('super-admin')" class="nav-item hidden" data-page="super-admin">
                    <span>ğŸ‘‘</span><span>Super Admin</span>
                </div>
            </nav>
        </div>
        
        <div class="p-4 border-t border-slate-700">
            <button onclick="UISystem.showAIAssistant()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2 hover:opacity-90 transition mb-3">
                <span>ğŸ¤–</span> AI Assistant
            </button>
            <div class="flex items-center gap-3 p-2 bg-slate-800 rounded-lg">
                <div class="w-10 h-10 bg-primary-600 rounded-full flex items-center justify-center text-white font-bold" id="user-avatar">U</div>
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium text-white truncate" id="user-name">User</div>
                    <div class="text-xs text-slate-400 truncate" id="user-email">user@email.com</div>
                </div>
                <button onclick="AuthSystem.logout()" class="p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white" title="Logout">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                </button>
            </div>
        </div>
    </aside>

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden" onclick="UISystem.toggleSidebar()"></div>

    <!-- Main Content Area -->
    <main class="lg:ml-72 pt-16 lg:pt-0 min-h-screen">
        <div id="page-container" class="p-4 lg:p-8">
            <!-- Pages will be injected here -->
        </div>
    </main>
</div>

<!-- ==================== MODALS ==================== -->

<!-- Login Modal -->
<div id="modal-login" class="modal-overlay">
    <div class="modal-content max-w-md">
        <h2 class="text-2xl font-bold text-slate-800 mb-2">Masuk ke Admin Guru</h2>
        <p class="text-slate-600 mb-6">Gunakan akun Google untuk masuk atau daftar</p>
        
        <button onclick="AuthSystem.loginWithGoogle()" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-slate-200 hover:border-primary-500 py-3 px-4 rounded-xl font-semibold transition mb-4">
            <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Masuk dengan Google
        </button>
        
        <p class="text-center text-xs text-slate-500">
            Hanya email @gmail.com yang diizinkan mendaftar
        </p>
        
        <button onclick="UISystem.closeModal('modal-login')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
    </div>
</div>

<!-- Upgrade Modal -->
<div id="modal-upgrade" class="modal-overlay">
    <div class="modal-content max-w-md text-center">
        <div class="w-20 h-20 bg-gradient-to-r from-amber-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4">
            <span class="text-4xl">ğŸ‘‘</span>
        </div>
        <h2 class="text-2xl font-bold text-slate-800 mb-2">Fitur PRO</h2>
        <p class="text-slate-600 mb-6">Fitur ini tersedia pada versi PRO. Upgrade sekarang untuk akses penuh ke semua fitur!</p>
        
        <a id="btn-wa-upgrade" href="#" target="_blank" class="block w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition mb-3">
            ğŸ’¬ Hubungi WhatsApp
        </a>
        
        <button onclick="UISystem.closeModal('modal-upgrade')" class="text-slate-500 hover:text-slate-700">
            Nanti saja
        </button>
    </div>
</div>

<!-- AI Assistant Modal -->
<div id="modal-ai" class="modal-overlay">
    <div class="modal-content max-w-2xl">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-full flex items-center justify-center">
                    <span class="text-xl">ğŸ¤–</span>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-slate-800">AI Assistant</h2>
                    <p class="text-sm text-slate-500">Panduan & Generator Prompt</p>
                </div>
            </div>
            <button onclick="UISystem.closeModal('modal-ai')" class="text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        
        <div class="mb-4">
            <div class="flex border-b border-slate-200">
                <button onclick="AISystem.switchTab('guide')" class="ai-tab px-4 py-2 font-semibold text-primary-600 border-b-2 border-primary-600" data-tab="guide">ğŸ“– Panduan</button>
                <button onclick="AISystem.switchTab('prompt')" class="ai-tab px-4 py-2 font-semibold text-slate-500" data-tab="prompt">âœ¨ Generator Prompt</button>
            </div>
        </div>
        
        <!-- Guide Tab -->
        <div id="ai-tab-guide" class="ai-tab-content">
            <div class="space-y-4 max-h-96 overflow-y-auto">
                <div class="p-4 bg-blue-50 rounded-xl">
                    <h4 class="font-bold text-blue-800 mb-2">ğŸš€ Cara Memulai</h4>
                    <ol class="list-decimal pl-5 text-sm text-blue-700 space-y-1">
                        <li>Lengkapi Profil Guru dan Profil Sekolah</li>
                        <li>Input data siswa dengan format: nama;L/P;kelas</li>
                        <li>Pilih jenjang dan muat data kurikulum</li>
                        <li>Pilih mapel, kelas, dan semester</li>
                        <li>Generate dokumen yang dibutuhkan</li>
                    </ol>
                </div>
                <div class="p-4 bg-amber-50 rounded-xl">
                    <h4 class="font-bold text-amber-800 mb-2">ğŸ“… Menggunakan Kalender</h4>
                    <p class="text-sm text-amber-700">Kalender otomatis menghitung hari efektif berdasarkan libur nasional dan agenda kustom. Tambahkan libur dengan format: YYYY-MM-DD = Keterangan</p>
                </div>
                <div class="p-4 bg-green-50 rounded-xl">
                    <h4 class="font-bold text-green-800 mb-2">ğŸ“‹ Tips Promes</h4>
                    <p class="text-sm text-green-700">Promes akan otomatis menandai tanggal mengajar berdasarkan hari mengajar yang dipilih dan menghindari tanggal libur.</p>
                </div>
                <div class="p-4 bg-purple-50 rounded-xl">
                    <h4 class="font-bold text-purple-800 mb-2">â“ Bank Soal</h4>
                    <p class="text-sm text-purple-700">Gunakan Generator Prompt untuk membuat soal dengan AI. Copy prompt, paste ke ChatGPT/Claude, lalu paste hasilnya dalam format CSV.</p>
                </div>
            </div>
        </div>
        
        <!-- Prompt Generator Tab -->
        <div id="ai-tab-prompt" class="ai-tab-content hidden">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1">Jenis Dokumen</label>
                        <select id="prompt-type" class="input-field" onchange="AISystem.updatePrompt()">
                            <option value="soal-pg">Soal Pilihan Ganda</option>
                            <option value="soal-essay">Soal Essay</option>
                            <option value="soal-campuran">Soal Campuran</option>
                            <option value="materi">Ringkasan Materi</option>
                            <option value="lkpd">Instruksi LKPD</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Jumlah</label>
                        <input type="number" id="prompt-count" class="input-field" value="10" min="1" max="50" onchange="AISystem.updatePrompt()">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold mb-1">Tujuan Pembelajaran (TP)</label>
                    <select id="prompt-tp" class="input-field" onchange="AISystem.updatePrompt()">
                        <option value="">-- Pilih TP dari kurikulum --</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold mb-1">Prompt yang Dihasilkan</label>
                    <textarea id="prompt-result" class="input-field h-40 text-sm" readonly></textarea>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="AISystem.copyPrompt()" class="flex-1 bg-primary-600 hover:bg-primary-700 text-white py-2 rounded-lg font-semibold transition">
                        ğŸ“‹ Copy Prompt
                    </button>
                    <button onclick="AISystem.openChatGPT()" class="flex-1 bg-slate-700 hover:bg-slate-800 text-white py-2 rounded-lg font-semibold transition">
                        ğŸš€ Buka ChatGPT
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-white z-[9999] flex items-center justify-center hidden">
    <div class="text-center">
        <div class="w-16 h-16 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-slate-600 font-medium" id="loading-text">Memuat...</p>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-4 right-4 z-[9999] hidden">
    <div class="bg-slate-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3">
        <span id="toast-icon">âœ“</span>
        <span id="toast-message">Berhasil</span>
    </div>
</div>

<script>
// ==================== FIREBASE CONFIG ====================
const firebaseConfig = {
    apiKey: "AIzaSyDe4ie2wSPEpNbAgWP-q03vTuHyxc9Jj3E",
    authDomain: "agsa-e5b08.firebaseapp.com",
    projectId: "agsa-e5b08",
    storageBucket: "agsa-e5b08.firebasestorage.app",
    messagingSenderId: "916052746331",
    appId: "1:916052746331:web:357cbadbfd8658f1689f7e"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ==================== CONSTANTS ====================
const CP_LINKS = {
    "SD": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1925091593&single=true&output=csv",
    "SMP": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1962203786&single=true&output=csv",
    "SMA": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=260922290&single=true&output=csv"
};

const BULAN_IND = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
const HARI_IND = ["Minggu","Senin","Selasa","Rabu","Kamis","Jum'at","Sabtu"];
const SUPER_ADMIN_EMAIL = "afifaro@gmail.com";

const DEFAULT_HOLIDAYS = `2025-08-17 = HUT Kemerdekaan RI
2025-09-05 = Maulid Nabi Muhammad SAW
2025-12-25 = Hari Raya Natal
2026-01-01 = Tahun Baru Masehi
2026-01-16 = Isra Mikraj Nabi Muhammad
2026-03-19 = Hari Raya Nyepi
2026-03-20 = Cuti Bersama Idul Fitri
2026-03-21 = Hari Raya Idul Fitri 1447 H
2026-04-03 = Wafat Isa Almasih
2026-05-01 = Hari Buruh Internasional
2026-05-14 = Kenaikan Yesus Kristus
2026-05-27 = Hari Raya Idul Adha 1447 H
2026-06-01 = Hari Lahir Pancasila`;

// ==================== STATE ====================
const AppState = {
    currentUser: null,
    userProfile: null,
    schoolProfile: null,
    students: [],
    curriculum: {},
    faseMap: {},
    calendarEvents: {},
    eventList: [],
    selectedMapel: '',
    selectedKelas: '',
    selectedSemester: '',
    selectedElemen: '',
    isPro: false,
    isAdmin: false,
    isSuperAdmin: false,
    settings: { waNumber: '6281234567890' }
};

// ==================== AUTH SYSTEM ====================
const AuthSystem = {
    init() {
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                if (!user.email.endsWith('@gmail.com')) {
                    UISystem.showToast('Hanya email Gmail yang diizinkan', 'error');
                    await auth.signOut();
                    return;
                }
                AppState.currentUser = user;
                AppState.isSuperAdmin = user.email === SUPER_ADMIN_EMAIL;
                await this.loadUserProfile();
                UISystem.showApp();
            } else {
                AppState.currentUser = null;
                UISystem.showLanding();
            }
        });
    },

    async loginWithGoogle() {
        try {
            UISystem.showLoading('Memproses login...');
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ hd: 'gmail.com' });
            await auth.signInWithPopup(provider);
            UISystem.closeModal('modal-login');
        } catch (error) {
            console.error('Login error:', error);
            UISystem.showToast('Gagal login: ' + error.message, 'error');
        } finally {
            UISystem.hideLoading();
        }
    },

    async loadUserProfile() {
        try {
            const doc = await db.collection('users').doc(AppState.currentUser.uid).get();
            if (doc.exists) {
                AppState.userProfile = doc.data();
            } else {
                // Create new user profile
                AppState.userProfile = {
                    email: AppState.currentUser.email,
                    name: AppState.currentUser.displayName || '',
                    nip: '',
                    tipeGuru: 'mapel',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('users').doc(AppState.currentUser.uid).set(AppState.userProfile);
            }
            
            // Check subscription
            await SubscriptionSystem.checkSubscription();
            
            // Load school profile if NPSN exists
            if (AppState.userProfile.npsn) {
                await SchoolSystem.loadSchool(AppState.userProfile.npsn);
            }
            
            // Load settings
            await SuperAdminSystem.loadSettings();
            
        } catch (error) {
            console.error('Load profile error:', error);
        }
    },

    async logout() {
        try {
            await auth.signOut();
            AppState.currentUser = null;
            AppState.userProfile = null;
            UISystem.showLanding();
        } catch (error) {
            console.error('Logout error:', error);
        }
    },

    showLoginModal() {
        UISystem.openModal('modal-login');
    }
};

// ==================== PROFILE SYSTEM ====================
const ProfileSystem = {
    async saveProfile(data) {
        try {
            await db.collection('users').doc(AppState.currentUser.uid).update(data);
            AppState.userProfile = { ...AppState.userProfile, ...data };
            UISystem.showToast('Profil berhasil disimpan');
            return true;
        } catch (error) {
            console.error('Save profile error:', error);
            UISystem.showToast('Gagal menyimpan profil', 'error');
            return false;
        }
    }
};

// ==================== SCHOOL SYSTEM ====================
const SchoolSystem = {
    async loadSchool(npsn) {
        try {
            const doc = await db.collection('schools').doc(npsn).get();
            if (doc.exists) {
                AppState.schoolProfile = doc.data();
            }
        } catch (error) {
            console.error('Load school error:', error);
        }
    },

    async saveSchool(data) {
        try {
            const npsn = data.npsn;
            await db.collection('schools').doc(npsn).set(data, { merge: true });
            AppState.schoolProfile = data;
            
            // Update user's NPSN
            await ProfileSystem.saveProfile({ npsn });
            
            UISystem.showToast('Data sekolah berhasil disimpan');
            return true;
        } catch (error) {
            console.error('Save school error:', error);
            UISystem.showToast('Gagal menyimpan data sekolah', 'error');
            return false;
        }
    },

    async getTeachersInSchool(npsn) {
        try {
            const snapshot = await db.collection('users').where('npsn', '==', npsn).get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) {
            console.error('Get teachers error:', error);
            return [];
        }
    }
};

// ==================== CURRICULUM SYSTEM ====================
const CurriculumSystem = {
    async fetchFromCloud(jenjang) {
        try {
            UISystem.showLoading('Mengunduh data kurikulum...');
            const url = CP_LINKS[jenjang];
            
            let response;
            try {
                response = await fetch(url);
            } catch {
                response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
            }
            
            const csvText = await response.text();
            this.parseCSV(csvText);
            UISystem.showToast('Data kurikulum berhasil dimuat');
        } catch (error) {
            console.error('Fetch curriculum error:', error);
            UISystem.showToast('Gagal mengunduh data kurikulum', 'error');
        } finally {
            UISystem.hideLoading();
        }
    },

    parseCSV(csvText) {
        const lines = csvText.split('\n');
        AppState.curriculum = {};
        AppState.faseMap = {};
        let count = 0;

        for (let i = 1; i < lines.length; i++) {
            const row = lines[i].trim();
            if (!row) continue;

            const cols = this.parseCSVRow(row);
            if (cols.length < 5) continue;

            const [mapel, fase, kelas, semester, elemen, cp, tp] = cols.map(c => c?.trim() || '');
            
            if (fase && kelas) AppState.faseMap[kelas] = fase;
            
            if (!AppState.curriculum[mapel]) AppState.curriculum[mapel] = {};
            if (!AppState.curriculum[mapel][kelas]) AppState.curriculum[mapel][kelas] = {};
            if (!AppState.curriculum[mapel][kelas][semester]) AppState.curriculum[mapel][kelas][semester] = {};
            if (!AppState.curriculum[mapel][kelas][semester][elemen]) {
                AppState.curriculum[mapel][kelas][semester][elemen] = { cp: cp || '', tps: [] };
            }
            
            AppState.curriculum[mapel][kelas][semester][elemen].tps.push({
                tp: tp || cp || '',
                jp: 0
            });
            count++;
        }
        
        console.log(`Parsed ${count} TP entries`);
        this.updateDropdowns();
    },

    parseCSVRow(row) {
        const cols = [];
        const regex = /("([^"]*)"|[^,]+)(?=,|$)/g;
        let match;
        while ((match = regex.exec(row)) !== null) {
            cols.push(match[2] !== undefined ? match[2] : match[1]);
        }
        return cols;
    },

    uploadCSV(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            this.parseCSV(e.target.result);
            UISystem.showToast('File CSV berhasil dimuat');
        };
        reader.readAsText(file);
    },

    updateDropdowns() {
        const mapels = Object.keys(AppState.curriculum);
        if (mapels.length === 0) return;

        // Will be called when page is rendered
        const event = new CustomEvent('curriculumLoaded', { detail: { mapels } });
        document.dispatchEvent(event);
    },

    getMapels() {
        return Object.keys(AppState.curriculum);
    },

    getKelas(mapel) {
        if (!AppState.curriculum[mapel]) return [];
        return Object.keys(AppState.curriculum[mapel]).sort((a, b) => {
            const numA = parseInt(a.replace(/\D/g, ''));
            const numB = parseInt(b.replace(/\D/g, ''));
            return numA - numB;
        });
    },

    getSemesters(mapel, kelas) {
        if (!AppState.curriculum[mapel]?.[kelas]) return [];
        return Object.keys(AppState.curriculum[mapel][kelas]);
    },

    getElemen(mapel, kelas, semester) {
        if (!AppState.curriculum[mapel]?.[kelas]?.[semester]) return [];
        return Object.keys(AppState.curriculum[mapel][kelas][semester]);
    },

    getTP(mapel, kelas, semester, elemen) {
        return AppState.curriculum[mapel]?.[kelas]?.[semester]?.[elemen] || null;
    },

    getAllTP(mapel, kelas, semester) {
        const result = [];
        const data = AppState.curriculum[mapel]?.[kelas]?.[semester];
        if (!data) return result;
        
        Object.keys(data).forEach(elemen => {
            data[elemen].tps.forEach(tp => {
                result.push({ elemen, ...tp, cp: data[elemen].cp });
            });
        });
        return result;
    }
};

// ==================== CALENDAR SYSTEM ====================
const CalendarSystem = {
    settings: {
        masukGanjil: '',
        raporGanjil: '',
        masukGenap: '',
        raporGenap: '',
        hariMengajar: 1,
        jpPertemuan: 4,
        customHolidays: DEFAULT_HOLIDAYS
    },

    init() {
        const year = new Date().getFullYear();
        this.settings.masukGanjil = `${year}-07-15`;
        this.settings.raporGanjil = `${year}-12-20`;
        this.settings.masukGenap = `${year + 1}-01-06`;
        this.settings.raporGenap = `${year + 1}-06-20`;
    },

    generateCalendar() {
        AppState.calendarEvents = {};
        AppState.eventList = [];

        const addEvent = (date, name) => {
            AppState.calendarEvents[date] = name;
            AppState.eventList.push({ date, name });
        };

        // Auto-generate semester boundaries
        const boundaries = [
            { date: this.settings.masukGanjil, name: 'Awal Masuk Tahun Ajaran', type: 'start', month: 6 },
            { date: this.settings.raporGanjil, name: 'Pembagian Rapor Ganjil', type: 'end', month: 11 },
            { date: this.settings.masukGenap, name: 'Awal Masuk Semester Genap', type: 'start', month: 0 },
            { date: this.settings.raporGenap, name: 'Pembagian Rapor Kenaikan', type: 'end', month: 5 }
        ];

        boundaries.forEach(b => {
            if (!b.date) return;
            addEvent(b.date, b.name);
            
            const [y, m, d] = b.date.split('-').map(Number);
            const lastDay = new Date(y, m, 0).getDate();
            
            if (b.type === 'start') {
                for (let i = 1; i < d; i++) {
                    addEvent(`${y}-${String(m).padStart(2, '0')}-${String(i).padStart(2, '0')}`, 'Libur Awal Semester');
                }
            } else {
                for (let i = d + 1; i <= lastDay; i++) {
                    addEvent(`${y}-${String(m).padStart(2, '0')}-${String(i).padStart(2, '0')}`, 'Libur Akhir Semester');
                }
            }
        });

        // Parse custom holidays
        this.settings.customHolidays.split('\n').forEach(line => {
            const parts = line.split('=');
            if (parts.length >= 2) {
                addEvent(parts[0].trim(), parts[1].trim());
            }
        });

        AppState.eventList.sort((a, b) => new Date(a.date) - new Date(b.date));
    },

    getTeachingDates(semester, year) {
        const dates = [];
        const startMonth = semester === 'Ganjil' ? 6 : 0;
        const monthCount = 6;
        const targetDay = this.settings.hariMengajar;

        for (let i = 0; i < monthCount; i++) {
            let month = startMonth + i;
            let yr = year;
            if (month > 11) {
                month -= 12;
                yr++;
            }

            const daysInMonth = new Date(yr, month + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(yr, month, day);
                if (date.getDay() === targetDay) {
                    const dateStr = `${yr}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    if (!AppState.calendarEvents[dateStr]) {
                        dates.push({ date: dateStr, dateObj: date });
                    }
                }
            }
        }

        return dates;
    },

    formatDateIndo(dateStr) {
        if (!dateStr) return '';
        const [y, m, d] = dateStr.split('-');
        return `${parseInt(d)} ${BULAN_IND[parseInt(m) - 1]} ${y}`;
    }
};

// ==================== SUBSCRIPTION SYSTEM ====================
const SubscriptionSystem = {
    async checkSubscription() {
        try {
            // Check if user's NPSN is in premium list
            const settingsDoc = await db.collection('settings').doc('global').get();
            if (settingsDoc.exists) {
                const settings = settingsDoc.data();
                AppState.settings = { ...AppState.settings, ...settings };
                
                const npsn = AppState.userProfile?.npsn;
                if (npsn && settings.premiumNPSN?.includes(npsn)) {
                    AppState.isPro = true;
                }
                
                // Check individual premium
                if (settings.premiumUsers?.includes(AppState.currentUser.email)) {
                    AppState.isPro = true;
                }
                
                // Check PAI teacher free access
                if (AppState.userProfile?.tipeGuru === 'mapel' && 
                    AppState.userProfile?.mapel?.toLowerCase().includes('pai') &&
                    settings.paiNPSN?.includes(npsn)) {
                    AppState.isPro = true;
                }
            }

            // Super admin always pro
            if (AppState.isSuperAdmin) {
                AppState.isPro = true;
                AppState.isAdmin = true;
            }

            this.updateUI();
        } catch (error) {
            console.error('Check subscription error:', error);
        }
    },

    updateUI() {
        const badge = document.getElementById('user-badge');
        if (badge) {
            badge.className = AppState.isPro ? 'badge-pro' : 'badge-free';
            badge.textContent = AppState.isPro ? 'PRO' : 'FREE';
        }
    },

    checkAccess(feature) {
        const freeFeatures = ['kalender', 'doc-atp', 'dashboard', 'profil-guru', 'profil-sekolah', 'data-siswa', 'kurikulum'];
        if (freeFeatures.includes(feature) || AppState.isPro) {
            return true;
        }
        this.showUpgradeModal();
        return false;
    },

    showUpgradeModal() {
        const waBtn = document.getElementById('btn-wa-upgrade');
        if (waBtn) {
            waBtn.href = `https://wa.me/${AppState.settings.waNumber}?text=${encodeURIComponent('Halo, saya ingin upgrade ke versi PRO Admin Guru Super App')}`;
        }
        UISystem.openModal('modal-upgrade');
    }
};

// ==================== SUPER ADMIN SYSTEM ====================
const SuperAdminSystem = {
    async loadSettings() {
        try {
            const doc = await db.collection('settings').doc('global').get();
            if (doc.exists) {
                AppState.settings = { ...AppState.settings, ...doc.data() };
            }
        } catch (error) {
            console.error('Load settings error:', error);
        }
    },

    async saveSettings(data) {
        if (!AppState.isSuperAdmin) {
            UISystem.showToast('Akses ditolak', 'error');
            return false;
        }

        try {
            await db.collection('settings').doc('global').set(data, { merge: true });
            AppState.settings = { ...AppState.settings, ...data };
            UISystem.showToast('Pengaturan berhasil disimpan');
            return true;
        } catch (error) {
            console.error('Save settings error:', error);
            UISystem.showToast('Gagal menyimpan pengaturan', 'error');
            return false;
        }
    },

    async getAllSchools() {
        try {
            const snapshot = await db.collection('schools').get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) {
            console.error('Get schools error:', error);
            return [];
        }
    },

    async getAllUsers() {
        try {
            const snapshot = await db.collection('users').get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) {
            console.error('Get users error:', error);
            return [];
        }
    }
};

// ==================== BANK SOAL SYSTEM ====================
const BankSoalSystem = {
    questions: [],

    parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        const questions = [];
        
        for (let i = 1; i < lines.length; i++) {
            const cols = CurriculumSystem.parseCSVRow(lines[i]);
            if (cols.length >= 3) {
                questions.push({
                    no: cols[0] || i,
                    soal: cols[1] || '',
                    jawaban: cols[2] || '',
                    type: cols[3] || 'pg'
                });
            }
        }
        
        this.questions = questions;
        return questions;
    },

    generatePacket(questions, shuffle = true) {
        let packet = [...questions];
        if (shuffle) {
            for (let i = packet.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [packet[i], packet[j]] = [packet[j], packet[i]];
            }
        }
        return packet;
    }
};

// ==================== DOCUMENT ENGINE ====================
const DocumentEngine = {
    getIdentity() {
        return {
            sekolah: AppState.schoolProfile?.nama || '',
            npsn: AppState.schoolProfile?.npsn || '',
            alamat: AppState.schoolProfile?.alamat || '',
            kepsek: AppState.schoolProfile?.kepsek || '',
            nipKepsek: AppState.schoolProfile?.nipKepsek || '',
            guru: AppState.userProfile?.name || '',
            nipGuru: AppState.userProfile?.nip || '',
            mapel: AppState.selectedMapel,
            kelas: AppState.selectedKelas,
            semester: AppState.selectedSemester,
            fase: AppState.faseMap[AppState.selectedKelas] || '',
            tahun: new Date().getFullYear(),
            rombel: AppState.userProfile?.rombel || 'A',
            tempat: AppState.schoolProfile?.kota || ''
        };
    },

    generateSignature(identity, date = null) {
        const tgl = date || new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
        return `
            <div class="signature-area" contenteditable="true">
                <div class="signature-box">
                    Mengetahui,<br>Kepala Sekolah
                    <div class="signature-name">${identity.kepsek}</div>
                    NIP. ${identity.nipKepsek}
                </div>
                <div class="signature-box">
                    ${identity.tempat}, ${tgl}<br>
                    Guru Mata Pelajaran
                    <div class="signature-name">${identity.guru}</div>
                    NIP. ${identity.nipGuru}
                </div>
            </div>
        `;
    }
};

// ==================== AI SYSTEM ====================
const AISystem = {
    switchTab(tabName) {
        document.querySelectorAll('.ai-tab').forEach(tab => {
            tab.classList.remove('text-primary-600', 'border-b-2', 'border-primary-600');
            tab.classList.add('text-slate-500');
        });
        document.querySelectorAll('.ai-tab-content').forEach(content => {
            content.classList.add('hidden');
        });

        const activeTab = document.querySelector(`.ai-tab[data-tab="${tabName}"]`);
        const activeContent = document.getElementById(`ai-tab-${tabName}`);
        
        if (activeTab) {
            activeTab.classList.remove('text-slate-500');
            activeTab.classList.add('text-primary-600', 'border-b-2', 'border-primary-600');
        }
        if (activeContent) {
            activeContent.classList.remove('hidden');
        }

        if (tabName === 'prompt') {
            this.populateTPDropdown();
        }
    },

    populateTPDropdown() {
        const select = document.getElementById('prompt-tp');
        if (!select) return;

        select.innerHTML = '<option value="">-- Pilih TP --</option>';
        
        const tps = CurriculumSystem.getAllTP(
            AppState.selectedMapel,
            AppState.selectedKelas,
            AppState.selectedSemester
        );

        tps.forEach((tp, i) => {
            const opt = document.createElement('option');
            opt.value = tp.tp;
            opt.textContent = `${i + 1}. ${tp.tp.substring(0, 60)}...`;
            select.appendChild(opt);
        });

        this.updatePrompt();
    },

    updatePrompt() {
        const type = document.getElementById('prompt-type')?.value || 'soal-pg';
        const count = document.getElementById('prompt-count')?.value || 10;
        const tp = document.getElementById('prompt-tp')?.value || '';
        const result = document.getElementById('prompt-result');

        if (!result) return;

        let prompt = '';
        const mapel = AppState.selectedMapel || 'Mata Pelajaran';
        const kelas = AppState.selectedKelas || 'X';

        switch (type) {
            case 'soal-pg':
                prompt = `Buatkan ${count} soal PILIHAN GANDA untuk:
- Mata Pelajaran: ${mapel}
- Kelas: ${kelas}
- Tujuan Pembelajaran: ${tp || '[Masukkan TP]'}

Format output dalam CSV:
no,soal,opsi_a,opsi_b,opsi_c,opsi_d,kunci_jawaban

Pastikan:
1. Soal sesuai dengan TP
2. Tingkat kesulitan bervariasi (mudah, sedang, sulit)
3. Opsi jawaban masuk akal dan tidak ambigu
4. Kunci jawaban menggunakan huruf (A/B/C/D)`;
                break;

            case 'soal-essay':
                prompt = `Buatkan ${count} soal ESSAY untuk:
- Mata Pelajaran: ${mapel}
- Kelas: ${kelas}
- Tujuan Pembelajaran: ${tp || '[Masukkan TP]'}

Format output dalam CSV:
no,soal,kunci_jawaban,skor_maksimal

Pastikan:
1. Soal menuntut analisis dan pemahaman mendalam
2. Kunci jawaban lengkap dengan poin-poin penting
3. Skor maksimal sesuai kompleksitas soal`;
                break;

            case 'soal-campuran':
                prompt = `Buatkan soal CAMPURAN untuk:
- Mata Pelajaran: ${mapel}
- Kelas: ${kelas}
- Tujuan Pembelajaran: ${tp || '[Masukkan TP]'}

Komposisi:
- 5 soal Pilihan Ganda
- 3 soal Isian Singkat
- 2 soal Essay

Format output dalam CSV dengan kolom:
no,tipe,soal,opsi_a,opsi_b,opsi_c,opsi_d,kunci_jawaban`;
                break;

            case 'materi':
                prompt = `Buatkan RINGKASAN MATERI untuk:
- Mata Pelajaran: ${mapel}
- Kelas: ${kelas}
- Tujuan Pembelajaran: ${tp || '[Masukkan TP]'}

Struktur:
1. Pendahuluan (pengertian dasar)
2. Isi materi (penjelasan lengkap)
3. Contoh penerapan
4. Rangkuman poin penting

Gunakan bahasa yang mudah dipahami siswa.`;
                break;

            case 'lkpd':
                prompt = `Buatkan INSTRUKSI LKPD (Lembar Kerja Peserta Didik) untuk:
- Mata Pelajaran: ${mapel}
- Kelas: ${kelas}
- Tujuan Pembelajaran: ${tp || '[Masukkan TP]'}

Struktur:
1. Petunjuk pengerjaan
2. Aktivitas 1 (observasi/pengamatan)
3. Aktivitas 2 (diskusi kelompok)
4. Aktivitas 3 (latihan mandiri)
5. Refleksi pembelajaran

Fokus pada pembelajaran aktif dan kolaboratif.`;
                break;
        }

        result.value = prompt;
    },

    copyPrompt() {
        const result = document.getElementById('prompt-result');
        if (result) {
            navigator.clipboard.writeText(result.value);
            UISystem.showToast('Prompt berhasil disalin');
        }
    },

    openChatGPT() {
        window.open('https://chat.openai.com', '_blank');
    }
};

// ==================== UI SYSTEM ====================
const UISystem = {
    currentPage: 'dashboard',

    showLanding() {
        document.getElementById('landing-page').classList.remove('hidden');
        document.getElementById('main-app').classList.add('hidden');
    },

    showApp() {
        document.getElementById('landing-page').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        
        // Update user info
        document.getElementById('user-name').textContent = AppState.currentUser.displayName || 'User';
        document.getElementById('user-email').textContent = AppState.currentUser.email;
        document.getElementById('user-avatar').textContent = (AppState.currentUser.displayName || 'U')[0].toUpperCase();
        
        // Show super admin nav if applicable
        if (AppState.isSuperAdmin) {
            document.getElementById('nav-superadmin').classList.remove('hidden');
        }

        this.navigateTo('dashboard');
    },

    navigateTo(page) {
        // Check subscription for pro features
        const proFeatures = ['doc-promes', 'doc-modul', 'doc-jurnal', 'doc-absensi', 'doc-kktp', 'bank-soal'];
        if (proFeatures.includes(page) && !SubscriptionSystem.checkAccess(page)) {
            return;
        }

        this.currentPage = page;
        
        // Update nav
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.page === page) {
                item.classList.add('active');
            }
        });

        // Render page
        this.renderPage(page);
        
        // Close sidebar on mobile
        if (window.innerWidth < 1024) {
            this.toggleSidebar(false);
        }
    },

    renderPage(page) {
        const container = document.getElementById('page-container');
        container.innerHTML = '';
        container.className = 'p-4 lg:p-8 page-transition';

        switch (page) {
            case 'dashboard':
                container.innerHTML = this.renderDashboard();
                break;
            case 'profil-guru':
                container.innerHTML = this.renderProfilGuru();
                break;
            case 'profil-sekolah':
                container.innerHTML = this.renderProfilSekolah();
                break;
            case 'data-siswa':
                container.innerHTML = this.renderDataSiswa();
                break;
            case 'kurikulum':
                container.innerHTML = this.renderKurikulum();
                break;
            case 'kalender':
                container.innerHTML = this.renderKalender();
                break;
            case 'doc-atp':
                container.innerHTML = this.renderDocATP();
                break;
            case 'doc-promes':
                container.innerHTML = this.renderDocPromes();
                break;
            case 'doc-modul':
                container.innerHTML = this.renderDocModul();
                break;
            case 'doc-jurnal':
                container.innerHTML = this.renderDocJurnal();
                break;
            case 'doc-absensi':
                container.innerHTML = this.renderDocAbsensi();
                break;
            case 'doc-kktp':
                container.innerHTML = this.renderDocKKTP();
                break;
            case 'bank-soal':
                container.innerHTML = this.renderBankSoal();
                break;
            case 'subscription':
                container.innerHTML = this.renderSubscription();
                break;
            case 'super-admin':
                container.innerHTML = this.renderSuperAdmin();
                break;
            default:
                container.innerHTML = '<p>Halaman tidak ditemukan</p>';
        }

        // Initialize page-specific functionality
        this.initPageScripts(page);
    },

    renderDashboard() {
        const stats = {
            mapelCount: CurriculumSystem.getMapels().length,
            studentCount: AppState.students.length,
            docsGenerated: 0
        };

        return `
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-slate-800">Dashboard</h1>
                <p class="text-slate-600">Selamat datang, ${AppState.userProfile?.name || AppState.currentUser.displayName}!</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-500 text-sm">Total Mapel</p>
                            <p class="text-3xl font-bold text-slate-800">${stats.mapelCount}</p>
                        </div>
                        <div class="w-12 h-12 bg-primary-100 rounded-xl flex items-center justify-center text-2xl">ğŸ“š</div>
                    </div>
                </div>
                <div class="card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-500 text-sm">Total Siswa</p>
                            <p class="text-3xl font-bold text-slate-800">${stats.studentCount}</p>
                        </div>
                        <div class="w-12 h-12 bg-accent-100 rounded-xl flex items-center justify-center text-2xl">ğŸ‘¥</div>
                    </div>
                </div>
                <div class="card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-500 text-sm">Status</p>
                            <p class="text-xl font-bold ${AppState.isPro ? 'text-amber-600' : 'text-accent-600'}">${AppState.isPro ? 'PRO' : 'FREE'}</p>
                        </div>
                        <div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center text-2xl">ğŸ’</div>
                    </div>
                </div>
                <div class="card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-500 text-sm">NPSN</p>
                            <p class="text-xl font-bold text-slate-800">${AppState.userProfile?.npsn || '-'}</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center text-2xl">ğŸ«</div>
                    </div>
                </div>
            </div>

            <div class="grid lg:grid-cols-2 gap-6">
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">ğŸš€ Quick Start</h3>
                    <div class="space-y-3">
                        <div onclick="UISystem.navigateTo('kurikulum')" class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 cursor-pointer transition">
                            <span class="w-8 h-8 bg-primary-600 text-white rounded-full flex items-center justify-center text-sm font-bold">1</span>
                            <span>Muat data kurikulum</span>
                        </div>
                        <div onclick="UISystem.navigateTo('profil-sekolah')" class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 cursor-pointer transition">
                            <span class="w-8 h-8 bg-primary-600 text-white rounded-full flex items-center justify-center text-sm font-bold">2</span>
                            <span>Lengkapi profil sekolah</span>
                        </div>
                        <div onclick="UISystem.navigateTo('data-siswa')" class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 cursor-pointer transition">
                            <span class="w-8 h-8 bg-primary-600 text-white rounded-full flex items-center justify-center text-sm font-bold">3</span>
                            <span>Input data siswa</span>
                        </div>
                        <div onclick="UISystem.navigateTo('doc-atp')" class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 cursor-pointer transition">
                            <span class="w-8 h-8 bg-primary-600 text-white rounded-full flex items-center justify-center text-sm font-bold">4</span>
                            <span>Generate dokumen</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="font-bold text-lg mb-4">ğŸ“‹ Dokumen Tersedia</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div onclick="UISystem.navigateTo('doc-atp')" class="p-3 border rounded-lg hover:border-primary-500 cursor-pointer transition text-center">
                            <span class="text-2xl">ğŸ“‹</span>
                            <p class="text-sm font-medium mt-1">ATP & Prota</p>
                            <span class="badge-free text-[10px]">FREE</span>
                        </div>
                        <div onclick="UISystem.navigateTo('kalender')" class="p-3 border rounded-lg hover:border-primary-500 cursor-pointer transition text-center">
                            <span class="text-2xl">ğŸ“…</span>
                            <p class="text-sm font-medium mt-1">Kalender</p>
                            <span class="badge-free text-[10px]">FREE</span>
                        </div>
                        <div onclick="UISystem.navigateTo('doc-promes')" class="p-3 border rounded-lg hover:border-primary-500 cursor-pointer transition text-center">
                            <span class="text-2xl">ğŸ“†</span>
                            <p class="text-sm font-medium mt-1">Promes</p>
                            <span class="badge-pro text-[10px]">PRO</span>
                        </div>
                        <div onclick="UISystem.navigateTo('doc-modul')" class="p-3 border rounded-lg hover:border-primary-500 cursor-pointer transition text-center">
                            <span class="text-2xl">ğŸ“–</span>
                            <p class="text-sm font-medium mt-1">Modul Ajar</p>
                            <span class="badge-pro text-[10px]">PRO</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    renderProfilGuru() {
        const profile = AppState.userProfile || {};
        return `
            <div class="max-w-2xl">
                <h1 class="text-2xl font-bold text-slate-800 mb-6">Profil Guru</h1>
                
                <div class="card">
                    <form id="form-profil-guru" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1">Nama Lengkap</label>
                            <input type="text" id="guru-nama" class="input-field" value="${profile.name || ''}" placeholder="Nama lengkap dengan gelar">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">NIP</label>
                            <input type="text" id="guru-nip" class="input-field" value="${profile.nip || ''}" placeholder="Nomor Induk Pegawai">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">Email</label>
                            <input type="email" class="input-field bg-slate-100" value="${profile.email || ''}" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">Tipe Guru</label>
                            <select id="guru-tipe" class="input-field">
                                <option value="mapel" ${profile.tipeGuru === 'mapel' ? 'selected' : ''}>Guru Mata Pelajaran</option>
                                <option value="kelas" ${profile.tipeGuru === 'kelas' ? 'selected' : ''}>Guru Kelas</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">Rombel</label>
                            <input type="text" id="guru-rombel" class="input-field" value="${profile.rombel || 'A'}" placeholder="A/B/C">
                        </div>
                        
                        <button type="submit" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 rounded-lg transition">
                            Simpan Profil
                        </button>
                    </form>
                </div>
            </div>
        `;
    },

    renderProfilSekolah() {
        const school = AppState.schoolProfile || {};
        return `
            <div class="max-w-2xl">
                <h1 class="text-2xl font-bold text-slate-800 mb-6">Profil Sekolah</h1>
                
                <div class="card">
                    <form id="form-profil-sekolah" class="space-y-4">
                        <div class="p-4 bg-blue-50 rounded-lg mb-4">
                            <p class="text-sm text-blue-700">
                                <strong>ğŸ’¡ Kolaborasi:</strong> Guru dengan NPSN yang sama akan tergabung dalam satu sekolah dan dapat berkolaborasi.
                            </p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-1">NPSN <span class="text-red-500">*</span></label>
                            <input type="text" id="sekolah-npsn" class="input-field" value="${school.npsn || ''}" placeholder="Nomor Pokok Sekolah Nasional" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">Nama Sekolah</label>
                            <input type="text" id="sekolah-nama" class="input-field" value="${school.nama || ''}" placeholder="SDN/SMPN/SMAN ...">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">Alamat</label>
                            <textarea id="sekolah-alamat" class="input-field" rows="2" placeholder="Alamat lengkap">${school.alamat || ''}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">Kota/Kabupaten</label>
                            <input type="text" id="sekolah-kota" class="input-field" value="${school.kota || ''}" placeholder="Untuk tanda tangan dokumen">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">Nama Kepala Sekolah</label>
                            <input type="text" id="sekolah-kepsek" class="input-field" value="${school.kepsek || ''}" placeholder="Nama lengkap dengan gelar">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">NIP Kepala Sekolah</label>
                            <input type="text" id="sekolah-nip-kepsek" class="input-field" value="${school.nipKepsek || ''}" placeholder="NIP Kepala Sekolah">
                        </div>
                        
                        <button type="submit" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 rounded-lg transition">
                            Simpan Data Sekolah
                        </button>
                    </form>
                </div>
            </div>
        `;
    },

    renderDataSiswa() {
        return `
            <div class="max-w-4xl">
                <h1 class="text-2xl font-bold text-slate-800 mb-6">Data Siswa</h1>
                
                <div class="card mb-6">
                    <h3 class="font-bold mb-3">ğŸ“‹ Input Data Siswa</h3>
                    <p class="text-sm text-slate-600 mb-4">Format: <code class="bg-slate-100 px-2 py-1 rounded">nama;L/P;kelas</code> (satu baris per siswa)</p>
                    
                    <textarea id="input-siswa" class="input-field h-48 font-mono text-sm" placeholder="Ahmad Fulan;L;7A&#10;Siti Fulanah;P;7A&#10;Budi Santoso;L;7B"></textarea>
                    
                    <div class="flex gap-3 mt-4">
                        <button onclick="PageScripts.saveSiswa()" class="flex-1 bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 rounded-lg transition">
                            ğŸ’¾ Simpan Data
                        </button>
                        <button onclick="PageScripts.importSiswaCSV()" class="bg-slate-600 hover:bg-slate-700 text-white font-semibold py-3 px-6 rounded-lg transition">
                            ğŸ“ Import CSV
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="font-bold mb-3">ğŸ‘¥ Daftar Siswa (${AppState.students.length})</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-slate-100">
                                    <th class="px-4 py-2 text-left">No</th>
                                    <th class="px-4 py-2 text-left">Nama</th>
                                    <th class="px-4 py-2 text-center">L/P</th>
                                    <th class="px-4 py-2 text-center">Kelas</th>
                                </tr>
                            </thead>
                            <tbody id="tabel-siswa">
                                ${AppState.students.map((s, i) => `
                                    <tr class="border-b">
                                        <td class="px-4 py-2">${i + 1}</td>
                                        <td class="px-4 py-2">${s.nama || s}</td>
                                        <td class="px-4 py-2 text-center">${s.jk || '-'}</td>
                                        <td class="px-4 py-2 text-center">${s.kelas || '-'}</td>
                                    </tr>
                                `).join('') || '<tr><td colspan="4" class="px-4 py-8 text-center text-slate-500">Belum ada data siswa</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    },

    renderKurikulum() {
        const mapels = CurriculumSystem.getMapels();
        return `
            <div class="max-w-4xl">
                <h1 class="text-2xl font-bold text-slate-800 mb-6">Kurikulum & Mapel</h1>
                
                <div class="grid lg:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="font-bold mb-4">ğŸ“¥ Muat Data Kurikulum</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-1">Jenjang Pendidikan</label>
                            <select id="select-jenjang" class="input-field">
                                <option value="SD">SD / MI</option>
                                <option value="SMP">SMP / MTs</option>
                                <option value="SMA">SMA / SMK / MA</option>
                            </select>
                        </div>
                        
                        <button onclick="PageScripts.loadKurikulum()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-semibold py-3 rounded-lg transition mb-3">
                            â˜ï¸ Load dari Cloud
                        </button>
                        
                        <div class="relative">
                            <input type="file" id="file-csv" accept=".csv" class="absolute inset-0 opacity-0 cursor-pointer" onchange="PageScripts.uploadCSV(this)">
                            <button class="w-full bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-3 rounded-lg transition">
                                ğŸ“ Upload CSV Manual
                            </button>
                        </div>
                        
                        <div id="csv-status" class="csv-info hidden mt-3"></div>
                    </div>
                    
                    <div class="card">
                        <h3 class="font-bold mb-4">ğŸ“š Pilih Mapel & Kelas</h3>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-semibold mb-1">Mata Pelajaran</label>
                                <select id="select-mapel" class="input-field" onchange="PageScripts.onMapelChange()">
                                    <option value="">-- Pilih Mapel --</option>
                                    ${mapels.map(m => `<option value="${m}" ${AppState.selectedMapel === m ? 'selected' : ''}>${m}</option>`).join('')}
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-semibold mb-1">Kelas</label>
                                    <select id="select-kelas" class="input-field" onchange="PageScripts.onKelasChange()">
                                        <option value="">-</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1">Semester</label>
                                    <select id="select-semester" class="input-field" onchange="PageScripts.onSemesterChange()">
                                        <option value="">-</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Elemen/Bab</label>
                                <select id="select-elemen" class="input-field" onchange="PageScripts.onElemenChange()">
                                    <option value="">-</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-6" id="preview-tp">
                    <h3 class="font-bold mb-4">ğŸ“‹ Preview Tujuan Pembelajaran</h3>
                    <div id="list-tp" class="space-y-2 text-sm">
                        <p class="text-slate-500 italic">Pilih mapel, kelas, dan semester untuk melihat TP</p>
                    </div>
                </div>
            </div>
        `;
    },

    renderKalender() {
        return `
            <div class="max-w-4xl">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <h1 class="text-2xl font-bold text-slate-800">Kalender & Jadwal</h1>
                    <button onclick="window.print()" class="bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2 px-4 rounded-lg transition no-print">
                        ğŸ–¨ï¸ Cetak PDF
                    </button>
                </div>
                
                <div class="card mb-6 no-print">
                    <h3 class="font-bold mb-4">âš™ï¸ Pengaturan Kalender</h3>
                    
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-semibold mb-1">Awal Masuk (Juli)</label>
                            <input type="date" id="cal-masuk-ganjil" class="input-field text-sm" value="${CalendarSystem.settings.masukGanjil}">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold mb-1">Rapor Ganjil (Des)</label>
                            <input type="date" id="cal-rapor-ganjil" class="input-field text-sm" value="${CalendarSystem.settings.raporGanjil}">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold mb-1">Awal Masuk (Jan)</label>
                            <input type="date" id="cal-masuk-genap" class="input-field text-sm" value="${CalendarSystem.settings.masukGenap}">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold mb-1">Rapor Genap (Jun)</label>
                            <input type="date" id="cal-rapor-genap" class="input-field text-sm" value="${CalendarSystem.settings.raporGenap}">
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-semibold mb-1">Hari Mengajar</label>
                            <select id="cal-hari" class="input-field">
                                ${HARI_IND.map((h, i) => `<option value="${i}" ${CalendarSystem.settings.hariMengajar === i ? 'selected' : ''}>${h}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold mb-1">JP per Pertemuan</label>
                            <input type="number" id="cal-jp" class="input-field" value="${CalendarSystem.settings.jpPertemuan}" min="1">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-semibold mb-1">Libur & Agenda Kustom (YYYY-MM-DD = Keterangan)</label>
                        <textarea id="cal-libur" class="input-field h-32 font-mono text-xs">${CalendarSystem.settings.customHolidays}</textarea>
                    </div>
                    
                    <button onclick="PageScripts.generateKalender()" class="mt-4 bg-primary-600 hover:bg-primary-700 text-white font-semibold py-2 px-6 rounded-lg transition">
                        ğŸ”„ Generate Kalender
                    </button>
                </div>
                
                <div id="output-kalender">
                    <!-- Kalender preview akan di-render di sini -->
                </div>
            </div>
        `;
    },

    renderDocATP() {
        return `
            <div>
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6 no-print">
                    <h1 class="text-2xl font-bold text-slate-800">ATP & Prota</h1>
                    <div class="flex gap-3">
                        <select id="atp-mode" class="input-field w-auto" onchange="PageScripts.generateATP()">
                            <option value="semester">1 Semester</option>
                            <option value="tahun">1 Tahun Penuh</option>
                        </select>
                        <button onclick="window.print()" class="bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2 px-4 rounded-lg transition">
                            ğŸ–¨ï¸ Cetak PDF
                        </button>
                    </div>
                </div>
                
                <div id="output-atp">
                    <div class="card text-center py-12">
                        <p class="text-slate-500">Pilih Mapel, Kelas, dan Semester di menu <strong>Kurikulum & Mapel</strong> terlebih dahulu</p>
                        <button onclick="UISystem.navigateTo('kurikulum')" class="mt-4 bg-primary-600 hover:bg-primary-700 text-white font-semibold py-2 px-6 rounded-lg transition">
                            Buka Kurikulum
                        </button>
                    </div>
                </div>
            </div>
        `;
    },

    renderDocPromes() {
        return `
            <div>
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6 no-print">
                    <h1 class="text-2xl font-bold text-slate-800">Program Semester (Promes)</h1>
                    <div class="flex gap-3">
                        <select id="promes-paper" class="input-field w-auto">
                            <option value="a4">A4 Landscape</option>
                            <option value="f4">F4 Landscape</option>
                        </select>
                        <button onclick="window.print()" class="bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2 px-4 rounded-lg transition">
                            ğŸ–¨ï¸ Cetak PDF
                        </button>
                    </div>
                </div>
                
                <div id="output-promes">
                    <div class="card text-center py-12">
                        <p class="text-slate-500">Generate kalender terlebih dahulu untuk melihat Promes</p>
                        <button onclick="UISystem.navigateTo('kalender')" class="mt-4 bg-primary-600 hover:bg-primary-700 text-white font-semibold py-2 px-6 rounded-lg transition">
                            Buka Kalender
                        </button>
                    </div>
                </div>
            </div>
        `;
    },

    renderDocModul() {
        return `
            <div>
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6 no-print">
                    <h1 class="text-2xl font-bold text-slate-800">Modul Ajar & LKPD</h1>
                    <button onclick="window.print()" class="bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2 px-4 rounded-lg transition">
                        ğŸ–¨ï¸ Cetak PDF
                    </button>
                </div>
                
                <div id="output-modul">
                    <!-- Modul akan di-render di sini -->
                </div>
            </div>
        `;
    },

    renderDocJurnal() {
        return `
            <div>
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6 no-print">
                    <h1 class="text-2xl font-bold text-slate-800">Jurnal Pembelajaran</h1>
                    <div class="flex gap-3">
                        <select id="jurnal-paper" class="input-field w-auto">
                            <option value="a4">A4 Landscape</option>
                            <option value="f4">F4 Landscape</option>
                        </select>
                        <button onclick="window.print()" class="bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2 px-4 rounded-lg transition">
                            ğŸ–¨ï¸ Cetak PDF
                        </button>
                    </div>
                </div>
                
                <div id="output-jurnal">
                    <!-- Jurnal akan di-render di sini -->
                </div>
            </div>
        `;
    },

    renderDocAbsensi() {
        return `
            <div>
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6 no-print">
                    <h1 class="text-2xl font-bold text-slate-800">Absensi Siswa</h1>
                    <button onclick="window.print()" class="bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2 px-4 rounded-lg transition">
                        ğŸ–¨ï¸ Cetak PDF
                    </button>
                </div>
                
                <div id="output-absensi">
                    <!-- Absensi akan di-render di sini -->
                </div>
            </div>
        `;
    },

    renderDocKKTP() {
        return `
            <div>
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6 no-print">
                    <h1 class="text-2xl font-bold text-slate-800">KKTP & Nilai</h1>
                    <button onclick="window.print()" class="bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2 px-4 rounded-lg transition">
                        ğŸ–¨ï¸ Cetak PDF
                    </button>
                </div>
                
                <div id="output-kktp">
                    <!-- KKTP akan di-render di sini -->
                </div>
            </div>
        `;
    },

    renderBankSoal() {
        return `
            <div class="max-w-4xl">
                <h1 class="text-2xl font-bold text-slate-800 mb-6">Bank Soal</h1>
                
                <div class="grid lg:grid-cols-2 gap-6 mb-6">
                    <div class="card">
                        <h3 class="font-bold mb-4">âš™ï¸ Pengaturan Soal</h3>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-semibold mb-1">Tujuan Pembelajaran</label>
                                <select id="soal-tp" class="input-field">
                                    <option value="">-- Pilih TP --</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-semibold mb-1">Tipe Soal</label>
                                    <select id="soal-tipe" class="input-field">
                                        <option value="pg">Pilihan Ganda</option>
                                        <option value="bs">Benar/Salah</option>
                                        <option value="jodoh">Menjodohkan</option>
                                        <option value="isian">Isian Singkat</option>
                                        <option value="essay">Essay</option>
                                        <option value="campuran">Campuran</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1">Jumlah Soal</label>
                                    <input type="number" id="soal-jumlah" class="input-field" value="10" min="1" max="50">
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="soal-random" checked>
                                <label for="soal-random" class="text-sm">Acak urutan soal</label>
                            </div>
                        </div>
                        
                        <button onclick="UISystem.showAIAssistant()" class="w-full mt-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-semibold py-3 rounded-lg transition">
                            ğŸ¤– Generate dengan AI
                        </button>
                    </div>
                    
                    <div class="card">
                        <h3 class="font-bold mb-4">ğŸ“¥ Import Soal (CSV)</h3>
                        <p class="text-sm text-slate-600 mb-3">Format: <code>no,soal,kunci_jawaban</code></p>
                        
                        <textarea id="input-soal-csv" class="input-field h-32 font-mono text-xs" placeholder="Paste hasil generate AI di sini..."></textarea>
                        
                        <button onclick="PageScripts.importSoalCSV()" class="w-full mt-3 bg-primary-600 hover:bg-primary-700 text-white font-semibold py-2 rounded-lg transition">
                            ğŸ“‹ Import & Parse
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="font-bold mb-4">ğŸ“ Daftar Soal</h3>
                    <div id="list-soal" class="space-y-4">
                        <p class="text-slate-500 italic text-center py-8">Belum ada soal. Generate atau import soal untuk memulai.</p>
                    </div>
                </div>
            </div>
        `;
    },

    renderSubscription() {
        return `
            <div class="max-w-2xl">
                <h1 class="text-2xl font-bold text-slate-800 mb-6">Subscription</h1>
                
                <div class="card mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="font-bold text-lg">Status Langganan</h3>
                            <p class="text-slate-600">Akun Anda saat ini</p>
                        </div>
                        <span class="${AppState.isPro ? 'badge-pro' : 'badge-free'} text-lg px-4 py-1">${AppState.isPro ? 'PRO' : 'FREE'}</span>
                    </div>
                    
                    ${AppState.isPro ? `
                        <div class="p-4 bg-green-50 rounded-lg">
                            <p class="text-green-700">âœ… Anda memiliki akses penuh ke semua fitur PRO!</p>
                        </div>
                    ` : `
                        <div class="p-4 bg-amber-50 rounded-lg mb-4">
                            <p class="text-amber-700">âš ï¸ Upgrade ke PRO untuk akses fitur lengkap!</p>
                        </div>
                        
                        <a href="https://wa.me/${AppState.settings.waNumber}?text=${encodeURIComponent('Halo, saya ingin upgrade ke versi PRO Admin Guru Super App')}" 
                           target="_blank"
                           class="block w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg text-center transition">
                            ğŸ’¬ Hubungi WhatsApp untuk Upgrade
                        </a>
                    `}
                </div>
                
                <div class="card">
                    <h3 class="font-bold mb-4">ğŸ“‹ Perbandingan Fitur</h3>
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2">Fitur</th>
                                <th class="text-center py-2">FREE</th>
                                <th class="text-center py-2">PRO</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b"><td class="py-2">ATP & Prota</td><td class="text-center text-green-600">âœ“</td><td class="text-center text-green-600">âœ“</td></tr>
                            <tr class="border-b"><td class="py-2">Kalender & Jadwal</td><td class="text-center text-green-600">âœ“</td><td class="text-center text-green-600">âœ“</td></tr>
                            <tr class="border-b"><td class="py-2">Promes</td><td class="text-center text-red-600">âœ—</td><td class="text-center text-green-600">âœ“</td></tr>
                            <tr class="border-b"><td class="py-2">Modul Ajar & LKPD</td><td class="text-center text-red-600">âœ—</td><td class="text-center text-green-600">âœ“</td></tr>
                            <tr class="border-b"><td class="py-2">Jurnal & Absensi</td><td class="text-center text-red-600">âœ—</td><td class="text-center text-green-600">âœ“</td></tr>
                            <tr class="border-b"><td class="py-2">KKTP & Nilai</td><td class="text-center text-red-600">âœ—</td><td class="text-center text-green-600">âœ“</td></tr>
                            <tr><td class="py-2">Bank Soal AI</td><td class="text-center text-red-600">âœ—</td><td class="text-center text-green-600">âœ“</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    },

    renderSuperAdmin() {
        if (!AppState.isSuperAdmin) {
            return '<div class="card"><p class="text-red-600">Akses ditolak. Hanya Super Admin yang dapat mengakses halaman ini.</p></div>';
        }

        return `
            <div class="max-w-4xl">
                <h1 class="text-2xl font-bold text-slate-800 mb-6">ğŸ‘‘ Super Admin Panel</h1>
                
                <div class="grid lg:grid-cols-2 gap-6 mb-6">
                    <div class="card">
                        <h3 class="font-bold mb-4">âš™ï¸ Pengaturan Global</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">Nomor WhatsApp Upgrade</label>
                                <input type="text" id="admin-wa" class="input-field" value="${AppState.settings.waNumber || ''}" placeholder="62812xxx">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">NPSN Premium (pisahkan dengan koma)</label>
                                <textarea id="admin-premium-npsn" class="input-field h-20" placeholder="12345678,87654321">${(AppState.settings.premiumNPSN || []).join(',')}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">NPSN Guru PAI Gratis</label>
                                <textarea id="admin-pai-npsn" class="input-field h-20" placeholder="12345678,87654321">${(AppState.settings.paiNPSN || []).join(',')}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Email User Premium</label>
                                <textarea id="admin-premium-users" class="input-field h-20" placeholder="user@gmail.com">${(AppState.settings.premiumUsers || []).join('\n')}</textarea>
                            </div>
                            
                            <button onclick="PageScripts.saveAdminSettings()" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 rounded-lg transition">
                                ğŸ’¾ Simpan Pengaturan
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="font-bold mb-4">ğŸ“Š Statistik</h3>
                        <div id="admin-stats" class="space-y-3">
                            <p class="text-slate-500">Memuat statistik...</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="font-bold mb-4">ğŸ« Daftar Sekolah Terdaftar</h3>
                    <div id="admin-schools" class="overflow-x-auto">
                        <p class="text-slate-500">Memuat data...</p>
                    </div>
                </div>
            </div>
        `;
    },

    initPageScripts(page) {
        switch (page) {
            case 'profil-guru':
                document.getElementById('form-profil-guru')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const data = {
                        name: document.getElementById('guru-nama').value,
                        nip: document.getElementById('guru-nip').value,
                        tipeGuru: document.getElementById('guru-tipe').value,
                        rombel: document.getElementById('guru-rombel').value
                    };
                    await ProfileSystem.saveProfile(data);
                });
                break;

            case 'profil-sekolah':
                document.getElementById('form-profil-sekolah')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const data = {
                        npsn: document.getElementById('sekolah-npsn').value,
                        nama: document.getElementById('sekolah-nama').value,
                        alamat: document.getElementById('sekolah-alamat').value,
                        kota: document.getElementById('sekolah-kota').value,
                        kepsek: document.getElementById('sekolah-kepsek').value,
                        nipKepsek: document.getElementById('sekolah-nip-kepsek').value
                    };
                    await SchoolSystem.saveSchool(data);
                });
                break;

            case 'data-siswa':
                // Populate textarea with existing data
                if (AppState.students.length > 0) {
                    document.getElementById('input-siswa').value = AppState.students.map(s => {
                        if (typeof s === 'object') {
                            return `${s.nama};${s.jk || ''};${s.kelas || ''}`;
                        }
                        return s;
                    }).join('\n');
                }
                break;

            case 'kurikulum':
                PageScripts.updateKurikulumDropdowns();
                break;

            case 'kalender':
                CalendarSystem.init();
                PageScripts.generateKalender();
                break;

            case 'doc-atp':
                PageScripts.generateATP();
                break;

            case 'bank-soal':
                PageScripts.populateSoalTP();
                break;

            case 'super-admin':
                PageScripts.loadAdminData();
                break;
        }
    },

    toggleSidebar(show = null) {
        const sidebar = document.getElementById('app-sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        
        if (show === null) {
            show = sidebar.classList.contains('-translate-x-full');
        }

        if (show) {
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
        } else {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        }
    },

    openModal(id) {
        document.getElementById(id).style.display = 'flex';
    },

    closeModal(id) {
        document.getElementById(id).style.display = 'none';
    },

    showAIAssistant() {
        this.openModal('modal-ai');
        AISystem.switchTab('guide');
    },

    showLoading(text = 'Memuat...') {
        document.getElementById('loading-text').textContent = text;
        document.getElementById('loading-overlay').classList.remove('hidden');
    },

    hideLoading() {
        document.getElementById('loading-overlay').classList.add('hidden');
    },

    showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const icon = document.getElementById('toast-icon');
        const msg = document.getElementById('toast-message');
        
        icon.textContent = type === 'success' ? 'âœ“' : 'âœ—';
        msg.textContent = message;
        toast.classList.remove('hidden');
        
        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }
};

// ==================== PAGE SCRIPTS ====================
const PageScripts = {
    saveSiswa() {
        const input = document.getElementById('input-siswa').value;
        const lines = input.split('\n').filter(l => l.trim());
        
        AppState.students = lines.map(line => {
            const parts = line.split(';');
            return {
                nama: parts[0]?.trim() || '',
                jk: parts[1]?.trim() || '',
                kelas: parts[2]?.trim() || ''
            };
        });

        localStorage.setItem('agsa_students', JSON.stringify(AppState.students));
        UISystem.showToast(`Berhasil menyimpan ${AppState.students.length} data siswa`);
        UISystem.navigateTo('data-siswa');
    },

    importSiswaCSV() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.csv';
        input.onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.getElementById('input-siswa').value = ev.target.result;
            };
            reader.readAsText(file);
        };
        input.click();
    },

    loadKurikulum() {
        const jenjang = document.getElementById('select-jenjang').value;
        CurriculumSystem.fetchFromCloud(jenjang);
    },

    uploadCSV(input) {
        if (input.files[0]) {
            CurriculumSystem.uploadCSV(input.files[0]);
        }
    },

    updateKurikulumDropdowns() {
        const mapelSelect = document.getElementById('select-mapel');
        if (!mapelSelect) return;

        const mapels = CurriculumSystem.getMapels();
        mapelSelect.innerHTML = '<option value="">-- Pilih Mapel --</option>' + 
            mapels.map(m => `<option value="${m}" ${AppState.selectedMapel === m ? 'selected' : ''}>${m}</option>`).join('');

        if (AppState.selectedMapel) {
            this.onMapelChange();
        }
    },

    onMapelChange() {
        const mapel = document.getElementById('select-mapel').value;
        AppState.selectedMapel = mapel;

        const kelasSelect = document.getElementById('select-kelas');
        const kelasList = CurriculumSystem.getKelas(mapel);
        kelasSelect.innerHTML = '<option value="">-</option>' + 
            kelasList.map(k => `<option value="${k}">${k} (${AppState.faseMap[k] || '-'})</option>`).join('');

        document.getElementById('select-semester').innerHTML = '<option value="">-</option>';
        document.getElementById('select-elemen').innerHTML = '<option value="">-</option>';
        document.getElementById('list-tp').innerHTML = '<p class="text-slate-500 italic">Pilih kelas dan semester</p>';
    },

    onKelasChange() {
        const kelas = document.getElementById('select-kelas').value;
        AppState.selectedKelas = kelas;

        const semesterSelect = document.getElementById('select-semester');
        const semesters = CurriculumSystem.getSemesters(AppState.selectedMapel, kelas);
        semesterSelect.innerHTML = '<option value="">-</option>' + 
            semesters.map(s => `<option value="${s}">${s}</option>`).join('');

        document.getElementById('select-elemen').innerHTML = '<option value="">-</option>';
    },

    onSemesterChange() {
        const semester = document.getElementById('select-semester').value;
        AppState.selectedSemester = semester;

        const elemenSelect = document.getElementById('select-elemen');
        const elemens = CurriculumSystem.getElemen(AppState.selectedMapel, AppState.selectedKelas, semester);
        elemenSelect.innerHTML = '<option value="">-- Semua Elemen --</option>' + 
            elemens.map(e => `<option value="${e}">${e.substring(0, 50)}...</option>`).join('');

        this.showTPPreview();
    },

    onElemenChange() {
        AppState.selectedElemen = document.getElementById('select-elemen').value;
        this.showTPPreview();
    },

    showTPPreview() {
        const tps = CurriculumSystem.getAllTP(AppState.selectedMapel, AppState.selectedKelas, AppState.selectedSemester);
        const container = document.getElementById('list-tp');
        
        if (tps.length === 0) {
            container.innerHTML = '<p class="text-slate-500 italic">Tidak ada data TP</p>';
            return;
        }

        container.innerHTML = tps.map((tp, i) => `
            <div class="p-3 bg-slate-50 rounded-lg">
                <div class="flex items-start gap-2">
                    <span class="w-6 h-6 bg-primary-600 text-white rounded-full flex items-center justify-center text-xs flex-shrink-0">${i + 1}</span>
                    <div>
                        <p class="font-medium text-slate-800">${tp.tp}</p>
                        <p class="text-xs text-slate-500 mt-1">Elemen: ${tp.elemen.substring(0, 50)}...</p>
                    </div>
                </div>
            </div>
        `).join('');
    },

    generateKalender() {
        // Update settings from inputs
        CalendarSystem.settings.masukGanjil = document.getElementById('cal-masuk-ganjil')?.value || CalendarSystem.settings.masukGanjil;
        CalendarSystem.settings.raporGanjil = document.getElementById('cal-rapor-ganjil')?.value || CalendarSystem.settings.raporGanjil;
        CalendarSystem.settings.masukGenap = document.getElementById('cal-masuk-genap')?.value || CalendarSystem.settings.masukGenap;
        CalendarSystem.settings.raporGenap = document.getElementById('cal-rapor-genap')?.value || CalendarSystem.settings.raporGenap;
        CalendarSystem.settings.hariMengajar = parseInt(document.getElementById('cal-hari')?.value || '1');
        CalendarSystem.settings.jpPertemuan = parseInt(document.getElementById('cal-jp')?.value || '4');
        CalendarSystem.settings.customHolidays = document.getElementById('cal-libur')?.value || DEFAULT_HOLIDAYS;

        CalendarSystem.generateCalendar();
        
        const identity = DocumentEngine.getIdentity();
        const container = document.getElementById('output-kalender');
        
        let html = `
            <div class="paper-preview portrait">
                <h1 class="text-center text-lg font-bold mb-6">KALENDER PENDIDIKAN & JADWAL PELAJARAN<br>TAHUN PELAJARAN ${identity.tahun}/${identity.tahun + 1}</h1>
                
                <table class="doc-table mb-6">
                    <tr><td width="150"><strong>Nama Sekolah</strong></td><td>: ${identity.sekolah}</td></tr>
                    <tr><td><strong>Mata Pelajaran</strong></td><td>: ${identity.mapel || '-'}</td></tr>
                    <tr><td><strong>Kelas/Semester</strong></td><td>: ${identity.kelas || '-'} / ${identity.semester || '-'}</td></tr>
                    <tr><td><strong>Guru</strong></td><td>: ${identity.guru}</td></tr>
                </table>
                
                <h3 class="font-bold mb-2">A. JADWAL MENGAJAR</h3>
                <table class="doc-table mb-6">
                    <thead>
                        <tr><th>Hari</th><th>Waktu</th><th>Mata Pelajaran</th><th>Kelas</th><th>JP</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-center font-bold">${HARI_IND[CalendarSystem.settings.hariMengajar]}</td>
                            <td class="text-center">Menyesuaikan</td>
                            <td class="font-bold">${identity.mapel || '-'}</td>
                            <td class="text-center">${identity.kelas || '-'}-${identity.rombel}</td>
                            <td class="text-center">${CalendarSystem.settings.jpPertemuan} JP</td>
                        </tr>
                    </tbody>
                </table>
                
                <h3 class="font-bold mb-2">B. RINCIAN AGENDA & HARI LIBUR</h3>
                <table class="doc-table">
                    <thead>
                        <tr><th width="30%">Tanggal</th><th>Keterangan</th></tr>
                    </thead>
                    <tbody>
                        ${this.renderEventList()}
                    </tbody>
                </table>
                
                ${DocumentEngine.generateSignature(identity)}
            </div>
        `;
        
        container.innerHTML = html;
    },

    renderEventList() {
        if (AppState.eventList.length === 0) {
            return '<tr><td colspan="2" class="text-center italic">Belum ada data kegiatan</td></tr>';
        }

        // Group consecutive events
        const grouped = [];
        let current = null;

        AppState.eventList.forEach(ev => {
            if (!current) {
                current = { start: ev.date, end: ev.date, name: ev.name };
            } else if (current.name === ev.name) {
                current.end = ev.date;
            } else {
                grouped.push(current);
                current = { start: ev.date, end: ev.date, name: ev.name };
            }
        });
        if (current) grouped.push(current);

        return grouped.map(g => {
            const dateText = g.start === g.end 
                ? CalendarSystem.formatDateIndo(g.start)
                : `${CalendarSystem.formatDateIndo(g.start)} s.d ${CalendarSystem.formatDateIndo(g.end)}`;
            const bgClass = g.name.toLowerCase().includes('libur') ? 'bg-red-50' : '';
            return `<tr class="${bgClass}"><td class="font-semibold">${dateText}</td><td>${g.name}</td></tr>`;
        }).join('');
    },

    generateATP() {
        if (!AppState.selectedMapel || !AppState.selectedKelas || !AppState.selectedSemester) {
            return;
        }

        const identity = DocumentEngine.getIdentity();
        const mode = document.getElementById('atp-mode')?.value || 'semester';
        const container = document.getElementById('output-atp');
        
        let dataToRender = [];
        
        if (mode === 'tahun') {
            ['Ganjil', 'Genap'].forEach(smt => {
                const data = AppState.curriculum[AppState.selectedMapel]?.[AppState.selectedKelas]?.[smt];
                if (data) {
                    Object.keys(data).forEach(elemen => {
                        dataToRender.push({ semester: smt, elemen, data: data[elemen] });
                    });
                }
            });
        } else {
            const data = AppState.curriculum[AppState.selectedMapel]?.[AppState.selectedKelas]?.[AppState.selectedSemester];
            if (data) {
                Object.keys(data).forEach(elemen => {
                    dataToRender.push({ semester: AppState.selectedSemester, elemen, data: data[elemen] });
                });
            }
        }

        if (dataToRender.length === 0) {
            container.innerHTML = '<div class="card text-center py-12"><p class="text-slate-500">Tidak ada data untuk ditampilkan</p></div>';
            return;
        }

        // Generate ATP Table
        let atpRows = '';
        let protaRows = '';
        let tpIndex = 0;

        dataToRender.forEach((item, idx) => {
            const tps = item.data.tps || [];
            const jp = CalendarSystem.settings.jpPertemuan || 4;
            const totalJP = tps.length * jp;

            tps.forEach((tp, tpIdx) => {
                tpIndex++;
                const kompetensi = this.extractKompetensi(tp.tp);
                
                atpRows += `<tr>`;
                if (tpIdx === 0) {
                    atpRows += `
                        <td rowspan="${tps.length}" class="text-center align-middle">${idx + 1}</td>
                        <td rowspan="${tps.length}" class="align-middle bg-slate-50" contenteditable="true">
                            <strong class="text-blue-800">${item.elemen}</strong>
                            <hr class="my-2 border-slate-300">
                            <span class="text-xs text-slate-600">${item.data.cp}</span>
                        </td>
                    `;
                }
                atpRows += `
                    <td contenteditable="true">${tp.tp}</td>
                    <td class="text-xs text-center">Beriman, Bernalar Kritis</td>
                    <td class="text-center font-semibold text-amber-600">${kompetensi}</td>
                `;
                if (tpIdx === 0) {
                    atpRows += `<td rowspan="${tps.length}" class="text-center align-middle">${tps.length} Minggu<br>${totalJP} JP</td>`;
                }
                atpRows += `</tr>`;

                // Prota rows
                protaRows += `<tr>`;
                if (tpIdx === 0) {
                    protaRows += `
                        <td rowspan="${tps.length}" class="text-center align-middle font-bold">${item.semester}</td>
                        <td rowspan="${tps.length}" class="align-middle bg-slate-50" contenteditable="true">
                            <strong class="text-blue-800">${item.elemen}</strong>
                            <hr class="my-2 border-slate-300">
                            <span class="text-xs text-slate-600">${item.data.cp}</span>
                        </td>
                    `;
                }
                protaRows += `<td contenteditable="true">${tp.tp}</td>`;
                if (tpIdx === 0) {
                    protaRows += `<td rowspan="${tps.length}" class="text-center align-middle font-bold">${totalJP} JP</td>`;
                }
                protaRows += `</tr>`;
            });
        });

        const fase = AppState.faseMap[AppState.selectedKelas] || '';
        const faseText = fase.toLowerCase().includes('fase') ? fase : `Fase ${fase}`;

        container.innerHTML = `
            <!-- ATP Document -->
            <div class="paper-preview landscape">
                <h1 class="text-center text-lg font-bold mb-6 uppercase" contenteditable="true">
                    ALUR TUJUAN PEMBELAJARAN (ATP)<br>
                    TAHUN PELAJARAN ${identity.tahun}/${identity.tahun + 1}
                </h1>
                
                <div class="flex justify-between mb-4 text-sm font-semibold" contenteditable="true">
                    <table>
                        <tr><td width="150">NAMA SEKOLAH</td><td>: ${identity.sekolah}</td></tr>
                        <tr><td>MATA PELAJARAN</td><td>: <span class="text-blue-700">${identity.mapel}</span></td></tr>
                        <tr><td>FASE</td><td>: ${faseText}</td></tr>
                    </table>
                    <table>
                        <tr><td width="100">KELAS</td><td>: ${identity.kelas}</td></tr>
                        <tr><td>SEMESTER</td><td>: ${mode === 'tahun' ? 'Ganjil & Genap' : identity.semester}</td></tr>
                    </table>
                </div>
                
                <table class="doc-table">
                    <thead>
                        <tr>
                            <th width="4%">NO</th>
                            <th width="22%">ELEMEN DAN CAPAIAN PEMBELAJARAN (CP)</th>
                            <th width="24%">TUJUAN PEMBELAJARAN (TP)</th>
                            <th width="15%">PROFIL PELAJAR PANCASILA</th>
                            <th width="10%">KOMPETENSI</th>
                            <th width="10%">WAKTU</th>
                        </tr>
                    </thead>
                    <tbody>${atpRows}</tbody>
                </table>
                
                ${DocumentEngine.generateSignature(identity)}
            </div>
            
            <!-- PROTA Document -->
            <div class="paper-preview portrait mt-8">
                <h1 class="text-center text-lg font-bold mb-6 uppercase" contenteditable="true">
                    PROGRAM TAHUNAN (PROTA)<br>
                    <span class="text-blue-700">${identity.mapel}</span>
                </h1>
                
                <table class="doc-table mb-4" contenteditable="true">
                    <tr><td width="150"><strong>Satuan Pendidikan</strong></td><td>: ${identity.sekolah}</td></tr>
                    <tr><td><strong>Fase / Kelas</strong></td><td>: ${faseText} / ${identity.kelas}</td></tr>
                    <tr><td><strong>Tahun Pelajaran</strong></td><td>: ${identity.tahun}/${identity.tahun + 1}</td></tr>
                </table>
                
                <table class="doc-table">
                    <thead>
                        <tr>
                            <th width="10%">Semester</th>
                            <th width="30%">Elemen & Capaian Pembelajaran</th>
                            <th width="50%">Tujuan Pembelajaran (TP)</th>
                            <th width="10%">JP</th>
                        </tr>
                    </thead>
                    <tbody>${protaRows}</tbody>
                </table>
                
                ${DocumentEngine.generateSignature(identity)}
            </div>
        `;
    },

    extractKompetensi(tpText) {
        const keywords = ['menganalisis', 'mengevaluasi', 'mencipta', 'memahami', 'menerapkan', 'mengingat', 'menjelaskan', 'membandingkan', 'menyusun', 'mengidentifikasi'];
        for (const kw of keywords) {
            if (tpText.toLowerCase().includes(kw)) {
                return kw.charAt(0).toUpperCase() + kw.slice(1);
            }
        }
        return 'Memahami';
    },

    generatePromes() {
        if (!AppState.selectedMapel || !AppState.selectedKelas || !AppState.selectedSemester) {
            return;
        }

        const identity = DocumentEngine.getIdentity();
        const container = document.getElementById('output-promes');
        const year = identity.tahun;
        const semester = AppState.selectedSemester;
        
        // Get months for semester
        const startMonth = semester === 'Ganjil' ? 6 : 0;
        const months = [];
        for (let i = 0; i < 6; i++) {
            let m = startMonth + i;
            let y = year;
            if (m > 11) { m -= 12; y++; }
            months.push({ month: m, year: y, name: BULAN_IND[m].substring(0, 3) });
        }

        // Get TPs
        const allTP = CurriculumSystem.getAllTP(AppState.selectedMapel, AppState.selectedKelas, semester);
        if (allTP.length === 0) {
            container.innerHTML = '<div class="card text-center py-12"><p class="text-slate-500">Tidak ada data TP</p></div>';
            return;
        }

        // Get teaching dates
        const teachingDates = CalendarSystem.getTeachingDates(semester, year);
        
        // Build header
        let headerRow1 = '<th rowspan="2" width="15%">Elemen</th><th rowspan="2" width="25%">Tujuan Pembelajaran</th><th rowspan="2" width="4%">JP</th>';
        let headerRow2 = '';
        
        months.forEach(mo => {
            headerRow1 += `<th colspan="5">${mo.name}</th>`;
            for (let w = 1; w <= 5; w++) {
                headerRow2 += `<th class="text-xs">${w}</th>`;
            }
        });

        // Build body with teaching dates mapping
        let bodyRows = '';
        let tpDateIndex = 0;
        let currentElemen = '';
        
        allTP.forEach((tp, idx) => {
            const jp = CalendarSystem.settings.jpPertemuan;
            const isNewElemen = tp.elemen !== currentElemen;
            currentElemen = tp.elemen;
            
            bodyRows += '<tr>';
            
            if (isNewElemen) {
                // Count TPs in this elemen
                const elemenTPs = allTP.filter(t => t.elemen === tp.elemen).length;
                bodyRows += `<td rowspan="${elemenTPs}" class="align-middle text-xs bg-slate-50" contenteditable="true">${tp.elemen.substring(0, 80)}...</td>`;
            }
            
            bodyRows += `<td class="text-xs" contenteditable="true">${tp.tp}</td>`;
            bodyRows += `<td class="text-center font-bold">${jp}</td>`;
            
            // Get teaching date for this TP
            const tpDate = teachingDates[tpDateIndex];
            tpDateIndex++;
            
            // Generate week cells
            for (let m = 0; m < 6; m++) {
                const mo = months[m];
                for (let w = 1; w <= 5; w++) {
                    // Check if this TP's teaching date falls in this week
                    let cellContent = '';
                    let cellClass = '';
                    
                    if (tpDate) {
                        const tpMonth = tpDate.dateObj.getMonth();
                        const tpDay = tpDate.dateObj.getDate();
                        const weekNum = Math.ceil(tpDay / 7);
                        
                        if (tpMonth === mo.month && weekNum === w) {
                            cellContent = tpDay;
                            cellClass = 'bg-blue-100 font-bold text-blue-800 text-center';
                        }
                    }
                    
                    // Check for holidays in this week
                    const weekStart = (w - 1) * 7 + 1;
                    const weekEnd = Math.min(w * 7, new Date(mo.year, mo.month + 1, 0).getDate());
                    
                    for (let d = weekStart; d <= weekEnd; d++) {
                        const dateStr = `${mo.year}-${String(mo.month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                        if (AppState.calendarEvents[dateStr] && !cellContent) {
                            const evName = AppState.calendarEvents[dateStr];
                            if (evName.toLowerCase().includes('libur')) {
                                cellClass = 'event-cell';
                                if (idx === 0) {
                                    cellContent = `<div class="vertical-text">${evName.substring(0, 15)}</div>`;
                                }
                            }
                        }
                    }
                    
                    bodyRows += `<td class="${cellClass}">${cellContent}</td>`;
                }
            }
            
            bodyRows += '</tr>';
        });

        container.innerHTML = `
            <div class="paper-preview landscape">
                <h1 class="text-center text-lg font-bold mb-6 uppercase" contenteditable="true">
                    PROGRAM SEMESTER (PROSEM)<br>
                    SEMESTER ${semester.toUpperCase()}
                </h1>
                
                <table class="doc-table mb-4 w-1/2" contenteditable="true">
                    <tr><td width="150"><strong>Mata Pelajaran</strong></td><td>: <span class="text-blue-700">${identity.mapel}</span></td></tr>
                    <tr><td><strong>Kelas / Rombel</strong></td><td>: ${identity.kelas} / ${identity.rombel}</td></tr>
                    <tr><td><strong>Tahun Pelajaran</strong></td><td>: ${identity.tahun}/${identity.tahun + 1}</td></tr>
                </table>
                
                <table class="doc-table text-xs">
                    <thead>
                        <tr>${headerRow1}</tr>
                        <tr>${headerRow2}</tr>
                    </thead>
                    <tbody>${bodyRows}</tbody>
                </table>
                
                ${DocumentEngine.generateSignature(identity)}
            </div>
        `;
    },

    generateModul() {
        if (!AppState.selectedMapel || !AppState.selectedKelas || !AppState.selectedSemester || !AppState.selectedElemen) {
            document.getElementById('output-modul').innerHTML = `
                <div class="card text-center py-12">
                    <p class="text-slate-500">Pilih Elemen/Bab di menu Kurikulum untuk generate Modul Ajar</p>
                </div>
            `;
            return;
        }

        const identity = DocumentEngine.getIdentity();
        const data = CurriculumSystem.getTP(AppState.selectedMapel, AppState.selectedKelas, AppState.selectedSemester, AppState.selectedElemen);
        
        if (!data) {
            document.getElementById('output-modul').innerHTML = '<div class="card"><p class="text-red-500">Data tidak ditemukan</p></div>';
            return;
        }

        const jp = CalendarSystem.settings.jpPertemuan;
        const totalJP = data.tps.length * jp;

        // Generate learning steps
        let stepsHtml = '';
        data.tps.forEach((tp, idx) => {
            stepsHtml += `
                <div class="mb-6 p-4 bg-slate-50 rounded-lg border" contenteditable="true">
                    <h4 class="font-bold text-blue-800 border-b-2 pb-2 mb-3">Pertemuan ${idx + 1} (${jp} JP)</h4>
                    
                    <div class="mb-3">
                        <p class="font-semibold underline">A. Pendahuluan (15 Menit)</p>
                        <ul class="list-decimal pl-6 mt-1 text-sm">
                            <li>Guru mengucapkan salam, mengajak berdoa, dan mengecek kehadiran siswa.</li>
                            <li>Guru memberikan apersepsi yang mengaitkan pengalaman siswa dengan topik pembelajaran.</li>
                            <li>Guru menyampaikan tujuan pembelajaran hari ini: "${tp.tp}"</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <p class="font-semibold underline">B. Kegiatan Inti (60 Menit)</p>
                        <ul class="list-decimal pl-6 mt-1 text-sm">
                            <li><strong>Orientasi:</strong> Siswa mengamati dan menyimak penjelasan guru tentang materi.</li>
                            <li><strong>Eksplorasi:</strong> Siswa berdiskusi dan mengerjakan LKPD secara berkelompok.</li>
                            <li><strong>Komunikasi:</strong> Perwakilan kelompok mempresentasikan hasil diskusi.</li>
                            <li><strong>Refleksi:</strong> Guru memberikan umpan balik dan penguatan konsep.</li>
                        </ul>
                    </div>
                    
                    <div>
                        <p class="font-semibold underline">C. Penutup (15 Menit)</p>
                        <ul class="list-decimal pl-6 mt-1 text-sm">
                            <li>Siswa bersama guru menyimpulkan materi pembelajaran.</li>
                            <li>Guru memberikan tugas/PR dan informasi pertemuan berikutnya.</li>
                            <li>Pembelajaran ditutup dengan doa dan salam.</li>
                        </ul>
                    </div>
                </div>
            `;
        });

        // Generate TP list
        const tpListHtml = data.tps.map((tp, idx) => `<li><strong>Pertemuan ${idx + 1}:</strong> ${tp.tp}</li>`).join('');

        document.getElementById('output-modul').innerHTML = `
            <!-- Modul Ajar -->
            <div class="paper-preview portrait">
                <h1 class="text-center text-lg font-bold mb-6 uppercase" contenteditable="true">
                    MODUL AJAR KURIKULUM MERDEKA
                </h1>
                
                <div class="font-bold bg-slate-100 p-2 border-l-4 border-blue-600 mb-3">A. IDENTITAS UMUM</div>
                <table class="doc-table mb-4" contenteditable="true">
                    <tr><td width="150"><strong>Nama Penyusun</strong></td><td>: ${identity.guru} (${identity.sekolah})</td></tr>
                    <tr><td><strong>Mata Pelajaran</strong></td><td>: ${identity.mapel}</td></tr>
                    <tr><td><strong>Kelas / Semester</strong></td><td>: ${identity.kelas} / ${identity.semester}</td></tr>
                    <tr><td><strong>Topik Materi</strong></td><td>: <span class="text-blue-700 font-bold">${AppState.selectedElemen}</span></td></tr>
                    <tr><td><strong>Alokasi Waktu</strong></td><td>: ${totalJP} JP (${data.tps.length} Pertemuan)</td></tr>
                </table>
                
                <div class="font-bold bg-slate-100 p-2 border-l-4 border-blue-600 mb-3">B. CAPAIAN & TUJUAN PEMBELAJARAN</div>
                <div class="mb-4 pl-4" contenteditable="true">
                    <p class="mb-2 bg-blue-50 p-3 rounded border text-sm"><strong>Capaian Pembelajaran:</strong><br>${data.cp}</p>
                    <p class="font-semibold">Tujuan Pembelajaran:</p>
                    <ul class="list-decimal pl-6 text-sm">${tpListHtml}</ul>
                </div>
                
                <div class="font-bold bg-slate-100 p-2 border-l-4 border-blue-600 mb-3">C. LANGKAH-LANGKAH PEMBELAJARAN</div>
                <div class="pl-4">${stepsHtml}</div>
                
                ${DocumentEngine.generateSignature(identity)}
            </div>
            
            <!-- LKPD (tanpa tanda tangan) -->
            <div class="paper-preview portrait mt-8">
                <div class="border-2 border-dashed border-blue-600 p-6 rounded-xl bg-slate-50">
                    <h1 class="text-center text-lg font-bold text-blue-800 mb-4 uppercase" contenteditable="true">
                        LEMBAR KERJA PESERTA DIDIK (LKPD)
                    </h1>
                    
                    <div class="flex justify-between border-b border-black pb-2 mb-4 font-semibold text-sm" contenteditable="true">
                        <span>Nama Kelompok : .......................</span>
                        <span>Kelas: ${identity.kelas}/${identity.rombel}</span>
                        <span>Nilai : .....</span>
                    </div>
                    
                    <p class="font-bold text-blue-700">Mata Pelajaran: ${identity.mapel}</p>
                    <p class="font-bold text-blue-700 mb-4">Materi: ${AppState.selectedElemen}</p>
                    
                    <div contenteditable="true">
                        <p class="font-bold text-blue-800 text-sm">A. Tujuan Kegiatan:</p>
                        <ul class="mb-4 bg-white p-3 border rounded list-disc pl-6 text-sm">${tpListHtml}</ul>
                        
                        <p class="font-bold text-blue-800 text-sm">B. Petunjuk Pengerjaan:</p>
                        <ol class="list-decimal pl-6 mb-6 text-sm">
                            <li>Berdoalah terlebih dahulu sebelum memulai aktivitas.</li>
                            <li>Diskusikan instruksi di bawah ini bersama kelompokmu.</li>
                            <li>Tuliskan hasil diskusi dengan rapi dan jelas.</li>
                        </ol>
                        
                        <p class="font-bold text-blue-800 text-sm border-b-2 pb-2">C. Kolom Pengerjaan:</p>
                        <div class="space-y-6 mt-4">
                            <div>
                                <p class="font-semibold text-sm mb-2">1. Tuliskan pemahaman utamamu mengenai materi ini!</p>
                                <div class="border border-slate-400 bg-white p-4 rounded-lg min-h-[100px]"></div>
                            </div>
                            <div>
                                <p class="font-semibold text-sm mb-2">2. Berikan contoh penerapan materi di lingkungan sekitarmu!</p>
                                <div class="border border-slate-400 bg-white p-4 rounded-lg min-h-[100px]"></div>
                            </div>
                            <div>
                                <p class="font-semibold text-sm mb-2">3. Apa kesimpulan yang dapat kamu ambil dari pembelajaran hari ini?</p>
                                <div class="border border-slate-400 bg-white p-4 rounded-lg min-h-[100px]"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    generateJurnal() {
        if (!AppState.selectedMapel || !AppState.selectedSemester) {
            document.getElementById('output-jurnal').innerHTML = `
                <div class="card text-center py-12">
                    <p class="text-slate-500">Pilih Mapel dan Semester terlebih dahulu</p>
                </div>
            `;
            return;
        }

        const identity = DocumentEngine.getIdentity();
        const semester = AppState.selectedSemester;
        const year = identity.tahun;
        const teachingDates = CalendarSystem.getTeachingDates(semester, year);
        const allTP = CurriculumSystem.getAllTP(AppState.selectedMapel, AppState.selectedKelas, semester);

        if (teachingDates.length === 0 || allTP.length === 0) {
            document.getElementById('output-jurnal').innerHTML = `
                <div class="card text-center py-12">
                    <p class="text-slate-500">Generate kalender terlebih dahulu</p>
                </div>
            `;
            return;
        }

        // Group by month
        const byMonth = {};
        teachingDates.forEach((td, idx) => {
            const month = td.dateObj.getMonth();
            const monthYear = `${month}-${td.dateObj.getFullYear()}`;
            if (!byMonth[monthYear]) {
                byMonth[monthYear] = [];
            }
            byMonth[monthYear].push({
                ...td,
                tp: allTP[idx] || allTP[allTP.length - 1]
            });
        });

        let html = '';
        Object.keys(byMonth).forEach(key => {
            const [monthStr, yearStr] = key.split('-');
            const month = parseInt(monthStr);
            const yr = parseInt(yearStr);
            const items = byMonth[key];

            let rows = items.map((item, idx) => {
                const dateStr = `${String(item.dateObj.getDate()).padStart(2, '0')}/${String(month + 1).padStart(2, '0')}/${yr}`;
                return `
                    <tr>
                        <td class="text-center font-bold">${dateStr}</td>
                        <td class="text-center" contenteditable="true">${identity.kelas}/${identity.rombel}</td>
                        <td contenteditable="true">${item.tp?.elemen?.substring(0, 30) || '-'}...</td>
                        <td contenteditable="true">${item.tp?.tp || '-'}</td>
                        <td class="text-center font-bold text-blue-700" contenteditable="true">Hadir Semua</td>
                        <td contenteditable="true">Berjalan Lancar</td>
                    </tr>
                `;
            }).join('');

            html += `
                <div class="paper-preview landscape mb-8">
                    <h1 class="text-center text-lg font-bold mb-6 uppercase" contenteditable="true">
                        JURNAL PELAKSANAAN PEMBELAJARAN<br>
                        BULAN ${BULAN_IND[month].toUpperCase()} ${yr}
                    </h1>
                    
                    <table class="doc-table mb-4 w-1/2" contenteditable="true">
                        <tr><td width="150"><strong>Mata Pelajaran</strong></td><td>: ${identity.mapel}</td></tr>
                        <tr><td><strong>Guru</strong></td><td>: ${identity.guru}</td></tr>
                    </table>
                    
                    <table class="doc-table text-sm">
                        <thead>
                            <tr>
                                <th width="10%">Tanggal</th>
                                <th width="10%">Kelas</th>
                                <th width="15%">Materi</th>
                                <th width="35%">Tujuan Pembelajaran</th>
                                <th width="12%">Kehadiran</th>
                                <th width="18%">Keterangan</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                    
                    ${DocumentEngine.generateSignature(identity)}
                </div>
            `;
        });

        document.getElementById('output-jurnal').innerHTML = html;
    },

    generateAbsensi() {
        if (AppState.students.length === 0) {
            document.getElementById('output-absensi').innerHTML = `
                <div class="card text-center py-12">
                    <p class="text-slate-500">Input data siswa terlebih dahulu</p>
                    <button onclick="UISystem.navigateTo('data-siswa')" class="mt-4 bg-primary-600 hover:bg-primary-700 text-white py-2 px-6 rounded-lg">
                        Input Siswa
                    </button>
                </div>
            `;
            return;
        }

        const identity = DocumentEngine.getIdentity();
        const semester = AppState.selectedSemester || 'Ganjil';
        const year = identity.tahun;
        const teachingDates = CalendarSystem.getTeachingDates(semester, year);

        // Group by month
        const byMonth = {};
        teachingDates.forEach(td => {
            const monthYear = `${td.dateObj.getMonth()}-${td.dateObj.getFullYear()}`;
            if (!byMonth[monthYear]) byMonth[monthYear] = [];
            byMonth[monthYear].push(td);
        });

        let html = '';
        Object.keys(byMonth).forEach(key => {
            const [monthStr, yearStr] = key.split('-');
            const month = parseInt(monthStr);
            const yr = parseInt(yearStr);
            const dates = byMonth[key];

            // Header with dates
            let dateHeaders = dates.map(d => `<th class="text-xs">${d.dateObj.getDate()}</th>`).join('');
            
            // Student rows
            let studentRows = AppState.students.map((student, idx) => {
                const name = typeof student === 'object' ? student.nama : student;
                const cells = dates.map(() => `
                    <td class="text-center">
                        <span class="cursor-pointer font-bold text-blue-600 hover:bg-blue-100 px-2 py-1 rounded" 
                              onclick="PageScripts.toggleAbsen(this)">H</span>
                    </td>
                `).join('');
                
                return `
                    <tr>
                        <td class="text-center">${idx + 1}</td>
                        <td contenteditable="true">${name}</td>
                        ${cells}
                        <td class="text-center font-bold bg-slate-50 tot-h">${dates.length}</td>
                        <td class="text-center font-bold bg-slate-50 tot-s">0</td>
                        <td class="text-center font-bold bg-slate-50 tot-i">0</td>
                        <td class="text-center font-bold bg-slate-50 tot-a">0</td>
                    </tr>
                `;
            }).join('');

            html += `
                <div class="paper-preview portrait mb-8">
                    <h1 class="text-center text-lg font-bold mb-6 uppercase" contenteditable="true">
                        DAFTAR HADIR SISWA<br>
                        BULAN ${BULAN_IND[month].toUpperCase()} ${yr}
                    </h1>
                    
                    <table class="doc-table mb-4 w-1/2" contenteditable="true">
                        <tr><td width="150"><strong>Mata Pelajaran</strong></td><td>: ${identity.mapel}</td></tr>
                        <tr><td><strong>Kelas</strong></td><td>: ${identity.kelas}/${identity.rombel}</td></tr>
                    </table>
                    
                    <table class="doc-table text-xs">
                        <thead>
                            <tr>
                                <th rowspan="2" width="4%">No</th>
                                <th rowspan="2" width="20%">Nama Siswa</th>
                                <th colspan="${dates.length}">Tanggal Pertemuan</th>
                                <th colspan="4" class="bg-blue-50">Jumlah</th>
                            </tr>
                            <tr>
                                ${dateHeaders}
                                <th class="bg-blue-50">H</th>
                                <th class="bg-blue-50">S</th>
                                <th class="bg-blue-50">I</th>
                                <th class="bg-blue-50">A</th>
                            </tr>
                        </thead>
                        <tbody>${studentRows}</tbody>
                    </table>
                    
                    <p class="text-xs mt-2 text-slate-500">Keterangan: H=Hadir, S=Sakit, I=Izin, A=Alpha. Klik huruf untuk mengubah status.</p>
                    
                    ${DocumentEngine.generateSignature(identity)}
                </div>
            `;
        });

        document.getElementById('output-absensi').innerHTML = html || `
            <div class="card text-center py-12">
                <p class="text-slate-500">Generate kalender terlebih dahulu</p>
            </div>
        `;
    },

    toggleAbsen(el) {
        const states = { 'H': 'S', 'S': 'I', 'I': 'A', 'A': 'H' };
        const colors = { 'H': 'text-blue-600', 'S': 'text-amber-600', 'I': 'text-purple-600', 'A': 'text-red-600' };
        
        const current = el.textContent.trim();
        const next = states[current] || 'H';
        
        el.textContent = next;
        el.className = `cursor-pointer font-bold ${colors[next]} hover:bg-blue-100 px-2 py-1 rounded`;
        
        // Update totals
        const row = el.closest('tr');
        if (row) {
            const cells = row.querySelectorAll('td span');
            let counts = { H: 0, S: 0, I: 0, A: 0 };
            cells.forEach(cell => {
                const val = cell.textContent.trim();
                if (counts[val] !== undefined) counts[val]++;
            });
            
            const totH = row.querySelector('.tot-h');
            const totS = row.querySelector('.tot-s');
            const totI = row.querySelector('.tot-i');
            const totA = row.querySelector('.tot-a');
            
            if (totH) totH.textContent = counts.H;
            if (totS) totS.textContent = counts.S;
            if (totI) totI.textContent = counts.I;
            if (totA) totA.textContent = counts.A;
        }
    },

    generateKKTP() {
        const identity = DocumentEngine.getIdentity();
        const allTP = CurriculumSystem.getAllTP(AppState.selectedMapel, AppState.selectedKelas, AppState.selectedSemester);

        if (allTP.length === 0) {
            document.getElementById('output-kktp').innerHTML = `
                <div class="card text-center py-12">
                    <p class="text-slate-500">Pilih Mapel, Kelas, dan Semester terlebih dahulu</p>
                </div>
            `;
            return;
        }

        // KKTP Rows
        let kktpRows = allTP.map((tp, idx) => `
            <tr>
                <td class="text-center">${idx + 1}</td>
                <td contenteditable="true">${tp.tp}</td>
                <td class="text-center bg-yellow-50" contenteditable="true" oninput="PageScripts.calcKKTP(this)">75</td>
                <td class="text-center bg-yellow-50" contenteditable="true" oninput="PageScripts.calcKKTP(this)">75</td>
                <td class="text-center bg-yellow-50" contenteditable="true" oninput="PageScripts.calcKKTP(this)">75</td>
                <td class="text-center font-bold bg-blue-50 kktp-result">75</td>
            </tr>
        `).join('');

        // Nilai Rows
        let nilaiRows = AppState.students.map((student, idx) => {
            const name = typeof student === 'object' ? student.nama : student;
            return `
                <tr>
                    <td class="text-center">${idx + 1}</td>
                    <td contenteditable="true">${name}</td>
                    <td class="text-center" contenteditable="true"></td>
                    <td class="text-center" contenteditable="true"></td>
                    <td class="text-center" contenteditable="true"></td>
                    <td class="text-center" contenteditable="true"></td>
                    <td class="text-center font-bold bg-slate-50" contenteditable="true"></td>
                    <td class="text-center" contenteditable="true"></td>
                    <td class="text-center" contenteditable="true"></td>
                    <td class="text-center font-bold bg-blue-50 text-blue-800" contenteditable="true"></td>
                </tr>
            `;
        }).join('');

        document.getElementById('output-kktp').innerHTML = `
            <!-- KKTP -->
            <div class="paper-preview portrait">
                <h1 class="text-center text-lg font-bold mb-6 uppercase" contenteditable="true">
                    KRITERIA KETERCAPAIAN TUJUAN PEMBELAJARAN (KKTP)
                </h1>
                
                <table class="doc-table mb-4 w-1/2" contenteditable="true">
                    <tr><td width="150"><strong>Mata Pelajaran</strong></td><td>: ${identity.mapel}</td></tr>
                    <tr><td><strong>Kelas / Semester</strong></td><td>: ${identity.kelas} / ${identity.semester}</td></tr>
                </table>
                
                <table class="doc-table text-sm">
                    <thead>
                        <tr>
                            <th rowspan="2" width="5%">No</th>
                            <th rowspan="2" width="45%">Tujuan Pembelajaran</th>
                            <th colspan="3">Kriteria (Klik untuk Edit)</th>
                            <th rowspan="2" width="10%">KKTP</th>
                        </tr>
                        <tr>
                            <th class="text-xs">Kompleksitas</th>
                            <th class="text-xs">Daya Dukung</th>
                            <th class="text-xs">Intake Siswa</th>
                        </tr>
                    </thead>
                    <tbody>${kktpRows}</tbody>
                </table>
                
                <p class="text-xs italic text-slate-500 mt-2">*KKTP = rata-rata dari 3 kriteria</p>
                
                ${DocumentEngine.generateSignature(identity)}
            </div>
            
            <!-- Daftar Nilai -->
            <div class="paper-preview landscape mt-8">
                <h1 class="text-center text-lg font-bold mb-6 uppercase" contenteditable="true">
                    DAFTAR NILAI SUMATIF & FORMATIF
                </h1>
                
                <table class="doc-table mb-4 w-1/3" contenteditable="true">
                    <tr><td width="150"><strong>Mata Pelajaran</strong></td><td>: ${identity.mapel}</td></tr>
                    <tr><td><strong>Kelas / Semester</strong></td><td>: ${identity.kelas} / ${identity.semester}</td></tr>
                </table>
                
                <table class="doc-table text-xs text-center">
                    <thead>
                        <tr>
                            <th rowspan="2" width="4%">No</th>
                            <th rowspan="2" width="20%">Nama Siswa</th>
                            <th colspan="5">Nilai Sumatif Harian</th>
                            <th rowspan="2" width="6%">STS</th>
                            <th rowspan="2" width="6%">SAS</th>
                            <th rowspan="2" width="8%" class="bg-blue-100">NR</th>
                        </tr>
                        <tr>
                            <th>S1</th>
                            <th>S2</th>
                            <th>S3</th>
                            <th>S4</th>
                            <th>Rata2</th>
                        </tr>
                    </thead>
                    <tbody>${nilaiRows}</tbody>
                </table>
                
                ${DocumentEngine.generateSignature(identity)}
            </div>
        `;
    },

    calcKKTP(el) {
        const row = el.closest('tr');
        if (!row) return;
        
        const cells = row.querySelectorAll('td[contenteditable="true"]');
        let sum = 0;
        let count = 0;
        
        cells.forEach((cell, idx) => {
            if (idx >= 1 && idx <= 3) {
                const val = parseFloat(cell.textContent) || 0;
                sum += val;
                count++;
            }
        });
        
        const result = row.querySelector('.kktp-result');
        if (result && count > 0) {
            result.textContent = Math.round(sum / count);
        }
    },

    populateSoalTP() {
        const select = document.getElementById('soal-tp');
        if (!select) return;

        const tps = CurriculumSystem.getAllTP(AppState.selectedMapel, AppState.selectedKelas, AppState.selectedSemester);
        select.innerHTML = '<option value="">-- Pilih TP --</option>' + 
            tps.map((tp, i) => `<option value="${tp.tp}">${i + 1}. ${tp.tp.substring(0, 50)}...</option>`).join('');
    },

    importSoalCSV() {
        const csv = document.getElementById('input-soal-csv').value;
        if (!csv.trim()) {
            UISystem.showToast('Paste data CSV terlebih dahulu', 'error');
            return;
        }

        const questions = BankSoalSystem.parseCSV(csv);
        this.renderSoalList(questions);
        UISystem.showToast(`Berhasil import ${questions.length} soal`);
    },

    renderSoalList(questions) {
        const container = document.getElementById('list-soal');
        if (!questions || questions.length === 0) {
            container.innerHTML = '<p class="text-slate-500 italic text-center py-8">Belum ada soal</p>';
            return;
        }

        container.innerHTML = questions.map((q, idx) => `
            <div class="p-4 bg-slate-50 rounded-lg border">
                <div class="flex items-start gap-3">
                    <span class="w-8 h-8 bg-primary-600 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">${idx + 1}</span>
                    <div class="flex-1">
                        <p class="font-medium">${q.soal}</p>
                        <p class="text-sm text-green-600 mt-2"><strong>Jawaban:</strong> ${q.jawaban}</p>
                    </div>
                </div>
            </div>
        `).join('');
    },

    async loadAdminData() {
        if (!AppState.isSuperAdmin) return;

        // Load stats
        const statsContainer = document.getElementById('admin-stats');
        const schoolsContainer = document.getElementById('admin-schools');

        try {
            const users = await SuperAdminSystem.getAllUsers();
            const schools = await SuperAdminSystem.getAllSchools();

            // Stats
            const schoolsByNPSN = {};
            users.forEach(u => {
                if (u.npsn) {
                    if (!schoolsByNPSN[u.npsn]) schoolsByNPSN[u.npsn] = [];
                    schoolsByNPSN[u.npsn].push(u);
                }
            });

            statsContainer.innerHTML = `
                <div class="flex justify-between py-2 border-b">
                    <span>Total Users</span>
                    <span class="font-bold">${users.length}</span>
                </div>
                <div class="flex justify-between py-2 border-b">
                    <span>Total Sekolah</span>
                    <span class="font-bold">${schools.length}</span>
                </div>
                <div class="flex justify-between py-2">
                    <span>NPSN Terdaftar</span>
                    <span class="font-bold">${Object.keys(schoolsByNPSN).length}</span>
                </div>
            `;

            // Schools table
            if (schools.length === 0) {
                schoolsContainer.innerHTML = '<p class="text-slate-500">Belum ada sekolah terdaftar</p>';
            } else {
                schoolsContainer.innerHTML = `
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-slate-100">
                                <th class="px-3 py-2 text-left">NPSN</th>
                                <th class="px-3 py-2 text-left">Nama Sekolah</th>
                                <th class="px-3 py-2 text-center">Guru</th>
                                <th class="px-3 py-2 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${schools.map(s => `
                                <tr class="border-b">
                                    <td class="px-3 py-2 font-mono">${s.npsn || s.id}</td>
                                    <td class="px-3 py-2">${s.nama || '-'}</td>
                                    <td class="px-3 py-2 text-center">${(schoolsByNPSN[s.npsn] || []).length}</td>
                                    <td class="px-3 py-2 text-center">
                                        ${AppState.settings.premiumNPSN?.includes(s.npsn) ? '<span class="badge-pro">PRO</span>' : '<span class="badge-free">FREE</span>'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
        } catch (error) {
            console.error('Load admin data error:', error);
            statsContainer.innerHTML = '<p class="text-red-500">Error loading data</p>';
        }
    },

    async saveAdminSettings() {
        const waNumber = document.getElementById('admin-wa').value.trim();
        const premiumNPSN = document.getElementById('admin-premium-npsn').value.split(',').map(s => s.trim()).filter(s => s);
        const paiNPSN = document.getElementById('admin-pai-npsn').value.split(',').map(s => s.trim()).filter(s => s);
        const premiumUsers = document.getElementById('admin-premium-users').value.split('\n').map(s => s.trim()).filter(s => s);

        await SuperAdminSystem.saveSettings({
            waNumber,
            premiumNPSN,
            paiNPSN,
            premiumUsers
        });
    }
};

// ==================== DOCUMENT READY ====================
document.addEventListener('DOMContentLoaded', () => {
    // Initialize calendar
    CalendarSystem.init();
    
    // Load students from localStorage
    const savedStudents = localStorage.getItem('agsa_students');
    if (savedStudents) {
        try {
            AppState.students = JSON.parse(savedStudents);
        } catch (e) {
            console.error('Error loading students:', e);
        }
    }

    // Initialize auth
    AuthSystem.init();

    // Listen for curriculum loaded event
    document.addEventListener('curriculumLoaded', (e) => {
        if (UISystem.currentPage === 'kurikulum') {
            PageScripts.updateKurikulumDropdowns();
        }
    });

    // Handle responsive sidebar
    window.addEventListener('resize', () => {
        if (window.innerWidth >= 1024) {
            document.getElementById('app-sidebar').classList.remove('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');
        }
    });

    // Close modals on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.style.display = 'none';
            });
        }
    });

    // Close modals on backdrop click
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
});

// ==================== GLOBAL FUNCTIONS FOR INLINE HANDLERS ====================
window.UISystem = UISystem;
window.AuthSystem = AuthSystem;
window.AISystem = AISystem;
window.PageScripts = PageScripts;
window.SubscriptionSystem = SubscriptionSystem;
</script>
</body>
</html>