<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Guru Super App - SaaS Edition</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìö</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; box-sizing: border-box; }
        body { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); min-height: 100vh; }
        .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); }
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .gradient-primary { background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%); }
        .gradient-secondary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .gradient-google { background: linear-gradient(135deg, #ea4335 0%, #fbbc05 50%, #34a853 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .paper-preview { background: white; margin: 20px auto; padding: 15mm; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 210mm; min-height: 297mm; border-radius: 8px; }
        .paper-preview.landscape { max-width: 297mm; min-height: 210mm; }
        .doc-table { width: 100%; border-collapse: collapse; font-size: 10pt; margin-bottom: 20px; }
        .doc-table th, .doc-table td { border: 1px solid #334155; padding: 8px; text-align: left; vertical-align: top; }
        .doc-table th { background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); font-weight: 600; text-align: center; }
        .event-cell { vertical-align: middle !important; text-align: center !important; background: linear-gradient(135deg, #fca5a5 0%, #f87171 100%) !important; }
        .vertical-text { writing-mode: vertical-rl; transform: rotate(180deg); font-size: 7pt; font-weight: bold; }
        [contenteditable="true"]:hover { background: #fef9c3; outline: 2px dashed #eab308; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .signature-area { display: flex; justify-content: space-between; margin-top: 40px; page-break-inside: avoid; flex-wrap: wrap; gap: 20px; }
        .signature-box { text-align: center; font-size: 11pt; min-width: 200px; flex: 1; }
        .signature-name { text-decoration: underline; font-weight: bold; margin-top: 70px; }
        .nav-item { transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover, .nav-item.active { background: rgba(37, 99, 235, 0.1); border-left-color: #2563eb; }
        .premium-badge { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast { animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .mode-badge { position: fixed; bottom: 20px; right: 20px; z-index: 999; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .google-btn { background: white; border: 2px solid #e2e8f0; transition: all 0.3s; }
        .google-btn:hover { border-color: #4285f4; box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3); }
        .divider { display: flex; align-items: center; text-align: center; margin: 20px 0; }
        .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid #e2e8f0; }
        .divider span { padding: 0 15px; color: #94a3b8; font-size: 14px; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); position: fixed !important; z-index: 100; height: 100vh; }
            .sidebar.open { transform: translateX(0); }
            .paper-preview { padding: 5mm; margin: 10px; font-size: 8pt; min-height: auto; }
            .doc-table th, .doc-table td { padding: 4px; font-size: 8pt; }
            .signature-area { flex-direction: column; align-items: center; }
        }
        @media print {
            body { background: white !important; }
            .no-print, #sidebar, #topbar, .mobile-menu-btn, .mode-badge, #toast-container { display: none !important; }
            #main-content { margin: 0 !important; padding: 0 !important; }
            .paper-preview { margin: 0; box-shadow: none; page-break-after: always; border-radius: 0; }
            @page { size: A4 portrait; margin: 10mm; }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-[2000] space-y-2"></div>

    <!-- Mode Badge -->
    <div id="mode-badge" class="mode-badge bg-slate-800 text-white hidden">
        <span id="mode-text">Mode: Offline</span>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-[3000] flex items-center justify-center">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-slate-600 font-medium">Memuat aplikasi...</p>
            <p class="text-slate-400 text-sm mt-2" id="loading-status">Menghubungkan ke server...</p>
        </div>
    </div>

    <!-- Landing Page -->
    <div id="landing-page" class="hidden">
        <nav class="fixed top-0 left-0 right-0 z-50 glass border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 gradient-primary rounded-xl flex items-center justify-center text-white text-xl">üìö</div>
                    <span class="font-bold text-xl text-slate-800">AdminGuru<span class="text-blue-600">Pro</span></span>
                </div>
                <div class="hidden md:flex items-center gap-8">
                    <a href="#features" class="text-slate-600 hover:text-blue-600 font-medium">Fitur</a>
                    <a href="#pricing" class="text-slate-600 hover:text-blue-600 font-medium">Harga</a>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="UISystem.showPage('login')" class="px-4 py-2 text-blue-600 font-semibold hover:bg-blue-50 rounded-lg transition">Masuk</button>
                    <button onclick="UISystem.showPage('register')" class="px-5 py-2 gradient-primary text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition">Daftar Gratis</button>
                </div>
            </div>
        </nav>

        <!-- Hero Section -->
        <section class="pt-32 pb-20 px-4">
            <div class="max-w-7xl mx-auto grid lg:grid-cols-2 gap-12 items-center">
                <div>
                    <div class="inline-flex items-center gap-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-full text-sm font-medium mb-6">
                        üöÄ Platform Administrasi Guru #1 di Indonesia
                    </div>
                    <h1 class="text-4xl lg:text-6xl font-extrabold text-slate-900 leading-tight mb-6">
                        Kelola Administrasi <span class="text-transparent bg-clip-text gradient-primary">Guru</span> dengan Mudah
                    </h1>
                    <p class="text-lg text-slate-600 mb-8 leading-relaxed">
                        Generate ATP, Prota, Promes, Modul Ajar, LKPD, Jurnal, Absensi, KKTP & Nilai secara otomatis. 
                        Terintegrasi dengan Kurikulum Merdeka terbaru.
                    </p>
                    <div class="flex flex-wrap gap-4">
                        <button onclick="AuthSystem.loginWithGoogle()" class="px-8 py-4 google-btn text-slate-700 font-bold rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition flex items-center gap-3">
                            <svg class="w-6 h-6" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Masuk dengan Google
                        </button>
                        <button onclick="AppState.enterOfflineMode()" class="px-8 py-4 border-2 border-slate-300 text-slate-700 font-bold rounded-xl hover:border-blue-500 hover:text-blue-600 transition">
                            üîå Mode Offline
                        </button>
                    </div>
                    <div class="flex items-center gap-6 mt-8">
                        <div class="flex -space-x-3">
                            <div class="w-10 h-10 rounded-full bg-blue-500 border-2 border-white flex items-center justify-center text-white text-sm font-bold">A</div>
                            <div class="w-10 h-10 rounded-full bg-green-500 border-2 border-white flex items-center justify-center text-white text-sm font-bold">B</div>
                            <div class="w-10 h-10 rounded-full bg-purple-500 border-2 border-white flex items-center justify-center text-white text-sm font-bold">C</div>
                        </div>
                        <div class="text-sm text-slate-600">
                            <span class="font-bold text-slate-900">5,000+</span> Guru sudah bergabung
                        </div>
                    </div>
                </div>
                <div class="relative hidden lg:block">
                    <div class="absolute -top-10 -left-10 w-72 h-72 bg-blue-200 rounded-full opacity-50 blur-3xl"></div>
                    <div class="absolute -bottom-10 -right-10 w-72 h-72 bg-purple-200 rounded-full opacity-50 blur-3xl"></div>
                    <div class="relative glass rounded-2xl shadow-2xl p-6 animate-float">
                        <div class="bg-slate-100 rounded-xl p-4 mb-4">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-8 h-8 bg-blue-500 rounded-lg"></div>
                                <div class="flex-1">
                                    <div class="h-3 bg-slate-300 rounded w-3/4 mb-2"></div>
                                    <div class="h-2 bg-slate-200 rounded w-1/2"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="h-16 bg-green-200 rounded-lg"></div>
                                <div class="h-16 bg-blue-200 rounded-lg"></div>
                                <div class="h-16 bg-purple-200 rounded-lg"></div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-slate-600">‚úÖ ATP Generated</span>
                            <span class="text-green-600 font-bold">100%</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section id="features" class="py-20 px-4 bg-white">
            <div class="max-w-7xl mx-auto">
                <div class="text-center mb-16">
                    <h2 class="text-3xl lg:text-4xl font-bold text-slate-900 mb-4">Fitur Lengkap untuk Guru Modern</h2>
                    <p class="text-lg text-slate-600 max-w-2xl mx-auto">Semua yang Anda butuhkan dalam satu platform</p>
                </div>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="card-hover bg-gradient-to-br from-blue-50 to-white p-6 rounded-2xl border border-blue-100">
                        <div class="w-14 h-14 gradient-primary rounded-2xl flex items-center justify-center text-2xl mb-4">üìã</div>
                        <h3 class="text-xl font-bold text-slate-900 mb-2">ATP & Prota</h3>
                        <p class="text-slate-600">Generate Alur Tujuan Pembelajaran dan Program Tahunan otomatis</p>
                        <span class="inline-block mt-3 px-3 py-1 bg-green-100 text-green-700 text-sm font-medium rounded-full">GRATIS</span>
                    </div>
                    <div class="card-hover bg-gradient-to-br from-green-50 to-white p-6 rounded-2xl border border-green-100">
                        <div class="w-14 h-14 gradient-secondary rounded-2xl flex items-center justify-center text-2xl mb-4">üìÖ</div>
                        <h3 class="text-xl font-bold text-slate-900 mb-2">Kalender & Jadwal</h3>
                        <p class="text-slate-600">Kelola kalender pendidikan dan jadwal pelajaran dengan mudah</p>
                        <span class="inline-block mt-3 px-3 py-1 bg-green-100 text-green-700 text-sm font-medium rounded-full">GRATIS</span>
                    </div>
                    <div class="card-hover bg-gradient-to-br from-purple-50 to-white p-6 rounded-2xl border border-purple-100">
                        <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center text-2xl mb-4">üìö</div>
                        <h3 class="text-xl font-bold text-slate-900 mb-2">Modul & LKPD</h3>
                        <p class="text-slate-600">Buat Modul Ajar dan Lembar Kerja Peserta Didik otomatis</p>
                        <span class="inline-block mt-3 px-3 py-1 premium-badge text-white text-sm font-medium rounded-full">PRO</span>
                    </div>
                    <div class="card-hover bg-gradient-to-br from-amber-50 to-white p-6 rounded-2xl border border-amber-100">
                        <div class="w-14 h-14 bg-gradient-to-br from-amber-500 to-orange-500 rounded-2xl flex items-center justify-center text-2xl mb-4">üìù</div>
                        <h3 class="text-xl font-bold text-slate-900 mb-2">Jurnal & Absensi</h3>
                        <p class="text-slate-600">Catat pelaksanaan pembelajaran dan kehadiran siswa</p>
                        <span class="inline-block mt-3 px-3 py-1 premium-badge text-white text-sm font-medium rounded-full">PRO</span>
                    </div>
                    <div class="card-hover bg-gradient-to-br from-red-50 to-white p-6 rounded-2xl border border-red-100">
                        <div class="w-14 h-14 bg-gradient-to-br from-red-500 to-pink-500 rounded-2xl flex items-center justify-center text-2xl mb-4">üéØ</div>
                        <h3 class="text-xl font-bold text-slate-900 mb-2">KKTP & Nilai</h3>
                        <p class="text-slate-600">Kelola kriteria ketercapaian dan penilaian siswa</p>
                        <span class="inline-block mt-3 px-3 py-1 premium-badge text-white text-sm font-medium rounded-full">PRO</span>
                    </div>
                    <div class="card-hover bg-gradient-to-br from-cyan-50 to-white p-6 rounded-2xl border border-cyan-100">
                        <div class="w-14 h-14 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-2xl flex items-center justify-center text-2xl mb-4">‚ùì</div>
                        <h3 class="text-xl font-bold text-slate-900 mb-2">Bank Soal</h3>
                        <p class="text-slate-600">Buat dan kelola bank soal dengan berbagai tipe</p>
                        <span class="inline-block mt-3 px-3 py-1 premium-badge text-white text-sm font-medium rounded-full">PRO</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Pricing Section -->
        <section id="pricing" class="py-20 px-4">
            <div class="max-w-5xl mx-auto">
                <div class="text-center mb-16">
                    <h2 class="text-3xl lg:text-4xl font-bold text-slate-900 mb-4">Pilih Paket Anda</h2>
                    <p class="text-lg text-slate-600">Mulai gratis, upgrade kapan saja</p>
                </div>
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-white rounded-3xl p-8 shadow-lg border border-slate-200">
                        <div class="text-center mb-6">
                            <span class="text-slate-600 font-medium">GRATIS</span>
                            <div class="text-4xl font-extrabold text-slate-900 mt-2">Rp 0</div>
                            <span class="text-slate-500">Selamanya</span>
                        </div>
                        <ul class="space-y-4 mb-8 text-sm">
                            <li class="flex items-center gap-3"><span class="text-green-500">‚úì</span> Kalender Pendidikan</li>
                            <li class="flex items-center gap-3"><span class="text-green-500">‚úì</span> Jadwal Pelajaran</li>
                            <li class="flex items-center gap-3"><span class="text-green-500">‚úì</span> ATP & Prota</li>
                            <li class="flex items-center gap-3 text-slate-400"><span>‚úó</span> Promes, Modul, LKPD</li>
                            <li class="flex items-center gap-3 text-slate-400"><span>‚úó</span> Jurnal, Absensi, Nilai</li>
                        </ul>
                        <button onclick="AuthSystem.loginWithGoogle()" class="w-full py-3 google-btn text-slate-700 font-bold rounded-xl flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Mulai dengan Google
                        </button>
                    </div>
                    <div class="bg-gradient-to-br from-blue-600 to-purple-600 rounded-3xl p-8 shadow-2xl text-white relative overflow-hidden">
                        <div class="absolute top-4 right-4 bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-sm font-bold">POPULER</div>
                        <div class="text-center mb-6">
                            <span class="text-blue-200 font-medium">PRO</span>
                            <div class="text-4xl font-extrabold mt-2">Rp 50.000</div>
                            <span class="text-blue-200">Per bulan</span>
                        </div>
                        <ul class="space-y-4 mb-8 text-sm">
                            <li class="flex items-center gap-3"><span class="text-yellow-400">‚úì</span> Semua Fitur Gratis</li>
                            <li class="flex items-center gap-3"><span class="text-yellow-400">‚úì</span> Promes, Modul Ajar, LKPD</li>
                            <li class="flex items-center gap-3"><span class="text-yellow-400">‚úì</span> Jurnal & Absensi</li>
                            <li class="flex items-center gap-3"><span class="text-yellow-400">‚úì</span> KKTP & Daftar Nilai</li>
                            <li class="flex items-center gap-3"><span class="text-yellow-400">‚úì</span> Bank Soal Lengkap</li>
                        </ul>
                        <button onclick="SubscriptionSystem.showUpgradeModal()" class="w-full py-3 bg-white text-blue-600 font-bold rounded-xl hover:bg-blue-50 transition">
                            Upgrade Sekarang
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <footer class="bg-slate-900 text-white py-12 px-4">
            <div class="max-w-7xl mx-auto text-center">
                <p class="text-slate-400">¬© 2025 AdminGuruPro. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-16 h-16 gradient-primary rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4">üìö</div>
                <h1 class="text-2xl font-bold text-slate-900">Masuk ke Akun</h1>
                <p class="text-slate-500 mt-2">Selamat datang kembali!</p>
            </div>

            <!-- Google Sign In Button -->
            <button onclick="AuthSystem.loginWithGoogle()" id="google-login-btn" class="w-full py-3 google-btn text-slate-700 font-bold rounded-xl flex items-center justify-center gap-3 mb-4">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Masuk dengan Google
            </button>

            <div class="divider"><span>atau dengan email</span></div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                    <input type="email" id="login-email" required class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="email@contoh.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                    <input type="password" id="login-password" required minlength="6" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="Minimal 6 karakter">
                </div>
                <button type="submit" id="login-btn" class="w-full py-3 gradient-primary text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition">
                    Masuk dengan Email
                </button>
            </form>
            <div class="mt-4 text-center">
                <button onclick="AppState.enterOfflineMode()" class="text-slate-500 hover:text-blue-600 text-sm">
                    üîå Gunakan Mode Offline
                </button>
            </div>
            <p class="text-center text-slate-600 mt-6">
                Belum punya akun? <button onclick="UISystem.showPage('register')" class="text-blue-600 font-semibold hover:underline">Daftar</button>
            </p>
            <button onclick="UISystem.showPage('landing')" class="w-full mt-4 text-slate-500 hover:text-slate-700 text-sm">‚Üê Kembali</button>
        </div>
    </div>

    <!-- Register Page -->
    <div id="register-page" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-16 h-16 gradient-secondary rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4">üéì</div>
                <h1 class="text-2xl font-bold text-slate-900">Daftar Akun Baru</h1>
                <p class="text-slate-500 mt-2">Buat akun gratis sekarang</p>
            </div>

            <!-- Google Sign Up Button -->
            <button onclick="AuthSystem.loginWithGoogle()" class="w-full py-3 google-btn text-slate-700 font-bold rounded-xl flex items-center justify-center gap-3 mb-4">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Daftar dengan Google
            </button>

            <div class="divider"><span>atau dengan email</span></div>

            <form id="register-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nama Lengkap</label>
                    <input type="text" id="reg-nama" required class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition" placeholder="Nama lengkap dengan gelar">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                    <input type="email" id="reg-email" required class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition" placeholder="email@contoh.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">NPSN Sekolah</label>
                    <input type="text" id="reg-npsn" required pattern="[0-9]{8}" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition" placeholder="8 digit NPSN (contoh: 20234567)">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                    <input type="password" id="reg-password" required minlength="6" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition" placeholder="Minimal 6 karakter">
                </div>
                <button type="submit" id="register-btn" class="w-full py-3 gradient-secondary text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition">
                    Daftar dengan Email
                </button>
            </form>
            <p class="text-center text-slate-600 mt-6">
                Sudah punya akun? <button onclick="UISystem.showPage('login')" class="text-green-600 font-semibold hover:underline">Masuk</button>
            </p>
            <button onclick="UISystem.showPage('landing')" class="w-full mt-4 text-slate-500 hover:text-slate-700 text-sm">‚Üê Kembali</button>
        </div>
    </div>

    <!-- NPSN Modal (for Google Sign-in new users) -->
    <div id="npsn-modal" class="modal-overlay">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <div class="w-16 h-16 gradient-primary rounded-full flex items-center justify-center text-3xl mx-auto mb-4">üè´</div>
                <h2 class="text-xl font-bold text-slate-900">Lengkapi Data Anda</h2>
                <p class="text-slate-500 mt-2">Masukkan NPSN sekolah untuk melanjutkan</p>
            </div>
            <form id="npsn-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">NPSN Sekolah</label>
                    <input type="text" id="modal-npsn" required pattern="[0-9]{8}" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="8 digit NPSN (contoh: 20234567)">
                    <p class="text-xs text-slate-500 mt-1">NPSN adalah Nomor Pokok Sekolah Nasional (8 digit)</p>
                </div>
                <button type="submit" class="w-full py-3 gradient-primary text-white font-bold rounded-xl">
                    Lanjutkan
                </button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden flex h-screen overflow-hidden">
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" class="mobile-menu-btn fixed top-4 left-4 z-50 md:hidden bg-white p-2 rounded-lg shadow-lg no-print" onclick="document.getElementById('sidebar').classList.toggle('open')">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>

        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar w-64 min-w-[256px] bg-slate-900 text-white flex flex-col h-full transition-transform duration-300 no-print">
            <div class="p-5 border-b border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 gradient-primary rounded-xl flex items-center justify-center text-xl">üìö</div>
                    <div>
                        <span class="font-bold text-lg">AdminGuru</span>
                        <span id="user-badge" class="ml-2 px-2 py-0.5 rounded text-xs font-semibold bg-slate-700 text-slate-300">FREE</span>
                    </div>
                </div>
                <div class="mt-3 flex items-center gap-2">
                    <img id="sidebar-user-photo" class="w-8 h-8 rounded-full bg-slate-700 hidden" src="" alt="">
                    <div class="text-sm text-slate-400 truncate flex-1" id="sidebar-user-info">Mode Offline</div>
                </div>
            </div>

            <nav class="flex-1 overflow-y-auto sidebar-scroll p-3 space-y-1">
                <button onclick="UISystem.switchView('dashboard')" class="nav-item active w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left hover:bg-slate-800 transition">
                    <span>üìä</span> Dashboard
                </button>
                <button onclick="UISystem.switchView('profil')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left hover:bg-slate-800 transition">
                    <span>üë§</span> Profil Guru
                </button>
                <button onclick="UISystem.switchView('sekolah')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left hover:bg-slate-800 transition">
                    <span>üè´</span> Profil Sekolah
                </button>
                <button onclick="UISystem.switchView('kurikulum')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left hover:bg-slate-800 transition">
                    <span>üìñ</span> Kurikulum & Mapel
                </button>
                <button onclick="UISystem.switchView('kalender')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left hover:bg-slate-800 transition">
                    <span>üìÖ</span> Kalender & Libur
                </button>
                <button onclick="UISystem.switchView('banksoal')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left hover:bg-slate-800 transition">
                    <span>‚ùì</span> Bank Soal
                    <span class="premium-badge text-[10px] px-2 py-0.5 rounded ml-auto">PRO</span>
                </button>
                <button onclick="UISystem.switchView('generate')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left hover:bg-slate-800 transition">
                    <span>üìÑ</span> Generate Dokumen
                </button>
                <button onclick="UISystem.switchView('subscription')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left hover:bg-slate-800 transition">
                    <span>üí≥</span> Subscription
                </button>
                <button onclick="UISystem.switchView('superadmin')" id="nav-superadmin" class="nav-item hidden w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left hover:bg-slate-800 transition text-amber-400">
                    <span>üëë</span> Super Admin
                </button>
            </nav>

            <div class="p-4 border-t border-slate-700">
                <button onclick="AuthSystem.logout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-red-600 hover:bg-red-500 rounded-lg font-semibold transition">
                    <span>üö™</span> Keluar
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header id="topbar" class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 md:px-6 no-print">
                <div class="flex items-center gap-4 ml-12 md:ml-0">
                    <h1 id="page-title" class="text-xl font-bold text-slate-900">Dashboard</h1>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="window.print()" class="hidden md:flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-700 font-medium transition">
                        üñ®Ô∏è Cetak
                    </button>
                    <img id="user-avatar-img" class="w-10 h-10 rounded-full bg-blue-100 hidden" src="" alt="">
                    <div id="user-avatar" class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold">U</div>
                </div>
            </header>

            <div id="main-content" class="flex-1 overflow-y-auto p-4 md:p-6 bg-slate-50">
                <!-- Views loaded here -->
            </div>
        </main>
    </div>

    <!-- Upgrade Modal -->
    <div id="upgrade-modal" class="modal-overlay">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 relative">
            <button onclick="document.getElementById('upgrade-modal').style.display='none'" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-xl">‚úï</button>
            <div class="text-center">
                <div class="w-20 h-20 gradient-primary rounded-full flex items-center justify-center text-4xl mx-auto mb-4">üëë</div>
                <h2 class="text-2xl font-bold text-slate-900 mb-2">Upgrade ke PRO</h2>
                <p class="text-slate-600 mb-6">Fitur ini tersedia pada versi PRO. Upgrade sekarang untuk akses penuh!</p>
                <a id="upgrade-wa-link" href="#" target="_blank" class="inline-flex items-center gap-2 px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl transition">
                    üí¨ Hubungi WhatsApp
                </a>
            </div>
        </div>
    </div>

    <!-- Student Modal -->
    <div id="student-modal" class="modal-overlay">
        <div class="bg-white rounded-2xl p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-900">üìã Input Data Siswa</h2>
                <button onclick="document.getElementById('student-modal').style.display='none'" class="text-slate-400 hover:text-slate-600 text-2xl">‚úï</button>
            </div>
            <p class="text-sm text-slate-600 mb-4">Paste daftar nama siswa (1 baris = 1 nama)</p>
            <textarea id="student-input" rows="10" class="w-full border border-slate-300 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="1. Ahmad Fulan&#10;2. Siti Fulanah&#10;3. Budi Santoso"></textarea>
            <button onclick="ProfileSystem.saveStudents()" class="w-full mt-4 py-3 gradient-primary text-white font-bold rounded-xl transition">
                üíæ Simpan Data Siswa
            </button>
        </div>
    </div>

<script>
// =====================================================
// FIREBASE CONFIGURATION
// =====================================================
const firebaseConfig = {
    apiKey: "AIzaSyDe4ie2wSPEpNbAgWP-q03vTuHyxc9Jj3E",
    authDomain: "agsa-e5b08.firebaseapp.com",
    projectId: "agsa-e5b08",
    storageBucket: "agsa-e5b08.firebasestorage.app",
    messagingSenderId: "916052746331",
    appId: "1:916052746331:web:357cbadbfd8658f1689f7e",
};

let auth, db, googleProvider;
let firebaseReady = false;

try {
    firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();
    googleProvider = new firebase.auth.GoogleAuthProvider();
    googleProvider.addScope('email');
    googleProvider.addScope('profile');
    firebaseReady = true;
} catch (e) {
    console.warn('Firebase initialization failed:', e);
}

// =====================================================
// CONSTANTS
// =====================================================
const CP_LINKS = {
    "SD": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1925091593&single=true&output=csv",
    "SMP": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1962203786&single=true&output=csv",
    "SMA": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=260922290&single=true&output=csv"
};

const BULAN_IND = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
const HARI_IND = ["Minggu","Senin","Selasa","Rabu","Kamis","Jum'at","Sabtu"];
const SUPER_ADMIN_EMAIL = "afifaro@gmail.com";
const FREE_FEATURES = ['atp', 'prota', 'kalender', 'jadwal'];
const PRO_FEATURES = ['promes', 'modul', 'lkpd', 'jurnal', 'absensi', 'kktp', 'nilai', 'banksoal'];

// =====================================================
// APP STATE
// =====================================================
const AppState = {
    isOnline: false,
    currentUser: null,
    userData: null,
    pendingGoogleUser: null,

    init() {
        this.isOnline = firebaseReady;
        this.updateModeBadge();
    },

    updateModeBadge() {
        const badge = document.getElementById('mode-badge');
        const text = document.getElementById('mode-text');
        if (this.isOnline) {
            badge.className = 'mode-badge bg-green-500 text-white';
            text.textContent = 'üåê Online';
        } else {
            badge.className = 'mode-badge bg-slate-700 text-white';
            text.textContent = 'üîå Offline';
        }
        badge.classList.remove('hidden');
    },

    enterOfflineMode() {
        this.isOnline = false;
        this.userData = this.getLocalUser() || {
            id: 'offline-user',
            nama: 'Guru (Offline)',
            email: 'offline@local',
            npsn: '00000000',
            role: 'guru',
            isPremium: true
        };
        this.currentUser = { uid: 'offline-user' };
        this.saveLocalUser(this.userData);
        this.updateModeBadge();
        
        document.getElementById('loading-overlay').style.display = 'none';
        UISystem.showPage('app');
        Utils.toast('Mode Offline aktif - semua fitur tersedia', 'info');
    },

    getLocalUser() {
        try { return JSON.parse(localStorage.getItem('agsa_user')); } 
        catch { return null; }
    },

    saveLocalUser(data) {
        localStorage.setItem('agsa_user', JSON.stringify(data));
    }
};

// =====================================================
// UTILITY FUNCTIONS
// =====================================================
const Utils = {
    toast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500', warning: 'bg-amber-500' };
        const toast = document.createElement('div');
        toast.className = `toast ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg font-medium max-w-sm`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    },

    formatDate(dateStr) {
        if (!dateStr) return "";
        const [y, m, d] = dateStr.split('-');
        return `${parseInt(d)} ${BULAN_IND[parseInt(m)-1]} ${y}`;
    },

    generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }
};

// =====================================================
// AUTH SYSTEM
// =====================================================
const AuthSystem = {
    async init() {
        document.getElementById('loading-status').textContent = 'Memeriksa autentikasi...';
        
        if (!firebaseReady) {
            document.getElementById('loading-status').textContent = 'Firebase tidak tersedia';
            setTimeout(() => {
                document.getElementById('loading-overlay').style.display = 'none';
                UISystem.showPage('landing');
            }, 1500);
            return;
        }

        auth.onAuthStateChanged(async (user) => {
            document.getElementById('loading-overlay').style.display = 'none';
            
            if (user) {
                AppState.currentUser = user;
                AppState.isOnline = true;
                await this.loadUserData();
                
                // Check if user needs to enter NPSN
                if (!AppState.userData?.npsn || AppState.userData.npsn === '') {
                    AppState.pendingGoogleUser = user;
                    UISystem.showPage('app'); // Show app first
                    document.getElementById('npsn-modal').style.display = 'flex';
                } else {
                    UISystem.showPage('app');
                }
            } else {
                AppState.currentUser = null;
                AppState.userData = null;
                UISystem.showPage('landing');
            }
            AppState.updateModeBadge();
        });

        // Form handlers
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.loginWithEmail();
        });

        document.getElementById('register-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.registerWithEmail();
        });

        document.getElementById('npsn-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.completeGoogleSignUp();
        });
    },

    // ==================== GOOGLE LOGIN ====================
    async loginWithGoogle() {
        if (!firebaseReady) {
            Utils.toast('Firebase tidak tersedia. Gunakan mode offline.', 'warning');
            return;
        }

        const btn = document.getElementById('google-login-btn');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner w-5 h-5 mx-auto"></div>';
        }

        try {
            const result = await auth.signInWithPopup(googleProvider);
            const user = result.user;
            
            // Check if user exists in Firestore
            const userDoc = await db.collection('users').doc(user.uid).get();
            
            if (!userDoc.exists) {
                // New user from Google - need to get NPSN
                AppState.pendingGoogleUser = user;
                
                // Create initial user data
                const userData = {
                    nama: user.displayName || 'Guru',
                    email: user.email,
                    photoURL: user.photoURL || '',
                    npsn: '', // Will be filled later
                    role: user.email === SUPER_ADMIN_EMAIL ? 'super_admin' : 'guru',
                    isPremium: false,
                    provider: 'google',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(user.uid).set(userData);
                AppState.userData = { id: user.uid, ...userData };
                
                Utils.toast('Login berhasil! Silakan lengkapi data.', 'success');
            } else {
                Utils.toast('Login dengan Google berhasil!', 'success');
            }
        } catch (error) {
            console.error('Google login error:', error);
            let msg = 'Login Google gagal';
            if (error.code === 'auth/popup-closed-by-user') msg = 'Login dibatalkan';
            else if (error.code === 'auth/popup-blocked') msg = 'Pop-up diblokir browser. Izinkan pop-up dan coba lagi.';
            else if (error.code === 'auth/network-request-failed') msg = 'Koneksi gagal. Periksa internet Anda.';
            Utils.toast(msg, 'error');
        }

        if (btn) {
            btn.disabled = false;
            btn.innerHTML = `
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Masuk dengan Google`;
        }
    },

    async completeGoogleSignUp() {
        const npsn = document.getElementById('modal-npsn').value.trim();
        
        if (npsn.length !== 8 || !/^\d+$/.test(npsn)) {
            Utils.toast('NPSN harus 8 digit angka', 'error');
            return;
        }

        try {
            const user = AppState.currentUser || AppState.pendingGoogleUser;
            if (!user) {
                Utils.toast('Sesi tidak valid, silakan login ulang', 'error');
                return;
            }

            // Update user with NPSN
            await db.collection('users').doc(user.uid).update({ npsn: npsn });
            
            // Create school if not exists
            const schoolRef = db.collection('schools').doc(npsn);
            const schoolDoc = await schoolRef.get();
            if (!schoolDoc.exists) {
                await schoolRef.set({
                    npsn: npsn,
                    namaSekolah: '',
                    alamat: '',
                    kepsek: '',
                    nipKepsek: '',
                    premiumByAdmin: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            AppState.userData.npsn = npsn;
            AppState.saveLocalUser(AppState.userData);
            AppState.pendingGoogleUser = null;
            
            document.getElementById('npsn-modal').style.display = 'none';
            Utils.toast('Data berhasil dilengkapi!', 'success');
            
            // Reload user data
            await this.loadUserData();
            this.updateUI();
            
        } catch (error) {
            console.error('Error completing signup:', error);
            Utils.toast('Gagal menyimpan data: ' + error.message, 'error');
        }
    },

    // ==================== EMAIL LOGIN ====================
    async loginWithEmail() {
        if (!firebaseReady) {
            Utils.toast('Firebase tidak tersedia. Gunakan mode offline.', 'warning');
            return;
        }

        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        const btn = document.getElementById('login-btn');

        btn.disabled = true;
        btn.textContent = 'Memproses...';

        try {
            await auth.signInWithEmailAndPassword(email, password);
            Utils.toast('Login berhasil!', 'success');
        } catch (error) {
            let msg = 'Login gagal';
            if (error.code === 'auth/user-not-found') msg = 'Email tidak terdaftar';
            else if (error.code === 'auth/wrong-password') msg = 'Password salah';
            else if (error.code === 'auth/invalid-email') msg = 'Format email tidak valid';
            else if (error.code === 'auth/too-many-requests') msg = 'Terlalu banyak percobaan';
            Utils.toast(msg, 'error');
        }

        btn.disabled = false;
        btn.textContent = 'Masuk dengan Email';
    },

    async registerWithEmail() {
        if (!firebaseReady) {
            Utils.toast('Firebase tidak tersedia. Gunakan mode offline.', 'warning');
            return;
        }

        const nama = document.getElementById('reg-nama').value.trim();
        const email = document.getElementById('reg-email').value.trim();
        const npsn = document.getElementById('reg-npsn').value.trim();
        const password = document.getElementById('reg-password').value;
        const btn = document.getElementById('register-btn');

        if (npsn.length !== 8 || !/^\d+$/.test(npsn)) {
            Utils.toast('NPSN harus 8 digit angka', 'error');
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Memproses...';

        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            
            const userData = {
                nama: nama,
                email: email,
                npsn: npsn,
                role: email === SUPER_ADMIN_EMAIL ? 'super_admin' : 'guru',
                isPremium: false,
                provider: 'email',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db.collection('users').doc(userCredential.user.uid).set(userData);

            // Create school if not exists
            const schoolRef = db.collection('schools').doc(npsn);
            const schoolDoc = await schoolRef.get();
            if (!schoolDoc.exists) {
                await schoolRef.set({
                    npsn: npsn,
                    namaSekolah: '',
                    alamat: '',
                    kepsek: '',
                    nipKepsek: '',
                    premiumByAdmin: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            Utils.toast('Registrasi berhasil!', 'success');
        } catch (error) {
            let msg = 'Registrasi gagal';
            if (error.code === 'auth/email-already-in-use') msg = 'Email sudah terdaftar';
            else if (error.code === 'auth/weak-password') msg = 'Password minimal 6 karakter';
            else if (error.code === 'auth/invalid-email') msg = 'Format email tidak valid';
            Utils.toast(msg, 'error');
        }

        btn.disabled = false;
        btn.textContent = 'Daftar dengan Email';
    },

    async loadUserData() {
        if (!AppState.currentUser || !firebaseReady) return;

        try {
            const doc = await db.collection('users').doc(AppState.currentUser.uid).get();
            if (doc.exists) {
                AppState.userData = { id: doc.id, ...doc.data() };
                AppState.saveLocalUser(AppState.userData);
                await SubscriptionSystem.checkPremiumStatus();
                this.updateUI();
            }
        } catch (error) {
            console.error('Error loading user data:', error);
            const localData = AppState.getLocalUser();
            if (localData) AppState.userData = localData;
        }
    },

    updateUI() {
        const data = AppState.userData;
        if (!data) return;

        // Sidebar user info
        const sidebarInfo = document.getElementById('sidebar-user-info');
        const sidebarPhoto = document.getElementById('sidebar-user-photo');
        
        sidebarInfo.textContent = data.nama || data.email || 'User';
        
        if (data.photoURL) {
            sidebarPhoto.src = data.photoURL;
            sidebarPhoto.classList.remove('hidden');
        } else {
            sidebarPhoto.classList.add('hidden');
        }

        // Top bar avatar
        const avatarImg = document.getElementById('user-avatar-img');
        const avatarDiv = document.getElementById('user-avatar');
        
        if (data.photoURL) {
            avatarImg.src = data.photoURL;
            avatarImg.classList.remove('hidden');
            avatarDiv.classList.add('hidden');
        } else {
            avatarImg.classList.add('hidden');
            avatarDiv.classList.remove('hidden');
            avatarDiv.textContent = data.nama?.charAt(0).toUpperCase() || 'U';
        }

        // Premium badge
        const isPremium = SubscriptionSystem.isPremium();
        const badge = document.getElementById('user-badge');
        badge.textContent = isPremium ? 'PRO' : 'FREE';
        badge.className = `ml-2 px-2 py-0.5 rounded text-xs font-semibold ${isPremium ? 'bg-amber-500 text-white' : 'bg-slate-700 text-slate-300'}`;

        // Super admin nav
        if (data.role === 'super_admin') {
            document.getElementById('nav-superadmin').classList.remove('hidden');
        }
    },

    logout() {
        if (AppState.isOnline && firebaseReady) {
            auth.signOut();
        } else {
            localStorage.removeItem('agsa_user');
            AppState.userData = null;
            AppState.currentUser = null;
            UISystem.showPage('landing');
        }
        Utils.toast('Logout berhasil', 'info');
    }
};

// =====================================================
// SUBSCRIPTION SYSTEM
// =====================================================
const SubscriptionSystem = {
    settings: { whatsappUpgrade: "6281234567890", premiumNPSN: [] },

    async init() {
        if (AppState.isOnline && firebaseReady) {
            await this.loadSettings();
        }
    },

    async loadSettings() {
        try {
            const doc = await db.collection('settings').doc('subscription').get();
            if (doc.exists) this.settings = { ...this.settings, ...doc.data() };
        } catch (e) { console.log('Using default settings'); }
    },

    async checkPremiumStatus() {
        const data = AppState.userData;
        if (!data) return false;
        if (!AppState.isOnline) { data.isPremium = true; return true; }
        if (data.role === 'super_admin') { data.isPremium = true; return true; }
        if (this.settings.premiumNPSN.includes(data.npsn)) { data.isPremium = true; return true; }
        
        try {
            const schoolDoc = await db.collection('schools').doc(data.npsn).get();
            if (schoolDoc.exists && schoolDoc.data().premiumByAdmin) {
                data.isPremium = true;
                return true;
            }
        } catch (e) {}
        
        AuthSystem.updateUI();
        return data.isPremium || false;
    },

    isPremium() {
        if (!AppState.isOnline) return true;
        return AppState.userData?.isPremium || false;
    },

    guard(feature) {
        if (FREE_FEATURES.includes(feature)) return true;
        if (this.isPremium()) return true;
        this.showUpgradeModal();
        return false;
    },

    showUpgradeModal() {
        const waLink = `https://wa.me/${this.settings.whatsappUpgrade}?text=${encodeURIComponent('Halo, saya ingin upgrade ke versi PRO AdminGuruPro')}`;
        document.getElementById('upgrade-wa-link').href = waLink;
        document.getElementById('upgrade-modal').style.display = 'flex';
    }
};

// =====================================================
// UI SYSTEM (Shortened for space - same as before)
// =====================================================
const UISystem = {
    currentView: 'dashboard',

    showPage(page) {
        ['landing-page', 'login-page', 'register-page', 'app-container'].forEach(p => document.getElementById(p)?.classList.add('hidden'));
        
        switch(page) {
            case 'landing': document.getElementById('landing-page').classList.remove('hidden'); break;
            case 'login': document.getElementById('login-page').classList.remove('hidden'); break;
            case 'register': document.getElementById('register-page').classList.remove('hidden'); break;
            case 'app':
                document.getElementById('app-container').classList.remove('hidden');
                AuthSystem.updateUI();
                this.switchView('dashboard');
                CurriculumSystem.init();
                break;
        }
    },

    switchView(viewId) {
        this.currentView = viewId;
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active', 'bg-blue-600/20'));
        event?.currentTarget?.classList.add('active', 'bg-blue-600/20');
        document.getElementById('sidebar').classList.remove('open');

        const titles = { dashboard: 'Dashboard', profil: 'Profil Guru', sekolah: 'Profil Sekolah', kurikulum: 'Kurikulum & Mapel', kalender: 'Kalender & Libur', banksoal: 'Bank Soal', generate: 'Generate Dokumen', subscription: 'Subscription', superadmin: 'Super Admin' };
        document.getElementById('page-title').textContent = titles[viewId] || 'Dashboard';

        const content = document.getElementById('main-content');
        content.innerHTML = this.getViewHTML(viewId);
        this.initView(viewId);
    },

    getViewHTML(viewId) {
        // Return appropriate HTML for each view
        // (Same implementation as before - simplified here for space)
        return `<div class="text-center py-20"><p>Loading ${viewId}...</p></div>`;
    },

    initView(viewId) {
        // Initialize view-specific functionality
    }
};

// =====================================================
// Placeholder Systems (implement as needed)
// =====================================================
const CurriculumSystem = { init() {}, data: {}, faseMap: {} };
const CalendarSystem = { init() {}, generateEvents() {}, eventList: [] };
const ProfileSystem = { loadProfile() {}, saveStudents() {} };
const SchoolSystem = { loadSchool() {}, schoolData: {} };
const BankSoalSystem = { init() {} };
const DocumentEngine = { init() {}, generate() {} };
const DashboardSystem = { init() {} };
const SuperAdminSystem = { init() {} };

// =====================================================
// INITIALIZATION
// =====================================================
document.addEventListener('DOMContentLoaded', () => {
    AppState.init();
    AuthSystem.init();
    SubscriptionSystem.init();
});

// Close modals
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-overlay') && e.target.id !== 'npsn-modal') {
        e.target.style.display = 'none';
    }
});
</script>
</body>
</html>
