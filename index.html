<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN GURU SUPER APP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        .sidebar-item { @apply flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 cursor-pointer; }
        .sidebar-item:hover { @apply bg-primary-50 text-primary-600; }
        .sidebar-item.active { @apply bg-primary-500 text-white shadow-lg shadow-primary-500/30; }
        .card { @apply bg-white rounded-2xl shadow-sm border border-gray-100 p-6; }
        .btn-primary { @apply bg-gradient-to-r from-primary-500 to-primary-600 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg hover:shadow-primary-500/30 transition-all duration-200; }
        .btn-secondary { @apply bg-gray-100 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-200 transition-all duration-200; }
        .input-field { @apply w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 outline-none transition-all duration-200; }
        .label { @apply block text-sm font-medium text-gray-700 mb-2; }
        .badge { @apply inline-flex items-center px-3 py-1 rounded-full text-sm font-medium; }
        .badge-success { @apply bg-green-100 text-green-700; }
        .badge-warning { @apply bg-yellow-100 text-yellow-700; }
        .badge-danger { @apply bg-red-100 text-red-700; }
        .badge-info { @apply bg-blue-100 text-blue-700; }
        .table-header { @apply bg-gray-50 text-gray-600 text-sm font-semibold uppercase tracking-wider; }
        .rtl-text { direction: rtl; font-family: 'Traditional Arabic', 'Scheherazade New', serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        .animate-slideIn { animation: slideIn 0.3s ease-out; }
        .modal-backdrop { @apply fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4; }
        .modal-content { @apply bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto; }
        .loading-spinner { @apply inline-block w-6 h-6 border-3 border-primary-500 border-t-transparent rounded-full animate-spin; }
        .tooltip { @apply invisible absolute z-50 bg-gray-900 text-white text-sm px-3 py-2 rounded-lg -top-10 left-1/2 -translate-x-1/2 whitespace-nowrap; }
        .has-tooltip:hover .tooltip { @apply visible; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white !important; }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="font-sans bg-gray-50 min-h-screen">
    <!-- App Container -->
    <div id="app">
        <!-- Loading Screen -->
        <div id="loadingScreen" class="fixed inset-0 bg-gradient-to-br from-primary-600 to-primary-800 flex items-center justify-center z-50">
            <div class="text-center text-white">
                <div class="w-20 h-20 mx-auto mb-6 relative">
                    <div class="absolute inset-0 border-4 border-white/30 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-transparent border-t-white rounded-full animate-spin"></div>
                    <i class="fas fa-chalkboard-teacher text-3xl absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">ADMIN GURU SUPER APP</h2>
                <p class="text-primary-200">Memuat aplikasi...</p>
            </div>
        </div>

        <!-- Login Page -->
        <div id="loginPage" class="hidden min-h-screen bg-gradient-to-br from-primary-600 via-primary-700 to-primary-800 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md animate-fadeIn">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-gradient-to-br from-primary-500 to-primary-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-primary-500/30">
                        <i class="fas fa-chalkboard-teacher text-3xl text-white"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">ADMIN GURU SUPER APP</h1>
                    <p class="text-gray-500 mt-2">Single Input - Multi Output</p>
                </div>
                
                <div class="space-y-4">
                    <button onclick="signInWithGoogle()" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-200 text-gray-700 px-6 py-4 rounded-xl font-semibold hover:bg-gray-50 hover:border-gray-300 transition-all duration-200">
                        <svg class="w-6 h-6" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Masuk dengan Google
                    </button>
                </div>

                <div class="mt-6 p-4 bg-blue-50 rounded-xl">
                    <p class="text-sm text-blue-700">
                        <i class="fas fa-info-circle mr-2"></i>
                        Gunakan akun Gmail untuk mendaftar dan masuk ke aplikasi.
                    </p>
                </div>

                <div class="mt-6 text-center text-sm text-gray-500">
                    <p>Dengan masuk, Anda menyetujui</p>
                    <a href="#" class="text-primary-600 hover:underline">Syarat & Ketentuan</a>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="mainApp" class="hidden">
            <!-- Mobile Header -->
            <header class="lg:hidden fixed top-0 left-0 right-0 bg-white shadow-sm z-40 px-4 py-3">
                <div class="flex items-center justify-between">
                    <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-xl">
                        <i class="fas fa-bars text-gray-600 text-xl"></i>
                    </button>
                    <h1 class="text-lg font-bold text-gray-800">AGSA</h1>
                    <button onclick="openNotifications()" class="p-2 hover:bg-gray-100 rounded-xl relative">
                        <i class="fas fa-bell text-gray-600"></i>
                        <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                    </button>
                </div>
            </header>

            <!-- Sidebar Overlay -->
            <div id="sidebarOverlay" class="hidden fixed inset-0 bg-black/50 z-40 lg:hidden" onclick="toggleSidebar()"></div>

            <!-- Sidebar -->
            <aside id="sidebar" class="fixed left-0 top-0 bottom-0 w-72 bg-white shadow-xl z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col">
                <!-- Logo -->
                <div class="p-6 border-b border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-gradient-to-br from-primary-500 to-primary-600 rounded-xl flex items-center justify-center shadow-lg shadow-primary-500/30">
                            <i class="fas fa-chalkboard-teacher text-xl text-white"></i>
                        </div>
                        <div>
                            <h1 class="font-bold text-gray-800">ADMIN GURU</h1>
                            <p class="text-xs text-gray-500">Super App v1.0</p>
                        </div>
                    </div>
                </div>

                <!-- User Info -->
                <div class="p-4 border-b border-gray-100">
                    <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                        <img id="userAvatar" src="https://ui-avatars.com/api/?name=User&background=0ea5e9&color=fff" alt="Avatar" class="w-10 h-10 rounded-full">
                        <div class="flex-1 min-w-0">
                            <p id="userName" class="text-sm font-semibold text-gray-800 truncate">Loading...</p>
                            <p id="userRole" class="text-xs text-gray-500">Free User</p>
                        </div>
                        <span id="userBadge" class="badge badge-info text-xs">FREE</span>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="flex-1 overflow-y-auto p-4 space-y-1">
                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider px-4 mb-2">Menu Utama</div>
                    
                    <div onclick="showPage('dashboard')" class="sidebar-item active" data-page="dashboard">
                        <i class="fas fa-home w-5"></i>
                        <span>Dashboard</span>
                    </div>
                    
                    <div onclick="showPage('profil')" class="sidebar-item" data-page="profil">
                        <i class="fas fa-user w-5"></i>
                        <span>Profil</span>
                    </div>
                    
                    <div onclick="showPage('kalender')" class="sidebar-item" data-page="kalender">
                        <i class="fas fa-calendar-alt w-5"></i>
                        <span>Kalender Pendidikan</span>
                    </div>
                    
                    <div onclick="showPage('jadwal')" class="sidebar-item" data-page="jadwal">
                        <i class="fas fa-clock w-5"></i>
                        <span>Jadwal Pelajaran</span>
                    </div>

                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider px-4 mt-6 mb-2">Dokumen</div>
                    
                    <div onclick="showPage('cp')" class="sidebar-item" data-page="cp">
                        <i class="fas fa-book w-5"></i>
                        <span>Capaian Pembelajaran</span>
                    </div>
                    
                    <div onclick="showPage('atp')" class="sidebar-item" data-page="atp">
                        <i class="fas fa-route w-5"></i>
                        <span>ATP</span>
                    </div>
                    
                    <div onclick="showPage('prota')" class="sidebar-item" data-page="prota">
                        <i class="fas fa-calendar-check w-5"></i>
                        <span>Prota</span>
                    </div>
                    
                    <div onclick="showPage('promes')" class="sidebar-item" data-page="promes">
                        <i class="fas fa-calendar-week w-5"></i>
                        <span>Promes</span>
                    </div>

                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider px-4 mt-6 mb-2">Premium <i class="fas fa-crown text-yellow-500"></i></div>
                    
                    <div onclick="showPage('modul')" class="sidebar-item" data-page="modul">
                        <i class="fas fa-book-open w-5"></i>
                        <span>Modul Ajar</span>
                        <span class="ml-auto badge badge-warning text-xs">PRO</span>
                    </div>
                    
                    <div onclick="showPage('lkpd')" class="sidebar-item" data-page="lkpd">
                        <i class="fas fa-file-alt w-5"></i>
                        <span>LKPD</span>
                        <span class="ml-auto badge badge-warning text-xs">PRO</span>
                    </div>
                    
                    <div onclick="showPage('absensi')" class="sidebar-item" data-page="absensi">
                        <i class="fas fa-clipboard-check w-5"></i>
                        <span>Absensi</span>
                        <span class="ml-auto badge badge-warning text-xs">PRO</span>
                    </div>
                    
                    <div onclick="showPage('jurnal')" class="sidebar-item" data-page="jurnal">
                        <i class="fas fa-journal-whills w-5"></i>
                        <span>Jurnal</span>
                        <span class="ml-auto badge badge-warning text-xs">PRO</span>
                    </div>
                    
                    <div onclick="showPage('nilai')" class="sidebar-item" data-page="nilai">
                        <i class="fas fa-chart-bar w-5"></i>
                        <span>Daftar Nilai</span>
                        <span class="ml-auto badge badge-warning text-xs">PRO</span>
                    </div>
                    
                    <div onclick="showPage('banksoal')" class="sidebar-item" data-page="banksoal">
                        <i class="fas fa-question-circle w-5"></i>
                        <span>Bank Soal</span>
                        <span class="ml-auto badge badge-warning text-xs">PRO</span>
                    </div>

                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider px-4 mt-6 mb-2">Data</div>
                    
                    <div onclick="showPage('siswa')" class="sidebar-item" data-page="siswa">
                        <i class="fas fa-users w-5"></i>
                        <span>Data Siswa</span>
                    </div>
                    
                    <div onclick="showPage('aiassistant')" class="sidebar-item" data-page="aiassistant">
                        <i class="fas fa-robot w-5"></i>
                        <span>AI Assistant</span>
                    </div>

                    <div id="adminMenu" class="hidden">
                        <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider px-4 mt-6 mb-2">Admin</div>
                        
                        <div onclick="showPage('admin')" class="sidebar-item" data-page="admin">
                            <i class="fas fa-cog w-5"></i>
                            <span>Super Admin</span>
                        </div>
                    </div>

                    <div onclick="showPage('panduan')" class="sidebar-item" data-page="panduan">
                        <i class="fas fa-info-circle w-5"></i>
                        <span>Panduan</span>
                    </div>
                </nav>

                <!-- Upgrade Banner -->
                <div id="upgradeBanner" class="p-4 border-t border-gray-100">
                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-xl p-4 text-white">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-crown"></i>
                            <span class="font-semibold">Upgrade Premium</span>
                        </div>
                        <p class="text-sm text-yellow-100 mb-3">Akses semua fitur tanpa batas!</p>
                        <button onclick="showUpgradeModal()" class="w-full bg-white text-orange-600 font-semibold py-2 rounded-lg hover:bg-yellow-50 transition-all">
                            Upgrade Sekarang
                        </button>
                    </div>
                </div>

                <!-- Logout -->
                <div class="p-4 border-t border-gray-100">
                    <button onclick="signOut()" class="w-full flex items-center justify-center gap-2 text-red-600 hover:bg-red-50 py-3 rounded-xl transition-all">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Keluar</span>
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="lg:ml-72 min-h-screen pt-16 lg:pt-0">
                <div class="p-4 lg:p-8">
                    <!-- Dashboard Page -->
                    <div id="page-dashboard" class="page-content">
                        <!-- Header -->
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                            <div>
                                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Selamat Datang! ðŸ‘‹</h1>
                                <p class="text-gray-500 mt-1" id="welcomeText">Loading...</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <select id="tahunAjarSelect" class="input-field py-2 text-sm" onchange="changeTahunAjar()">
                                    <!-- Options will be populated dynamically -->
                                </select>
                                <select id="semesterSelect" class="input-field py-2 text-sm" onchange="changeSemester()">
                                    <option value="1">Semester 1 (Ganjil)</option>
                                    <option value="2">Semester 2 (Genap)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Stats Cards -->
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                            <div class="card">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-users text-blue-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Total Siswa</p>
                                        <p class="text-2xl font-bold text-gray-800" id="totalSiswa">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-chalkboard text-green-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Kelas Diampu</p>
                                        <p class="text-2xl font-bold text-gray-800" id="totalKelas">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-book text-purple-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Mata Pelajaran</p>
                                        <p class="text-2xl font-bold text-gray-800" id="totalMapel">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-calendar-day text-orange-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Pertemuan Hari Ini</p>
                                        <p class="text-2xl font-bold text-gray-800" id="totalPertemuan">0</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="card mb-8">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">âš¡ Aksi Cepat</h2>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <button onclick="showPage('absensi')" class="p-4 bg-gray-50 hover:bg-primary-50 hover:text-primary-600 rounded-xl text-center transition-all">
                                    <i class="fas fa-clipboard-check text-2xl mb-2"></i>
                                    <p class="text-sm font-medium">Input Absensi</p>
                                </button>
                                <button onclick="showPage('jurnal')" class="p-4 bg-gray-50 hover:bg-primary-50 hover:text-primary-600 rounded-xl text-center transition-all">
                                    <i class="fas fa-journal-whills text-2xl mb-2"></i>
                                    <p class="text-sm font-medium">Input Jurnal</p>
                                </button>
                                <button onclick="showPage('nilai')" class="p-4 bg-gray-50 hover:bg-primary-50 hover:text-primary-600 rounded-xl text-center transition-all">
                                    <i class="fas fa-chart-bar text-2xl mb-2"></i>
                                    <p class="text-sm font-medium">Input Nilai</p>
                                </button>
                                <button onclick="showPage('modul')" class="p-4 bg-gray-50 hover:bg-primary-50 hover:text-primary-600 rounded-xl text-center transition-all">
                                    <i class="fas fa-book-open text-2xl mb-2"></i>
                                    <p class="text-sm font-medium">Buat Modul</p>
                                </button>
                            </div>
                        </div>

                        <!-- Today's Schedule & Recent Activities -->
                        <div class="grid lg:grid-cols-2 gap-8">
                            <!-- Today's Schedule -->
                            <div class="card">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-lg font-semibold text-gray-800">ðŸ“… Jadwal Hari Ini</h2>
                                    <span class="text-sm text-gray-500" id="todayDate">Loading...</span>
                                </div>
                                <div id="todaySchedule" class="space-y-3">
                                    <div class="text-center py-8 text-gray-400">
                                        <i class="fas fa-calendar-times text-4xl mb-2"></i>
                                        <p>Tidak ada jadwal hari ini</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Document Progress -->
                            <div class="card">
                                <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“Š Progress Dokumen</h2>
                                <div class="space-y-4" id="documentProgress">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-route text-blue-600"></i>
                                            </div>
                                            <span class="font-medium">ATP</span>
                                        </div>
                                        <span class="badge badge-success">Selesai</span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-calendar-check text-green-600"></i>
                                            </div>
                                            <span class="font-medium">Prota</span>
                                        </div>
                                        <span class="badge badge-success">Selesai</span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-calendar-week text-purple-600"></i>
                                            </div>
                                            <span class="font-medium">Promes</span>
                                        </div>
                                        <span class="badge badge-warning">Proses</span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-book-open text-orange-600"></i>
                                            </div>
                                            <span class="font-medium">Modul Ajar</span>
                                        </div>
                                        <span class="badge badge-danger">Belum</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profil Page -->
                    <div id="page-profil" class="page-content hidden">
                        <div class="flex items-center justify-between mb-8">
                            <div>
                                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Profil</h1>
                                <p class="text-gray-500 mt-1">Kelola data profil dan satuan pendidikan Anda</p>
                            </div>
                        </div>

                        <div class="grid lg:grid-cols-2 gap-8">
                            <!-- Data Guru -->
                            <div class="card">
                                <h2 class="text-lg font-semibold text-gray-800 mb-6 flex items-center gap-2">
                                    <i class="fas fa-user text-primary-500"></i>
                                    Data Guru
                                </h2>
                                <form id="formProfil" class="space-y-4">
                                    <div>
                                        <label class="label">Nama Lengkap</label>
                                        <input type="text" id="profilNama" class="input-field" placeholder="Masukkan nama lengkap">
                                    </div>
                                    <div>
                                        <label class="label">NIP</label>
                                        <input type="text" id="profilNIP" class="input-field" placeholder="Masukkan NIP">
                                    </div>
                                    <div>
                                        <label class="label">Email</label>
                                        <input type="email" id="profilEmail" class="input-field" readonly>
                                    </div>
                                    <div>
                                        <label class="label">No. HP</label>
                                        <input type="tel" id="profilHP" class="input-field" placeholder="Masukkan nomor HP">
                                    </div>
                                </form>
                            </div>

                            <!-- Data Satuan Pendidikan -->
                            <div class="card">
                                <h2 class="text-lg font-semibold text-gray-800 mb-6 flex items-center gap-2">
                                    <i class="fas fa-school text-primary-500"></i>
                                    Satuan Pendidikan
                                </h2>
                                <form id="formSekolah" class="space-y-4">
                                    <div>
                                        <label class="label">Nama Sekolah</label>
                                        <input type="text" id="sekolahNama" class="input-field" placeholder="Masukkan nama sekolah">
                                    </div>
                                    <div>
                                        <label class="label">NPSN</label>
                                        <input type="text" id="sekolahNPSN" class="input-field" placeholder="Masukkan NPSN">
                                    </div>
                                    <div>
                                        <label class="label">Jenjang</label>
                                        <select id="sekolahJenjang" class="input-field">
                                            <option value="">Pilih Jenjang</option>
                                            <option value="SD">SD/MI</option>
                                            <option value="SMP">SMP/MTs</option>
                                            <option value="SMA">SMA/MA</option>
                                            <option value="SMK">SMK</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="label">Alamat</label>
                                        <textarea id="sekolahAlamat" class="input-field" rows="2" placeholder="Masukkan alamat sekolah"></textarea>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="label">Kota/Kabupaten</label>
                                            <input type="text" id="sekolahKota" class="input-field" placeholder="Nama Kota/Kabupaten">
                                        </div>
                                        <div>
                                            <label class="label">Provinsi</label>
                                            <input type="text" id="sekolahProvinsi" class="input-field" placeholder="Nama Provinsi">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="label">Nama Kepala Sekolah</label>
                                        <input type="text" id="kepalaSekolah" class="input-field" placeholder="Nama Kepala Sekolah">
                                    </div>
                                    <div>
                                        <label class="label">NIP Kepala Sekolah</label>
                                        <input type="text" id="nipKepalaSekolah" class="input-field" placeholder="NIP Kepala Sekolah">
                                    </div>
                                </form>
                            </div>

                            <!-- Mata Pelajaran yang Diampu -->
                            <div class="card lg:col-span-2">
                                <div class="flex items-center justify-between mb-6">
                                    <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                                        <i class="fas fa-book text-primary-500"></i>
                                        Mata Pelajaran yang Diampu
                                    </h2>
                                    <button onclick="tambahMapel()" class="btn-primary py-2 px-4 text-sm">
                                        <i class="fas fa-plus mr-2"></i>Tambah
                                    </button>
                                </div>
                                <div id="listMapel" class="space-y-4">
                                    <!-- Dynamic content -->
                                </div>
                                <div id="emptyMapel" class="text-center py-8 text-gray-400">
                                    <i class="fas fa-book text-4xl mb-2"></i>
                                    <p>Belum ada mata pelajaran. Klik "Tambah" untuk menambahkan.</p>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 flex justify-end">
                            <button onclick="simpanProfil()" class="btn-primary">
                                <i class="fas fa-save mr-2"></i>Simpan Profil
                            </button>
                        </div>
                    </div>

                    <!-- Kalender Page -->
                    <div id="page-kalender" class="page-content hidden">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                            <div>
                                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Kalender Pendidikan</h1>
                                <p class="text-gray-500 mt-1">Atur kalender akademik sesuai kebutuhan</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="importKalenderCSV()" class="btn-secondary py-2 px-4 text-sm">
                                    <i class="fas fa-file-csv mr-2"></i>Import CSV
                                </button>
                                <button onclick="tambahEventKalender()" class="btn-primary py-2 px-4 text-sm">
                                    <i class="fas fa-plus mr-2"></i>Tambah Event
                                </button>
                            </div>
                        </div>

                        <!-- Semester Settings -->
                        <div class="grid md:grid-cols-2 gap-6 mb-8">
                            <div class="card">
                                <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-calendar-alt text-green-500"></i>
                                    Semester 1 (Ganjil)
                                </h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="label">Tanggal Mulai</label>
                                        <input type="date" id="sem1Mulai" class="input-field" onchange="updateKalender()">
                                    </div>
                                    <div>
                                        <label class="label">Tanggal Selesai</label>
                                        <input type="date" id="sem1Selesai" class="input-field" onchange="updateKalender()">
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-calendar-alt text-blue-500"></i>
                                    Semester 2 (Genap)
                                </h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="label">Tanggal Mulai</label>
                                        <input type="date" id="sem2Mulai" class="input-field" onchange="updateKalender()">
                                    </div>
                                    <div>
                                        <label class="label">Tanggal Selesai</label>
                                        <input type="date" id="sem2Selesai" class="input-field" onchange="updateKalender()">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Hari Libur & Events -->
                        <div class="card">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                                    <i class="fas fa-calendar-times text-red-500"></i>
                                    Hari Libur & Event Khusus
                                </h3>
                                <div class="flex gap-2">
                                    <button onclick="filterKalender('semua')" class="px-3 py-1 text-sm rounded-lg bg-primary-100 text-primary-700">Semua</button>
                                    <button onclick="filterKalender('libur')" class="px-3 py-1 text-sm rounded-lg bg-gray-100 text-gray-600">Libur</button>
                                    <button onclick="filterKalender('kegiatan')" class="px-3 py-1 text-sm rounded-lg bg-gray-100 text-gray-600">Kegiatan</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="table-header">
                                            <th class="px-4 py-3 text-left">Tanggal</th>
                                            <th class="px-4 py-3 text-left">Keterangan</th>
                                            <th class="px-4 py-3 text-left">Jenis</th>
                                            <th class="px-4 py-3 text-left">Status</th>
                                            <th class="px-4 py-3 text-center">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableKalender" class="divide-y divide-gray-100">
                                        <!-- Dynamic content -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="emptyKalender" class="hidden text-center py-12 text-gray-400">
                                <i class="fas fa-calendar-plus text-5xl mb-3"></i>
                                <p>Belum ada event kalender</p>
                            </div>
                        </div>

                        <div class="mt-6 flex justify-end">
                            <button onclick="simpanKalender()" class="btn-primary">
                                <i class="fas fa-save mr-2"></i>Simpan Kalender
                            </button>
                        </div>
                    </div>

                    <!-- Jadwal Pelajaran Page -->
                    <div id="page-jadwal" class="page-content hidden">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                            <div>
                                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Jadwal Pelajaran</h1>
                                <p class="text-gray-500 mt-1">Atur jadwal mengajar dengan validasi anti-bentrok</p>
                            </div>
                            <button onclick="tambahJadwal()" class="btn-primary py-2 px-4 text-sm">
                                <i class="fas fa-plus mr-2"></i>Tambah Jadwal
                            </button>
                        </div>

                        <!-- Jam Pelajaran Settings -->
                        <div class="card mb-8">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                                    <i class="fas fa-clock text-primary-500"></i>
                                    Pengaturan Jam Pelajaran
                                </h3>
                                <button onclick="tambahJamPelajaran()" class="btn-secondary py-2 px-4 text-sm">
                                    <i class="fas fa-plus mr-2"></i>Tambah Jam
                                </button>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="listJamPelajaran">
                                <!-- Dynamic content -->
                            </div>
                        </div>

                        <!-- Jadwal Table -->
                        <div class="card overflow-x-auto">
                            <div class="flex items-center gap-4 mb-6">
                                <select id="filterKelas" class="input-field py-2 text-sm w-auto" onchange="filterJadwal()">
                                    <option value="">Semua Kelas</option>
                                </select>
                                <select id="filterHari" class="input-field py-2 text-sm w-auto" onchange="filterJadwal()">
                                    <option value="">Semua Hari</option>
                                    <option value="Senin">Senin</option>
                                    <option value="Selasa">Selasa</option>
                                    <option value="Rabu">Rabu</option>
                                    <option value="Kamis">Kamis</option>
                                    <option value="Jumat">Jumat</option>
                                    <option value="Sabtu">Sabtu</option>
                                </select>
                            </div>
                            
                            <table class="w-full min-w-[800px]">
                                <thead>
                                    <tr class="table-header">
                                        <th class="px-4 py-3 text-left">Hari</th>
                                        <th class="px-4 py-3 text-left">Jam Ke</th>
                                        <th class="px-4 py-3 text-left">Waktu</th>
                                        <th class="px-4 py-3 text-left">Kelas</th>
                                        <th class="px-4 py-3 text-left">Mata Pelajaran</th>
                                        <th class="px-4 py-3 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tableJadwal" class="divide-y divide-gray-100">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                            <div id="emptyJadwal" class="hidden text-center py-12 text-gray-400">
                                <i class="fas fa-calendar-alt text-5xl mb-3"></i>
                                <p>Belum ada jadwal pelajaran</p>
                            </div>
                        </div>
                    </div>

                    <!-- CP (Capaian Pembelajaran) Page -->
                    <div id="page-cp" class="page-content hidden">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                            <div>
                                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Capaian Pembelajaran (CP)</h1>
                                <p class="text-gray-500 mt-1">Kelola CP dan Tujuan Pembelajaran</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="showDefaultCP()" class="btn-secondary py-2 px-4 text-sm">
                                    <i class="fas fa-database mr-2"></i>CP PAI Default
                                </button>
                                <button onclick="tambahCP()" class="btn-primary py-2 px-4 text-sm">
                                    <i class="fas fa-plus mr-2"></i>Tambah CP
                                </button>
                            </div>
                        </div>

                        <!-- Filter -->
                        <div class="card mb-6">
                            <div class="flex flex-wrap gap-4">
                                <select id="cpFilterKelas" class="input-field py-2 text-sm w-auto" onchange="filterCP()">
                                    <option value="">Semua Kelas</option>
                                    <option value="1">Kelas 1</option>
                                    <option value="2">Kelas 2</option>
                                    <option value="3">Kelas 3</option>
                                    <option value="4">Kelas 4</option>
                                    <option value="5">Kelas 5</option>
                                    <option value="6">Kelas 6</option>
                                </select>
                                <select id="cpFilterFase" class="input-field py-2 text-sm w-auto" onchange="filterCP()">
                                    <option value="">Semua Fase</option>
                                    <option value="A">Fase A</option>
                                    <option value="B">Fase B</option>
                                    <option value="C">Fase C</option>
                                </select>
                                <select id="cpFilterElemen" class="input-field py-2 text-sm w-auto" onchange="filterCP()">
                                    <option value="">Semua Elemen</option>
                                    <option value="Al-Qur'an dan Hadis">Al-Qur'an dan Hadis</option>
                                    <option value="Akidah">Akidah</option>
                                    <option value="Akhlak">Akhlak</option>
                                    <option value="Fikih">Fikih</option>
                                    <option value="Sejarah Peradaban Islam">Sejarah Peradaban Islam</option>
                                </select>
                            </div>
                        </div>

                        <!-- CP List -->
                        <div id="listCP" class="space-y-4">
                            <!-- Dynamic content -->
                        </div>
                        <div id="emptyCP" class="card text-center py-12 text-gray-400">
                            <i class="fas fa-book text-5xl mb-3"></i>
                            <p>Belum ada Capaian Pembelajaran</p>
                            <p class="text-sm mt-2">Gunakan "CP PAI Default" atau tambah manual</p>
                        </div>
                    </div>

                    <!-- ATP Page -->
                    <div id="page-atp" class="page-content hidden">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                            <div>
                                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Alur Tujuan Pembelajaran (ATP)</h1>
                                <p class="text-gray-500 mt-1">ATP otomatis tersinkronisasi dengan CP</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="generateATP()" class="btn-secondary py-2 px-4 text-sm">
                                    <i class="fas fa-sync mr-2"></i>Generate ATP
                                </button>
                                <button onclick="exportATP()" class="btn-primary py-2 px-4 text-sm">
                                    <i class="fas fa-file-export mr-2"></i>Export
                                </button>
                            </div>
                        </div>

                        <!-- Filter -->
                        <div class="card mb-6">
                            <div class="flex flex-wrap gap-4">
                                <select id="atpFilterKelas" class="input-field py-2 text-sm w-auto" onchange="filterATP()">
                                    <option value="">Semua Kelas</option>
                                </select>
                                <select id="atpFilterMapel" class="input-field py-2 text-sm w-auto" onchange="filterATP()">
                                    <option value="">Semua Mapel</option>
                                </select>
                            </div>
                        </div>

                        <!-- ATP Preview -->
                        <div id="atpPreview" class="card">
                            <div class="overflow-x-auto">
                                <table class="w-full min-w-[1000px]">
                                    <thead>
                                        <tr class="table-header">
                                            <th class="px-4 py-3 text-left">No</th>
                                            <th class="px-4 py-3 text-left">Elemen</th>
                                            <th class="px-4 py-3 text-left">Tujuan Pembelajaran</th>
                                            <th class="px-4 py-3 text-left">Materi</th>
                                            <th class="px-4 py-3 text-center">JP</th>
                                            <th class="px-4 py-3 text-left">Profil Lulusan</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableATP" class="divide-y divide-gray-100">
                                        <!-- Dynamic content -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Prota Page -->
                    <div id="page-prota" class="page-content hidden">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                            <div>
                                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Program Tahunan (Prota)</h1>
                                <p class="text-gray-500 mt-1">Prota tersinkronisasi dengan ATP dan Kalender</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="generateProta()" class="btn-secondary py-2 px-4 text-sm">
                                    <i class="fas fa-sync mr-2"></i>Generate Prota
                                </button>
                                <button onclick="printProta()" class="btn-primary py-2 px-4 text-sm">
                                    <i class="fas fa-print mr-2"></i>Cetak
                                </button>
                            </div>
                        </div>

                        <!-- Prota Document -->
                        <div id="protaDocument" class="card">
                            <div class="text-center mb-8 print-only">
                                <h2 class="text-xl font-bold">PROGRAM TAHUNAN (PROTA)</h2>
                                <p class="text-gray-600">Tahun Pelajaran <span id="protaTahunAjar">2024/2025</span></p>
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-6 mb-8 no-print">
                                <div>
                                    <label class="label">Mata Pelajaran</label>
                                    <select id="protaMapel" class="input-field" onchange="updateProta()">
                                        <option value="">Pilih Mata Pelajaran</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="label">Kelas</label>
                                    <select id="protaKelas" class="input-field" onchange="updateProta()">
                                        <option value="">Pilih Kelas</option>
                                    </select>
                                </div>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse border border-gray-300">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-4 py-2">Semester</th>
                                            <th class="border border-gray-300 px-4 py-2">Elemen/Bab</th>
                                            <th class="border border-gray-300 px-4 py-2">Tujuan Pembelajaran</th>
                                            <th class="border border-gray-300 px-4 py-2">Alokasi Waktu (JP)</th>
                                            <th class="border border-gray-300 px-4 py-2">Keterangan</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableProta">
                                        <!-- Dynamic content -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Signature -->
                            <div class="grid grid-cols-2 gap-8 mt-12 text-center text-sm">
                                <div>
                                    <p>Mengetahui,</p>
                                    <p>Kepala Sekolah</p>
                                    <div class="h-20"></div>
                                    <p class="font-semibold border-b border-gray-400 inline-block" id="protaKepsek">_________________</p>
                                    <p id="protaNIPKepsek">NIP. </p>
                                </div>
                                <div>
                                    <p id="protaKota">_________________, __________</p>
                                    <p>Guru Mata Pelajaran</p>
                                    <div class="h-20"></div>
                                    <p class="font-semibold border-b border-gray-400 inline-block" id="protaGuru">_________________</p>
                                    <p id="protaNIPGuru">NIP. </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Promes Page -->
                    <div id="page-promes" class="page-content hidden">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                            <div>
                                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Program Semester (Promes)</h1>
                                <p class="text-gray-500 mt-1">Promes dengan detail tanggal per pertemuan</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="generatePromes()" class="btn-secondary py-2 px-4 text-sm">
                                    <i class="fas fa-sync mr-2"></i>Generate Promes
                                </button>
                                <button onclick="printPromes()" class="btn-primary py-2 px-4 text-sm">
                                    <i class="fas fa-print mr-2"></i>Cetak
                                </button>
                            </div>
                        </div>

                        <!-- Promes Filter -->
                        <div class="card mb-6">
                            <div class="grid md:grid-cols-3 gap-4">
                                <div>
                                    <label class="label">Mata Pelajaran</label>
                                    <select id="promesMapel" class="input-field" onchange="updatePromes()">
                                        <option value="">Pilih Mata Pelajaran</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="label">Kelas</label>
                                    <select id="promesKelas" class="input-field" onchange="updatePromes()">
                                        <option value="">Pilih Kelas</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="label">Semester</label>
                                    <select id="promesSemester" class="input-field" onchange="updatePromes()">
                                        <option value="1">Semester 1 (Ganjil)</option>
                                        <option value="2">Semester 2 (Genap)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Promes Document -->
                        <div id="promesDocument" class="card overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300 min-w-[1200px]">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="border border-gray-300 px-3 py-2" rowspan="2">No</th>
                                        <th class="border border-gray-300 px-3 py-2" rowspan="2">Elemen/Bab</th>
                                        <th class="border border-gray-300 px-3 py-2" rowspan="2">Tujuan Pembelajaran</th>
                                        <th class="border border-gray-300 px-3 py-2" rowspan="2">JP</th>
                                        <th class="border border-gray-300 px-3 py-2" colspan="20">Bulan dan Minggu</th>
                                    </tr>
                                    <tr class="bg-gray-50" id="promesHeaderMinggu">
                                        <!-- Dynamic weeks -->
                                    </tr>
                                </thead>
                                <tbody id="tablePromes">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Modul Ajar Page (Premium) -->
                    <div id="page-modul" class="page-content hidden">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                            <div>
                                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Modul Ajar</h1>
                                <p class="text-gray-500 mt-1">Modul ajar terintegrasi dengan Promes dan LKPD</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="tambahModul()" class="btn-primary py-2 px-4 text-sm">
                                    <i class="fas fa-plus mr-2"></i>Buat Modul Baru
                                </button>
                            </div>
                        </div>

                        <!-- Premium Check -->
                        <div id="modulPremiumCheck" class="card text-center py-12">
                            <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-crown text-4xl text-yellow-500"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Fitur Premium</h3>
                            <p class="text-gray-500 mb-6">Upgrade ke Premium untuk mengakses Modul Ajar</p>
                            <button onclick="showUpgradeModal()" class="btn-primary">
                                <i class="fas fa-arrow-up mr-2"></i>Upgrade Sekarang
                            </button>
                        </div>

                        <!-- Modul List (Premium Only) -->
                        <div id="modulContent" class="hidden">
                            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="listModul">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                    </div>

                    <!-- LKPD Page (Premium) -->
                    <div id="page-lkpd" class="page-content hidden">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                            <div>
                                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">LKPD (Lembar Kerja Peserta Didik)</h1>
                                <p class="text-gray-500 mt-1">LKPD terintegrasi dengan Modul Ajar</p>
                            </div>
                        </div>

                        <div id="lkpdPremiumCheck" class="card text-center py-12">
                            <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-crown text-4xl text-yellow-500"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Fitur Premium</h3>
                            <p class="text-gray-500 mb-6">Upgrade ke Premium untuk mengakses LKPD</p>
                            <button onclick="showUpgradeModal()" class="btn-primary">
                                <i class="fas fa-arrow-up mr-2"></i>Upgrade Sekarang
                            </button>
                        </div>
                    </div>

                    <!-- Absensi Page (Premium) -->
                    <div id="page-absensi" class="page-content hidden">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                            <div>
                                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Absensi</h1>
                                <p class="text-gray-500 mt-1">Input absensi terintegrasi dengan jurnal</p>
                            </div>
                        </div>

                        <div id="absensiPremiumCheck" class="card text-center py-12">
                            <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-crown text-4xl text-yellow-500"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Fitur Premium</h3>
                            <p class="text-gray-500 mb-6">Upgrade ke Premium untuk mengakses Absensi</p>
                            <button onclick="showUpgradeModal()" class="btn-primary">
                                <i class="fas fa-arrow-up mr-2"></i>Upgrade Sekarang
                            </button>
                        </div>

                        <div id="absensiContent" class="hidden">
                            <!-- Absensi Filter -->
                            <div class="card mb-6">
                                <div class="grid md:grid-cols-4 gap-4">
                                    <div>
                                        <label class="label">Tanggal</label>
                                        <input type="date" id="absensiTanggal" class="input-field" onchange="loadAbsensi()">
                                    </div>
                                    <div>
                                        <label class="label">Kelas</label>
                                        <select id="absensiKelas" class="input-field" onchange="loadAbsensi()">
                                            <option value="">Pilih Kelas</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="label">Mata Pelajaran</label>
                                        <select id="absensiMapel" class="input-field" onchange="loadAbsensi()">
                                            <option value="">Pilih Mapel</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="label">Jam Ke</label>
                                        <select id="absensiJam" class="input-field" onchange="loadAbsensi()">
                                            <option value="">Pilih Jam</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Absensi Table -->
                            <div class="card">
                                <table class="w-full">
                                    <thead>
                                        <tr class="table-header">
                                            <th class="px-4 py-3 text-left">No</th>
                                            <th class="px-4 py-3 text-left">NISN</th>
                                            <th class="px-4 py-3 text-left">Nama Siswa</th>
                                            <th class="px-4 py-3 text-center">H</th>
                                            <th class="px-4 py-3 text-center">S</th>
                                            <th class="px-4 py-3 text-center">I</th>
                                            <th class="px-4 py-3 text-center">A</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableAbsensi" class="divide-y divide-gray-100">
                                        <!-- Dynamic content -->
                                    </tbody>
                                </table>
                                <div class="mt-6 flex justify-end">
                                    <button onclick="simpanAbsensi()" class="btn-primary">
                                        <i class="fas fa-save mr-2"></i>Simpan Absensi
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Jurnal Page (Premium) -->
                    <div id="page-jurnal" class="page-content hidden">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                            <div>
                                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Jurnal Pembelajaran</h1>
                                <p class="text-gray-500 mt-1">Jurnal sinkron dengan absen dan promes</p>
                            </div>
                            <button onclick="printJurnal()" class="btn-primary py-2 px-4 text-sm">
                                <i class="fas fa-print mr-2"></i>Cetak Jurnal
                            </button>
                        </div>

                        <div id="jurnalPremiumCheck" class="card text-center py-12">
                            <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-crown text-4xl text-yellow-500"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Fitur Premium</h3>
                            <p class="text-gray-500 mb-6">Upgrade ke Premium untuk mengakses Jurnal</p>
                            <button onclick="showUpgradeModal()" class="btn-primary">
                                <i class="fas fa-arrow-up mr-2"></i>Upgrade Sekarang
                            </button>
                        </div>

                        <div id="jurnalContent" class="hidden">
                            <div class="card mb-6">
                                <div class="grid md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="label">Mata Pelajaran</label>
                                        <select id="jurnalMapel" class="input-field" onchange="loadJurnal()">
                                            <option value="">Pilih Mapel</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="label">Kelas</label>
                                        <select id="jurnalKelas" class="input-field" onchange="loadJurnal()">
                                            <option value="">Pilih Kelas</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="label">Semester</label>
                                        <select id="jurnalSemester" class="input-field" onchange="loadJurnal()">
                                            <option value="1">Semester 1</option>
                                            <option value="2">Semester 2</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Jurnal Document -->
                            <div class="card overflow-x-auto" id="jurnalDocument">
                                <div class="text-center mb-6">
                                    <h2 class="text-lg font-bold">JURNAL PEMBELAJARAN</h2>
                                    <p class="text-sm text-gray-600">Mata Pelajaran: <span id="jurnalMapelTitle">-</span></p>
                                    <p class="text-sm text-gray-600">Semester: <span id="jurnalSemesterTitle">-</span> | Tahun Pelajaran: <span id="jurnalTahunTitle">-</span></p>
                                </div>
                                <table class="w-full border-collapse border border-gray-300">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-3 py-2">No</th>
                                            <th class="border border-gray-300 px-3 py-2">Kelas</th>
                                            <th class="border border-gray-300 px-3 py-2">Materi</th>
                                            <th class="border border-gray-300 px-3 py-2">Tujuan Pembelajaran</th>
                                            <th class="border border-gray-300 px-3 py-2">Kehadiran</th>
                                            <th class="border border-gray-300 px-3 py-2">Hari/Tanggal</th>
                                            <th class="border border-gray-300 px-3 py-2">Hasil Pembelajaran</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableJurnal">
                                        <!-- Dynamic content -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Nilai Page (Premium) -->
                    <div id="page-nilai" class="page-content hidden">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                            <div>
                                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Daftar Nilai</h1>
                                <p class="text-gray-500 mt-1">Kelola nilai PH, PTS, PAS dan Nilai Raport</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="settingNilai()" class="btn-secondary py-2 px-4 text-sm">
                                    <i class="fas fa-cog mr-2"></i>Pengaturan
                                </button>
                                <button onclick="exportNilai()" class="btn-primary py-2 px-4 text-sm">
                                    <i class="fas fa-file-export mr-2"></i>Export
                                </button>
                            </div>
                        </div>

                        <div id="nilaiPremiumCheck" class="card text-center py-12">
                            <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-crown text-4xl text-yellow-500"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Fitur Premium</h3>
                            <p class="text-gray-500 mb-6">Upgrade ke Premium untuk mengakses Daftar Nilai</p>
                            <button onclick="showUpgradeModal()" class="btn-primary">
                                <i class="fas fa-arrow-up mr-2"></i>Upgrade Sekarang
                            </button>
                        </div>
                    </div>

                    <!-- Bank Soal Page (Premium) -->
                    <div id="page-banksoal" class="page-content hidden">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                            <div>
                                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Bank Soal</h1>
                                <p class="text-gray-500 mt-1">Bank soal terintegrasi dengan ATP (support teks Arab)</p>
                            </div>
                            <button onclick="tambahSoal()" class="btn-primary py-2 px-4 text-sm">
                                <i class="fas fa-plus mr-2"></i>Tambah Soal
                            </button>
                        </div>

                        <div id="banksoalPremiumCheck" class="card text-center py-12">
                            <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-crown text-4xl text-yellow-500"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Fitur Premium</h3>
                            <p class="text-gray-500 mb-6">Upgrade ke Premium untuk mengakses Bank Soal</p>
                            <button onclick="showUpgradeModal()" class="btn-primary">
                                <i class="fas fa-arrow-up mr-2"></i>Upgrade Sekarang
                            </button>
                        </div>
                    </div>

                    <!-- Data Siswa Page -->
                    <div id="page-siswa" class="page-content hidden">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                            <div>
                                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Data Siswa</h1>
                                <p class="text-gray-500 mt-1">Kelola data siswa dengan import CSV</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="downloadTemplateSiswa()" class="btn-secondary py-2 px-4 text-sm">
                                    <i class="fas fa-download mr-2"></i>Template CSV
                                </button>
                                <button onclick="importSiswaCSV()" class="btn-primary py-2 px-4 text-sm">
                                    <i class="fas fa-file-csv mr-2"></i>Import CSV
                                </button>
                            </div>
                        </div>

                        <!-- Info CSV -->
                        <div class="card mb-6 bg-blue-50 border-blue-200">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-info-circle text-blue-500 text-xl mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-blue-800">Import Data Siswa dari Google Spreadsheet</h4>
                                    <p class="text-sm text-blue-600 mt-1">
                                        Format CSV: nisn, nama, jenis_kelamin (L/P), kelas, rombel<br>
                                        Publikasikan spreadsheet sebagai CSV dan gunakan URL-nya untuk import.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Filter -->
                        <div class="card mb-6">
                            <div class="flex flex-wrap gap-4">
                                <select id="siswaFilterKelas" class="input-field py-2 text-sm w-auto" onchange="filterSiswa()">
                                    <option value="">Semua Kelas</option>
                                </select>
                                <select id="siswaFilterRombel" class="input-field py-2 text-sm w-auto" onchange="filterSiswa()">
                                    <option value="">Semua Rombel</option>
                                </select>
                                <input type="text" id="siswaSearch" class="input-field py-2 text-sm w-auto" placeholder="Cari nama/NISN..." oninput="filterSiswa()">
                            </div>
                        </div>

                        <!-- Siswa Table -->
                        <div class="card overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="table-header">
                                        <th class="px-4 py-3 text-left">No</th>
                                        <th class="px-4 py-3 text-left">NISN</th>
                                        <th class="px-4 py-3 text-left">Nama Siswa</th>
                                        <th class="px-4 py-3 text-center">L/P</th>
                                        <th class="px-4 py-3 text-center">Kelas</th>
                                        <th class="px-4 py-3 text-center">Rombel</th>
                                        <th class="px-4 py-3 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tableSiswa" class="divide-y divide-gray-100">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                            <div id="emptySiswa" class="text-center py-12 text-gray-400">
                                <i class="fas fa-users text-5xl mb-3"></i>
                                <p>Belum ada data siswa</p>
                                <p class="text-sm mt-2">Import data dari CSV atau tambah manual</p>
                            </div>
                        </div>
                    </div>

                    <!-- AI Assistant Page -->
                    <div id="page-aiassistant" class="page-content hidden">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                            <div>
                                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">AI Assistant</h1>
                                <p class="text-gray-500 mt-1">Bantuan AI untuk mengubah materi menjadi format CSV</p>
                            </div>
                        </div>

                        <div class="grid lg:grid-cols-2 gap-8">
                            <!-- Prompt Templates -->
                            <div class="card">
                                <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-lightbulb text-yellow-500"></i>
                                    Template Prompt
                                </h3>
                                <div class="space-y-4">
                                    <div class="p-4 bg-gray-50 rounded-xl cursor-pointer hover:bg-primary-50 transition-all" onclick="usePrompt('siswa')">
                                        <h4 class="font-medium text-gray-800">ðŸ“‹ Data Siswa</h4>
                                        <p class="text-sm text-gray-500 mt-1">Ubah daftar nama siswa menjadi format CSV</p>
                                    </div>
                                    <div class="p-4 bg-gray-50 rounded-xl cursor-pointer hover:bg-primary-50 transition-all" onclick="usePrompt('kalender')">
                                        <h4 class="font-medium text-gray-800">ðŸ“… Kalender Pendidikan</h4>
                                        <p class="text-sm text-gray-500 mt-1">Ubah jadwal kegiatan menjadi format CSV</p>
                                    </div>
                                    <div class="p-4 bg-gray-50 rounded-xl cursor-pointer hover:bg-primary-50 transition-all" onclick="usePrompt('cp')">
                                        <h4 class="font-medium text-gray-800">ðŸ“š Capaian Pembelajaran</h4>
                                        <p class="text-sm text-gray-500 mt-1">Format CP dan TP untuk sistem</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Prompt Output -->
                            <div class="card">
                                <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-copy text-primary-500"></i>
                                    Prompt untuk AI
                                </h3>
                                <textarea id="aiPrompt" class="input-field h-64 font-mono text-sm" readonly placeholder="Pilih template di sebelah kiri..."></textarea>
                                <div class="mt-4 flex gap-3">
                                    <button onclick="copyPrompt()" class="btn-primary flex-1">
                                        <i class="fas fa-copy mr-2"></i>Salin Prompt
                                    </button>
                                    <button onclick="openChatGPT()" class="btn-secondary">
                                        <i class="fas fa-external-link-alt mr-2"></i>Buka ChatGPT
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Instructions -->
                        <div class="card mt-8 bg-gradient-to-r from-primary-50 to-blue-50">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <i class="fas fa-question-circle text-primary-500"></i>
                                Cara Menggunakan
                            </h3>
                            <ol class="list-decimal list-inside space-y-2 text-gray-600">
                                <li>Pilih template prompt sesuai data yang ingin diformat</li>
                                <li>Salin prompt yang muncul</li>
                                <li>Paste prompt ke ChatGPT atau AI lainnya</li>
                                <li>Masukkan data mentah Anda ke AI</li>
                                <li>Salin hasil CSV dari AI</li>
                                <li>Import ke sistem menggunakan fitur Import CSV</li>
                            </ol>
                        </div>
                    </div>

                    <!-- Super Admin Page -->
                    <div id="page-admin" class="page-content hidden">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                            <div>
                                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Super Admin Panel</h1>
                                <p class="text-gray-500 mt-1">Kelola pengguna, langganan, dan CP default</p>
                            </div>
                        </div>

                        <!-- Admin Stats -->
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                            <div class="card">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-users text-blue-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Total Pengguna</p>
                                        <p class="text-2xl font-bold text-gray-800" id="adminTotalUsers">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-crown text-yellow-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">User Premium</p>
                                        <p class="text-2xl font-bold text-gray-800" id="adminPremiumUsers">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-school text-green-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Paket Sekolah</p>
                                        <p class="text-2xl font-bold text-gray-800" id="adminSchoolPkg">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-book text-purple-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Total CP</p>
                                        <p class="text-2xl font-bold text-gray-800" id="adminTotalCP">0</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Admin Tabs -->
                        <div class="flex gap-2 mb-6 overflow-x-auto">
                            <button onclick="showAdminTab('users')" class="admin-tab px-4 py-2 rounded-xl bg-primary-500 text-white font-medium" data-tab="users">Pengguna</button>
                            <button onclick="showAdminTab('subscription')" class="admin-tab px-4 py-2 rounded-xl bg-gray-100 text-gray-600 font-medium" data-tab="subscription">Langganan</button>
                            <button onclick="showAdminTab('cpdefault')" class="admin-tab px-4 py-2 rounded-xl bg-gray-100 text-gray-600 font-medium" data-tab="cpdefault">CP Default</button>
                            <button onclick="showAdminTab('settings')" class="admin-tab px-4 py-2 rounded-xl bg-gray-100 text-gray-600 font-medium" data-tab="settings">Pengaturan</button>
                        </div>

                        <!-- Users Tab -->
                        <div id="adminTab-users" class="admin-tab-content card">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="font-semibold text-gray-800">Daftar Pengguna</h3>
                                <input type="text" id="adminSearchUser" class="input-field py-2 text-sm w-64" placeholder="Cari email/nama...">
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="table-header">
                                            <th class="px-4 py-3 text-left">Email</th>
                                            <th class="px-4 py-3 text-left">Nama</th>
                                            <th class="px-4 py-3 text-center">Status</th>
                                            <th class="px-4 py-3 text-left">Terdaftar</th>
                                            <th class="px-4 py-3 text-center">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="adminTableUsers" class="divide-y divide-gray-100">
                                        <!-- Dynamic content -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Subscription Tab -->
                        <div id="adminTab-subscription" class="admin-tab-content card hidden">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="font-semibold text-gray-800">Pengaturan Langganan</h3>
                            </div>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label class="label">No. WhatsApp Upgrade</label>
                                    <input type="text" id="adminWANumber" class="input-field" placeholder="628xxxxxxxxxx">
                                    <p class="text-sm text-gray-500 mt-1">User akan diarahkan ke nomor ini untuk upgrade</p>
                                </div>
                                <div>
                                    <label class="label">Pesan WhatsApp Default</label>
                                    <textarea id="adminWAMessage" class="input-field" rows="3" placeholder="Halo, saya ingin upgrade ke Premium..."></textarea>
                                </div>
                                <div>
                                    <label class="label">Harga Perorangan</label>
                                    <input type="number" id="adminPricePersonal" class="input-field" placeholder="100000">
                                </div>
                                <div>
                                    <label class="label">Harga Paket Sekolah</label>
                                    <input type="number" id="adminPriceSchool" class="input-field" placeholder="500000">
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end">
                                <button onclick="saveAdminSettings()" class="btn-primary">
                                    <i class="fas fa-save mr-2"></i>Simpan Pengaturan
                                </button>
                            </div>
                        </div>

                        <!-- CP Default Tab -->
                        <div id="adminTab-cpdefault" class="admin-tab-content card hidden">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="font-semibold text-gray-800">CP Default PAI</h3>
                                <button onclick="tambahCPDefault()" class="btn-primary py-2 px-4 text-sm">
                                    <i class="fas fa-plus mr-2"></i>Tambah CP
                                </button>
                            </div>
                            <div class="mb-6 p-4 bg-amber-50 rounded-xl border border-amber-200">
                                <h4 class="font-medium text-amber-800 mb-2">8 Dimensi Profil Lulusan:</h4>
                                <div class="flex flex-wrap gap-2">
                                    <span class="badge badge-info">Keimanan</span>
                                    <span class="badge badge-info">Kewargaan</span>
                                    <span class="badge badge-info">Penalaran Kritis</span>
                                    <span class="badge badge-info">Kreativitas</span>
                                    <span class="badge badge-info">Kolaborasi</span>
                                    <span class="badge badge-info">Kemandirian</span>
                                    <span class="badge badge-info">Kesehatan</span>
                                    <span class="badge badge-info">Komunikasi</span>
                                </div>
                            </div>
                            <div id="listCPDefault" class="space-y-4">
                                <!-- Dynamic content -->
                            </div>
                        </div>

                        <!-- Settings Tab -->
                        <div id="adminTab-settings" class="admin-tab-content card hidden">
                            <h3 class="font-semibold text-gray-800 mb-6">Pengaturan Umum</h3>
                            <div class="space-y-6">
                                <div>
                                    <label class="label">Nama Aplikasi</label>
                                    <input type="text" id="adminAppName" class="input-field" value="ADMIN GURU SUPER APP">
                                </div>
                                <div>
                                    <label class="label">Deskripsi Aplikasi</label>
                                    <textarea id="adminAppDesc" class="input-field" rows="2">Aplikasi administrasi guru dengan konsep Single Input - Multi Output</textarea>
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end">
                                <button onclick="saveAdminSettings()" class="btn-primary">
                                    <i class="fas fa-save mr-2"></i>Simpan Pengaturan
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Panduan Page -->
                    <div id="page-panduan" class="page-content hidden">
                        <div class="mb-8">
                            <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Panduan Penggunaan</h1>
                            <p class="text-gray-500 mt-1">Pelajari cara menggunakan ADMIN GURU SUPER APP</p>
                        </div>

                        <div class="space-y-6">
                            <!-- Getting Started -->
                            <div class="card">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-rocket text-primary-500"></i>
                                    Memulai
                                </h3>
                                <div class="prose prose-sm max-w-none text-gray-600">
                                    <ol class="list-decimal list-inside space-y-3">
                                        <li><strong>Lengkapi Profil:</strong> Isi data diri dan data sekolah di menu Profil. Data ini akan digunakan untuk semua dokumen.</li>
                                        <li><strong>Tambah Mata Pelajaran:</strong> Tambahkan mata pelajaran yang Anda ampu beserta jumlah jam per minggu.</li>
                                        <li><strong>Atur Kalender:</strong> Tentukan tanggal semester dan hari libur di menu Kalender Pendidikan.</li>
                                        <li><strong>Buat Jadwal:</strong> Atur jadwal mengajar dengan validasi anti-bentrok.</li>
                                        <li><strong>Input CP/TP:</strong> Gunakan CP default PAI atau input manual untuk mata pelajaran lain.</li>
                                    </ol>
                                </div>
                            </div>

                            <!-- Single Input Multi Output -->
                            <div class="card">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-magic text-purple-500"></i>
                                    Konsep Single Input - Multi Output
                                </h3>
                                <div class="prose prose-sm max-w-none text-gray-600">
                                    <p>Aplikasi ini dirancang untuk meminimalkan input data berulang:</p>
                                    <div class="grid md:grid-cols-2 gap-6 mt-4">
                                        <div class="p-4 bg-green-50 rounded-xl">
                                            <h4 class="font-semibold text-green-800 mb-2">ðŸ“¥ Input Sekali:</h4>
                                            <ul class="list-disc list-inside text-sm text-green-600 space-y-1">
                                                <li>Kalender Pendidikan</li>
                                                <li>Jadwal Pelajaran</li>
                                                <li>Capaian Pembelajaran (CP)</li>
                                                <li>Data Siswa</li>
                                            </ul>
                                        </div>
                                        <div class="p-4 bg-blue-50 rounded-xl">
                                            <h4 class="font-semibold text-blue-800 mb-2">ðŸ“¤ Output Otomatis:</h4>
                                            <ul class="list-disc list-inside text-sm text-blue-600 space-y-1">
                                                <li>ATP (Alur Tujuan Pembelajaran)</li>
                                                <li>Prota (Program Tahunan)</li>
                                                <li>Promes (Program Semester)</li>
                                                <li>Modul Ajar & LKPD</li>
                                                <li>Jurnal Pembelajaran</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Import CSV -->
                            <div class="card">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-file-csv text-green-500"></i>
                                    Import Data CSV
                                </h3>
                                <div class="prose prose-sm max-w-none text-gray-600">
                                    <p>Anda dapat mengimport data massal menggunakan file CSV dari Google Spreadsheet:</p>
                                    <h4 class="font-medium mt-4">Format CSV Data Siswa:</h4>
                                    <code class="block p-3 bg-gray-100 rounded-lg text-sm">
                                        nisn,nama,jenis_kelamin,kelas,rombel<br>
                                        1234567890,Ahmad Rizki,L,1,A<br>
                                        1234567891,Siti Fatimah,P,1,A
                                    </code>
                                    <h4 class="font-medium mt-4">Cara Publish Google Spreadsheet sebagai CSV:</h4>
                                    <ol class="list-decimal list-inside space-y-2">
                                        <li>Buka Google Spreadsheet Anda</li>
                                        <li>Klik File â†’ Share â†’ Publish to web</li>
                                        <li>Pilih sheet dan format CSV</li>
                                        <li>Klik Publish dan salin URL</li>
                                        <li>Gunakan URL tersebut di fitur Import CSV</li>
                                    </ol>
                                </div>
                            </div>

                            <!-- AI Assistant -->
                            <div class="card">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-robot text-indigo-500"></i>
                                    AI Assistant
                                </h3>
                                <div class="prose prose-sm max-w-none text-gray-600">
                                    <p>Gunakan AI Assistant untuk mengubah data mentah menjadi format CSV:</p>
                                    <ol class="list-decimal list-inside space-y-2 mt-4">
                                        <li>Buka menu AI Assistant</li>
                                        <li>Pilih template prompt sesuai kebutuhan</li>
                                        <li>Salin prompt yang muncul</li>
                                        <li>Paste ke ChatGPT atau AI lainnya</li>
                                        <li>Masukkan data mentah Anda</li>
                                        <li>Salin hasil CSV dan import ke sistem</li>
                                    </ol>
                                </div>
                            </div>

                            <!-- Subscription -->
                            <div class="card">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-crown text-yellow-500"></i>
                                    Fitur Free vs Premium
                                </h3>
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead>
                                            <tr class="table-header">
                                                <th class="px-4 py-3 text-left">Fitur</th>
                                                <th class="px-4 py-3 text-center">Free</th>
                                                <th class="px-4 py-3 text-center">Premium</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-100">
                                            <tr><td class="px-4 py-3">Kalender Pendidikan</td><td class="px-4 py-3 text-center text-green-500"><i class="fas fa-check"></i></td><td class="px-4 py-3 text-center text-green-500"><i class="fas fa-check"></i></td></tr>
                                            <tr><td class="px-4 py-3">Jadwal Pelajaran</td><td class="px-4 py-3 text-center text-green-500"><i class="fas fa-check"></i></td><td class="px-4 py-3 text-center text-green-500"><i class="fas fa-check"></i></td></tr>
                                            <tr><td class="px-4 py-3">ATP</td><td class="px-4 py-3 text-center text-green-500"><i class="fas fa-check"></i></td><td class="px-4 py-3 text-center text-green-500"><i class="fas fa-check"></i></td></tr>
                                            <tr><td class="px-4 py-3">Prota</td><td class="px-4 py-3 text-center text-green-500"><i class="fas fa-check"></i></td><td class="px-4 py-3 text-center text-green-500"><i class="fas fa-check"></i></td></tr>
                                            <tr><td class="px-4 py-3">Promes</td><td class="px-4 py-3 text-center text-red-500"><i class="fas fa-times"></i></td><td class="px-4 py-3 text-center text-green-500"><i class="fas fa-check"></i></td></tr>
                                            <tr><td class="px-4 py-3">Modul Ajar</td><td class="px-4 py-3 text-center text-red-500"><i class="fas fa-times"></i></td><td class="px-4 py-3 text-center text-green-500"><i class="fas fa-check"></i></td></tr>
                                            <tr><td class="px-4 py-3">LKPD</td><td class="px-4 py-3 text-center text-red-500"><i class="fas fa-times"></i></td><td class="px-4 py-3 text-center text-green-500"><i class="fas fa-check"></i></td></tr>
                                            <tr><td class="px-4 py-3">Absensi & Jurnal</td><td class="px-4 py-3 text-center text-red-500"><i class="fas fa-times"></i></td><td class="px-4 py-3 text-center text-green-500"><i class="fas fa-check"></i></td></tr>
                                            <tr><td class="px-4 py-3">Daftar Nilai</td><td class="px-4 py-3 text-center text-red-500"><i class="fas fa-times"></i></td><td class="px-4 py-3 text-center text-green-500"><i class="fas fa-check"></i></td></tr>
                                            <tr><td class="px-4 py-3">Bank Soal</td><td class="px-4 py-3 text-center text-red-500"><i class="fas fa-times"></i></td><td class="px-4 py-3 text-center text-green-500"><i class="fas fa-check"></i></td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="modal-backdrop hidden">
        <div class="modal-content p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">Upgrade ke Premium</h3>
                <button onclick="closeModal('upgradeModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-crown text-4xl text-white"></i>
                </div>
                <h4 class="text-lg font-semibold text-gray-800">Akses Semua Fitur Premium!</h4>
                <p class="text-gray-500 mt-2">Modul Ajar, LKPD, Absensi, Jurnal, Nilai, Bank Soal</p>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-4 border-2 border-primary-500 rounded-xl text-center">
                    <h5 class="font-semibold text-primary-600">Perorangan</h5>
                    <p class="text-2xl font-bold text-gray-800 mt-2" id="modalPricePersonal">Rp 100.000</p>
                    <p class="text-sm text-gray-500">/tahun</p>
                </div>
                <div class="p-4 border-2 border-orange-500 rounded-xl text-center bg-orange-50">
                    <h5 class="font-semibold text-orange-600">Paket Sekolah</h5>
                    <p class="text-2xl font-bold text-gray-800 mt-2" id="modalPriceSchool">Rp 500.000</p>
                    <p class="text-sm text-gray-500">/tahun (unlimited)</p>
                </div>
            </div>
            <button onclick="redirectToWhatsApp()" class="w-full btn-primary flex items-center justify-center gap-2">
                <i class="fab fa-whatsapp text-xl"></i>
                Hubungi via WhatsApp
            </button>
        </div>
    </div>

    <!-- Add Mapel Modal -->
    <div id="mapelModal" class="modal-backdrop hidden">
        <div class="modal-content p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">Tambah Mata Pelajaran</h3>
                <button onclick="closeModal('mapelModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="formMapel" class="space-y-4">
                <div>
                    <label class="label">Nama Mata Pelajaran</label>
                    <input type="text" id="mapelNama" class="input-field" placeholder="Contoh: Pendidikan Agama Islam">
                </div>
                <div>
                    <label class="label">Jumlah Jam per Minggu</label>
                    <input type="number" id="mapelJam" class="input-field" min="1" max="20" placeholder="3">
                </div>
                <div>
                    <label class="label">Kelas yang Diampu</label>
                    <div class="grid grid-cols-3 gap-2" id="mapelKelasCheckbox">
                        <label class="flex items-center gap-2"><input type="checkbox" value="1" class="rounded"> Kelas 1</label>
                        <label class="flex items-center gap-2"><input type="checkbox" value="2" class="rounded"> Kelas 2</label>
                        <label class="flex items-center gap-2"><input type="checkbox" value="3" class="rounded"> Kelas 3</label>
                        <label class="flex items-center gap-2"><input type="checkbox" value="4" class="rounded"> Kelas 4</label>
                        <label class="flex items-center gap-2"><input type="checkbox" value="5" class="rounded"> Kelas 5</label>
                        <label class="flex items-center gap-2"><input type="checkbox" value="6" class="rounded"> Kelas 6</label>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeModal('mapelModal')" class="btn-secondary flex-1">Batal</button>
                    <button type="submit" class="btn-primary flex-1">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Jadwal Modal -->
    <div id="jadwalModal" class="modal-backdrop hidden">
        <div class="modal-content p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">Tambah Jadwal</h3>
                <button onclick="closeModal('jadwalModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="formJadwal" class="space-y-4">
                <div>
                    <label class="label">Hari</label>
                    <select id="jadwalHari" class="input-field" required>
                        <option value="">Pilih Hari</option>
                        <option value="Senin">Senin</option>
                        <option value="Selasa">Selasa</option>
                        <option value="Rabu">Rabu</option>
                        <option value="Kamis">Kamis</option>
                        <option value="Jumat">Jumat</option>
                        <option value="Sabtu">Sabtu</option>
                    </select>
                </div>
                <div>
                    <label class="label">Jam Ke</label>
                    <select id="jadwalJam" class="input-field" required>
                        <option value="">Pilih Jam</option>
                    </select>
                </div>
                <div>
                    <label class="label">Kelas/Rombel</label>
                    <select id="jadwalKelas" class="input-field" required>
                        <option value="">Pilih Kelas</option>
                    </select>
                </div>
                <div>
                    <label class="label">Mata Pelajaran</label>
                    <select id="jadwalMapel" class="input-field" required>
                        <option value="">Pilih Mapel</option>
                    </select>
                </div>
                <div id="jadwalError" class="hidden p-3 bg-red-100 text-red-700 rounded-lg text-sm">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span id="jadwalErrorText"></span>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeModal('jadwalModal')" class="btn-secondary flex-1">Batal</button>
                    <button type="submit" class="btn-primary flex-1">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Event Kalender Modal -->
    <div id="eventModal" class="modal-backdrop hidden">
        <div class="modal-content p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">Tambah Event Kalender</h3>
                <button onclick="closeModal('eventModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="formEvent" class="space-y-4">
                <div>
                    <label class="label">Tanggal Mulai</label>
                    <input type="date" id="eventTanggalMulai" class="input-field" required>
                </div>
                <div>
                    <label class="label">Tanggal Selesai (opsional)</label>
                    <input type="date" id="eventTanggalSelesai" class="input-field">
                </div>
                <div>
                    <label class="label">Keterangan</label>
                    <input type="text" id="eventKeterangan" class="input-field" placeholder="Contoh: Libur Tahun Baru" required>
                </div>
                <div>
                    <label class="label">Jenis</label>
                    <select id="eventJenis" class="input-field" required>
                        <option value="libur">Hari Libur</option>
                        <option value="kegiatan">Kegiatan Sekolah</option>
                        <option value="ujian">Ujian/Penilaian</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="eventEditable" class="rounded" checked>
                    <label for="eventEditable" class="text-sm text-gray-600">Dapat diedit</label>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeModal('eventModal')" class="btn-secondary flex-1">Batal</button>
                    <button type="submit" class="btn-primary flex-1">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import CSV Modal -->
    <div id="importCSVModal" class="modal-backdrop hidden">
        <div class="modal-content p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800" id="importCSVTitle">Import CSV</h3>
                <button onclick="closeModal('importCSVModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="formImportCSV" class="space-y-4">
                <div>
                    <label class="label">URL CSV (Google Spreadsheet)</label>
                    <input type="url" id="csvURL" class="input-field" placeholder="https://docs.google.com/spreadsheets/d/.../export?format=csv">
                </div>
                <div class="text-center">
                    <span class="text-gray-400">atau</span>
                </div>
                <div>
                    <label class="label">Upload File CSV</label>
                    <input type="file" id="csvFile" class="input-field" accept=".csv">
                </div>
                <div id="csvPreview" class="hidden">
                    <label class="label">Preview Data</label>
                    <div class="overflow-x-auto max-h-48 border rounded-lg">
                        <table class="w-full text-sm" id="csvPreviewTable">
                            <!-- Preview table -->
                        </table>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeModal('importCSVModal')" class="btn-secondary flex-1">Batal</button>
                    <button type="submit" class="btn-primary flex-1">Import</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 z-50 hidden">
        <div class="bg-gray-900 text-white px-6 py-4 rounded-xl shadow-lg flex items-center gap-3">
            <i id="toastIcon" class="fas fa-check-circle text-green-400"></i>
            <span id="toastMessage">Success!</span>
        </div>
    </div>

    <!-- Firebase & App Script -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDe4ie2wSPEpNbAgWP-q03vTuHyxc9Jj3E",
            authDomain: "agsa-e5b08.firebaseapp.com",
            projectId: "agsa-e5b08",
            storageBucket: "agsa-e5b08.firebasestorage.app",
            messagingSenderId: "916052746331",
            appId: "1:916052746331:web:357cbadbfd8658f1689f7e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // App State
        let currentUser = null;
        let userData = null;
        let userSubscription = 'free';
        let currentPage = 'dashboard';
        let currentTahunAjar = '';
        let currentSemester = 1;

        // Super Admin Email
        const SUPER_ADMIN_EMAIL = 'afifaro@gmail.com';

        // Default Settings
        let appSettings = {
            waNumber: '6281234567890',
            waMessage: 'Halo, saya ingin upgrade ke Premium ADMIN GURU SUPER APP',
            pricePersonal: 100000,
            priceSchool: 500000
        };

        // ==================== AUTHENTICATION ====================

        // Check Auth State
        auth.onAuthStateChanged(async (user) => {
            hideLoading();
            if (user) {
                // Check if email is Gmail
                if (!user.email.endsWith('@gmail.com')) {
                    showToast('Hanya akun Gmail yang diizinkan', 'error');
                    auth.signOut();
                    return;
                }
                
                currentUser = user;
                await loadUserData();
                showMainApp();
            } else {
                showLoginPage();
            }
        });

        // Sign In with Google
        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({
                hd: 'gmail.com'
            });
            
            try {
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error('Sign in error:', error);
                showToast('Gagal masuk: ' + error.message, 'error');
            }
        }

        // Sign Out
        async function signOut() {
            try {
                await auth.signOut();
                showToast('Berhasil keluar', 'success');
            } catch (error) {
                showToast('Gagal keluar', 'error');
            }
        }

        // Load User Data
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                } else {
                    // Create new user document
                    userData = {
                        email: currentUser.email,
                        nama: currentUser.displayName || '',
                        photoURL: currentUser.photoURL || '',
                        subscription: 'free',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        profil: {},
                        sekolah: {},
                        mapel: []
                    };
                    await db.collection('users').doc(currentUser.uid).set(userData);
                }

                userSubscription = userData.subscription || 'free';
                updateUserUI();
                checkAdminAccess();
                loadAppSettings();
                initTahunAjar();
                
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Update User UI
        function updateUserUI() {
            document.getElementById('userAvatar').src = currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.nama || 'User')}&background=0ea5e9&color=fff`;
            document.getElementById('userName').textContent = userData.nama || currentUser.displayName || 'User';
            document.getElementById('userRole').textContent = userData.sekolah?.nama || 'Guru';
            
            const badge = document.getElementById('userBadge');
            if (userSubscription === 'premium') {
                badge.textContent = 'PREMIUM';
                badge.className = 'badge badge-warning text-xs';
                document.getElementById('upgradeBanner').classList.add('hidden');
            } else {
                badge.textContent = 'FREE';
                badge.className = 'badge badge-info text-xs';
                document.getElementById('upgradeBanner').classList.remove('hidden');
            }

            document.getElementById('welcomeText').textContent = `Selamat datang kembali, ${userData.nama || currentUser.displayName || 'Guru'}!`;
        }

        // Check Admin Access
        function checkAdminAccess() {
            if (currentUser.email === SUPER_ADMIN_EMAIL) {
                document.getElementById('adminMenu').classList.remove('hidden');
            } else {
                document.getElementById('adminMenu').classList.add('hidden');
            }
        }

        // ==================== NAVIGATION ====================

        function showLoading() {
            document.getElementById('loadingScreen').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            loadDashboardData();
        }

        function showPage(page) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            
            // Show selected page
            document.getElementById(`page-${page}`).classList.remove('hidden');
            
            // Update sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === page) {
                    item.classList.add('active');
                }
            });

            currentPage = page;

            // Close sidebar on mobile
            if (window.innerWidth < 1024) {
                toggleSidebar();
            }

            // Load page specific data
            loadPageData(page);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function loadPageData(page) {
            switch(page) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'profil':
                    loadProfilData();
                    break;
                case 'kalender':
                    loadKalenderData();
                    break;
                case 'jadwal':
                    loadJadwalData();
                    break;
                case 'cp':
                    loadCPData();
                    break;
                case 'atp':
                    loadATPData();
                    break;
                case 'prota':
                    loadProtaData();
                    break;
                case 'promes':
                    loadPromesData();
                    break;
                case 'siswa':
                    loadSiswaData();
                    break;
                case 'absensi':
                case 'jurnal':
                case 'nilai':
                case 'modul':
                case 'lkpd':
                case 'banksoal':
                    checkPremiumAccess(page);
                    break;
                case 'admin':
                    loadAdminData();
                    break;
            }
        }

        // ==================== TAHUN AJAR ====================

        function initTahunAjar() {
            const select = document.getElementById('tahunAjarSelect');
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1; // 1-12

            let startYear;
            if (currentMonth >= 7) { // July onwards = new school year
                startYear = currentYear;
            } else {
                startYear = currentYear - 1;
            }

            // Generate options
            const options = [];
            for (let i = -1; i <= 1; i++) {
                const year = startYear + i;
                options.push(`${year}/${year + 1}`);
            }

            select.innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
            
            // Set current
            currentTahunAjar = `${startYear}/${startYear + 1}`;
            select.value = currentTahunAjar;

            // Set current semester
            if (currentMonth >= 7 && currentMonth <= 12) {
                currentSemester = 1;
            } else {
                currentSemester = 2;
            }
            document.getElementById('semesterSelect').value = currentSemester;
        }

        function changeTahunAjar() {
            currentTahunAjar = document.getElementById('tahunAjarSelect').value;
            loadDashboardData();
        }

        function changeSemester() {
            currentSemester = parseInt(document.getElementById('semesterSelect').value);
            loadDashboardData();
        }

        // ==================== DASHBOARD ====================

        async function loadDashboardData() {
            // Update today's date
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('todayDate').textContent = today.toLocaleDateString('id-ID', options);

            try {
                // Load stats
                const siswaSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('siswa').get();
                document.getElementById('totalSiswa').textContent = siswaSnap.size;

                // Count unique classes
                const classes = new Set();
                siswaSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.kelas) classes.add(data.kelas);
                });
                document.getElementById('totalKelas').textContent = classes.size;

                // Count mapel
                const mapelCount = userData.mapel?.length || 0;
                document.getElementById('totalMapel').textContent = mapelCount;

                // Load today's schedule
                loadTodaySchedule();

            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadTodaySchedule() {
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const todayName = days[new Date().getDay()];
            
            const container = document.getElementById('todaySchedule');
            
            try {
                const snap = await db.collection('users').doc(currentUser.uid)
                    .collection('jadwal')
                    .where('hari', '==', todayName)
                    .orderBy('jamKe')
                    .get();

                if (snap.empty) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-calendar-times text-4xl mb-2"></i>
                            <p>Tidak ada jadwal hari ini</p>
                        </div>
                    `;
                    document.getElementById('totalPertemuan').textContent = '0';
                } else {
                    let html = '';
                    snap.forEach(doc => {
                        const j = doc.data();
                        html += `
                            <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-xl">
                                <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                                    <span class="text-lg font-bold text-primary-600">${j.jamKe}</span>
                                </div>
                                <div class="flex-1">
                                    <p class="font-medium text-gray-800">${j.mapel}</p>
                                    <p class="text-sm text-gray-500">Kelas ${j.kelas} | ${j.waktuMulai} - ${j.waktuSelesai}</p>
                                                            </div>
                        `;
                    });
                    container.innerHTML = html;
                    document.getElementById('totalPertemuan').textContent = snap.size;
                }
            } catch (error) {
                console.error('Error loading today schedule:', error);
            }
        }

        // ==================== PROFIL ====================

        async function loadProfilData() {
            if (!userData) return;

            // Profil Guru
            document.getElementById('profilNama').value = userData.nama || userData.profil?.nama || '';
            document.getElementById('profilNIP').value = userData.profil?.nip || '';
            document.getElementById('profilEmail').value = currentUser.email;
            document.getElementById('profilHP').value = userData.profil?.hp || '';

            // Sekolah
            document.getElementById('sekolahNama').value = userData.sekolah?.nama || '';
            document.getElementById('sekolahNPSN').value = userData.sekolah?.npsn || '';
            document.getElementById('sekolahJenjang').value = userData.sekolah?.jenjang || '';
            document.getElementById('sekolahAlamat').value = userData.sekolah?.alamat || '';
            document.getElementById('sekolahKota').value = userData.sekolah?.kota || '';
            document.getElementById('sekolahProvinsi').value = userData.sekolah?.provinsi || '';
            document.getElementById('kepalaSekolah').value = userData.sekolah?.kepalaSekolah || '';
            document.getElementById('nipKepalaSekolah').value = userData.sekolah?.nipKepalaSekolah || '';

            // Mapel
            renderMapelList();
        }

        function renderMapelList() {
            const container = document.getElementById('listMapel');
            const emptyState = document.getElementById('emptyMapel');
            const mapelList = userData.mapel || [];

            if (mapelList.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = mapelList.map((m, index) => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-book text-primary-600"></i>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">${m.nama}</p>
                            <p class="text-sm text-gray-500">${m.jamPerMinggu} JP/minggu | Kelas: ${m.kelas.join(', ')}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editMapel(${index})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="hapusMapel(${index})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function tambahMapel() {
            document.getElementById('formMapel').reset();
            document.getElementById('formMapel').dataset.editIndex = '';
            openModal('mapelModal');
        }

        function editMapel(index) {
            const mapel = userData.mapel[index];
            document.getElementById('mapelNama').value = mapel.nama;
            document.getElementById('mapelJam').value = mapel.jamPerMinggu;
            
            // Check kelas
            document.querySelectorAll('#mapelKelasCheckbox input').forEach(cb => {
                cb.checked = mapel.kelas.includes(cb.value);
            });

            document.getElementById('formMapel').dataset.editIndex = index;
            openModal('mapelModal');
        }

        async function hapusMapel(index) {
            if (!confirm('Yakin ingin menghapus mata pelajaran ini?')) return;

            userData.mapel.splice(index, 1);
            await saveUserData();
            renderMapelList();
            showToast('Mata pelajaran dihapus', 'success');
        }

        document.getElementById('formMapel').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nama = document.getElementById('mapelNama').value.trim();
            const jamPerMinggu = parseInt(document.getElementById('mapelJam').value);
            const kelas = Array.from(document.querySelectorAll('#mapelKelasCheckbox input:checked')).map(cb => cb.value);

            if (!nama || !jamPerMinggu || kelas.length === 0) {
                showToast('Lengkapi semua data', 'error');
                return;
            }

            const mapelData = { nama, jamPerMinggu, kelas };
            
            if (!userData.mapel) userData.mapel = [];

            const editIndex = document.getElementById('formMapel').dataset.editIndex;
            if (editIndex !== '') {
                userData.mapel[parseInt(editIndex)] = mapelData;
            } else {
                userData.mapel.push(mapelData);
            }

            await saveUserData();
            closeModal('mapelModal');
            renderMapelList();
            showToast('Mata pelajaran disimpan', 'success');
        });

        async function simpanProfil() {
            userData.nama = document.getElementById('profilNama').value.trim();
            userData.profil = {
                nama: document.getElementById('profilNama').value.trim(),
                nip: document.getElementById('profilNIP').value.trim(),
                hp: document.getElementById('profilHP').value.trim()
            };
            userData.sekolah = {
                nama: document.getElementById('sekolahNama').value.trim(),
                npsn: document.getElementById('sekolahNPSN').value.trim(),
                jenjang: document.getElementById('sekolahJenjang').value,
                alamat: document.getElementById('sekolahAlamat').value.trim(),
                kota: document.getElementById('sekolahKota').value.trim(),
                provinsi: document.getElementById('sekolahProvinsi').value.trim(),
                kepalaSekolah: document.getElementById('kepalaSekolah').value.trim(),
                nipKepalaSekolah: document.getElementById('nipKepalaSekolah').value.trim()
            };

            await saveUserData();
            updateUserUI();
            showToast('Profil berhasil disimpan', 'success');
        }

        async function saveUserData() {
            try {
                await db.collection('users').doc(currentUser.uid).update(userData);
            } catch (error) {
                console.error('Error saving user data:', error);
                showToast('Gagal menyimpan data', 'error');
            }
        }

        // ==================== KALENDER ====================

        let kalenderEvents = [];
        const defaultHolidays = [
            { tanggal: '2025-01-01', keterangan: 'Tahun Baru Masehi', jenis: 'libur', editable: false },
            { tanggal: '2025-01-29', keterangan: 'Tahun Baru Imlek', jenis: 'libur', editable: false },
            { tanggal: '2025-03-29', keterangan: 'Hari Raya Nyepi', jenis: 'libur', editable: false },
            { tanggal: '2025-03-31', keterangan: 'Idul Fitri 1446 H (Hari 1)', jenis: 'libur', editable: true },
            { tanggal: '2025-04-01', keterangan: 'Idul Fitri 1446 H (Hari 2)', jenis: 'libur', editable: true },
            { tanggal: '2025-04-18', keterangan: 'Jumat Agung', jenis: 'libur', editable: false },
            { tanggal: '2025-05-01', keterangan: 'Hari Buruh Internasional', jenis: 'libur', editable: false },
            { tanggal: '2025-05-12', keterangan: 'Hari Raya Waisak', jenis: 'libur', editable: false },
            { tanggal: '2025-05-29', keterangan: 'Kenaikan Isa Almasih', jenis: 'libur', editable: false },
            { tanggal: '2025-06-01', keterangan: 'Hari Lahir Pancasila', jenis: 'libur', editable: false },
            { tanggal: '2025-06-07', keterangan: 'Idul Adha 1446 H', jenis: 'libur', editable: true },
            { tanggal: '2025-06-27', keterangan: 'Tahun Baru Islam 1447 H', jenis: 'libur', editable: true },
            { tanggal: '2025-08-17', keterangan: 'Hari Kemerdekaan RI', jenis: 'libur', editable: false },
            { tanggal: '2025-09-05', keterangan: 'Maulid Nabi Muhammad SAW', jenis: 'libur', editable: true },
            { tanggal: '2025-12-25', keterangan: 'Hari Raya Natal', jenis: 'libur', editable: false }
        ];

        async function loadKalenderData() {
            try {
                // Load semester dates
                const settingsDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('settings').doc('kalender').get();

                if (settingsDoc.exists) {
                    const settings = settingsDoc.data();
                    document.getElementById('sem1Mulai').value = settings.sem1Mulai || '';
                    document.getElementById('sem1Selesai').value = settings.sem1Selesai || '';
                    document.getElementById('sem2Mulai').value = settings.sem2Mulai || '';
                    document.getElementById('sem2Selesai').value = settings.sem2Selesai || '';
                } else {
                    // Set defaults
                    const year = parseInt(currentTahunAjar.split('/')[0]);
                    document.getElementById('sem1Mulai').value = `${year}-07-15`;
                    document.getElementById('sem1Selesai').value = `${year}-12-20`;
                    document.getElementById('sem2Mulai').value = `${year + 1}-01-06`;
                    document.getElementById('sem2Selesai').value = `${year + 1}-06-20`;
                }

                // Load events
                const eventsSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('kalender').orderBy('tanggal').get();

                if (eventsSnap.empty) {
                    // Use default holidays
                    kalenderEvents = [...defaultHolidays];
                } else {
                    kalenderEvents = [];
                    eventsSnap.forEach(doc => {
                        kalenderEvents.push({ id: doc.id, ...doc.data() });
                    });
                }

                renderKalenderTable();

            } catch (error) {
                console.error('Error loading kalender:', error);
            }
        }

        function renderKalenderTable() {
            const tbody = document.getElementById('tableKalender');
            const emptyState = document.getElementById('emptyKalender');

            if (kalenderEvents.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            tbody.innerHTML = kalenderEvents.map((event, index) => {
                const jenisClass = event.jenis === 'libur' ? 'badge-danger' : 
                                   event.jenis === 'ujian' ? 'badge-warning' : 'badge-info';
                const statusClass = event.editable ? 'badge-success' : 'badge-secondary';
                
                return `
                    <tr>
                        <td class="px-4 py-3">${formatDate(event.tanggal)}</td>
                        <td class="px-4 py-3">${event.keterangan}</td>
                        <td class="px-4 py-3">
                            <span class="badge ${jenisClass}">${event.jenis}</span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="badge ${event.editable !== false ? 'badge-success' : 'bg-gray-100 text-gray-600'}">
                                ${event.editable !== false ? 'Dapat diedit' : 'Tetap'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            ${event.editable !== false ? `
                                <button onclick="editEvent(${index})" class="text-blue-600 hover:text-blue-800 mr-2">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="hapusEvent(${index})" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function tambahEventKalender() {
            document.getElementById('formEvent').reset();
            document.getElementById('formEvent').dataset.editIndex = '';
            openModal('eventModal');
        }

        function editEvent(index) {
            const event = kalenderEvents[index];
            document.getElementById('eventTanggalMulai').value = event.tanggal;
            document.getElementById('eventTanggalSelesai').value = event.tanggalSelesai || '';
            document.getElementById('eventKeterangan').value = event.keterangan;
            document.getElementById('eventJenis').value = event.jenis;
            document.getElementById('eventEditable').checked = event.editable !== false;
            document.getElementById('formEvent').dataset.editIndex = index;
            openModal('eventModal');
        }

        async function hapusEvent(index) {
            if (!confirm('Yakin ingin menghapus event ini?')) return;

            const event = kalenderEvents[index];
            if (event.id) {
                await db.collection('users').doc(currentUser.uid)
                    .collection('kalender').doc(event.id).delete();
            }

            kalenderEvents.splice(index, 1);
            renderKalenderTable();
            showToast('Event dihapus', 'success');
        }

        document.getElementById('formEvent').addEventListener('submit', async (e) => {
            e.preventDefault();

            const eventData = {
                tanggal: document.getElementById('eventTanggalMulai').value,
                tanggalSelesai: document.getElementById('eventTanggalSelesai').value || null,
                keterangan: document.getElementById('eventKeterangan').value.trim(),
                jenis: document.getElementById('eventJenis').value,
                editable: document.getElementById('eventEditable').checked
            };

            const editIndex = document.getElementById('formEvent').dataset.editIndex;
            
            if (editIndex !== '') {
                const event = kalenderEvents[parseInt(editIndex)];
                if (event.id) {
                    await db.collection('users').doc(currentUser.uid)
                        .collection('kalender').doc(event.id).update(eventData);
                }
                kalenderEvents[parseInt(editIndex)] = { ...event, ...eventData };
            } else {
                const docRef = await db.collection('users').doc(currentUser.uid)
                    .collection('kalender').add(eventData);
                kalenderEvents.push({ id: docRef.id, ...eventData });
            }

            // Sort by date
            kalenderEvents.sort((a, b) => a.tanggal.localeCompare(b.tanggal));

            closeModal('eventModal');
            renderKalenderTable();
            showToast('Event disimpan', 'success');
        });

        async function simpanKalender() {
            const settingsData = {
                sem1Mulai: document.getElementById('sem1Mulai').value,
                sem1Selesai: document.getElementById('sem1Selesai').value,
                sem2Mulai: document.getElementById('sem2Mulai').value,
                sem2Selesai: document.getElementById('sem2Selesai').value
            };

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('settings').doc('kalender').set(settingsData, { merge: true });
                
                showToast('Kalender disimpan', 'success');
            } catch (error) {
                showToast('Gagal menyimpan kalender', 'error');
            }
        }

        function importKalenderCSV() {
            document.getElementById('importCSVTitle').textContent = 'Import Kalender CSV';
            document.getElementById('formImportCSV').dataset.type = 'kalender';
            openModal('importCSVModal');
        }

        // ==================== JADWAL PELAJARAN ====================

        let jamPelajaranList = [];
        let jadwalList = [];

        const defaultJamPelajaran = {
            SD: [
                { jam: 1, mulai: '07:00', selesai: '07:35' },
                { jam: 2, mulai: '07:35', selesai: '08:10' },
                { jam: 3, mulai: '08:10', selesai: '08:45' },
                { jam: 4, mulai: '08:45', selesai: '09:20' },
                { jam: 5, mulai: '09:35', selesai: '10:10' },
                { jam: 6, mulai: '10:10', selesai: '10:45' },
                { jam: 7, mulai: '10:45', selesai: '11:20' },
                { jam: 8, mulai: '11:20', selesai: '11:55' }
            ],
            SMP: [
                { jam: 1, mulai: '07:00', selesai: '07:40' },
                { jam: 2, mulai: '07:40', selesai: '08:20' },
                { jam: 3, mulai: '08:20', selesai: '09:00' },
                { jam: 4, mulai: '09:15', selesai: '09:55' },
                { jam: 5, mulai: '09:55', selesai: '10:35' },
                { jam: 6, mulai: '10:35', selesai: '11:15' },
                { jam: 7, mulai: '11:15', selesai: '11:55' },
                { jam: 8, mulai: '12:30', selesai: '13:10' },
                { jam: 9, mulai: '13:10', selesai: '13:50' },
                { jam: 10, mulai: '13:50', selesai: '14:30' }
            ],
            SMA: [
                { jam: 1, mulai: '07:00', selesai: '07:45' },
                { jam: 2, mulai: '07:45', selesai: '08:30' },
                { jam: 3, mulai: '08:30', selesai: '09:15' },
                { jam: 4, mulai: '09:30', selesai: '10:15' },
                { jam: 5, mulai: '10:15', selesai: '11:00' },
                { jam: 6, mulai: '11:00', selesai: '11:45' },
                { jam: 7, mulai: '12:15', selesai: '13:00' },
                { jam: 8, mulai: '13:00', selesai: '13:45' },
                { jam: 9, mulai: '13:45', selesai: '14:30' },
                { jam: 10, mulai: '14:30', selesai: '15:15' }
            ]
        };

        async function loadJadwalData() {
            try {
                // Load jam pelajaran
                const jamDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('settings').doc('jamPelajaran').get();

                if (jamDoc.exists) {
                    jamPelajaranList = jamDoc.data().list || [];
                } else {
                    const jenjang = userData.sekolah?.jenjang || 'SD';
                    jamPelajaranList = defaultJamPelajaran[jenjang] || defaultJamPelajaran.SD;
                }

                renderJamPelajaran();

                // Load jadwal
                const jadwalSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('jadwal').get();

                jadwalList = [];
                jadwalSnap.forEach(doc => {
                    jadwalList.push({ id: doc.id, ...doc.data() });
                });

                renderJadwalTable();
                populateJadwalFilters();

            } catch (error) {
                console.error('Error loading jadwal:', error);
            }
        }

        function renderJamPelajaran() {
            const container = document.getElementById('listJamPelajaran');
            container.innerHTML = jamPelajaranList.map((jp, index) => `
                <div class="p-3 bg-gray-50 rounded-xl text-center">
                    <div class="text-lg font-bold text-primary-600">Jam ${jp.jam}</div>
                    <input type="time" value="${jp.mulai}" class="w-full text-sm mt-1 px-2 py-1 border rounded" 
                        onchange="updateJamPelajaran(${index}, 'mulai', this.value)">
                    <span class="text-gray-400">-</span>
                    <input type="time" value="${jp.selesai}" class="w-full text-sm px-2 py-1 border rounded"
                        onchange="updateJamPelajaran(${index}, 'selesai', this.value)">
                </div>
            `).join('');
        }

        async function updateJamPelajaran(index, field, value) {
            jamPelajaranList[index][field] = value;
            await db.collection('users').doc(currentUser.uid)
                .collection('settings').doc('jamPelajaran').set({ list: jamPelajaranList });
        }

        async function tambahJamPelajaran() {
            const lastJam = jamPelajaranList[jamPelajaranList.length - 1];
            const newJam = {
                jam: (lastJam?.jam || 0) + 1,
                mulai: lastJam?.selesai || '07:00',
                selesai: addMinutes(lastJam?.selesai || '07:00', 35)
            };
            jamPelajaranList.push(newJam);
            
            await db.collection('users').doc(currentUser.uid)
                .collection('settings').doc('jamPelajaran').set({ list: jamPelajaranList });
            
            renderJamPelajaran();
        }

        function addMinutes(time, minutes) {
            const [h, m] = time.split(':').map(Number);
            const totalMinutes = h * 60 + m + minutes;
            const newH = Math.floor(totalMinutes / 60) % 24;
            const newM = totalMinutes % 60;
            return `${String(newH).padStart(2, '0')}:${String(newM).padStart(2, '0')}`;
        }

        function renderJadwalTable() {
            const tbody = document.getElementById('tableJadwal');
            const emptyState = document.getElementById('emptyJadwal');

            if (jadwalList.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // Sort by day and jam
            const dayOrder = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            jadwalList.sort((a, b) => {
                const dayDiff = dayOrder.indexOf(a.hari) - dayOrder.indexOf(b.hari);
                if (dayDiff !== 0) return dayDiff;
                return a.jamKe - b.jamKe;
            });

            tbody.innerHTML = jadwalList.map((j, index) => `
                <tr>
                    <td class="px-4 py-3 font-medium">${j.hari}</td>
                    <td class="px-4 py-3">${j.jamKe}</td>
                    <td class="px-4 py-3">${j.waktuMulai} - ${j.waktuSelesai}</td>
                    <td class="px-4 py-3">${j.kelas}</td>
                    <td class="px-4 py-3">${j.mapel}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="hapusJadwal('${j.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function populateJadwalFilters() {
            // Populate kelas filter
            const kelasSet = new Set();
            jadwalList.forEach(j => kelasSet.add(j.kelas));
            
            const filterKelas = document.getElementById('filterKelas');
            filterKelas.innerHTML = '<option value="">Semua Kelas</option>' +
                Array.from(kelasSet).sort().map(k => `<option value="${k}">${k}</option>`).join('');

            // Populate modal selects
            populateJadwalModalSelects();
        }

        function populateJadwalModalSelects() {
            // Jam select
            const jamSelect = document.getElementById('jadwalJam');
            jamSelect.innerHTML = '<option value="">Pilih Jam</option>' +
                jamPelajaranList.map(jp => `<option value="${jp.jam}">Jam ${jp.jam} (${jp.mulai}-${jp.selesai})</option>`).join('');

            // Kelas select - get from siswa or mapel
            const kelasSelect = document.getElementById('jadwalKelas');
            const allKelas = new Set();
            (userData.mapel || []).forEach(m => {
                m.kelas.forEach(k => allKelas.add(k));
            });
            
            // Add rombel options
            const kelasWithRombel = [];
            allKelas.forEach(k => {
                ['A', 'B', 'C'].forEach(r => kelasWithRombel.push(`${k}${r}`));
            });
            
            kelasSelect.innerHTML = '<option value="">Pilih Kelas</option>' +
                kelasWithRombel.map(k => `<option value="${k}">Kelas ${k}</option>`).join('');

            // Mapel select
            const mapelSelect = document.getElementById('jadwalMapel');
            mapelSelect.innerHTML = '<option value="">Pilih Mapel</option>' +
                (userData.mapel || []).map(m => `<option value="${m.nama}">${m.nama}</option>`).join('');
        }

        function tambahJadwal() {
            document.getElementById('formJadwal').reset();
            document.getElementById('jadwalError').classList.add('hidden');
            populateJadwalModalSelects();
            openModal('jadwalModal');
        }

        document.getElementById('formJadwal').addEventListener('submit', async (e) => {
            e.preventDefault();

            const hari = document.getElementById('jadwalHari').value;
            const jamKe = parseInt(document.getElementById('jadwalJam').value);
            const kelas = document.getElementById('jadwalKelas').value;
            const mapel = document.getElementById('jadwalMapel').value;

            // Validation - Anti-bentrok
            const conflict = jadwalList.find(j => {
                // Same teacher, same day, same jam
                if (j.hari === hari && j.jamKe === jamKe) {
                    return true;
                }
                return false;
            });

            if (conflict) {
                document.getElementById('jadwalError').classList.remove('hidden');
                document.getElementById('jadwalErrorText').textContent = 
                    `Bentrok! Anda sudah mengajar ${conflict.mapel} di kelas ${conflict.kelas} pada waktu tersebut.`;
                return;
            }

            // Check same class, same jam
            const classConflict = jadwalList.find(j => 
                j.hari === hari && j.jamKe === jamKe && j.kelas === kelas
            );

            if (classConflict) {
                document.getElementById('jadwalError').classList.remove('hidden');
                document.getElementById('jadwalErrorText').textContent = 
                    `Bentrok! Kelas ${kelas} sudah ada jadwal pada waktu tersebut.`;
                return;
            }

            const jamData = jamPelajaranList.find(jp => jp.jam === jamKe);

            const jadwalData = {
                hari,
                jamKe,
                waktuMulai: jamData?.mulai || '',
                waktuSelesai: jamData?.selesai || '',
                kelas,
                mapel,
                tahunAjar: currentTahunAjar
            };

            try {
                const docRef = await db.collection('users').doc(currentUser.uid)
                    .collection('jadwal').add(jadwalData);
                
                jadwalList.push({ id: docRef.id, ...jadwalData });
                
                closeModal('jadwalModal');
                renderJadwalTable();
                showToast('Jadwal ditambahkan', 'success');
            } catch (error) {
                showToast('Gagal menambahkan jadwal', 'error');
            }
        });

        async function hapusJadwal(id) {
            if (!confirm('Yakin ingin menghapus jadwal ini?')) return;

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('jadwal').doc(id).delete();
                
                jadwalList = jadwalList.filter(j => j.id !== id);
                renderJadwalTable();
                showToast('Jadwal dihapus', 'success');
            } catch (error) {
                showToast('Gagal menghapus jadwal', 'error');
            }
        }

        function filterJadwal() {
            const filterKelas = document.getElementById('filterKelas').value;
            const filterHari = document.getElementById('filterHari').value;

            const filteredList = jadwalList.filter(j => {
                if (filterKelas && j.kelas !== filterKelas) return false;
                if (filterHari && j.hari !== filterHari) return false;
                return true;
            });

            // Render filtered
            const tbody = document.getElementById('tableJadwal');
            if (filteredList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">Tidak ada data</td></tr>';
            } else {
                const dayOrder = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                filteredList.sort((a, b) => {
                    const dayDiff = dayOrder.indexOf(a.hari) - dayOrder.indexOf(b.hari);
                    if (dayDiff !== 0) return dayDiff;
                    return a.jamKe - b.jamKe;
                });

                tbody.innerHTML = filteredList.map(j => `
                    <tr>
                        <td class="px-4 py-3 font-medium">${j.hari}</td>
                        <td class="px-4 py-3">${j.jamKe}</td>
                        <td class="px-4 py-3">${j.waktuMulai} - ${j.waktuSelesai}</td>
                        <td class="px-4 py-3">${j.kelas}</td>
                        <td class="px-4 py-3">${j.mapel}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="hapusJadwal('${j.id}')" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        // ==================== CP (CAPAIAN PEMBELAJARAN) ====================

        let cpList = [];

        // Default CP PAI Data (from provided data)
        const dataBukuPAI = {
            kelas1: {
                fase: "A",
                semester1: [
                    { bab: 1, elemen: "Al-Qur'an dan Hadis", judul: "Aku Belajar Huruf Hijaiyah", tujuan: "Peserta didik dapat mengenal dan melafalkan huruf hijaiyah dengan benar" },
                    { bab: 2, elemen: "Akidah", judul: "Allah Tuhanku", tujuan: "Peserta didik dapat meyakini Allah SWT sebagai Tuhan Yang Maha Esa" },
                    { bab: 3, elemen: "Akhlak", judul: "Aku Anak Saleh", tujuan: "Peserta didik dapat menunjukkan perilaku terpuji dalam kehidupan sehari-hari" },
                    { bab: 4, elemen: "Fikih", judul: "Aku Belajar Bersuci", tujuan: "Peserta didik dapat memahami dan mempraktikkan tata cara bersuci sederhana" },
                    { bab: 5, elemen: "Sejarah Peradaban Islam", judul: "Nabi Muhammad SAW Panutanku", tujuan: "Peserta didik dapat mengenal Nabi Muhammad SAW sebagai teladan" }
                ],
                semester2: [
                    { bab: 6, elemen: "Al-Qur'an dan Hadis", judul: "Aku Menghafal Surah Pendek", tujuan: "Peserta didik dapat melafalkan dan menghafal surah Al-Fatihah dan An-Nas" },
                    { bab: 7, elemen: "Akidah", judul: "Malaikat Allah", tujuan: "Peserta didik dapat mengenal malaikat sebagai makhluk Allah" },
                    { bab: 8, elemen: "Akhlak", judul: "Aku Sayang Temanku", tujuan: "Peserta didik dapat menunjukkan sikap persahabatan dan tolong-menolong" },
                    { bab: 9, elemen: "Fikih", judul: "Aku Belajar Wudhu", tujuan: "Peserta didik dapat mengetahui tata cara wudhu yang benar" },
                    { bab: 10, elemen: "Sejarah Peradaban Islam", judul: "Kisah Nabi Adam AS", tujuan: "Peserta didik dapat mengenal kisah Nabi Adam AS sebagai manusia pertama" }
                ]
            },
            // ... more classes data would be here (from the provided dataBuku)
        };

        const profilLulusan = [
            "Keimanan", "Kewargaan", "Penalaran Kritis", "Kreativitas",
            "Kolaborasi", "Kemandirian", "Kesehatan", "Komunikasi"
        ];

        async function loadCPData() {
            try {
                const snap = await db.collection('users').doc(currentUser.uid)
                    .collection('cp').orderBy('kelas').get();

                cpList = [];
                snap.forEach(doc => {
                    cpList.push({ id: doc.id, ...doc.data() });
                });

                renderCPList();
            } catch (error) {
                console.error('Error loading CP:', error);
            }
        }

        function renderCPList() {
            const container = document.getElementById('listCP');
            const emptyState = document.getElementById('emptyCP');

            if (cpList.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // Group by kelas
            const grouped = {};
            cpList.forEach(cp => {
                const key = `Kelas ${cp.kelas}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(cp);
            });

            container.innerHTML = Object.entries(grouped).map(([kelas, items]) => `
                <div class="card">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-graduation-cap text-primary-500"></i>
                        ${kelas} - Fase ${items[0]?.fase || '-'}
                    </h3>
                    <div class="space-y-3">
                        ${items.map(cp => `
                            <div class="p-4 bg-gray-50 rounded-xl">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <span class="badge ${getElemenColor(cp.elemen)} mb-2">${cp.elemen}</span>
                                        <h4 class="font-medium text-gray-800">${cp.judul}</h4>
                                        <p class="text-sm text-gray-600 mt-1">${cp.tujuan}</p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="editCP('${cp.id}')" class="text-blue-600 hover:text-blue-800">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="hapusCP('${cp.id}')" class="text-red-600 hover:text-red-800">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function getElemenColor(elemen) {
            const colors = {
                "Al-Qur'an dan Hadis": "bg-emerald-100 text-emerald-700",
                "Akidah": "bg-blue-100 text-blue-700",
                "Akhlak": "bg-pink-100 text-pink-700",
                "Fikih": "bg-purple-100 text-purple-700",
                "Sejarah Peradaban Islam": "bg-amber-100 text-amber-700"
            };
            return colors[elemen] || "bg-gray-100 text-gray-700";
        }

        async function showDefaultCP() {
            if (!confirm('Ini akan menambahkan CP default PAI ke daftar Anda. Lanjutkan?')) return;

            try {
                const batch = db.batch();
                
                // Add all default CP from dataBukuPAI
                for (const [kelasKey, kelasData] of Object.entries(dataBukuPAI)) {
                    const kelasNum = kelasKey.replace('kelas', '');
                    
                    [...kelasData.semester1, ...kelasData.semester2].forEach(cp => {
                        const docRef = db.collection('users').doc(currentUser.uid)
                            .collection('cp').doc();
                        batch.set(docRef, {
                            kelas: kelasNum,
                            fase: kelasData.fase,
                            bab: cp.bab,
                            elemen: cp.elemen,
                            judul: cp.judul,
                            tujuan: cp.tujuan,
                            mapel: 'Pendidikan Agama Islam dan Budi Pekerti',
                            profilLulusan: ['Keimanan'],
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                }

                await batch.commit();
                await loadCPData();
                showToast('CP PAI default berhasil ditambahkan', 'success');

            } catch (error) {
                console.error('Error adding default CP:', error);
                showToast('Gagal menambahkan CP default', 'error');
            }
        }

        function tambahCP() {
            // Would open a modal for adding custom CP
            showToast('Fitur tambah CP manual akan segera tersedia', 'info');
        }

        async function hapusCP(id) {
            if (!confirm('Yakin ingin menghapus CP ini?')) return;

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('cp').doc(id).delete();
                await loadCPData();
                showToast('CP dihapus', 'success');
            } catch (error) {
                showToast('Gagal menghapus CP', 'error');
            }
        }

        // ==================== ATP (ALUR TUJUAN PEMBELAJARAN) ====================

        async function loadATPData() {
            // ATP is auto-generated from CP
            await loadCPData();
            renderATPTable();
            populateATPFilters();
        }

        function renderATPTable() {
            const tbody = document.getElementById('tableATP');

            if (cpList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">Belum ada data CP. Tambahkan CP terlebih dahulu.</td></tr>';
                return;
            }

            tbody.innerHTML = cpList.map((cp, index) => `
                <tr>
                    <td class="px-4 py-3">${index + 1}</td>
                    <td class="px-4 py-3">
                        <span class="badge ${getElemenColor(cp.elemen)}">${cp.elemen}</span>
                    </td>
                    <td class="px-4 py-3">${cp.tujuan}</td>
                    <td class="px-4 py-3">${cp.judul}</td>
                    <td class="px-4 py-3 text-center">${cp.jp || 4}</td>
                    <td class="px-4 py-3">
                        <div class="flex flex-wrap gap-1">
                            ${(cp.profilLulusan || ['Keimanan']).map(p => 
                                `<span class="text-xs bg-primary-100 text-primary-700 px-2 py-0.5 rounded">${p}</span>`
                            ).join('')}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function populateATPFilters() {
            const kelasFilter = document.getElementById('atpFilterKelas');
            const kelasSet = new Set(cpList.map(cp => cp.kelas));
            kelasFilter.innerHTML = '<option value="">Semua Kelas</option>' +
                Array.from(kelasSet).sort().map(k => `<option value="${k}">Kelas ${k}</option>`).join('');

            const mapelFilter = document.getElementById('atpFilterMapel');
            const mapelSet = new Set(cpList.map(cp => cp.mapel));
            mapelFilter.innerHTML = '<option value="">Semua Mapel</option>' +
                Array.from(mapelSet).map(m => `<option value="${m}">${m}</option>`).join('');
        }

        async function generateATP() {
            // ATP is already synced with CP
            await loadCPData();
            renderATPTable();
            showToast('ATP berhasil di-generate dari CP', 'success');
        }

        function exportATP() {
            // Would export to printable format
            window.print();
        }

        // ==================== PROTA (PROGRAM TAHUNAN) ====================

        async function loadProtaData() {
            // Populate filters
            const mapelSelect = document.getElementById('protaMapel');
            mapelSelect.innerHTML = '<option value="">Pilih Mata Pelajaran</option>' +
                (userData.mapel || []).map(m => `<option value="${m.nama}">${m.nama}</option>`).join('');

            const kelasSelect = document.getElementById('protaKelas');
            const allKelas = new Set();
            (userData.mapel || []).forEach(m => m.kelas.forEach(k => allKelas.add(k)));
            kelasSelect.innerHTML = '<option value="">Pilih Kelas</option>' +
                Array.from(allKelas).sort().map(k => `<option value="${k}">Kelas ${k}</option>`).join('');

            // Set signature data
            document.getElementById('protaKepsek').textContent = userData.sekolah?.kepalaSekolah || '_________________';
            document.getElementById('protaNIPKepsek').textContent = 'NIP. ' + (userData.sekolah?.nipKepalaSekolah || '');
            document.getElementById('protaGuru').textContent = userData.nama || '_________________';
            document.getElementById('protaNIPGuru').textContent = 'NIP. ' + (userData.profil?.nip || '');
            document.getElementById('protaKota').textContent = `${userData.sekolah?.kota || '_________'}, ${formatDate(new Date().toISOString().split('T')[0])}`;
            document.getElementById('protaTahunAjar').textContent = currentTahunAjar;
        }

        async function updateProta() {
            const mapel = document.getElementById('protaMapel').value;
            const kelas = document.getElementById('protaKelas').value;

            if (!mapel || !kelas) return;

            const tbody = document.getElementById('tableProta');

            // Filter CP by kelas
            const filteredCP = cpList.filter(cp => cp.kelas === kelas);

            if (filteredCP.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400">Tidak ada data CP untuk kelas ini</td></tr>';
                return;
            }

            // Group by semester
            const sem1 = filteredCP.filter(cp => cp.bab <= 5);
            const sem2 = filteredCP.filter(cp => cp.bab > 5);

            let html = '';

            // Semester 1
            if (sem1.length > 0) {
                html += `<tr><td class="border border-gray-300 px-4 py-2 font-bold bg-gray-50" rowspan="${sem1.length + 1}">Semester 1</td></tr>`;
                sem1.forEach(cp => {
                    html += `
                        <tr>
                            <td class="border border-gray-300 px-4 py-2">${cp.elemen} - ${cp.judul}</td>
                            <td class="border border-gray-300 px-4 py-2">${cp.tujuan}</td>
                            <td class="border border-gray-300 px-4 py-2 text-center">${cp.jp || 4}</td>
                            <td class="border border-gray-300 px-4 py-2"></td>
                        </tr>
                    `;
                });
            }

            // Semester 2
            if (sem2.length > 0) {
                html += `<tr><td class="border border-gray-300 px-4 py-2 font-bold bg-gray-50" rowspan="${sem2.length + 1}">Semester 2</td></tr>`;
                sem2.forEach(cp => {
                    html += `
                        <tr>
                            <td class="border border-gray-300 px-4 py-2">${cp.elemen} - ${cp.judul}</td>
                            <td class="border border-gray-300 px-4 py-2">${cp.tujuan}</td>
                            <td class="border border-gray-300 px-4 py-2 text-center">${cp.jp || 4}</td>
                            <td class="border border-gray-300 px-4 py-2"></td>
                        </tr>
                    `;
                });
            }

            tbody.innerHTML = html;
        }

        function generateProta() {
            updateProta();
            showToast('Prota berhasil di-generate', 'success');
        }

        function printProta() {
            window.print();
        }

        // ==================== PROMES (PROGRAM SEMESTER) ====================

        async function loadPromesData() {
            // Check premium
            if (userSubscription !== 'premium' && currentUser.email !== SUPER_ADMIN_EMAIL) {
                // Promes is premium feature
            }

            // Populate filters (same as Prota)
            const mapelSelect = document.getElementById('promesMapel');
            mapelSelect.innerHTML = '<option value="">Pilih Mata Pelajaran</option>' +
                (userData.mapel || []).map(m => `<option value="${m.nama}">${m.nama}</option>`).join('');

            const kelasSelect = document.getElementById('promesKelas');
            const allKelas = new Set();
            (userData.mapel || []).forEach(m => m.kelas.forEach(k => allKelas.add(k)));
            kelasSelect.innerHTML = '<option value="">Pilih Kelas</option>' +
                Array.from(allKelas).sort().map(k => `<option value="${k}">Kelas ${k}</option>`).join('');
        }

        async function updatePromes() {
            const mapel = document.getElementById('promesMapel').value;
            const kelas = document.getElementById('promesKelas').value;
            const semester = document.getElementById('promesSemester').value;

            if (!mapel || !kelas) return;

            // Generate weeks header
            const headerRow = document.getElementById('promesHeaderMinggu');
            const months = semester === '1' ? 
                ['Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'] :
                ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni'];

            let weekHtml = '';
            months.forEach(month => {
                for (let w = 1; w <= 4; w++) {
                    weekHtml += `<th class="border border-gray-300 px-1 py-1 text-xs">${w}</th>`;
                }
            });
            headerRow.innerHTML = weekHtml;

            // Generate promes data
            const tbody = document.getElementById('tablePromes');
            const filteredCP = cpList.filter(cp => {
                if (cp.kelas !== kelas) return false;
                if (semester === '1' && cp.bab > 5) return false;
                if (semester === '2' && cp.bab <= 5) return false;
                return true;
            });

            if (filteredCP.length === 0) {
                tbody.innerHTML = '<tr><td colspan="25" class="text-center py-8 text-gray-400">Tidak ada data</td></tr>';
                return;
            }

            // Calculate which weeks each CP falls into based on jadwal
            const jadwalForClass = jadwalList.filter(j => j.kelas.startsWith(kelas) && j.mapel === mapel);
            
            tbody.innerHTML = filteredCP.map((cp, index) => {
                let weekCells = '';
                for (let i = 0; i < 24; i++) {
                    // Simple distribution - would need proper calculation based on calendar
                    const isActive = i >= (index * 4) && i < ((index + 1) * 4);
                    weekCells += `<td class="border border-gray-300 px-1 py-1 text-center ${isActive ? 'bg-primary-200' : ''}">${isActive ? 'âœ“' : ''}</td>`;
                }

                return `
                    <tr>
                        <td class="border border-gray-300 px-3 py-2">${index + 1}</td>
                        <td class="border border-gray-300 px-3 py-2">${cp.elemen}<br><small class="text-gray-500">${cp.judul}</small></td>
                        <td class="border border-gray-300 px-3 py-2">${cp.tujuan}</td>
                        <td class="border border-gray-300 px-3 py-2 text-center">${cp.jp || 4}</td>
                        ${weekCells}
                    </tr>
                `;
            }).join('');
        }

        function generatePromes() {
            updatePromes();
            showToast('Promes berhasil di-generate', 'success');
        }

        function printPromes() {
            window.print();
        }

        // ==================== DATA SISWA ====================

        let siswaList = [];

        async function loadSiswaData() {
            try {
                const snap = await db.collection('users').doc(currentUser.uid)
                    .collection('siswa').orderBy('nama').get();

                siswaList = [];
                snap.forEach(doc => {
                    siswaList.push({ id: doc.id, ...doc.data() });
                });

                renderSiswaTable();
                populateSiswaFilters();

            } catch (error) {
                console.error('Error loading siswa:', error);
            }
        }

        function renderSiswaTable() {
            const tbody = document.getElementById('tableSiswa');
            const emptyState = document.getElementById('emptySiswa');

            if (siswaList.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            tbody.innerHTML = siswaList.map((s, index) => `
                <tr>
                    <td class="px-4 py-3">${index + 1}</td>
                    <td class="px-4 py-3">${s.nisn}</td>
                    <td class="px-4 py-3 font-medium">${s.nama}</td>
                    <td class="px-4 py-3 text-center">${s.jenis_kelamin}</td>
                    <td class="px-4 py-3 text-center">${s.kelas}</td>
                    <td class="px-4 py-3 text-center">${s.rombel}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="hapusSiswa('${s.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function populateSiswaFilters() {
            const kelasSet = new Set(siswaList.map(s => s.kelas));
            const rombelSet = new Set(siswaList.map(s => s.rombel));

            document.getElementById('siswaFilterKelas').innerHTML = '<option value="">Semua Kelas</option>' +
                Array.from(kelasSet).sort().map(k => `<option value="${k}">Kelas ${k}</option>`).join('');

            document.getElementById('siswaFilterRombel').innerHTML = '<option value="">Semua Rombel</option>' +
                Array.from(rombelSet).sort().map(r => `<option value="${r}">${r}</option>`).join('');
        }

        function filterSiswa() {
            const filterKelas = document.getElementById('siswaFilterKelas').value;
            const filterRombel = document.getElementById('siswaFilterRombel').value;
            const search = document.getElementById('siswaSearch').value.toLowerCase();

            const filtered = siswaList.filter(s => {
                if (filterKelas && s.kelas !== filterKelas) return false;
                if (filterRombel && s.rombel !== filterRombel) return false;
                if (search && !s.nama.toLowerCase().includes(search) && !s.nisn.includes(search)) return false;
                return true;
            });

            const tbody = document.getElementById('tableSiswa');
            tbody.innerHTML = filtered.map((s, index) => `
                <tr>
                    <td class="px-4 py-3">${index + 1}</td>
                    <td class="px-4 py-3">${s.nisn}</td>
                    <td class="px-4 py-3 font-medium">${s.nama}</td>
                    <td class="px-4 py-3 text-center">${s.jenis_kelamin}</td>
                    <td class="px-4 py-3 text-center">${s.kelas}</td>
                    <td class="px-4 py-3 text-center">${s.rombel}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="hapusSiswa('${s.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function hapusSiswa(id) {
            if (!confirm('Yakin ingin menghapus siswa ini?')) return;

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('siswa').doc(id).delete();
                await loadSiswaData();
                showToast('Siswa dihapus', 'success');
            } catch (error) {
                showToast('Gagal menghapus siswa', 'error');
            }
        }

        function importSiswaCSV() {
            document.getElementById('importCSVTitle').textContent = 'Import Data Siswa CSV';
            document.getElementById('formImportCSV').dataset.type = 'siswa';
            openModal('importCSVModal');
        }

        function downloadTemplateSiswa() {
            const csv = 'nisn,nama,jenis_kelamin,kelas,rombel\n1234567890,Ahmad Rizki,L,1,A\n1234567891,Siti Fatimah,P,1,A';
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template_siswa.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // CSV Import Handler
        document.getElementById('formImportCSV').addEventListener('submit', async (e) => {
            e.preventDefault();

            const type = e.target.dataset.type;
            const urlInput = document.getElementById('csvURL').value;
            const fileInput = document.getElementById('csvFile').files[0];

            let csvText = '';

            if (urlInput) {
                try {
                    const response = await fetch(urlInput);
                    csvText = await response.text();
                } catch (error) {
                    showToast('Gagal mengambil data dari URL', 'error');
                    return;
                }
            } else if (fileInput) {
                csvText = await fileInput.text();
            } else {
                showToast('Masukkan URL atau pilih file CSV', 'error');
                return;
            }

            // Parse CSV
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};
                headers.forEach((h, index) => {
                    row[h] = values[index] || '';
                });
                data.push(row);
            }

            if (type === 'siswa') {
                await importSiswaData(data);
            } else if (type === 'kalender') {
                await importKalenderData(data);
            }

            closeModal('importCSVModal');
        });

        async function importSiswaData(data) {
            try {
                const batch = db.batch();

                data.forEach(row => {
                    const docRef = db.collection('users').doc(currentUser.uid)
                        .collection('siswa').doc();
                    batch.set(docRef, {
                        nisn: row.nisn || '',
                        nama: row.nama || '',
                        jenis_kelamin: row.jenis_kelamin || row.jk || 'L',
                        kelas: row.kelas || '',
                        rombel: row.rombel || 'A',
                        tahunAjar: currentTahunAjar,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                await batch.commit();
                await loadSiswaData();
                showToast(`${data.length} siswa berhasil diimport`, 'success');

            } catch (error) {
                console.error('Error importing siswa:', error);
                showToast('Gagal mengimport data siswa', 'error');
            }
        }

        // ==================== PREMIUM FEATURES ====================

        function checkPremiumAccess(page) {
            const isPremium = userSubscription === 'premium' || currentUser.email === SUPER_ADMIN_EMAIL;

            const premiumCheckId = `${page}PremiumCheck`;
            const contentId = `${page}Content`;

            const premiumCheck = document.getElementById(premiumCheckId);
            const content = document.getElementById(contentId);

            if (premiumCheck && content) {
                if (isPremium) {
                    premiumCheck.classList.add('hidden');
                    content.classList.remove('hidden');
                    // Load page specific data
                    loadPremiumPageData(page);
                } else {
                    premiumCheck.classList.remove('hidden');
                    content.classList.add('hidden');
                }
            }
        }

        function loadPremiumPageData(page) {
            switch (page) {
                case 'absensi':
                    loadAbsensiData();
                    break;
                case 'jurnal':
                    loadJurnalData();
                    break;
                // Add more premium pages
            }
        }

        async function loadAbsensiData() {
            document.getElementById('absensiTanggal').value = new Date().toISOString().split('T')[0];
            
            // Populate filters
            const kelasSet = new Set();
            jadwalList.forEach(j => kelasSet.add(j.kelas));
            
            document.getElementById('absensiKelas').innerHTML = '<option value="">Pilih Kelas</option>' +
                Array.from(kelasSet).sort().map(k => `<option value="${k}">Kelas ${k}</option>`).join('');

            document.getElementById('absensiMapel').innerHTML = '<option value="">Pilih Mapel</option>' +
                (userData.mapel || []).map(m => `<option value="${m.nama}">${m.nama}</option>`).join('');
        }

        async function loadAbsensi() {
            const tanggal = document.getElementById('absensiTanggal').value;
            const kelas = document.getElementById('absensiKelas').value;

            if (!tanggal || !kelas) return;

            // Get students for this class
            const kelasNum = kelas.replace(/[^0-9]/g, '');
            const rombel = kelas.replace(/[0-9]/g, '');

            const filtered = siswaList.filter(s => 
                s.kelas === kelasNum && (!rombel || s.rombel === rombel)
            );

            const tbody = document.getElementById('tableAbsensi');
            tbody.innerHTML = filtered.map((s, index) => `
                <tr>
                    <td class="px-4 py-3">${index + 1}</td>
                    <td class="px-4 py-3">${s.nisn}</td>
                    <td class="px-4 py-3">${s.nama}</td>
                    <td class="px-4 py-3 text-center">
                        <input type="radio" name="absen_${s.id}" value="H" checked class="w-4 h-4">
                    </td>
                    <td class="px-4 py-3 text-center">
                        <input type="radio" name="absen_${s.id}" value="S" class="w-4 h-4">
                    </td>
                    <td class="px-4 py-3 text-center">
                        <input type="radio" name="absen_${s.id}" value="I" class="w-4 h-4">
                    </td>
                    <td class="px-4 py-3 text-center">
                        <input type="radio" name="absen_${s.id}" value="A" class="w-4 h-4">
                    </td>
                </tr>
            `).join('');
        }

        async function simpanAbsensi() {
            const tanggal = document.getElementById('absensiTanggal').value;
            const kelas = document.getElementById('absensiKelas').value;
            const mapel = document.getElementById('absensiMapel').value;
            const jam = document.getElementById('absensiJam').value;

            if (!tanggal || !kelas || !mapel) {
                showToast('Lengkapi semua filter', 'error');
                return;
            }

            const absensiData = {
                tanggal,
                kelas,
                mapel,
                jam,
                tahunAjar: currentTahunAjar,
                semester: currentSemester,
                data: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Collect attendance data
            document.querySelectorAll('#tableAbsensi tr').forEach(tr => {
                const inputs = tr.querySelectorAll('input[type="radio"]');
                if (inputs.length > 0) {
                    const name = inputs[0].name;
                    const siswaId = name.replace('absen_', '');
                    const checked = tr.querySelector(`input[name="${name}"]:checked`);
                    absensiData.data.push({
                        siswaId,
                        status: checked?.value || 'H'
                    });
                }
            });

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('absensi').add(absensiData);
                showToast('Absensi berhasil disimpan', 'success');
            } catch (error) {
                showToast('Gagal menyimpan absensi', 'error');
            }
        }

        async function loadJurnalData() {
            // Similar to absensi, populate filters
            document.getElementById('jurnalMapel').innerHTML = '<option value="">Pilih Mapel</option>' +
                (userData.mapel || []).map(m => `<option value="${m.nama}">${m.nama}</option>`).join('');

            const kelasSet = new Set();
            jadwalList.forEach(j => kelasSet.add(j.kelas));
            document.getElementById('jurnalKelas').innerHTML = '<option value="">Pilih Kelas</option>' +
                Array.from(kelasSet).sort().map(k => `<option value="${k}">Kelas ${k}</option>`).join('');
        }

        // ==================== AI ASSISTANT ====================

        const promptTemplates = {
            siswa: `Saya ingin mengubah daftar siswa menjadi format CSV.

Format CSV yang dibutuhkan:
nisn,nama,jenis_kelamin,kelas,rombel

Contoh output:
nisn,nama,jenis_kelamin,kelas,rombel
1234567890,Ahmad Rizki,L,1,A
1234567891,Siti Fatimah,P,1,A

Tolong ubah data berikut menjadi format CSV di atas:
[PASTE DATA SISWA ANDA DI SINI]

Catatan:
- jenis_kelamin: L untuk Laki-laki, P untuk Perempuan
- kelas: angka saja (1, 2, 3, dst)
- rombel: huruf (A, B, C, dst)`,

            kalender: `Saya ingin mengubah jadwal kegiatan sekolah menjadi format CSV.

Format CSV yang dibutuhkan:
tanggal,keterangan,jenis

Contoh output:
tanggal,keterangan,jenis
2025-07-14,Hari pertama masuk sekolah,kegiatan
2025-08-17,Hari Kemerdekaan RI,libur
2025-09-15,UTS Semester 1,ujian

Tolong ubah data berikut menjadi format CSV di atas:
[PASTE JADWAL KEGIATAN ANDA DI SINI]

Catatan:
- tanggal: format YYYY-MM-DD
- jenis: libur, kegiatan, atau ujian`,

            cp: `Saya ingin membuat Capaian Pembelajaran dalam format CSV.

Format CSV yang dibutuhkan:
kelas,fase,bab,elemen,judul,tujuan,profil_lulusan

Contoh output:
kelas,fase,bab,elemen,judul,tujuan,profil_lulusan
1,A,1,Al-Qur'an dan Hadis,Mengenal Huruf Hijaiyah,Peserta didik dapat mengenal dan melafalkan huruf hijaiyah,Keimanan

8 Dimensi Profil Lulusan yang tersedia:
1. Keimanan
2. Kewargaan
3. Penalaran Kritis
4. Kreativitas
5. Kolaborasi
6. Kemandirian
7. Kesehatan
8. Komunikasi

Tolong ubah data berikut menjadi format CSV di atas:
[PASTE MATERI/CP ANDA DI SINI]`
        };

        function usePrompt(type) {
            document.getElementById('aiPrompt').value = promptTemplates[type] || '';
        }

        function copyPrompt() {
            const textarea = document.getElementById('aiPrompt');
            textarea.select();
            document.execCommand('copy');
            showToast('Prompt berhasil disalin', 'success');
        }

        function openChatGPT() {
            window.open('https://chat.openai.com', '_blank');
        }

        // ==================== ADMIN FUNCTIONS ====================

        async function loadAdminData() {
            if (currentUser.email !== SUPER_ADMIN_EMAIL) {
                showPage('dashboard');
                return;
            }

            try {
                // Load stats
                const usersSnap = await db.collection('users').get();
                document.getElementById('adminTotalUsers').textContent = usersSnap.size;

                let premiumCount = 0;
                let schoolCount = 0;
                usersSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.subscription === 'premium') premiumCount++;
                    if (data.subscriptionType === 'school') schoolCount++;
                });
                document.getElementById('adminPremiumUsers').textContent = premiumCount;
                document.getElementById('adminSchoolPkg').textContent = schoolCount;

                // Load CP default count
                const cpDefaultSnap = await db.collection('cpDefault').get();
                document.getElementById('adminTotalCP').textContent = cpDefaultSnap.size;

                // Load users table
                await loadAdminUsersTable();

                // Load settings
                await loadAppSettings();

                // Populate settings fields
                document.getElementById('adminWANumber').value = appSettings.waNumber || '';
                document.getElementById('adminWAMessage').value = appSettings.waMessage || '';
                document.getElementById('adminPricePersonal').value = appSettings.pricePersonal || 100000;
                document.getElementById('adminPriceSchool').value = appSettings.priceSchool || 500000;

            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        async function loadAdminUsersTable() {
            try {
                const snap = await db.collection('users').orderBy('createdAt', 'desc').limit(50).get();
                const tbody = document.getElementById('adminTableUsers');

                tbody.innerHTML = '';
                snap.forEach(doc => {
                    const user = doc.data();
                    const statusClass = user.subscription === 'premium' ? 'badge-warning' : 'badge-info';
                    tbody.innerHTML += `
                        <tr>
                            <td class="px-4 py-3">${user.email}</td>
                            <td class="px-4 py-3">${user.nama || '-'}</td>
                            <td class="px-4 py-3 text-center">
                                <span class="badge ${statusClass}">${user.subscription || 'free'}</span>
                            </td>
                            <td class="px-4 py-3">${user.createdAt ? formatDate(user.createdAt.toDate().toISOString().split('T')[0]) : '-'}</td>
                            <td class="px-4 py-3 text-center">
                                <button onclick="toggleUserPremium('${doc.id}', '${user.subscription}')" 
                                    class="text-primary-600 hover:text-primary-800 mr-2" title="Toggle Premium">
                                    <i class="fas fa-crown"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function toggleUserPremium(userId, currentStatus) {
            const newStatus = currentStatus === 'premium' ? 'free' : 'premium';
            
            try {
                await db.collection('users').doc(userId).update({
                    subscription: newStatus
                });
                await loadAdminUsersTable();
                await loadAdminData();
                showToast(`Status user diubah ke ${newStatus}`, 'success');
            } catch (error) {
                showToast('Gagal mengubah status', 'error');
            }
        }

        function showAdminTab(tabName) {
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('bg-primary-500', 'text-white');
                tab.classList.add('bg-gray-100', 'text-gray-600');
            });
            document.querySelector(`.admin-tab[data-tab="${tabName}"]`).classList.remove('bg-gray-100', 'text-gray-600');
            document.querySelector(`.admin-tab[data-tab="${tabName}"]`).classList.add('bg-primary-500', 'text-white');

            document.querySelectorAll('.admin-tab-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(`adminTab-${tabName}`).classList.remove('hidden');
        }

        async function saveAdminSettings() {
            appSettings = {
                waNumber: document.getElementById('adminWANumber').value,
                waMessage: document.getElementById('adminWAMessage').value,
                pricePersonal: parseInt(document.getElementById('adminPricePersonal').value) || 100000,
                priceSchool: parseInt(document.getElementById('adminPriceSchool').value) || 500000
            };

            try {
                await db.collection('settings').doc('app').set(appSettings);
                showToast('Pengaturan disimpan', 'success');
            } catch (error) {
                showToast('Gagal menyimpan pengaturan', 'error');
            }
        }

        async function loadAppSettings() {
            try {
                const doc = await db.collection('settings').doc('app').get();
                if (doc.exists) {
                    appSettings = { ...appSettings, ...doc.data() };
                }
            } catch (error) {
                console.error('Error loading app settings:', error);
            }
        }

        // ==================== UPGRADE & WHATSAPP ====================

        function showUpgradeModal() {
            document.getElementById('modalPricePersonal').textContent = `Rp ${appSettings.pricePersonal?.toLocaleString('id-ID') || '100.000'}`;
            document.getElementById('modalPriceSchool').textContent = `Rp ${appSettings.priceSchool?.toLocaleString('id-ID') || '500.000'}`;
            openModal('upgradeModal');
        }

        function redirectToWhatsApp() {
            const phone = appSettings.waNumber || '6281234567890';
            const message = encodeURIComponent(appSettings.waMessage || 'Halo, saya ingin upgrade ke Premium ADMIN GURU SUPER APP');
            window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
        }

        // ==================== UTILITIES ====================

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.body.style.overflow = '';
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const text = document.getElementById('toastMessage');

            text.textContent = message;

            if (type === 'success') {
                icon.className = 'fas fa-check-circle text-green-400';
            } else if (type === 'error') {
                icon.className = 'fas fa-times-circle text-red-400';
            } else {
                icon.className = 'fas fa-info-circle text-blue-400';
            }

            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        // Close modals on backdrop click
        document.querySelectorAll('.modal-backdrop').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
            });
        });

        // Initialize
        window.addEventListener('load', () => {
            // Show loading initially
        });
    </script>
</body>
</html>
