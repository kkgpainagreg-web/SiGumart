<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Guru Super App - SaaS Edition</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“š</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --accent: #f59e0b;
            --dark: #1e293b;
        }
        body { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); min-height: 100vh; }
        .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); }
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-primary { background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%); }
        .gradient-secondary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .paper-preview { background: white; margin: 20px auto; padding: 15mm; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 210mm; min-height: 297mm; border-radius: 8px; }
        .paper-preview.landscape { max-width: 297mm; min-height: 210mm; }
        .doc-table { width: 100%; border-collapse: collapse; font-size: 10pt; margin-bottom: 20px; }
        .doc-table th, .doc-table td { border: 1px solid #334155; padding: 8px; text-align: left; vertical-align: top; }
        .doc-table th { background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); font-weight: 600; text-align: center; }
        .event-cell { vertical-align: middle !important; text-align: center !important; background: linear-gradient(135deg, #fca5a5 0%, #f87171 100%) !important; }
        .vertical-text { writing-mode: vertical-rl; transform: rotate(180deg); font-size: 7pt; font-weight: bold; }
        [contenteditable="true"]:hover { background: #fef9c3; outline: 2px dashed #eab308; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .signature-area { display: flex; justify-content: space-between; margin-top: 40px; page-break-inside: avoid; }
        .signature-box { text-align: center; font-size: 11pt; min-width: 200px; }
        .signature-name { text-decoration: underline; font-weight: bold; margin-top: 70px; }
        .nav-item { transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover, .nav-item.active { background: rgba(37, 99, 235, 0.1); border-left-color: #2563eb; }
        .premium-badge { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast { animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); position: fixed !important; z-index: 100; }
            .sidebar.open { transform: translateX(0); }
            .paper-preview { padding: 5mm; margin: 10px; font-size: 8pt; }
            .doc-table th, .doc-table td { padding: 4px; font-size: 8pt; }
        }
        @media print {
            body { background: white; }
            .no-print, #sidebar, #topbar, .mobile-menu-btn { display: none !important; }
            #main-content { margin: 0; padding: 0; }
            .paper-preview { margin: 0; box-shadow: none; page-break-after: always; }
            @page { size: A4 portrait; margin: 10mm; }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-[2000] space-y-2"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-[3000] flex items-center justify-center">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-slate-600 font-medium">Memuat aplikasi...</p>
        </div>
    </div>

    <!-- Landing Page -->
    <div id="landing-page" class="hidden">
        <nav class="fixed top-0 left-0 right-0 z-50 glass border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 gradient-primary rounded-xl flex items-center justify-center text-white text-xl">ğŸ“š</div>
                    <span class="font-bold text-xl text-slate-800">AdminGuru<span class="text-blue-600">Pro</span></span>
                </div>
                <div class="hidden md:flex items-center gap-8">
                    <a href="#features" class="text-slate-600 hover:text-blue-600 font-medium">Fitur</a>
                    <a href="#pricing" class="text-slate-600 hover:text-blue-600 font-medium">Harga</a>
                    <a href="#contact" class="text-slate-600 hover:text-blue-600 font-medium">Kontak</a>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="UISystem.showPage('login')" class="px-4 py-2 text-blue-600 font-semibold hover:bg-blue-50 rounded-lg transition">Masuk</button>
                    <button onclick="UISystem.showPage('register')" class="px-5 py-2 gradient-primary text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition">Daftar Gratis</button>
                </div>
            </div>
        </nav>

        <!-- Hero Section -->
        <section class="pt-32 pb-20 px-4">
            <div class="max-w-7xl mx-auto grid lg:grid-cols-2 gap-12 items-center">
                <div>
                    <div class="inline-flex items-center gap-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-full text-sm font-medium mb-6">
                        <span>ğŸš€</span> Platform Administrasi Guru #1 di Indonesia
                    </div>
                    <h1 class="text-4xl lg:text-6xl font-extrabold text-slate-900 leading-tight mb-6">
                        Kelola Administrasi <span class="text-transparent bg-clip-text gradient-primary">Guru</span> dengan Mudah
                    </h1>
                    <p class="text-lg text-slate-600 mb-8 leading-relaxed">
                        Generate ATP, Prota, Promes, Modul Ajar, LKPD, Jurnal, Absensi, KKTP & Nilai secara otomatis. 
                        Terintegrasi dengan Kurikulum Merdeka terbaru.
                    </p>
                    <div class="flex flex-wrap gap-4">
                        <button onclick="UISystem.showPage('register')" class="px-8 py-4 gradient-primary text-white font-bold rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition flex items-center gap-2">
                            <span>Mulai Gratis</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/></svg>
                        </button>
                        <button class="px-8 py-4 border-2 border-slate-300 text-slate-700 font-bold rounded-xl hover:border-blue-500 hover:text-blue-600 transition flex items-center gap-2">
                            <span>â–¶ï¸</span> Lihat Demo
                        </button>
                    </div>
                    <div class="flex items-center gap-6 mt-8">
                        <div class="flex -space-x-3">
                            <div class="w-10 h-10 rounded-full bg-blue-500 border-2 border-white flex items-center justify-center text-white text-sm font-bold">A</div>
                            <div class="w-10 h-10 rounded-full bg-green-500 border-2 border-white flex items-center justify-center text-white text-sm font-bold">B</div>
                            <div class="w-10 h-10 rounded-full bg-purple-500 border-2 border-white flex items-center justify-center text-white text-sm font-bold">C</div>
                            <div class="w-10 h-10 rounded-full bg-orange-500 border-2 border-white flex items-center justify-center text-white text-sm font-bold">+</div>
                        </div>
                        <div class="text-sm text-slate-600">
                            <span class="font-bold text-slate-900">5,000+</span> Guru sudah bergabung
                        </div>
                    </div>
                </div>
                <div class="relative hidden lg:block">
                    <div class="absolute -top-10 -left-10 w-72 h-72 bg-blue-200 rounded-full opacity-50 blur-3xl"></div>
                    <div class="absolute -bottom-10 -right-10 w-72 h-72 bg-purple-200 rounded-full opacity-50 blur-3xl"></div>
                    <div class="relative glass rounded-2xl shadow-2xl p-6 animate-float">
                        <div class="bg-slate-100 rounded-xl p-4 mb-4">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-8 h-8 bg-blue-500 rounded-lg"></div>
                                <div class="flex-1">
                                    <div class="h-3 bg-slate-300 rounded w-3/4 mb-2"></div>
                                    <div class="h-2 bg-slate-200 rounded w-1/2"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="h-16 bg-green-200 rounded-lg"></div>
                                <div class="h-16 bg-blue-200 rounded-lg"></div>
                                <div class="h-16 bg-purple-200 rounded-lg"></div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-slate-600">âœ… ATP Generated</span>
                            <span class="text-green-600 font-bold">100%</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section id="features" class="py-20 px-4 bg-white">
            <div class="max-w-7xl mx-auto">
                <div class="text-center mb-16">
                    <h2 class="text-3xl lg:text-4xl font-bold text-slate-900 mb-4">Fitur Lengkap untuk Guru Modern</h2>
                    <p class="text-lg text-slate-600 max-w-2xl mx-auto">Semua yang Anda butuhkan untuk mengelola administrasi pembelajaran dalam satu platform</p>
                </div>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="card-hover bg-gradient-to-br from-blue-50 to-white p-6 rounded-2xl border border-blue-100">
                        <div class="w-14 h-14 gradient-primary rounded-2xl flex items-center justify-center text-2xl mb-4">ğŸ“‹</div>
                        <h3 class="text-xl font-bold text-slate-900 mb-2">ATP & Prota</h3>
                        <p class="text-slate-600">Generate Alur Tujuan Pembelajaran dan Program Tahunan otomatis sesuai Kurikulum Merdeka</p>
                        <span class="inline-block mt-3 px-3 py-1 bg-green-100 text-green-700 text-sm font-medium rounded-full">GRATIS</span>
                    </div>
                    <div class="card-hover bg-gradient-to-br from-green-50 to-white p-6 rounded-2xl border border-green-100">
                        <div class="w-14 h-14 gradient-secondary rounded-2xl flex items-center justify-center text-2xl mb-4">ğŸ“…</div>
                        <h3 class="text-xl font-bold text-slate-900 mb-2">Kalender & Jadwal</h3>
                        <p class="text-slate-600">Kelola kalender pendidikan dan jadwal pelajaran dengan mudah dan fleksibel</p>
                        <span class="inline-block mt-3 px-3 py-1 bg-green-100 text-green-700 text-sm font-medium rounded-full">GRATIS</span>
                    </div>
                    <div class="card-hover bg-gradient-to-br from-purple-50 to-white p-6 rounded-2xl border border-purple-100">
                        <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center text-2xl mb-4">ğŸ“š</div>
                        <h3 class="text-xl font-bold text-slate-900 mb-2">Modul & LKPD</h3>
                        <p class="text-slate-600">Buat Modul Ajar dan Lembar Kerja Peserta Didik yang menarik secara otomatis</p>
                        <span class="inline-block mt-3 px-3 py-1 premium-badge text-white text-sm font-medium rounded-full">PRO</span>
                    </div>
                    <div class="card-hover bg-gradient-to-br from-amber-50 to-white p-6 rounded-2xl border border-amber-100">
                        <div class="w-14 h-14 bg-gradient-to-br from-amber-500 to-orange-500 rounded-2xl flex items-center justify-center text-2xl mb-4">ğŸ“</div>
                        <h3 class="text-xl font-bold text-slate-900 mb-2">Jurnal & Absensi</h3>
                        <p class="text-slate-600">Catat pelaksanaan pembelajaran dan kehadiran siswa dengan praktis</p>
                        <span class="inline-block mt-3 px-3 py-1 premium-badge text-white text-sm font-medium rounded-full">PRO</span>
                    </div>
                    <div class="card-hover bg-gradient-to-br from-red-50 to-white p-6 rounded-2xl border border-red-100">
                        <div class="w-14 h-14 bg-gradient-to-br from-red-500 to-pink-500 rounded-2xl flex items-center justify-center text-2xl mb-4">ğŸ¯</div>
                        <h3 class="text-xl font-bold text-slate-900 mb-2">KKTP & Nilai</h3>
                        <p class="text-slate-600">Kelola kriteria ketercapaian dan penilaian siswa dengan mudah</p>
                        <span class="inline-block mt-3 px-3 py-1 premium-badge text-white text-sm font-medium rounded-full">PRO</span>
                    </div>
                    <div class="card-hover bg-gradient-to-br from-cyan-50 to-white p-6 rounded-2xl border border-cyan-100">
                        <div class="w-14 h-14 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-2xl flex items-center justify-center text-2xl mb-4">â“</div>
                        <h3 class="text-xl font-bold text-slate-900 mb-2">Bank Soal</h3>
                        <p class="text-slate-600">Buat dan kelola bank soal dengan berbagai tipe pertanyaan</p>
                        <span class="inline-block mt-3 px-3 py-1 premium-badge text-white text-sm font-medium rounded-full">PRO</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Pricing Section -->
        <section id="pricing" class="py-20 px-4">
            <div class="max-w-5xl mx-auto">
                <div class="text-center mb-16">
                    <h2 class="text-3xl lg:text-4xl font-bold text-slate-900 mb-4">Pilih Paket Anda</h2>
                    <p class="text-lg text-slate-600">Mulai gratis, upgrade kapan saja</p>
                </div>
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-white rounded-3xl p-8 shadow-lg border border-slate-200">
                        <div class="text-center mb-6">
                            <span class="text-slate-600 font-medium">GRATIS</span>
                            <div class="text-4xl font-extrabold text-slate-900 mt-2">Rp 0</div>
                            <span class="text-slate-500">Selamanya</span>
                        </div>
                        <ul class="space-y-4 mb-8">
                            <li class="flex items-center gap-3"><span class="text-green-500">âœ“</span> Kalender Pendidikan</li>
                            <li class="flex items-center gap-3"><span class="text-green-500">âœ“</span> Jadwal Pelajaran</li>
                            <li class="flex items-center gap-3"><span class="text-green-500">âœ“</span> ATP (Alur Tujuan Pembelajaran)</li>
                            <li class="flex items-center gap-3"><span class="text-green-500">âœ“</span> Prota (Program Tahunan)</li>
                            <li class="flex items-center gap-3 text-slate-400"><span>âœ—</span> Promes</li>
                            <li class="flex items-center gap-3 text-slate-400"><span>âœ—</span> Modul Ajar & LKPD</li>
                            <li class="flex items-center gap-3 text-slate-400"><span>âœ—</span> Jurnal & Absensi</li>
                            <li class="flex items-center gap-3 text-slate-400"><span>âœ—</span> KKTP & Nilai</li>
                            <li class="flex items-center gap-3 text-slate-400"><span>âœ—</span> Bank Soal</li>
                        </ul>
                        <button onclick="UISystem.showPage('register')" class="w-full py-3 border-2 border-slate-300 text-slate-700 font-bold rounded-xl hover:border-blue-500 hover:text-blue-600 transition">
                            Mulai Gratis
                        </button>
                    </div>
                    <div class="bg-gradient-to-br from-blue-600 to-purple-600 rounded-3xl p-8 shadow-2xl text-white relative overflow-hidden">
                        <div class="absolute top-4 right-4 bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-sm font-bold">POPULER</div>
                        <div class="text-center mb-6">
                            <span class="text-blue-200 font-medium">PRO</span>
                            <div class="text-4xl font-extrabold mt-2">Rp 50.000</div>
                            <span class="text-blue-200">Per bulan</span>
                        </div>
                        <ul class="space-y-4 mb-8">
                            <li class="flex items-center gap-3"><span class="text-yellow-400">âœ“</span> Semua Fitur Gratis</li>
                            <li class="flex items-center gap-3"><span class="text-yellow-400">âœ“</span> Promes (Program Semester)</li>
                            <li class="flex items-center gap-3"><span class="text-yellow-400">âœ“</span> Modul Ajar & LKPD</li>
                            <li class="flex items-center gap-3"><span class="text-yellow-400">âœ“</span> Jurnal Pembelajaran</li>
                            <li class="flex items-center gap-3"><span class="text-yellow-400">âœ“</span> Absensi Interaktif</li>
                            <li class="flex items-center gap-3"><span class="text-yellow-400">âœ“</span> KKTP & Daftar Nilai</li>
                            <li class="flex items-center gap-3"><span class="text-yellow-400">âœ“</span> Bank Soal Lengkap</li>
                            <li class="flex items-center gap-3"><span class="text-yellow-400">âœ“</span> Kolaborasi Sekolah</li>
                            <li class="flex items-center gap-3"><span class="text-yellow-400">âœ“</span> Support Prioritas</li>
                        </ul>
                        <button onclick="SubscriptionSystem.showUpgradeModal()" class="w-full py-3 bg-white text-blue-600 font-bold rounded-xl hover:bg-blue-50 transition">
                            Upgrade Sekarang
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer id="contact" class="bg-slate-900 text-white py-12 px-4">
            <div class="max-w-7xl mx-auto grid md:grid-cols-4 gap-8">
                <div>
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 gradient-primary rounded-xl flex items-center justify-center text-xl">ğŸ“š</div>
                        <span class="font-bold text-xl">AdminGuru<span class="text-blue-400">Pro</span></span>
                    </div>
                    <p class="text-slate-400 text-sm">Platform administrasi guru terlengkap di Indonesia</p>
                </div>
                <div>
                    <h4 class="font-bold mb-4">Fitur</h4>
                    <ul class="space-y-2 text-slate-400 text-sm">
                        <li>ATP & Prota</li>
                        <li>Promes</li>
                        <li>Modul Ajar</li>
                        <li>Bank Soal</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold mb-4">Dukungan</h4>
                    <ul class="space-y-2 text-slate-400 text-sm">
                        <li>Panduan</li>
                        <li>FAQ</li>
                        <li>Kontak</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold mb-4">Kontak</h4>
                    <p class="text-slate-400 text-sm">Email: support@adminguru.id</p>
                    <p class="text-slate-400 text-sm mt-2">WhatsApp: <span id="footer-wa">6281234567890</span></p>
                </div>
            </div>
            <div class="max-w-7xl mx-auto mt-8 pt-8 border-t border-slate-800 text-center text-slate-500 text-sm">
                Â© 2025 AdminGuruPro. All rights reserved.
            </div>
        </footer>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-16 h-16 gradient-primary rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4">ğŸ“š</div>
                <h1 class="text-2xl font-bold text-slate-900">Masuk ke Akun</h1>
                <p class="text-slate-500 mt-2">Selamat datang kembali!</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                    <input type="email" id="login-email" required class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="email@contoh.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                    <input type="password" id="login-password" required class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button type="submit" class="w-full py-3 gradient-primary text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition">
                    Masuk
                </button>
            </form>
            <p class="text-center text-slate-600 mt-6">
                Belum punya akun? <button onclick="UISystem.showPage('register')" class="text-blue-600 font-semibold hover:underline">Daftar</button>
            </p>
            <button onclick="UISystem.showPage('landing')" class="w-full mt-4 text-slate-500 hover:text-slate-700 text-sm">â† Kembali</button>
        </div>
    </div>

    <!-- Register Page -->
    <div id="register-page" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-16 h-16 gradient-secondary rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4">ğŸ“</div>
                <h1 class="text-2xl font-bold text-slate-900">Daftar Akun Baru</h1>
                <p class="text-slate-500 mt-2">Buat akun gratis sekarang</p>
            </div>
            <form id="register-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nama Lengkap</label>
                    <input type="text" id="reg-nama" required class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition" placeholder="Nama lengkap dengan gelar">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                    <input type="email" id="reg-email" required class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition" placeholder="email@contoh.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">NPSN Sekolah</label>
                    <input type="text" id="reg-npsn" required class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition" placeholder="8 digit NPSN">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                    <input type="password" id="reg-password" required minlength="6" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition" placeholder="Minimal 6 karakter">
                </div>
                <button type="submit" class="w-full py-3 gradient-secondary text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition">
                    Daftar Sekarang
                </button>
            </form>
            <p class="text-center text-slate-600 mt-6">
                Sudah punya akun? <button onclick="UISystem.showPage('login')" class="text-green-600 font-semibold hover:underline">Masuk</button>
            </p>
            <button onclick="UISystem.showPage('landing')" class="w-full mt-4 text-slate-500 hover:text-slate-700 text-sm">â† Kembali</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden flex h-screen overflow-hidden">
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" class="mobile-menu-btn fixed top-4 left-4 z-50 md:hidden bg-white p-2 rounded-lg shadow-lg" onclick="document.getElementById('sidebar').classList.toggle('open')">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>

        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar w-64 min-w-[256px] bg-slate-900 text-white flex flex-col h-full transition-transform duration-300 no-print">
            <div class="p-5 border-b border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 gradient-primary rounded-xl flex items-center justify-center text-xl">ğŸ“š</div>
                    <div>
                        <span class="font-bold text-lg">AdminGuru</span>
                        <span id="user-badge" class="ml-2 px-2 py-0.5 rounded text-xs font-semibold bg-slate-700 text-slate-300">FREE</span>
                    </div>
                </div>
                <div class="mt-3 text-sm text-slate-400 truncate" id="sidebar-user-email">user@email.com</div>
            </div>

            <nav class="flex-1 overflow-y-auto sidebar-scroll p-3 space-y-1">
                <button onclick="UISystem.switchView('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left hover:bg-slate-800 transition">
                    <span>ğŸ“Š</span> Dashboard
                </button>
                <button onclick="UISystem.switchView('profil')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left hover:bg-slate-800 transition">
                    <span>ğŸ‘¤</span> Profil Guru
                </button>
                <button onclick="UISystem.switchView('sekolah')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left hover:bg-slate-800 transition">
                    <span>ğŸ«</span> Profil Sekolah
                </button>
                <button onclick="UISystem.switchView('kurikulum')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left hover:bg-slate-800 transition">
                    <span>ğŸ“–</span> Kurikulum & Mapel
                </button>
                <button onclick="UISystem.switchView('kalender')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left hover:bg-slate-800 transition">
                    <span>ğŸ“…</span> Kalender & Libur
                </button>
                <button onclick="UISystem.switchView('banksoal')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left hover:bg-slate-800 transition">
                    <span>â“</span> Bank Soal
                    <span class="premium-badge text-[10px] px-2 py-0.5 rounded ml-auto">PRO</span>
                </button>
                <button onclick="UISystem.switchView('generate')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left hover:bg-slate-800 transition">
                    <span>ğŸ“„</span> Generate Dokumen
                </button>
                <button onclick="UISystem.switchView('subscription')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left hover:bg-slate-800 transition">
                    <span>ğŸ’³</span> Subscription
                </button>
                <button onclick="UISystem.switchView('superadmin')" id="nav-superadmin" class="nav-item hidden w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left hover:bg-slate-800 transition text-amber-400">
                    <span>ğŸ‘‘</span> Super Admin
                </button>
            </nav>

            <div class="p-4 border-t border-slate-700">
                <button onclick="AuthSystem.logout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-red-600 hover:bg-red-500 rounded-lg font-semibold transition">
                    <span>ğŸšª</span> Keluar
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header id="topbar" class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 md:px-6 no-print">
                <div class="flex items-center gap-4 ml-12 md:ml-0">
                    <h1 id="page-title" class="text-xl font-bold text-slate-900">Dashboard</h1>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="window.print()" class="hidden md:flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-700 font-medium transition">
                        <span>ğŸ–¨ï¸</span> Cetak
                    </button>
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold" id="user-avatar">U</div>
                </div>
            </header>

            <div id="main-content" class="flex-1 overflow-y-auto p-4 md:p-6">
                <!-- Views will be loaded here -->
            </div>
        </main>
    </div>

    <!-- Upgrade Modal -->
    <div id="upgrade-modal" class="modal-overlay">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 relative">
            <button onclick="document.getElementById('upgrade-modal').style.display='none'" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">âœ•</button>
            <div class="text-center">
                <div class="w-20 h-20 gradient-primary rounded-full flex items-center justify-center text-4xl mx-auto mb-4">ğŸ‘‘</div>
                <h2 class="text-2xl font-bold text-slate-900 mb-2">Upgrade ke PRO</h2>
                <p class="text-slate-600 mb-6">Fitur ini tersedia pada versi PRO. Upgrade sekarang untuk akses penuh!</p>
                <a id="upgrade-wa-link" href="#" target="_blank" class="inline-flex items-center gap-2 px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl transition">
                    <span>ğŸ’¬</span> Hubungi WhatsApp
                </a>
            </div>
        </div>
    </div>

    <!-- Student Modal -->
    <div id="student-modal" class="modal-overlay">
        <div class="bg-white rounded-2xl p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-900">ğŸ“‹ Input Data Siswa</h2>
                <button onclick="document.getElementById('student-modal').style.display='none'" class="text-slate-400 hover:text-slate-600 text-2xl">âœ•</button>
            </div>
            <p class="text-sm text-slate-600 mb-4">Paste daftar nama siswa (1 baris = 1 nama)</p>
            <textarea id="student-input" rows="10" class="w-full border border-slate-300 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="1. Ahmad Fulan&#10;2. Siti Fulanah"></textarea>
            <button onclick="ProfileSystem.saveStudents()" class="w-full mt-4 py-3 gradient-primary text-white font-bold rounded-xl transition">
                Simpan Data Siswa
            </button>
        </div>
    </div>

<script>
// =====================================================
// FIREBASE CONFIGURATION
// =====================================================
const firebaseConfig = {
    apiKey: "AIzaSyDe4ie2wSPEpNbAgWP-q03vTuHyxc9Jj3E",
    authDomain: "agsa-e5b08.firebaseapp.com",
    projectId: "agsa-e5b08",
    storageBucket: "agsa-e5b08.firebasestorage.app",
    messagingSenderId: "916052746331",
    appId: "1:916052746331:web:357cbadbfd8658f1689f7e",
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// =====================================================
// CONSTANTS
// =====================================================
const CP_LINKS = {
    "SD": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1925091593&single=true&output=csv",
    "SMP": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1962203786&single=true&output=csv",
    "SMA": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=260922290&single=true&output=csv"
};

const BULAN_IND = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
const HARI_IND = ["Minggu","Senin","Selasa","Rabu","Kamis","Jum'at","Sabtu"];
const SUPER_ADMIN_EMAIL = "afifaro@gmail.com";

const FREE_FEATURES = ['atp', 'prota', 'kalender', 'jadwal'];
const PRO_FEATURES = ['promes', 'modul', 'lkpd', 'jurnal', 'absensi', 'kktp', 'nilai', 'banksoal'];

// =====================================================
// UTILITY FUNCTIONS
// =====================================================
const Utils = {
    toast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const colors = {
            success: 'bg-green-500',
            error: 'bg-red-500',
            info: 'bg-blue-500',
            warning: 'bg-amber-500'
        };
        const toast = document.createElement('div');
        toast.className = `toast ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg font-medium`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    },

    formatDate(dateStr) {
        if (!dateStr) return "";
        const [y, m, d] = dateStr.split('-');
        return `${parseInt(d)} ${BULAN_IND[parseInt(m)-1]} ${y}`;
    },

    generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }
};

// =====================================================
// AUTH SYSTEM
// =====================================================
const AuthSystem = {
    currentUser: null,
    userData: null,

    init() {
        auth.onAuthStateChanged(async (user) => {
            document.getElementById('loading-overlay').style.display = 'none';
            
            if (user) {
                this.currentUser = user;
                await this.loadUserData();
                UISystem.showPage('app');
            } else {
                this.currentUser = null;
                this.userData = null;
                UISystem.showPage('landing');
            }
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.login();
        });

        document.getElementById('register-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.register();
        });
    },

    async login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        try {
            await auth.signInWithEmailAndPassword(email, password);
            Utils.toast('Login berhasil!', 'success');
        } catch (error) {
            Utils.toast('Login gagal: ' + error.message, 'error');
        }
    },

    async register() {
        const nama = document.getElementById('reg-nama').value;
        const email = document.getElementById('reg-email').value;
        const npsn = document.getElementById('reg-npsn').value;
        const password = document.getElementById('reg-password').value;

        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            
            await db.collection('users').doc(userCredential.user.uid).set({
                nama: nama,
                email: email,
                npsn: npsn,
                role: email === SUPER_ADMIN_EMAIL ? 'super_admin' : 'guru',
                isPremium: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Check if school exists, if not create it
            const schoolRef = db.collection('schools').doc(npsn);
            const schoolDoc = await schoolRef.get();
            
            if (!schoolDoc.exists) {
                await schoolRef.set({
                    npsn: npsn,
                    namaSekolah: '',
                    alamat: '',
                    kepsek: '',
                    nipKepsek: '',
                    premiumByAdmin: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            Utils.toast('Registrasi berhasil!', 'success');
        } catch (error) {
            Utils.toast('Registrasi gagal: ' + error.message, 'error');
        }
    },

    async loadUserData() {
        if (!this.currentUser) return;

        try {
            const doc = await db.collection('users').doc(this.currentUser.uid).get();
            if (doc.exists) {
                this.userData = { id: doc.id, ...doc.data() };
                this.updateUI();
                await SubscriptionSystem.checkPremiumStatus();
            }
        } catch (error) {
            console.error('Error loading user data:', error);
        }
    },

    updateUI() {
        if (!this.userData) return;

        document.getElementById('sidebar-user-email').textContent = this.userData.email;
        document.getElementById('user-avatar').textContent = this.userData.nama?.charAt(0).toUpperCase() || 'U';

        const isPremium = SubscriptionSystem.isPremium();
        document.getElementById('user-badge').textContent = isPremium ? 'PRO' : 'FREE';
        document.getElementById('user-badge').className = `ml-2 px-2 py-0.5 rounded text-xs font-semibold ${isPremium ? 'bg-amber-500 text-white' : 'bg-slate-700 text-slate-300'}`;

        // Show super admin nav
        if (this.userData.role === 'super_admin') {
            document.getElementById('nav-superadmin').classList.remove('hidden');
        }
    },

    logout() {
        auth.signOut();
        Utils.toast('Logout berhasil', 'info');
    }
};

// =====================================================
// SUBSCRIPTION SYSTEM
// =====================================================
const SubscriptionSystem = {
    settings: {
        whatsappUpgrade: "6281234567890",
        premiumNPSN: []
    },

    async init() {
        await this.loadSettings();
    },

    async loadSettings() {
        try {
            const doc = await db.collection('settings').doc('subscription').get();
            if (doc.exists) {
                this.settings = { ...this.settings, ...doc.data() };
            }
            document.getElementById('footer-wa').textContent = this.settings.whatsappUpgrade;
        } catch (error) {
            console.error('Error loading subscription settings:', error);
        }
    },

    async checkPremiumStatus() {
        if (!AuthSystem.userData) return false;

        // Super admin is always premium
        if (AuthSystem.userData.role === 'super_admin') {
            AuthSystem.userData.isPremium = true;
            return true;
        }

        // Check if NPSN is in premium list
        if (this.settings.premiumNPSN.includes(AuthSystem.userData.npsn)) {
            AuthSystem.userData.isPremium = true;
            return true;
        }

        // Check school premium status
        try {
            const schoolDoc = await db.collection('schools').doc(AuthSystem.userData.npsn).get();
            if (schoolDoc.exists && schoolDoc.data().premiumByAdmin) {
                AuthSystem.userData.isPremium = true;
                return true;
            }
        } catch (error) {
            console.error('Error checking school premium:', error);
        }

        AuthSystem.updateUI();
        return AuthSystem.userData.isPremium;
    },

    isPremium() {
        return AuthSystem.userData?.isPremium || false;
    },

    guard(feature) {
        if (FREE_FEATURES.includes(feature)) return true;
        if (this.isPremium()) return true;
        
        this.showUpgradeModal();
        return false;
    },

    showUpgradeModal() {
        const waLink = `https://wa.me/${this.settings.whatsappUpgrade}?text=${encodeURIComponent('Halo, saya ingin upgrade ke versi PRO AdminGuruPro')}`;
        document.getElementById('upgrade-wa-link').href = waLink;
        document.getElementById('upgrade-modal').style.display = 'flex';
    }
};

// =====================================================
// UI SYSTEM
// =====================================================
const UISystem = {
    currentView: 'dashboard',

    showPage(page) {
        const pages = ['landing-page', 'login-page', 'register-page', 'app-container'];
        pages.forEach(p => document.getElementById(p).classList.add('hidden'));

        switch(page) {
            case 'landing':
                document.getElementById('landing-page').classList.remove('hidden');
                break;
            case 'login':
                document.getElementById('login-page').classList.remove('hidden');
                break;
            case 'register':
                document.getElementById('register-page').classList.remove('hidden');
                break;
            case 'app':
                document.getElementById('app-container').classList.remove('hidden');
                this.switchView('dashboard');
                CurriculumSystem.init();
                break;
        }
    },

    switchView(viewId) {
        this.currentView = viewId;
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active', 'bg-blue-600/20'));
        event?.currentTarget?.classList.add('active', 'bg-blue-600/20');

        // Close mobile sidebar
        document.getElementById('sidebar').classList.remove('open');

        const titles = {
            dashboard: 'Dashboard',
            profil: 'Profil Guru',
            sekolah: 'Profil Sekolah',
            kurikulum: 'Kurikulum & Mapel',
            kalender: 'Kalender & Libur',
            banksoal: 'Bank Soal',
            generate: 'Generate Dokumen',
            subscription: 'Subscription',
            superadmin: 'Super Admin Panel'
        };
        document.getElementById('page-title').textContent = titles[viewId] || 'Dashboard';

        const content = document.getElementById('main-content');
        content.innerHTML = this.getViewHTML(viewId);
        this.initView(viewId);
    },

    getViewHTML(viewId) {
        switch(viewId) {
            case 'dashboard': return this.getDashboardHTML();
            case 'profil': return this.getProfilHTML();
            case 'sekolah': return this.getSekolahHTML();
            case 'kurikulum': return this.getKurikulumHTML();
            case 'kalender': return this.getKalenderHTML();
            case 'banksoal': return this.getBankSoalHTML();
            case 'generate': return this.getGenerateHTML();
            case 'subscription': return this.getSubscriptionHTML();
            case 'superadmin': return this.getSuperAdminHTML();
            default: return '<p>View not found</p>';
        }
    },

    initView(viewId) {
        switch(viewId) {
            case 'dashboard': DashboardSystem.init(); break;
            case 'profil': ProfileSystem.loadProfile(); break;
            case 'sekolah': SchoolSystem.loadSchool(); break;
            case 'kurikulum': CurriculumSystem.initDropdowns(); break;
            case 'kalender': CalendarSystem.init(); break;
            case 'banksoal': BankSoalSystem.init(); break;
            case 'generate': DocumentEngine.init(); break;
            case 'subscription': break;
            case 'superadmin': SuperAdminSystem.init(); break;
        }
    },

    // View Templates
    getDashboardHTML() {
        return `
        <div class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 card-hover">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-2xl">ğŸ“š</div>
                        <span class="text-green-500 text-sm font-medium">+12%</span>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-900" id="stat-dokumen">0</h3>
                    <p class="text-slate-500 text-sm">Dokumen Dibuat</p>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 card-hover">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-2xl">ğŸ‘¨â€ğŸ“</div>
                        <span class="text-green-500 text-sm font-medium">Active</span>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-900" id="stat-siswa">0</h3>
                    <p class="text-slate-500 text-sm">Total Siswa</p>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 card-hover">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center text-2xl">â“</div>
                        <span class="text-amber-500 text-sm font-medium">Bank</span>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-900" id="stat-soal">0</h3>
                    <p class="text-slate-500 text-sm">Soal Tersimpan</p>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 card-hover">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center text-2xl">ğŸ‘¥</div>
                        <span class="text-blue-500 text-sm font-medium">NPSN</span>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-900" id="stat-guru">0</h3>
                    <p class="text-slate-500 text-sm">Guru di Sekolah</p>
                </div>
            </div>

            <div class="grid lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <h3 class="font-bold text-lg text-slate-900 mb-4">ğŸ“… Agenda Mendatang</h3>
                    <div id="dashboard-agenda" class="space-y-3">
                        <p class="text-slate-500 text-sm">Memuat agenda...</p>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <h3 class="font-bold text-lg text-slate-900 mb-4">ğŸš€ Quick Actions</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="UISystem.switchView('generate')" class="p-4 bg-blue-50 hover:bg-blue-100 rounded-xl text-left transition">
                            <span class="text-2xl mb-2 block">ğŸ“„</span>
                            <span class="font-medium text-slate-700">Generate ATP</span>
                        </button>
                        <button onclick="UISystem.switchView('kalender')" class="p-4 bg-green-50 hover:bg-green-100 rounded-xl text-left transition">
                            <span class="text-2xl mb-2 block">ğŸ“…</span>
                            <span class="font-medium text-slate-700">Atur Kalender</span>
                        </button>
                        <button onclick="document.getElementById('student-modal').style.display='flex'" class="p-4 bg-purple-50 hover:bg-purple-100 rounded-xl text-left transition">
                            <span class="text-2xl mb-2 block">ğŸ‘¨â€ğŸ“</span>
                            <span class="font-medium text-slate-700">Input Siswa</span>
                        </button>
                        <button onclick="UISystem.switchView('banksoal')" class="p-4 bg-amber-50 hover:bg-amber-100 rounded-xl text-left transition">
                            <span class="text-2xl mb-2 block">â“</span>
                            <span class="font-medium text-slate-700">Buat Soal</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <h3 class="font-bold text-lg text-slate-900 mb-4">ğŸ‘¥ Guru di Sekolah Anda</h3>
                <div id="dashboard-teachers" class="space-y-2">
                    <p class="text-slate-500 text-sm">Memuat data guru...</p>
                </div>
            </div>
        </div>`;
    },

    getProfilHTML() {
        return `
        <div class="max-w-2xl mx-auto">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-20 h-20 gradient-primary rounded-full flex items-center justify-center text-3xl text-white font-bold" id="profile-avatar">U</div>
                    <div>
                        <h2 class="text-xl font-bold text-slate-900" id="profile-name">Nama Guru</h2>
                        <p class="text-slate-500" id="profile-email">email@contoh.com</p>
                    </div>
                </div>
                <form id="profile-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Nama Lengkap</label>
                        <input type="text" id="profil-nama" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">NIP</label>
                        <input type="text" id="profil-nip" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Tipe Guru</label>
                        <select id="profil-tipe" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="mapel">Guru Mata Pelajaran</option>
                            <option value="kelas">Guru Kelas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">NPSN Sekolah</label>
                        <input type="text" id="profil-npsn" class="w-full px-4 py-3 border border-slate-300 rounded-xl bg-slate-100" readonly>
                    </div>
                    <button type="submit" class="w-full py-3 gradient-primary text-white font-bold rounded-xl">Simpan Profil</button>
                </form>
            </div>
        </div>`;
    },

    getSekolahHTML() {
        return `
        <div class="max-w-2xl mx-auto">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center text-3xl">ğŸ«</div>
                    <div>
                        <h2 class="text-xl font-bold text-slate-900">Profil Sekolah</h2>
                        <p class="text-slate-500">NPSN: <span id="school-npsn-display">-</span></p>
                    </div>
                </div>
                <form id="school-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Nama Sekolah</label>
                        <input type="text" id="school-nama" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">NPSN</label>
                        <input type="text" id="school-npsn" class="w-full px-4 py-3 border border-slate-300 rounded-xl bg-slate-100" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Alamat</label>
                        <textarea id="school-alamat" rows="3" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Nama Kepala Sekolah</label>
                        <input type="text" id="school-kepsek" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">NIP Kepala Sekolah</label>
                        <input type="text" id="school-nip-kepsek" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none">
                    </div>
                    <button type="submit" class="w-full py-3 gradient-secondary text-white font-bold rounded-xl">Simpan Data Sekolah</button>
                </form>
            </div>
        </div>`;
    },

    getKurikulumHTML() {
        return `
        <div class="space-y-6">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <h3 class="font-bold text-lg text-slate-900 mb-4">ğŸ“– Database Kurikulum</h3>
                <div class="grid md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Jenjang</label>
                        <select id="cur-jenjang" onchange="CurriculumSystem.fetchCP()" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="SD">SD / MI</option>
                            <option value="SMP">SMP / MTs</option>
                            <option value="SMA">SMA / SMK / MA</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 flex items-end gap-2">
                        <button onclick="CurriculumSystem.fetchCP()" class="flex-1 py-3 gradient-primary text-white font-bold rounded-xl">
                            ğŸ”„ Load dari Cloud
                        </button>
                        <div class="relative flex-1">
                            <input type="file" accept=".csv" onchange="CurriculumSystem.uploadCSV(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            <button class="w-full py-3 border-2 border-slate-300 text-slate-700 font-bold rounded-xl hover:border-blue-500">
                                ğŸ“¤ Upload CSV
                            </button>
                        </div>
                    </div>
                </div>
                <div id="cp-status" class="p-3 rounded-xl text-sm hidden"></div>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <h3 class="font-bold text-lg text-slate-900 mb-4">ğŸ“š Pilih Mapel & Kelas</h3>
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Mata Pelajaran</label>
                        <select id="cur-mapel" onchange="CurriculumSystem.updateKelas()" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">-- Pilih Mapel --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Kelas</label>
                        <select id="cur-kelas" onchange="CurriculumSystem.updateSemester()" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">-- Pilih Kelas --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Semester</label>
                        <select id="cur-semester" onchange="CurriculumSystem.updateElemen()" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">-- Pilih Semester --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Elemen/Bab</label>
                        <select id="cur-elemen" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">-- Pilih Elemen --</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <h3 class="font-bold text-lg text-slate-900 mb-4">ğŸ“‹ Preview CP & TP</h3>
                <div id="cp-preview" class="text-slate-600">
                    <p class="italic">Pilih mapel dan kelas untuk melihat CP & TP</p>
                </div>
            </div>
        </div>`;
    },

    getKalenderHTML() {
        return `
        <div class="space-y-6">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <h3 class="font-bold text-lg text-slate-900 mb-4">ğŸ“… Pengaturan Kalender</h3>
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Tahun Pelajaran Awal</label>
                        <input type="number" id="cal-tahun" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" value="${new Date().getFullYear()}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Hari Mengajar</label>
                        <select id="cal-hari" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="1">Senin</option>
                            <option value="2">Selasa</option>
                            <option value="3">Rabu</option>
                            <option value="4">Kamis</option>
                            <option value="5">Jum'at</option>
                            <option value="6">Sabtu</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">JP/Pertemuan</label>
                        <input type="number" id="cal-jp" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" value="4">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Rombel</label>
                        <input type="text" id="cal-rombel" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" value="A">
                    </div>
                </div>

                <h4 class="font-medium text-slate-700 mb-2">ğŸ“Œ Titik Penetapan Semester</h4>
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">Awal Masuk (Juli)</label>
                        <input type="date" id="cal-masuk-ganjil" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">Rapor Ganjil (Des)</label>
                        <input type="date" id="cal-rapor-ganjil" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">Awal Masuk (Jan)</label>
                        <input type="date" id="cal-masuk-genap" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">Rapor Genap (Jun)</label>
                        <input type="date" id="cal-rapor-genap" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <h3 class="font-bold text-lg text-slate-900 mb-4">ğŸ–ï¸ Agenda & Hari Libur Kustom</h3>
                <p class="text-sm text-slate-500 mb-2">Format: YYYY-MM-DD = Nama Kegiatan (1 baris = 1 kegiatan)</p>
                <textarea id="cal-libur" rows="10" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm"></textarea>
                <button onclick="CalendarSystem.save()" class="mt-4 px-6 py-3 gradient-primary text-white font-bold rounded-xl">
                    ğŸ’¾ Simpan Kalender
                </button>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <h3 class="font-bold text-lg text-slate-900 mb-4">ğŸ“† Preview Kalender</h3>
                <div id="cal-preview" class="overflow-x-auto">
                    <p class="text-slate-500 italic">Kalender akan muncul di sini...</p>
                </div>
            </div>
        </div>`;
    },

    getBankSoalHTML() {
        return `
        <div class="space-y-6">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                    <h3 class="font-bold text-lg text-slate-900">â“ Bank Soal</h3>
                    <button onclick="BankSoalSystem.showAddModal()" class="px-4 py-2 gradient-primary text-white font-bold rounded-xl">
                        + Tambah Soal Baru
                    </button>
                </div>

                <div class="grid md:grid-cols-4 gap-4 mb-4">
                    <select id="bs-mapel" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
                        <option value="">Semua Mapel</option>
                    </select>
                    <select id="bs-kelas" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
                        <option value="">Semua Kelas</option>
                    </select>
                    <select id="bs-tipe" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
                        <option value="">Semua Tipe</option>
                        <option value="pg">Pilihan Ganda</option>
                        <option value="bs">Benar/Salah</option>
                        <option value="jodoh">Menjodohkan</option>
                        <option value="isian">Isian Singkat</option>
                        <option value="essay">Essay</option>
                    </select>
                    <button onclick="BankSoalSystem.filter()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg font-medium">
                        ğŸ” Filter
                    </button>
                </div>

                <div id="bs-list" class="space-y-3">
                    <p class="text-slate-500 italic text-center py-8">Belum ada soal tersimpan</p>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <h3 class="font-bold text-lg text-slate-900 mb-4">ğŸ² Generate Paket Soal</h3>
                <div class="grid md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Jumlah Soal PG</label>
                        <input type="number" id="gen-pg" value="10" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Jumlah Soal Essay</label>
                        <input type="number" id="gen-essay" value="5" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Acak Soal</label>
                        <select id="gen-random" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                            <option value="1">Ya, Acak</option>
                            <option value="0">Tidak</option>
                        </select>
                    </div>
                </div>
                <button onclick="BankSoalSystem.generatePaket()" class="px-6 py-3 gradient-secondary text-white font-bold rounded-xl">
                    ğŸ¯ Generate Paket
                </button>
            </div>
        </div>`;
    },

    getGenerateHTML() {
        return `
        <div class="space-y-6">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <h3 class="font-bold text-lg text-slate-900 mb-4">ğŸ“„ Pilih Dokumen</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button onclick="DocumentEngine.generate('atp')" class="p-4 border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 rounded-xl text-center transition">
                        <span class="text-2xl block mb-2">ğŸ“‹</span>
                        <span class="font-medium text-sm">ATP</span>
                        <span class="block text-xs text-green-600 mt-1">GRATIS</span>
                    </button>
                    <button onclick="DocumentEngine.generate('prota')" class="p-4 border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 rounded-xl text-center transition">
                        <span class="text-2xl block mb-2">ğŸ“Š</span>
                        <span class="font-medium text-sm">Prota</span>
                        <span class="block text-xs text-green-600 mt-1">GRATIS</span>
                    </button>
                    <button onclick="DocumentEngine.generate('promes')" class="p-4 border-2 border-slate-200 hover:border-amber-500 hover:bg-amber-50 rounded-xl text-center transition">
                        <span class="text-2xl block mb-2">ğŸ“…</span>
                        <span class="font-medium text-sm">Promes</span>
                        <span class="block text-xs text-amber-600 mt-1">PRO</span>
                    </button>
                    <button onclick="DocumentEngine.generate('modul')" class="p-4 border-2 border-slate-200 hover:border-amber-500 hover:bg-amber-50 rounded-xl text-center transition">
                        <span class="text-2xl block mb-2">ğŸ“š</span>
                        <span class="font-medium text-sm">Modul Ajar</span>
                        <span class="block text-xs text-amber-600 mt-1">PRO</span>
                    </button>
                    <button onclick="DocumentEngine.generate('lkpd')" class="p-4 border-2 border-slate-200 hover:border-amber-500 hover:bg-amber-50 rounded-xl text-center transition">
                        <span class="text-2xl block mb-2">ğŸ“</span>
                        <span class="font-medium text-sm">LKPD</span>
                        <span class="block text-xs text-amber-600 mt-1">PRO</span>
                    </button>
                    <button onclick="DocumentEngine.generate('jurnal')" class="p-4 border-2 border-slate-200 hover:border-amber-500 hover:bg-amber-50 rounded-xl text-center transition">
                        <span class="text-2xl block mb-2">ğŸ““</span>
                        <span class="font-medium text-sm">Jurnal</span>
                        <span class="block text-xs text-amber-600 mt-1">PRO</span>
                    </button>
                    <button onclick="DocumentEngine.generate('absensi')" class="p-4 border-2 border-slate-200 hover:border-amber-500 hover:bg-amber-50 rounded-xl text-center transition">
                        <span class="text-2xl block mb-2">âœ…</span>
                        <span class="font-medium text-sm">Absensi</span>
                        <span class="block text-xs text-amber-600 mt-1">PRO</span>
                    </button>
                    <button onclick="DocumentEngine.generate('kktp')" class="p-4 border-2 border-slate-200 hover:border-amber-500 hover:bg-amber-50 rounded-xl text-center transition">
                        <span class="text-2xl block mb-2">ğŸ¯</span>
                        <span class="font-medium text-sm">KKTP & Nilai</span>
                        <span class="block text-xs text-amber-600 mt-1">PRO</span>
                    </button>
                </div>
            </div>

            <div id="doc-preview-container" class="hidden">
                <div class="flex justify-between items-center mb-4 no-print">
                    <h3 class="font-bold text-lg text-slate-900">Preview Dokumen</h3>
                    <div class="flex gap-2">
                        <button onclick="window.print()" class="px-4 py-2 gradient-primary text-white font-bold rounded-lg">ğŸ–¨ï¸ Cetak PDF</button>
                        <button onclick="document.getElementById('doc-preview-container').classList.add('hidden')" class="px-4 py-2 bg-slate-200 text-slate-700 font-bold rounded-lg">âœ• Tutup</button>
                    </div>
                </div>
                <div id="doc-preview"></div>
            </div>
        </div>`;
    },

    getSubscriptionHTML() {
        const isPremium = SubscriptionSystem.isPremium();
        return `
        <div class="max-w-2xl mx-auto space-y-6">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 text-center">
                <div class="w-20 h-20 ${isPremium ? 'gradient-primary' : 'bg-slate-200'} rounded-full flex items-center justify-center text-4xl mx-auto mb-4">
                    ${isPremium ? 'ğŸ‘‘' : 'ğŸ”’'}
                </div>
                <h2 class="text-2xl font-bold text-slate-900 mb-2">Status: ${isPremium ? 'PRO' : 'GRATIS'}</h2>
                <p class="text-slate-600 mb-6">${isPremium ? 'Anda memiliki akses ke semua fitur premium!' : 'Upgrade ke PRO untuk akses fitur lengkap'}</p>
                
                ${!isPremium ? `
                <button onclick="SubscriptionSystem.showUpgradeModal()" class="px-8 py-3 gradient-primary text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition">
                    ğŸš€ Upgrade ke PRO
                </button>
                ` : `
                <div class="p-4 bg-green-50 rounded-xl text-green-700">
                    âœ… Semua fitur PRO sudah aktif
                </div>
                `}
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <h3 class="font-bold text-lg text-slate-900 mb-4">Perbandingan Fitur</h3>
                <div class="space-y-3">
                    ${FREE_FEATURES.map(f => `
                    <div class="flex justify-between items-center py-2 border-b border-slate-100">
                        <span class="capitalize">${f}</span>
                        <span class="text-green-500 font-bold">âœ“ Gratis</span>
                    </div>
                    `).join('')}
                    ${PRO_FEATURES.map(f => `
                    <div class="flex justify-between items-center py-2 border-b border-slate-100">
                        <span class="capitalize">${f}</span>
                        <span class="${isPremium ? 'text-green-500' : 'text-amber-500'} font-bold">${isPremium ? 'âœ“ Aktif' : 'ğŸ”’ PRO'}</span>
                    </div>
                    `).join('')}
                </div>
            </div>
        </div>`;
    },

    getSuperAdminHTML() {
        if (AuthSystem.userData?.role !== 'super_admin') {
            return `<div class="text-center py-20"><p class="text-red-500">â›” Akses Ditolak</p></div>`;
        }
        return `
        <div class="space-y-6">
            <div class="grid md:grid-cols-4 gap-4">
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <h3 class="text-3xl font-bold text-blue-600" id="sa-total-users">0</h3>
                    <p class="text-slate-500">Total Users</p>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <h3 class="text-3xl font-bold text-green-600" id="sa-total-schools">0</h3>
                    <p class="text-slate-500">Total Sekolah</p>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <h3 class="text-3xl font-bold text-amber-600" id="sa-total-premium">0</h3>
                    <p class="text-slate-500">Premium Users</p>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <h3 class="text-3xl font-bold text-purple-600" id="sa-total-soal">0</h3>
                    <p class="text-slate-500">Total Soal</p>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <h3 class="font-bold text-lg text-slate-900 mb-4">âš™ï¸ Pengaturan Subscription</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Nomor WhatsApp Upgrade</label>
                        <input type="text" id="sa-wa" class="w-full px-4 py-3 border border-slate-300 rounded-xl" placeholder="628xxx">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">NPSN Premium (pisah koma)</label>
                        <input type="text" id="sa-premium-npsn" class="w-full px-4 py-3 border border-slate-300 rounded-xl" placeholder="20234567,20234568">
                    </div>
                </div>
                <button onclick="SuperAdminSystem.saveSettings()" class="mt-4 px-6 py-3 gradient-primary text-white font-bold rounded-xl">
                    ğŸ’¾ Simpan Pengaturan
                </button>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <h3 class="font-bold text-lg text-slate-900 mb-4">ğŸ‘¥ Daftar Users</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-2">Nama</th>
                                <th class="text-left py-3 px-2">Email</th>
                                <th class="text-left py-3 px-2">NPSN</th>
                                <th class="text-left py-3 px-2">Role</th>
                                <th class="text-left py-3 px-2">Premium</th>
                                <th class="text-left py-3 px-2">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="sa-users-list"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <h3 class="font-bold text-lg text-slate-900 mb-4">ğŸ« Daftar Sekolah</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-2">NPSN</th>
                                <th class="text-left py-3 px-2">Nama Sekolah</th>
                                <th class="text-left py-3 px-2">Jumlah Guru</th>
                                <th class="text-left py-3 px-2">Premium</th>
                                <th class="text-left py-3 px-2">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="sa-schools-list"></tbody>
                    </table>
                </div>
            </div>
        </div>`;
    }
};

// =====================================================
// DASHBOARD SYSTEM
// =====================================================
const DashboardSystem = {
    async init() {
        await this.loadStats();
        await this.loadTeachers();
        this.loadAgenda();
    },

    async loadStats() {
        const students = JSON.parse(localStorage.getItem('agsa_students') || '[]');
        document.getElementById('stat-siswa').textContent = students.length;

        try {
            // Count teachers in same school
            if (AuthSystem.userData?.npsn) {
                const teachersSnap = await db.collection('users').where('npsn', '==', AuthSystem.userData.npsn).get();
                document.getElementById('stat-guru').textContent = teachersSnap.size;
            }

            // Count soal
            const soalSnap = await db.collection('banksoal').where('userId', '==', AuthSystem.currentUser?.uid).get();
            document.getElementById('stat-soal').textContent = soalSnap.size;
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    },

    async loadTeachers() {
        const container = document.getElementById('dashboard-teachers');
        if (!AuthSystem.userData?.npsn) {
            container.innerHTML = '<p class="text-slate-500">NPSN belum diatur</p>';
            return;
        }

        try {
            const snap = await db.collection('users').where('npsn', '==', AuthSystem.userData.npsn).get();
            if (snap.empty) {
                container.innerHTML = '<p class="text-slate-500">Belum ada guru lain di sekolah ini</p>';
                return;
            }

            let html = '';
            snap.forEach(doc => {
                const d = doc.data();
                html += `
                <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold">${d.nama?.charAt(0) || 'U'}</div>
                    <div class="flex-1">
                        <p class="font-medium text-slate-900">${d.nama || 'Guru'}</p>
                        <p class="text-sm text-slate-500">${d.email}</p>
                    </div>
                    <span class="px-2 py-1 ${d.role === 'admin_sekolah' ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-600'} rounded text-xs font-medium capitalize">${d.role || 'guru'}</span>
                </div>`;
            });
            container.innerHTML = html;
        } catch (error) {
            container.innerHTML = '<p class="text-red-500">Error memuat data</p>';
        }
    },

    loadAgenda() {
        const container = document.getElementById('dashboard-agenda');
        const events = CalendarSystem.getUpcomingEvents(5);
        
        if (events.length === 0) {
            container.innerHTML = '<p class="text-slate-500 italic">Tidak ada agenda mendatang</p>';
            return;
        }

        let html = '';
        events.forEach(ev => {
            const isLibur = ev.nama.toLowerCase().includes('libur');
            html += `
            <div class="flex items-center gap-3 p-3 ${isLibur ? 'bg-red-50' : 'bg-blue-50'} rounded-lg">
                <div class="w-12 h-12 ${isLibur ? 'bg-red-100' : 'bg-blue-100'} rounded-xl flex items-center justify-center">
                    <span class="text-lg">${isLibur ? 'ğŸ–ï¸' : 'ğŸ“…'}</span>
                </div>
                <div>
                    <p class="font-medium ${isLibur ? 'text-red-700' : 'text-slate-900'}">${ev.nama}</p>
                    <p class="text-sm text-slate-500">${Utils.formatDate(ev.tanggal)}</p>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }
};

// =====================================================
// PROFILE SYSTEM
// =====================================================
const ProfileSystem = {
    loadProfile() {
        if (!AuthSystem.userData) return;

        const d = AuthSystem.userData;
        document.getElementById('profile-avatar').textContent = d.nama?.charAt(0) || 'U';
        document.getElementById('profile-name').textContent = d.nama || 'Nama Guru';
        document.getElementById('profile-email').textContent = d.email;
        document.getElementById('profil-nama').value = d.nama || '';
        document.getElementById('profil-nip').value = d.nip || '';
        document.getElementById('profil-tipe').value = d.tipeGuru || 'mapel';
        document.getElementById('profil-npsn').value = d.npsn || '';

        document.getElementById('profile-form').onsubmit = (e) => {
            e.preventDefault();
            this.saveProfile();
        };

        // Load students
        const students = JSON.parse(localStorage.getItem('agsa_students') || '[]');
        document.getElementById('student-input').value = students.join('\n');
    },

    async saveProfile() {
        const data = {
            nama: document.getElementById('profil-nama').value,
            nip: document.getElementById('profil-nip').value,
            tipeGuru: document.getElementById('profil-tipe').value
        };

        try {
            await db.collection('users').doc(AuthSystem.currentUser.uid).update(data);
            AuthSystem.userData = { ...AuthSystem.userData, ...data };
            AuthSystem.updateUI();
            Utils.toast('Profil berhasil disimpan!', 'success');
        } catch (error) {
            Utils.toast('Gagal menyimpan profil', 'error');
        }
    },

    saveStudents() {
        const input = document.getElementById('student-input').value;
        const students = input.split('\n')
            .map(s => s.replace(/^[0-9]+[\.\)\-]\s*/, '').trim())
            .filter(s => s.length > 0);
        
        localStorage.setItem('agsa_students', JSON.stringify(students));
        document.getElementById('student-modal').style.display = 'none';
        Utils.toast(`${students.length} siswa berhasil disimpan!`, 'success');
    }
};

// =====================================================
// SCHOOL SYSTEM
// =====================================================
const SchoolSystem = {
    schoolData: null,

    async loadSchool() {
        if (!AuthSystem.userData?.npsn) return;

        document.getElementById('school-npsn').value = AuthSystem.userData.npsn;
        document.getElementById('school-npsn-display').textContent = AuthSystem.userData.npsn;

        try {
            const doc = await db.collection('schools').doc(AuthSystem.userData.npsn).get();
            if (doc.exists) {
                this.schoolData = doc.data();
                document.getElementById('school-nama').value = this.schoolData.namaSekolah || '';
                document.getElementById('school-alamat').value = this.schoolData.alamat || '';
                document.getElementById('school-kepsek').value = this.schoolData.kepsek || '';
                document.getElementById('school-nip-kepsek').value = this.schoolData.nipKepsek || '';
            }
        } catch (error) {
            console.error('Error loading school:', error);
        }

        document.getElementById('school-form').onsubmit = (e) => {
            e.preventDefault();
            this.saveSchool();
        };
    },

    async saveSchool() {
        const data = {
            namaSekolah: document.getElementById('school-nama').value,
            alamat: document.getElementById('school-alamat').value,
            kepsek: document.getElementById('school-kepsek').value,
            nipKepsek: document.getElementById('school-nip-kepsek').value
        };

        try {
            await db.collection('schools').doc(AuthSystem.userData.npsn).update(data);
            this.schoolData = { ...this.schoolData, ...data };
            Utils.toast('Data sekolah berhasil disimpan!', 'success');
        } catch (error) {
            Utils.toast('Gagal menyimpan data sekolah', 'error');
        }
    }
};

// =====================================================
// CURRICULUM SYSTEM
// =====================================================
const CurriculumSystem = {
    data: {},
    faseMap: {},
    cached: false,

    init() {
        // Load from cache first
        const cache = localStorage.getItem('agsa_cp_cache');
        if (cache) {
            try {
                const parsed = JSON.parse(cache);
                this.data = parsed.data;
                this.faseMap = parsed.faseMap;
                this.cached = true;
                this.initDropdowns();
            } catch (e) {}
        }
    },

    async fetchCP() {
        const jenjang = document.getElementById('cur-jenjang')?.value || 'SD';
        const url = CP_LINKS[jenjang];
        const statusEl = document.getElementById('cp-status');
        
        if (statusEl) {
            statusEl.classList.remove('hidden', 'bg-red-100', 'text-red-700');
            statusEl.classList.add('bg-blue-100', 'text-blue-700');
            statusEl.textContent = 'â³ Mengunduh data kurikulum...';
        }

        try {
            let response = await fetch(url);
            if (!response.ok) throw new Error('Fetch failed');
            this.parseCSV(await response.text());
            
            if (statusEl) {
                statusEl.classList.remove('bg-blue-100', 'text-blue-700');
                statusEl.classList.add('bg-green-100', 'text-green-700');
                statusEl.textContent = 'âœ… Data berhasil dimuat!';
            }
        } catch (error) {
            try {
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                this.parseCSV(await response.text());
                
                if (statusEl) {
                    statusEl.classList.remove('bg-blue-100', 'text-blue-700');
                    statusEl.classList.add('bg-green-100', 'text-green-700');
                    statusEl.textContent = 'âœ… Data berhasil dimuat (via proxy)!';
                }
            } catch (e) {
                if (statusEl) {
                    statusEl.classList.remove('bg-blue-100', 'text-blue-700');
                    statusEl.classList.add('bg-red-100', 'text-red-700');
                    statusEl.textContent = 'âŒ Gagal memuat. Silakan upload CSV manual.';
                }
            }
        }
    },

    uploadCSV(input) {
        const file = input.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            this.parseCSV(e.target.result);
            input.value = '';
            Utils.toast('CSV berhasil diupload!', 'success');
        };
        reader.readAsText(file);
    },

    parseCSV(csvText) {
        const lines = csvText.split('\n');
        this.data = {};
        this.faseMap = {};
        let count = 0;

        for (let i = 1; i < lines.length; i++) {
            let row = lines[i].trim();
            if (!row) continue;

            let cols = [];
            const regex = /("([^"]*)"|[^",]+)(?=,|$)/g;
            let match;
            while (match = regex.exec(row)) {
                cols.push(match[2] !== undefined ? match[2] : match[1]);
            }

            if (cols.length < 5) continue;

            const [mapel, fase, kelas, semester, elemen, cp, tp] = cols.map(c => (c || '').trim());
            
            if (fase && kelas) this.faseMap[kelas] = fase;
            
            if (!this.data[mapel]) this.data[mapel] = {};
            if (!this.data[mapel][kelas]) this.data[mapel][kelas] = {};
            if (!this.data[mapel][kelas][semester]) this.data[mapel][kelas][semester] = {};
            if (!this.data[mapel][kelas][semester][elemen]) {
                this.data[mapel][kelas][semester][elemen] = { cp: cp, tps: [] };
            }
            this.data[mapel][kelas][semester][elemen].tps.push({ tp: tp || cp });
            count++;
        }

        // Cache the data
        localStorage.setItem('agsa_cp_cache', JSON.stringify({
            data: this.data,
            faseMap: this.faseMap
        }));
        this.cached = true;
        this.initDropdowns();
        
        console.log(`Parsed ${count} TP entries`);
    },

    initDropdowns() {
        const mapelSel = document.getElementById('cur-mapel');
        if (!mapelSel) return;
        
        mapelSel.innerHTML = '<option value="">-- Pilih Mapel --</option>';
        Object.keys(this.data).sort().forEach(m => {
            mapelSel.appendChild(new Option(m, m));
        });
    },

    updateKelas() {
        const mapel = document.getElementById('cur-mapel')?.value;
        const kelasSel = document.getElementById('cur-kelas');
        if (!kelasSel) return;
        
        kelasSel.innerHTML = '<option value="">-- Pilih Kelas --</option>';
        
        if (mapel && this.data[mapel]) {
            Object.keys(this.data[mapel]).sort((a, b) => {
                const nA = parseInt(a.replace(/\D/g, ''));
                const nB = parseInt(b.replace(/\D/g, ''));
                return nA - nB;
            }).forEach(k => {
                const fase = this.faseMap[k] || '';
                kelasSel.appendChild(new Option(`Kelas ${k} (${fase})`, k));
            });
        }
        this.updateSemester();
    },

    updateSemester() {
        const mapel = document.getElementById('cur-mapel')?.value;
        const kelas = document.getElementById('cur-kelas')?.value;
        const semSel = document.getElementById('cur-semester');
        if (!semSel) return;
        
        semSel.innerHTML = '<option value="">-- Pilih Semester --</option>';
        
        if (mapel && kelas && this.data[mapel]?.[kelas]) {
            Object.keys(this.data[mapel][kelas]).forEach(s => {
                semSel.appendChild(new Option(s, s));
            });
        }
        this.updateElemen();
    },

    updateElemen() {
        const mapel = document.getElementById('cur-mapel')?.value;
        const kelas = document.getElementById('cur-kelas')?.value;
        const semester = document.getElementById('cur-semester')?.value;
        const elSel = document.getElementById('cur-elemen');
        if (!elSel) return;
        
        elSel.innerHTML = '<option value="">-- Pilih Elemen --</option>';
        
        if (mapel && kelas && semester && this.data[mapel]?.[kelas]?.[semester]) {
            Object.keys(this.data[mapel][kelas][semester]).forEach(e => {
                elSel.appendChild(new Option(e, e));
            });
        }
        this.showPreview();
    },

    showPreview() {
        const preview = document.getElementById('cp-preview');
        if (!preview) return;

        const mapel = document.getElementById('cur-mapel')?.value;
        const kelas = document.getElementById('cur-kelas')?.value;
        const semester = document.getElementById('cur-semester')?.value;
        const elemen = document.getElementById('cur-elemen')?.value;

        if (!mapel || !kelas || !semester) {
            preview.innerHTML = '<p class="italic text-slate-500">Pilih mapel dan kelas untuk melihat CP & TP</p>';
            return;
        }

        let html = '';
        const semData = this.data[mapel]?.[kelas]?.[semester];
        
        if (semData) {
            const elemenList = elemen ? { [elemen]: semData[elemen] } : semData;
            
            for (const [el, data] of Object.entries(elemenList)) {
                if (!data) continue;
                html += `
                <div class="mb-6 p-4 bg-slate-50 rounded-xl">
                    <h4 class="font-bold text-blue-700 mb-2">${el}</h4>
                    <p class="text-sm text-slate-600 mb-3 bg-white p-2 rounded">${data.cp}</p>
                    <div class="space-y-1">
                        ${data.tps.map((t, i) => `
                        <div class="flex gap-2 text-sm">
                            <span class="font-medium text-slate-500">${i + 1}.</span>
                            <span>${t.tp}</span>
                        </div>
                        `).join('')}
                    </div>
                </div>`;
            }
        }

        preview.innerHTML = html || '<p class="italic text-slate-500">Data tidak ditemukan</p>';
    },

    getCurrentSelection() {
        return {
            mapel: document.getElementById('cur-mapel')?.value || '',
            kelas: document.getElementById('cur-kelas')?.value || '',
            semester: document.getElementById('cur-semester')?.value || '',
            elemen: document.getElementById('cur-elemen')?.value || '',
            fase: this.faseMap[document.getElementById('cur-kelas')?.value] || ''
        };
    },

    getDataForSelection(mapel, kelas, semester, elemen) {
        if (elemen) {
            return this.data[mapel]?.[kelas]?.[semester]?.[elemen];
        }
        return this.data[mapel]?.[kelas]?.[semester];
    }
};

// =====================================================
// CALENDAR SYSTEM
// =====================================================
const CalendarSystem = {
    events: {},
    eventList: [],

    init() {
        const year = new Date().getFullYear();
        const el = (id) => document.getElementById(id);
        
        if (el('cal-tahun')) el('cal-tahun').value = year;
        if (el('cal-masuk-ganjil')) el('cal-masuk-ganjil').value = `${year}-07-15`;
        if (el('cal-rapor-ganjil')) el('cal-rapor-ganjil').value = `${year}-12-20`;
        if (el('cal-masuk-genap')) el('cal-masuk-genap').value = `${year + 1}-01-06`;
        if (el('cal-rapor-genap')) el('cal-rapor-genap').value = `${year + 1}-06-20`;

        // Load saved events
        const saved = localStorage.getItem('agsa_calendar');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                if (data.libur && el('cal-libur')) el('cal-libur').value = data.libur;
                if (data.tahun && el('cal-tahun')) el('cal-tahun').value = data.tahun;
                if (data.hari && el('cal-hari')) el('cal-hari').value = data.hari;
                if (data.jp && el('cal-jp')) el('cal-jp').value = data.jp;
            } catch (e) {}
        } else {
            // Default holidays
            if (el('cal-libur')) {
                el('cal-libur').value = this.getDefaultHolidays(year);
            }
        }

        this.generateEvents();
        this.renderPreview();
    },

    getDefaultHolidays(year) {
        return `${year}-08-17 = HUT Kemerdekaan RI
${year}-09-16 = Maulid Nabi Muhammad SAW
${year}-12-25 = Hari Raya Natal
${year + 1}-01-01 = Tahun Baru Masehi
${year + 1}-01-27 = Tahun Baru Imlek
${year + 1}-03-29 = Idul Fitri 1446 H
${year + 1}-03-30 = Idul Fitri 1446 H
${year + 1}-05-01 = Hari Buruh
${year + 1}-06-01 = Hari Lahir Pancasila
${year + 1}-06-06 = Idul Adha 1446 H`;
    },

    generateEvents() {
        this.events = {};
        this.eventList = [];

        const addEvent = (date, name) => {
            if (!date) return;
            this.events[date] = name;
            this.eventList.push({ tanggal: date, nama: name });
        };

        // Semester boundaries
        const boundaries = [
            { id: 'cal-masuk-ganjil', name: 'Awal Masuk Tahun Ajaran', month: 6 },
            { id: 'cal-rapor-ganjil', name: 'Pembagian Rapor Ganjil', month: 11 },
            { id: 'cal-masuk-genap', name: 'Awal Masuk Semester Genap', month: 0 },
            { id: 'cal-rapor-genap', name: 'Pembagian Rapor Genap', month: 5 }
        ];

        boundaries.forEach(b => {
            const val = document.getElementById(b.id)?.value;
            if (val) {
                addEvent(val, b.name);
                
                // Add holiday ranges
                const [y, m, d] = val.split('-').map(Number);
                if (b.id.includes('masuk')) {
                    // Before start = holiday
                    for (let i = 1; i < d; i++) {
                        const dt = `${y}-${String(m).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        addEvent(dt, 'Libur Semester');
                    }
                } else if (b.id.includes('rapor')) {
                    // After rapor = holiday
                    const lastDay = new Date(y, m, 0).getDate();
                    for (let i = d + 1; i <= lastDay; i++) {
                        const dt = `${y}-${String(m).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        addEvent(dt, 'Libur Semester');
                    }
                }
            }
        });

        // Custom holidays
        const liburText = document.getElementById('cal-libur')?.value || '';
        liburText.split('\n').forEach(line => {
            const parts = line.split('=');
            if (parts.length >= 2) {
                addEvent(parts[0].trim(), parts[1].trim());
            }
        });

        this.eventList.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));
    },

    renderPreview() {
        const preview = document.getElementById('cal-preview');
        if (!preview) return;

        this.generateEvents();
        const year = parseInt(document.getElementById('cal-tahun')?.value) || new Date().getFullYear();

        let html = '<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">';
        
        for (let m = 6; m <= 17; m++) {
            const month = m % 12;
            const yr = m < 12 ? year : year + 1;
            const daysInMonth = new Date(yr, month + 1, 0).getDate();
            const firstDay = new Date(yr, month, 1).getDay();

            html += `
            <div class="border border-slate-200 rounded-xl p-3">
                <h4 class="font-bold text-center text-slate-800 mb-2">${BULAN_IND[month]} ${yr}</h4>
                <div class="grid grid-cols-7 gap-1 text-center text-xs">
                    <div class="text-red-500 font-medium">Mg</div>
                    <div class="font-medium">Sn</div>
                    <div class="font-medium">Sl</div>
                    <div class="font-medium">Rb</div>
                    <div class="font-medium">Km</div>
                    <div class="font-medium">Jm</div>
                    <div class="text-green-600 font-medium">Sb</div>`;

            for (let i = 0; i < firstDay; i++) {
                html += '<div></div>';
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${yr}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const event = this.events[dateStr];
                const dayOfWeek = new Date(yr, month, d).getDay();
                
                let classes = 'p-1 rounded text-xs ';
                if (dayOfWeek === 0) classes += 'text-red-500 bg-red-50 ';
                else if (event) classes += 'bg-amber-100 text-amber-800 font-bold ';
                
                html += `<div class="${classes}" title="${event || ''}">${d}</div>`;
            }

            html += '</div></div>';
        }

        html += '</div>';

        // Event list
        html += `
        <div class="mt-6">
            <h4 class="font-bold text-slate-800 mb-3">ğŸ“‹ Daftar Kegiatan</h4>
            <div class="max-h-64 overflow-y-auto space-y-2">`;
        
        this.eventList.slice(0, 30).forEach(ev => {
            const isHoliday = ev.nama.toLowerCase().includes('libur');
            html += `
            <div class="flex items-center gap-3 p-2 ${isHoliday ? 'bg-red-50' : 'bg-blue-50'} rounded-lg text-sm">
                <span class="font-mono text-slate-600">${ev.tanggal}</span>
                <span class="${isHoliday ? 'text-red-700' : 'text-slate-800'}">${ev.nama}</span>
            </div>`;
        });

        html += '</div></div>';
        preview.innerHTML = html;
    },

    save() {
        const data = {
            tahun: document.getElementById('cal-tahun')?.value,
            hari: document.getElementById('cal-hari')?.value,
            jp: document.getElementById('cal-jp')?.value,
            rombel: document.getElementById('cal-rombel')?.value,
            libur: document.getElementById('cal-libur')?.value
        };
        localStorage.setItem('agsa_calendar', JSON.stringify(data));
        this.generateEvents();
        this.renderPreview();
        Utils.toast('Kalender berhasil disimpan!', 'success');
    },

    getUpcomingEvents(limit = 5) {
        this.generateEvents();
        const today = new Date().toISOString().split('T')[0];
        return this.eventList
            .filter(ev => ev.tanggal >= today && !ev.nama.includes('Libur Semester'))
            .slice(0, limit);
    },

    getSettings() {
        return {
            tahun: parseInt(document.getElementById('cal-tahun')?.value) || new Date().getFullYear(),
            hari: parseInt(document.getElementById('cal-hari')?.value) || 1,
            jp: parseInt(document.getElementById('cal-jp')?.value) || 4,
            rombel: document.getElementById('cal-rombel')?.value || 'A'
        };
    },

    isHoliday(dateStr) {
        return !!this.events[dateStr];
    },

    getEventName(dateStr) {
        return this.events[dateStr] || '';
    }
};

// =====================================================
// BANK SOAL SYSTEM
// =====================================================
const BankSoalSystem = {
    soalList: [],

    init() {
        if (!SubscriptionSystem.guard('banksoal')) return;
        this.loadSoal();
    },

    async loadSoal() {
        if (!AuthSystem.currentUser) return;

        try {
            const snap = await db.collection('banksoal')
                .where('userId', '==', AuthSystem.currentUser.uid)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();

            this.soalList = [];
            snap.forEach(doc => {
                this.soalList.push({ id: doc.id, ...doc.data() });
            });
            this.renderList();
        } catch (error) {
            console.error('Error loading soal:', error);
        }
    },

    renderList() {
        const container = document.getElementById('bs-list');
        if (!container) return;

        if (this.soalList.length === 0) {
            container.innerHTML = '<p class="text-slate-500 italic text-center py-8">Belum ada soal tersimpan</p>';
            return;
        }

        let html = '';
        this.soalList.forEach(soal => {
            const tipeLabel = {
                pg: 'Pilihan Ganda',
                bs: 'Benar/Salah',
                isian: 'Isian Singkat',
                essay: 'Essay',
                jodoh: 'Menjodohkan'
            };

            html += `
            <div class="p-4 border border-slate-200 rounded-xl hover:border-blue-300 transition">
                <div class="flex justify-between items-start gap-4">
                    <div class="flex-1">
                        <p class="font-medium text-slate-900 mb-2">${soal.pertanyaan}</p>
                        <div class="flex flex-wrap gap-2 text-xs">
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded">${soal.mapel}</span>
                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded">Kelas ${soal.kelas}</span>
                            <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded">${tipeLabel[soal.tipe] || soal.tipe}</span>
                        </div>
                    </div>
                    <button onclick="BankSoalSystem.deleteSoal('${soal.id}')" class="text-red-500 hover:text-red-700 text-sm">ğŸ—‘ï¸</button>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    },

    showAddModal() {
        const sel = CurriculumSystem.getCurrentSelection();
        
        const modal = document.createElement('div');
        modal.id = 'add-soal-modal';
        modal.className = 'modal-overlay';
        modal.style.display = 'flex';
        modal.innerHTML = `
        <div class="bg-white rounded-2xl p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-900">â• Tambah Soal Baru</h2>
                <button onclick="this.closest('.modal-overlay').remove()" class="text-slate-400 hover:text-slate-600 text-2xl">âœ•</button>
            </div>
            <form id="add-soal-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Mapel</label>
                        <input type="text" id="soal-mapel" value="${sel.mapel}" class="w-full px-3 py-2 border border-slate-300 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Kelas</label>
                        <input type="text" id="soal-kelas" value="${sel.kelas}" class="w-full px-3 py-2 border border-slate-300 rounded-lg" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Tipe Soal</label>
                    <select id="soal-tipe" class="w-full px-3 py-2 border border-slate-300 rounded-lg" required onchange="BankSoalSystem.toggleOptions(this.value)">
                        <option value="pg">Pilihan Ganda</option>
                        <option value="bs">Benar/Salah</option>
                        <option value="isian">Isian Singkat</option>
                        <option value="essay">Essay</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Pertanyaan</label>
                    <textarea id="soal-pertanyaan" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg" required></textarea>
                </div>
                <div id="soal-opsi-container">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Opsi Jawaban (1 per baris)</label>
                    <textarea id="soal-opsi" rows="4" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="A. Opsi 1&#10;B. Opsi 2&#10;C. Opsi 3&#10;D. Opsi 4"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Kunci Jawaban</label>
                    <input type="text" id="soal-jawaban" class="w-full px-3 py-2 border border-slate-300 rounded-lg" required>
                </div>
                <button type="submit" class="w-full py-3 gradient-primary text-white font-bold rounded-xl">
                    Simpan Soal
                </button>
            </form>
        </div>`;

        document.body.appendChild(modal);

        document.getElementById('add-soal-form').onsubmit = (e) => {
            e.preventDefault();
            this.saveSoal();
        };
    },

    toggleOptions(tipe) {
        const container = document.getElementById('soal-opsi-container');
        if (container) {
            container.style.display = (tipe === 'pg' || tipe === 'bs') ? 'block' : 'none';
        }
    },

    async saveSoal() {
        const data = {
            userId: AuthSystem.currentUser.uid,
            npsn: AuthSystem.userData?.npsn,
            mapel: document.getElementById('soal-mapel').value,
            kelas: document.getElementById('soal-kelas').value,
            tipe: document.getElementById('soal-tipe').value,
            pertanyaan: document.getElementById('soal-pertanyaan').value,
            opsi: document.getElementById('soal-opsi')?.value.split('\n').filter(o => o.trim()) || [],
            jawaban: document.getElementById('soal-jawaban').value,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await db.collection('banksoal').add(data);
            document.getElementById('add-soal-modal')?.remove();
            Utils.toast('Soal berhasil disimpan!', 'success');
            this.loadSoal();
        } catch (error) {
            Utils.toast('Gagal menyimpan soal', 'error');
        }
    },

    async deleteSoal(id) {
        if (!confirm('Hapus soal ini?')) return;
        
        try {
            await db.collection('banksoal').doc(id).delete();
            Utils.toast('Soal dihapus', 'info');
            this.loadSoal();
        } catch (error) {
            Utils.toast('Gagal menghapus', 'error');
        }
    },

    filter() {
        // Simple client-side filter
        const mapel = document.getElementById('bs-mapel')?.value;
        const kelas = document.getElementById('bs-kelas')?.value;
        const tipe = document.getElementById('bs-tipe')?.value;

        const filtered = this.soalList.filter(s => {
            if (mapel && s.mapel !== mapel) return false;
            if (kelas && s.kelas !== kelas) return false;
            if (tipe && s.tipe !== tipe) return false;
            return true;
        });

        // Temporarily replace and render
        const original = this.soalList;
        this.soalList = filtered;
        this.renderList();
        this.soalList = original;
    },

    generatePaket() {
        Utils.toast('Fitur generate paket akan tersedia segera!', 'info');
    }
};

// =====================================================
// DOCUMENT ENGINE
// =====================================================
const DocumentEngine = {
    init() {
        // Initialize document generation view
    },

    generate(type) {
        // Check permission
        if (!SubscriptionSystem.guard(type)) return;

        const sel = CurriculumSystem.getCurrentSelection();
        if (!sel.mapel || !sel.kelas || !sel.semester) {
            Utils.toast('Pilih Mapel, Kelas, dan Semester terlebih dahulu di menu Kurikulum', 'warning');
            return;
        }

        const container = document.getElementById('doc-preview-container');
        const preview = document.getElementById('doc-preview');
        
        let html = '';

        switch (type) {
            case 'atp':
                html = this.generateATP(sel);
                break;
            case 'prota':
                html = this.generateProta(sel);
                break;
            case 'promes':
                html = this.generatePromes(sel);
                break;
            case 'modul':
                html = this.generateModul(sel);
                break;
            case 'lkpd':
                html = this.generateLKPD(sel);
                break;
            case 'jurnal':
                html = this.generateJurnal(sel);
                break;
            case 'absensi':
                html = this.generateAbsensi(sel);
                break;
            case 'kktp':
                html = this.generateKKTP(sel);
                break;
            default:
                html = '<p class="text-center text-slate-500">Dokumen tidak ditemukan</p>';
        }

        preview.innerHTML = html;
        container.classList.remove('hidden');
        container.scrollIntoView({ behavior: 'smooth' });
    },

    getIdentity() {
        return {
            sekolah: SchoolSystem.schoolData?.namaSekolah || 'SDN Contoh',
            kepsek: SchoolSystem.schoolData?.kepsek || 'Kepala Sekolah, S.Pd.',
            nipKepsek: SchoolSystem.schoolData?.nipKepsek || '19700101 199001 1 001',
            guru: AuthSystem.userData?.nama || 'Nama Guru, S.Pd.',
            nipGuru: AuthSystem.userData?.nip || '19900101 201501 1 001',
            tahun: CalendarSystem.getSettings().tahun,
            rombel: CalendarSystem.getSettings().rombel
        };
    },

    generateATP(sel) {
        const id = this.getIdentity();
        const data = CurriculumSystem.getDataForSelection(sel.mapel, sel.kelas, sel.semester, null);
        const calSettings = CalendarSystem.getSettings();
        
        if (!data) return '<p class="text-center text-red-500">Data tidak ditemukan. Pilih kurikulum terlebih dahulu.</p>';

        let rows = '';
        let no = 1;
        
        for (const [elemen, elData] of Object.entries(data)) {
            const rowspan = elData.tps.length;
            elData.tps.forEach((tp, idx) => {
                rows += `<tr>`;
                if (idx === 0) {
                    rows += `<td rowspan="${rowspan}" class="text-center align-middle">${no}</td>`;
                    rows += `<td rowspan="${rowspan}" class="align-middle bg-slate-50" contenteditable="true">
                        <strong class="text-blue-800">${elemen}</strong>
                        <hr class="my-2 border-slate-300">
                        <span class="text-xs text-slate-600">${elData.cp}</span>
                    </td>`;
                }
                rows += `<td contenteditable="true">${tp.tp}</td>`;
                rows += `<td class="text-xs text-blue-700" contenteditable="true">Beriman, Bernalar Kritis, Mandiri</td>`;
                rows += `<td class="text-center font-medium text-amber-600" contenteditable="true">Memahami</td>`;
                if (idx === 0) {
                    rows += `<td rowspan="${rowspan}" class="text-center align-middle">${rowspan * calSettings.jp} JP</td>`;
                }
                rows += `</tr>`;
            });
            no++;
        }

        return `
        <div class="paper-preview landscape">
            <h1 class="text-center text-[14pt] font-bold mb-5 uppercase" contenteditable="true">
                ALUR TUJUAN PEMBELAJARAN (ATP)<br>
                TAHUN PELAJARAN ${id.tahun}/${id.tahun + 1}
            </h1>
            <div class="flex justify-between mb-4 font-bold text-[11pt]" contenteditable="true">
                <table>
                    <tr><td width="160">NAMA SEKOLAH</td><td>: ${id.sekolah}</td></tr>
                    <tr><td>MATA PELAJARAN</td><td>: ${sel.mapel}</td></tr>
                    <tr><td>FASE</td><td>: ${sel.fase}</td></tr>
                </table>
                <table>
                    <tr><td width="100">KELAS</td><td>: ${sel.kelas}</td></tr>
                    <tr><td>SEMESTER</td><td>: ${sel.semester}</td></tr>
                </table>
            </div>
            <table class="doc-table">
                <thead>
                    <tr>
                        <th width="4%">NO</th>
                        <th width="22%">ELEMEN DAN CAPAIAN PEMBELAJARAN</th>
                        <th width="28%">TUJUAN PEMBELAJARAN</th>
                        <th width="18%">PROFIL PELAJAR PANCASILA</th>
                        <th width="12%">KOMPETENSI</th>
                        <th width="8%">ALOKASI WAKTU</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
            ${this.getSignature(id)}
        </div>`;
    },

    generateProta(sel) {
        const id = this.getIdentity();
        const calSettings = CalendarSystem.getSettings();
        
        // Get both semesters data
        const ganjilData = CurriculumSystem.getDataForSelection(sel.mapel, sel.kelas, 'Ganjil', null);
        const genapData = CurriculumSystem.getDataForSelection(sel.mapel, sel.kelas, 'Genap', null);

        let rows = '';
        
        const renderSemester = (semData, semLabel) => {
            if (!semData) return '';
            let html = '';
            for (const [elemen, elData] of Object.entries(semData)) {
                const rowspan = elData.tps.length;
                elData.tps.forEach((tp, idx) => {
                    html += `<tr>`;
                    if (idx === 0) {
                        html += `<td rowspan="${rowspan}" class="text-center align-middle font-bold">${semLabel}</td>`;
                        html += `<td rowspan="${rowspan}" class="align-middle bg-slate-50" contenteditable="true">
                            <strong>${elemen}</strong>
                            <hr class="my-1">
                            <span class="text-xs text-slate-600">${elData.cp}</span>
                        </td>`;
                    }
                    html += `<td contenteditable="true">${tp.tp}</td>`;
                    if (idx === 0) {
                        html += `<td rowspan="${rowspan}" class="text-center align-middle font-bold">${rowspan * calSettings.jp} JP</td>`;
                    }
                    html += `</tr>`;
                });
            }
            return html;
        };

        rows += renderSemester(ganjilData, 'Ganjil');
        rows += renderSemester(genapData, 'Genap');

        if (!rows) rows = '<tr><td colspan="4" class="text-center text-slate-500">Data tidak ditemukan</td></tr>';

        return `
        <div class="paper-preview portrait">
            <h1 class="text-center text-[14pt] font-bold mb-5 uppercase" contenteditable="true">
                PROGRAM TAHUNAN (PROTA)<br>
                ${sel.mapel.toUpperCase()}
            </h1>
            <table class="mb-4 font-bold text-[11pt]" contenteditable="true">
                <tr><td width="150">Satuan Pendidikan</td><td>: ${id.sekolah}</td></tr>
                <tr><td>Fase / Kelas</td><td>: ${sel.fase} / ${sel.kelas}</td></tr>
                <tr><td>Tahun Pelajaran</td><td>: ${id.tahun}/${id.tahun + 1}</td></tr>
            </table>
            <table class="doc-table">
                <thead>
                    <tr>
                        <th width="10%">Semester</th>
                        <th width="30%">Elemen & Capaian</th>
                        <th width="45%">Tujuan Pembelajaran</th>
                        <th width="15%">JP</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
            ${this.getSignature(id)}
        </div>`;
    },

    generatePromes(sel) {
        const id = this.getIdentity();
        const calSettings = CalendarSystem.getSettings();
        const data = CurriculumSystem.getDataForSelection(sel.mapel, sel.kelas, sel.semester, null);
        
        if (!data) return '<p class="text-center text-red-500">Data tidak ditemukan</p>';

        // Generate month headers based on semester
        const startMonth = sel.semester === 'Ganjil' ? 6 : 0; // July or January
        const months = [];
        for (let i = 0; i < 6; i++) {
            const monthIdx = (startMonth + i) % 12;
            const year = sel.semester === 'Ganjil' ? 
                (monthIdx >= 6 ? id.tahun : id.tahun + 1) : 
                (monthIdx >= 6 ? id.tahun : id.tahun + 1);
            months.push({ idx: monthIdx, year: year, name: BULAN_IND[monthIdx].substring(0, 3) });
        }

        // Build header
        let thead = `
        <tr>
            <th rowspan="2" width="10%">Elemen</th>
            <th rowspan="2" width="25%">Tujuan Pembelajaran</th>
            <th rowspan="2" width="5%">JP</th>`;
        months.forEach(m => {
            thead += `<th colspan="5">${m.name}</th>`;
        });
        thead += `</tr><tr>`;
        for (let i = 0; i < 6; i++) {
            thead += `<th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>`;
        }
        thead += `</tr>`;

        // Build rows with activity tracking
        let rows = '';
        let weekCounter = 0;
        const totalWeeks = 30; // 6 months * 5 weeks max
        
        CalendarSystem.generateEvents(); // Ensure events are loaded

        for (const [elemen, elData] of Object.entries(data)) {
            const rowspan = elData.tps.length;
            
            elData.tps.forEach((tp, idx) => {
                rows += `<tr>`;
                if (idx === 0) {
                    rows += `<td rowspan="${rowspan}" class="text-center align-middle text-xs font-bold bg-slate-50" contenteditable="true">${elemen.substring(0, 50)}${elemen.length > 50 ? '...' : ''}</td>`;
                }
                rows += `<td class="text-xs" contenteditable="true">${tp.tp}</td>`;
                rows += `<td class="text-center font-bold">${calSettings.jp}</td>`;

                // Generate week cells
                for (let w = 0; w < totalWeeks; w++) {
                    const monthIdx = Math.floor(w / 5);
                    const weekInMonth = (w % 5) + 1;
                    const month = months[monthIdx];
                    
                    if (!month) {
                        rows += `<td></td>`;
                        continue;
                    }

                    // Check for holidays in this week
                    const weekStart = (weekInMonth - 1) * 7 + 1;
                    const dateStr = `${month.year}-${String(month.idx + 1).padStart(2, '0')}-${String(Math.min(weekStart, 28)).padStart(2, '0')}`;
                    const eventName = CalendarSystem.getEventName(dateStr);
                    
                    if (eventName && eventName.toLowerCase().includes('libur')) {
                        // Holiday cell - only show once per column
                        if (idx === 0) {
                            rows += `<td rowspan="${rowspan}" class="event-cell"><div class="vertical-text">${eventName.substring(0, 15)}</div></td>`;
                        }
                    } else if (w === weekCounter) {
                        // Active teaching week
                        rows += `<td class="bg-blue-100 text-center text-xs font-bold text-blue-800">${weekInMonth}</td>`;
                    } else {
                        rows += `<td></td>`;
                    }
                }
                
                weekCounter++;
                rows += `</tr>`;
            });
        }

        return `
        <div class="paper-preview landscape">
            <h1 class="text-center text-[14pt] font-bold mb-5 uppercase" contenteditable="true">
                PROGRAM SEMESTER (PROMES)<br>
                SEMESTER ${sel.semester.toUpperCase()}
            </h1>
            <table class="mb-4 font-bold text-[11pt]" contenteditable="true">
                <tr><td width="150">Mata Pelajaran</td><td>: ${sel.mapel}</td></tr>
                <tr><td>Kelas/Rombel</td><td>: ${sel.kelas} / ${id.rombel}</td></tr>
                <tr><td>Tahun Pelajaran</td><td>: ${id.tahun}/${id.tahun + 1}</td></tr>
            </table>
            <table class="doc-table text-[8pt]">
                <thead>${thead}</thead>
                <tbody>${rows}</tbody>
            </table>
            ${this.getSignature(id)}
        </div>`;
    },

    generateModul(sel) {
        const id = this.getIdentity();
        const calSettings = CalendarSystem.getSettings();
        const elemenData = CurriculumSystem.getDataForSelection(sel.mapel, sel.kelas, sel.semester, sel.elemen);
        
        if (!elemenData) return '<p class="text-center text-red-500">Pilih Elemen terlebih dahulu di menu Kurikulum</p>';

        let tpList = '';
        let langkahKBM = '';
        
        elemenData.tps.forEach((tp, idx) => {
            tpList += `<li><strong>Pertemuan ${idx + 1}:</strong> ${tp.tp}</li>`;
            
            langkahKBM += `
            <div class="mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                <h4 class="font-bold text-blue-800 border-b-2 border-slate-300 pb-2 mb-3">Pertemuan ${idx + 1} (${calSettings.jp} JP)</h4>
                
                <div class="mb-3">
                    <p class="font-bold text-slate-700 underline mb-2">A. PENDAHULUAN (15 Menit)</p>
                    <ol class="list-decimal pl-6 text-sm space-y-1">
                        <li>Guru mengucapkan salam pembuka dan mengajak peserta didik berdoa sebelum memulai pembelajaran.</li>
                        <li>Guru mengecek kehadiran peserta didik dan mempersiapkan kondisi kelas yang kondusif.</li>
                        <li>Guru memberikan apersepsi dengan mengaitkan pengalaman peserta didik dengan materi <strong>${sel.elemen}</strong>.</li>
                        <li>Guru menyampaikan tujuan pembelajaran hari ini: <em>${tp.tp}</em></li>
                    </ol>
                </div>

                <div class="mb-3">
                    <p class="font-bold text-slate-700 underline mb-2">B. KEGIATAN INTI (50-60 Menit)</p>
                    <ol class="list-decimal pl-6 text-sm space-y-1">
                        <li><strong>Orientasi:</strong> Peserta didik mengamati penjelasan guru dan media pembelajaran terkait materi.</li>
                        <li><strong>Eksplorasi:</strong> Peserta didik dibagi dalam kelompok untuk mendiskusikan dan mengerjakan LKPD.</li>
                        <li><strong>Elaborasi:</strong> Perwakilan kelompok mempresentasikan hasil diskusi di depan kelas.</li>
                        <li><strong>Konfirmasi:</strong> Guru memberikan umpan balik dan penguatan terhadap hasil kerja peserta didik.</li>
                    </ol>
                </div>

                <div>
                    <p class="font-bold text-slate-700 underline mb-2">C. PENUTUP (15 Menit)</p>
                    <ol class="list-decimal pl-6 text-sm space-y-1">
                        <li>Guru bersama peserta didik menyimpulkan materi pembelajaran hari ini.</li>
                        <li>Guru memberikan tugas atau pekerjaan rumah untuk pendalaman materi.</li>
                        <li>Guru menyampaikan rencana pembelajaran pertemuan berikutnya.</li>
                        <li>Pembelajaran ditutup dengan doa dan salam penutup.</li>
                    </ol>
                </div>
            </div>`;
        });

        return `
        <div class="paper-preview portrait">
            <h1 class="text-center text-[14pt] font-bold mb-5 uppercase" contenteditable="true">
                MODUL AJAR KURIKULUM MERDEKA
            </h1>

            <div class="font-bold text-[11pt] bg-slate-100 p-2 border-l-4 border-blue-600 mb-3">A. IDENTITAS UMUM</div>
            <table class="mb-4 font-bold text-[11pt] w-full" contenteditable="true">
                <tr><td width="150">Nama Penyusun</td><td>: ${id.guru}</td></tr>
                <tr><td>Satuan Pendidikan</td><td>: ${id.sekolah}</td></tr>
                <tr><td>Mata Pelajaran</td><td>: ${sel.mapel}</td></tr>
                <tr><td>Kelas / Semester</td><td>: ${sel.kelas} / ${sel.semester}</td></tr>
                <tr><td>Fase</td><td>: ${sel.fase}</td></tr>
                <tr><td>Topik/Materi</td><td>: <span class="text-blue-700">${sel.elemen}</span></td></tr>
                <tr><td>Alokasi Waktu</td><td>: ${elemenData.tps.length * calSettings.jp} JP (${elemenData.tps.length} Pertemuan)</td></tr>
            </table>

            <div class="font-bold text-[11pt] bg-slate-100 p-2 border-l-4 border-blue-600 mb-3">B. CAPAIAN & TUJUAN PEMBELAJARAN</div>
            <div class="mb-4 pl-2" contenteditable="true">
                <p class="font-bold text-slate-700 mb-1">Capaian Pembelajaran (CP):</p>
                <p class="text-sm bg-blue-50 p-3 rounded border border-blue-200 mb-3">${elemenData.cp}</p>
                
                <p class="font-bold text-slate-700 mb-1">Tujuan Pembelajaran (TP):</p>
                <ol class="list-decimal pl-5 text-sm font-medium">${tpList}</ol>
            </div>

            <div class="font-bold text-[11pt] bg-slate-100 p-2 border-l-4 border-blue-600 mb-3">C. LANGKAH-LANGKAH PEMBELAJARAN</div>
            <div contenteditable="true">${langkahKBM}</div>

            <div class="font-bold text-[11pt] bg-slate-100 p-2 border-l-4 border-blue-600 mb-3">D. ASESMEN</div>
            <div class="pl-2 text-sm" contenteditable="true">
                <p><strong>1. Asesmen Formatif:</strong> Observasi keaktifan, tanya jawab, dan diskusi kelompok.</p>
                <p><strong>2. Asesmen Sumatif:</strong> Penugasan individu dan tes tertulis di akhir pembelajaran.</p>
            </div>

            ${this.getSignature(id)}
        </div>`;
    },

    generateLKPD(sel) {
        const id = this.getIdentity();
        const elemenData = CurriculumSystem.getDataForSelection(sel.mapel, sel.kelas, sel.semester, sel.elemen);
        
        if (!elemenData) return '<p class="text-center text-red-500">Pilih Elemen terlebih dahulu</p>';

        let tpList = elemenData.tps.map((tp, i) => `<li>${tp.tp}</li>`).join('');

        return `
        <div class="paper-preview portrait">
            <div class="border-4 border-dashed border-blue-500 p-6 rounded-2xl bg-blue-50 min-h-[90%]">
                <h1 class="text-center text-[16pt] font-bold text-blue-800 mb-4 uppercase" contenteditable="true">
                    LEMBAR KERJA PESERTA DIDIK (LKPD)
                </h1>
                
                <div class="flex justify-between border-b-2 border-blue-300 pb-3 mb-4 font-medium" contenteditable="true">
                    <span>Nama Kelompok : ................................</span>
                    <span>Kelas: ${sel.kelas}/${id.rombel}</span>
                    <span>Nilai : ........</span>
                </div>

                <table class="w-full mb-4 text-sm">
                    <tr><td class="font-bold text-blue-700" width="140">Mata Pelajaran</td><td>: ${sel.mapel}</td></tr>
                    <tr><td class="font-bold text-blue-700">Materi/Topik</td><td>: ${sel.elemen}</td></tr>
                </table>

                <div contenteditable="true">
                    <p class="font-bold text-blue-800 text-[11pt] border-b border-blue-300 pb-1 mb-2">A. Tujuan Kegiatan</p>
                    <div class="bg-white p-3 rounded border border-blue-200 mb-4">
                        <ol class="list-decimal pl-5 text-sm">${tpList}</ol>
                    </div>

                    <p class="font-bold text-blue-800 text-[11pt] border-b border-blue-300 pb-1 mb-2">B. Petunjuk Pengerjaan</p>
                    <ol class="list-decimal pl-5 mb-4 text-sm bg-white p-3 rounded border border-blue-200">
                        <li>Berdoalah terlebih dahulu sebelum mengerjakan.</li>
                        <li>Bacalah setiap instruksi dengan cermat dan teliti.</li>
                        <li>Diskusikan bersama kelompokmu untuk menjawab setiap pertanyaan.</li>
                        <li>Tuliskan jawaban pada kolom yang telah disediakan.</li>
                        <li>Presentasikan hasil kerja kelompokmu di depan kelas.</li>
                    </ol>

                    <p class="font-bold text-blue-800 text-[11pt] border-b border-blue-300 pb-1 mb-2">C. Aktivitas / Tantangan</p>
                    
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded border border-slate-300">
                            <p class="font-bold text-sm mb-2">1. Tuliskan pemahaman utamamu tentang materi "${sel.elemen}"!</p>
                            <div class="border border-slate-400 rounded min-h-[100px] p-2"></div>
                        </div>
                        
                        <div class="bg-white p-4 rounded border border-slate-300">
                            <p class="font-bold text-sm mb-2">2. Berikan 3 contoh nyata penerapan materi ini dalam kehidupan sehari-hari!</p>
                            <div class="border border-slate-400 rounded min-h-[100px] p-2"></div>
                        </div>
                        
                        <div class="bg-white p-4 rounded border border-slate-300">
                            <p class="font-bold text-sm mb-2">3. Bagaimana kamu dapat mengimplementasikan pembelajaran hari ini untuk menjadi lebih baik?</p>
                            <div class="border border-slate-400 rounded min-h-[100px] p-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    },

    generateJurnal(sel) {
        const id = this.getIdentity();
        const calSettings = CalendarSystem.getSettings();
        const data = CurriculumSystem.getDataForSelection(sel.mapel, sel.kelas, sel.semester, null);
        
        if (!data) return '<p class="text-center text-red-500">Data tidak ditemukan</p>';

        // Calculate teaching dates
        CalendarSystem.generateEvents();
        const startMonth = sel.semester === 'Ganjil' ? 6 : 0;
        const year = sel.semester === 'Ganjil' ? id.tahun : id.tahun + 1;
        
        let teachingDates = [];
        for (let m = 0; m < 6; m++) {
            const monthIdx = (startMonth + m) % 12;
            const yr = monthIdx >= 6 ? id.tahun : id.tahun + 1;
            const daysInMonth = new Date(yr, monthIdx + 1, 0).getDate();
            
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(yr, monthIdx, d);
                if (date.getDay() === calSettings.hari) {
                    const dateStr = `${yr}-${String(monthIdx + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    if (!CalendarSystem.isHoliday(dateStr)) {
                        teachingDates.push({
                            date: dateStr,
                            display: `${d}/${monthIdx + 1}/${yr}`
                        });
                    }
                }
            }
        }

        // Build journal entries
        let rows = '';
        let dateIdx = 0;
        
        for (const [elemen, elData] of Object.entries(data)) {
            elData.tps.forEach(tp => {
                const teachDate = teachingDates[dateIdx] || { display: '-', date: '-' };
                dateIdx++;
                
                rows += `
                <tr>
                    <td class="text-center font-bold">${teachDate.display}</td>
                    <td class="text-center" contenteditable="true">${sel.kelas}/${id.rombel}</td>
                    <td contenteditable="true">${elemen}</td>
                    <td contenteditable="true">${tp.tp}</td>
                    <td class="text-center font-bold text-green-600" contenteditable="true">Hadir Semua</td>
                    <td contenteditable="true">Pembelajaran berjalan lancar</td>
                </tr>`;
            });
        }

        return `
        <div class="paper-preview landscape">
            <h1 class="text-center text-[14pt] font-bold mb-5 uppercase" contenteditable="true">
                JURNAL PELAKSANAAN PEMBELAJARAN<br>
                SEMESTER ${sel.semester.toUpperCase()} TAHUN PELAJARAN ${id.tahun}/${id.tahun + 1}
            </h1>
            <table class="mb-4 font-bold text-[11pt]" contenteditable="true">
                <tr><td width="150">Mata Pelajaran</td><td>: ${sel.mapel}</td></tr>
                <tr><td>Guru Pengajar</td><td>: ${id.guru}</td></tr>
            </table>
            <table class="doc-table text-sm">
                <thead>
                    <tr>
                        <th width="10%">Tanggal</th>
                        <th width="10%">Kelas</th>
                        <th width="15%">Materi/Bab</th>
                        <th width="35%">Tujuan Pembelajaran</th>
                        <th width="12%">Kehadiran</th>
                        <th width="18%">Keterangan</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
            ${this.getSignature(id)}
        </div>`;
    },

    generateAbsensi(sel) {
        const id = this.getIdentity();
        const calSettings = CalendarSystem.getSettings();
        const students = JSON.parse(localStorage.getItem('agsa_students') || '[]');
        
        if (students.length === 0) {
            return '<p class="text-center text-amber-600">Silakan input data siswa terlebih dahulu di menu Profil Guru</p>';
        }

        // Generate teaching dates
        CalendarSystem.generateEvents();
        const startMonth = sel.semester === 'Ganjil' ? 6 : 0;
        let dates = [];
        
        for (let m = 0; m < 6; m++) {
            const monthIdx = (startMonth + m) % 12;
            const yr = monthIdx >= 6 ? id.tahun : id.tahun + 1;
            const daysInMonth = new Date(yr, monthIdx + 1, 0).getDate();
            
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(yr, monthIdx, d);
                if (date.getDay() === calSettings.hari) {
                    const dateStr = `${yr}-${String(monthIdx + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    if (!CalendarSystem.isHoliday(dateStr)) {
                        dates.push(d);
                    }
                }
            }
            
            if (dates.length >= 12) break; // Max 12 columns
        }

        let thead = `<tr><th rowspan="2" width="3%">No</th><th rowspan="2" width="25%">Nama Siswa</th>`;
        thead += `<th colspan="${dates.length}">Tanggal Pertemuan</th>`;
        thead += `<th colspan="4" class="bg-blue-100">Akumulasi</th></tr><tr>`;
        dates.forEach(d => thead += `<th>${d}</th>`);
        thead += `<th class="bg-blue-50">H</th><th class="bg-blue-50">S</th><th class="bg-blue-50">I</th><th class="bg-blue-50">A</th></tr>`;

        let tbody = '';
        students.forEach((name, idx) => {
            tbody += `<tr><td class="text-center">${idx + 1}</td><td contenteditable="true">${name}</td>`;
            dates.forEach(() => {
                tbody += `<td class="text-center font-bold text-green-600 cursor-pointer" onclick="this.textContent = this.textContent === 'H' ? 'S' : this.textContent === 'S' ? 'I' : this.textContent === 'I' ? 'A' : 'H'" contenteditable="false">H</td>`;
            });
            tbody += `<td class="text-center font-bold bg-slate-50">${dates.length}</td>`;
            tbody += `<td class="text-center font-bold bg-slate-50">0</td>`;
            tbody += `<td class="text-center font-bold bg-slate-50">0</td>`;
            tbody += `<td class="text-center font-bold bg-slate-50">0</td></tr>`;
        });

        return `
        <div class="paper-preview landscape">
            <h1 class="text-center text-[14pt] font-bold mb-5 uppercase" contenteditable="true">
                DAFTAR HADIR PESERTA DIDIK<br>
                SEMESTER ${sel.semester.toUpperCase()} TAHUN PELAJARAN ${id.tahun}/${id.tahun + 1}
            </h1>
            <table class="mb-4 font-bold text-[11pt]" contenteditable="true">
                <tr><td width="150">Mata Pelajaran</td><td>: ${sel.mapel}</td></tr>
                <tr><td>Kelas / Rombel</td><td>: ${sel.kelas} / ${id.rombel}</td></tr>
            </table>
            <p class="text-sm text-slate-600 mb-2">Keterangan: H = Hadir, S = Sakit, I = Izin, A = Alpa (Klik sel untuk mengubah)</p>
            <table class="doc-table text-[9pt] text-center">
                <thead>${thead}</thead>
                <tbody>${tbody}</tbody>
            </table>
            ${this.getSignature(id)}
        </div>`;
    },

    generateKKTP(sel) {
        const id = this.getIdentity();
        const data = CurriculumSystem.getDataForSelection(sel.mapel, sel.kelas, sel.semester, null);
        const students = JSON.parse(localStorage.getItem('agsa_students') || '[]');
        
        if (!data) return '<p class="text-center text-red-500">Data tidak ditemukan</p>';

        // KKTP Table
        let kktpRows = '';
        let no = 1;
        for (const [elemen, elData] of Object.entries(data)) {
            elData.tps.forEach(tp => {
                kktpRows += `
                <tr>
                    <td class="text-center">${no}</td>
                    <td contenteditable="true">${tp.tp}</td>
                    <td class="text-center bg-yellow-50 font-bold cursor-pointer" contenteditable="true">75</td>
                    <td class="text-center bg-yellow-50 font-bold cursor-pointer" contenteditable="true">75</td>
                    <td class="text-center bg-yellow-50 font-bold cursor-pointer" contenteditable="true">75</td>
                    <td class="text-center bg-blue-100 font-bold text-blue-800">75</td>
                </tr>`;
                no++;
            });
        }

        // Nilai Table
        let nilaiRows = '';
        if (students.length > 0) {
            students.forEach((name, idx) => {
                nilaiRows += `
                <tr>
                    <td class="text-center">${idx + 1}</td>
                    <td class="text-left" contenteditable="true">${name}</td>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                    <td class="bg-slate-50 font-bold" contenteditable="true"></td>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                    <td class="bg-blue-100 font-bold text-blue-800" contenteditable="true"></td>
                </tr>`;
            });
        } else {
            nilaiRows = '<tr><td colspan="10" class="text-center text-slate-500">Silakan input data siswa terlebih dahulu</td></tr>';
        }

        return `
        <div class="paper-preview portrait">
            <h1 class="text-center text-[14pt] font-bold mb-5 uppercase" contenteditable="true">
                KRITERIA KETERCAPAIAN TUJUAN PEMBELAJARAN (KKTP)
            </h1>
            <table class="mb-4 font-bold text-[11pt]" contenteditable="true">
                <tr><td width="150">Mata Pelajaran</td><td>: ${sel.mapel}</td></tr>
                <tr><td>Kelas / Semester</td><td>: ${sel.kelas} / ${sel.semester}</td></tr>
            </table>
            <table class="doc-table">
                <thead>
                    <tr>
                        <th rowspan="2" width="5%">No</th>
                        <th rowspan="2" width="45%">Tujuan Pembelajaran</th>
                        <th colspan="3">Kriteria (Klik untuk Edit)</th>
                        <th rowspan="2" width="10%">KKTP</th>
                    </tr>
                    <tr>
                        <th class="text-xs">Kompleksitas</th>
                        <th class="text-xs">Daya Dukung</th>
                        <th class="text-xs">Intake Siswa</th>
                    </tr>
                </thead>
                <tbody>${kktpRows}</tbody>
            </table>
            <p class="text-xs italic text-slate-500 mt-2">*Nilai KKTP = Rata-rata dari 3 kriteria</p>
            ${this.getSignature(id)}
        </div>

        <div class="paper-preview landscape mt-6">
            <h1 class="text-center text-[14pt] font-bold mb-5 uppercase" contenteditable="true">
                DAFTAR NILAI SUMATIF & FORMATIF
            </h1>
            <table class="mb-4 font-bold text-[11pt]" contenteditable="true">
                <tr><td width="150">Mata Pelajaran</td><td>: ${sel.mapel}</td></tr>
                <tr><td>Kelas / Semester</td><td>: ${sel.kelas} / ${sel.semester}</td></tr>
            </table>
            <table class="doc-table text-[9pt] text-center">
                <thead>
                    <tr>
                        <th rowspan="2" width="4%">No</th>
                        <th rowspan="2" width="22%">Nama Siswa</th>
                        <th colspan="5">Nilai Sumatif Harian</th>
                        <th rowspan="2" width="7%">STS</th>
                        <th rowspan="2" width="7%">SAS</th>
                        <th rowspan="2" width="8%" class="bg-blue-100">Nilai Rapor</th>
                    </tr>
                    <tr>
                        <th>S1</th><th>S2</th><th>S3</th><th>S4</th><th>RataÂ²</th>
                    </tr>
                </thead>
                <tbody>${nilaiRows}</tbody>
            </table>
            ${this.getSignature(id)}
        </div>`;
    },

    getSignature(id) {
        const today = new Date();
        const dateStr = `${today.getDate()} ${BULAN_IND[today.getMonth()]} ${today.getFullYear()}`;
        
        return `
        <div class="signature-area" contenteditable="true">
            <div class="signature-box">
                <p>Mengetahui,</p>
                <p>Kepala Sekolah</p>
                <p class="signature-name">${id.kepsek}</p>
                <p>NIP. ${id.nipKepsek}</p>
            </div>
            <div class="signature-box">
                <p>..................., ${dateStr}</p>
                <p>Guru Mata Pelajaran</p>
                <p class="signature-name">${id.guru}</p>
                <p>NIP. ${id.nipGuru}</p>
            </div>
        </div>`;
    }
};

// =====================================================
// SUPER ADMIN SYSTEM
// =====================================================
const SuperAdminSystem = {
    async init() {
        if (AuthSystem.userData?.role !== 'super_admin') return;
        
        await this.loadStats();
        await this.loadSettings();
        await this.loadUsers();
        await this.loadSchools();
    },

    async loadStats() {
        try {
            const usersSnap = await db.collection('users').get();
            const schoolsSnap = await db.collection('schools').get();
            const soalSnap = await db.collection('banksoal').get();
            
            let premiumCount = 0;
            usersSnap.forEach(doc => {
                if (doc.data().isPremium) premiumCount++;
            });

            document.getElementById('sa-total-users').textContent = usersSnap.size;
            document.getElementById('sa-total-schools').textContent = schoolsSnap.size;
            document.getElementById('sa-total-premium').textContent = premiumCount;
            document.getElementById('sa-total-soal').textContent = soalSnap.size;
        } catch (error) {
            console.error('Error loading admin stats:', error);
        }
    },

    async loadSettings() {
        try {
            const doc = await db.collection('settings').doc('subscription').get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('sa-wa').value = data.whatsappUpgrade || '';
                document.getElementById('sa-premium-npsn').value = (data.premiumNPSN || []).join(',');
            }
        } catch (error) {
            console.error('Error loading settings:', error);
        }
    },

    async saveSettings() {
        const wa = document.getElementById('sa-wa').value.trim();
        const npsnList = document.getElementById('sa-premium-npsn').value
            .split(',')
            .map(n => n.trim())
            .filter(n => n.length > 0);

        try {
            await db.collection('settings').doc('subscription').set({
                whatsappUpgrade: wa,
                premiumNPSN: npsnList,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            SubscriptionSystem.settings.whatsappUpgrade = wa;
            SubscriptionSystem.settings.premiumNPSN = npsnList;
            
            Utils.toast('Pengaturan berhasil disimpan!', 'success');
        } catch (error) {
            Utils.toast('Gagal menyimpan pengaturan', 'error');
        }
    },

    async loadUsers() {
        const container = document.getElementById('sa-users-list');
        if (!container) return;

        try {
            const snap = await db.collection('users').orderBy('createdAt', 'desc').limit(100).get();
            
            let html = '';
            snap.forEach(doc => {
                const d = doc.data();
                html += `
                <tr class="border-b hover:bg-slate-50">
                    <td class="py-2 px-2">${d.nama || '-'}</td>
                    <td class="py-2 px-2">${d.email}</td>
                    <td class="py-2 px-2">${d.npsn || '-'}</td>
                    <td class="py-2 px-2">
                        <select onchange="SuperAdminSystem.updateUserRole('${doc.id}', this.value)" class="px-2 py-1 border rounded text-xs">
                            <option value="guru" ${d.role === 'guru' ? 'selected' : ''}>Guru</option>
                            <option value="admin_sekolah" ${d.role === 'admin_sekolah' ? 'selected' : ''}>Admin Sekolah</option>
                            <option value="super_admin" ${d.role === 'super_admin' ? 'selected' : ''}>Super Admin</option>
                        </select>
                    </td>
                    <td class="py-2 px-2">
                        <span class="px-2 py-1 rounded text-xs ${d.isPremium ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-600'}">
                            ${d.isPremium ? 'PRO' : 'FREE'}
                        </span>
                    </td>
                    <td class="py-2 px-2">
                        <button onclick="SuperAdminSystem.togglePremium('${doc.id}', ${!d.isPremium})" class="px-2 py-1 ${d.isPremium ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'} rounded text-xs">
                            ${d.isPremium ? 'Revoke' : 'Upgrade'}
                        </button>
                    </td>
                </tr>`;
            });
            container.innerHTML = html || '<tr><td colspan="6" class="text-center py-4 text-slate-500">Tidak ada data</td></tr>';
        } catch (error) {
            container.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Error loading users</td></tr>';
        }
    },

    async loadSchools() {
        const container = document.getElementById('sa-schools-list');
        if (!container) return;

        try {
            const snap = await db.collection('schools').limit(100).get();
            
            let html = '';
            for (const doc of snap.docs) {
                const d = doc.data();
                
                // Count teachers in this school
                const teacherSnap = await db.collection('users').where('npsn', '==', doc.id).get();
                
                html += `
                <tr class="border-b hover:bg-slate-50">
                    <td class="py-2 px-2 font-mono">${doc.id}</td>
                    <td class="py-2 px-2">${d.namaSekolah || '-'}</td>
                    <td class="py-2 px-2 text-center font-bold">${teacherSnap.size}</td>
                    <td class="py-2 px-2">
                        <span class="px-2 py-1 rounded text-xs ${d.premiumByAdmin ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-600'}">
                            ${d.premiumByAdmin ? 'PRO' : 'FREE'}
                        </span>
                    </td>
                    <td class="py-2 px-2">
                        <button onclick="SuperAdminSystem.toggleSchoolPremium('${doc.id}', ${!d.premiumByAdmin})" class="px-2 py-1 ${d.premiumByAdmin ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'} rounded text-xs">
                            ${d.premiumByAdmin ? 'Revoke' : 'Full Premium'}
                        </button>
                    </td>
                </tr>`;
            }
            container.innerHTML = html || '<tr><td colspan="5" class="text-center py-4 text-slate-500">Tidak ada data</td></tr>';
        } catch (error) {
            container.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Error loading schools</td></tr>';
        }
    },

    async updateUserRole(userId, role) {
        try {
            await db.collection('users').doc(userId).update({ role: role });
            Utils.toast('Role berhasil diubah', 'success');
        } catch (error) {
            Utils.toast('Gagal mengubah role', 'error');
        }
    },

    async togglePremium(userId, isPremium) {
        try {
            await db.collection('users').doc(userId).update({ isPremium: isPremium });
            Utils.toast(`User ${isPremium ? 'di-upgrade ke PRO' : 'di-downgrade ke FREE'}`, 'success');
            this.loadUsers();
        } catch (error) {
            Utils.toast('Gagal mengubah status', 'error');
        }
    },

    async toggleSchoolPremium(npsn, isPremium) {
        try {
            await db.collection('schools').doc(npsn).update({ premiumByAdmin: isPremium });
            Utils.toast(`Sekolah ${isPremium ? 'di-set Full Premium' : 'di-revoke Premium'}`, 'success');
            this.loadSchools();
        } catch (error) {
            Utils.toast('Gagal mengubah status', 'error');
        }
    }
};

// =====================================================
// INITIALIZATION
// =====================================================
document.addEventListener('DOMContentLoaded', () => {
    AuthSystem.init();
    SubscriptionSystem.init();
});

// Close modals on outside click
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-overlay')) {
        e.target.style.display = 'none';
    }
});

// Close mobile sidebar on outside click
document.addEventListener('click', (e) => {
    const sidebar = document.getElementById('sidebar');
    const menuBtn = document.getElementById('mobile-menu-btn');
    if (sidebar && sidebar.classList.contains('open') && 
        !sidebar.contains(e.target) && 
        !menuBtn.contains(e.target)) {
        sidebar.classList.remove('open');
    }
});
</script>
</body>
</html>