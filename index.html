<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Guru Super App - SaaS Kolaboratif</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìö</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81' },
                        accent: { 50: '#ecfdf5', 100: '#d1fae5', 500: '#10b981', 600: '#059669', 700: '#047857' },
                        dark: { 800: '#1e293b', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; min-height: 100vh; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Gradients */
        .gradient-hero { background: linear-gradient(135deg, #312e81 0%, #4f46e5 40%, #06b6d4 100%); }
        .gradient-card { background: linear-gradient(145deg, #ffffff 0%, #f1f5f9 100%); }
        .gradient-pro { background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%); }
        .gradient-sidebar { background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%); }
        
        /* Glass Effect */
        .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .glass-dark { background: rgba(15,23,42,0.95); backdrop-filter: blur(20px); }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        .animate-slide-in { animation: slideInLeft 0.3s ease-out; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-shimmer { 
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        /* Sidebar */
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
        
        /* Navigation */
        .nav-item { 
            display: flex; align-items: center; gap: 12px; 
            padding: 12px 16px; border-radius: 10px; 
            transition: all 0.2s ease; cursor: pointer;
            color: #94a3b8; font-weight: 500;
        }
        .nav-item:hover { background: rgba(99,102,241,0.1); color: #e2e8f0; }
        .nav-item.active { background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); color: white; box-shadow: 0 4px 15px rgba(79,70,229,0.4); }
        .nav-item .icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }
        
        /* Cards */
        .card { 
            background: white; border-radius: 16px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0; transition: all 0.3s ease;
        }
        .card:hover { box-shadow: 0 10px 40px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .card-flat { box-shadow: none; border: 1px solid #e2e8f0; }
        .card-flat:hover { transform: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        /* Buttons */
        .btn { 
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            padding: 12px 24px; border-radius: 10px; font-weight: 600;
            transition: all 0.2s ease; cursor: pointer; border: none;
        }
        .btn-primary { background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); color: white; }
        .btn-primary:hover { background: linear-gradient(135deg, #4338ca 0%, #4f46e5 100%); box-shadow: 0 4px 20px rgba(79,70,229,0.4); transform: translateY(-1px); }
        .btn-secondary { background: #f1f5f9; color: #475569; }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn-success { background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; }
        .btn-success:hover { box-shadow: 0 4px 20px rgba(16,185,129,0.4); }
        .btn-warning { background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); color: white; }
        .btn-outline { background: transparent; border: 2px solid #e2e8f0; color: #475569; }
        .btn-outline:hover { border-color: #4f46e5; color: #4f46e5; background: #eef2ff; }
        .btn-sm { padding: 8px 16px; font-size: 0.875rem; border-radius: 8px; }
        .btn-lg { padding: 16px 32px; font-size: 1.125rem; }
        
        /* Inputs */
        .input-field {
            width: 100%; padding: 12px 16px; border-radius: 10px;
            border: 2px solid #e2e8f0; background: white;
            font-size: 0.95rem; transition: all 0.2s ease;
            outline: none;
        }
        .input-field:focus { border-color: #6366f1; box-shadow: 0 0 0 4px rgba(99,102,241,0.1); }
        .input-field::placeholder { color: #94a3b8; }
        .input-dark {
            background: #1e293b; border-color: #334155; color: white;
        }
        .input-dark:focus { border-color: #6366f1; }
        
        /* Badges */
        .badge { 
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
        }
        .badge-pro { background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%); color: white; }
        .badge-free { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .badge-info { background: #e0e7ff; color: #4338ca; }
        .badge-success { background: #d1fae5; color: #047857; }
        .badge-warning { background: #fef3c7; color: #b45309; }
        
        /* Document Styles */
        .paper-preview { 
            background: white; margin: 20px auto; padding: 20mm;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05), 0 10px 40px rgba(0,0,0,0.1);
            border-radius: 4px; max-width: 210mm; min-height: 297mm;
        }
        .paper-preview.landscape { max-width: 297mm; min-height: 210mm; }
        .paper-preview.f4 { max-width: 215.9mm; }
        .paper-preview.f4.landscape { max-width: 330.2mm; min-height: 215.9mm; }
        
        .doc-table { width: 100%; border-collapse: collapse; font-size: 10pt; }
        .doc-table th, .doc-table td { border: 1px solid #374151; padding: 8px; text-align: left; vertical-align: top; }
        .doc-table th { background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%); font-weight: 600; text-align: center; }
        .doc-table-sm th, .doc-table-sm td { padding: 4px 6px; font-size: 9pt; }
        
        [contenteditable="true"]:hover { background: #fef9c3; outline: 2px dashed #fbbf24; border-radius: 2px; }
        [contenteditable="true"]:focus { background: #fef3c7; outline: 2px solid #f59e0b; }
        
        .signature-area { display: flex; justify-content: space-between; margin-top: 40px; padding: 0 5%; }
        .signature-box { text-align: center; font-size: 11pt; min-width: 200px; }
        .signature-name { border-bottom: 1px solid black; font-weight: bold; margin-top: 80px; padding-bottom: 2px; }
        
        .event-cell { 
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%) !important; 
            text-align: center !important; vertical-align: middle !important;
            color: #991b1b; font-weight: 600;
        }
        .active-cell {
            background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%) !important;
            color: #1e40af; font-weight: bold; text-align: center;
        }
        
        /* Modal */
        .modal-overlay { 
            display: none; position: fixed; inset: 0; 
            background: rgba(15,23,42,0.7); backdrop-filter: blur(4px);
            z-index: 1000; justify-content: center; align-items: center; padding: 16px;
        }
        .modal-content { 
            background: white; width: 100%; max-width: 600px; 
            border-radius: 20px; padding: 32px; 
            max-height: 90vh; overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            animation: fadeIn 0.3s ease-out;
        }
        .modal-lg { max-width: 900px; }
        
        /* Tooltip */
        .tooltip { position: relative; }
        .tooltip::after {
            content: attr(data-tip); position: absolute; bottom: 100%; left: 50%;
            transform: translateX(-50%); padding: 6px 12px; border-radius: 6px;
            background: #1e293b; color: white; font-size: 0.75rem; white-space: nowrap;
            opacity: 0; visibility: hidden; transition: all 0.2s;
        }
        .tooltip:hover::after { opacity: 1; visibility: visible; }
        
        /* Stats Card */
        .stat-card {
            background: white; border-radius: 16px; padding: 20px;
            border: 1px solid #e2e8f0; position: relative; overflow: hidden;
        }
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, #4f46e5, #06b6d4);
        }
        .stat-icon {
            width: 48px; height: 48px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
        }
        
        /* Schedule Table */
        .schedule-row {
            display: grid; grid-template-columns: 1fr 1fr 2fr 1fr 80px 60px;
            gap: 8px; padding: 12px; background: #f8fafc; border-radius: 10px;
            margin-bottom: 8px; align-items: center;
        }
        .schedule-row:hover { background: #f1f5f9; }
        .schedule-row select, .schedule-row input {
            padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 8px;
            font-size: 0.875rem; background: white;
        }
        
        /* Toggle Switch */
        .toggle { 
            position: relative; width: 48px; height: 26px; 
            background: #e2e8f0; border-radius: 13px; cursor: pointer;
            transition: background 0.3s;
        }
        .toggle::after {
            content: ''; position: absolute; top: 3px; left: 3px;
            width: 20px; height: 20px; background: white; border-radius: 50%;
            transition: transform 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle.active { background: #4f46e5; }
        .toggle.active::after { transform: translateX(22px); }
        
        /* CSV Info */
        .csv-info { 
            padding: 12px 16px; border-radius: 10px; font-size: 0.875rem;
            display: flex; align-items: center; gap: 8px;
        }
        .csv-info.success { background: #d1fae5; color: #047857; }
        .csv-info.error { background: #fee2e2; color: #b91c1c; }
        .csv-info.loading { background: #e0e7ff; color: #4338ca; }
        
        /* Print Styles */
        @media print {
            body { background: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print, #app-sidebar, #app-header, .modal-overlay { display: none !important; }
            main { margin: 0 !important; padding: 0 !important; }
            .paper-preview { 
                margin: 0; padding: 15mm; box-shadow: none; 
                page-break-after: always; border-radius: 0;
            }
            .paper-preview:last-child { page-break-after: auto; }
            @page { size: A4; margin: 0; }
            @page landscape { size: A4 landscape; }
            [contenteditable="true"]:hover { background: transparent !important; outline: none !important; }
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .paper-preview { padding: 10mm; max-width: 100%; }
            .paper-preview.landscape { min-height: auto; }
            .schedule-row { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 640px) {
            .paper-preview { padding: 5mm; font-size: 9pt; }
            .signature-area { flex-direction: column; gap: 40px; }
            .modal-content { padding: 20px; border-radius: 16px; }
        }
    </style>
</head>
<body>

<!-- ==================== LANDING PAGE ==================== -->
<div id="landing-page" class="min-h-screen">
    <!-- Navbar -->
    <nav class="fixed top-0 left-0 right-0 z-50 glass border-b border-slate-200/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary-500 to-primary-700 rounded-xl flex items-center justify-center text-white text-xl shadow-lg">üìö</div>
                    <div>
                        <span class="font-bold text-lg text-slate-800">Admin Guru</span>
                        <span class="badge-pro ml-2 text-[10px]">SUPER APP</span>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <a href="#fitur" class="text-slate-600 hover:text-primary-600 font-medium hidden md:block transition">Fitur</a>
                    <a href="#pricing" class="text-slate-600 hover:text-primary-600 font-medium hidden md:block transition">Harga</a>
                    <button onclick="AuthSystem.showLoginModal()" class="btn btn-primary btn-sm shadow-lg">
                        Masuk / Daftar
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="gradient-hero min-h-screen flex items-center pt-20 pb-16 relative overflow-hidden">
        <div class="absolute inset-0 opacity-10">
            <div class="absolute top-20 left-10 w-72 h-72 bg-white rounded-full blur-3xl"></div>
            <div class="absolute bottom-20 right-10 w-96 h-96 bg-cyan-300 rounded-full blur-3xl"></div>
        </div>
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
            <div class="grid lg:grid-cols-2 gap-16 items-center">
                <div class="text-white">
                    <div class="inline-flex items-center gap-2 bg-white/10 backdrop-blur px-4 py-2 rounded-full text-sm font-medium mb-8 border border-white/20">
                        <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                        Platform #1 Administrasi Guru Indonesia
                    </div>
                    <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold leading-tight mb-6">
                        Otomatisasi<br>
                        <span class="bg-gradient-to-r from-cyan-300 to-emerald-300 bg-clip-text text-transparent">Administrasi Guru</span><br>
                        Dalam Hitungan Detik
                    </h1>
                    <p class="text-xl text-blue-100 mb-10 leading-relaxed max-w-xl">
                        Generate ATP, Prota, Promes, Modul Ajar, LKPD, Jurnal, Absensi, KKTP, Bank Soal 
                        secara otomatis berbasis <strong>Kurikulum Merdeka</strong> dengan AI Assistant.
                    </p>
                    <div class="flex flex-wrap gap-4">
                        <button onclick="AuthSystem.showLoginModal()" class="btn btn-lg bg-white text-primary-700 hover:bg-slate-100 shadow-2xl">
                            üöÄ Mulai Gratis Sekarang
                        </button>
                        <a href="#fitur" class="btn btn-lg bg-white/10 text-white border-2 border-white/30 hover:bg-white/20">
                            Pelajari Fitur ‚Üí
                        </a>
                    </div>
                    <div class="mt-10 flex flex-wrap items-center gap-6 text-sm text-blue-200">
                        <span class="flex items-center gap-2"><span class="text-green-400">‚úì</span> Gratis Selamanya</span>
                        <span class="flex items-center gap-2"><span class="text-green-400">‚úì</span> Tanpa Kartu Kredit</span>
                        <span class="flex items-center gap-2"><span class="text-green-400">‚úì</span> Setup 2 Menit</span>
                    </div>
                </div>
                <div class="hidden lg:block animate-float">
                    <div class="bg-white/5 backdrop-blur rounded-3xl p-8 border border-white/10">
                        <div class="bg-white rounded-2xl p-6 shadow-2xl">
                            <div class="flex items-center gap-2 mb-4">
                                <div class="w-3 h-3 rounded-full bg-red-400"></div>
                                <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                                <div class="w-3 h-3 rounded-full bg-green-400"></div>
                                <span class="ml-auto text-xs text-slate-400">Admin Guru Super App</span>
                            </div>
                            <div class="space-y-3">
                                <div class="h-6 bg-gradient-to-r from-primary-100 to-primary-50 rounded-lg w-3/4"></div>
                                <div class="h-4 bg-slate-100 rounded w-1/2"></div>
                                <div class="h-32 bg-gradient-to-br from-slate-50 to-slate-100 rounded-xl mt-4 p-4">
                                    <div class="grid grid-cols-4 gap-2 h-full">
                                        <div class="bg-primary-100 rounded-lg"></div>
                                        <div class="bg-accent-100 rounded-lg"></div>
                                        <div class="bg-amber-100 rounded-lg"></div>
                                        <div class="bg-rose-100 rounded-lg"></div>
                                    </div>
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <div class="h-10 bg-primary-500 rounded-lg flex-1"></div>
                                    <div class="h-10 bg-slate-200 rounded-lg w-24"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section id="fitur" class="py-24 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <span class="badge badge-info mb-4">‚ú® Fitur Lengkap</span>
                <h2 class="text-3xl sm:text-4xl font-bold text-slate-800 mb-4">Semua yang Guru Butuhkan</h2>
                <p class="text-xl text-slate-600 max-w-2xl mx-auto">Platform terintegrasi untuk mengelola administrasi pembelajaran Kurikulum Merdeka</p>
            </div>
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card p-6 group">
                    <div class="stat-icon bg-primary-100 text-primary-600 mb-4 group-hover:scale-110 transition">üìã</div>
                    <h3 class="font-bold text-lg mb-2">ATP & Prota</h3>
                    <p class="text-slate-600 text-sm mb-3">Generate otomatis berdasarkan CP Kurikulum Merdeka</p>
                    <span class="badge badge-free">GRATIS</span>
                </div>
                <div class="card p-6 group">
                    <div class="stat-icon bg-accent-100 text-accent-600 mb-4 group-hover:scale-110 transition">üìÖ</div>
                    <h3 class="font-bold text-lg mb-2">Kalender & Jadwal</h3>
                    <p class="text-slate-600 text-sm mb-3">Multi-kelas atau multi-mapel dalam satu kalender</p>
                    <span class="badge badge-free">GRATIS</span>
                </div>
                <div class="card p-6 group">
                    <div class="stat-icon bg-amber-100 text-amber-600 mb-4 group-hover:scale-110 transition">üìÜ</div>
                    <h3 class="font-bold text-lg mb-2">Promes</h3>
                    <p class="text-slate-600 text-sm mb-3">Program semester dengan opsi A4/F4 Landscape</p>
                    <span class="badge badge-pro">PRO</span>
                </div>
                <div class="card p-6 group">
                    <div class="stat-icon bg-rose-100 text-rose-600 mb-4 group-hover:scale-110 transition">üìñ</div>
                    <h3 class="font-bold text-lg mb-2">Modul Ajar</h3>
                    <p class="text-slate-600 text-sm mb-3">Langkah KBM detail berbasis TP siap cetak</p>
                    <span class="badge badge-pro">PRO</span>
                </div>
                <div class="card p-6 group">
                    <div class="stat-icon bg-cyan-100 text-cyan-600 mb-4 group-hover:scale-110 transition">üìù</div>
                    <h3 class="font-bold text-lg mb-2">LKPD</h3>
                    <p class="text-slate-600 text-sm mb-3">Lembar kerja siswa kreatif dan interaktif</p>
                    <span class="badge badge-pro">PRO</span>
                </div>
                <div class="card p-6 group">
                    <div class="stat-icon bg-purple-100 text-purple-600 mb-4 group-hover:scale-110 transition">üìî</div>
                    <h3 class="font-bold text-lg mb-2">Jurnal</h3>
                    <p class="text-slate-600 text-sm mb-3">Dokumentasi pembelajaran harian otomatis</p>
                    <span class="badge badge-pro">PRO</span>
                </div>
                <div class="card p-6 group">
                    <div class="stat-icon bg-emerald-100 text-emerald-600 mb-4 group-hover:scale-110 transition">‚úÖ</div>
                    <h3 class="font-bold text-lg mb-2">Absensi</h3>
                    <p class="text-slate-600 text-sm mb-3">Presensi interaktif dengan rekapitulasi</p>
                    <span class="badge badge-pro">PRO</span>
                </div>
                <div class="card p-6 group">
                    <div class="stat-icon bg-indigo-100 text-indigo-600 mb-4 group-hover:scale-110 transition">üéØ</div>
                    <h3 class="font-bold text-lg mb-2">KKTP & Nilai</h3>
                    <p class="text-slate-600 text-sm mb-3">Kriteria ketercapaian dan daftar nilai</p>
                    <span class="badge badge-pro">PRO</span>
                </div>
            </div>
            <div class="mt-12 grid md:grid-cols-2 gap-6">
                <div class="card p-6 border-2 border-primary-200 bg-primary-50/50">
                    <div class="flex items-start gap-4">
                        <div class="stat-icon bg-gradient-to-br from-purple-500 to-indigo-600 text-white">ü§ñ</div>
                        <div>
                            <h3 class="font-bold text-lg mb-2">AI Assistant & Prompt Generator</h3>
                            <p class="text-slate-600 text-sm mb-3">Generate soal, materi, dan instruksi LKPD dengan bantuan AI. Copy prompt yang sudah disiapkan ke ChatGPT/Claude.</p>
                            <span class="badge badge-pro">PRO</span>
                        </div>
                    </div>
                </div>
                <div class="card p-6 border-2 border-accent-200 bg-accent-50/50">
                    <div class="flex items-start gap-4">
                        <div class="stat-icon bg-gradient-to-br from-emerald-500 to-teal-600 text-white">üè´</div>
                        <div>
                            <h3 class="font-bold text-lg mb-2">Kolaborasi Sekolah (NPSN)</h3>
                            <p class="text-slate-600 text-sm mb-3">Guru dengan NPSN sama tergabung dalam satu sekolah. Lihat jadwal guru lain dan hindari bentrok.</p>
                            <span class="badge badge-pro">PRO</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Pricing Section -->
    <section id="pricing" class="py-24 bg-gradient-to-b from-slate-50 to-white">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <span class="badge badge-warning mb-4">üí∞ Harga Terjangkau</span>
                <h2 class="text-3xl sm:text-4xl font-bold text-slate-800 mb-4">Pilih Paket Anda</h2>
                <p class="text-xl text-slate-600">Mulai gratis, upgrade kapan saja</p>
            </div>
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Free Plan -->
                <div class="card p-8 border-2 border-slate-200 hover:border-primary-300">
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold text-slate-800">Gratis</h3>
                        <p class="text-slate-500">Untuk memulai</p>
                    </div>
                    <div class="mb-8">
                        <span class="text-5xl font-extrabold text-slate-800">Rp 0</span>
                        <span class="text-slate-500">/selamanya</span>
                    </div>
                    <ul class="space-y-3 mb-8 text-slate-600">
                        <li class="flex items-center gap-3"><span class="text-green-500 text-lg">‚úì</span> Kalender Pendidikan</li>
                        <li class="flex items-center gap-3"><span class="text-green-500 text-lg">‚úì</span> Jadwal Pelajaran (Multi-kelas/mapel)</li>
                        <li class="flex items-center gap-3"><span class="text-green-500 text-lg">‚úì</span> ATP (Alur Tujuan Pembelajaran)</li>
                        <li class="flex items-center gap-3"><span class="text-green-500 text-lg">‚úì</span> Prota (Program Tahunan)</li>
                        <li class="flex items-center gap-3 text-slate-400"><span>‚úó</span> Promes, Modul, LKPD</li>
                        <li class="flex items-center gap-3 text-slate-400"><span>‚úó</span> Jurnal, Absensi, KKTP, Nilai</li>
                    </ul>
                    <button onclick="AuthSystem.showLoginModal()" class="btn btn-outline w-full">
                        Mulai Gratis
                    </button>
                </div>
                <!-- Pro Plan -->
                <div class="card p-8 bg-gradient-to-br from-primary-600 to-primary-800 text-white relative overflow-hidden">
                    <div class="absolute top-4 right-4 badge bg-amber-400 text-amber-900 px-3 py-1">
                        üî• POPULER
                    </div>
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold">Pro</h3>
                        <p class="text-primary-200">Fitur lengkap</p>
                    </div>
                    <div class="mb-8">
                        <span class="text-5xl font-extrabold">Rp 99K</span>
                        <span class="text-primary-200">/tahun</span>
                    </div>
                    <ul class="space-y-3 mb-8">
                        <li class="flex items-center gap-3"><span class="text-cyan-300 text-lg">‚úì</span> Semua fitur Gratis</li>
                        <li class="flex items-center gap-3"><span class="text-cyan-300 text-lg">‚úì</span> Promes (Landscape A4/F4)</li>
                        <li class="flex items-center gap-3"><span class="text-cyan-300 text-lg">‚úì</span> Modul Ajar & LKPD</li>
                        <li class="flex items-center gap-3"><span class="text-cyan-300 text-lg">‚úì</span> Jurnal & Absensi</li>
                        <li class="flex items-center gap-3"><span class="text-cyan-300 text-lg">‚úì</span> KKTP & Daftar Nilai</li>
                        <li class="flex items-center gap-3"><span class="text-cyan-300 text-lg">‚úì</span> Bank Soal dengan AI</li>
                        <li class="flex items-center gap-3"><span class="text-cyan-300 text-lg">‚úì</span> Kolaborasi Sekolah</li>
                    </ul>
                    <button onclick="SubscriptionSystem.showUpgradeModal()" class="btn w-full bg-white text-primary-700 hover:bg-slate-100">
                        üöÄ Upgrade Sekarang
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-dark-900 text-slate-400 py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-primary-500 to-primary-700 rounded-xl flex items-center justify-center text-white text-2xl">üìö</div>
                    <div>
                        <span class="font-bold text-xl text-white">Admin Guru Super App</span>
                        <p class="text-sm">Platform Administrasi Guru Berbasis AI</p>
                    </div>
                </div>
                <p class="text-sm">¬© 2025 Admin Guru Super App. All rights reserved.</p>
            </div>
        </div>
    </footer>
</div>

<!-- ==================== MAIN APP ==================== -->
<div id="main-app" class="hidden">
    <!-- Mobile Header -->
    <header id="app-header" class="lg:hidden fixed top-0 left-0 right-0 z-40 glass border-b border-slate-200 h-16 flex items-center justify-between px-4">
        <button onclick="UISystem.toggleSidebar()" class="w-10 h-10 flex items-center justify-center hover:bg-slate-100 rounded-xl transition">
            <svg class="w-6 h-6 text-slate-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
        <span class="font-bold text-slate-800">Admin Guru</span>
        <button onclick="UISystem.showAIAssistant()" class="w-10 h-10 flex items-center justify-center hover:bg-primary-50 rounded-xl transition text-primary-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
        </button>
    </header>

    <!-- Sidebar -->
    <aside id="app-sidebar" class="fixed left-0 top-0 bottom-0 w-72 gradient-sidebar text-slate-300 z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col shadow-2xl">
        <!-- Logo -->
        <div class="p-5 border-b border-slate-700/50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-primary-500 to-primary-600 rounded-xl flex items-center justify-center text-white text-xl shadow-lg">üìö</div>
                <div>
                    <span class="font-bold text-white text-lg">Admin Guru</span>
                    <div class="flex items-center gap-2 mt-0.5">
                        <span id="user-badge" class="badge badge-free text-[10px]">FREE</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="flex-1 overflow-y-auto sidebar-scroll p-4">
            <nav class="space-y-1">
                <div onclick="UISystem.navigateTo('dashboard')" class="nav-item active" data-page="dashboard">
                    <span class="icon">üìä</span><span>Dashboard</span>
                </div>
                
                <div class="pt-4 pb-2"><span class="text-xs text-slate-500 uppercase font-bold tracking-wider">Pengaturan</span></div>
                
                <div onclick="UISystem.navigateTo('profil-guru')" class="nav-item" data-page="profil-guru">
                    <span class="icon">üë§</span><span>Profil Guru</span>
                </div>
                <div onclick="UISystem.navigateTo('profil-sekolah')" class="nav-item" data-page="profil-sekolah">
                    <span class="icon">üè´</span><span>Profil Sekolah</span>
                </div>
                <div onclick="UISystem.navigateTo('data-siswa')" class="nav-item" data-page="data-siswa">
                    <span class="icon">üë•</span><span>Data Siswa</span>
                </div>
                <div onclick="UISystem.navigateTo('kurikulum')" class="nav-item" data-page="kurikulum">
                    <span class="icon">üìö</span><span>Kurikulum & Mapel</span>
                </div>
                <div onclick="UISystem.navigateTo('kalender')" class="nav-item" data-page="kalender">
                    <span class="icon">üìÖ</span><span>Kalender & Jadwal</span>
                    <span class="badge badge-free ml-auto text-[9px]">FREE</span>
                </div>
                
                <div class="pt-4 pb-2"><span class="text-xs text-slate-500 uppercase font-bold tracking-wider">Generate Dokumen</span></div>
                
                <div onclick="UISystem.navigateTo('doc-atp')" class="nav-item" data-page="doc-atp">
                    <span class="icon">üìã</span><span>ATP & Prota</span>
                    <span class="badge badge-free ml-auto text-[9px]">FREE</span>
                </div>
                <div onclick="UISystem.navigateTo('doc-promes')" class="nav-item" data-page="doc-promes">
                    <span class="icon">üìÜ</span><span>Promes</span>
                    <span class="badge badge-pro ml-auto text-[9px]">PRO</span>
                </div>
                <div onclick="UISystem.navigateTo('doc-modul')" class="nav-item" data-page="doc-modul">
                    <span class="icon">üìñ</span><span>Modul Ajar</span>
                    <span class="badge badge-pro ml-auto text-[9px]">PRO</span>
                </div>
                <div onclick="UISystem.navigateTo('doc-lkpd')" class="nav-item" data-page="doc-lkpd">
                    <span class="icon">üìù</span><span>LKPD</span>
                    <span class="badge badge-pro ml-auto text-[9px]">PRO</span>
                </div>
                <div onclick="UISystem.navigateTo('doc-jurnal')" class="nav-item" data-page="doc-jurnal">
                    <span class="icon">üìî</span><span>Jurnal</span>
                    <span class="badge badge-pro ml-auto text-[9px]">PRO</span>
                </div>
                <div onclick="UISystem.navigateTo('doc-absensi')" class="nav-item" data-page="doc-absensi">
                    <span class="icon">‚úÖ</span><span>Absensi</span>
                    <span class="badge badge-pro ml-auto text-[9px]">PRO</span>
                </div>
                <div onclick="UISystem.navigateTo('doc-kktp')" class="nav-item" data-page="doc-kktp">
                    <span class="icon">üéØ</span><span>KKTP & Nilai</span>
                    <span class="badge badge-pro ml-auto text-[9px]">PRO</span>
                </div>
                <div onclick="UISystem.navigateTo('bank-soal')" class="nav-item" data-page="bank-soal">
                    <span class="icon">‚ùì</span><span>Bank Soal</span>
                    <span class="badge badge-pro ml-auto text-[9px]">PRO</span>
                </div>
                
                <div class="pt-4 pb-2"><span class="text-xs text-slate-500 uppercase font-bold tracking-wider">Lainnya</span></div>
                
                <div onclick="UISystem.navigateTo('subscription')" class="nav-item" data-page="subscription">
                    <span class="icon">üíé</span><span>Subscription</span>
                </div>
                <div id="nav-superadmin" onclick="UISystem.navigateTo('super-admin')" class="nav-item hidden" data-page="super-admin">
                    <span class="icon">üëë</span><span>Super Admin</span>
                </div>
            </nav>
        </div>
        
        <!-- AI Assistant Button & User -->
        <div class="p-4 border-t border-slate-700/50 space-y-3">
            <button onclick="UISystem.showAIAssistant()" class="btn w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-lg shadow-purple-500/30 hover:shadow-purple-500/50">
                ü§ñ AI Assistant
            </button>
            <div class="flex items-center gap-3 p-3 bg-slate-800/50 rounded-xl">
                <div class="w-10 h-10 bg-gradient-to-br from-primary-500 to-primary-600 rounded-full flex items-center justify-center text-white font-bold shadow" id="user-avatar">U</div>
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-semibold text-white truncate" id="user-name">User</div>
                    <div class="text-xs text-slate-400 truncate" id="user-email">user@email.com</div>
                </div>
                <button onclick="AuthSystem.logout()" class="w-8 h-8 flex items-center justify-center hover:bg-slate-700 rounded-lg text-slate-400 hover:text-red-400 transition" title="Logout">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                </button>
            </div>
        </div>
    </aside>

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 hidden lg:hidden" onclick="UISystem.toggleSidebar()"></div>

    <!-- Main Content Area -->
    <main class="lg:ml-72 pt-16 lg:pt-0 min-h-screen bg-slate-50">
        <div id="page-container" class="p-4 lg:p-8 max-w-7xl mx-auto">
            <!-- Pages will be injected here -->
        </div>
    </main>
</div>

<!-- ==================== MODALS ==================== -->

<!-- Login Modal -->
<div id="modal-login" class="modal-overlay">
    <div class="modal-content max-w-md text-center">
        <div class="w-16 h-16 bg-gradient-to-br from-primary-500 to-primary-600 rounded-2xl flex items-center justify-center text-3xl mx-auto mb-6 shadow-lg">üìö</div>
        <h2 class="text-2xl font-bold text-slate-800 mb-2">Selamat Datang!</h2>
        <p class="text-slate-600 mb-8">Masuk dengan akun Google untuk melanjutkan</p>
        
        <button onclick="AuthSystem.loginWithGoogle()" class="btn w-full bg-white border-2 border-slate-200 hover:border-primary-500 hover:bg-primary-50 text-slate-700 mb-4 shadow-sm">
            <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Masuk dengan Google
        </button>
        
        <p class="text-xs text-slate-500">
            Hanya email <strong>@gmail.com</strong> yang diizinkan
        </p>
        
        <button onclick="UISystem.closeModal('modal-login')" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
    </div>
</div>

<!-- Upgrade Modal -->
<div id="modal-upgrade" class="modal-overlay">
    <div class="modal-content max-w-md text-center">
        <div class="w-20 h-20 bg-gradient-to-br from-amber-400 to-orange-500 rounded-full flex items-center justify-center text-4xl mx-auto mb-6 shadow-lg animate-float">üëë</div>
        <h2 class="text-2xl font-bold text-slate-800 mb-2">Fitur PRO</h2>
        <p class="text-slate-600 mb-8">Fitur ini tersedia pada versi PRO. Upgrade sekarang untuk akses penuh ke semua fitur premium!</p>
        
        <a id="btn-wa-upgrade" href="#" target="_blank" class="btn btn-success w-full mb-4 shadow-lg">
            üí¨ Hubungi WhatsApp untuk Upgrade
        </a>
        
        <button onclick="UISystem.closeModal('modal-upgrade')" class="text-slate-500 hover:text-slate-700 font-medium">
            Nanti saja
        </button>
    </div>
</div>

<!-- AI Assistant Modal -->
<div id="modal-ai" class="modal-overlay">
    <div class="modal-content modal-lg">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-purple-600 to-indigo-600 rounded-xl flex items-center justify-center text-2xl shadow-lg">ü§ñ</div>
                <div>
                    <h2 class="text-xl font-bold text-slate-800">AI Assistant</h2>
                    <p class="text-sm text-slate-500">Panduan & Generator Prompt Cerdas</p>
                </div>
            </div>
            <button onclick="UISystem.closeModal('modal-ai')" class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-xl transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        
        <div class="mb-6">
            <div class="flex bg-slate-100 rounded-xl p-1">
                <button onclick="AISystem.switchTab('guide')" class="ai-tab flex-1 py-3 px-4 rounded-lg font-semibold transition bg-white text-primary-600 shadow" data-tab="guide">üìñ Panduan</button>
                <button onclick="AISystem.switchTab('prompt')" class="ai-tab flex-1 py-3 px-4 rounded-lg font-semibold transition text-slate-500 hover:text-slate-700" data-tab="prompt">‚ú® Generator Prompt</button>
            </div>
        </div>
        
        <!-- Guide Tab -->
        <div id="ai-tab-guide" class="ai-tab-content">
            <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <div class="card card-flat p-5 border-l-4 border-l-primary-500">
                    <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2">üöÄ Cara Memulai</h4>
                    <ol class="list-decimal pl-5 text-sm text-slate-600 space-y-2">
                        <li>Lengkapi <strong>Profil Guru</strong> dan <strong>Profil Sekolah</strong></li>
                        <li>Input <strong>Data Siswa</strong> dengan format: <code class="bg-slate-100 px-2 py-0.5 rounded">nama;L/P;kelas</code></li>
                        <li>Pilih jenjang dan muat data <strong>Kurikulum</strong></li>
                        <li>Pilih Mapel, Kelas, dan Semester</li>
                        <li>Atur <strong>Jadwal Mengajar</strong> di menu Kalender</li>
                        <li>Generate dokumen yang dibutuhkan!</li>
                    </ol>
                </div>
                <div class="card card-flat p-5 border-l-4 border-l-amber-500">
                    <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2">üìÖ Kalender & Jadwal</h4>
                    <p class="text-sm text-slate-600 mb-2">Sistem mendukung:</p>
                    <ul class="list-disc pl-5 text-sm text-slate-600 space-y-1">
                        <li><strong>Guru Mapel:</strong> Satu mata pelajaran untuk beberapa kelas berbeda</li>
                        <li><strong>Guru Kelas:</strong> Beberapa mata pelajaran untuk satu kelas</li>
                        <li>Kalender libur otomatis + kustom dengan format: <code class="bg-slate-100 px-2 py-0.5 rounded">YYYY-MM-DD = Keterangan</code></li>
                    </ul>
                </div>
                <div class="card card-flat p-5 border-l-4 border-l-green-500">
                    <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2">üìã Tips Promes</h4>
                    <p class="text-sm text-slate-600">Promes otomatis menandai tanggal mengajar berdasarkan jadwal dan menghindari tanggal libur. Pilih orientasi A4/F4 Landscape sesuai kebutuhan.</p>
                </div>
                <div class="card card-flat p-5 border-l-4 border-l-purple-500">
                    <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2">‚ùì Bank Soal dengan AI</h4>
                    <p class="text-sm text-slate-600">Gunakan tab <strong>Generator Prompt</strong> untuk membuat soal dengan AI. Copy prompt, paste ke ChatGPT/Claude, lalu paste hasilnya dalam format CSV ke aplikasi.</p>
                </div>
            </div>
        </div>
        
        <!-- Prompt Generator Tab -->
        <div id="ai-tab-prompt" class="ai-tab-content hidden">
            <div class="space-y-5">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-slate-700">Jenis Dokumen</label>
                        <select id="prompt-type" class="input-field" onchange="AISystem.updatePrompt()">
                            <option value="soal-pg">Soal Pilihan Ganda</option>
                            <option value="soal-essay">Soal Essay</option>
                            <option value="soal-bs">Soal Benar/Salah</option>
                            <option value="soal-isian">Soal Isian Singkat</option>
                            <option value="soal-campuran">Soal Campuran</option>
                            <option value="materi">Ringkasan Materi</option>
                            <option value="lkpd">Instruksi LKPD</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-slate-700">Jumlah</label>
                        <input type="number" id="prompt-count" class="input-field" value="10" min="1" max="50" onchange="AISystem.updatePrompt()">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold mb-2 text-slate-700">Tujuan Pembelajaran (TP)</label>
                    <select id="prompt-tp" class="input-field" onchange="AISystem.updatePrompt()">
                        <option value="">-- Pilih TP dari kurikulum --</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold mb-2 text-slate-700">Prompt yang Dihasilkan</label>
                    <textarea id="prompt-result" class="input-field h-48 text-sm font-mono" readonly placeholder="Pilih jenis dokumen dan TP untuk generate prompt..."></textarea>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="AISystem.copyPrompt()" class="btn btn-primary flex-1">
                        üìã Copy Prompt
                    </button>
                    <button onclick="AISystem.openChatGPT()" class="btn btn-secondary flex-1">
                        üöÄ Buka ChatGPT
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-white/90 backdrop-blur z-[9999] flex items-center justify-center hidden">
    <div class="text-center">
        <div class="w-16 h-16 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-slate-600 font-medium" id="loading-text">Memuat...</p>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-6 right-6 z-[9999] hidden">
    <div class="bg-slate-800 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 animate-fade-in">
        <span id="toast-icon" class="text-xl">‚úì</span>
        <span id="toast-message" class="font-medium">Berhasil</span>
    </div>
</div>

<script>
// ==================== FIREBASE CONFIG ====================
const firebaseConfig = {
    apiKey: "AIzaSyDe4ie2wSPEpNbAgWP-q03vTuHyxc9Jj3E",
    authDomain: "agsa-e5b08.firebaseapp.com",
    projectId: "agsa-e5b08",
    storageBucket: "agsa-e5b08.firebasestorage.app",
    messagingSenderId: "916052746331",
    appId: "1:916052746331:web:357cbadbfd8658f1689f7e"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ==================== CONSTANTS ====================
const CP_LINKS = {
    "SD": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1925091593&single=true&output=csv",
    "SMP": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1962203786&single=true&output=csv",
    "SMA": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=260922290&single=true&output=csv"
};

const BULAN = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
const BULAN_SHORT = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Ags","Sep","Okt","Nov","Des"];
const HARI = ["Minggu","Senin","Selasa","Rabu","Kamis","Jum'at","Sabtu"];
const SUPER_ADMIN_EMAIL = "afifaro@gmail.com";

const DEFAULT_HOLIDAYS = `2025-01-01 = Tahun Baru Masehi
2025-01-29 = Tahun Baru Imlek
2025-03-29 = Hari Raya Nyepi
2025-03-31 = Idul Fitri 1446 H
2025-04-01 = Idul Fitri 1446 H
2025-04-18 = Wafat Isa Almasih
2025-05-01 = Hari Buruh
2025-05-12 = Hari Raya Waisak
2025-05-29 = Kenaikan Isa Almasih
2025-06-01 = Hari Lahir Pancasila
2025-06-07 = Idul Adha 1446 H
2025-06-27 = Tahun Baru Islam 1447 H
2025-08-17 = HUT Kemerdekaan RI
2025-09-05 = Maulid Nabi Muhammad SAW
2025-12-25 = Hari Raya Natal`;

// ==================== STATE ====================
const AppState = {
    currentUser: null,
    userProfile: null,
    schoolProfile: null,
    students: [],
    curriculum: {},
    faseMap: {},
    calendarEvents: {},
    eventList: [],
    schedules: [], // Array of schedule items
    selectedMapel: '',
    selectedKelas: '',
    selectedSemester: '',
    selectedElemen: '',
    isPro: false,
    isAdmin: false,
    isSuperAdmin: false,
    settings: { waNumber: '6281234567890', premiumNPSN: [], paiNPSN: [], premiumUsers: [] },
    calendarSettings: {
        masukGanjil: '', raporGanjil: '', masukGenap: '', raporGenap: '',
        customHolidays: DEFAULT_HOLIDAYS
    }
};

// ==================== AUTH SYSTEM ====================
const AuthSystem = {
    init() {
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                if (!user.email.endsWith('@gmail.com')) {
                    UISystem.showToast('Hanya email Gmail yang diizinkan', 'error');
                    await auth.signOut();
                    return;
                }
                AppState.currentUser = user;
                AppState.isSuperAdmin = user.email === SUPER_ADMIN_EMAIL;
                await this.loadUserProfile();
                UISystem.showApp();
            } else {
                AppState.currentUser = null;
                UISystem.showLanding();
            }
            UISystem.hideLoading();
        });
    },

    async loginWithGoogle() {
        try {
            UISystem.showLoading('Memproses login...');
            const provider = new firebase.auth.GoogleAuthProvider();
            await auth.signInWithPopup(provider);
            UISystem.closeModal('modal-login');
        } catch (error) {
            console.error('Login error:', error);
            UISystem.showToast('Gagal login: ' + error.message, 'error');
            UISystem.hideLoading();
        }
    },

    async loadUserProfile() {
        try {
            const doc = await db.collection('users').doc(AppState.currentUser.uid).get();
            if (doc.exists) {
                AppState.userProfile = doc.data();
            } else {
                AppState.userProfile = {
                    email: AppState.currentUser.email,
                    name: AppState.currentUser.displayName || '',
                    nip: '',
                    tipeGuru: 'mapel',
                    rombel: 'A',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('users').doc(AppState.currentUser.uid).set(AppState.userProfile);
            }
            
            // Load schedules
            if (AppState.userProfile.schedules) {
                AppState.schedules = AppState.userProfile.schedules;
            }
            
            await SubscriptionSystem.checkSubscription();
            
            if (AppState.userProfile.npsn) {
                await SchoolSystem.loadSchool(AppState.userProfile.npsn);
            }
            
            await SuperAdminSystem.loadSettings();
            
        } catch (error) {
            console.error('Load profile error:', error);
        }
    },

    async logout() {
        try {
            await auth.signOut();
            AppState.currentUser = null;
            AppState.userProfile = null;
            location.reload();
        } catch (error) {
            console.error('Logout error:', error);
        }
    },

    showLoginModal() {
        UISystem.openModal('modal-login');
    }
};

// ==================== PROFILE SYSTEM ====================
const ProfileSystem = {
    async saveProfile(data) {
        try {
            await db.collection('users').doc(AppState.currentUser.uid).update(data);
            AppState.userProfile = { ...AppState.userProfile, ...data };
            UISystem.showToast('Profil berhasil disimpan');
            return true;
        } catch (error) {
            console.error('Save profile error:', error);
            UISystem.showToast('Gagal menyimpan profil', 'error');
            return false;
        }
    }
};

// ==================== SCHOOL SYSTEM ====================
const SchoolSystem = {
    async loadSchool(npsn) {
        try {
            const doc = await db.collection('schools').doc(npsn).get();
            if (doc.exists) {
                AppState.schoolProfile = doc.data();
            }
        } catch (error) {
            console.error('Load school error:', error);
        }
    },

    async saveSchool(data) {
        try {
            const npsn = data.npsn;
            await db.collection('schools').doc(npsn).set(data, { merge: true });
            AppState.schoolProfile = data;
            await ProfileSystem.saveProfile({ npsn });
            UISystem.showToast('Data sekolah berhasil disimpan');
            return true;
        } catch (error) {
            console.error('Save school error:', error);
            UISystem.showToast('Gagal menyimpan data sekolah', 'error');
            return false;
        }
    }
};

// ==================== CURRICULUM SYSTEM ====================
const CurriculumSystem = {
    async fetchFromCloud(jenjang) {
        try {
            UISystem.showLoading('Mengunduh data kurikulum...');
            const url = CP_LINKS[jenjang];
            
            let response;
            try {
                response = await fetch(url);
            } catch {
                response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
            }
            
            const csvText = await response.text();
            this.parseCSV(csvText);
            UISystem.showToast(`Data kurikulum ${jenjang} berhasil dimuat`);
        } catch (error) {
            console.error('Fetch curriculum error:', error);
            UISystem.showToast('Gagal mengunduh. Coba upload CSV manual.', 'error');
        } finally {
            UISystem.hideLoading();
        }
    },

    parseCSV(csvText) {
        const lines = csvText.split('\n');
        AppState.curriculum = {};
        AppState.faseMap = {};
        let count = 0;

        for (let i = 1; i < lines.length; i++) {
            const row = lines[i].trim();
            if (!row) continue;

            const cols = this.parseCSVRow(row);
            if (cols.length < 5) continue;

            const [mapel, fase, kelas, semester, elemen, cp, tp] = cols.map(c => (c || '').trim());
            
            if (fase && kelas) AppState.faseMap[kelas] = fase;
            
            if (!AppState.curriculum[mapel]) AppState.curriculum[mapel] = {};
            if (!AppState.curriculum[mapel][kelas]) AppState.curriculum[mapel][kelas] = {};
            if (!AppState.curriculum[mapel][kelas][semester]) AppState.curriculum[mapel][kelas][semester] = {};
            if (!AppState.curriculum[mapel][kelas][semester][elemen]) {
                AppState.curriculum[mapel][kelas][semester][elemen] = { cp: cp || '', tps: [] };
            }
            
            AppState.curriculum[mapel][kelas][semester][elemen].tps.push({ tp: tp || cp || '' });
            count++;
        }
        
        console.log(`Parsed ${count} TP entries`);
        document.dispatchEvent(new CustomEvent('curriculumLoaded'));
    },

    parseCSVRow(row) {
        const cols = [];
        const regex = /("([^"]*)"|[^,]+)(?=,|$)/g;
        let match;
        while ((match = regex.exec(row)) !== null) {
            cols.push(match[2] !== undefined ? match[2] : match[1]);
        }
        return cols;
    },

    getMapels() { return Object.keys(AppState.curriculum); },
    
    getKelas(mapel) {
        if (!AppState.curriculum[mapel]) return [];
        return Object.keys(AppState.curriculum[mapel]).sort((a, b) => {
            const numA = parseInt(a.replace(/\D/g, '')) || 0;
            const numB = parseInt(b.replace(/\D/g, '')) || 0;
            return numA - numB;
        });
    },

    getSemesters(mapel, kelas) {
        return Object.keys(AppState.curriculum[mapel]?.[kelas] || {});
    },

    getElemen(mapel, kelas, semester) {
        return Object.keys(AppState.curriculum[mapel]?.[kelas]?.[semester] || {});
    },

    getTP(mapel, kelas, semester, elemen) {
        return AppState.curriculum[mapel]?.[kelas]?.[semester]?.[elemen] || null;
    },

    getAllTP(mapel, kelas, semester) {
        const result = [];
        const data = AppState.curriculum[mapel]?.[kelas]?.[semester];
        if (!data) return result;
        
        Object.keys(data).forEach(elemen => {
            data[elemen].tps.forEach(tp => {
                result.push({ elemen, ...tp, cp: data[elemen].cp });
            });
        });
        return result;
    }
};

// ==================== CALENDAR SYSTEM ====================
const CalendarSystem = {
    init() {
        const year = new Date().getFullYear();
        AppState.calendarSettings = {
            masukGanjil: `${year}-07-14`,
            raporGanjil: `${year}-12-20`,
            masukGenap: `${year + 1}-01-06`,
            raporGenap: `${year + 1}-06-21`,
            customHolidays: DEFAULT_HOLIDAYS
        };
    },

    generateCalendar() {
        AppState.calendarEvents = {};
        AppState.eventList = [];

        const addEvent = (date, name) => {
            if (!date) return;
            AppState.calendarEvents[date] = name;
            AppState.eventList.push({ date, name });
        };

        // Semester boundaries
        const cs = AppState.calendarSettings;
        const boundaries = [
            { date: cs.masukGanjil, name: 'Awal Masuk Tahun Ajaran', fillBefore: true, month: 6 },
            { date: cs.raporGanjil, name: 'Pembagian Rapor Ganjil', fillAfter: true, month: 11 },
            { date: cs.masukGenap, name: 'Awal Masuk Semester Genap', fillBefore: true, month: 0 },
            { date: cs.raporGenap, name: 'Pembagian Rapor Kenaikan', fillAfter: true, month: 5 }
        ];

        boundaries.forEach(b => {
            if (!b.date) return;
            addEvent(b.date, b.name);
            
            const [y, m, d] = b.date.split('-').map(Number);
            const lastDay = new Date(y, m, 0).getDate();
            
            if (b.fillBefore) {
                for (let i = 1; i < d; i++) {
                    addEvent(`${y}-${String(m).padStart(2, '0')}-${String(i).padStart(2, '0')}`, 'Libur Awal Semester');
                }
            }
            if (b.fillAfter) {
                for (let i = d + 1; i <= lastDay; i++) {
                    addEvent(`${y}-${String(m).padStart(2, '0')}-${String(i).padStart(2, '0')}`, 'Libur Akhir Semester');
                }
            }
        });

        // Custom holidays
        cs.customHolidays.split('\n').forEach(line => {
            const parts = line.split('=');
            if (parts.length >= 2) {
                addEvent(parts[0].trim(), parts[1].trim());
            }
        });

        AppState.eventList.sort((a, b) => new Date(a.date) - new Date(b.date));
    },

    getTeachingDates(hari, semester, year) {
        const dates = [];
        const startMonth = semester === 'Ganjil' ? 6 : 0;

        for (let i = 0; i < 6; i++) {
            let month = startMonth + i;
            let yr = year;
            if (month > 11) { month -= 12; yr++; }

            const daysInMonth = new Date(yr, month + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(yr, month, day);
                if (date.getDay() === parseInt(hari)) {
                    const dateStr = `${yr}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    if (!AppState.calendarEvents[dateStr]) {
                        dates.push({ date: dateStr, dateObj: date });
                    }
                }
            }
        }
        return dates;
    },

    formatDate(dateStr) {
        if (!dateStr) return '';
        const [y, m, d] = dateStr.split('-');
        return `${parseInt(d)} ${BULAN[parseInt(m) - 1]} ${y}`;
    }
};

// ==================== SUBSCRIPTION SYSTEM ====================
const SubscriptionSystem = {
    async checkSubscription() {
        try {
            const settingsDoc = await db.collection('settings').doc('global').get();
            if (settingsDoc.exists) {
                const settings = settingsDoc.data();
                AppState.settings = { ...AppState.settings, ...settings };
                
                const npsn = AppState.userProfile?.npsn;
                const email = AppState.currentUser?.email;
                
                if (npsn && settings.premiumNPSN?.includes(npsn)) AppState.isPro = true;
                if (settings.premiumUsers?.includes(email)) AppState.isPro = true;
                if (AppState.userProfile?.mapel?.toLowerCase().includes('pai') && settings.paiNPSN?.includes(npsn)) AppState.isPro = true;
            }

            if (AppState.isSuperAdmin) {
                AppState.isPro = true;
                AppState.isAdmin = true;
            }

            this.updateUI();
        } catch (error) {
            console.error('Check subscription error:', error);
        }
    },

    updateUI() {
        const badge = document.getElementById('user-badge');
        if (badge) {
            badge.className = AppState.isPro ? 'badge badge-pro text-[10px]' : 'badge badge-free text-[10px]';
            badge.textContent = AppState.isPro ? 'PRO' : 'FREE';
        }
    },

    checkAccess(feature) {
        const freeFeatures = ['kalender', 'doc-atp', 'dashboard', 'profil-guru', 'profil-sekolah', 'data-siswa', 'kurikulum', 'subscription'];
        if (freeFeatures.includes(feature) || AppState.isPro) return true;
        this.showUpgradeModal();
        return false;
    },

    showUpgradeModal() {
        const waBtn = document.getElementById('btn-wa-upgrade');
        if (waBtn) {
            waBtn.href = `https://wa.me/${AppState.settings.waNumber}?text=${encodeURIComponent('Halo, saya ingin upgrade ke versi PRO Admin Guru Super App')}`;
        }
        UISystem.openModal('modal-upgrade');
    }
};

// ==================== SUPER ADMIN SYSTEM ====================
const SuperAdminSystem = {
    async loadSettings() {
        try {
            const doc = await db.collection('settings').doc('global').get();
            if (doc.exists) {
                AppState.settings = { ...AppState.settings, ...doc.data() };
            }
        } catch (error) {
            console.error('Load settings error:', error);
        }
    },

    async saveSettings(data) {
        if (!AppState.isSuperAdmin) {
            UISystem.showToast('Akses ditolak', 'error');
            return false;
        }

        try {
            await db.collection('settings').doc('global').set(data, { merge: true });
            AppState.settings = { ...AppState.settings, ...data };
            UISystem.showToast('Pengaturan berhasil disimpan');
            return true;
        } catch (error) {
            console.error('Save settings error:', error);
            UISystem.showToast('Gagal menyimpan pengaturan', 'error');
            return false;
        }
    },

    async getAllSchools() {
        try {
            const snapshot = await db.collection('schools').get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) { return []; }
    },

    async getAllUsers() {
        try {
            const snapshot = await db.collection('users').get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) { return []; }
    }
};

// ==================== DOCUMENT ENGINE ====================
const DocumentEngine = {
    getIdentity() {
        const year = new Date().getFullYear();
        return {
            sekolah: AppState.schoolProfile?.nama || 'Nama Sekolah',
            npsn: AppState.schoolProfile?.npsn || '',
            alamat: AppState.schoolProfile?.alamat || '',
            kepsek: AppState.schoolProfile?.kepsek || 'Nama Kepala Sekolah',
            nipKepsek: AppState.schoolProfile?.nipKepsek || '',
            guru: AppState.userProfile?.name || 'Nama Guru',
            nipGuru: AppState.userProfile?.nip || '',
            mapel: AppState.selectedMapel || '',
            kelas: AppState.selectedKelas || '',
            semester: AppState.selectedSemester || '',
            fase: AppState.faseMap[AppState.selectedKelas] || '',
            tahun: year,
            tahunAjar: `${year}/${year + 1}`,
            rombel: AppState.userProfile?.rombel || 'A',
            tempat: AppState.schoolProfile?.kota || ''
        };
    },

    generateSignature(identity, customDate = null) {
        const tgl = customDate || '..............................';
        return `
            <div class="signature-area" contenteditable="true">
                <div class="signature-box">
                    <p>Mengetahui,</p>
                    <p>Kepala Sekolah</p>
                    <p class="signature-name">${identity.kepsek}</p>
                    <p>NIP. ${identity.nipKepsek}</p>
                </div>
                <div class="signature-box">
                    <p>${identity.tempat}, ${tgl}</p>
                    <p>Guru Mata Pelajaran</p>
                    <p class="signature-name">${identity.guru}</p>
                    <p>NIP. ${identity.nipGuru}</p>
                </div>
            </div>
        `;
    }
};

// ==================== AI SYSTEM ====================
const AISystem = {
    switchTab(tabName) {
        document.querySelectorAll('.ai-tab').forEach(tab => {
            tab.classList.remove('bg-white', 'text-primary-600', 'shadow');
            tab.classList.add('text-slate-500');
        });
        document.querySelectorAll('.ai-tab-content').forEach(content => content.classList.add('hidden'));

        const activeTab = document.querySelector(`.ai-tab[data-tab="${tabName}"]`);
        const activeContent = document.getElementById(`ai-tab-${tabName}`);
        
        if (activeTab) {
            activeTab.classList.remove('text-slate-500');
            activeTab.classList.add('bg-white', 'text-primary-600', 'shadow');
        }
        if (activeContent) activeContent.classList.remove('hidden');

        if (tabName === 'prompt') this.populateTPDropdown();
    },

    populateTPDropdown() {
        const select = document.getElementById('prompt-tp');
        if (!select) return;

        select.innerHTML = '<option value="">-- Pilih TP --</option>';
        
        const tps = CurriculumSystem.getAllTP(AppState.selectedMapel, AppState.selectedKelas, AppState.selectedSemester);

        tps.forEach((tp, i) => {
            const opt = document.createElement('option');
            opt.value = tp.tp;
            opt.textContent = `${i + 1}. ${tp.tp.substring(0, 60)}...`;
            select.appendChild(opt);
        });

        this.updatePrompt();
    },

    updatePrompt() {
        const type = document.getElementById('prompt-type')?.value || 'soal-pg';
        const count = document.getElementById('prompt-count')?.value || 10;
        const tp = document.getElementById('prompt-tp')?.value || '[Masukkan Tujuan Pembelajaran]';
        const result = document.getElementById('prompt-result');

        if (!result) return;

        const mapel = AppState.selectedMapel || '[Mata Pelajaran]';
        const kelas = AppState.selectedKelas || '[Kelas]';

        const prompts = {
            'soal-pg': `Buatkan ${count} soal PILIHAN GANDA untuk:
- Mata Pelajaran: ${mapel}
- Kelas: ${kelas}
- Tujuan Pembelajaran: ${tp}

Format output dalam CSV dengan header:
no,soal,opsi_a,opsi_b,opsi_c,opsi_d,kunci_jawaban

Ketentuan:
1. Soal sesuai dengan TP dan level kognitif bervariasi (C1-C4)
2. Opsi jawaban logis dan tidak ambigu
3. Kunci jawaban menggunakan huruf (A/B/C/D)
4. Bahasa Indonesia yang baik dan benar`,

            'soal-essay': `Buatkan ${count} soal ESSAY/URAIAN untuk:
- Mata Pelajaran: ${mapel}
- Kelas: ${kelas}
- Tujuan Pembelajaran: ${tp}

Format output dalam CSV dengan header:
no,soal,kunci_jawaban,skor

Ketentuan:
1. Soal menuntut analisis dan pemahaman mendalam
2. Kunci jawaban lengkap dengan poin-poin penting
3. Skor sesuai kompleksitas (5-20 poin)`,

            'soal-bs': `Buatkan ${count} soal BENAR/SALAH untuk:
- Mata Pelajaran: ${mapel}
- Kelas: ${kelas}
- Tujuan Pembelajaran: ${tp}

Format output dalam CSV dengan header:
no,pernyataan,jawaban,alasan

Ketentuan:
1. Pernyataan jelas dan tidak ambigu
2. Jawaban: BENAR atau SALAH
3. Berikan alasan singkat untuk setiap jawaban`,

            'soal-isian': `Buatkan ${count} soal ISIAN SINGKAT untuk:
- Mata Pelajaran: ${mapel}
- Kelas: ${kelas}
- Tujuan Pembelajaran: ${tp}

Format output dalam CSV dengan header:
no,soal,jawaban

Ketentuan:
1. Jawaban singkat (1-3 kata)
2. Gunakan tanda (...) untuk bagian yang harus diisi`,

            'soal-campuran': `Buatkan soal CAMPURAN untuk:
- Mata Pelajaran: ${mapel}
- Kelas: ${kelas}
- Tujuan Pembelajaran: ${tp}

Komposisi:
- 5 soal Pilihan Ganda
- 3 soal Isian Singkat  
- 2 soal Essay

Format output dalam CSV dengan header:
no,tipe,soal,opsi_a,opsi_b,opsi_c,opsi_d,kunci_jawaban

Keterangan tipe: PG/ISIAN/ESSAY`,

            'materi': `Buatkan RINGKASAN MATERI PEMBELAJARAN untuk:
- Mata Pelajaran: ${mapel}
- Kelas: ${kelas}
- Tujuan Pembelajaran: ${tp}

Struktur:
1. Pendahuluan (pengertian dasar)
2. Materi Inti (penjelasan lengkap dan sistematis)
3. Contoh Penerapan (minimal 2 contoh)
4. Rangkuman (poin-poin penting)

Gunakan bahasa yang mudah dipahami siswa ${kelas}.`,

            'lkpd': `Buatkan INSTRUKSI LKPD (Lembar Kerja Peserta Didik) untuk:
- Mata Pelajaran: ${mapel}
- Kelas: ${kelas}
- Tujuan Pembelajaran: ${tp}

Struktur LKPD:
1. Judul Kegiatan
2. Tujuan Pembelajaran
3. Petunjuk Pengerjaan
4. Aktivitas 1: Observasi/Pengamatan
5. Aktivitas 2: Diskusi Kelompok
6. Aktivitas 3: Latihan Mandiri
7. Pertanyaan Refleksi

Fokus pada pembelajaran aktif, kolaboratif, dan student-centered.`
        };

        result.value = prompts[type] || '';
    },

    copyPrompt() {
        const result = document.getElementById('prompt-result');
        if (result && result.value) {
            navigator.clipboard.writeText(result.value);
            UISystem.showToast('Prompt berhasil disalin!');
        }
    },

    openChatGPT() {
        window.open('https://chat.openai.com', '_blank');
    }
};

// ==================== UI SYSTEM ====================
const UISystem = {
    currentPage: 'dashboard',

    showLanding() {
        document.getElementById('landing-page').classList.remove('hidden');
        document.getElementById('main-app').classList.add('hidden');
    },

    showApp() {
        document.getElementById('landing-page').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        
        document.getElementById('user-name').textContent = AppState.userProfile?.name || AppState.currentUser?.displayName || 'User';
        document.getElementById('user-email').textContent = AppState.currentUser?.email || '';
        document.getElementById('user-avatar').textContent = (AppState.userProfile?.name || AppState.currentUser?.displayName || 'U')[0].toUpperCase();
        
        if (AppState.isSuperAdmin) {
            document.getElementById('nav-superadmin').classList.remove('hidden');
        }

        this.navigateTo('dashboard');
    },

    navigateTo(page) {
        const proFeatures = ['doc-promes', 'doc-modul', 'doc-lkpd', 'doc-jurnal', 'doc-absensi', 'doc-kktp', 'bank-soal'];
        if (proFeatures.includes(page) && !SubscriptionSystem.checkAccess(page)) return;

        this.currentPage = page;
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.page === page) item.classList.add('active');
        });

        this.renderPage(page);
        
        if (window.innerWidth < 1024) this.toggleSidebar(false);
    },

    renderPage(page) {
        const container = document.getElementById('page-container');
        container.className = 'p-4 lg:p-8 max-w-7xl mx-auto animate-fade-in';

        const pages = {
            'dashboard': PageRenderer.dashboard,
            'profil-guru': PageRenderer.profilGuru,
            'profil-sekolah': PageRenderer.profilSekolah,
            'data-siswa': PageRenderer.dataSiswa,
            'kurikulum': PageRenderer.kurikulum,
            'kalender': PageRenderer.kalender,
            'doc-atp': PageRenderer.docATP,
            'doc-promes': PageRenderer.docPromes,
            'doc-modul': PageRenderer.docModul,
            'doc-lkpd': PageRenderer.docLKPD,
            'doc-jurnal': PageRenderer.docJurnal,
            'doc-absensi': PageRenderer.docAbsensi,
            'doc-kktp': PageRenderer.docKKTP,
            'bank-soal': PageRenderer.bankSoal,
            'subscription': PageRenderer.subscription,
            'super-admin': PageRenderer.superAdmin
        };

        container.innerHTML = pages[page] ? pages[page]() : '<p>Halaman tidak ditemukan</p>';
        PageScripts.init(page);
    },

    toggleSidebar(show = null) {
        const sidebar = document.getElementById('app-sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        
        if (show === null) show = sidebar.classList.contains('-translate-x-full');

        sidebar.classList.toggle('-translate-x-full', !show);
        overlay.classList.toggle('hidden', !show);
    },

    openModal(id) { document.getElementById(id).style.display = 'flex'; },
    closeModal(id) { document.getElementById(id).style.display = 'none'; },
    
    showAIAssistant() {
        this.openModal('modal-ai');
        AISystem.switchTab('guide');
    },

    showLoading(text = 'Memuat...') {
        document.getElementById('loading-text').textContent = text;
        document.getElementById('loading-overlay').classList.remove('hidden');
    },

    hideLoading() {
        document.getElementById('loading-overlay').classList.add('hidden');
    },

    showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        document.getElementById('toast-icon').textContent = type === 'success' ? '‚úì' : '‚úó';
        document.getElementById('toast-message').textContent = message;
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
    }
};

// ==================== PAGE RENDERER ====================
const PageRenderer = {
    dashboard() {
        const identity = DocumentEngine.getIdentity();
        return `
            <div class="mb-8">
                <h1 class="text-2xl lg:text-3xl font-bold text-slate-800">Selamat Datang! üëã</h1>
                <p class="text-slate-600 mt-1">${identity.guru} ‚Ä¢ ${identity.sekolah}</p>
            </div>

            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 mb-8">
                <div class="stat-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-500 text-sm">Mata Pelajaran</p>
                            <p class="text-2xl font-bold text-slate-800">${CurriculumSystem.getMapels().length}</p>
                        </div>
                        <div class="stat-icon bg-primary-100">üìö</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-500 text-sm">Data Siswa</p>
                            <p class="text-2xl font-bold text-slate-800">${AppState.students.length}</p>
                        </div>
                        <div class="stat-icon bg-accent-100">üë•</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-500 text-sm">Jadwal</p>
                            <p class="text-2xl font-bold text-slate-800">${AppState.schedules.length}</p>
                        </div>
                        <div class="stat-icon bg-amber-100">üìÖ</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-500 text-sm">Status</p>
                            <p class="text-xl font-bold ${AppState.isPro ? 'text-amber-600' : 'text-accent-600'}">${AppState.isPro ? 'PRO' : 'FREE'}</p>
                        </div>
                        <div class="stat-icon bg-purple-100">üíé</div>
                    </div>
                </div>
            </div>

            <div class="grid lg:grid-cols-2 gap-6">
                <div class="card p-6">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">üöÄ Quick Start</h3>
                    <div class="space-y-3">
                        ${[
                            ['kurikulum', '1', 'Muat data kurikulum'],
                            ['profil-sekolah', '2', 'Lengkapi profil sekolah'],
                            ['data-siswa', '3', 'Input data siswa'],
                            ['kalender', '4', 'Atur jadwal mengajar'],
                            ['doc-atp', '5', 'Generate dokumen']
                        ].map(([page, num, text]) => `
                            <div onclick="UISystem.navigateTo('${page}')" class="flex items-center gap-4 p-3 bg-slate-50 rounded-xl hover:bg-primary-50 cursor-pointer transition group">
                                <span class="w-8 h-8 bg-primary-600 text-white rounded-lg flex items-center justify-center text-sm font-bold group-hover:scale-110 transition">${num}</span>
                                <span class="font-medium">${text}</span>
                                <span class="ml-auto text-slate-400 group-hover:text-primary-600 transition">‚Üí</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">üìÑ Dokumen Tersedia</h3>
                    <div class="grid grid-cols-2 gap-3">
                        ${[
                            ['doc-atp', 'üìã', 'ATP & Prota', 'FREE'],
                            ['kalender', 'üìÖ', 'Kalender', 'FREE'],
                            ['doc-promes', 'üìÜ', 'Promes', 'PRO'],
                            ['doc-modul', 'üìñ', 'Modul Ajar', 'PRO'],
                            ['doc-lkpd', 'üìù', 'LKPD', 'PRO'],
                            ['doc-jurnal', 'üìî', 'Jurnal', 'PRO'],
                            ['doc-absensi', '‚úÖ', 'Absensi', 'PRO'],
                            ['doc-kktp', 'üéØ', 'KKTP & Nilai', 'PRO']
                        ].map(([page, icon, name, type]) => `
                            <div onclick="UISystem.navigateTo('${page}')" class="p-4 border-2 border-slate-100 rounded-xl hover:border-primary-300 hover:bg-primary-50/50 cursor-pointer transition text-center group">
                                <span class="text-2xl block mb-2 group-hover:scale-110 transition">${icon}</span>
                                <p class="text-sm font-semibold">${name}</p>
                                <span class="badge ${type === 'FREE' ? 'badge-free' : 'badge-pro'} text-[9px] mt-2">${type}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    },

    profilGuru() {
        const p = AppState.userProfile || {};
        return `
            <div class="max-w-2xl mx-auto">
                <h1 class="text-2xl font-bold text-slate-800 mb-6">üë§ Profil Guru</h1>
                <div class="card p-6">
                    <form id="form-profil-guru" class="space-y-5">
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-slate-700">Nama Lengkap</label>
                            <input type="text" id="guru-nama" class="input-field" value="${p.name || ''}" placeholder="Nama lengkap dengan gelar">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-slate-700">NIP</label>
                            <input type="text" id="guru-nip" class="input-field" value="${p.nip || ''}" placeholder="Nomor Induk Pegawai">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-slate-700">Email</label>
                            <input type="email" class="input-field bg-slate-50" value="${p.email || ''}" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-slate-700">Tipe Guru</label>
                            <select id="guru-tipe" class="input-field">
                                <option value="mapel" ${p.tipeGuru === 'mapel' ? 'selected' : ''}>Guru Mata Pelajaran (mengajar 1 mapel di beberapa kelas)</option>
                                <option value="kelas" ${p.tipeGuru === 'kelas' ? 'selected' : ''}>Guru Kelas (mengajar beberapa mapel di 1 kelas)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-slate-700">Rombel Default</label>
                            <input type="text" id="guru-rombel" class="input-field" value="${p.rombel || 'A'}" placeholder="A/B/C">
                        </div>
                        <button type="submit" class="btn btn-primary w-full">üíæ Simpan Profil</button>
                    </form>
                </div>
            </div>
        `;
    },

    profilSekolah() {
        const s = AppState.schoolProfile || {};
        return `
            <div class="max-w-2xl mx-auto">
                <h1 class="text-2xl font-bold text-slate-800 mb-6">üè´ Profil Sekolah</h1>
                <div class="card p-6">
                    <div class="p-4 bg-blue-50 rounded-xl mb-6 border border-blue-200">
                        <p class="text-sm text-blue-700"><strong>üí° Kolaborasi:</strong> Guru dengan NPSN yang sama akan tergabung dalam satu sekolah dan dapat melihat jadwal guru lain.</p>
                    </div>
                    <form id="form-profil-sekolah" class="space-y-5">
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-slate-700">NPSN <span class="text-red-500">*</span></label>
                            <input type="text" id="sekolah-npsn" class="input-field" value="${s.npsn || ''}" placeholder="Nomor Pokok Sekolah Nasional" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-slate-700">Nama Sekolah</label>
                            <input type="text" id="sekolah-nama" class="input-field" value="${s.nama || ''}" placeholder="SDN/SMPN/SMAN ...">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-slate-700">Alamat</label>
                            <textarea id="sekolah-alamat" class="input-field" rows="2">${s.alamat || ''}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-slate-700">Kota/Kabupaten</label>
                            <input type="text" id="sekolah-kota" class="input-field" value="${s.kota || ''}" placeholder="Untuk tanda tangan dokumen">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-slate-700">Nama Kepala Sekolah</label>
                            <input type="text" id="sekolah-kepsek" class="input-field" value="${s.kepsek || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-slate-700">NIP Kepala Sekolah</label>
                            <input type="text" id="sekolah-nip-kepsek" class="input-field" value="${s.nipKepsek || ''}">
                        </div>
                        <button type="submit" class="btn btn-primary w-full">üíæ Simpan Data Sekolah</button>
                    </form>
                </div>
            </div>
        `;
    },

    dataSiswa() {
        return `
            <div class="max-w-4xl mx-auto">
                <h1 class="text-2xl font-bold text-slate-800 mb-6">üë• Data Siswa</h1>
                
                <div class="card p-6 mb-6">
                    <h3 class="font-bold mb-3">üìã Input Data Siswa</h3>
                    <p class="text-sm text-slate-600 mb-4">Format: <code class="bg-slate-100 px-2 py-1 rounded font-mono">nama;L/P;kelas</code> (satu baris per siswa)</p>
                    
                    <textarea id="input-siswa" class="input-field h-48 font-mono text-sm" placeholder="Ahmad Fulan;L;7A&#10;Siti Fulanah;P;7A&#10;Budi Santoso;L;7B"></textarea>
                    
                    <div class="flex gap-3 mt-4">
                        <button onclick="PageScripts.saveSiswa()" class="btn btn-primary flex-1">üíæ Simpan Data</button>
                        <label class="btn btn-secondary cursor-pointer">
                            üìÅ Import CSV
                            <input type="file" accept=".csv,.txt" class="hidden" onchange="PageScripts.importSiswaFile(this)">
                        </label>
                    </div>
                </div>
                
                <div class="card p-6">
                    <h3 class="font-bold mb-4">üìä Daftar Siswa (${AppState.students.length} siswa)</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-slate-100">
                                    <th class="px-4 py-3 text-left rounded-tl-lg">No</th>
                                    <th class="px-4 py-3 text-left">Nama Siswa</th>
                                    <th class="px-4 py-3 text-center">L/P</th>
                                    <th class="px-4 py-3 text-center rounded-tr-lg">Kelas</th>
                                </tr>
                            </thead>
                            <tbody id="tabel-siswa">
                                ${AppState.students.length > 0 ? AppState.students.map((s, i) => `
                                    <tr class="border-b hover:bg-slate-50">
                                        <td class="px-4 py-3">${i + 1}</td>
                                        <td class="px-4 py-3 font-medium">${typeof s === 'object' ? s.nama : s}</td>
                                        <td class="px-4 py-3 text-center">${s.jk || '-'}</td>
                                        <td class="px-4 py-3 text-center">${s.kelas || '-'}</td>
                                    </tr>
                                `).join('') : '<tr><td colspan="4" class="px-4 py-12 text-center text-slate-400">Belum ada data siswa</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    },

    kurikulum() {
        const mapels = CurriculumSystem.getMapels();
        return `
            <div class="max-w-4xl mx-auto">
                <h1 class="text-2xl font-bold text-slate-800 mb-6">üìö Kurikulum & Mapel</h1>
                
                <div class="grid lg:grid-cols-2 gap-6 mb-6">
                    <div class="card p-6">
                        <h3 class="font-bold mb-4">üì• Muat Data Kurikulum</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-2 text-slate-700">Jenjang Pendidikan</label>
                            <select id="select-jenjang" class="input-field">
                                <option value="SD">SD / MI</option>
                                <option value="SMP">SMP / MTs</option>
                                <option value="SMA">SMA / SMK / MA</option>
                            </select>
                        </div>
                        <button onclick="PageScripts.loadKurikulum()" class="btn btn-warning w-full mb-3">‚òÅÔ∏è Load dari Cloud</button>
                        <label class="btn btn-secondary w-full cursor-pointer block text-center">
                            üìÅ Upload CSV Manual
                            <input type="file" id="file-csv" accept=".csv" class="hidden" onchange="PageScripts.uploadCSV(this)">
                        </label>
                        <div id="csv-status" class="hidden mt-4"></div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="font-bold mb-4">üéØ Pilih Mapel & Kelas</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700">Mata Pelajaran</label>
                                <select id="select-mapel" class="input-field" onchange="PageScripts.onMapelChange()">
                                    <option value="">-- Pilih Mapel --</option>
                                    ${mapels.map(m => `<option value="${m}" ${AppState.selectedMapel === m ? 'selected' : ''}>${m}</option>`).join('')}
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-slate-700">Kelas</label>
                                    <select id="select-kelas" class="input-field" onchange="PageScripts.onKelasChange()"><option value="">-</option></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-slate-700">Semester</label>
                                    <select id="select-semester" class="input-field" onchange="PageScripts.onSemesterChange()"><option value="">-</option></select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700">Elemen/Bab</label>
                                <select id="select-elemen" class="input-field" onchange="PageScripts.onElemenChange()"><option value="">-- Semua --</option></select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <h3 class="font-bold mb-4">üìã Preview Tujuan Pembelajaran</h3>
                    <div id="list-tp" class="space-y-3 max-h-96 overflow-y-auto">
                        <p class="text-slate-400 italic text-center py-8">Pilih mapel, kelas, dan semester untuk melihat TP</p>
                    </div>
                </div>
            </div>
        `;
    },

    kalender() {
        const cs = AppState.calendarSettings;
        const tipeGuru = AppState.userProfile?.tipeGuru || 'mapel';
        
        return `
            <div class="max-w-5xl mx-auto">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <h1 class="text-2xl font-bold text-slate-800">üìÖ Kalender & Jadwal Mengajar</h1>
                    <button onclick="window.print()" class="btn btn-secondary no-print">üñ®Ô∏è Cetak</button>
                </div>
                
                <!-- Jadwal Mengajar -->
                <div class="card p-6 mb-6 no-print">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold">üìÜ Jadwal Mengajar (${tipeGuru === 'mapel' ? 'Multi-Kelas' : 'Multi-Mapel'})</h3>
                        <button onclick="PageScripts.addSchedule()" class="btn btn-sm btn-primary">+ Tambah Jadwal</button>
                    </div>
                    <p class="text-sm text-slate-600 mb-4">
                        ${tipeGuru === 'mapel' 
                            ? 'üí° Sebagai Guru Mapel, Anda mengajar 1 mata pelajaran di beberapa kelas berbeda.' 
                            : 'üí° Sebagai Guru Kelas, Anda mengajar beberapa mata pelajaran di 1 kelas.'}
                    </p>
                    
                    <div id="schedule-list" class="space-y-2">
                        ${AppState.schedules.length > 0 ? AppState.schedules.map((s, i) => PageScripts.renderScheduleRow(s, i)).join('') : `
                            <div class="text-center py-8 text-slate-400">
                                <p>Belum ada jadwal. Klik tombol + Tambah Jadwal.</p>
                            </div>
                        `}
                    </div>
                    
                    <button onclick="PageScripts.saveSchedules()" class="btn btn-success w-full mt-4">üíæ Simpan Jadwal</button>
                </div>
                
                <!-- Pengaturan Kalender -->
                <div class="card p-6 mb-6 no-print">
                    <h3 class="font-bold mb-4">‚öôÔ∏è Pengaturan Kalender Akademik</h3>
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-semibold mb-1 text-slate-600">Awal Masuk (Juli)</label>
                            <input type="date" id="cal-masuk-ganjil" class="input-field text-sm" value="${cs.masukGanjil}">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold mb-1 text-slate-600">Rapor Ganjil (Des)</label>
                            <input type="date" id="cal-rapor-ganjil" class="input-field text-sm" value="${cs.raporGanjil}">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold mb-1 text-slate-600">Awal Masuk (Jan)</label>
                            <input type="date" id="cal-masuk-genap" class="input-field text-sm" value="${cs.masukGenap}">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold mb-1 text-slate-600">Rapor Genap (Jun)</label>
                            <input type="date" id="cal-rapor-genap" class="input-field text-sm" value="${cs.raporGenap}">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold mb-1 text-slate-600">Libur & Agenda Kustom (YYYY-MM-DD = Keterangan)</label>
                        <textarea id="cal-libur" class="input-field h-32 font-mono text-xs">${cs.customHolidays}</textarea>
                    </div>
                    <button onclick="PageScripts.generateKalender()" class="btn btn-primary mt-4">üîÑ Generate Kalender</button>
                </div>
                
                <!-- Output Kalender -->
                <div id="output-kalender"></div>
            </div>
        `;
    },

    docATP() {
        return `
            <div>
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6 no-print">
                    <h1 class="text-2xl font-bold text-slate-800">üìã ATP & Prota</h1>
                    <div class="flex gap-3">
                        <select id="atp-mode" class="input-field w-auto" onchange="PageScripts.generateATP()">
                            <option value="semester">1 Semester</option>
                            <option value="tahun">1 Tahun Penuh</option>
                        </select>
                        <button onclick="window.print()" class="btn btn-secondary">üñ®Ô∏è Cetak PDF</button>
                    </div>
                </div>
                <div id="output-atp"></div>
            </div>
        `;
    },

    docPromes() {
        return `
            <div>
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6 no-print">
                    <h1 class="text-2xl font-bold text-slate-800">üìÜ Program Semester</h1>
                    <div class="flex gap-3">
                        <select id="promes-paper" class="input-field w-auto">
                            <option value="a4">A4 Landscape</option>
                            <option value="f4">F4/Folio Landscape</option>
                        </select>
                        <button onclick="window.print()" class="btn btn-secondary">üñ®Ô∏è Cetak PDF</button>
                    </div>
                </div>
                <div id="output-promes"></div>
            </div>
        `;
    },

    docModul() {
        return `
            <div>
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6 no-print">
                    <h1 class="text-2xl font-bold text-slate-800">üìñ Modul Ajar</h1>
                    <button onclick="window.print()" class="btn btn-secondary">üñ®Ô∏è Cetak PDF</button>
                </div>
                <div id="output-modul"></div>
            </div>
        `;
    },

    docLKPD() {
        return `
            <div>
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6 no-print">
                    <h1 class="text-2xl font-bold text-slate-800">üìù LKPD</h1>
                    <button onclick="window.print()" class="btn btn-secondary">üñ®Ô∏è Cetak PDF</button>
                </div>
                <div id="output-lkpd"></div>
            </div>
        `;
    },

    docJurnal() {
        return `
            <div>
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6 no-print">
                    <h1 class="text-2xl font-bold text-slate-800">üìî Jurnal Pembelajaran</h1>
                    <div class="flex gap-3">
                        <select id="jurnal-paper" class="input-field w-auto">
                            <option value="a4">A4 Landscape</option>
                            <option value="f4">F4/Folio Landscape</option>
                        </select>
                        <button onclick="window.print()" class="btn btn-secondary">üñ®Ô∏è Cetak PDF</button>
                    </div>
                </div>
                <div id="output-jurnal"></div>
            </div>
        `;
    },

    docAbsensi() {
        return `
            <div>
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6 no-print">
                    <h1 class="text-2xl font-bold text-slate-800">‚úÖ Absensi Siswa</h1>
                    <button onclick="window.print()" class="btn btn-secondary">üñ®Ô∏è Cetak PDF</button>
                </div>
                <div id="output-absensi"></div>
            </div>
        `;
    },

    docKKTP() {
        return `
            <div>
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6 no-print">
                    <h1 class="text-2xl font-bold text-slate-800">üéØ KKTP & Nilai</h1>
                    <button onclick="window.print()" class="btn btn-secondary">üñ®Ô∏è Cetak PDF</button>
                </div>
                <div id="output-kktp"></div>
            </div>
        `;
    },

    bankSoal() {
        return `
            <div class="max-w-4xl mx-auto">
                <h1 class="text-2xl font-bold text-slate-800 mb-6">‚ùì Bank Soal</h1>
                
                <div class="grid lg:grid-cols-2 gap-6 mb-6">
                    <div class="card p-6">
                        <h3 class="font-bold mb-4">‚öôÔ∏è Pengaturan Soal</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Tujuan Pembelajaran</label>
                                <select id="soal-tp" class="input-field"><option value="">-- Pilih TP --</option></select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Tipe Soal</label>
                                    <select id="soal-tipe" class="input-field">
                                        <option value="pg">Pilihan Ganda</option>
                                        <option value="bs">Benar/Salah</option>
                                        <option value="isian">Isian Singkat</option>
                                        <option value="essay">Essay</option>
                                        <option value="campuran">Campuran</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Jumlah</label>
                                    <input type="number" id="soal-jumlah" class="input-field" value="10" min="1" max="50">
                                </div>
                            </div>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="soal-random" checked class="w-5 h-5 rounded border-slate-300 text-primary-600">
                                <span class="text-sm font-medium">Acak urutan soal</span>
                            </label>
                        </div>
                        <button onclick="UISystem.showAIAssistant()" class="btn w-full mt-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white">ü§ñ Generate dengan AI</button>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="font-bold mb-4">üì• Import Soal (CSV)</h3>
                        <p class="text-sm text-slate-600 mb-3">Paste hasil generate AI dalam format CSV:</p>
                        <textarea id="input-soal-csv" class="input-field h-40 font-mono text-xs" placeholder="no,soal,kunci_jawaban&#10;1,Pertanyaan...,Jawaban..."></textarea>
                        <button onclick="PageScripts.importSoalCSV()" class="btn btn-primary w-full mt-3">üìã Import & Parse</button>
                    </div>
                </div>
                
                <div class="card p-6">
                    <h3 class="font-bold mb-4">üìù Daftar Soal</h3>
                    <div id="list-soal" class="space-y-4">
                        <p class="text-slate-400 italic text-center py-8">Belum ada soal. Generate atau import soal untuk memulai.</p>
                    </div>
                </div>
            </div>
        `;
    },

    subscription() {
        return `
            <div class="max-w-2xl mx-auto">
                <h1 class="text-2xl font-bold text-slate-800 mb-6">üíé Subscription</h1>
                
                <div class="card p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="font-bold text-lg">Status Langganan</h3>
                            <p class="text-slate-500">Akun: ${AppState.currentUser?.email}</p>
                        </div>
                        <span class="badge ${AppState.isPro ? 'badge-pro' : 'badge-free'} text-base px-4 py-2">${AppState.isPro ? 'üëë PRO' : 'FREE'}</span>
                    </div>
                    
                    ${AppState.isPro ? `
                        <div class="p-4 bg-green-50 rounded-xl border border-green-200">
                            <p class="text-green-700 font-medium">‚úÖ Anda memiliki akses penuh ke semua fitur PRO!</p>
                        </div>
                    ` : `
                        <div class="p-4 bg-amber-50 rounded-xl border border-amber-200 mb-4">
                            <p class="text-amber-700 font-medium">‚ö†Ô∏è Upgrade ke PRO untuk akses fitur lengkap!</p>
                        </div>
                        <a href="https://wa.me/${AppState.settings.waNumber}?text=${encodeURIComponent('Halo, saya ingin upgrade ke versi PRO Admin Guru Super App')}" target="_blank" class="btn btn-success w-full">
                            üí¨ Hubungi WhatsApp untuk Upgrade
                        </a>
                    `}
                </div>
                
                <div class="card p-6">
                    <h3 class="font-bold mb-4">üìä Perbandingan Fitur</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead><tr class="border-b-2"><th class="text-left py-3">Fitur</th><th class="text-center py-3">FREE</th><th class="text-center py-3">PRO</th></tr></thead>
                            <tbody>
                                ${[
                                    ['ATP & Prota', true, true],
                                    ['Kalender & Jadwal Multi', true, true],
                                    ['Promes (A4/F4 Landscape)', false, true],
                                    ['Modul Ajar', false, true],
                                    ['LKPD', false, true],
                                    ['Jurnal Pembelajaran', false, true],
                                    ['Absensi Interaktif', false, true],
                                    ['KKTP & Daftar Nilai', false, true],
                                    ['Bank Soal + AI Generator', false, true],
                                    ['Kolaborasi Sekolah (NPSN)', false, true]
                                ].map(([name, free, pro]) => `
                                    <tr class="border-b"><td class="py-3">${name}</td><td class="text-center py-3 ${free ? 'text-green-600' : 'text-slate-300'}">${free ? '‚úì' : '‚úó'}</td><td class="text-center py-3 text-green-600">‚úì</td></tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    },

    superAdmin() {
        if (!AppState.isSuperAdmin) return '<div class="card p-6"><p class="text-red-600 font-medium">‚õî Akses ditolak</p></div>';
        
        return `
            <div class="max-w-4xl mx-auto">
                <h1 class="text-2xl font-bold text-slate-800 mb-6">üëë Super Admin Panel</h1>
                
                <div class="grid lg:grid-cols-2 gap-6 mb-6">
                    <div class="card p-6">
                        <h3 class="font-bold mb-4">‚öôÔ∏è Pengaturan Global</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Nomor WhatsApp Upgrade</label>
                                <input type="text" id="admin-wa" class="input-field" value="${AppState.settings.waNumber || ''}" placeholder="62812xxx">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">NPSN Premium (pisahkan dengan koma)</label>
                                <textarea id="admin-premium-npsn" class="input-field h-20 font-mono text-sm">${(AppState.settings.premiumNPSN || []).join(', ')}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">NPSN Guru PAI Gratis</label>
                                <textarea id="admin-pai-npsn" class="input-field h-20 font-mono text-sm">${(AppState.settings.paiNPSN || []).join(', ')}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Email User Premium (satu per baris)</label>
                                <textarea id="admin-premium-users" class="input-field h-20 font-mono text-sm">${(AppState.settings.premiumUsers || []).join('\n')}</textarea>
                            </div>
                            <button onclick="PageScripts.saveAdminSettings()" class="btn btn-primary w-full">üíæ Simpan Pengaturan</button>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="font-bold mb-4">üìä Statistik</h3>
                        <div id="admin-stats" class="space-y-4">
                            <div class="animate-shimmer h-12 rounded-lg"></div>
                            <div class="animate-shimmer h-12 rounded-lg"></div>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <h3 class="font-bold mb-4">üè´ Daftar Sekolah Terdaftar</h3>
                    <div id="admin-schools" class="overflow-x-auto">
                        <div class="animate-shimmer h-32 rounded-lg"></div>
                    </div>
                </div>
            </div>
        `;
    }
};

// ==================== PAGE SCRIPTS ====================
const PageScripts = {
    init(page) {
        switch (page) {
            case 'profil-guru':
                document.getElementById('form-profil-guru')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await ProfileSystem.saveProfile({
                        name: document.getElementById('guru-nama').value,
                        nip: document.getElementById('guru-nip').value,
                        tipeGuru: document.getElementById('guru-tipe').value,
                        rombel: document.getElementById('guru-rombel').value
                    });
                });
                break;

            case 'profil-sekolah':
                document.getElementById('form-profil-sekolah')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await SchoolSystem.saveSchool({
                        npsn: document.getElementById('sekolah-npsn').value,
                        nama: document.getElementById('sekolah-nama').value,
                        alamat: document.getElementById('sekolah-alamat').value,
                        kota: document.getElementById('sekolah-kota').value,
                        kepsek: document.getElementById('sekolah-kepsek').value,
                        nipKepsek: document.getElementById('sekolah-nip-kepsek').value
                    });
                });
                break;

            case 'data-siswa':
                if (AppState.students.length > 0) {
                    document.getElementById('input-siswa').value = AppState.students.map(s => 
                        typeof s === 'object' ? `${s.nama};${s.jk || ''};${s.kelas || ''}` : s
                    ).join('\n');
                }
                break;

            case 'kurikulum':
                this.updateKurikulumDropdowns();
                break;

            case 'kalender':
                CalendarSystem.init();
                this.generateKalender();
                break;

            case 'doc-atp':
                this.generateATP();
                break;

            case 'doc-promes':
                this.generatePromes();
                break;

            case 'doc-modul':
                this.generateModul();
                break;

            case 'doc-lkpd':
                this.generateLKPD();
                break;

            case 'doc-jurnal':
                this.generateJurnal();
                break;

            case 'doc-absensi':
                this.generateAbsensi();
                break;

            case 'doc-kktp':
                this.generateKKTP();
                break;

            case 'bank-soal':
                this.populateSoalTP();
                break;

            case 'super-admin':
                this.loadAdminData();
                break;
        }
    },

    // ============ SISWA ============
    saveSiswa() {
        const input = document.getElementById('input-siswa').value;
        const lines = input.split('\n').filter(l => l.trim());
        
        AppState.students = lines.map(line => {
            const parts = line.split(';').map(p => p.trim());
            return { nama: parts[0] || '', jk: parts[1] || '', kelas: parts[2] || '' };
        });

        localStorage.setItem('agsa_students', JSON.stringify(AppState.students));
        UISystem.showToast(`Berhasil menyimpan ${AppState.students.length} data siswa`);
        UISystem.navigateTo('data-siswa');
    },

    importSiswaFile(input) {
        if (!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('input-siswa').value = e.target.result;
            UISystem.showToast('File berhasil dimuat');
        };
        reader.readAsText(input.files[0]);
    },

    // ============ KURIKULUM ============
    loadKurikulum() {
        const jenjang = document.getElementById('select-jenjang').value;
        CurriculumSystem.fetchFromCloud(jenjang);
    },

    uploadCSV(input) {
        if (!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            CurriculumSystem.parseCSV(e.target.result);
            UISystem.showToast('File CSV berhasil dimuat');
        };
        reader.readAsText(input.files[0]);
    },

    updateKurikulumDropdowns() {
        const mapelSelect = document.getElementById('select-mapel');
        if (!mapelSelect) return;

        const mapels = CurriculumSystem.getMapels();
        mapelSelect.innerHTML = '<option value="">-- Pilih Mapel --</option>' + 
            mapels.map(m => `<option value="${m}" ${AppState.selectedMapel === m ? 'selected' : ''}>${m}</option>`).join('');

        if (AppState.selectedMapel) this.onMapelChange();
    },

    onMapelChange() {
        const mapel = document.getElementById('select-mapel').value;
        AppState.selectedMapel = mapel;

        const kelasSelect = document.getElementById('select-kelas');
        const kelasList = CurriculumSystem.getKelas(mapel);
        kelasSelect.innerHTML = '<option value="">-</option>' + 
            kelasList.map(k => {
                const fase = AppState.faseMap[k] || '';
                return `<option value="${k}">${k} ${fase ? `(${fase})` : ''}</option>`;
            }).join('');

        document.getElementById('select-semester').innerHTML = '<option value="">-</option>';
        document.getElementById('select-elemen').innerHTML = '<option value="">-- Semua --</option>';
        this.showTPPreview();
    },

    onKelasChange() {
        const kelas = document.getElementById('select-kelas').value;
        AppState.selectedKelas = kelas;

        const semesterSelect = document.getElementById('select-semester');
        const semesters = CurriculumSystem.getSemesters(AppState.selectedMapel, kelas);
        semesterSelect.innerHTML = '<option value="">-</option>' + 
            semesters.map(s => `<option value="${s}">${s}</option>`).join('');

        document.getElementById('select-elemen').innerHTML = '<option value="">-- Semua --</option>';
        this.showTPPreview();
    },

    onSemesterChange() {
        const semester = document.getElementById('select-semester').value;
        AppState.selectedSemester = semester;

        const elemenSelect = document.getElementById('select-elemen');
        const elemens = CurriculumSystem.getElemen(AppState.selectedMapel, AppState.selectedKelas, semester);
        elemenSelect.innerHTML = '<option value="">-- Semua Elemen --</option>' + 
            elemens.map(e => `<option value="${e}">${e.substring(0, 60)}...</option>`).join('');

        this.showTPPreview();
    },

    onElemenChange() {
        AppState.selectedElemen = document.getElementById('select-elemen').value;
        this.showTPPreview();
    },

    showTPPreview() {
        const container = document.getElementById('list-tp');
        if (!container) return;

        const tps = CurriculumSystem.getAllTP(AppState.selectedMapel, AppState.selectedKelas, AppState.selectedSemester);
        
        if (tps.length === 0) {
            container.innerHTML = '<p class="text-slate-400 italic text-center py-8">Pilih mapel, kelas, dan semester untuk melihat TP</p>';
            return;
        }

        container.innerHTML = tps.map((tp, i) => `
            <div class="p-4 bg-slate-50 rounded-xl border border-slate-200 hover:border-primary-300 transition">
                <div class="flex items-start gap-3">
                    <span class="w-7 h-7 bg-primary-600 text-white rounded-lg flex items-center justify-center text-xs font-bold flex-shrink-0">${i + 1}</span>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium text-slate-800 text-sm">${tp.tp}</p>
                        <p class="text-xs text-slate-500 mt-1 truncate">Elemen: ${tp.elemen}</p>
                    </div>
                </div>
            </div>
        `).join('');
    },

    // ============ JADWAL / SCHEDULE ============
    renderScheduleRow(s, index) {
        const tipeGuru = AppState.userProfile?.tipeGuru || 'mapel';
        const mapels = CurriculumSystem.getMapels();
        const kelasList = tipeGuru === 'mapel' && AppState.selectedMapel 
            ? CurriculumSystem.getKelas(AppState.selectedMapel) 
            : ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];

        return `
            <div class="schedule-row" data-index="${index}">
                <select class="sch-hari" value="${s.hari || '1'}">
                    ${HARI.map((h, i) => `<option value="${i}" ${s.hari == i ? 'selected' : ''}>${h}</option>`).join('')}
                </select>
                ${tipeGuru === 'mapel' ? `
                    <select class="sch-kelas">
                        ${kelasList.map(k => `<option value="${k}" ${s.kelas === k ? 'selected' : ''}>${k}</option>`).join('')}
                    </select>
                    <input type="text" class="sch-mapel" value="${s.mapel || AppState.selectedMapel || ''}" placeholder="Mata Pelajaran">
                ` : `
                    <input type="text" class="sch-kelas" value="${s.kelas || AppState.selectedKelas || ''}" placeholder="Kelas">
                    <select class="sch-mapel">
                        <option value="">-- Pilih Mapel --</option>
                        ${mapels.map(m => `<option value="${m}" ${s.mapel === m ? 'selected' : ''}>${m}</option>`).join('')}
                    </select>
                `}
                <input type="text" class="sch-rombel" value="${s.rombel || 'A'}" placeholder="Rombel">
                <input type="number" class="sch-jp" value="${s.jp || 2}" min="1" max="10" placeholder="JP">
                <button onclick="PageScripts.removeSchedule(${index})" class="btn btn-sm btn-danger">‚úï</button>
            </div>
        `;
    },

    addSchedule() {
        const tipeGuru = AppState.userProfile?.tipeGuru || 'mapel';
        AppState.schedules.push({
            hari: 1,
            mapel: tipeGuru === 'mapel' ? AppState.selectedMapel : '',
            kelas: tipeGuru === 'kelas' ? AppState.selectedKelas : '',
            rombel: 'A',
            jp: 2
        });
        this.refreshScheduleList();
    },

    removeSchedule(index) {
        AppState.schedules.splice(index, 1);
        this.refreshScheduleList();
    },

    refreshScheduleList() {
        const container = document.getElementById('schedule-list');
        if (!container) return;

        if (AppState.schedules.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-slate-400"><p>Belum ada jadwal. Klik tombol + Tambah Jadwal.</p></div>';
        } else {
            container.innerHTML = AppState.schedules.map((s, i) => this.renderScheduleRow(s, i)).join('');
        }
    },

    async saveSchedules() {
        const rows = document.querySelectorAll('.schedule-row');
        AppState.schedules = Array.from(rows).map(row => ({
            hari: row.querySelector('.sch-hari')?.value || '1',
            kelas: row.querySelector('.sch-kelas')?.value || '',
            mapel: row.querySelector('.sch-mapel')?.value || '',
            rombel: row.querySelector('.sch-rombel')?.value || 'A',
            jp: parseInt(row.querySelector('.sch-jp')?.value) || 2
        }));

        await ProfileSystem.saveProfile({ schedules: AppState.schedules });
        UISystem.showToast('Jadwal berhasil disimpan');
    },

    // ============ KALENDER ============
    generateKalender() {
        // Update settings
        AppState.calendarSettings = {
            masukGanjil: document.getElementById('cal-masuk-ganjil')?.value || AppState.calendarSettings.masukGanjil,
            raporGanjil: document.getElementById('cal-rapor-ganjil')?.value || AppState.calendarSettings.raporGanjil,
            masukGenap: document.getElementById('cal-masuk-genap')?.value || AppState.calendarSettings.masukGenap,
            raporGenap: document.getElementById('cal-rapor-genap')?.value || AppState.calendarSettings.raporGenap,
            customHolidays: document.getElementById('cal-libur')?.value || AppState.calendarSettings.customHolidays
        };

        CalendarSystem.generateCalendar();
        
        const identity = DocumentEngine.getIdentity();
        const container = document.getElementById('output-kalender');
        if (!container) return;

        // Build schedule table
        let scheduleRows = '';
        if (AppState.schedules.length > 0) {
            scheduleRows = AppState.schedules.map(s => `
                <tr>
                    <td class="text-center font-bold text-primary-700">${HARI[s.hari] || 'Senin'}</td>
                    <td class="text-center">Menyesuaikan</td>
                    <td class="font-semibold">${s.mapel || identity.mapel || '-'}</td>
                    <td class="text-center">${s.kelas || identity.kelas || '-'}${s.rombel ? '/' + s.rombel : ''}</td>
                    <td class="text-center font-bold">${s.jp || 2} JP</td>
                </tr>
            `).join('');
        } else {
            scheduleRows = `<tr><td colspan="5" class="text-center py-4 text-slate-400 italic">Belum ada jadwal</td></tr>`;
        }

        // Build event list
        const eventRows = this.renderEventList();

        container.innerHTML = `
            <div class="paper-preview portrait">
                <h1 class="text-center text-base font-bold mb-6 uppercase" contenteditable="true">
                    KALENDER PENDIDIKAN & JADWAL PELAJARAN<br>
                    TAHUN PELAJARAN ${identity.tahunAjar}
                </h1>
                
                <table class="doc-table mb-6" style="width: auto;">
                    <tr><td width="150"><strong>Nama Sekolah</strong></td><td>: ${identity.sekolah}</td></tr>
                    <tr><td><strong>NPSN</strong></td><td>: ${identity.npsn || '-'}</td></tr>
                    <tr><td><strong>Guru</strong></td><td>: ${identity.guru}</td></tr>
                </table>
                
                <div class="font-bold bg-slate-100 p-2 border-l-4 border-primary-600 mb-3">A. JADWAL MENGAJAR</div>
                <table class="doc-table mb-6">
                    <thead>
                        <tr>
                            <th width="15%">Hari</th>
                            <th width="20%">Waktu</th>
                            <th width="30%">Mata Pelajaran</th>
                            <th width="20%">Kelas/Rombel</th>
                            <th width="15%">JP</th>
                        </tr>
                    </thead>
                    <tbody>${scheduleRows}</tbody>
                </table>
                
                <div class="font-bold bg-slate-100 p-2 border-l-4 border-primary-600 mb-3">B. RINCIAN AGENDA & HARI LIBUR</div>
                <table class="doc-table">
                    <thead>
                        <tr><th width="30%">Tanggal</th><th>Keterangan</th></tr>
                    </thead>
                    <tbody>${eventRows}</tbody>
                </table>
                
                ${DocumentEngine.generateSignature(identity)}
            </div>
        `;
    },

    renderEventList() {
        if (AppState.eventList.length === 0) {
            return '<tr><td colspan="2" class="text-center py-4 italic text-slate-400">Belum ada data kegiatan</td></tr>';
        }

        // Group consecutive same events
        const grouped = [];
        let current = null;

        AppState.eventList.forEach(ev => {
            if (!current) {
                current = { start: ev.date, end: ev.date, name: ev.name };
            } else if (current.name === ev.name) {
                current.end = ev.date;
            } else {
                grouped.push(current);
                current = { start: ev.date, end: ev.date, name: ev.name };
            }
        });
        if (current) grouped.push(current);

        return grouped.slice(0, 30).map(g => {
            const dateText = g.start === g.end 
                ? CalendarSystem.formatDate(g.start)
                : `${CalendarSystem.formatDate(g.start)} s.d ${CalendarSystem.formatDate(g.end)}`;
            const isLibur = g.name.toLowerCase().includes('libur');
            return `<tr class="${isLibur ? 'bg-red-50' : ''}"><td class="font-semibold">${dateText}</td><td contenteditable="true">${g.name}</td></tr>`;
        }).join('');
    },

    // ============ ATP & PROTA ============
    generateATP() {
        const container = document.getElementById('output-atp');
        if (!container) return;

        if (!AppState.selectedMapel || !AppState.selectedKelas || !AppState.selectedSemester) {
            container.innerHTML = `
                <div class="card p-12 text-center">
                    <p class="text-slate-500 mb-4">Pilih Mapel, Kelas, dan Semester di menu <strong>Kurikulum & Mapel</strong> terlebih dahulu.</p>
                    <button onclick="UISystem.navigateTo('kurikulum')" class="btn btn-primary">Buka Kurikulum</button>
                </div>
            `;
            return;
        }

        const identity = DocumentEngine.getIdentity();
        const mode = document.getElementById('atp-mode')?.value || 'semester';
        
        let dataToRender = [];
        
        if (mode === 'tahun') {
            ['Ganjil', 'Genap'].forEach(smt => {
                const data = AppState.curriculum[AppState.selectedMapel]?.[AppState.selectedKelas]?.[smt];
                if (data) {
                    Object.keys(data).forEach(elemen => {
                        dataToRender.push({ semester: smt, elemen, data: data[elemen] });
                    });
                }
            });
        } else {
            const data = AppState.curriculum[AppState.selectedMapel]?.[AppState.selectedKelas]?.[AppState.selectedSemester];
            if (data) {
                Object.keys(data).forEach(elemen => {
                    dataToRender.push({ semester: AppState.selectedSemester, elemen, data: data[elemen] });
                });
            }
        }

        if (dataToRender.length === 0) {
            container.innerHTML = '<div class="card p-12 text-center"><p class="text-slate-500">Tidak ada data untuk ditampilkan</p></div>';
            return;
        }

        // Generate ATP rows
        let atpRows = '';
        let protaRows = '';
        const jp = AppState.schedules.length > 0 ? (AppState.schedules[0].jp || 2) : 2;

        dataToRender.forEach((item, idx) => {
            const tps = item.data.tps || [];
            const totalJP = tps.length * jp;

            tps.forEach((tp, tpIdx) => {
                const kompetensi = this.extractKompetensi(tp.tp);
                
                atpRows += `<tr>`;
                if (tpIdx === 0) {
                    atpRows += `
                        <td rowspan="${tps.length}" class="text-center align-middle">${idx + 1}</td>
                        <td rowspan="${tps.length}" class="align-middle bg-slate-50 p-2" contenteditable="true">
                            <strong class="text-primary-800">${item.elemen}</strong>
                            <hr class="my-2 border-slate-300">
                            <span class="text-xs text-slate-600">${item.data.cp}</span>
                        </td>
                    `;
                }
                atpRows += `
                    <td contenteditable="true">${tp.tp}</td>
                    <td class="text-xs text-center">Beriman, Bernalar Kritis</td>
                    <td class="text-center font-semibold text-amber-600">${kompetensi}</td>
                `;
                if (tpIdx === 0) {
                    atpRows += `<td rowspan="${tps.length}" class="text-center align-middle">${tps.length} Mgg<br>${totalJP} JP</td>`;
                }
                atpRows += `</tr>`;

                // Prota rows
                protaRows += `<tr>`;
                if (tpIdx === 0) {
                    protaRows += `
                        <td rowspan="${tps.length}" class="text-center align-middle font-bold">${item.semester}</td>
                        <td rowspan="${tps.length}" class="align-middle bg-slate-50 p-2" contenteditable="true">
                            <strong class="text-primary-800">${item.elemen}</strong>
                            <hr class="my-2 border-slate-300">
                            <span class="text-xs text-slate-600">${item.data.cp}</span>
                        </td>
                    `;
                }
                protaRows += `<td contenteditable="true">${tp.tp}</td>`;
                if (tpIdx === 0) {
                    protaRows += `<td rowspan="${tps.length}" class="text-center align-middle font-bold">${totalJP} JP</td>`;
                }
                protaRows += `</tr>`;
            });
        });

        const fase = AppState.faseMap[AppState.selectedKelas] || '';
        const faseText = fase.toLowerCase().includes('fase') ? fase : `Fase ${fase}`;

        container.innerHTML = `
            <!-- ATP -->
            <div class="paper-preview landscape">
                <h1 class="text-center text-base font-bold mb-6 uppercase" contenteditable="true">
                    ALUR TUJUAN PEMBELAJARAN (ATP)<br>
                    TAHUN PELAJARAN ${identity.tahunAjar}
                </h1>
                
                <div class="flex justify-between mb-4 text-sm" contenteditable="true">
                    <table style="line-height: 1.6;">
                        <tr><td width="150"><strong>NAMA SEKOLAH</strong></td><td>: ${identity.sekolah}</td></tr>
                        <tr><td><strong>MATA PELAJARAN</strong></td><td>: <span class="text-primary-700 font-bold">${identity.mapel}</span></td></tr>
                        <tr><td><strong>FASE</strong></td><td>: ${faseText}</td></tr>
                    </table>
                    <table style="line-height: 1.6;">
                        <tr><td width="100"><strong>KELAS</strong></td><td>: ${identity.kelas}</td></tr>
                        <tr><td><strong>SEMESTER</strong></td><td>: ${mode === 'tahun' ? 'Ganjil & Genap' : identity.semester}</td></tr>
                    </table>
                </div>
                
                <table class="doc-table">
                    <thead>
                        <tr>
                            <th width="4%">NO</th>
                            <th width="22%">ELEMEN & CAPAIAN PEMBELAJARAN</th>
                            <th width="26%">TUJUAN PEMBELAJARAN</th>
                            <th width="14%">PROFIL PELAJAR PANCASILA</th>
                            <th width="10%">KOMPETENSI</th>
                            <th width="8%">WAKTU</th>
                        </tr>
                    </thead>
                    <tbody>${atpRows}</tbody>
                </table>
                
                ${DocumentEngine.generateSignature(identity)}
            </div>
            
            <!-- PROTA -->
            <div class="paper-preview portrait" style="margin-top: 30px;">
                <h1 class="text-center text-base font-bold mb-6 uppercase" contenteditable="true">
                    PROGRAM TAHUNAN (PROTA)<br>
                    <span class="text-primary-700">${identity.mapel}</span>
                </h1>
                
                <table class="doc-table mb-4" style="width: auto;" contenteditable="true">
                    <tr><td width="150"><strong>Satuan Pendidikan</strong></td><td>: ${identity.sekolah}</td></tr>
                    <tr><td><strong>Fase / Kelas</strong></td><td>: ${faseText} / ${identity.kelas}</td></tr>
                    <tr><td><strong>Tahun Pelajaran</strong></td><td>: ${identity.tahunAjar}</td></tr>
                </table>
                
                <table class="doc-table">
                    <thead>
                        <tr>
                            <th width="10%">Smt</th>
                            <th width="30%">Elemen & CP</th>
                            <th width="50%">Tujuan Pembelajaran</th>
                            <th width="10%">JP</th>
                        </tr>
                    </thead>
                    <tbody>${protaRows}</tbody>
                </table>
                
                ${DocumentEngine.generateSignature(identity)}
            </div>
        `;
    },

    extractKompetensi(text) {
        const keywords = ['menganalisis', 'mengevaluasi', 'mencipta', 'membuat', 'menyusun', 'memahami', 'menerapkan', 'mengingat', 'menjelaskan', 'membandingkan', 'mengidentifikasi', 'mendeskripsikan'];
        for (const kw of keywords) {
            if (text.toLowerCase().includes(kw)) {
                return kw.charAt(0).toUpperCase() + kw.slice(1);
            }
        }
        return 'Memahami';
    },

    // ============ PROMES ============
    generatePromes() {
        const container = document.getElementById('output-promes');
        if (!container) return;

        if (!AppState.selectedMapel || !AppState.selectedKelas || !AppState.selectedSemester) {
            container.innerHTML = `
                <div class="card p-12 text-center">
                    <p class="text-slate-500 mb-4">Pilih Mapel, Kelas, Semester di menu Kurikulum & generate Kalender terlebih dahulu.</p>
                    <button onclick="UISystem.navigateTo('kurikulum')" class="btn btn-primary">Buka Kurikulum</button>
                </div>
            `;
            return;
        }

        CalendarSystem.generateCalendar();

        const identity = DocumentEngine.getIdentity();
        const paper = document.getElementById('promes-paper')?.value || 'a4';
        const semester = AppState.selectedSemester;
        const year = identity.tahun;
        
        // Get months for semester
        const startMonth = semester === 'Ganjil' ? 6 : 0;
        const months = [];
        for (let i = 0; i < 6; i++) {
            let m = startMonth + i;
            let y = year;
            if (m > 11) { m -= 12; y++; }
            months.push({ month: m, year: y, name: BULAN_SHORT[m] });
        }

        // Get TPs
        const allTP = CurriculumSystem.getAllTP(AppState.selectedMapel, AppState.selectedKelas, semester);
        if (allTP.length === 0) {
            container.innerHTML = '<div class="card p-12 text-center"><p class="text-slate-500">Tidak ada data TP</p></div>';
            return;
        }

        // Get teaching days from schedules
        const teachingDays = AppState.schedules.map(s => parseInt(s.hari));
        if (teachingDays.length === 0) teachingDays.push(1); // Default Monday

        // Collect all teaching dates
        let allTeachingDates = [];
        teachingDays.forEach(day => {
            const dates = CalendarSystem.getTeachingDates(day, semester, year);
            allTeachingDates = allTeachingDates.concat(dates);
        });
        allTeachingDates.sort((a, b) => new Date(a.date) - new Date(b.date));

        // Build header
        let headerRow1 = '<th rowspan="2" width="20%">Elemen / TP</th><th rowspan="2" width="4%">JP</th>';
        let headerRow2 = '';
        
        months.forEach(mo => {
            headerRow1 += `<th colspan="5">${mo.name}</th>`;
            for (let w = 1; w <= 5; w++) {
                headerRow2 += `<th class="text-[8pt]">${w}</th>`;
            }
        });

        // Build body with TP mapping
        let bodyRows = '';
        let currentElemen = '';
        const jp = AppState.schedules.length > 0 ? (AppState.schedules[0].jp || 2) : 2;
        
        allTP.forEach((tp, tpIdx) => {
            const isNewElemen = tp.elemen !== currentElemen;
            currentElemen = tp.elemen;
            
            // Get teaching date for this TP
            const tpDate = allTeachingDates[tpIdx];
            
            bodyRows += '<tr>';
            
            if (isNewElemen) {
                const elemenTPs = allTP.filter(t => t.elemen === tp.elemen).length;
                bodyRows += `<td rowspan="${elemenTPs}" class="align-top text-[8pt] bg-slate-50 p-1" contenteditable="true">
                    <strong>${tp.elemen.substring(0, 50)}...</strong>
                </td>`;
            }
            
            bodyRows += `<td class="text-center font-bold text-[9pt]">${jp}</td>`;
            
            // Generate week cells for 6 months
            for (let m = 0; m < 6; m++) {
                const mo = months[m];
                for (let w = 1; w <= 5; w++) {
                    let cellContent = '';
                    let cellClass = '';
                    
                    // Check if this TP's date falls in this week of this month
                    if (tpDate) {
                        const tpMonth = tpDate.dateObj.getMonth();
                        const tpDay = tpDate.dateObj.getDate();
                        const weekNum = Math.ceil(tpDay / 7);
                        
                        if (tpMonth === mo.month && weekNum === w) {
                            cellContent = tpDay;
                            cellClass = 'active-cell';
                        }
                    }
                    
                    // Check for holidays in this week
                    if (!cellContent) {
                        const weekStart = (w - 1) * 7 + 1;
                        const weekEnd = Math.min(w * 7, new Date(mo.year, mo.month + 1, 0).getDate());
                        
                        for (let d = weekStart; d <= weekEnd; d++) {
                            const dateStr = `${mo.year}-${String(mo.month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                            if (AppState.calendarEvents[dateStr]) {
                                const evName = AppState.calendarEvents[dateStr];
                                if (evName.toLowerCase().includes('libur') || evName.toLowerCase().includes('rapor')) {
                                    cellClass = 'event-cell';
                                    if (tpIdx === 0) {
                                        const shortName = evName.length > 10 ? evName.substring(0, 8) + '..' : evName;
                                        cellContent = `<span class="text-[6pt]">${shortName}</span>`;
                                    }
                                    break;
                                }
                            }
                        }
                    }
                    
                    bodyRows += `<td class="${cellClass} text-[8pt]">${cellContent}</td>`;
                }
            }
            
            bodyRows += '</tr>';
        });

        container.innerHTML = `
            <div class="paper-preview landscape ${paper === 'f4' ? 'f4' : ''}">
                <h1 class="text-center text-base font-bold mb-6 uppercase" contenteditable="true">
                    PROGRAM SEMESTER (PROSEM)<br>
                    SEMESTER ${semester.toUpperCase()} - TAHUN PELAJARAN ${identity.tahunAjar}
                </h1>
                
                <table class="doc-table mb-4" style="width: auto;" contenteditable="true">
                    <tr><td width="150"><strong>Mata Pelajaran</strong></td><td>: <span class="text-primary-700 font-bold">${identity.mapel}</span></td></tr>
                    <tr><td><strong>Kelas / Rombel</strong></td><td>: ${identity.kelas} / ${identity.rombel}</td></tr>
                </table>
                
                <table class="doc-table doc-table-sm">
                    <thead>
                        <tr>${headerRow1}</tr>
                        <tr>${headerRow2}</tr>
                    </thead>
                    <tbody>${bodyRows}</tbody>
                </table>
                
                <p class="text-[8pt] mt-2 text-slate-500">Keterangan: Angka = tanggal mengajar, Sel merah = libur/kegiatan sekolah</p>
                
                ${DocumentEngine.generateSignature(identity)}
            </div>
        `;
    },

    // ============ MODUL AJAR ============
    generateModul() {
        const container = document.getElementById('output-modul');
        if (!container) return;

        if (!AppState.selectedMapel || !AppState.selectedKelas || !AppState.selectedSemester) {
            container.innerHTML = `
                <div class="card p-12 text-center">
                    <p class="text-slate-500 mb-4">Pilih Mapel, Kelas, Semester, dan Elemen di menu Kurikulum terlebih dahulu.</p>
                    <button onclick="UISystem.navigateTo('kurikulum')" class="btn btn-primary">Buka Kurikulum</button>
                </div>
            `;
            return;
        }

        const identity = DocumentEngine.getIdentity();
        const jp = AppState.schedules.length > 0 ? (AppState.schedules[0].jp || 2) : 2;
        
        // Get data for selected or first elemen
        const elemens = CurriculumSystem.getElemen(AppState.selectedMapel, AppState.selectedKelas, AppState.selectedSemester);
        const targetElemen = AppState.selectedElemen || elemens[0];
        const data = CurriculumSystem.getTP(AppState.selectedMapel, AppState.selectedKelas, AppState.selectedSemester, targetElemen);

        if (!data) {
            container.innerHTML = '<div class="card p-12 text-center"><p class="text-slate-500">Pilih Elemen/Bab untuk generate Modul Ajar</p></div>';
            return;
        }

        const totalJP = data.tps.length * jp;
        const fase = AppState.faseMap[AppState.selectedKelas] || '';

        // Generate learning steps
        let stepsHtml = data.tps.map((tp, idx) => `
            <div class="mb-6 p-4 bg-slate-50 rounded border" contenteditable="true">
                <h4 class="font-bold text-primary-800 border-b-2 border-primary-200 pb-2 mb-3">PERTEMUAN ${idx + 1} (${jp} JP)</h4>
                
                <p class="font-semibold mb-2">Tujuan: ${tp.tp}</p>
                
                <div class="mb-3">
                    <p class="font-semibold underline">A. Pendahuluan (15 Menit)</p>
                    <ol class="list-decimal pl-6 mt-1 text-sm space-y-1">
                        <li>Guru mengucapkan salam, berdoa, dan mengecek kehadiran siswa.</li>
                        <li>Guru memberikan apersepsi dan motivasi terkait materi.</li>
                        <li>Guru menyampaikan tujuan pembelajaran dan langkah kegiatan.</li>
                    </ol>
                </div>
                
                <div class="mb-3">
                    <p class="font-semibold underline">B. Kegiatan Inti (${jp * 35 - 30} Menit)</p>
                    <ol class="list-decimal pl-6 mt-1 text-sm space-y-1">
                        <li><strong>Orientasi:</strong> Siswa mengamati dan menyimak penjelasan guru.</li>
                        <li><strong>Eksplorasi:</strong> Siswa berdiskusi dan mengerjakan LKPD berkelompok.</li>
                        <li><strong>Komunikasi:</strong> Perwakilan kelompok mempresentasikan hasil.</li>
                        <li><strong>Refleksi:</strong> Guru memberikan umpan balik dan penguatan.</li>
                    </ol>
                </div>
                
                <div>
                    <p class="font-semibold underline">C. Penutup (15 Menit)</p>
                    <ol class="list-decimal pl-6 mt-1 text-sm space-y-1">
                        <li>Siswa bersama guru menyimpulkan materi pembelajaran.</li>
                        <li>Guru memberikan tugas/PR dan informasi pertemuan berikutnya.</li>
                        <li>Pembelajaran ditutup dengan doa dan salam.</li>
                    </ol>
                </div>
            </div>
        `).join('');

        const tpList = data.tps.map((tp, idx) => `<li><strong>TP ${idx + 1}:</strong> ${tp.tp}</li>`).join('');

        container.innerHTML = `
            <div class="paper-preview portrait">
                <h1 class="text-center text-base font-bold mb-6 uppercase" contenteditable="true">
                    MODUL AJAR KURIKULUM MERDEKA
                </h1>
                
                <div class="font-bold bg-slate-100 p-2 border-l-4 border-primary-600 mb-3">A. IDENTITAS MODUL</div>
                <table class="doc-table mb-4" contenteditable="true">
                    <tr><td width="150"><strong>Penyusun</strong></td><td>: ${identity.guru}</td></tr>
                    <tr><td><strong>Satuan Pendidikan</strong></td><td>: ${identity.sekolah}</td></tr>
                    <tr><td><strong>Mata Pelajaran</strong></td><td>: ${identity.mapel}</td></tr>
                    <tr><td><strong>Fase / Kelas</strong></td><td>: ${fase} / ${identity.kelas}</td></tr>
                    <tr><td><strong>Semester</strong></td><td>: ${identity.semester}</td></tr>
                    <tr><td><strong>Materi Pokok</strong></td><td>: <span class="text-primary-700 font-bold">${targetElemen}</span></td></tr>
                    <tr><td><strong>Alokasi Waktu</strong></td><td>: ${totalJP} JP (${data.tps.length} Pertemuan)</td></tr>
                </table>
                
                <div class="font-bold bg-slate-100 p-2 border-l-4 border-primary-600 mb-3">B. CAPAIAN & TUJUAN PEMBELAJARAN</div>
                <div class="mb-4 pl-4" contenteditable="true">
                    <p class="mb-2"><strong>Capaian Pembelajaran (CP):</strong></p>
                    <p class="bg-blue-50 p-3 rounded border border-blue-200 text-sm mb-3">${data.cp}</p>
                    <p class="font-semibold mb-2">Tujuan Pembelajaran (TP):</p>
                    <ol class="list-decimal pl-6 text-sm space-y-1">${tpList}</ol>
                </div>
                
                <div class="font-bold bg-slate-100 p-2 border-l-4 border-primary-600 mb-3">C. LANGKAH-LANGKAH PEMBELAJARAN</div>
                <div class="pl-2">${stepsHtml}</div>
                
                <div class="font-bold bg-slate-100 p-2 border-l-4 border-primary-600 mb-3">D. ASESMEN</div>
                <div class="pl-4 mb-4" contenteditable="true">
                    <ul class="list-disc pl-6 text-sm space-y-1">
                        <li><strong>Asesmen Formatif:</strong> Observasi, diskusi, LKPD</li>
                        <li><strong>Asesmen Sumatif:</strong> Tes tertulis, proyek, presentasi</li>
                    </ul>
                </div>
                
                ${DocumentEngine.generateSignature(identity)}
            </div>
        `;
    },

    // ============ LKPD ============
    generateLKPD() {
        const container = document.getElementById('output-lkpd');
        if (!container) return;

        if (!AppState.selectedMapel || !AppState.selectedKelas || !AppState.selectedSemester) {
            container.innerHTML = `
                <div class="card p-12 text-center">
                    <p class="text-slate-500 mb-4">Pilih Mapel, Kelas, Semester, dan Elemen terlebih dahulu.</p>
                    <button onclick="UISystem.navigateTo('kurikulum')" class="btn btn-primary">Buka Kurikulum</button>
                </div>
            `;
            return;
        }

        const identity = DocumentEngine.getIdentity();
        const elemens = CurriculumSystem.getElemen(AppState.selectedMapel, AppState.selectedKelas, AppState.selectedSemester);
        const targetElemen = AppState.selectedElemen || elemens[0];
        const data = CurriculumSystem.getTP(AppState.selectedMapel, AppState.selectedKelas, AppState.selectedSemester, targetElemen);

        if (!data) {
            container.innerHTML = '<div class="card p-12 text-center"><p class="text-slate-500">Pilih Elemen/Bab untuk generate LKPD</p></div>';
            return;
        }

        const tpList = data.tps.map((tp, idx) => `<li>${tp.tp}</li>`).join('');

        // LKPD TANPA TANDA TANGAN
        container.innerHTML = `
            <div class="paper-preview portrait">
                <div class="border-4 border-dashed border-primary-400 p-6 rounded-2xl bg-gradient-to-br from-blue-50 to-indigo-50 min-h-[250mm]">
                    <div class="text-center mb-6">
                        <h1 class="text-xl font-bold text-primary-800 uppercase" contenteditable="true">
                            LEMBAR KERJA PESERTA DIDIK (LKPD)
                        </h1>
                        <p class="text-primary-600 font-semibold">${identity.mapel} - Kelas ${identity.kelas}</p>
                    </div>
                    
                    <div class="flex justify-between items-center border-2 border-primary-300 rounded-lg p-3 mb-6 bg-white" contenteditable="true">
                        <span><strong>Nama/Kelompok:</strong> ...................................</span>
                        <span><strong>Kelas:</strong> ${identity.kelas}/${identity.rombel}</span>
                        <span><strong>Nilai:</strong> ........</span>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4 mb-6 border border-primary-200" contenteditable="true">
                        <p class="font-bold text-primary-700 mb-2">üìö MATERI POKOK:</p>
                        <p class="text-lg font-semibold">${targetElemen}</p>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4 mb-6 border border-primary-200" contenteditable="true">
                        <p class="font-bold text-primary-700 mb-2">üéØ TUJUAN PEMBELAJARAN:</p>
                        <ol class="list-decimal pl-6 text-sm space-y-1">${tpList}</ol>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4 mb-6 border border-amber-200" contenteditable="true">
                        <p class="font-bold text-amber-700 mb-2">üìã PETUNJUK PENGERJAAN:</p>
                        <ol class="list-decimal pl-6 text-sm space-y-1">
                            <li>Berdoalah sebelum mengerjakan.</li>
                            <li>Baca dan pahami setiap instruksi dengan seksama.</li>
                            <li>Diskusikan dengan teman kelompok jika ada yang kurang dipahami.</li>
                            <li>Tuliskan jawaban dengan rapi dan jelas.</li>
                        </ol>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4 border border-primary-200" contenteditable="true">
                        <p class="font-bold text-primary-700 mb-4 border-b-2 border-primary-200 pb-2">‚úèÔ∏è KEGIATAN:</p>
                        
                        <div class="space-y-6">
                            <div>
                                <p class="font-semibold mb-2">1. Tuliskan pemahaman utamamu mengenai materi ini!</p>
                                <div class="border-2 border-dashed border-slate-300 rounded-lg p-4 min-h-[80px] bg-slate-50"></div>
                            </div>
                            
                            <div>
                                <p class="font-semibold mb-2">2. Berikan contoh penerapan materi di kehidupan sehari-hari!</p>
                                <div class="border-2 border-dashed border-slate-300 rounded-lg p-4 min-h-[80px] bg-slate-50"></div>
                            </div>
                            
                            <div>
                                <p class="font-semibold mb-2">3. Apa kesimpulan yang dapat kamu ambil dari pembelajaran hari ini?</p>
                                <div class="border-2 border-dashed border-slate-300 rounded-lg p-4 min-h-[80px] bg-slate-50"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    // ============ JURNAL ============
    generateJurnal() {
        const container = document.getElementById('output-jurnal');
        if (!container) return;

        if (!AppState.selectedMapel || !AppState.selectedSemester || AppState.schedules.length === 0) {
            container.innerHTML = `
                <div class="card p-12 text-center">
                    <p class="text-slate-500 mb-4">Lengkapi Kurikulum dan Jadwal Mengajar terlebih dahulu.</p>
                    <button onclick="UISystem.navigateTo('kalender')" class="btn btn-primary">Buka Kalender</button>
                </div>
            `;
            return;
        }

        CalendarSystem.generateCalendar();
        
        const identity = DocumentEngine.getIdentity();
        const paper = document.getElementById('jurnal-paper')?.value || 'a4';
        const semester = AppState.selectedSemester;
        const year = identity.tahun;
        const allTP = CurriculumSystem.getAllTP(AppState.selectedMapel, AppState.selectedKelas, semester);

        // Get teaching dates
        const teachingDays = AppState.schedules.map(s => parseInt(s.hari));
        let allTeachingDates = [];
        teachingDays.forEach(day => {
            allTeachingDates = allTeachingDates.concat(CalendarSystem.getTeachingDates(day, semester, year));
        });
        allTeachingDates.sort((a, b) => new Date(a.date) - new Date(b.date));

        if (allTeachingDates.length === 0) {
            container.innerHTML = '<div class="card p-12 text-center"><p class="text-slate-500">Generate kalender terlebih dahulu</p></div>';
            return;
        }

        // Group by month
        const byMonth = {};
        allTeachingDates.forEach((td, idx) => {
            const key = `${td.dateObj.getMonth()}-${td.dateObj.getFullYear()}`;
            if (!byMonth[key]) byMonth[key] = [];
            byMonth[key].push({ ...td, tp: allTP[idx % allTP.length] });
        });

        let html = '';
        Object.keys(byMonth).forEach(key => {
            const [monthStr, yearStr] = key.split('-');
            const month = parseInt(monthStr);
            const yr = parseInt(yearStr);
            const items = byMonth[key];

            const rows = items.map(item => {
                const dateStr = `${String(item.dateObj.getDate()).padStart(2, '0')}/${String(month + 1).padStart(2, '0')}/${yr}`;
                return `
                    <tr>
                        <td class="text-center font-bold">${dateStr}</td>
                        <td class="text-center" contenteditable="true">${identity.kelas}/${identity.rombel}</td>
                        <td contenteditable="true">${item.tp?.elemen?.substring(0, 25) || '-'}...</td>
                        <td contenteditable="true">${item.tp?.tp || '-'}</td>
                        <td class="text-center font-bold text-green-700" contenteditable="true">Hadir Semua</td>
                        <td contenteditable="true">Berjalan Lancar</td>
                    </tr>
                `;
            }).join('');

            html += `
                <div class="paper-preview landscape ${paper === 'f4' ? 'f4' : ''}" style="margin-bottom: 30px;">
                    <h1 class="text-center text-base font-bold mb-6 uppercase" contenteditable="true">
                        JURNAL PELAKSANAAN PEMBELAJARAN<br>
                        BULAN ${BULAN[month].toUpperCase()} ${yr}
                    </h1>
                    
                    <table class="doc-table mb-4" style="width: auto;" contenteditable="true">
                        <tr><td width="150"><strong>Mata Pelajaran</strong></td><td>: ${identity.mapel}</td></tr>
                        <tr><td><strong>Guru</strong></td><td>: ${identity.guru}</td></tr>
                    </table>
                    
                    <table class="doc-table">
                        <thead>
                            <tr>
                                <th width="10%">Tanggal</th>
                                <th width="10%">Kelas</th>
                                <th width="18%">Materi</th>
                                <th width="32%">Tujuan Pembelajaran</th>
                                <th width="12%">Kehadiran</th>
                                <th width="18%">Keterangan</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                    
                    ${DocumentEngine.generateSignature(identity, `${CalendarSystem.formatDate(`${yr}-${String(month + 1).padStart(2, '0')}-28`)}`)}
                </div>
            `;
        });

        container.innerHTML = html;
    },

    // ============ ABSENSI ============
    generateAbsensi() {
        const container = document.getElementById('output-absensi');
        if (!container) return;

        if (AppState.students.length === 0) {
            container.innerHTML = `
                <div class="card p-12 text-center">
                    <p class="text-slate-500 mb-4">Input data siswa terlebih dahulu.</p>
                    <button onclick="UISystem.navigateTo('data-siswa')" class="btn btn-primary">Input Siswa</button>
                </div>
            `;
            return;
        }

        if (AppState.schedules.length === 0) {
            container.innerHTML = `
                <div class="card p-12 text-center">
                    <p class="text-slate-500 mb-4">Atur jadwal mengajar di menu Kalender terlebih dahulu.</p>
                    <button onclick="UISystem.navigateTo('kalender')" class="btn btn-primary">Buka Kalender</button>
                </div>
            `;
            return;
        }

        CalendarSystem.generateCalendar();

        const identity = DocumentEngine.getIdentity();
        const semester = AppState.selectedSemester || 'Ganjil';
        const year = identity.tahun;

        // Get teaching dates
        const teachingDays = AppState.schedules.map(s => parseInt(s.hari));
        let allTeachingDates = [];
        teachingDays.forEach(day => {
            allTeachingDates = allTeachingDates.concat(CalendarSystem.getTeachingDates(day, semester, year));
        });
        allTeachingDates.sort((a, b) => new Date(a.date) - new Date(b.date));

        // Group by month
        const byMonth = {};
        allTeachingDates.forEach(td => {
            const key = `${td.dateObj.getMonth()}-${td.dateObj.getFullYear()}`;
            if (!byMonth[key]) byMonth[key] = [];
            byMonth[key].push(td);
        });

        let html = '';
        Object.keys(byMonth).forEach(key => {
            const [monthStr, yearStr] = key.split('-');
            const month = parseInt(monthStr);
            const yr = parseInt(yearStr);
            const dates = byMonth[key];

            const dateHeaders = dates.map(d => `<th class="text-[9pt]">${d.dateObj.getDate()}</th>`).join('');
            
            const studentRows = AppState.students.map((student, idx) => {
                const name = typeof student === 'object' ? student.nama : student;
                const cells = dates.map((_, cIdx) => `
                    <td class="text-center p-1">
                        <span class="cursor-pointer font-bold text-blue-600 hover:bg-blue-100 px-2 py-1 rounded text-sm absen-cell" 
                              onclick="PageScripts.toggleAbsen(this)" data-row="${idx}">H</span>
                    </td>
                `).join('');
                
                return `
                    <tr data-row="${idx}">
                        <td class="text-center">${idx + 1}</td>
                        <td class="text-left" contenteditable="true">${name}</td>
                        ${cells}
                        <td class="text-center font-bold bg-slate-50 tot-h">${dates.length}</td>
                        <td class="text-center font-bold bg-slate-50 tot-s">0</td>
                        <td class="text-center font-bold bg-slate-50 tot-i">0</td>
                        <td class="text-center font-bold bg-slate-50 tot-a">0</td>
                    </tr>
                `;
            }).join('');

            html += `
                <div class="paper-preview portrait" style="margin-bottom: 30px;">
                    <h1 class="text-center text-base font-bold mb-6 uppercase" contenteditable="true">
                        DAFTAR HADIR SISWA<br>
                        BULAN ${BULAN[month].toUpperCase()} ${yr}
                    </h1>
                    
                    <table class="doc-table mb-4" style="width: auto;" contenteditable="true">
                        <tr><td width="150"><strong>Mata Pelajaran</strong></td><td>: ${identity.mapel}</td></tr>
                        <tr><td><strong>Kelas</strong></td><td>: ${identity.kelas}/${identity.rombel}</td></tr>
                    </table>
                    
                    <table class="doc-table doc-table-sm">
                        <thead>
                            <tr>
                                <th rowspan="2" width="4%">No</th>
                                <th rowspan="2" width="18%">Nama Siswa</th>
                                <th colspan="${dates.length}">Tanggal</th>
                                <th colspan="4" class="bg-blue-50">Jumlah</th>
                            </tr>
                            <tr>
                                ${dateHeaders}
                                <th class="bg-blue-50 text-[9pt]">H</th>
                                <th class="bg-blue-50 text-[9pt]">S</th>
                                <th class="bg-blue-50 text-[9pt]">I</th>
                                <th class="bg-blue-50 text-[9pt]">A</th>
                            </tr>
                        </thead>
                        <tbody>${studentRows}</tbody>
                    </table>
                    
                    <p class="text-[9pt] mt-2 text-slate-500">Keterangan: H=Hadir, S=Sakit, I=Izin, A=Alpha. <strong>Klik huruf untuk mengubah status.</strong></p>
                    
                    ${DocumentEngine.generateSignature(identity, `${CalendarSystem.formatDate(`${yr}-${String(month + 1).padStart(2, '0')}-28`)}`)}
                </div>
            `;
        });

        container.innerHTML = html || '<div class="card p-12 text-center"><p class="text-slate-500">Generate kalender terlebih dahulu</p></div>';
    },

    toggleAbsen(el) {
        const states = { 'H': 'S', 'S': 'I', 'I': 'A', 'A': 'H' };
        const colors = { 'H': 'text-blue-600', 'S': 'text-amber-600', 'I': 'text-purple-600', 'A': 'text-red-600' };
        
        const current = el.textContent.trim();
        const next = states[current] || 'H';
        
        el.textContent = next;
        el.className = `cursor-pointer font-bold ${colors[next]} hover:bg-blue-100 px-2 py-1 rounded text-sm absen-cell`;
        
        // Update totals
        const row = el.closest('tr');
        if (row) {
            const cells = row.querySelectorAll('.absen-cell');
            let counts = { H: 0, S: 0, I: 0, A: 0 };
            cells.forEach(c => {
                const val = c.textContent.trim();
                if (counts[val] !== undefined) counts[val]++;
            });
            
            row.querySelector('.tot-h').textContent = counts.H;
            row.querySelector('.tot-s').textContent = counts.S;
            row.querySelector('.tot-i').textContent = counts.I;
            row.querySelector('.tot-a').textContent = counts.A;
        }
    },

    // ============ KKTP & NILAI ============
    generateKKTP() {
        const container = document.getElementById('output-kktp');
        if (!container) return;

        if (!AppState.selectedMapel || !AppState.selectedKelas || !AppState.selectedSemester) {
            container.innerHTML = `
                <div class="card p-12 text-center">
                    <p class="text-slate-500 mb-4">Pilih Mapel, Kelas, dan Semester terlebih dahulu.</p>
                    <button onclick="UISystem.navigateTo('kurikulum')" class="btn btn-primary">Buka Kurikulum</button>
                </div>
            `;
            return;
        }

        const identity = DocumentEngine.getIdentity();
        const allTP = CurriculumSystem.getAllTP(AppState.selectedMapel, AppState.selectedKelas, AppState.selectedSemester);

        if (allTP.length === 0) {
            container.innerHTML = '<div class="card p-12 text-center"><p class="text-slate-500">Tidak ada data TP</p></div>';
            return;
        }

        // KKTP Rows
        const kktpRows = allTP.map((tp, idx) => `
            <tr>
                <td class="text-center">${idx + 1}</td>
                <td contenteditable="true" class="text-sm">${tp.tp}</td>
                <td class="text-center bg-yellow-50 font-semibold" contenteditable="true" oninput="PageScripts.calcKKTP(this)">75</td>
                <td class="text-center bg-yellow-50 font-semibold" contenteditable="true" oninput="PageScripts.calcKKTP(this)">75</td>
                <td class="text-center bg-yellow-50 font-semibold" contenteditable="true" oninput="PageScripts.calcKKTP(this)">75</td>
                <td class="text-center font-bold bg-blue-100 text-primary-800 kktp-result">75</td>
            </tr>
        `).join('');

        // Nilai Rows
        const nilaiRows = AppState.students.length > 0 ? AppState.students.map((student, idx) => {
            const name = typeof student === 'object' ? student.nama : student;
            return `
                <tr>
                    <td class="text-center">${idx + 1}</td>
                    <td class="text-left" contenteditable="true">${name}</td>
                    <td class="text-center" contenteditable="true"></td>
                    <td class="text-center" contenteditable="true"></td>
                    <td class="text-center" contenteditable="true"></td>
                    <td class="text-center" contenteditable="true"></td>
                    <td class="text-center font-semibold bg-slate-50" contenteditable="true"></td>
                    <td class="text-center" contenteditable="true"></td>
                    <td class="text-center" contenteditable="true"></td>
                    <td class="text-center font-bold bg-blue-100 text-primary-800" contenteditable="true"></td>
                </tr>
            `;
        }).join('') : '<tr><td colspan="10" class="text-center py-4 text-slate-400">Belum ada data siswa</td></tr>';

        container.innerHTML = `
            <!-- KKTP -->
            <div class="paper-preview portrait">
                <h1 class="text-center text-base font-bold mb-6 uppercase" contenteditable="true">
                    KRITERIA KETERCAPAIAN TUJUAN PEMBELAJARAN (KKTP)
                </h1>
                
                <table class="doc-table mb-4" style="width: auto;" contenteditable="true">
                    <tr><td width="150"><strong>Mata Pelajaran</strong></td><td>: ${identity.mapel}</td></tr>
                    <tr><td><strong>Kelas / Semester</strong></td><td>: ${identity.kelas} / ${identity.semester}</td></tr>
                </table>
                
                <table class="doc-table">
                    <thead>
                        <tr>
                            <th rowspan="2" width="5%">No</th>
                            <th rowspan="2" width="45%">Tujuan Pembelajaran</th>
                            <th colspan="3">Kriteria (Klik untuk Edit)</th>
                            <th rowspan="2" width="10%">KKTP</th>
                        </tr>
                        <tr>
                            <th class="text-[9pt]">Kompleksitas</th>
                            <th class="text-[9pt]">Daya Dukung</th>
                            <th class="text-[9pt]">Intake Siswa</th>
                        </tr>
                    </thead>
                    <tbody>${kktpRows}</tbody>
                </table>
                
                <p class="text-[9pt] italic text-slate-500 mt-2">*KKTP = Rata-rata dari 3 kriteria</p>
                
                ${DocumentEngine.generateSignature(identity)}
            </div>
            
            <!-- DAFTAR NILAI -->
            <div class="paper-preview landscape" style="margin-top: 30px;">
                <h1 class="text-center text-base font-bold mb-6 uppercase" contenteditable="true">
                    DAFTAR NILAI SUMATIF & FORMATIF
                </h1>
                
                <table class="doc-table mb-4" style="width: auto;" contenteditable="true">
                    <tr><td width="150"><strong>Mata Pelajaran</strong></td><td>: ${identity.mapel}</td></tr>
                    <tr><td><strong>Kelas / Semester</strong></td><td>: ${identity.kelas} / ${identity.semester}</td></tr>
                </table>
                
                <table class="doc-table doc-table-sm text-center">
                    <thead>
                        <tr>
                            <th rowspan="2" width="4%">No</th>
                            <th rowspan="2" width="20%">Nama Siswa</th>
                            <th colspan="5">Nilai Sumatif Harian (Per TP)</th>
                            <th rowspan="2" width="7%">STS</th>
                            <th rowspan="2" width="7%">SAS</th>
                            <th rowspan="2" width="8%" class="bg-blue-50">NR</th>
                        </tr>
                        <tr>
                            <th>S1</th><th>S2</th><th>S3</th><th>S4</th><th>Rata2</th>
                        </tr>
                    </thead>
                    <tbody>${nilaiRows}</tbody>
                </table>
                
                <p class="text-[9pt] mt-2 text-slate-500">Keterangan: STS=Sumatif Tengah Semester, SAS=Sumatif Akhir Semester, NR=Nilai Rapor</p>
                
                ${DocumentEngine.generateSignature(identity)}
            </div>
        `;
    },

    calcKKTP(el) {
        const row = el.closest('tr');
        if (!row) return;
        
        const editableCells = row.querySelectorAll('td[contenteditable="true"]');
        let sum = 0, count = 0;
        
        editableCells.forEach(cell => {
            const val = parseFloat(cell.textContent);
            if (!isNaN(val) && val >= 0 && val <= 100) {
                sum += val;
                count++;
            }
        });
        
        const result = row.querySelector('.kktp-result');
        if (result && count > 0) {
            result.textContent = Math.round(sum / count);
        }
    },

    // ============ BANK SOAL ============
    populateSoalTP() {
        const select = document.getElementById('soal-tp');
        if (!select) return;

        const tps = CurriculumSystem.getAllTP(AppState.selectedMapel, AppState.selectedKelas, AppState.selectedSemester);
        select.innerHTML = '<option value="">-- Pilih TP --</option>' + 
            tps.map((tp, i) => `<option value="${tp.tp}">${i + 1}. ${tp.tp.substring(0, 50)}...</option>`).join('');
    },

    importSoalCSV() {
        const csv = document.getElementById('input-soal-csv').value.trim();
        if (!csv) {
            UISystem.showToast('Paste data CSV terlebih dahulu', 'error');
            return;
        }

        const lines = csv.split('\n');
        const questions = [];
        
        for (let i = 1; i < lines.length; i++) {
            const cols = CurriculumSystem.parseCSVRow(lines[i]);
            if (cols.length >= 2) {
                questions.push({
                    no: cols[0] || i,
                    soal: cols[1] || '',
                    jawaban: cols[cols.length - 1] || ''
                });
            }
        }

        this.renderSoalList(questions);
        UISystem.showToast(`Berhasil import ${questions.length} soal`);
    },

    renderSoalList(questions) {
        const container = document.getElementById('list-soal');
        if (!container) return;

        if (!questions || questions.length === 0) {
            container.innerHTML = '<p class="text-slate-400 italic text-center py-8">Belum ada soal</p>';
            return;
        }

        container.innerHTML = questions.map((q, idx) => `
            <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                <div class="flex items-start gap-4">
                    <span class="w-8 h-8 bg-primary-600 text-white rounded-lg flex items-center justify-center font-bold flex-shrink-0">${idx + 1}</span>
                    <div class="flex-1">
                        <p class="font-medium text-slate-800">${q.soal}</p>
                        <p class="text-sm text-green-600 mt-2 font-semibold"><span class="text-slate-500">Jawaban:</span> ${q.jawaban}</p>
                    </div>
                </div>
            </div>
        `).join('');
    },

    // ============ SUPER ADMIN ============
    async loadAdminData() {
        if (!AppState.isSuperAdmin) return;

        const statsContainer = document.getElementById('admin-stats');
        const schoolsContainer = document.getElementById('admin-schools');

        try {
            const users = await SuperAdminSystem.getAllUsers();
            const schools = await SuperAdminSystem.getAllSchools();

            const schoolsByNPSN = {};
            users.forEach(u => {
                if (u.npsn) {
                    if (!schoolsByNPSN[u.npsn]) schoolsByNPSN[u.npsn] = [];
                    schoolsByNPSN[u.npsn].push(u);
                }
            });

            statsContainer.innerHTML = `
                <div class="flex justify-between items-center py-3 border-b">
                    <span class="text-slate-600">Total Users</span>
                    <span class="text-xl font-bold text-slate-800">${users.length}</span>
                </div>
                <div class="flex justify-between items-center py-3 border-b">
                    <span class="text-slate-600">Total Sekolah</span>
                    <span class="text-xl font-bold text-slate-800">${schools.length}</span>
                </div>
                <div class="flex justify-between items-center py-3">
                    <span class="text-slate-600">NPSN Premium</span>
                    <span class="text-xl font-bold text-primary-600">${AppState.settings.premiumNPSN?.length || 0}</span>
                </div>
            `;

            if (schools.length === 0) {
                schoolsContainer.innerHTML = '<p class="text-slate-400 text-center py-8">Belum ada sekolah terdaftar</p>';
            } else {
                schoolsContainer.innerHTML = `
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-slate-100">
                                <th class="px-4 py-3 text-left rounded-tl-lg">NPSN</th>
                                <th class="px-4 py-3 text-left">Nama Sekolah</th>
                                <th class="px-4 py-3 text-center">Guru</th>
                                <th class="px-4 py-3 text-center rounded-tr-lg">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${schools.map(s => `
                                <tr class="border-b hover:bg-slate-50">
                                    <td class="px-4 py-3 font-mono">${s.npsn || s.id}</td>
                                    <td class="px-4 py-3">${s.nama || '-'}</td>
                                    <td class="px-4 py-3 text-center">${(schoolsByNPSN[s.npsn || s.id] || []).length}</td>
                                    <td class="px-4 py-3 text-center">
                                        ${AppState.settings.premiumNPSN?.includes(s.npsn || s.id) ? '<span class="badge badge-pro">PRO</span>' : '<span class="badge badge-free">FREE</span>'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
        } catch (error) {
            console.error('Load admin data error:', error);
            statsContainer.innerHTML = '<p class="text-red-500">Error loading data</p>';
        }
    },

    async saveAdminSettings() {
        const waNumber = document.getElementById('admin-wa').value.trim();
        const premiumNPSN = document.getElementById('admin-premium-npsn').value.split(',').map(s => s.trim()).filter(s => s);
        const paiNPSN = document.getElementById('admin-pai-npsn').value.split(',').map(s => s.trim()).filter(s => s);
        const premiumUsers = document.getElementById('admin-premium-users').value.split('\n').map(s => s.trim()).filter(s => s);

        await SuperAdminSystem.saveSettings({ waNumber, premiumNPSN, paiNPSN, premiumUsers });
    }
};

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', () => {
    // Initialize calendar settings
    CalendarSystem.init();
    
    // Load students from localStorage
    const savedStudents = localStorage.getItem('agsa_students');
    if (savedStudents) {
        try {
            AppState.students = JSON.parse(savedStudents);
        } catch (e) {
            console.error('Error loading students:', e);
        }
    }

    // Initialize auth
    AuthSystem.init();

    // Listen for curriculum loaded
    document.addEventListener('curriculumLoaded', () => {
        if (UISystem.currentPage === 'kurikulum') {
            PageScripts.updateKurikulumDropdowns();
        }
    });

    // Responsive sidebar
    window.addEventListener('resize', () => {
        if (window.innerWidth >= 1024) {
            document.getElementById('app-sidebar').classList.remove('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');
        }
    });

    // Close modals with Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
        }
    });

    // Close modals on backdrop click
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.style.display = 'none';
        });
    });
});

// Global exports
window.UISystem = UISystem;
window.AuthSystem = AuthSystem;
window.AISystem = AISystem;
window.PageScripts = PageScripts;
window.SubscriptionSystem = SubscriptionSystem;
</script>
</body>
</html>