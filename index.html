<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Guru Super App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; overflow: hidden; }
        
        .paper-preview { background: white; margin: 20px auto; padding: 15mm; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); max-width: 297mm; min-height: 210mm; position: relative; }
        .paper-preview.portrait { max-width: 210mm; min-height: 297mm; }
        
        .doc-table { width: 100%; border-collapse: collapse; font-size: 10pt; margin-bottom: 20px; }
        .doc-table th, .doc-table td { border: 1px solid #1f2937; padding: 6px; text-align: left; vertical-align: top; }
        .doc-table th { background-color: #f1f5f9; font-weight: 600; text-align: center; }
        .text-center { text-align: center !important; }
        .align-middle { vertical-align: middle !important; }
        .vertical-text { writing-mode: vertical-rl; transform: rotate(180deg); text-align: center; vertical-align: middle; margin: auto; }
        .vertical-event { writing-mode: vertical-rl; transform: rotate(180deg); text-align: center; vertical-align: middle; margin: auto; font-size: 8.5pt; letter-spacing: 1.5px; color: #334155; white-space: nowrap; }
        
        [contenteditable="true"]:hover { background-color: #fef08a; outline: 1px dashed #eab308; cursor: text; transition: 0.2s; }
        
        .kktp-val { background-color: #fdfde8; font-weight: bold; color: #2563eb; cursor: text; text-align: center;}
        .kktp-hasil { background-color: #e0f2fe; color: #1e40af; font-size: 11pt; text-align: center; font-weight: bold;}

        /* Perbaikan Tanda Tangan */
        .signature-area { display: flex; justify-content: space-between; margin-top: 40px; page-break-inside: avoid; padding: 0 5%; }
        .signature-box { text-align: center; font-size: 11pt; min-width: 250px; }
        .signature-name { text-decoration: underline; font-weight: bold; margin-top: 80px; }

        /* Scrollbar Sidebar */
        .sidebar-scroll::-webkit-scrollbar { width: 5px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

        .csv-info { padding: 10px; background-color: #047857; border-radius: 6px; font-size: 0.8rem; display: none; margin-top: 5px; line-height: 1.4; color: white;}
        .csv-info.error { background-color: #991b1b; }

        @media print {
            body { background: white; overflow: visible; }
            #sidebar, #topbar, .no-print, #login-screen { display: none !important; }
            #main-content { margin: 0; padding: 0; width: 100%; overflow: visible; }
            .paper-preview { margin: 0; padding: 15mm; box-shadow: none; max-width: 100%; page-break-after: always; }
            .paper-preview:last-child { page-break-after: auto; }
            [contenteditable="true"]:hover { background-color: transparent; outline: none; }
            .kktp-val { background-color: transparent !important; color: black; }
            .kktp-hasil { background-color: #e0f2fe !important; -webkit-print-color-adjust: exact; }
            @page { size: A4 portrait; }
            .landscape { @page { size: A4 landscape; } }
        }
    </style>
</head>
<body class="flex h-screen text-slate-800">

    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center text-white">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl max-w-md w-full text-center border border-slate-700">
            <h1 class="text-3xl font-bold text-blue-400 mb-2">Admin Guru Super App</h1>
            <p class="text-slate-400 mb-8 text-sm">Sistem Administrasi Cerdas Single Input</p>
            <button id="btn-login-google" class="w-full bg-white text-slate-800 font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-3 hover:bg-slate-100 transition">
                Masuk dengan Google
            </button>
        </div>
    </div>

    <aside id="sidebar" class="w-[340px] min-w-[340px] bg-slate-900 text-slate-300 flex flex-col h-full border-r border-slate-700 hidden">
        <div class="p-5 border-b border-slate-700">
            <h2 class="text-xl font-bold text-white">Super App</h2>
            <div class="flex items-center gap-2 mt-2">
                <span id="user-badge" class="px-2 py-0.5 rounded text-xs font-semibold bg-emerald-500/20 text-emerald-400">FREE</span>
                <span id="user-email" class="text-xs truncate">user@gmail.com</span>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-5 sidebar-scroll text-sm">
            
            <div class="border border-dashed border-amber-500 p-3 rounded-lg bg-amber-500/5">
                <h3 class="text-xs font-bold text-amber-500 mb-2">1. LINK DATABASE CP (CSV)</h3>
                <textarea id="in-csv-url" rows="3" class="w-full bg-slate-950 border border-slate-600 rounded p-2 text-xs focus:border-amber-500 outline-none text-slate-300" placeholder="Paste link CSV di sini..."></textarea>
                <div class="flex gap-2 mt-2">
                    <button onclick="Engine.fetchGlobalCSV()" class="flex-1 bg-amber-600 hover:bg-amber-500 text-white font-bold py-1.5 rounded text-xs">Muat Data Cloud</button>
                </div>
                <div id="csvStatus" class="csv-info"></div>
            </div>

            <div>
                <h3 class="text-xs font-bold text-slate-400 mb-2">2. PILIH MAPEL & KELAS</h3>
                <div class="space-y-2">
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold">Mata Pelajaran</label>
                        <select id="in-mapel" onchange="Engine.updateKelasList()" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none font-bold text-blue-400">
                            <option value="">-- Load CSV Dulu --</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold">Kelas</label>
                            <select id="in-kelas" onchange="Engine.updateSemesterList()" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none">
                                <option value="">-</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold">Semester</label>
                            <select id="in-semester" onchange="Engine.updateBabList()" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none">
                                <option value="">-</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold">Bab / Elemen Pembelajaran</label>
                        <select id="in-elemen" onchange="Engine.syncAll()" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none">
                            <option value="">-</option>
                        </select>
                    </div>
                </div>
            </div>

            <div>
                <h3 class="text-xs font-bold text-slate-400 mb-2">3. IDENTITAS SEKOLAH</h3>
                <div class="space-y-2">
                    <input type="text" id="in-sekolah" placeholder="Nama Sekolah" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none" value="SD Negeri Cerdas Bangsa">
                    <input type="text" id="in-kepsek" placeholder="Nama Kepala Sekolah" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none" value="Budi, S.Pd., M.Pd.">
                    <input type="text" id="in-nip-kepsek" placeholder="NIP Kepala Sekolah" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none" value="19800101 200501 1 001">
                    <input type="text" id="in-guru" placeholder="Nama Guru" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none" value="Siti Aminah, S.Pd.">
                    <input type="text" id="in-nip-guru" placeholder="NIP Guru" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none" value="19900202 201502 2 002">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="in-rombel" placeholder="Rombel (Misal: A)" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none text-center" value="A">
                        <input type="number" id="in-tahun" placeholder="Tahun Awal (2024)" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none text-center" value="2024">
                    </div>
                    <input type="text" id="in-tempat-tgl" placeholder="Tgl Penetapan Dokumen" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none" value="Jakarta, 15 Juli 2024">
                </div>
            </div>

            <div>
                <h3 class="text-xs font-bold text-slate-400 mb-2">4. JADWAL & LIBUR</h3>
                <div class="space-y-2">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase">Hari Mengajar</label>
                            <select id="in-hari" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none">
                                <option value="1" selected>Senin</option><option value="2">Selasa</option><option value="3">Rabu</option>
                                <option value="4">Kamis</option><option value="5">Jum'at</option><option value="6">Sabtu</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase">JP per Pertemuan</label>
                            <input type="number" id="in-jp" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none text-center" value="4">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase">Tgl Libur Khusus (YYYY-MM-DD)</label>
                        <textarea id="in-libur" rows="2" placeholder="Pisahkan dengan koma" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none"></textarea>
                    </div>
                </div>
            </div>

        </div>
        
        <div class="p-4 border-t border-slate-700">
            <button onclick="Engine.syncAll()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3 rounded-lg shadow-lg shadow-blue-500/30">
                üöÄ GENERATE DOKUMEN
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col hidden" id="main-wrapper">
        
        <header id="topbar" class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 no-print">
            <div class="flex space-x-1 overflow-x-auto">
                <button onclick="UI.switchTab('atp')" class="nav-tab px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600">ATP & Prota</button>
                <button onclick="UI.switchTab('promes')" class="nav-tab px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700">Promes</button>
                <button onclick="UI.switchTab('modul')" class="nav-tab px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700">Modul & LKPD</button>
                <button onclick="UI.switchTab('jurnal')" class="nav-tab px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700">Jurnal</button>
                <button onclick="UI.switchTab('absensi')" class="nav-tab px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700">Absensi</button>
                <button onclick="UI.switchTab('kktp')" class="nav-tab px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700">KKTP & Nilai</button>
            </div>
            <button onclick="window.print()" class="bg-slate-800 text-white px-5 py-2 rounded-md text-sm font-semibold hover:bg-slate-700 shadow flex items-center gap-2">
                üñ®Ô∏è Cetak PDF
            </button>
        </header>

        <div id="main-content" class="flex-1 overflow-y-auto p-8">
            
            <div id="view-atp" class="view-section block">
                <div class="no-print mb-4 flex justify-end gap-2">
                    <select id="in-atp-mode" onchange="Engine.syncAll()" class="p-2 border border-slate-300 rounded text-sm outline-none bg-white font-bold text-blue-700">
                        <option value="semester">Cetak 1 Semester (Aktif)</option>
                        <option value="tahun">Cetak 1 Tahun Penuh (Ganjil & Genap)</option>
                    </select>
                </div>
                
                <div class="paper-preview landscape max-w-full">
                    <h1 class="header-title" contenteditable="true">ALUR TUJUAN PEMBELAJARAN (ATP)<br>TAHUN PELAJARAN <span class="v-thn"></span></h1>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; font-size: 11pt;" contenteditable="true">
                        <table style="text-align: left; line-height: 1.5;">
                            <tr><td width="160">NAMA SEKOLAH</td><td>: <span class="v-sekolah"></span></td></tr>
                            <tr><td>MATA PELAJARAN</td><td>: <span class="v-mapel text-blue-700"></span></td></tr>
                            <tr><td>FASE</td><td>: <span class="v-fase"></span></td></tr>
                        </table>
                        <table style="text-align: left; line-height: 1.5;">
                            <tr><td width="100">KELAS</td><td>: <span class="v-kls"></span></td></tr>
                            <tr><td>SEMESTER</td><td>: <span class="v-smt"></span></td></tr>
                        </table>
                    </div>
                    <table class="doc-table">
                        <thead>
                            <tr>
                                <th width="3%">NO</th>
                                <th width="18%">ELEMEN DAN CAPAIAN PEMBELAJARAN (CP)</th>
                                <th width="20%">TUJUAN PEMBELAJARAN (TP)</th>
                                <th width="15%">DIMENSI PROFIL LULUSAN</th>
                                <th width="10%">KOMPETENSI</th>
                                <th width="8%">WAKTU</th>
                            </tr>
                        </thead>
                        <tbody id="out-atp"><tr><td colspan="6" class="text-center">Silakan klik tombol Generate...</td></tr></tbody>
                    </table>

                    <div class="signature-area" contenteditable="true">
                        <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name v-kepsek"></div>NIP. <span class="v-nip-kepsek"></span></div>
                        <div class="signature-box"><span class="v-tgl"></span><br>Guru Mata Pelajaran<br><div class="signature-name v-guru"></div>NIP. <span class="v-nip-guru"></span></div>
                    </div>
                </div>

                <div class="paper-preview portrait mt-10">
                    <h1 class="header-title" contenteditable="true">PROGRAM TAHUNAN (PROTA)<br><span class="v-mapel uppercase"></span></h1>
                    <table class="identity-table" contenteditable="true">
                        <tr><td width="150">Satuan Pendidikan</td><td>: <span class="v-sekolah"></span></td></tr>
                        <tr><td>Fase / Kelas</td><td>: <span class="v-fase"></span> / <span class="v-kls"></span></td></tr>
                        <tr><td>Tahun Pelajaran</td><td>: <span class="v-thn"></span></td></tr>
                    </table>
                    <table class="doc-table">
                        <thead>
                            <tr><th width="10%">Smt</th><th width="25%">Elemen/Bab</th><th width="55%">Tujuan Pembelajaran</th><th width="10%">JP</th></tr>
                        </thead>
                        <tbody id="out-prota"></tbody>
                    </table>
                    <div class="signature-area" contenteditable="true">
                        <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name v-kepsek"></div>NIP. <span class="v-nip-kepsek"></span></div>
                        <div class="signature-box"><span class="v-tgl"></span><br>Guru Mata Pelajaran<br><div class="signature-name v-guru"></div>NIP. <span class="v-nip-guru"></span></div>
                    </div>
                </div>
            </div>

            <div id="view-promes" class="view-section hidden">
                <div class="paper-preview landscape max-w-full">
                    <h1 class="header-title" contenteditable="true">PROGRAM SEMESTER (PROSEM)<br>SEMESTER <span class="v-smt uppercase"></span></h1>
                    <table class="identity-table w-1/2" contenteditable="true">
                        <tr><td width="150">Mata Pelajaran</td><td>: <span class="v-mapel text-blue-700"></span></td></tr>
                        <tr><td>Kelas/Rombel</td><td>: <span class="v-kls"></span> / <span class="v-rombel"></span></td></tr>
                    </table>
                    <table class="doc-table text-[8pt]">
                        <thead id="out-promes-head"></thead>
                        <tbody id="out-promes-body"></tbody>
                    </table>
                    <div class="signature-area" contenteditable="true">
                        <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name v-kepsek"></div>NIP. <span class="v-nip-kepsek"></span></div>
                        <div class="signature-box"><span class="v-tgl"></span><br>Guru Mata Pelajaran<br><div class="signature-name v-guru"></div>NIP. <span class="v-nip-guru"></span></div>
                    </div>
                </div>
            </div>

            <div id="view-modul" class="view-section hidden relative">
                <div class="no-print mb-4 bg-white p-3 rounded shadow flex items-center gap-4 border border-slate-200">
                    <label class="flex items-center gap-2 text-sm font-semibold cursor-pointer text-blue-600">
                        <input type="checkbox" checked onchange="document.getElementById('wrapper-lkpd').classList.toggle('hidden')"> Tampilkan Form LKPD
                    </label>
                </div>

                <div class="paper-preview portrait">
                    <h1 class="header-title" contenteditable="true">MODUL AJAR KURIKULUM MERDEKA</h1>
                    <div class="font-bold text-[11pt] bg-slate-100 p-1 border-l-4 border-blue-600 mt-4 mb-2">A. IDENTITAS</div>
                    <table class="identity-table" contenteditable="true">
                        <tr><td width="150">Penyusun</td><td>: <span class="v-guru"></span> (<span class="v-sekolah"></span>)</td></tr>
                        <tr><td>Mata Pelajaran</td><td>: <span class="v-mapel"></span></td></tr>
                        <tr><td>Kelas / Smt / Rombel</td><td>: <span class="v-kls"></span> / <span class="v-smt"></span> / <span class="v-rombel"></span></td></tr>
                        <tr><td>Topik Materi</td><td>: <span class="text-blue-600 font-bold v-bab-aktif"></span></td></tr>
                        <tr><td>Alokasi Waktu</td><td>: <span class="v-jp-bab"></span> JP</td></tr>
                    </table>
                    
                    <div class="font-bold text-[11pt] bg-slate-100 p-1 border-l-4 border-blue-600 mt-4 mb-2">B. PROFIL LULUSAN</div>
                    <div class="pl-4 mb-3" contenteditable="true" id="out-modul-p3"></div>

                    <div class="font-bold text-[11pt] bg-slate-100 p-1 border-l-4 border-blue-600 mt-4 mb-2">C. CAPAIAN & TUJUAN PEMBELAJARAN</div>
                    <div class="pl-4 mb-3 text-justify" contenteditable="true">
                        <p class="font-semibold italic text-slate-600 mb-2">Capaian Pembelajaran (CP):</p>
                        <p id="out-modul-cp" class="mb-2"></p>
                        <p class="font-semibold italic text-slate-600 mt-2">Tujuan Pembelajaran (TP):</p>
                        <div id="out-modul-tp"></div>
                    </div>

                    <div class="font-bold text-[11pt] bg-slate-100 p-1 border-l-4 border-blue-600 mt-4 mb-2">D. LANGKAH PEMBELAJARAN</div>
                    <div class="pl-4 mb-3" contenteditable="true" id="out-modul-langkah"></div>
                    
                    <div class="signature-area" contenteditable="true">
                        <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name v-kepsek"></div>NIP. <span class="v-nip-kepsek"></span></div>
                        <div class="signature-box"><span class="v-tgl"></span><br>Guru Mata Pelajaran<br><div class="signature-name v-guru"></div>NIP. <span class="v-nip-guru"></span></div>
                    </div>
                </div>

                <div id="wrapper-lkpd" class="paper-preview portrait mt-10">
                    <div class="border-2 border-dashed border-blue-600 p-6 rounded-xl bg-slate-50 h-full">
                        <h1 class="text-center font-bold text-xl text-blue-800 mb-4" contenteditable="true">LEMBAR KERJA PESERTA DIDIK (LKPD)</h1>
                        <div class="flex justify-between border-b border-black pb-2 mb-4 font-bold" contenteditable="true">
                            <span>Nama : .......................</span>
                            <span>Kelas: <span class="v-kls"></span>/<span class="v-rombel"></span></span>
                            <span>Nilai : .....</span>
                        </div>
                        <p class="font-bold text-blue-700">Mata Pelajaran: <span class="v-mapel"></span></p>
                        <p class="font-bold text-blue-700 mb-2">Materi: <span class="v-bab-aktif"></span></p>
                        
                        <div class="space-y-6 mt-6" contenteditable="true">
                            <div class="border border-slate-300 bg-white p-4 rounded-lg min-h-[120px]">1. Tulislah pemahamanmu tentang materi hari ini dengan bahasamu sendiri!</div>
                            <div class="border border-slate-300 bg-white p-4 rounded-lg min-h-[120px]">2. Berikan contoh nyata penerapan materi ini dalam kehidupan sehari-hari!</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-jurnal" class="view-section hidden relative">
                <div class="paper-preview landscape max-w-full">
                    <h1 class="header-title" contenteditable="true">JURNAL PELAKSANAAN PEMBELAJARAN</h1>
                    <table class="identity-table w-1/2" contenteditable="true">
                        <tr><td width="150">Mata Pelajaran</td><td>: <span class="v-mapel"></span></td></tr>
                        <tr><td>Kelas/Semester</td><td>: <span class="v-kls"></span> / <span class="v-smt"></span></td></tr>
                    </table>
                    <table class="doc-table text-sm">
                        <thead>
                            <tr><th width="8%">Hari/Tanggal</th><th width="15%">Materi/Bab</th><th width="40%">Tujuan Pembelajaran (TP)</th><th width="12%">Kehadiran</th><th width="15%">Keterangan</th></tr>
                        </thead>
                        <tbody id="out-jurnal"></tbody>
                    </table>
                    <div class="signature-area" contenteditable="true">
                        <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name v-kepsek"></div>NIP. <span class="v-nip-kepsek"></span></div>
                        <div class="signature-box"><span class="v-tgl"></span><br>Guru Mata Pelajaran<br><div class="signature-name v-guru"></div>NIP. <span class="v-nip-guru"></span></div>
                    </div>
                </div>
            </div>

            <div id="view-absensi" class="view-section hidden relative">
                <div class="paper-preview portrait">
                    <h1 class="header-title" contenteditable="true">DAFTAR HADIR (PRESENSI) SISWA</h1>
                    <table class="identity-table mb-4" contenteditable="true">
                        <tr><td width="150">Mata Pelajaran</td><td>: <span class="v-mapel"></span></td><td width="100">Kelas/Rombel</td><td>: <span class="v-kls"></span> / <span class="v-rombel"></span></td></tr>
                        <tr><td>Semester</td><td>: <span class="v-smt"></span></td><td>Bulan</td><td>: ........................</td></tr>
                    </table>
                    <table class="doc-table text-center text-[9pt]">
                        <thead>
                            <tr>
                                <th rowspan="2" width="5%">No</th>
                                <th rowspan="2" width="25%" class="text-left">Nama Siswa</th>
                                <th colspan="16">Pertemuan Ke- / Tanggal</th>
                            </tr>
                            <tr>
                                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th><th>13</th><th>14</th><th>15</th><th>16</th>
                            </tr>
                        </thead>
                        <tbody id="out-absensi">
                            </tbody>
                    </table>
                    <p class="text-xs italic text-slate-500 mt-2">*Keterangan: Ketik H (Hadir), S (Sakit), I (Izin), A (Alpa). Seluruh kolom default telah diset Hadir (H).</p>
                    
                    <div class="signature-area" contenteditable="true">
                        <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name v-kepsek"></div>NIP. <span class="v-nip-kepsek"></span></div>
                        <div class="signature-box"><span class="v-tgl"></span><br>Guru Mata Pelajaran<br><div class="signature-name v-guru"></div>NIP. <span class="v-nip-guru"></span></div>
                    </div>
                </div>
            </div>

            <div id="view-kktp" class="view-section hidden relative">
                <div class="paper-preview portrait">
                    <h1 class="header-title" contenteditable="true">KRITERIA KETERCAPAIAN TUJUAN PEMBELAJARAN (KKTP)</h1>
                    <table class="identity-table mb-4" contenteditable="true">
                        <tr><td width="150">Mata Pelajaran</td><td>: <span class="v-mapel"></span></td></tr>
                        <tr><td>Kelas/Semester</td><td>: <span class="v-kls"></span> / <span class="v-smt"></span></td></tr>
                    </table>
                    <table class="doc-table">
                        <thead>
                            <tr>
                                <th rowspan="2" width="5%">No</th><th rowspan="2" width="45%">Tujuan Pembelajaran</th>
                                <th colspan="3">Kriteria (Klik Angka Edit)</th><th rowspan="2" width="10%">Nilai KKTP</th>
                            </tr>
                            <tr><th class="text-[8pt]">Kompleksitas</th><th class="text-[8pt]">Daya Dukung</th><th class="text-[8pt]">Intaks Siswa</th></tr>
                        </thead>
                        <tbody id="out-kktp"></tbody>
                    </table>
                    <p class="text-xs italic text-slate-500 mt-2">*Nilai KKTP akhir akan otomatis menghitung rata-rata dari 3 kriteria di atas jika angkanya diubah.</p>
                </div>
                
                <div class="paper-preview landscape max-w-full mt-10">
                    <h1 class="header-title" contenteditable="true">DAFTAR NILAI SUMATIF & FORMATIF</h1>
                    <table class="identity-table w-1/3 mb-4" contenteditable="true">
                        <tr><td width="150">Mata Pelajaran</td><td>: <span class="v-mapel"></span></td></tr>
                        <tr><td>Kelas/Semester</td><td>: <span class="v-kls"></span> / <span class="v-smt"></span></td></tr>
                    </table>
                    <table class="doc-table text-[9pt] text-center">
                        <thead>
                            <tr>
                                <th width="3%" rowspan="2">No</th><th width="20%" rowspan="2" class="text-left">Nama Siswa</th>
                                <th colspan="5">Nilai Sumatif Harian (Per TP/Bab)</th><th width="6%" rowspan="2">STS</th><th width="6%" rowspan="2">SAS</th><th width="6%" rowspan="2" class="bg-blue-100 text-blue-800">Nilai Rapor (NR)</th>
                            </tr>
                            <tr><th>S1</th><th>S2</th><th>S3</th><th>S4</th><th>Rata2</th></tr>
                        </thead>
                        <tbody id="out-nilai">
                            <tr><td>1</td><td class="text-left" contenteditable="true">Ahmad Fulan</td><td contenteditable="true">85</td><td contenteditable="true">80</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true">82.5</td><td contenteditable="true">90</td><td contenteditable="true">85</td><td class="font-bold bg-blue-50" contenteditable="true">85</td></tr>
                            <tr><td>2</td><td class="text-left" contenteditable="true">Siti Fulanah</td><td contenteditable="true">90</td><td contenteditable="true">95</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true">92.5</td><td contenteditable="true">88</td><td contenteditable="true">90</td><td class="font-bold bg-blue-50" contenteditable="true">90.5</td></tr>
                            <tr><td>3</td><td class="text-left" contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td class="font-bold bg-blue-50" contenteditable="true"></td></tr>
                            <tr><td>4</td><td class="text-left" contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td class="font-bold bg-blue-50" contenteditable="true"></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDe4ie2wSPEpNbAgWP-q03vTuHyxc9Jj3E",
            authDomain: "agsa-e5b08.firebaseapp.com",
            projectId: "agsa-e5b08",
            storageBucket: "agsa-e5b08.firebasestorage.app",
            messagingSenderId: "916052746331",
            appId: "1:916052746331:web:357cbadbfd8658f1689f7e"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const provider = new GoogleAuthProvider();

            document.getElementById('btn-login-google').addEventListener('click', () => {
                signInWithPopup(auth, provider).catch(err => {
                    console.log("Firebase bypass (Localhost)");
                    masukSistem();
                });
            });

            onAuthStateChanged(auth, (user) => {
                if (user) masukSistem(user.email);
            });
        } catch(e) {
            document.getElementById('btn-login-google').addEventListener('click', () => masukSistem());
        }

        function masukSistem(email = "guru@sekolah.id") {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-wrapper').classList.remove('hidden');
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('user-email').innerText = email;
            
            const defaultUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1925091593&single=true&output=csv";
            let savedUrl = localStorage.getItem('sa_global_csv') || defaultUrl;
            document.getElementById('in-csv-url').value = savedUrl;
            
            window.Engine.fetchGlobalCSV();
        }
    </script>

    <script>
        const UI = {
            switchTab: function(tabId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.nav-tab').forEach(el => {
                    el.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                    el.classList.add('text-slate-500');
                });
                document.getElementById(`view-${tabId}`).classList.remove('hidden');
                event.currentTarget.classList.remove('text-slate-500');
                event.currentTarget.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            }
        };

        window.Engine = {
            data: {}, 

            fetchGlobalCSV: async function() {
                let url = document.getElementById('in-csv-url').value.trim();
                if(!url) return;
                
                localStorage.setItem('sa_global_csv', url);
                let statusEl = document.getElementById('csvStatus');
                statusEl.style.display = 'block';
                statusEl.className = 'csv-info';
                statusEl.innerHTML = "‚è≥ Mengunduh data dari Cloud...";
                
                try {
                    const proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
                    const response = await fetch(proxyUrl);
                    if(!response.ok) throw new Error("Gagal mengambil data HTTP " + response.status);
                    const csvText = await response.text();
                    this.parseCSV(csvText);
                } catch(err) {
                    statusEl.className = 'csv-info error';
                    statusEl.innerHTML = "‚ùå Error: " + err.message + ". Pastikan Link dipublish ke web.";
                }
            },

            parseCSV: function(csvText) {
                const lines = csvText.split('\n');
                this.data = {};
                let count = 0;

                for(let i=1; i<lines.length; i++) { 
                    let row = lines[i].trim();
                    if(!row) continue;
                    
                    let separator = row.includes(';') ? ';' : ',';
                    let cols = []; let match;
                    const regex = new RegExp(`(\"([^\"]*)\"|[^\"${separator}]+)(?=${separator}|$)`, 'g');
                    while(match = regex.exec(row)) cols.push(match[2] ? match[2] : match[1]);

                    if(cols.length < 5) continue;

                    let mapel  = cols[0] ? cols[0].trim() : "Mata Pelajaran";
                    let fase   = cols[1] ? cols[1].trim() : "";
                    let kls    = cols[2] ? cols[2].trim() : "";
                    let smt    = cols[3] ? cols[3].trim() : "";
                    let elemen = cols[4] ? cols[4].trim() : "";
                    
                    let cpText = cols.length >= 8 ? cols[5].trim() : "Capaian Pembelajaran...";
                    let tpText = cols.length >= 8 ? cols[6].trim() : (cols[5]||"TP...");
                    let p3Text = cols.length >= 8 ? cols[7].trim() : "Beriman Bertakwa, Mandiri";

                    if(!this.data[mapel]) this.data[mapel] = {};
                    if(!this.data[mapel][kls]) this.data[mapel][kls] = {};
                    if(!this.data[mapel][kls][smt]) this.data[mapel][kls][smt] = {};
                    if(!this.data[mapel][kls][smt][elemen]) this.data[mapel][kls][smt][elemen] = { cp: cpText, tps: [] };
                    
                    this.data[mapel][kls][smt][elemen].tps.push({ tp: tpText, p3: p3Text });
                    count++;
                }

                let statusEl = document.getElementById('csvStatus');
                statusEl.className = 'csv-info';
                statusEl.innerHTML = `‚úÖ Sukses membaca <b>${count}</b> TP dari Cloud.`;
                
                this.initDropdowns();
            },

            initDropdowns: function() {
                let mapelSel = document.getElementById('in-mapel');
                mapelSel.innerHTML = "";
                let mapels = Object.keys(this.data);
                if(mapels.length === 0) { mapelSel.innerHTML = "<option value=''>- Kosong -</option>"; return; }
                mapels.forEach(m => {
                    let opt = document.createElement('option'); opt.value=m; opt.text=m; mapelSel.appendChild(opt);
                });
                this.updateKelasList();
            },

            updateKelasList: function() {
                let mapel = document.getElementById('in-mapel').value;
                let klsSel = document.getElementById('in-kelas');
                klsSel.innerHTML = "";
                if(this.data[mapel]) {
                    Object.keys(this.data[mapel]).sort((a,b)=>a-b).forEach(k => {
                        let f = k<=2?'A':k<=4?'B':k<=6?'C':k<=9?'D':k==10?'E':'F';
                        let opt = document.createElement('option'); opt.value=k; opt.text=`Kls ${k} (Fase ${f})`; klsSel.appendChild(opt);
                    });
                }
                this.updateSemesterList();
            },

            updateSemesterList: function() {
                let mapel = document.getElementById('in-mapel').value;
                let kls = document.getElementById('in-kelas').value;
                let smtSel = document.getElementById('in-semester');
                smtSel.innerHTML = "";
                if(this.data[mapel] && this.data[mapel][kls]) {
                    Object.keys(this.data[mapel][kls]).forEach(s => {
                        let opt = document.createElement('option'); opt.value=s; opt.text=s; smtSel.appendChild(opt);
                    });
                }
                this.updateBabList();
            },

            updateBabList: function() {
                let mapel = document.getElementById('in-mapel').value;
                let kls = document.getElementById('in-kelas').value;
                let smt = document.getElementById('in-semester').value;
                let elemSel = document.getElementById('in-elemen');
                elemSel.innerHTML = "";
                if(this.data[mapel] && this.data[mapel][kls] && this.data[mapel][kls][smt]) {
                    Object.keys(this.data[mapel][kls][smt]).forEach(b => {
                        let opt = document.createElement('option'); opt.value=b; opt.text=b; elemSel.appendChild(opt);
                    });
                }
                this.syncAll();
            },

            syncAll: function() {
                let mapel = document.getElementById('in-mapel').value;
                let kls = document.getElementById('in-kelas').value;
                let smt = document.getElementById('in-semester').value;
                let babAktif = document.getElementById('in-elemen').value;
                
                if(!mapel || !kls || !smt) return;

                let thnAwal = parseInt(document.getElementById('in-tahun').value) || 2024;
                let jp = parseInt(document.getElementById('in-jp').value) || 4;
                let hariTarget = parseInt(document.getElementById('in-hari').value);
                
                let kInt = parseInt(kls);
                let f = kInt<=2?'A' : kInt<=4?'B' : kInt<=6?'C' : kInt<=9?'D' : kInt==10?'E' : 'F';

                // Teks UI Sinkronisasi
                document.querySelectorAll('.v-mapel').forEach(e=>e.innerText=mapel);
                document.querySelectorAll('.v-kls').forEach(e=>e.innerText=kls);
                document.querySelectorAll('.v-fase').forEach(e=>e.innerText="Fase "+f);
                document.querySelectorAll('.v-smt').forEach(e=>e.innerText=smt);
                document.querySelectorAll('.v-thn').forEach(e=>e.innerText=`${thnAwal}/${thnAwal+1}`);
                document.querySelectorAll('.v-bab-aktif').forEach(e=>e.innerText=babAktif);
                
                document.querySelectorAll('.v-sekolah').forEach(e=>e.innerText=document.getElementById('in-sekolah').value);
                document.querySelectorAll('.v-kepsek').forEach(e=>e.innerText=document.getElementById('in-kepsek').value);
                document.querySelectorAll('.v-nip-kepsek').forEach(e=>e.innerText=document.getElementById('in-nip-kepsek').value);
                document.querySelectorAll('.v-guru').forEach(e=>e.innerText=document.getElementById('in-guru').value);
                document.querySelectorAll('.v-nip-guru').forEach(e=>e.innerText=document.getElementById('in-nip-guru').value);
                document.querySelectorAll('.v-tgl').forEach(e=>e.innerText=document.getElementById('in-tempat-tgl').value);
                document.querySelectorAll('.v-rombel').forEach(e=>e.innerText=document.getElementById('in-rombel').value);

                // Date Engine
                let liburRaw = document.getElementById('in-libur').value.split(/[\n,]+/);
                let t1=thnAwal, t2=thnAwal+1;
                let liburDB = [`${t1}-08-17`,`${t1}-12-25`,`${t2}-01-01`,`${t2}-05-01`]; 
                liburRaw.forEach(d=>{ if(d.trim()) liburDB.push(d.trim()); });

                let colEvents = new Array(30).fill(null);
                if(smt==="Ganjil"){
                    colEvents[0]="MPLS/Libur"; colEvents[1]="MPLS/Libur"; colEvents[12]="SUMATIF TENGAH SMT"; 
                    colEvents[25]="SUMATIF AKHIR SMT"; colEvents[26]="PENGAYAAN"; colEvents[27]="PEMBAGIAN RAPOR"; colEvents[28]="LIBUR"; colEvents[29]="LIBUR";
                } else {
                    colEvents[0]="LIBUR"; colEvents[11]="SUMATIF TENGAH SMT"; 
                    let sasIdx = (kInt==6 || kInt==9 || kInt==12) ? 20 : 25; 
                    colEvents[sasIdx]="SUMATIF AKHIR SMT / PAT"; colEvents[sasIdx+1]="PENGAYAAN"; colEvents[sasIdx+2]="PEMBAGIAN RAPOR";
                    for(let x=sasIdx+3; x<30; x++) colEvents[x]="LIBUR / LULUS";
                }

                let blnAwal = smt==="Ganjil"?6:0;
                let activeDates = [];
                for(let i=0; i<6; i++) {
                    let b = blnAwal+i; let y = smt==="Ganjil" ? (b>11?t2:t1) : t2;
                    if(b>11) b-=12;
                    let daysInMonth = new Date(y, b+1, 0).getDate();
                    for(let d=1; d<=daysInMonth; d++) {
                        let dt = new Date(y, b, d);
                        if(dt.getDay() === hariTarget) {
                            let strD = `${y}-${String(b+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                            let wIdx = Math.ceil(d/7); if(wIdx>5) wIdx=5;
                            let cIdx = (i*5)+(wIdx-1);
                            if(liburDB.includes(strD)) { if(cIdx<30 && !colEvents[cIdx]) colEvents[cIdx]="LIBUR NASIONAL / KHUSUS"; } 
                            else { if(!colEvents[cIdx]) activeDates.push(dt); }
                        }
                    }
                }

                this.renderATPProta(mapel, kls, smt, jp, activeDates);
                this.renderPromes(jp, colEvents, smt, blnAwal);
                this.renderAbsensiList();
                if(babAktif) this.renderModulDanLainnya(mapel, kls, smt, babAktif, jp);
            },

            renderATPProta: function(mapel, kls, smt, jp, activeDates) {
                let atpMode = document.getElementById('in-atp-mode').value;
                let dataToRender = [];
                
                if(atpMode === "tahun") {
                    if(this.data[mapel] && this.data[mapel][kls]) {
                        if(this.data[mapel][kls]["Ganjil"]) Object.keys(this.data[mapel][kls]["Ganjil"]).forEach(k => dataToRender.push({smt:"Ganjil", bab:k, d:this.data[mapel][kls]["Ganjil"][k]}));
                        if(this.data[mapel][kls]["Genap"]) Object.keys(this.data[mapel][kls]["Genap"]).forEach(k => dataToRender.push({smt:"Genap", bab:k, d:this.data[mapel][kls]["Genap"][k]}));
                    }
                } else {
                    if(this.data[mapel] && this.data[mapel][kls] && this.data[mapel][kls][smt]) {
                        Object.keys(this.data[mapel][kls][smt]).forEach(k => dataToRender.push({smt:smt, bab:k, d:this.data[mapel][kls][smt][k]}));
                    }
                }

                let atpHtml="", protaHtml=""; 
                let dIdx = 0;
                window.promesRows = [];

                dataToRender.forEach((item, index) => {
                    let totalJp = item.d.tps.length * jp;
                    item.d.tps.forEach((tpObj, tIdx) => {
                        let kk = tpObj.tp.match(/mampu\s+([a-zA-Z\-]+)/i);
                        kk = kk ? kk[1].toUpperCase() : "MEMAHAMI";

                        atpHtml += `<tr>`;
                        if(tIdx===0) {
                            atpHtml += `<td rowspan="${item.d.tps.length}" class="text-center">${index+1}</td>
                                        <td rowspan="${item.d.tps.length}" contenteditable="true" class="bg-slate-50"><b>${item.bab}</b><br><span class="text-xs text-slate-600">${item.d.cp}</span></td>`;
                        }
                        atpHtml += `<td contenteditable="true">${tpObj.tp}</td><td class="text-xs text-blue-800" contenteditable="true">${tpObj.p3}</td><td class="font-bold text-amber-600">${kk}</td>`;
                        if(tIdx===0) atpHtml += `<td rowspan="${item.d.tps.length}" class="text-center">${Math.ceil(totalJp/jp)} Minggu<br>${totalJp} JP</td>`;
                        atpHtml += `</tr>`;

                        // PROTA - Teks Bab Normal (Horizontal)
                        protaHtml += `<tr>`;
                        if(tIdx===0) {
                            protaHtml += `<td rowspan="${item.d.tps.length}" class="font-bold text-center">${item.smt}</td>
                                          <td rowspan="${item.d.tps.length}" class="bg-slate-50 font-bold text-center align-middle" contenteditable="true">${item.bab}</td>`;
                        }
                        protaHtml += `<td contenteditable="true">${tpObj.tp}</td>`;
                        if(tIdx===0) protaHtml += `<td rowspan="${item.d.tps.length}" class="font-bold text-center">${totalJp} JP</td>`;
                        protaHtml += `</tr>`;

                        if(atpMode === "semester" || item.smt === smt) {
                            let alok = [];
                            if(dIdx < activeDates.length) { alok.push({date: activeDates[dIdx], jp: jp}); dIdx++; }
                            window.promesRows.push({
                                bab: tIdx===0?item.bab:"", tp: tpObj.tp, jp: jp, alokasi: alok, rowsp: tIdx===0?item.d.tps.length:0
                            });
                        }
                    });
                });
                document.getElementById('out-atp').innerHTML = atpHtml || `<tr><td colspan="6" class="text-center">Data kosong</td></tr>`;
                document.getElementById('out-prota').innerHTML = protaHtml || `<tr><td colspan="4" class="text-center">Data kosong</td></tr>`;
            },

            renderPromes: function(jp, colEvents, smt, blnAwal) {
                let nBulan = smt==="Ganjil" ? ["Jul","Ags","Sep","Okt","Nov","Des"] : ["Jan","Feb","Mar","Apr","Mei","Jun"];
                let th = `<tr><th rowspan="2" width="5%">Bab</th><th rowspan="2" width="25%">Tujuan Pembelajaran</th><th rowspan="2">JP</th>`;
                nBulan.forEach(b=> th+=`<th colspan="5">${b}</th>`);
                th+=`</tr><tr>`; for(let i=0;i<6;i++) th+=`<th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>`; th+=`</tr>`;
                document.getElementById('out-promes-head').innerHTML = th;

                let tb = ""; let rows = window.promesRows || [];
                if(rows.length>0) {
                    rows.forEach((r, idx) => {
                        tb+=`<tr>`;
                        if(r.rowsp>0) tb+=`<td rowspan="${r.rowsp}" class="bg-slate-50"><div class="vertical-text font-bold text-[8pt]">${r.bab}</div></td>`;
                        tb+=`<td contenteditable="true">${r.tp}</td><td class="text-center font-bold">${r.jp}</td>`;
                        
                        for(let c=0; c<30; c++) {
                            if(colEvents[c]) {
                                if(idx===0) tb+=`<td rowspan="${rows.length}" class="bg-slate-100" contenteditable="true"><div class="vertical-event">${colEvents[c]}</div></td>`;
                            } else {
                                let mI=Math.floor(c/5); let wI=(c%5)+1;
                                let tBln = blnAwal+mI; if(tBln>11) tBln-=12;
                                let match = r.alokasi.filter(a=> a.date.getMonth()===tBln && Math.ceil(a.date.getDate()/7)===wI);
                                
                                if(match.length>0) {
                                    tb+=`<td class="bg-blue-100 text-center" contenteditable="true"><span class="cell-jp">${match[0].jp}</span><span class="cell-date">${match[0].date.getDate()}</span></td>`;
                                } else { tb+=`<td contenteditable="true"></td>`; }
                            }
                        }
                        tb+=`</tr>`;
                    });
                } else tb = `<tr><td colspan="33" class="text-center">Kosong</td></tr>`;
                document.getElementById('out-promes-body').innerHTML = tb;
            },

            // FITUR BARU ABSENSI HARIAN
            renderAbsensiList: function() {
                let html = "";
                // Generate 20 Baris Dummy
                for(let i=1; i<=20; i++) {
                    let nama = i===1 ? "Ahmad Fulan" : i===2 ? "Siti Fulanah" : i===3 ? "Budi Santoso" : "";
                    html += `<tr><td class="text-center">${i}</td><td class="text-left" contenteditable="true">${nama}</td>`;
                    // Generate 16 Kolom Presensi (Default 'H')
                    for(let j=0; j<16; j++) {
                        html += `<td contenteditable="true" class="text-center font-bold text-blue-700">H</td>`;
                    }
                    html += `</tr>`;
                }
                document.getElementById('out-absensi').innerHTML = html;
            },

            renderModulDanLainnya: function(mapel, kls, smt, bab, jp) {
                let data = this.data[mapel]?.[kls]?.[smt]?.[bab];
                if(!data) return;

                document.querySelectorAll('.valJpBab').forEach(e=>e.innerText = data.tps.length * jp);
                document.getElementById('out-modul-cp').innerText = data.cp;

                let p3Set = new Set();
                let mdHtml="", kktpHtml="", jurnalHtml="";

                data.tps.forEach((t, i) => {
                    t.p3.split(',').forEach(p=> { if(p.trim()) p3Set.add(p.trim())});
                    mdHtml += `<li><strong>Pertemuan ${i+1}:</strong> ${t.tp}</li>`;
                    
                    kktpHtml += `<tr>`;
                    if(i===0) kktpHtml += `<td rowspan="${data.tps.length}" class="text-center align-middle">${i+1}</td>`;
                    kktpHtml += `<td contenteditable="true">${t.tp}</td>
                                 <td class="kktp-val" contenteditable="true" oninput="Engine.calcKktp(this)">75</td>
                                 <td class="kktp-val" contenteditable="true" oninput="Engine.calcKktp(this)">75</td>
                                 <td class="kktp-val" contenteditable="true" oninput="Engine.calcKktp(this)">75</td>
                                 <td class="kktp-hasil">75</td></tr>`;

                    let dMatch = (window.promesRows||[]).find(pr => pr.tp === t.tp);
                    let dStr = "...../...../20..";
                    if(dMatch && dMatch.alokasi.length>0) {
                        let dt = dMatch.alokasi[0].date;
                        dStr = `${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}/${dt.getFullYear()}`;
                    }
                    // JURNAL: Default Kehadiran adalah Hadir Semua
                    jurnalHtml += `<tr><td class="text-center font-bold" contenteditable="true">${dStr}</td><td contenteditable="true">${bab}</td><td contenteditable="true">${t.tp}</td><td contenteditable="true" class="text-center font-bold text-blue-700">Hadir Semua</td><td contenteditable="true">Kegiatan Berjalan Baik</td></tr>`;
                });

                let p3Html = "<ul class='list-disc'>"; p3Set.forEach(s=> p3Html+=`<li><strong>${s}</strong></li>`); p3Html+="</ul>";
                document.getElementById('out-modul-p3').innerHTML = p3Html;
                document.getElementById('out-modul-tp').innerHTML = `<ul class="list-none">${mdHtml}</ul>`;
                
                let stepHtml="";
                data.tps.forEach((t,i)=>{
                    stepHtml += `<div class="mb-4 bg-slate-50 p-3 rounded border border-slate-200">
                        <div class="font-bold border-b pb-1 mb-2 text-blue-800">Pertemuan ${i+1} (${jp} JP)</div>
                        <ul class="list-disc pl-5">
                            <li><b>Pendahuluan (Mindful):</b> Doa, apersepsi, memberikan pertanyaan pemantik terkait materi hari ini.</li>
                            <li><b>Inti (Meaningful & Joyful):</b> Eksplorasi materi, pengerjaan LKPD secara berkelompok, dan unjuk karya interaktif.</li>
                            <li><b>Penutup:</b> Kesimpulan, refleksi pembelajaran, diakhiri doa bersama.</li>
                        </ul>
                    </div>`;
                });
                document.getElementById('out-modul-langkah').innerHTML = stepHtml;
                document.getElementById('out-kktp').innerHTML = kktpHtml;
                document.getElementById('out-jurnal').innerHTML = jurnalHtml;
            }
        };
    </script>
</body>
</html>
