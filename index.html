<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Guru Super App</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìö</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Plus Jakarta Sans', sans-serif; box-sizing: border-box; }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); min-height: 100vh; margin: 0; }
        
        /* Landing Page */
        .glass-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); }
        .feature-card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .floating { animation: floating 3s ease-in-out infinite; }
        @keyframes floating { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-20px)} }
        .pulse-glow { animation: pulseGlow 2s ease-in-out infinite; }
        @keyframes pulseGlow { 0%,100%{box-shadow:0 0 20px rgba(99,102,241,0.5)} 50%{box-shadow:0 0 40px rgba(99,102,241,0.8)} }
        
        /* Sidebar */
        .sidebar-scroll::-webkit-scrollbar { width: 6px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #6366f1, #8b5cf6); border-radius: 10px; }
        .sidebar-scroll::-webkit-scrollbar-track { background: #1e293b; }
        
        /* Paper Sizes - FIXED */
        .paper-preview { 
            background: white; 
            margin: 20px auto; 
            padding: 12mm 15mm; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
            position: relative; 
            border-radius: 4px;
        }
        .paper-a4-portrait { width: 210mm; min-height: 297mm; }
        .paper-a4-landscape { width: 297mm; min-height: 200mm; }
        .paper-f4-portrait { width: 215mm; min-height: 330mm; }
        .paper-f4-landscape { width: 330mm; min-height: 210mm; }
        
        /* Tables */
        .doc-table { width: 100%; border-collapse: collapse; font-size: 9pt; margin-bottom: 15px; }
        .doc-table th, .doc-table td { border: 1px solid #374151; padding: 4px 6px; text-align: left; vertical-align: top; }
        .doc-table th { background-color: #e5e7eb; font-weight: 600; text-align: center; }
        
        [contenteditable="true"]:hover { background-color: #fef3c7; outline: 1px dashed #f59e0b; }
        
        .kktp-val { background-color: #fef9c3; font-weight: bold; color: #1d4ed8; text-align: center; }
        .kktp-hasil { background-color: #dbeafe; color: #1e40af; text-align: center; font-weight: bold; }
        
        .event-cell { 
            vertical-align: middle !important; 
            text-align: center !important; 
            height: 80px; 
            padding: 2px !important; 
            background-color: #fecaca !important;
        }
        .vertical-event { 
            writing-mode: vertical-rl; 
            transform: rotate(180deg); 
            font-size: 6pt; 
            font-weight: bold; 
            color: #991b1b; 
            white-space: nowrap;
        }
        
        /* SIGNATURE - FIXED FOR PRINT */
        .signature-area { 
            width: 100%;
            display: table;
            table-layout: fixed;
            margin-top: 30px;
            page-break-inside: avoid;
        }
        .signature-box { 
            display: table-cell;
            width: 50%;
            text-align: center; 
            font-size: 10pt;
            vertical-align: top;
            padding: 0 20px;
        }
        .signature-name { 
            font-weight: bold; 
            text-decoration: underline;
            margin-top: 60px; 
            display: block;
        }
        
        /* Navigation */
        .nav-tab.active { color: #6366f1; border-bottom: 3px solid #6366f1; }
        
        /* Modals */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 700px; border-radius: 16px; padding: 24px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; position: relative; }
        
        .btn-gradient { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
        .btn-gradient:hover { box-shadow: 0 10px 30px rgba(99,102,241,0.4); }
        
        /* Mobile */
        @media (max-width: 768px) {
            .sidebar-mobile { position: fixed; left: -100%; top: 0; height: 100vh; z-index: 999; transition: left 0.3s ease; }
            .sidebar-mobile.open { left: 0; }
            .paper-preview { padding: 5mm; margin: 10px; max-width: 100%; overflow-x: auto; transform: scale(0.6); transform-origin: top left; }
        }
        
        /* ============ PRINT STYLES - COMPLETELY FIXED ============ */
        @media print {
            @page { 
                size: A4; 
                margin: 8mm;
            }
            
            @page:first {
                margin-top: 10mm;
            }
            
            *, *::before, *::after {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            html, body {
                width: 100% !important;
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                overflow: visible !important;
                font-size: 9pt !important;
            }
            
            #landing-page, 
            #sidebar, 
            #topbar, 
            .no-print, 
            .modal-overlay, 
            #mobile-menu-btn,
            .nav-tab,
            button:not(.print-include) { 
                display: none !important; 
            }
            
            #app-wrapper {
                display: block !important;
                width: 100% !important;
                height: auto !important;
            }
            
            main, #main-wrapper, #main-content {
                display: block !important;
                width: 100% !important;
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important;
            }
            
            .view-section {
                display: none !important;
            }
            
            .view-section.print-active {
                display: block !important;
            }
            
            .paper-preview { 
                margin: 0 !important; 
                padding: 0 10mm !important;
                box-shadow: none !important; 
                border-radius: 0 !important;
                border: none !important;
                width: 100% !important;
                max-width: 100% !important;
                min-height: auto !important;
                page-break-after: always;
                page-break-inside: avoid;
            }
            
            .paper-preview:last-child { 
                page-break-after: auto; 
            }
            
            /* SIGNATURE FIX - MUST USE TABLE */
            .signature-area {
                width: 100% !important;
                display: table !important;
                table-layout: fixed !important;
                margin-top: 20px !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
            
            .signature-box {
                display: table-cell !important;
                width: 50% !important;
                text-align: center !important;
                vertical-align: top !important;
                padding: 0 15px !important;
            }
            
            .signature-name {
                margin-top: 50px !important;
            }
            
            .doc-table {
                width: 100% !important;
                font-size: 8pt !important;
            }
            
            .doc-table th, .doc-table td {
                padding: 3px 4px !important;
                border: 1px solid #000 !important;
            }
            
            .event-cell {
                background-color: #fecaca !important;
                height: 60px !important;
            }
            
            .kktp-val { background-color: #fef9c3 !important; }
            .kktp-hasil { background-color: #dbeafe !important; }
            
            [contenteditable="true"]:hover { 
                background-color: transparent !important; 
                outline: none !important; 
            }
            
            h1 { font-size: 12pt !important; margin-bottom: 10px !important; }
        }
    </style>
</head>
<body>

    <!-- ==================== LANDING PAGE ==================== -->
    <div id="landing-page" class="min-h-screen">
        <nav class="fixed top-0 left-0 right-0 z-50 glass-card">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16 md:h-20">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 md:w-12 md:h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-xl md:text-2xl shadow-lg">üìö</div>
                        <div>
                            <h1 class="text-lg md:text-xl font-bold text-white">Admin Guru</h1>
                            <p class="text-[10px] md:text-xs text-indigo-300">Super App v2.1</p>
                        </div>
                    </div>
                    <div class="hidden md:flex items-center gap-6">
                        <a href="#features" class="text-white/80 hover:text-white transition">Fitur</a>
                        <a href="#pricing" class="text-white/80 hover:text-white transition">Harga</a>
                        <button onclick="showAuthModal('login')" class="px-6 py-2.5 rounded-full bg-white/10 text-white hover:bg-white/20 transition font-medium">Masuk</button>
                        <button onclick="showAuthModal('register')" class="px-6 py-2.5 rounded-full btn-gradient text-white font-medium">Daftar Gratis</button>
                    </div>
                    <button onclick="toggleMobileNav()" class="md:hidden text-white text-2xl">‚ò∞</button>
                </div>
            </div>
        </nav>

        <div id="mobile-nav" class="fixed inset-0 z-40 bg-slate-900/95 backdrop-blur-lg hidden flex-col items-center justify-center gap-6">
            <button onclick="toggleMobileNav()" class="absolute top-6 right-6 text-white text-3xl">‚úï</button>
            <a href="#features" onclick="toggleMobileNav()" class="text-2xl text-white font-medium">Fitur</a>
            <a href="#pricing" onclick="toggleMobileNav()" class="text-2xl text-white font-medium">Harga</a>
            <button onclick="toggleMobileNav();showAuthModal('login')" class="px-8 py-3 rounded-full bg-white/10 text-white font-medium text-lg">Masuk</button>
            <button onclick="toggleMobileNav();showAuthModal('register')" class="px-8 py-3 rounded-full btn-gradient text-white font-medium text-lg">Daftar Gratis</button>
        </div>

        <section class="pt-28 md:pt-40 pb-20 px-4">
            <div class="max-w-7xl mx-auto">
                <div class="grid lg:grid-cols-2 gap-12 items-center">
                    <div class="text-center lg:text-left">
                        <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full glass-card text-indigo-300 text-sm mb-6">
                            <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                            Kurikulum Merdeka 2024/2025
                        </div>
                        <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold text-white leading-tight mb-6">
                            Administrasi Guru
                            <span class="bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400 bg-clip-text text-transparent"> Lebih Mudah</span>
                        </h1>
                        <p class="text-lg md:text-xl text-slate-300 mb-8 max-w-xl mx-auto lg:mx-0">
                            Buat ATP, Prota, Promes, Modul Ajar, LKPD, Jurnal, dan Soal Otomatis. Kolaborasi dengan guru lain!
                        </p>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center lg:justify-start">
                            <button onclick="showAuthModal('register')" class="px-8 py-4 rounded-2xl btn-gradient text-white font-bold text-lg pulse-glow flex items-center justify-center gap-2">
                                üöÄ Mulai Gratis Sekarang
                            </button>
                            <button onclick="showDemo()" class="px-8 py-4 rounded-2xl glass-card text-white font-semibold hover:bg-white/20 transition flex items-center justify-center gap-2">
                                ‚ñ∂Ô∏è Lihat Demo
                            </button>
                        </div>
                    </div>
                    <div class="relative hidden lg:block">
                        <div class="floating">
                            <div class="glass-card rounded-3xl p-6 shadow-2xl">
                                <div class="bg-slate-800 rounded-2xl p-4 mb-4">
                                    <div class="flex items-center gap-2 mb-3">
                                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                                        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                                    </div>
                                    <div class="space-y-2">
                                        <div class="h-4 bg-gradient-to-r from-indigo-500/30 to-purple-500/30 rounded w-3/4"></div>
                                        <div class="h-3 bg-slate-700 rounded w-full"></div>
                                        <div class="h-3 bg-slate-700 rounded w-5/6"></div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-3">
                                    <div class="bg-indigo-500/20 rounded-xl p-3 text-center">
                                        <div class="text-2xl mb-1">üìã</div>
                                        <p class="text-xs text-indigo-300">ATP</p>
                                    </div>
                                    <div class="bg-purple-500/20 rounded-xl p-3 text-center">
                                        <div class="text-2xl mb-1">üìÖ</div>
                                        <p class="text-xs text-purple-300">Promes</p>
                                    </div>
                                    <div class="bg-pink-500/20 rounded-xl p-3 text-center">
                                        <div class="text-2xl mb-1">üìù</div>
                                        <p class="text-xs text-pink-300">Soal</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="features" class="py-20 px-4">
            <div class="max-w-7xl mx-auto">
                <div class="text-center mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">Fitur Lengkap</h2>
                    <p class="text-slate-400 max-w-2xl mx-auto">Semua kebutuhan administrasi dalam satu platform</p>
                </div>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="feature-card glass-card rounded-2xl p-6 border-2 border-green-500/30 transition-all duration-300">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-green-400 to-emerald-600 flex items-center justify-center text-2xl mb-4 shadow-lg">üìÖ</div>
                        <div class="flex items-center gap-2 mb-2">
                            <h3 class="text-xl font-bold text-white">Kalender Pendidikan</h3>
                            <span class="px-2 py-0.5 rounded-full bg-green-500/20 text-green-400 text-xs font-bold">GRATIS</span>
                        </div>
                        <p class="text-slate-400">Kalender pendidikan otomatis dengan libur nasional.</p>
                    </div>
                    <div class="feature-card glass-card rounded-2xl p-6 border-2 border-green-500/30 transition-all duration-300">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-400 to-cyan-600 flex items-center justify-center text-2xl mb-4 shadow-lg">üïê</div>
                        <div class="flex items-center gap-2 mb-2">
                            <h3 class="text-xl font-bold text-white">Jadwal Pelajaran</h3>
                            <span class="px-2 py-0.5 rounded-full bg-green-500/20 text-green-400 text-xs font-bold">GRATIS</span>
                        </div>
                        <p class="text-slate-400">Kolaborasi jadwal dengan guru se-NPSN.</p>
                    </div>
                    <div class="feature-card glass-card rounded-2xl p-6 border-2 border-green-500/30 transition-all duration-300">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-indigo-400 to-violet-600 flex items-center justify-center text-2xl mb-4 shadow-lg">üìã</div>
                        <div class="flex items-center gap-2 mb-2">
                            <h3 class="text-xl font-bold text-white">ATP & Prota</h3>
                            <span class="px-2 py-0.5 rounded-full bg-green-500/20 text-green-400 text-xs font-bold">GRATIS</span>
                        </div>
                        <p class="text-slate-400">ATP dan Prota otomatis dari database kurikulum.</p>
                    </div>
                    <div class="feature-card glass-card rounded-2xl p-6 border-2 border-amber-500/30 transition-all duration-300">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-amber-400 to-orange-600 flex items-center justify-center text-2xl mb-4 shadow-lg">üìÜ</div>
                        <div class="flex items-center gap-2 mb-2">
                            <h3 class="text-xl font-bold text-white">Program Semester</h3>
                            <span class="px-2 py-0.5 rounded-full bg-amber-500/20 text-amber-400 text-xs font-bold">PRO</span>
                        </div>
                        <p class="text-slate-400">Promes dengan minggu efektif dan libur.</p>
                    </div>
                    <div class="feature-card glass-card rounded-2xl p-6 border-2 border-amber-500/30 transition-all duration-300">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-pink-400 to-rose-600 flex items-center justify-center text-2xl mb-4 shadow-lg">üìñ</div>
                        <div class="flex items-center gap-2 mb-2">
                            <h3 class="text-xl font-bold text-white">Modul & LKPD</h3>
                            <span class="px-2 py-0.5 rounded-full bg-amber-500/20 text-amber-400 text-xs font-bold">PRO</span>
                        </div>
                        <p class="text-slate-400">Modul ajar dan LKPD siap pakai.</p>
                    </div>
                    <div class="feature-card glass-card rounded-2xl p-6 border-2 border-amber-500/30 transition-all duration-300">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-purple-400 to-fuchsia-600 flex items-center justify-center text-2xl mb-4 shadow-lg">ü§ñ</div>
                        <div class="flex items-center gap-2 mb-2">
                            <h3 class="text-xl font-bold text-white">Generator Soal AI</h3>
                            <span class="px-2 py-0.5 rounded-full bg-amber-500/20 text-amber-400 text-xs font-bold">PRO</span>
                        </div>
                        <p class="text-slate-400">Generate soal PG, Essay dari TP.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="pricing" class="py-20 px-4">
            <div class="max-w-5xl mx-auto">
                <div class="text-center mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">Pilih Paket</h2>
                </div>
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="glass-card rounded-3xl p-8 border-2 border-slate-600">
                        <h3 class="text-2xl font-bold text-white mb-2">Gratis</h3>
                        <div class="text-4xl font-extrabold text-white mb-6">Rp 0</div>
                        <ul class="space-y-3 mb-8">
                            <li class="flex items-center gap-3 text-slate-300"><span class="text-green-400">‚úì</span> Kalender Pendidikan</li>
                            <li class="flex items-center gap-3 text-slate-300"><span class="text-green-400">‚úì</span> Jadwal Pelajaran</li>
                            <li class="flex items-center gap-3 text-slate-300"><span class="text-green-400">‚úì</span> ATP & Prota</li>
                            <li class="flex items-center gap-3 text-slate-500"><span class="text-slate-600">‚úï</span> Promes & Modul</li>
                            <li class="flex items-center gap-3 text-slate-500"><span class="text-slate-600">‚úï</span> Generator Soal AI</li>
                        </ul>
                        <button onclick="showAuthModal('register')" class="w-full py-4 rounded-2xl border-2 border-slate-500 text-white font-bold hover:bg-slate-800 transition">Daftar Gratis</button>
                    </div>
                    <div class="glass-card rounded-3xl p-8 border-2 border-indigo-500 relative">
                        <div class="absolute top-6 right-6 px-4 py-1 rounded-full bg-gradient-to-r from-amber-400 to-orange-500 text-white text-sm font-bold">POPULER</div>
                        <h3 class="text-2xl font-bold text-white mb-2">Pro</h3>
                        <div class="text-4xl font-extrabold text-white mb-6">Rp 49.000<span class="text-lg font-normal text-slate-400">/bln</span></div>
                        <ul class="space-y-3 mb-8">
                            <li class="flex items-center gap-3 text-slate-300"><span class="text-green-400">‚úì</span> Semua Fitur Gratis</li>
                            <li class="flex items-center gap-3 text-slate-300"><span class="text-green-400">‚úì</span> Promes & Modul</li>
                            <li class="flex items-center gap-3 text-slate-300"><span class="text-green-400">‚úì</span> Jurnal & Absensi</li>
                            <li class="flex items-center gap-3 text-slate-300"><span class="text-green-400">‚úì</span> KKTP & Nilai</li>
                            <li class="flex items-center gap-3 text-slate-300"><span class="text-green-400">‚úì</span> Generator Soal AI</li>
                        </ul>
                        <button onclick="showAuthModal('register')" class="w-full py-4 rounded-2xl btn-gradient text-white font-bold">Upgrade Pro</button>
                    </div>
                </div>
            </div>
        </section>

        <footer class="py-10 px-4 border-t border-slate-800">
            <div class="max-w-7xl mx-auto text-center">
                <p class="text-slate-400">¬© 2024 Admin Guru Super App</p>
            </div>
        </footer>
    </div>

    <!-- ==================== AUTH MODAL ==================== -->
    <div id="modal-auth" class="modal-overlay">
        <div class="modal-content max-w-md">
            <button onclick="closeModal('modal-auth')" class="absolute top-4 right-4 w-10 h-10 rounded-full bg-slate-100 hover:bg-red-100 flex items-center justify-center text-xl">‚úï</button>
            
            <div id="auth-login" class="auth-form">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-3xl mx-auto mb-4">üìö</div>
                    <h2 class="text-2xl font-bold text-slate-800">Masuk</h2>
                </div>
                <div class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="w-full px-4 py-3 rounded-xl border border-slate-300 outline-none focus:border-indigo-500">
                    <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-3 rounded-xl border border-slate-300 outline-none focus:border-indigo-500">
                    <button onclick="handleLogin()" class="w-full py-4 rounded-xl btn-gradient text-white font-bold">Masuk</button>
                    <button onclick="handleGoogleLogin()" class="w-full py-4 rounded-xl border-2 border-slate-200 font-semibold hover:bg-slate-50 flex items-center justify-center gap-3">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Google
                    </button>
                </div>
                <p class="text-center mt-6 text-slate-500">Belum punya akun? <button onclick="showAuthModal('register')" class="text-indigo-600 font-semibold">Daftar</button></p>
            </div>

            <div id="auth-register" class="auth-form hidden">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-3xl mx-auto mb-4">üìö</div>
                    <h2 class="text-2xl font-bold text-slate-800">Daftar</h2>
                </div>
                <div class="space-y-4">
                    <input type="text" id="reg-name" placeholder="Nama Lengkap" class="w-full px-4 py-3 rounded-xl border border-slate-300 outline-none focus:border-indigo-500">
                    <input type="text" id="reg-npsn" placeholder="NPSN (8 digit)" maxlength="8" class="w-full px-4 py-3 rounded-xl border border-slate-300 outline-none focus:border-indigo-500">
                    <input type="email" id="reg-email" placeholder="Email" class="w-full px-4 py-3 rounded-xl border border-slate-300 outline-none focus:border-indigo-500">
                    <input type="password" id="reg-password" placeholder="Password (min 6)" class="w-full px-4 py-3 rounded-xl border border-slate-300 outline-none focus:border-indigo-500">
                    <button onclick="handleRegister()" class="w-full py-4 rounded-xl btn-gradient text-white font-bold">Daftar</button>
                </div>
                <p class="text-center mt-6 text-slate-500">Sudah punya akun? <button onclick="showAuthModal('login')" class="text-indigo-600 font-semibold">Masuk</button></p>
            </div>
        </div>
    </div>

    <!-- ==================== MAIN APP ==================== -->
    <div id="app-wrapper" class="hidden flex h-screen">
        
        <button id="mobile-menu-btn" onclick="toggleSidebar()" class="fixed top-4 left-4 z-50 w-12 h-12 rounded-xl bg-indigo-600 text-white flex items-center justify-center text-2xl shadow-lg md:hidden no-print">‚ò∞</button>

        <aside id="sidebar" class="sidebar-mobile md:relative w-80 min-w-[320px] bg-slate-900 text-slate-300 flex flex-col h-full border-r border-slate-700 no-print overflow-hidden">
            <div class="p-4 border-b border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-xl">üìö</div>
                    <div class="flex-1 min-w-0">
                        <h2 class="text-lg font-bold text-white">Super App</h2>
                        <div class="flex items-center gap-2">
                            <span id="user-plan-badge" class="px-2 py-0.5 rounded text-xs font-bold bg-slate-700 text-slate-400">FREE</span>
                            <span id="user-email-display" class="text-xs truncate">user@email.com</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2 mt-3">
                    <button onclick="showModal('modal-panduan')" class="flex-1 text-xs bg-slate-800 hover:bg-slate-700 text-white px-2 py-2 rounded-lg">üìñ Panduan</button>
                    <button id="btn-admin-panel" onclick="showModal('modal-admin')" class="flex-1 text-xs bg-amber-600 hover:bg-amber-500 text-white px-2 py-2 rounded-lg hidden">‚öôÔ∏è Admin</button>
                    <button onclick="handleLogout()" class="flex-1 text-xs bg-red-600/20 hover:bg-red-600/30 text-red-400 px-2 py-2 rounded-lg">üö™ Keluar</button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-3 space-y-3 sidebar-scroll text-sm">
                
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="showModal('modal-siswa')" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 rounded-xl flex flex-col items-center gap-1">
                        <span class="text-lg">üë•</span>
                        <span class="text-[10px]">Data Siswa</span>
                    </button>
                    <button onclick="showModal('modal-soal')" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 rounded-xl flex flex-col items-center gap-1">
                        <span class="text-lg">ü§ñ</span>
                        <span class="text-[10px]">Generator Soal</span>
                    </button>
                </div>

                <div class="bg-indigo-900/30 border border-indigo-500/30 rounded-xl p-3">
                    <h3 class="text-xs font-bold text-indigo-400 uppercase mb-2">üè´ NPSN Sekolah</h3>
                    <input type="text" id="in-npsn" placeholder="8 digit" maxlength="8" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 text-center text-lg tracking-widest font-mono outline-none focus:border-indigo-500">
                    <button onclick="Engine.syncNPSN()" class="w-full mt-2 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-1.5 rounded-lg text-xs">üîó Sinkronkan</button>
                </div>

                <div class="bg-amber-900/20 border border-amber-500/30 rounded-xl p-3">
                    <h3 class="text-xs font-bold text-amber-400 mb-2">üìÑ UKURAN KERTAS</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="in-paper-size" class="bg-slate-800 border border-slate-600 rounded-lg p-1.5 text-xs outline-none cursor-pointer">
                            <option value="a4">A4</option>
                            <option value="f4">F4/Folio</option>
                        </select>
                        <select id="in-paper-orient" class="bg-slate-800 border border-slate-600 rounded-lg p-1.5 text-xs outline-none cursor-pointer">
                            <option value="landscape">Landscape</option>
                            <option value="portrait">Portrait</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] text-amber-400 uppercase font-bold">Tipe Guru</label>
                    <select id="in-tipe-guru" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 outline-none text-white font-bold cursor-pointer">
                        <option value="kelas">Guru Kelas</option>
                        <option value="mapel" selected>Guru Mapel</option>
                    </select>
                </div>

                <div class="border border-dashed border-amber-500/50 p-3 rounded-xl bg-amber-500/5">
                    <h3 class="text-xs font-bold text-amber-400 mb-2">üìö DATABASE KURIKULUM</h3>
                    <select id="in-jenjang" onchange="Engine.fetchGlobalCSV()" class="w-full bg-slate-950 border border-slate-600 rounded-lg p-2 text-sm outline-none text-white font-bold cursor-pointer mb-2">
                        <option value="SD">SD / MI</option>
                        <option value="SMP">SMP / MTs</option>
                        <option value="SMA">SMA / SMK / MA</option>
                    </select>
                    <div class="flex gap-2">
                        <button onclick="Engine.fetchGlobalCSV()" class="flex-1 bg-amber-600 hover:bg-amber-500 text-white font-bold py-1.5 rounded-lg text-xs">‚òÅÔ∏è Cloud</button>
                        <div class="flex-1 relative">
                            <input type="file" accept=".csv" onchange="Engine.uploadCSV(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            <button class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-1.5 rounded-lg text-xs border border-slate-500">üìÅ Upload</button>
                        </div>
                    </div>
                    <div id="csvStatus" class="mt-2 p-2 rounded-lg text-xs hidden"></div>
                </div>

                <div>
                    <h3 class="text-xs font-bold text-slate-400 mb-2">üìå MAPEL & KELAS</h3>
                    <div class="space-y-2">
                        <select id="in-mapel" onchange="Engine.updateKelasList()" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 outline-none font-bold text-blue-400 cursor-pointer"><option value="">-- Pilih Mapel --</option></select>
                        <div class="grid grid-cols-2 gap-2">
                            <select id="in-kelas" onchange="Engine.updateSemesterList()" class="bg-slate-800 border border-slate-600 rounded-lg p-2 outline-none cursor-pointer"><option value="">Kelas</option></select>
                            <select id="in-semester" onchange="Engine.updateBabList();Engine.generateDefaultCalendar()" class="bg-slate-800 border border-slate-600 rounded-lg p-2 outline-none cursor-pointer"><option value="">Smt</option></select>
                        </div>
                        <select id="in-elemen" onchange="Engine.syncAll()" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 outline-none cursor-pointer"><option value="">-- Bab/Elemen --</option></select>
                    </div>
                </div>

                <div>
                    <h3 class="text-xs font-bold text-slate-400 mb-2">üè´ IDENTITAS</h3>
                    <div class="space-y-1.5">
                        <input type="text" id="in-sekolah" placeholder="Nama Sekolah" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 outline-none text-sm" value="SDN Cerdas Bangsa">
                        <input type="text" id="in-kepsek" placeholder="Kepala Sekolah" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 outline-none text-sm" value="Budi, S.Pd., M.Pd.">
                        <input type="text" id="in-nip-kepsek" placeholder="NIP Kepsek" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 outline-none text-sm" value="19800101 200501 1 001">
                        <input type="text" id="in-guru" placeholder="Nama Guru" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 outline-none text-sm" value="Siti Aminah, S.Pd.">
                        <input type="text" id="in-nip-guru" placeholder="NIP Guru" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 outline-none text-sm" value="19900202 201502 2 002">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="in-rombel" placeholder="Rombel" class="bg-slate-800 border border-slate-600 rounded-lg p-2 outline-none text-sm text-center" value="A">
                            <input type="number" id="in-tahun" placeholder="Tahun" class="bg-slate-800 border border-slate-600 rounded-lg p-2 outline-none text-sm text-center" value="2025" onchange="Engine.generateDefaultCalendar()">
                        </div>
                        <input type="text" id="in-tempat-tgl" placeholder="Tempat TTD" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 outline-none text-sm" value="Jakarta">
                    </div>
                </div>

                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs font-bold text-slate-400">üìÖ KALENDER</h3>
                        <button onclick="Engine.generateDefaultCalendar()" class="text-[10px] bg-indigo-600 hover:bg-indigo-500 text-white px-2 py-1 rounded">üîÑ Reset</button>
                    </div>
                    <div class="space-y-2">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-[10px] text-slate-500">Hari Mengajar</label>
                                <select id="in-hari" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 outline-none cursor-pointer">
                                    <option value="1">Senin</option>
                                    <option value="2">Selasa</option>
                                    <option value="3">Rabu</option>
                                    <option value="4">Kamis</option>
                                    <option value="5">Jum'at</option>
                                    <option value="6">Sabtu</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500">JP/Pertemuan</label>
                                <input type="number" id="in-jp" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 outline-none text-center" value="4">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] text-amber-400 uppercase font-bold">Agenda & Libur</label>
                            <textarea id="in-libur" rows="8" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 text-[10px] outline-none text-slate-200 font-mono"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-3 border-t border-slate-700 space-y-2">
                <button onclick="Engine.saveAllData()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-semibold py-2.5 rounded-xl flex items-center justify-center gap-2">
                    üíæ Simpan
                </button>
                <button onclick="Engine.syncAll()" class="w-full btn-gradient text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2">
                    üöÄ RENDER
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-slate-100 overflow-hidden" id="main-wrapper">
            <header id="topbar" class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-3 md:px-6 no-print shadow-sm">
                <div class="flex items-center gap-1 overflow-x-auto pl-10 md:pl-0 flex-1">
                    <button onclick="UI.switchTab('kalender')" data-tab="kalender" class="nav-tab px-2 md:px-3 py-2 text-[11px] md:text-sm font-medium text-slate-500 hover:text-indigo-600 whitespace-nowrap">üìÖ Kalender</button>
                    <button onclick="UI.switchTab('jadwal')" data-tab="jadwal" class="nav-tab px-2 md:px-3 py-2 text-[11px] md:text-sm font-medium text-slate-500 hover:text-indigo-600 whitespace-nowrap">üïê Jadwal</button>
                    <button onclick="UI.switchTab('atp')" data-tab="atp" class="nav-tab active px-2 md:px-3 py-2 text-[11px] md:text-sm font-medium text-indigo-600 whitespace-nowrap">üìã ATP</button>
                    <button onclick="UI.switchTab('promes')" data-tab="promes" class="nav-tab px-2 md:px-3 py-2 text-[11px] md:text-sm font-medium text-slate-500 hover:text-indigo-600 whitespace-nowrap">üìÜ Promes</button>
                    <button onclick="UI.switchTab('modul')" data-tab="modul" class="nav-tab px-2 md:px-3 py-2 text-[11px] md:text-sm font-medium text-slate-500 hover:text-indigo-600 whitespace-nowrap">üìñ Modul</button>
                    <button onclick="UI.switchTab('jurnal')" data-tab="jurnal" class="nav-tab px-2 md:px-3 py-2 text-[11px] md:text-sm font-medium text-slate-500 hover:text-indigo-600 whitespace-nowrap">üìù Jurnal</button>
                    <button onclick="UI.switchTab('absensi')" data-tab="absensi" class="nav-tab px-2 md:px-3 py-2 text-[11px] md:text-sm font-medium text-slate-500 hover:text-indigo-600 whitespace-nowrap">‚úÖ Absensi</button>
                    <button onclick="UI.switchTab('kktp')" data-tab="kktp" class="nav-tab px-2 md:px-3 py-2 text-[11px] md:text-sm font-medium text-slate-500 hover:text-indigo-600 whitespace-nowrap">üìä KKTP</button>
                    <button onclick="UI.switchTab('soal')" data-tab="soal" class="nav-tab px-2 md:px-3 py-2 text-[11px] md:text-sm font-medium text-slate-500 hover:text-indigo-600 whitespace-nowrap">ü§ñ Soal</button>
                </div>
                <button onclick="printDocument()" class="bg-slate-800 text-white px-3 md:px-4 py-2 rounded-xl text-xs md:text-sm font-semibold hover:bg-slate-700 shadow flex items-center gap-2 ml-2">
                    üñ®Ô∏è <span class="hidden md:inline">Cetak</span>
                </button>
            </header>

            <div id="main-content" class="flex-1 overflow-y-auto p-4 md:p-6">
                
                <!-- KALENDER VIEW -->
                <div id="view-kalender" class="view-section hidden">
                    <div class="paper-preview paper-a4-portrait" id="doc-kalender">
                        <h1 class="text-center text-[13pt] font-bold mb-4 uppercase">KALENDER PENDIDIKAN<br>TAHUN PELAJARAN <span class="v-thn"></span></h1>
                        <table class="mb-3" style="font-size: 10pt; width: 100%;">
                            <tr><td width="140">Satuan Pendidikan</td><td>: <span class="v-sekolah"></span></td></tr>
                        </table>
                        <div id="out-kalender" class="grid grid-cols-3 gap-2 text-[8pt]"></div>
                        
                        <div class="signature-area">
                            <div class="signature-box">
                                Mengetahui,<br>Kepala Sekolah
                                <span class="signature-name v-kepsek"></span>
                                NIP. <span class="v-nip-kepsek"></span>
                            </div>
                            <div class="signature-box">
                                <span class="v-tempat-tgl"></span><br>Guru
                                <span class="signature-name v-guru"></span>
                                NIP. <span class="v-nip-guru"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- JADWAL VIEW -->
                <div id="view-jadwal" class="view-section hidden">
                    <div class="no-print mb-4 bg-white p-3 rounded-xl shadow flex flex-wrap items-center gap-3">
                        <span class="text-sm font-semibold text-slate-600">NPSN:</span>
                        <span id="jadwal-npsn-display" class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-lg font-mono font-bold">-</span>
                        <button onclick="Engine.loadJadwalKolaborasi()" class="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-indigo-500">üîÑ Refresh</button>
                    </div>
                    <div class="paper-preview paper-a4-landscape" id="doc-jadwal">
                        <h1 class="text-center text-[13pt] font-bold mb-4 uppercase">JADWAL PELAJARAN<br>TAHUN PELAJARAN <span class="v-thn"></span></h1>
                        <table class="mb-3" style="font-size: 10pt; width: 50%;">
                            <tr><td width="140">Satuan Pendidikan</td><td>: <span class="v-sekolah"></span></td></tr>
                            <tr><td>Kelas/Rombel</td><td>: <span class="v-kls"></span> / <span class="v-rombel"></span></td></tr>
                        </table>
                        <table class="doc-table">
                            <thead>
                                <tr><th width="5%">Jam</th><th width="9%">Waktu</th><th>Senin</th><th>Selasa</th><th>Rabu</th><th>Kamis</th><th>Jum'at</th><th>Sabtu</th></tr>
                            </thead>
                            <tbody id="out-jadwal"></tbody>
                        </table>
                        
                        <div class="signature-area">
                            <div class="signature-box">
                                Mengetahui,<br>Kepala Sekolah
                                <span class="signature-name v-kepsek"></span>
                                NIP. <span class="v-nip-kepsek"></span>
                            </div>
                            <div class="signature-box">
                                <span class="v-tempat-tgl"></span><br>Wali Kelas
                                <span class="signature-name v-guru"></span>
                                NIP. <span class="v-nip-guru"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ATP VIEW -->
                <div id="view-atp" class="view-section">
                    <div class="no-print mb-4 flex flex-wrap gap-2 justify-end">
                        <select id="in-atp-mode" onchange="Engine.syncAll()" class="p-2 border border-slate-300 rounded-xl text-sm outline-none bg-white font-bold text-indigo-700 cursor-pointer">
                            <option value="semester">1 Semester</option>
                            <option value="tahun">1 Tahun</option>
                        </select>
                    </div>
                    
                    <div class="paper-preview paper-a4-landscape" id="doc-atp">
                        <h1 class="text-center text-[13pt] font-bold mb-4 uppercase">ALUR TUJUAN PEMBELAJARAN (ATP)<br>TAHUN PELAJARAN <span class="v-thn"></span></h1>
                        <table style="width:100%; font-size: 10pt; margin-bottom:10px;">
                            <tr>
                                <td width="50%"><b>Sekolah:</b> <span class="v-sekolah"></span></td>
                                <td><b>Kelas:</b> <span class="v-kls"></span></td>
                            </tr>
                            <tr>
                                <td><b>Mapel:</b> <span class="v-mapel text-blue-700"></span></td>
                                <td><b>Semester:</b> <span class="v-smt"></span></td>
                            </tr>
                            <tr>
                                <td><b>Fase:</b> <span class="v-fase"></span></td>
                                <td></td>
                            </tr>
                        </table>
                        <table class="doc-table">
                            <thead><tr><th width="3%">NO</th><th width="18%">ELEMEN & CP</th><th width="28%">TUJUAN PEMBELAJARAN</th><th width="12%">P. PELAJAR</th><th width="9%">KOMPETENSI</th><th width="8%">WAKTU</th></tr></thead>
                            <tbody id="out-atp"><tr><td colspan="6" class="text-center italic text-slate-400 py-6">Pilih mapel dan kelas, lalu klik RENDER...</td></tr></tbody>
                        </table>
                        
                        <div class="signature-area">
                            <div class="signature-box">
                                Mengetahui,<br>Kepala Sekolah
                                <span class="signature-name v-kepsek"></span>
                                NIP. <span class="v-nip-kepsek"></span>
                            </div>
                            <div class="signature-box">
                                <span class="v-tempat-tgl"></span><br>Guru Mata Pelajaran
                                <span class="signature-name v-guru"></span>
                                NIP. <span class="v-nip-guru"></span>
                            </div>
                        </div>
                    </div>

                    <div class="paper-preview paper-a4-portrait" id="doc-prota">
                        <h1 class="text-center text-[13pt] font-bold mb-4 uppercase">PROGRAM TAHUNAN (PROTA)<br><span class="v-mapel uppercase"></span></h1>
                        <table class="mb-3" style="font-size: 10pt; width: 100%;">
                            <tr><td width="140">Satuan Pendidikan</td><td>: <span class="v-sekolah"></span></td></tr>
                            <tr><td>Fase / Kelas</td><td>: <span class="v-fase"></span> / <span class="v-kls"></span></td></tr>
                            <tr><td>Tahun Pelajaran</td><td>: <span class="v-thn"></span></td></tr>
                        </table>
                        <table class="doc-table">
                            <thead><tr><th width="10%">Smt</th><th width="25%">Elemen & CP</th><th width="55%">Tujuan Pembelajaran</th><th width="10%">JP</th></tr></thead>
                            <tbody id="out-prota"></tbody>
                        </table>
                        
                        <div class="signature-area">
                            <div class="signature-box">
                                Mengetahui,<br>Kepala Sekolah
                                <span class="signature-name v-kepsek"></span>
                                NIP. <span class="v-nip-kepsek"></span>
                            </div>
                            <div class="signature-box">
                                <span class="v-tempat-tgl"></span><br>Guru Mata Pelajaran
                                <span class="signature-name v-guru"></span>
                                NIP. <span class="v-nip-guru"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PROMES VIEW -->
                <div id="view-promes" class="view-section hidden">
                    <div id="premium-gate-promes" class="bg-gradient-to-br from-amber-50 to-orange-100 rounded-2xl p-8 text-center mb-6">
                        <div class="text-5xl mb-4">üîí</div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">Fitur Premium</h3>
                        <p class="text-slate-600 mb-4">Program Semester untuk pengguna Pro</p>
                        <button onclick="showUpgradeModal()" class="px-6 py-3 rounded-xl btn-gradient text-white font-bold">Upgrade Pro</button>
                    </div>
                    <div id="content-promes" class="hidden">
                        <div class="paper-preview paper-a4-landscape" id="doc-promes">
                            <h1 class="text-center text-[13pt] font-bold mb-4 uppercase">PROGRAM SEMESTER (PROSEM)<br>SEMESTER <span class="v-smt uppercase"></span></h1>
                            <table class="mb-3" style="font-size: 10pt; width: 60%;">
                                <tr><td width="140">Mata Pelajaran</td><td>: <span class="v-mapel"></span></td></tr>
                                <tr><td>Kelas/Rombel</td><td>: <span class="v-kls"></span> / <span class="v-rombel"></span></td></tr>
                                <tr><td>Tahun Pelajaran</td><td>: <span class="v-thn"></span></td></tr>
                            </table>
                            <table class="doc-table text-[6pt]">
                                <thead id="out-promes-head"></thead>
                                <tbody id="out-promes-body"></tbody>
                            </table>
                            
                            <div class="signature-area">
                                <div class="signature-box">
                                    Mengetahui,<br>Kepala Sekolah
                                    <span class="signature-name v-kepsek"></span>
                                    NIP. <span class="v-nip-kepsek"></span>
                                </div>
                                <div class="signature-box">
                                    <span class="v-tempat-tgl"></span><br>Guru Mata Pelajaran
                                    <span class="signature-name v-guru"></span>
                                    NIP. <span class="v-nip-guru"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODUL VIEW -->
                <div id="view-modul" class="view-section hidden">
                    <div id="premium-gate-modul" class="bg-gradient-to-br from-amber-50 to-orange-100 rounded-2xl p-8 text-center mb-6">
                        <div class="text-5xl mb-4">üîí</div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">Fitur Premium</h3>
                        <p class="text-slate-600 mb-4">Modul Ajar & LKPD untuk pengguna Pro</p>
                        <button onclick="showUpgradeModal()" class="px-6 py-3 rounded-xl btn-gradient text-white font-bold">Upgrade Pro</button>
                    </div>
                    <div id="content-modul" class="hidden">
                        <div class="no-print mb-4 bg-white p-3 rounded-xl shadow flex items-center gap-4">
                            <label class="flex items-center gap-2 text-sm font-semibold cursor-pointer text-indigo-600">
                                <input type="checkbox" checked onchange="document.getElementById('wrapper-lkpd').classList.toggle('hidden')"> Tampilkan LKPD
                            </label>
                        </div>
                        <div class="paper-preview paper-a4-portrait" id="doc-modul">
                            <h1 class="text-center text-[13pt] font-bold mb-4 uppercase">MODUL AJAR KURIKULUM MERDEKA</h1>
                            <div class="font-bold text-[10pt] bg-slate-100 p-1.5 border-l-4 border-indigo-600 mb-2">A. IDENTITAS</div>
                            <table style="font-size: 10pt; width: 100%;">
                                <tr><td width="130">Penyusun</td><td>: <span class="v-guru"></span></td></tr>
                                <tr><td>Mapel</td><td>: <span class="v-mapel"></span></td></tr>
                                <tr><td>Kelas/Smt/Rombel</td><td>: <span class="v-kls"></span> / <span class="v-smt"></span> / <span class="v-rombel"></span></td></tr>
                                <tr><td>Topik</td><td>: <span class="v-bab-aktif text-indigo-600 font-bold"></span></td></tr>
                                <tr><td>Alokasi Waktu</td><td>: <span class="v-jp-bab"></span> JP</td></tr>
                            </table>
                            <div class="font-bold text-[10pt] bg-slate-100 p-1.5 border-l-4 border-indigo-600 mt-3 mb-2">B. CAPAIAN & TUJUAN</div>
                            <div class="pl-3 mb-2">
                                <p id="out-modul-cp" class="mb-2 bg-indigo-50 p-2 rounded border border-indigo-100 text-[9pt] text-justify"></p>
                                <div id="out-modul-tp" class="text-[9pt]"></div>
                            </div>
                            <div class="font-bold text-[10pt] bg-slate-100 p-1.5 border-l-4 border-indigo-600 mt-3 mb-2">C. LANGKAH KBM</div>
                            <div class="pl-3 text-[9pt]" id="out-modul-langkah"></div>
                            
                            <div class="signature-area">
                                <div class="signature-box">
                                    Mengetahui,<br>Kepala Sekolah
                                    <span class="signature-name v-kepsek"></span>
                                    NIP. <span class="v-nip-kepsek"></span>
                                </div>
                                <div class="signature-box">
                                    <span class="v-tempat-tgl"></span><br>Guru Mata Pelajaran
                                    <span class="signature-name v-guru"></span>
                                    NIP. <span class="v-nip-guru"></span>
                                </div>
                            </div>
                        </div>

                        <div id="wrapper-lkpd" class="paper-preview paper-a4-portrait" id="doc-lkpd">
                            <div class="border-2 border-dashed border-indigo-600 p-4 rounded-xl bg-slate-50">
                                <h1 class="text-center text-[14pt] font-bold text-indigo-800 mb-3 uppercase">LEMBAR KERJA PESERTA DIDIK (LKPD)</h1>
                                <div class="flex justify-between border-b border-black pb-2 mb-3 font-bold text-[10pt]">
                                    <span>Nama: .......................</span>
                                    <span>Kelas: <span class="v-kls"></span>/<span class="v-rombel"></span></span>
                                    <span>Nilai: .....</span>
                                </div>
                                <p class="font-bold text-indigo-700 text-[10pt]">Mapel: <span class="v-mapel"></span></p>
                                <p class="font-bold text-indigo-700 text-[10pt] mb-3">Topik: <span class="v-bab-aktif"></span></p>
                                
                                <div class="text-[9pt]">
                                    <p class="font-bold text-indigo-800">A. Tujuan:</p>
                                    <ul id="out-lkpd-tp" class="mb-3 bg-white p-2 border rounded list-disc pl-5"></ul>
                                    
                                    <p class="font-bold text-indigo-800">B. Petunjuk:</p>
                                    <ol class="list-decimal pl-5 mb-4">
                                        <li>Berdoa sebelum memulai.</li>
                                        <li>Kerjakan dengan teliti.</li>
                                    </ol>

                                    <p class="font-bold text-indigo-800 border-b pb-1 mb-3">C. Pengerjaan:</p>
                                    <div class="space-y-4">
                                        <div>
                                            <p class="font-bold mb-1">1. Jelaskan pemahamanmu!</p>
                                            <div class="border border-slate-400 bg-white p-3 rounded min-h-[80px]"></div>
                                        </div>
                                        <div>
                                            <p class="font-bold mb-1">2. Berikan contoh!</p>
                                            <div class="border border-slate-400 bg-white p-3 rounded min-h-[80px]"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- JURNAL VIEW -->
                <div id="view-jurnal" class="view-section hidden">
                    <div id="premium-gate-jurnal" class="bg-gradient-to-br from-amber-50 to-orange-100 rounded-2xl p-8 text-center mb-6">
                        <div class="text-5xl mb-4">üîí</div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">Fitur Premium</h3>
                        <p class="text-slate-600 mb-4">Jurnal Pelaksanaan untuk pengguna Pro</p>
                        <button onclick="showUpgradeModal()" class="px-6 py-3 rounded-xl btn-gradient text-white font-bold">Upgrade Pro</button>
                    </div>
                    <div id="content-jurnal" class="hidden">
                        <div id="jurnal-container"></div>
                    </div>
                </div>

                <!-- ABSENSI VIEW -->
                <div id="view-absensi" class="view-section hidden">
                    <div id="premium-gate-absensi" class="bg-gradient-to-br from-amber-50 to-orange-100 rounded-2xl p-8 text-center mb-6">
                        <div class="text-5xl mb-4">üîí</div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">Fitur Premium</h3>
                        <p class="text-slate-600 mb-4">Absensi Siswa untuk pengguna Pro</p>
                        <button onclick="showUpgradeModal()" class="px-6 py-3 rounded-xl btn-gradient text-white font-bold">Upgrade Pro</button>
                    </div>
                    <div id="content-absensi" class="hidden">
                        <div id="absensi-container"></div>
                    </div>
                </div>

                <!-- KKTP VIEW -->
                <div id="view-kktp" class="view-section hidden">
                    <div id="premium-gate-kktp" class="bg-gradient-to-br from-amber-50 to-orange-100 rounded-2xl p-8 text-center mb-6">
                        <div class="text-5xl mb-4">üîí</div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">Fitur Premium</h3>
                        <p class="text-slate-600 mb-4">KKTP & Nilai untuk pengguna Pro</p>
                        <button onclick="showUpgradeModal()" class="px-6 py-3 rounded-xl btn-gradient text-white font-bold">Upgrade Pro</button>
                    </div>
                    <div id="content-kktp" class="hidden">
                        <div class="paper-preview paper-a4-portrait" id="doc-kktp">
                            <h1 class="text-center text-[13pt] font-bold mb-4 uppercase">KRITERIA KETERCAPAIAN TUJUAN PEMBELAJARAN (KKTP)</h1>
                            <table class="mb-3" style="font-size: 10pt; width: 100%;">
                                <tr><td width="140">Mata Pelajaran</td><td>: <span class="v-mapel"></span></td></tr>
                                <tr><td>Kelas/Semester</td><td>: <span class="v-kls"></span> / <span class="v-smt"></span></td></tr>
                            </table>
                            <table class="doc-table">
                                <thead>
                                    <tr><th rowspan="2" width="5%">No</th><th rowspan="2" width="45%">Tujuan Pembelajaran</th><th colspan="3">Kriteria</th><th rowspan="2" width="10%">KKTP</th></tr>
                                    <tr><th class="text-[7pt]">Kompleksitas</th><th class="text-[7pt]">Daya Dukung</th><th class="text-[7pt]">Intaks</th></tr>
                                </thead>
                                <tbody id="out-kktp"></tbody>
                            </table>
                            
                            <div class="signature-area">
                                <div class="signature-box">
                                    Mengetahui,<br>Kepala Sekolah
                                    <span class="signature-name v-kepsek"></span>
                                    NIP. <span class="v-nip-kepsek"></span>
                                </div>
                                <div class="signature-box">
                                    <span class="v-tempat-tgl"></span><br>Guru Mata Pelajaran
                                    <span class="signature-name v-guru"></span>
                                    NIP. <span class="v-nip-guru"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="paper-preview paper-a4-landscape" id="doc-nilai">
                            <h1 class="text-center text-[13pt] font-bold mb-4 uppercase">DAFTAR NILAI</h1>
                            <table class="mb-3" style="font-size: 10pt; width: 40%;">
                                <tr><td width="130">Mata Pelajaran</td><td>: <span class="v-mapel"></span></td></tr>
                                <tr><td>Kelas/Semester</td><td>: <span class="v-kls"></span> / <span class="v-smt"></span></td></tr>
                            </table>
                            <table class="doc-table text-[8pt] text-center">
                                <thead>
                                    <tr><th width="3%" rowspan="2">No</th><th width="20%" rowspan="2" class="text-left">Nama Siswa</th><th colspan="5">Nilai Sumatif</th><th width="6%" rowspan="2">STS</th><th width="6%" rowspan="2">SAS</th><th width="6%" rowspan="2" class="bg-indigo-100">NR</th></tr>
                                    <tr><th>S1</th><th>S2</th><th>S3</th><th>S4</th><th>Rata2</th></tr>
                                </thead>
                                <tbody id="out-nilai"></tbody>
                            </table>
                            
                            <div class="signature-area">
                                <div class="signature-box">
                                    Mengetahui,<br>Kepala Sekolah
                                    <span class="signature-name v-kepsek"></span>
                                    NIP. <span class="v-nip-kepsek"></span>
                                </div>
                                <div class="signature-box">
                                    <span class="v-tempat-tgl"></span><br>Guru Mata Pelajaran
                                    <span class="signature-name v-guru"></span>
                                    NIP. <span class="v-nip-guru"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SOAL VIEW -->
                <div id="view-soal" class="view-section hidden">
                    <div id="premium-gate-soal" class="bg-gradient-to-br from-amber-50 to-orange-100 rounded-2xl p-8 text-center mb-6">
                        <div class="text-5xl mb-4">üîí</div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">Fitur Premium</h3>
                        <p class="text-slate-600 mb-4">Generator Soal AI untuk pengguna Pro</p>
                        <button onclick="showUpgradeModal()" class="px-6 py-3 rounded-xl btn-gradient text-white font-bold">Upgrade Pro</button>
                    </div>
                    <div id="content-soal" class="hidden">
                        <div class="bg-white rounded-2xl shadow-lg p-5 mb-5 no-print">
                            <h2 class="text-lg font-bold text-slate-800 mb-3">ü§ñ Generator Soal AI</h2>
                            <div class="grid md:grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="text-xs font-medium text-slate-700 mb-1 block">Pilih TP</label>
                                    <select id="soal-tp-select" class="w-full px-3 py-2 rounded-lg border border-slate-300 outline-none text-sm">
                                        <option value="">-- Pilih TP --</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-slate-700 mb-1 block">Jenis Soal</label>
                                    <select id="soal-jenis" class="w-full px-3 py-2 rounded-lg border border-slate-300 outline-none text-sm">
                                        <option value="pg">Pilihan Ganda</option>
                                        <option value="bs">Benar/Salah</option>
                                        <option value="jodoh">Menjodohkan</option>
                                        <option value="isian">Isian Singkat</option>
                                        <option value="essay">Essay</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-slate-700 mb-1 block">Jumlah</label>
                                    <input type="number" id="soal-jumlah" value="5" min="1" max="20" class="w-full px-3 py-2 rounded-lg border border-slate-300 outline-none text-sm">
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-slate-700 mb-1 block">Kelas</label>
                                    <select id="soal-kelas" class="w-full px-3 py-2 rounded-lg border border-slate-300 outline-none text-sm">
                                        <option value="1">Kelas 1</option>
                                        <option value="2">Kelas 2</option>
                                        <option value="3">Kelas 3</option>
                                        <option value="4" selected>Kelas 4</option>
                                        <option value="5">Kelas 5</option>
                                        <option value="6">Kelas 6</option>
                                    </select>
                                </div>
                            </div>
                            <button onclick="generateAIPrompt()" class="w-full py-3 rounded-xl btn-gradient text-white font-bold">‚ú® Generate Prompt AI</button>
                        </div>
                        
                        <div id="ai-prompt-result" class="hidden bg-purple-50 rounded-xl p-4 mb-5 border-2 border-purple-200 no-print">
                            <h3 class="font-bold text-purple-800 mb-2">üìã Prompt untuk AI:</h3>
                            <div id="ai-prompt-text" class="bg-white p-3 rounded-lg border text-xs text-slate-700 whitespace-pre-wrap mb-3 max-h-48 overflow-y-auto"></div>
                            <button onclick="copyAIPrompt()" class="px-4 py-2 rounded-lg bg-purple-600 text-white font-semibold text-sm">üìã Salin</button>
                        </div>

                        <div class="paper-preview paper-a4-portrait" id="doc-soal">
                            <div style="border: 2px solid #000; padding: 12px; margin-bottom: 15px;">
                                <table style="width: 100%; font-size: 10pt;">
                                    <tr><td width="50%">Nama: .................................</td><td>Kelas: ............</td></tr>
                                    <tr><td>No. Absen: ............</td><td>Tanggal: ............</td></tr>
                                </table>
                            </div>
                            <h1 class="text-center text-[13pt] font-bold mb-1 uppercase">LEMBAR SOAL</h1>
                            <h2 class="text-center text-[11pt] mb-3">Mata Pelajaran: <span class="v-mapel"></span></h2>
                            <div id="soal-content" class="text-[10pt]" contenteditable="true">
                                <p class="text-center text-slate-500 italic py-6">Paste hasil soal dari AI di sini...</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- ==================== MODALS ==================== -->
    
    <div id="modal-siswa" class="modal-overlay">
        <div class="modal-content">
            <button onclick="closeModal('modal-siswa')" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-100 hover:bg-red-100 flex items-center justify-center text-lg">‚úï</button>
            <h2 class="text-lg font-bold text-emerald-600 mb-2">üë• Data Siswa</h2>
            <p class="text-sm text-slate-600 mb-3">1 baris = 1 nama</p>
            <textarea id="in-data-siswa" rows="12" class="w-full border border-slate-300 rounded-xl p-3 text-sm outline-none" placeholder="1. Ahmad Fulan&#10;2. Siti Fulanah"></textarea>
            <button onclick="Engine.saveStudents()" class="w-full mt-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl">üíæ Simpan</button>
        </div>
    </div>

    <div id="modal-panduan" class="modal-overlay">
        <div class="modal-content">
            <button onclick="closeModal('modal-panduan')" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-100 hover:bg-red-100 flex items-center justify-center text-lg">‚úï</button>
            <h2 class="text-lg font-bold text-indigo-600 mb-4">üìñ Panduan</h2>
            <div class="space-y-3 text-sm">
                <div class="bg-slate-50 p-3 rounded-xl"><b>1.</b> Masukkan NPSN untuk kolaborasi jadwal</div>
                <div class="bg-slate-50 p-3 rounded-xl"><b>2.</b> Load database kurikulum dari Cloud</div>
                <div class="bg-slate-50 p-3 rounded-xl"><b>3.</b> Pilih mapel, kelas, semester</div>
                <div class="bg-slate-50 p-3 rounded-xl"><b>4.</b> Klik RENDER untuk generate dokumen</div>
                <div class="bg-slate-50 p-3 rounded-xl"><b>5.</b> Klik Cetak untuk save PDF</div>
            </div>
        </div>
    </div>

    <div id="modal-upgrade" class="modal-overlay">
        <div class="modal-content text-center">
            <button onclick="closeModal('modal-upgrade')" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-100 hover:bg-red-100 flex items-center justify-center text-lg">‚úï</button>
            <div class="text-5xl mb-3">üëë</div>
            <h2 class="text-xl font-bold text-slate-800 mb-2">Upgrade Pro</h2>
            <div class="bg-indigo-50 rounded-xl p-4 mb-4 text-left">
                <div class="text-center mb-3">
                    <span class="text-slate-400 line-through">Rp 99.000</span>
                    <div class="text-3xl font-extrabold text-indigo-600">Rp 49.000<span class="text-sm font-normal">/bln</span></div>
                </div>
                <ul class="space-y-1 text-sm">
                    <li class="flex items-center gap-2"><span class="text-green-500">‚úì</span> Semua Fitur Premium</li>
                    <li class="flex items-center gap-2"><span class="text-green-500">‚úì</span> Generator Soal AI</li>
                    <li class="flex items-center gap-2"><span class="text-green-500">‚úì</span> Support WhatsApp</li>
                </ul>
            </div>
            <button onclick="redirectToWhatsApp()" class="w-full py-3 rounded-xl bg-green-500 hover:bg-green-600 text-white font-bold flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                Hubungi via WhatsApp
            </button>
            <p class="text-xs text-slate-500 mt-3">Aktivasi 1x24 jam</p>
        </div>
    </div>

    <!-- ADMIN PANEL MODAL -->
    <div id="modal-admin" class="modal-overlay">
        <div class="modal-content">
            <button onclick="closeModal('modal-admin')" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-100 hover:bg-red-100 flex items-center justify-center text-lg">‚úï</button>
            <h2 class="text-lg font-bold text-amber-600 mb-4">‚öôÔ∏è Admin Panel</h2>
            
            <div class="space-y-4">
                <div class="bg-slate-50 p-4 rounded-xl">
                    <h3 class="font-bold text-slate-800 mb-2">üìä Statistik</h3>
                    <div id="admin-stats" class="text-sm text-slate-600">Loading...</div>
                </div>
                
                <div class="bg-slate-50 p-4 rounded-xl">
                    <h3 class="font-bold text-slate-800 mb-2">üëë Upgrade User ke Pro</h3>
                    <input type="email" id="admin-upgrade-email" placeholder="Email user" class="w-full px-3 py-2 rounded-lg border border-slate-300 outline-none text-sm mb-2">
                    <button onclick="adminUpgradeUser()" class="w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 rounded-lg text-sm">Upgrade ke Pro</button>
                </div>
                
                <div class="bg-slate-50 p-4 rounded-xl">
                    <h3 class="font-bold text-slate-800 mb-2">üìã Daftar User Pro</h3>
                    <div id="admin-pro-users" class="text-sm text-slate-600 max-h-40 overflow-y-auto">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== SCRIPTS ==================== -->
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDpiK4F4ilnDDNEwO0djGY-ClwgwBl1eFk",
            authDomain: "asap-1d653.firebaseapp.com",
            projectId: "asap-1d653",
            storageBucket: "asap-1d653.firebasestorage.app",
            messagingSenderId: "143263188364",
            appId: "1:143263188364:web:47b4c003972b3503e882a9",
            measurementId: "G-3VRD49K5PE"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Constants
        const SUPER_ADMIN_EMAIL = "afifaro@gmail.com";
        const WA_ADMIN_NUMBER = "6285123456789"; // GANTI DENGAN NOMOR WA ADMIN
        const CP_LINKS = {
            "SD": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1925091593&single=true&output=csv",
            "SMP": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1962203786&single=true&output=csv",
            "SMA": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=260922290&single=true&output=csv"
        };
        const BULAN_IND = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
        const FREE_FEATURES = ['kalender', 'jadwal', 'atp'];
        const PREMIUM_FEATURES = ['promes', 'modul', 'jurnal', 'absensi', 'kktp', 'soal'];

        // Hari Libur Nasional Baku
        const LIBUR_NASIONAL = {
            "01-01": "Tahun Baru Masehi",
            "05-01": "Hari Buruh",
            "06-01": "Hari Lahir Pancasila",
            "08-17": "HUT Kemerdekaan RI",
            "12-25": "Hari Natal"
        };

        // State
        let currentUser = null;
        let userProfile = null;
        let isPremium = false;
        let currentTab = 'atp';

        // ==================== AUTH ====================
        function showAuthModal(type) {
            document.getElementById('modal-auth').style.display = 'flex';
            document.querySelectorAll('.auth-form').forEach(f => f.classList.add('hidden'));
            document.getElementById(`auth-${type}`).classList.remove('hidden');
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function showModal(id) {
            document.getElementById(id).style.display = 'flex';
            if (id === 'modal-admin') loadAdminData();
        }

        async function handleRegister() {
            const name = document.getElementById('reg-name').value.trim();
            const npsn = document.getElementById('reg-npsn').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;

            if (!name || !email || !password) return alert('Lengkapi semua field!');

            try {
                const cred = await auth.createUserWithEmailAndPassword(email, password);
                await cred.user.updateProfile({ displayName: name });
                await db.collection('users').doc(cred.user.uid).set({
                    name, email, npsn, plan: 'free',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                closeModal('modal-auth');
                alert('Registrasi berhasil!');
            } catch (e) { alert('Error: ' + e.message); }
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
                closeModal('modal-auth');
            } catch (e) { alert('Error: ' + e.message); }
        }

        async function handleGoogleLogin() {
            try {
                const result = await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
                const doc = await db.collection('users').doc(result.user.uid).get();
                if (!doc.exists) {
                    await db.collection('users').doc(result.user.uid).set({
                        name: result.user.displayName, email: result.user.email, npsn: '', plan: 'free',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                closeModal('modal-auth');
            } catch (e) { alert('Error: ' + e.message); }
        }

        function handleLogout() {
            if (confirm('Keluar?')) auth.signOut();
        }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const doc = await db.collection('users').doc(user.uid).get();
                userProfile = doc.exists ? doc.data() : { plan: 'free', npsn: '' };
                isPremium = userProfile.plan === 'pro' || user.email === SUPER_ADMIN_EMAIL;
                
                document.getElementById('landing-page').classList.add('hidden');
                document.getElementById('app-wrapper').classList.remove('hidden');
                document.getElementById('app-wrapper').classList.add('flex');
                document.getElementById('user-email-display').textContent = user.email;
                
                const badge = document.getElementById('user-plan-badge');
                badge.textContent = isPremium ? 'PRO' : 'FREE';
                badge.className = isPremium 
                    ? 'px-2 py-0.5 rounded text-xs font-bold bg-gradient-to-r from-amber-400 to-orange-500 text-white'
                    : 'px-2 py-0.5 rounded text-xs font-bold bg-slate-700 text-slate-400';
                
                // Show admin button for super admin
                if (user.email === SUPER_ADMIN_EMAIL) {
                    document.getElementById('btn-admin-panel').classList.remove('hidden');
                }
                
                if (userProfile.npsn) document.getElementById('in-npsn').value = userProfile.npsn;
                
                Engine.loadUserData();
                Engine.fetchGlobalCSV();
                Engine.generateDefaultCalendar();
                updatePremiumGates();
            } else {
                currentUser = null;
                isPremium = false;
                document.getElementById('landing-page').classList.remove('hidden');
                document.getElementById('app-wrapper').classList.add('hidden');
            }
        });

        function updatePremiumGates() {
            PREMIUM_FEATURES.forEach(f => {
                const gate = document.getElementById(`premium-gate-${f}`);
                const content = document.getElementById(`content-${f}`);
                if (gate && content) {
                    gate.style.display = isPremium ? 'none' : 'block';
                    content.style.display = isPremium ? 'block' : 'none';
                }
            });
        }

        // ==================== UI ====================
        function toggleMobileNav() {
            const nav = document.getElementById('mobile-nav');
            nav.classList.toggle('hidden');
            nav.classList.toggle('flex');
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function showUpgradeModal() {
            showModal('modal-upgrade');
        }

        function showDemo() {
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('app-wrapper').classList.remove('hidden');
            document.getElementById('app-wrapper').classList.add('flex');
            isPremium = false;
            updatePremiumGates();
            Engine.fetchGlobalCSV();
            Engine.generateDefaultCalendar();
        }

        const UI = {
            switchTab: function(tabId) {
                currentTab = tabId;
                
                // Hide all views
                document.querySelectorAll('.view-section').forEach(el => {
                    el.classList.add('hidden');
                    el.classList.remove('print-active');
                });
                
                // Remove active from all tabs
                document.querySelectorAll('.nav-tab').forEach(el => {
                    el.classList.remove('active', 'text-indigo-600');
                    el.classList.add('text-slate-500');
                });
                
                // Show selected view
                const view = document.getElementById(`view-${tabId}`);
                if (view) {
                    view.classList.remove('hidden');
                    view.classList.add('print-active');
                }
                
                // Activate tab button
                const tabBtn = document.querySelector(`[data-tab="${tabId}"]`);
                if (tabBtn) {
                    tabBtn.classList.remove('text-slate-500');
                    tabBtn.classList.add('active', 'text-indigo-600');
                }
                
                // Close sidebar on mobile
                if (window.innerWidth < 768) {
                    document.getElementById('sidebar').classList.remove('open');
                }
            }
        };

        // ==================== PRINT ====================
        function printDocument() {
            const mapel = document.getElementById('in-mapel')?.value || 'Dokumen';
            const kelas = document.getElementById('in-kelas')?.value || '';
            const tabNames = {
                'kalender': 'Kalender Pendidikan',
                'jadwal': 'Jadwal Pelajaran',
                'atp': `ATP ${mapel} Kelas ${kelas}`,
                'promes': `Promes ${mapel} Kelas ${kelas}`,
                'modul': `Modul Ajar ${mapel} Kelas ${kelas}`,
                'jurnal': `Jurnal ${mapel} Kelas ${kelas}`,
                'absensi': `Absensi ${mapel} Kelas ${kelas}`,
                'kktp': `KKTP ${mapel} Kelas ${kelas}`,
                'soal': `Soal ${mapel} Kelas ${kelas}`
            };
            
            document.title = tabNames[currentTab] || 'Dokumen';
            
            // Mark current view for print
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('print-active'));
            const currentView = document.getElementById(`view-${currentTab}`);
            if (currentView) currentView.classList.add('print-active');
            
            window.print();
        }

        // ==================== AI GENERATOR ====================
        function generateAIPrompt() {
            const tpSelect = document.getElementById('soal-tp-select');
            const jenis = document.getElementById('soal-jenis').value;
            const jumlah = document.getElementById('soal-jumlah').value;
            const kelas = document.getElementById('soal-kelas').value;
            const mapel = document.getElementById('in-mapel')?.value || '';
            const tp = tpSelect.options[tpSelect.selectedIndex]?.text || '';
            
            if (!tp || tp === '-- Pilih TP --') return alert('Pilih TP!');

            const jenisMap = {
                'pg': 'pilihan ganda (A, B, C, D) dengan kunci jawaban',
                'bs': 'benar/salah dengan kunci jawaban',
                'jodoh': 'menjodohkan',
                'isian': 'isian singkat dengan kunci jawaban',
                'essay': 'essay dengan pedoman penskoran'
            };

            const prompt = `Dengan Tujuan Pembelajaran: "${tp}"

Buatkan ${jumlah} soal ${jenisMap[jenis]} untuk siswa kelas ${kelas} ${mapel}.

Format:
1. Sesuai TP
2. Bahasa sederhana untuk kelas ${kelas}
3. Kunci jawaban di akhir
4. Kolom identitas: Nama, Kelas, No.Absen, Tanggal

Format rapi siap cetak.`;

            document.getElementById('ai-prompt-text').textContent = prompt;
            document.getElementById('ai-prompt-result').classList.remove('hidden');
        }

        function copyAIPrompt() {
            navigator.clipboard.writeText(document.getElementById('ai-prompt-text').textContent)
                .then(() => alert('Disalin!'));
        }

        // ==================== WHATSAPP ====================
        function redirectToWhatsApp() {
            const email = currentUser?.email || '-';
            const name = currentUser?.displayName || userProfile?.name || 'Guru';
            const sekolah = document.getElementById('in-sekolah')?.value || '-';
            const npsn = document.getElementById('in-npsn')?.value || '-';
            
            const msg = `Halo Admin, saya ingin upgrade ke PRO.

üìß Email: ${email}
üë§ Nama: ${name}
üè´ Sekolah: ${sekolah}
üî¢ NPSN: ${npsn}

Mohon info pembayaran. Terima kasih!`;

            window.open(`https://wa.me/${WA_ADMIN_NUMBER}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // ==================== ADMIN PANEL ====================
        async function loadAdminData() {
            if (currentUser?.email !== SUPER_ADMIN_EMAIL) return;
            
            try {
                // Stats
                const users = await db.collection('users').get();
                const proUsers = users.docs.filter(d => d.data().plan === 'pro');
                
                document.getElementById('admin-stats').innerHTML = `
                    Total User: <b>${users.size}</b><br>
                    User Pro: <b>${proUsers.length}</b><br>
                    User Free: <b>${users.size - proUsers.length}</b>
                `;
                
                // Pro Users List
                let proList = '';
                proUsers.forEach(d => {
                    proList += `<div class="py-1 border-b">${d.data().email}</div>`;
                });
                document.getElementById('admin-pro-users').innerHTML = proList || 'Belum ada user Pro';
                
            } catch (e) { console.error(e); }
        }

        async function adminUpgradeUser() {
            const email = document.getElementById('admin-upgrade-email').value.trim();
            if (!email) return alert('Masukkan email!');
            
            try {
                const snap = await db.collection('users').where('email', '==', email).get();
                if (snap.empty) return alert('User tidak ditemukan!');
                
                await snap.docs[0].ref.update({ plan: 'pro' });
                alert('User berhasil di-upgrade ke Pro!');
                document.getElementById('admin-upgrade-email').value = '';
                loadAdminData();
            } catch (e) { alert('Error: ' + e.message); }
        }

        // ==================== ENGINE ====================
        window.Engine = {
            data: {}, students: [], faseMap: {},

            generateDefaultCalendar: function() {
                const tahun = parseInt(document.getElementById('in-tahun')?.value) || 2025;
                const semester = document.getElementById('in-semester')?.value || "Ganjil";
                const kelas = document.getElementById('in-kelas')?.value || "1";
                const kelasNum = parseInt(kelas) || 1;
                const jenjang = document.getElementById('in-jenjang')?.value || "SD";
                
                // Determine if this is first grade of level
                const isFirstGrade = (jenjang === "SD" && kelasNum === 1) || 
                                    (jenjang === "SMP" && kelasNum === 7) || 
                                    (jenjang === "SMA" && kelasNum === 10);
                
                const mplsDays = isFirstGrade ? 3 : 1;
                
                let template = "";
                
                if (semester === "Ganjil" || semester === "") {
                    // MPLS start date (usually mid-July)
                    const mplsStart = 14;
                    
                    template = `# ===== SEMESTER GANJIL ${tahun}/${tahun+1} =====

# LIBUR AWAL TAHUN AJARAN (sebelum MPLS)
`;
                    // Add holidays before MPLS
                    for (let d = 1; d < mplsStart; d++) {
                        if (new Date(tahun, 6, d).getDay() !== 0) { // Skip Sundays
                            template += `${tahun}-07-${String(d).padStart(2,'0')} = Libur Awal Tahun Ajaran\n`;
                        }
                    }
                    
                    template += `
# MPLS (${mplsDays} hari untuk ${isFirstGrade ? 'kelas awal' : 'kelas lain'})
`;
                    for (let d = 0; d < mplsDays; d++) {
                        template += `${tahun}-07-${String(mplsStart + d).padStart(2,'0')} = MPLS Hari ${d+1}\n`;
                    }

                    template += `
# LIBUR NASIONAL
${tahun}-08-17 = HUT Kemerdekaan RI

# SUMATIF TENGAH SEMESTER (STS)
${tahun}-09-22 = STS Hari 1
${tahun}-09-23 = STS Hari 2
${tahun}-09-24 = STS Hari 3
${tahun}-09-25 = STS Hari 4
${tahun}-09-26 = STS Hari 5

# SUMATIF AKHIR SEMESTER (SAS)
${tahun}-12-01 = SAS Hari 1
${tahun}-12-02 = SAS Hari 2
${tahun}-12-03 = SAS Hari 3
${tahun}-12-04 = SAS Hari 4
${tahun}-12-05 = SAS Hari 5

# REMEDIAL & PENGOLAHAN NILAI
${tahun}-12-08 = Remedial
${tahun}-12-09 = Remedial
${tahun}-12-10 = Pengolahan Nilai
${tahun}-12-11 = Pengolahan Nilai
${tahun}-12-12 = Rapat Pleno

# PEMBAGIAN RAPOR
${tahun}-12-20 = Pembagian Rapor

# LIBUR AKHIR SEMESTER GANJIL (setelah rapor)
`;
                    // Add holidays after report card until end of December
                    for (let d = 21; d <= 31; d++) {
                        if (new Date(tahun, 11, d).getDay() !== 0) {
                            let name = (d === 25) ? "Hari Natal" : "Libur Akhir Semester Ganjil";
                            if (d === 31) name = "Tahun Baru";
                            template += `${tahun}-12-${String(d).padStart(2,'0')} = ${name}\n`;
                        }
                    }
                    
                    // First days of January
                    template += `${tahun+1}-01-01 = Tahun Baru Masehi\n`;
                    for (let d = 2; d <= 5; d++) {
                        if (new Date(tahun+1, 0, d).getDay() !== 0) {
                            template += `${tahun+1}-01-0${d} = Libur Akhir Semester Ganjil\n`;
                        }
                    }

                } else {
                    // GENAP
                    const semesterStart = 6; // January 6th
                    
                    template = `# ===== SEMESTER GENAP ${tahun}/${tahun+1} =====

# LIBUR AWAL SEMESTER GENAP
`;
                    for (let d = 1; d < semesterStart; d++) {
                        if (new Date(tahun+1, 0, d).getDay() !== 0) {
                            template += `${tahun+1}-01-0${d} = Libur Awal Semester Genap\n`;
                        }
                    }

                    template += `
# AWAL SEMESTER GENAP
${tahun+1}-01-0${semesterStart} = Masuk Semester Genap

# LIBUR NASIONAL
${tahun+1}-05-01 = Hari Buruh
${tahun+1}-06-01 = Hari Lahir Pancasila

# STS
${tahun+1}-03-10 = STS Hari 1
${tahun+1}-03-11 = STS Hari 2
${tahun+1}-03-12 = STS Hari 3
${tahun+1}-03-13 = STS Hari 4
${tahun+1}-03-14 = STS Hari 5

# SAS
${tahun+1}-06-02 = SAS Hari 1
${tahun+1}-06-03 = SAS Hari 2
${tahun+1}-06-04 = SAS Hari 3
${tahun+1}-06-05 = SAS Hari 4
${tahun+1}-06-06 = SAS Hari 5

# REMEDIAL
${tahun+1}-06-09 = Remedial
${tahun+1}-06-10 = Remedial
${tahun+1}-06-11 = Pengolahan Nilai

# PEMBAGIAN RAPOR
${tahun+1}-06-21 = Pembagian Rapor

# LIBUR AKHIR TAHUN AJARAN (setelah rapor)
`;
                    for (let d = 22; d <= 30; d++) {
                        if (new Date(tahun+1, 5, d).getDay() !== 0) {
                            template += `${tahun+1}-06-${d} = Libur Akhir Tahun Ajaran\n`;
                        }
                    }
                }
                
                document.getElementById('in-libur').value = template.trim();
            },

            saveAllData: async function() {
                if (!currentUser) return alert('Login dulu!');
                
                const data = {
                    npsn: document.getElementById('in-npsn')?.value || '',
                    tipeGuru: document.getElementById('in-tipe-guru')?.value || '',
                    jenjang: document.getElementById('in-jenjang')?.value || '',
                    mapel: document.getElementById('in-mapel')?.value || '',
                    kelas: document.getElementById('in-kelas')?.value || '',
                    semester: document.getElementById('in-semester')?.value || '',
                    sekolah: document.getElementById('in-sekolah')?.value || '',
                    kepsek: document.getElementById('in-kepsek')?.value || '',
                    nipKepsek: document.getElementById('in-nip-kepsek')?.value || '',
                    guru: document.getElementById('in-guru')?.value || '',
                    nipGuru: document.getElementById('in-nip-guru')?.value || '',
                    rombel: document.getElementById('in-rombel')?.value || '',
                    tahun: document.getElementById('in-tahun')?.value || '',
                    tempat: document.getElementById('in-tempat-tgl')?.value || '',
                    hari: document.getElementById('in-hari')?.value || '',
                    jp: document.getElementById('in-jp')?.value || '',
                    libur: document.getElementById('in-libur')?.value || '',
                    students: this.students,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    await db.collection('users').doc(currentUser.uid).set(data, { merge: true });
                    alert('‚úÖ Tersimpan!');
                } catch (e) { alert('Error: ' + e.message); }
            },

            loadUserData: async function() {
                if (!currentUser) return;
                try {
                    const doc = await db.collection('users').doc(currentUser.uid).get();
                    if (doc.exists) {
                        const d = doc.data();
                        if (d.npsn) document.getElementById('in-npsn').value = d.npsn;
                        if (d.sekolah) document.getElementById('in-sekolah').value = d.sekolah;
                        if (d.kepsek) document.getElementById('in-kepsek').value = d.kepsek;
                        if (d.nipKepsek) document.getElementById('in-nip-kepsek').value = d.nipKepsek;
                        if (d.guru) document.getElementById('in-guru').value = d.guru;
                        if (d.nipGuru) document.getElementById('in-nip-guru').value = d.nipGuru;
                        if (d.rombel) document.getElementById('in-rombel').value = d.rombel;
                        if (d.tahun) document.getElementById('in-tahun').value = d.tahun;
                        if (d.tempat) document.getElementById('in-tempat-tgl').value = d.tempat;
                        if (d.hari) document.getElementById('in-hari').value = d.hari;
                        if (d.jp) document.getElementById('in-jp').value = d.jp;
                        if (d.libur) document.getElementById('in-libur').value = d.libur;
                        if (d.students) {
                            this.students = d.students;
                            document.getElementById('in-data-siswa').value = d.students.join('\n');
                        }
                    }
                } catch (e) { console.error(e); }
            },

            syncNPSN: async function() {
                const npsn = document.getElementById('in-npsn')?.value?.trim();
                if (!npsn || npsn.length !== 8) return alert('NPSN 8 digit!');
                if (currentUser) await db.collection('users').doc(currentUser.uid).update({ npsn });
                document.getElementById('jadwal-npsn-display').textContent = npsn;
                alert('‚úÖ NPSN tersimpan!');
            },

            loadJadwalKolaborasi: function() {
                // Placeholder for collaborative schedule loading
                this.renderJadwal();
            },

            saveStudents: function() {
                let list = document.getElementById('in-data-siswa').value.split('\n')
                    .map(s => s.replace(/^[0-9]+[\.\)\-]\s*/, '').trim())
                    .filter(s => s.length > 0);
                if (list.length > 0) {
                    this.students = list;
                    closeModal('modal-siswa');
                    this.syncAll();
                    alert("‚úÖ " + list.length + " siswa tersimpan!");
                }
            },

            toggleAbsen: function(el) {
                const m = {'H':'S','S':'I','I':'A','A':'H'};
                const c = {'H':'text-indigo-600','S':'text-amber-500','I':'text-purple-500','A':'text-red-600'};
                const cur = el.innerText.trim();
                const next = m[cur] || 'H';
                el.innerText = next;
                el.className = `cursor-pointer font-bold ${c[next]}`;
            },

            uploadCSV: function(input) {
                const file = input.files[0];
                if (!file) return;
                const r = new FileReader();
                r.onload = e => { this.parseCSV(e.target.result); input.value = ''; };
                r.readAsText(file);
            },

            fetchGlobalCSV: async function() {
                const jenjang = document.getElementById('in-jenjang')?.value || "SD";
                const url = CP_LINKS[jenjang];
                const status = document.getElementById('csvStatus');
                
                if (status) {
                    status.style.display = 'block';
                    status.className = 'mt-2 p-2 rounded-lg text-xs bg-indigo-900 text-indigo-200';
                    status.innerHTML = `‚è≥ Loading ${jenjang}...`;
                }

                try {
                    let res = await fetch(url);
                    if (!res.ok) throw new Error();
                    this.parseCSV(await res.text());
                } catch {
                    try {
                        const r = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(url));
                        this.parseCSV(await r.text());
                    } catch {
                        if (status) {
                            status.className = 'mt-2 p-2 rounded-lg text-xs bg-red-900 text-red-200';
                            status.innerHTML = "‚ùå Gagal. Upload manual.";
                        }
                    }
                }
            },

            parseCSV: function(csv) {
                const lines = csv.split('\n');
                this.data = {};
                this.faseMap = {};
                let count = 0;

                for (let i = 1; i < lines.length; i++) {
                    const row = lines[i].trim();
                    if (!row) continue;
                    
                    let cols = [];
                    let match;
                    const regex = /("([^"]*)"|[^",]+)(?=,|$)/g;
                    while (match = regex.exec(row)) cols.push(match[2] || match[1]);
                    if (cols.length < 5) continue;

                    const [m, f, k, s, el, cp, tp, p3] = cols.map(c => c?.trim() || '');
                    
                    if (f && k) this.faseMap[k] = f;
                    
                    if (!this.data[m]) this.data[m] = {};
                    if (!this.data[m][k]) this.data[m][k] = {};
                    if (!this.data[m][k][s]) this.data[m][k][s] = {};
                    if (!this.data[m][k][s][el]) this.data[m][k][s][el] = { cp: cp || '', tps: [] };
                    this.data[m][k][s][el].tps.push({ tp: tp || cp, p3: p3 || '' });
                    count++;
                }

                const status = document.getElementById('csvStatus');
                if (status) {
                    status.className = 'mt-2 p-2 rounded-lg text-xs bg-emerald-900 text-emerald-200';
                    status.innerHTML = `‚úÖ ${count} TP dimuat.`;
                }
                this.initDropdowns();
            },

            initDropdowns: function() {
                const sel = document.getElementById('in-mapel');
                sel.innerHTML = "<option value=''>-- Pilih Mapel --</option>";
                Object.keys(this.data).forEach(m => sel.appendChild(new Option(m, m)));
                this.updateKelasList();
            },

            updateKelasList: function() {
                const m = document.getElementById('in-mapel')?.value;
                const sel = document.getElementById('in-kelas');
                sel.innerHTML = "<option value=''>Kelas</option>";
                
                if (m && this.data[m]) {
                    Object.keys(this.data[m]).sort((a, b) => {
                        const nA = parseInt(a.replace(/\D/g, ''));
                        const nB = parseInt(b.replace(/\D/g, ''));
                        return nA - nB;
                    }).forEach(k => {
                        const f = this.faseMap[k] || "-";
                        sel.appendChild(new Option(`${k} (${f})`, k));
                    });
                }
                this.updateSemesterList();
            },

            updateSemesterList: function() {
                const m = document.getElementById('in-mapel')?.value;
                const k = document.getElementById('in-kelas')?.value;
                const sel = document.getElementById('in-semester');
                sel.innerHTML = "<option value=''>Smt</option>";
                
                if (m && k && this.data[m]?.[k]) {
                    Object.keys(this.data[m][k]).forEach(s => sel.appendChild(new Option(s, s)));
                }
                this.updateBabList();
            },

            updateBabList: function() {
                const m = document.getElementById('in-mapel')?.value;
                const k = document.getElementById('in-kelas')?.value;
                const s = document.getElementById('in-semester')?.value;
                const sel = document.getElementById('in-elemen');
                sel.innerHTML = "<option value=''>-- Bab --</option>";
                
                if (m && k && s && this.data[m]?.[k]?.[s]) {
                    Object.keys(this.data[m][k][s]).forEach(b => sel.appendChild(new Option(b, b)));
                }
                this.syncAll();
            },

            calcKktp: function(el) {
                const row = el.closest('tr');
                const vals = row.querySelectorAll('.kktp-val');
                const result = row.querySelector('.kktp-hasil');
                if (vals.length === 3 && result) {
                    const avg = Math.round((parseFloat(vals[0].innerText) + parseFloat(vals[1].innerText) + parseFloat(vals[2].innerText)) / 3);
                    result.innerText = avg || 0;
                }
            },

            syncAll: function() {
                const m = document.getElementById('in-mapel')?.value || "";
                const k = document.getElementById('in-kelas')?.value || "";
                const s = document.getElementById('in-semester')?.value || "";
                const bab = document.getElementById('in-elemen')?.value || "";
                
                if (!m || !k || !s) return;

                const tahun = parseInt(document.getElementById('in-tahun')?.value) || 2025;
                const jp = parseInt(document.getElementById('in-jp')?.value) || 4;
                const hTarget = parseInt(document.getElementById('in-hari')?.value) || 1;
                const tAjar = `${tahun} / ${tahun + 1}`;
                const fase = this.faseMap[k] || "-";

                // Update placeholders
                document.querySelectorAll('.v-mapel').forEach(e => e.innerText = m);
                document.querySelectorAll('.v-kls').forEach(e => e.innerText = k);
                document.querySelectorAll('.v-fase').forEach(e => e.innerText = fase);
                document.querySelectorAll('.v-smt').forEach(e => e.innerText = s);
                document.querySelectorAll('.v-thn').forEach(e => e.innerText = tAjar);
                document.querySelectorAll('.v-bab-aktif').forEach(e => e.innerText = bab);
                document.querySelectorAll('.v-sekolah').forEach(e => e.innerText = document.getElementById('in-sekolah')?.value || "");
                document.querySelectorAll('.v-kepsek').forEach(e => e.innerText = document.getElementById('in-kepsek')?.value || "");
                document.querySelectorAll('.v-nip-kepsek').forEach(e => e.innerText = document.getElementById('in-nip-kepsek')?.value || "");
                document.querySelectorAll('.v-guru').forEach(e => e.innerText = document.getElementById('in-guru')?.value || "");
                document.querySelectorAll('.v-nip-guru').forEach(e => e.innerText = document.getElementById('in-nip-guru')?.value || "");
                document.querySelectorAll('.v-rombel').forEach(e => e.innerText = document.getElementById('in-rombel')?.value || "");
                
                const tmpt = document.getElementById('in-tempat-tgl')?.value || "";
                document.querySelectorAll('.v-tempat-tgl').forEach(e => e.innerText = tmpt + ", ......................");

                const spData = this.data[m]?.[k]?.[s]?.[bab];
                document.querySelectorAll('.v-jp-bab').forEach(e => e.innerText = spData ? spData.tps.length * jp : 0);

                // Update TP selector
                this.updateTPSelector(m, k, s);

                // Parse holidays
                const bAwal = s === "Ganjil" ? 6 : 0;
                const rawLibur = (document.getElementById("in-libur")?.value || "").split('\n');
                const calEvents = {};
                const dLibur = [];

                rawLibur.forEach(line => {
                    if (line.trim().startsWith('#') || !line.trim()) return;
                    const parts = line.split('=');
                    if (parts.length >= 2) {
                        const dateStr = parts[0].trim();
                        const eventName = parts[1].trim();
                        if (dateStr && eventName) {
                            calEvents[dateStr] = eventName;
                            dLibur.push(dateStr);
                        }
                    }
                });

                // Calculate column events for promes
                const colEv = new Array(30).fill(null);
                Object.keys(calEvents).forEach(dStr => {
                    const p = dStr.split('-');
                    if (p.length === 3) {
                        let mo = parseInt(p[1]) - 1;
                        const d = parseInt(p[2]);
                        let mIdx = mo - bAwal;
                        if (s === "Ganjil" && mIdx < 0) mIdx += 12;
                        if (s === "Genap" && mIdx < 0) mIdx += 12;
                        
                        if (mIdx >= 0 && mIdx < 6) {
                            const wIdx = Math.min(Math.ceil(d / 7) - 1, 4);
                            const cIdx = mIdx * 5 + wIdx;
                            if (colEv[cIdx]) {
                                if (!colEv[cIdx].includes(calEvents[dStr])) {
                                    colEv[cIdx] = colEv[cIdx].split('/')[0].trim();
                                }
                            } else {
                                colEv[cIdx] = calEvents[dStr];
                            }
                        }
                    }
                });

                // Get active teaching dates
                const activeDates = [];
                for (let i = 0; i < 6; i++) {
                    let curBln = bAwal + i;
                    let cYr = tahun;
                    if (curBln > 11) { cYr++; curBln -= 12; }
                    
                    const daysInMonth = new Date(cYr, curBln + 1, 0).getDate();
                    for (let tgl = 1; tgl <= daysInMonth; tgl++) {
                        const dt = new Date(cYr, curBln, tgl);
                        const dtStr = `${cYr}-${String(curBln + 1).padStart(2, '0')}-${String(tgl).padStart(2, '0')}`;
                        
                        if (dt.getDay() === hTarget && !dLibur.includes(dtStr)) {
                            const wIdx = Math.min(Math.ceil(tgl / 7) - 1, 4);
                            const cIdx = i * 5 + wIdx;
                            if (!colEv[cIdx]) {
                                activeDates.push(dt);
                            }
                        }
                    }
                }

                this.renderKalender(s, tahun, calEvents);
                this.renderJadwal();
                this.renderATPProta(m, k, s, jp, activeDates);
                this.renderPromes(jp, colEv, s, bAwal);
                this.renderJurnalAbsensi(m, k, s, tahun, dLibur);
                this.renderDaftarNilai();
                if (bab) this.renderModul(m, k, s, bab, jp);
            },

            updateTPSelector: function(m, k, s) {
                const sel = document.getElementById('soal-tp-select');
                if (!sel) return;
                sel.innerHTML = "<option value=''>-- Pilih TP --</option>";
                
                if (this.data[m]?.[k]?.[s]) {
                    Object.keys(this.data[m][k][s]).forEach(bab => {
                        this.data[m][k][s][bab].tps.forEach((tp, i) => {
                            const opt = new Option(tp.tp.substring(0, 70) + '...', `${bab}-${i}`);
                            sel.appendChild(opt);
                        });
                    });
                }
            },

            renderKalender: function(s, tahun, calEvents) {
                const container = document.getElementById('out-kalender');
                if (!container) return;
                
                let html = '';
                const bAwal = s === "Ganjil" ? 6 : 0;
                
                for (let i = 0; i < 6; i++) {
                    let curBln = bAwal + i;
                    let cYr = tahun;
                    if (curBln > 11) { cYr++; curBln -= 12; }
                    
                    const firstDay = new Date(cYr, curBln, 1).getDay();
                    const daysInMonth = new Date(cYr, curBln + 1, 0).getDate();
                    
                    html += `<div class="border border-slate-300 rounded overflow-hidden">
                        <div class="bg-indigo-600 text-white text-center py-1 font-bold text-[9pt]">${BULAN_IND[curBln]} ${cYr}</div>
                        <table class="w-full text-[7pt]">
                            <thead><tr class="bg-slate-100">
                                <th class="text-red-500">M</th><th>S</th><th>S</th><th>R </th><th>K</th><th>J</th><th class="text-blue-600">S</th>
                            </tr></thead>
                            <tbody>`;
                    
                    let day = 1;
                    for (let row = 0; row < 6; row++) {
                        html += '<tr>';
                        for (let col = 0; col < 7; col++) {
                            if (row === 0 && col < firstDay) {
                                html += '<td class="text-center text-slate-300">-</td>';
                            } else if (day > daysInMonth) {
                                html += '<td class="text-center text-slate-300">-</td>';
                            } else {
                                const dateStr = `${cYr}-${String(curBln + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                const isHoliday = calEvents && calEvents[dateStr];
                                const isSunday = col === 0;
                                
                                let cls = 'text-center';
                                if (isSunday) cls += ' text-red-500 font-bold';
                                if (isHoliday) cls += ' bg-red-100';
                                
                                html += `<td class="${cls}" title="${isHoliday || ''}">${day}</td>`;
                                day++;
                            }
                        }
                        html += '</tr>';
                        if (day > daysInMonth) break;
                    }
                    html += '</tbody></table></div>';
                }
                
                container.innerHTML = html;
            },

            renderJadwal: function() {
                const container = document.getElementById('out-jadwal');
                if (!container) return;
                
                const jam = [
                    { no: '1', waktu: '07:00-07:35' },
                    { no: '2', waktu: '07:35-08:10' },
                    { no: '3', waktu: '08:10-08:45' },
                    { no: '4', waktu: '08:45-09:20' },
                    { no: 'IST', waktu: '09:20-09:40' },
                    { no: '5', waktu: '09:40-10:15' },
                    { no: '6', waktu: '10:15-10:50' },
                    { no: '7', waktu: '10:50-11:25' },
                    { no: '8', waktu: '11:25-12:00' }
                ];
                
                let html = '';
                jam.forEach(j => {
                    if (j.no === 'IST') {
                        html += `<tr class="bg-amber-100"><td colspan="8" class="text-center font-bold">ISTIRAHAT (${j.waktu})</td></tr>`;
                    } else {
                        html += `<tr>
                            <td class="text-center bg-slate-50 font-bold">${j.no}</td>
                            <td class="text-center bg-slate-50 text-[8pt]">${j.waktu}</td>
                            <td contenteditable="true" class="text-center"></td>
                            <td contenteditable="true" class="text-center"></td>
                            <td contenteditable="true" class="text-center"></td>
                            <td contenteditable="true" class="text-center"></td>
                            <td contenteditable="true" class="text-center"></td>
                            <td contenteditable="true" class="text-center"></td>
                        </tr>`;
                    }
                });
                
                container.innerHTML = html;
            },

            renderATPProta: function(m, k, s, jp, aDates) {
                const mode = document.getElementById('in-atp-mode')?.value || 'semester';
                let dRender = [];
                
                if (mode === "tahun" && this.data[m]?.[k]) {
                    ["Ganjil", "Genap"].forEach(smt => {
                        if (this.data[m][k][smt]) {
                            Object.keys(this.data[m][k][smt]).forEach(b => {
                                dRender.push({ s: smt, b: b, d: this.data[m][k][smt][b] });
                            });
                        }
                    });
                } else if (this.data[m]?.[k]?.[s]) {
                    Object.keys(this.data[m][k][s]).forEach(b => {
                        dRender.push({ s: s, b: b, d: this.data[m][k][s][b] });
                    });
                }

                let aHtml = "", pHtml = "";
                let dIdx = 0;
                window.promesRows = [];

                dRender.forEach((it, i) => {
                    const tJp = it.d.tps.length * jp;
                    it.d.tps.forEach((tpO, tI) => {
                        const match = tpO.tp.match(/mampu\s+([a-zA-Z\-]+)/i);
                        const kompetensi = match ? match[1].charAt(0).toUpperCase() + match[1].slice(1) : "Memahami";

                        aHtml += '<tr>';
                        if (tI === 0) {
                            aHtml += `<td rowspan="${it.d.tps.length}" class="text-center align-middle">${i + 1}</td>
                                      <td rowspan="${it.d.tps.length}" class="bg-slate-50 align-middle text-[8pt]" contenteditable="true">
                                          <b class="text-indigo-900">${it.b}</b><hr class="my-1">
                                          <span class="text-slate-600">${it.d.cp}</span>
                                      </td>`;
                        }
                        aHtml += `<td contenteditable="true" class="text-[8pt]">${tpO.tp}</td>
                                  <td class="text-[7pt] text-indigo-700">${tpO.p3}</td>
                                  <td class="font-bold text-amber-600 text-center text-[8pt]">${kompetensi}</td>`;
                        if (tI === 0) aHtml += `<td rowspan="${it.d.tps.length}" class="text-center align-middle text-[8pt]">${Math.ceil(tJp / jp)} Mgg<br><b>${tJp} JP</b></td>`;
                        aHtml += '</tr>';

                        pHtml += '<tr>';
                        if (tI === 0) {
                            pHtml += `<td rowspan="${it.d.tps.length}" class="font-bold text-center align-middle">${it.s}</td>
                                      <td rowspan="${it.d.tps.length}" class="bg-slate-50 align-middle text-[8pt]" contenteditable="true">
                                          <b class="text-indigo-900">${it.b}</b><hr class="my-1">
                                          <span class="text-slate-600">${it.d.cp}</span>
                                      </td>`;
                        }
                        pHtml += `<td contenteditable="true" class="text-[8pt]">${tpO.tp}</td>`;
                        if (tI === 0) pHtml += `<td rowspan="${it.d.tps.length}" class="font-bold text-center align-middle">${tJp} JP</td>`;
                        pHtml += '</tr>';

                        if (mode === "semester" || it.s === s) {
                            let dt = aDates && dIdx < aDates.length ? aDates[dIdx++] : null;
                            window.promesRows.push({ bab: tI === 0 ? it.b : "", tp: tpO.tp, jp: jp, dt: dt, rs: tI === 0 ? it.d.tps.length : 0 });
                        }
                    });
                });

                const outAtp = document.getElementById('out-atp');
                if (outAtp) outAtp.innerHTML = aHtml || '<tr><td colspan="6" class="text-center italic text-slate-400 py-6">Data kosong</td></tr>';
                
                const outProta = document.getElementById('out-prota');
                if (outProta) outProta.innerHTML = pHtml || '<tr><td colspan="4" class="text-center italic text-slate-400 py-6">Data kosong</td></tr>';
            },

            renderPromes: function(jp, colEv, s, bAwal) {
                const nb = s === "Ganjil" ? ["Jul", "Ags", "Sep", "Okt", "Nov", "Des"] : ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun"];
                
                let th = '<tr><th rowspan="2" width="10%">Bab</th><th rowspan="2" width="18%">TP</th><th rowspan="2" width="3%">JP</th>';
                nb.forEach(b => th += `<th colspan="5">${b}</th>`);
                th += '</tr><tr>';
                for (let i = 0; i < 6; i++) th += '<th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>';
                th += '</tr>';

                const outHead = document.getElementById('out-promes-head');
                if (outHead) outHead.innerHTML = th;

                let tb = "";
                const r = window.promesRows || [];

                if (r.length > 0) {
                    r.forEach((ro, idx) => {
                        tb += '<tr>';
                        if (ro.rs > 0) tb += `<td rowspan="${ro.rs}" class="bg-slate-50 font-bold text-center align-middle text-[6pt]" contenteditable="true">${ro.bab}</td>`;
                        tb += `<td contenteditable="true" class="text-[6pt]">${ro.tp}</td><td class="text-center font-bold align-middle">${ro.jp}</td>`;

                        for (let c = 0; c < 30; c++) {
                            if (colEv[c]) {
                                if (idx === 0) {
                                    const short = colEv[c].length > 15 ? colEv[c].substring(0, 13) + '..' : colEv[c];
                                    tb += `<td rowspan="${r.length}" class="event-cell"><div class="vertical-event">${short.toUpperCase()}</div></td>`;
                                }
                            } else {
                                const mI = Math.floor(c / 5);
                                const wI = (c % 5) + 1;
                                let tBln = bAwal + mI;
                                if (tBln > 11) tBln -= 12;

                                if (ro.dt && ro.dt.getMonth() === tBln && Math.min(Math.ceil(ro.dt.getDate() / 7), 5) === wI) {
                                    tb += `<td class="bg-indigo-100 text-center font-bold text-indigo-800 align-middle text-[7pt]">${ro.dt.getDate()}</td>`;
                                } else {
                                    tb += '<td contenteditable="true"></td>';
                                }
                            }
                        }
                        tb += '</tr>';
                    });
                } else {
                    tb = '<tr><td colspan="33" class="text-center italic text-slate-400 py-6">Data kosong</td></tr>';
                }

                const outBody = document.getElementById('out-promes-body');
                if (outBody) outBody.innerHTML = tb;
            },

            renderJurnalAbsensi: function(m, k, s, tahun, liburList) {
                const tGuru = document.getElementById('in-tipe-guru').value;
                const rombel = document.getElementById('in-rombel')?.value || "A";
                const tmpt = document.getElementById('in-tempat-tgl')?.value || "";
                const kepsek = document.getElementById('in-kepsek')?.value || "";
                const nipKepsek = document.getElementById('in-nip-kepsek')?.value || "";
                const guru = document.getElementById('in-guru')?.value || "";
                const nipGuru = document.getElementById('in-nip-guru')?.value || "";

                const dataPerBulan = {};
                (window.promesRows || []).forEach(r => {
                    if (r.dt) {
                        const key = `${r.dt.getMonth()}-${r.dt.getFullYear()}`;
                        if (!dataPerBulan[key]) dataPerBulan[key] = [];
                        dataPerBulan[key].push(r);
                    }
                });

                let jHtml = "", aHtml = "";

                Object.keys(dataPerBulan).forEach(key => {
                    const [moStr, yStr] = key.split('-');
                    const mo = parseInt(moStr);
                    const yr = parseInt(yStr);
                    const items = dataPerBulan[key];
                    let currentBab = "";

                    // Get last working day for signature date
                    let lastDay = new Date(yr, mo + 1, 0);
                    while (lastDay.getDay() === 0) lastDay.setDate(lastDay.getDate() - 1);
                    const tglTtd = `${lastDay.getDate()} ${BULAN_IND[mo]} ${yr}`;

                    // JURNAL
                    jHtml += `<div class="paper-preview paper-a4-landscape">
                        <h1 class="text-center text-[13pt] font-bold mb-4 uppercase">JURNAL PELAKSANAAN PEMBELAJARAN<br>BULAN ${BULAN_IND[mo].toUpperCase()} ${yr}</h1>
                        <table class="mb-3" style="font-size: 10pt; width: 50%;">
                            <tr><td width="130">Mata Pelajaran</td><td>: ${m}</td></tr>
                            <tr><td>Kelas/Rombel</td><td>: ${k} / ${rombel}</td></tr>
                        </table>
                        <table class="doc-table text-[8pt]">
                            <thead><tr><th width="10%">Tanggal</th><th width="10%">Kelas</th><th width="15%">Materi</th><th width="35%">Tujuan Pembelajaran</th><th width="10%">Kehadiran</th><th width="20%">Keterangan</th></tr></thead>
                            <tbody>`;

                    items.forEach(it => {
                        if (it.bab) currentBab = it.bab;
                        const tgl = `${String(it.dt.getDate()).padStart(2, '0')}/${String(mo + 1).padStart(2, '0')}/${yr}`;
                        jHtml += `<tr>
                            <td class="text-center font-bold">${tgl}</td>
                            <td class="text-center">${k}/${rombel}</td>
                            <td contenteditable="true">${currentBab}</td>
                            <td contenteditable="true">${it.tp}</td>
                            <td class="text-center font-bold text-indigo-700" contenteditable="true">Hadir Semua</td>
                            <td contenteditable="true">Lancar</td>
                        </tr>`;
                    });

                    jHtml += `</tbody></table>
                        <div class="signature-area">
                            <div class="signature-box">Mengetahui,<br>Kepala Sekolah<span class="signature-name">${kepsek}</span>NIP. ${nipKepsek}</div>
                            <div class="signature-box">${tmpt}, ${tglTtd}<br>Guru Mapel<span class="signature-name">${guru}</span>NIP. ${nipGuru}</div>
                        </div>
                    </div>`;

                    // ABSENSI
                    let tglHead = "";
                    items.forEach(it => tglHead += `<th class="text-[7pt]">${it.dt.getDate()}</th>`);

                    aHtml += `<div class="paper-preview paper-a4-portrait">
                        <h1 class="text-center text-[13pt] font-bold mb-4 uppercase">DAFTAR HADIR SISWA<br>BULAN ${BULAN_IND[mo].toUpperCase()} ${yr}</h1>
                        <table class="mb-3" style="font-size: 10pt; width: 60%;">
                            <tr><td width="130">Mata Pelajaran</td><td>: ${m}</td></tr>
                            <tr><td>Kelas/Rombel</td><td>: ${k} / ${rombel}</td></tr>
                        </table>
                        <table class="doc-table text-[7pt] text-center">
                            <thead>
                                <tr><th rowspan="2" width="4%">No</th><th rowspan="2" width="22%" class="text-left">Nama</th><th colspan="${items.length}">Tanggal</th><th colspan="4">Rekap</th></tr>
                                <tr>${tglHead}<th>H</th><th>S</th><th>I</th><th>A</th></tr>
                            </thead>
                            <tbody>`;

                    const sList = this.students.length > 0 ? this.students : ["Ahmad Fulan", "Siti Fulanah", "Budi Santoso"];
                    sList.forEach((sn, i) => {
                        aHtml += `<tr><td>${i + 1}</td><td class="text-left">${sn}</td>`;
                        for (let c = 0; c < items.length; c++) {
                            aHtml += `<td><span onclick="Engine.toggleAbsen(this)" class="cursor-pointer font-bold text-indigo-600">H</span></td>`;
                        }
                        aHtml += `<td class="bg-indigo-50 font-bold">${items.length}</td><td class="bg-amber-50">0</td><td class="bg-purple-50">0</td><td class="bg-red-50">0</td></tr>`;
                    });

                    aHtml += `</tbody></table>
                        <div class="mt-3 text-[8pt]"><b>Ket:</b> H=Hadir, S=Sakit, I=Izin, A=Alpa. Klik untuk ubah status.</div>
                        <div class="signature-area">
                            <div class="signature-box">Mengetahui,<br>Kepala Sekolah<span class="signature-name">${kepsek}</span>NIP. ${nipKepsek}</div>
                            <div class="signature-box">${tmpt}, ${tglTtd}<br>Guru Mapel<span class="signature-name">${guru}</span>NIP. ${nipGuru}</div>
                        </div>
                    </div>`;
                });

                const jurnalContainer = document.getElementById('jurnal-container');
                if (jurnalContainer) jurnalContainer.innerHTML = jHtml || '<div class="paper-preview paper-a4-landscape text-center italic text-slate-400 py-10">Data kosong</div>';

                const absensiContainer = document.getElementById('absensi-container');
                if (absensiContainer) absensiContainer.innerHTML = aHtml || '<div class="paper-preview paper-a4-portrait text-center italic text-slate-400 py-10">Data kosong</div>';
            },

            renderDaftarNilai: function() {
                let html = "";
                const sList = this.students.length > 0 ? this.students : ["Ahmad Fulan", "Siti Fulanah", "Budi Santoso"];

                sList.forEach((n, i) => {
                    html += `<tr>
                        <td>${i + 1}</td>
                        <td class="text-left" contenteditable="true">${n}</td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td class="bg-amber-50 font-bold" contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td class="font-bold bg-indigo-50 text-indigo-800" contenteditable="true"></td>
                    </tr>`;
                });

                const outNilai = document.getElementById('out-nilai');
                if (outNilai) outNilai.innerHTML = html;
            },

            renderModul: function(m, k, s, bab, jp) {
                const d = this.data[m]?.[k]?.[s]?.[bab];
                if (!d) return;

                const cpEl = document.getElementById('out-modul-cp');
                if (cpEl) cpEl.innerText = d.cp;

                let tpHtml = "", langkahHtml = "", kktpHtml = "";

                d.tps.forEach((t, i) => {
                    tpHtml += `<li class="mb-1"><b>Pertemuan ${i + 1}:</b> ${t.tp}</li>`;

                    langkahHtml += `<div class="mb-3 bg-slate-50 p-3 rounded border" style="page-break-inside: avoid;">
                        <div class="font-bold border-b pb-1 mb-2 text-indigo-800">Pertemuan ${i + 1} (${jp} JP)</div>
                        <div class="mb-2">
                            <b class="underline">A. Pendahuluan (15')</b>
                            <ol class="list-decimal pl-5 mt-1">
                                <li>Salam, doa, presensi</li>
                                <li>Apersepsi: "${bab}"</li>
                                <li>Menyampaikan TP</li>
                            </ol>
                        </div>
                        <div class="mb-2">
                            <b class="underline">B. Inti (60')</b>
                            <ol class="list-decimal pl-5 mt-1">
                                <li>Orientasi materi</li>
                                <li>Diskusi kelompok + LKPD</li>
                                <li>Presentasi</li>
                                <li>Penguatan</li>
                            </ol>
                        </div>
                        <div>
                            <b class="underline">C. Penutup (15')</b>
                            <ol class="list-decimal pl-5 mt-1">
                                <li>Kesimpulan</li>
                                <li>Refleksi</li>
                                <li>Doa penutup</li>
                            </ol>
                        </div>
                    </div>`;

                    kktpHtml += `<tr>
                        <td class="text-center">${i + 1}</td>
                        <td contenteditable="true" class="text-[8pt]">${t.tp}</td>
                        <td class="kktp-val" contenteditable="true" oninput="Engine.calcKktp(this)">75</td>
                        <td class="kktp-val" contenteditable="true" oninput="Engine.calcKktp(this)">75</td>
                        <td class="kktp-val" contenteditable="true" oninput="Engine.calcKktp(this)">75</td>
                        <td class="kktp-hasil">75</td>
                    </tr>`;
                });

                const tpEl = document.getElementById('out-modul-tp');
                if (tpEl) tpEl.innerHTML = `<b class="text-indigo-800">Tujuan Pembelajaran:</b><ul class="list-disc pl-5 mt-1">${tpHtml}</ul>`;

                const lkpdTpEl = document.getElementById('out-lkpd-tp');
                if (lkpdTpEl) lkpdTpEl.innerHTML = tpHtml;

                const langkahEl = document.getElementById('out-modul-langkah');
                if (langkahEl) langkahEl.innerHTML = langkahHtml;

                const kktpEl = document.getElementById('out-kktp');
                if (kktpEl) kktpEl.innerHTML = kktpHtml;
            }
        };

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            // Set initial tab
            UI.switchTab('atp');
            
            // Generate default calendar
            Engine.generateDefaultCalendar();
            
            // Mobile sidebar close on outside click
            document.addEventListener('click', (e) => {
                const sidebar = document.getElementById('sidebar');
                const menuBtn = document.getElementById('mobile-menu-btn');
                if (window.innerWidth < 768 && sidebar?.classList.contains('open')) {
                    if (!sidebar.contains(e.target) && !menuBtn?.contains(e.target)) {
                        sidebar.classList.remove('open');
                    }
                }
            });
            
            // Window resize handler
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 768) {
                    document.getElementById('sidebar')?.classList.remove('open');
                }
            });
        });
    </script>
</body>
</html>