<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guru Smart - Aplikasi Administrasi Guru</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#3b82f6',
                        accent: '#10b981'
                    }
                }
            }
        }
    </script>
    
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar.collapsed { transform: translateX(-100%); }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-fade-out { animation: fadeOut 0.3s ease-out; }

        @media print {
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            body { font-family: 'Times New Roman', serif; font-size: 12pt; }
            @page { size: A4; margin: 2cm; }
            .no-print, nav, .sidebar, button:not(.print-show), #loading-overlay { display: none !important; }
            .print-only { display: block !important; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #000; padding: 8px; }
            th { background-color: #f0f0f0 !important; font-weight: bold; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-4">
            <svg class="animate-spin h-8 w-8 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-700 font-medium">Memuat...</span>
        </div>
    </div>

    <!-- Auth Container -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-purple-700">
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar fixed left-0 top-0 h-full w-64 bg-gray-800 text-white z-40 overflow-y-auto">
            <div class="p-4 border-b border-gray-700">
                <h1 class="text-xl font-bold">üéì Guru Smart</h1>
                <p id="user-name" class="text-sm text-gray-400 mt-1"></p>
                <p id="school-name" class="text-xs text-gray-500"></p>
            </div>
            
            <nav class="p-4">
                <ul class="space-y-2">
                    <li><button data-tab="dashboard" class="nav-link w-full flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 transition"><span class="mr-3">üìä</span> Dashboard</button></li>
                    <li><button data-tab="master-data" class="nav-link w-full flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 transition"><span class="mr-3">üìù</span> Master Data & CP</button></li>
                    <li><button data-tab="atp" class="nav-link w-full flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 transition"><span class="mr-3">üéØ</span> ATP</button></li>
                    <li><button data-tab="kktp" class="nav-link w-full flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 transition"><span class="mr-3">‚úÖ</span> KKTP</button></li>
                    <li><button data-tab="calendar" class="nav-link w-full flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 transition"><span class="mr-3">üìÖ</span> Kalender Pendidikan</button></li>
                    <li><button data-tab="schedule" class="nav-link w-full flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 transition"><span class="mr-3">üïê</span> Jadwal Pelajaran</button></li>
                    <li><button data-tab="prota" class="nav-link w-full flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 transition"><span class="mr-3">üìã</span> Program Tahunan</button></li>
                    <li><button data-tab="promes" class="nav-link w-full flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 transition"><span class="mr-3">üìÜ</span> Program Semester</button></li>
                    <li><button data-tab="modul" class="nav-link w-full flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 transition"><span class="mr-3">üìö</span> Modul Ajar</button></li>
                    <li><button data-tab="bank-soal" class="nav-link w-full flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 transition"><span class="mr-3">‚ùì</span> Bank Soal</button></li>
                </ul>
            </nav>

            <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-700">
                <button onclick="Auth.logout()" class="w-full flex items-center justify-center px-4 py-2 bg-red-600 rounded-lg hover:bg-red-700 transition">
                    <span class="mr-2">üö™</span> Keluar
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="ml-64 min-h-screen">
            <header class="bg-white shadow-sm sticky top-0 z-30">
                <div class="flex items-center justify-between px-6 py-4">
                    <div class="flex items-center">
                        <button id="toggle-sidebar" class="mr-4 p-2 rounded-lg hover:bg-gray-100 lg:hidden">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                        </button>
                        <h2 id="page-title" class="text-xl font-semibold text-gray-800">Dashboard</h2>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="tahun-ajaran" class="text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded"></span>
                        <button id="btn-print-current" class="no-print flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition">
                            <span class="mr-2">üñ®Ô∏è</span> Cetak
                        </button>
                    </div>
                </div>
            </header>

            <div class="p-6">
                <!-- Dashboard Tab -->
                <div id="tab-dashboard" class="tab-content active">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg"><span class="text-2xl">üìù</span></div>
                                <div class="ml-4">
                                    <p class="text-gray-500 text-sm">Capaian Pembelajaran</p>
                                    <p id="stat-cp" class="text-2xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg"><span class="text-2xl">üéØ</span></div>
                                <div class="ml-4">
                                    <p class="text-gray-500 text-sm">ATP</p>
                                    <p id="stat-atp" class="text-2xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg"><span class="text-2xl">üìö</span></div>
                                <div class="ml-4">
                                    <p class="text-gray-500 text-sm">Modul Ajar</p>
                                    <p id="stat-modul" class="text-2xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-purple-100 rounded-lg"><span class="text-2xl">‚ùì</span></div>
                                <div class="ml-4">
                                    <p class="text-gray-500 text-sm">Bank Soal</p>
                                    <p id="stat-soal" class="text-2xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow p-6 mb-8">
                        <h3 class="text-lg font-semibold mb-4">Aksi Cepat</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <button onclick="App.switchTab('master-data')" class="p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-primary hover:bg-blue-50 transition text-center">
                                <span class="text-3xl block mb-2">‚ûï</span>
                                <span class="text-sm text-gray-600">Input CP Baru</span>
                            </button>
                            <button onclick="App.switchTab('modul')" class="p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-primary hover:bg-blue-50 transition text-center">
                                <span class="text-3xl block mb-2">üìö</span>
                                <span class="text-sm text-gray-600">Buat Modul Ajar</span>
                            </button>
                            <button onclick="App.switchTab('schedule')" class="p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-primary hover:bg-blue-50 transition text-center">
                                <span class="text-3xl block mb-2">üïê</span>
                                <span class="text-sm text-gray-600">Atur Jadwal</span>
                            </button>
                            <button onclick="App.switchTab('bank-soal')" class="p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-primary hover:bg-blue-50 transition text-center">
                                <span class="text-3xl block mb-2">‚ùì</span>
                                <span class="text-sm text-gray-600">Tambah Soal</span>
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">8 Dimensi Profil Lulusan</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="profil-lulusan-grid"></div>
                    </div>
                </div>

                <div id="tab-master-data" class="tab-content"></div>
                <div id="tab-atp" class="tab-content"></div>
                <div id="tab-kktp" class="tab-content"></div>
                <div id="tab-calendar" class="tab-content"></div>
                <div id="tab-schedule" class="tab-content"></div>
                <div id="tab-prota" class="tab-content"></div>
                <div id="tab-promes" class="tab-content"></div>
                <div id="tab-modul" class="tab-content"></div>
                <div id="tab-bank-soal" class="tab-content"></div>
            </div>
        </main>
    </div>

    <!-- Complete Profile Modal -->
    <div id="complete-profile-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-2">üìã Lengkapi Profil Anda</h3>
            <p class="text-gray-500 text-sm mb-4">Data profil Anda belum lengkap. Silakan lengkapi data berikut:</p>
            
            <form id="complete-profile-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap *</label>
                    <input type="text" id="profile-nama" required
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary"
                        placeholder="Nama lengkap dengan gelar">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">NPSN Sekolah *</label>
                    <input type="text" id="profile-npsn" required maxlength="8" pattern="[0-9]{8}"
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary"
                        placeholder="8 digit NPSN">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenjang *</label>
                    <select id="profile-jenjang" required
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary">
                        <option value="">Pilih Jenjang</option>
                        <option value="SD">SD</option>
                        <option value="SMP">SMP</option>
                        <option value="SMA">SMA</option>
                        <option value="SMK">SMK</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Sekolah *</label>
                    <input type="text" id="profile-sekolah" required
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary"
                        placeholder="Nama lengkap sekolah">
                </div>
                <button type="submit" 
                    class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                    üíæ Simpan & Lanjutkan
                </button>
            </form>
        </div>
    </div>

    <script>
// =====================================================
// FIREBASE CONFIG
// =====================================================
const firebaseConfig = {
    apiKey: "AIzaSyCyRKvngA1EqlQmgxgxU4465qgRw8TdT08",
    authDomain: "sigumart-c977e.firebaseapp.com",
    projectId: "sigumart-c977e",
    storageBucket: "sigumart-c977e.firebasestorage.app",
    messagingSenderId: "191aborongan492389029",
    appId: "1:191492389029:web:cc7b6f9f2e4a8e8f8b8b8b"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Collections Reference
const COLLECTIONS = {
    USERS: 'users',
    SCHOOLS: 'schools',
    SUBJECTS: 'subjects',
    CP_DATA: 'cp_data',
    ATP: 'atp',
    KKTP: 'kktp',
    CALENDAR: 'calendar',
    SCHEDULE: 'schedule',
    PROTA: 'prota',
    PROMES: 'promes',
    MODUL_AJAR: 'modul_ajar',
    BANK_SOAL: 'bank_soal',
    ROMBEL: 'rombel'
};

// 8 Dimensi Profil Lulusan
const PROFIL_LULUSAN = [
    { id: 'keimanan', nama: 'Keimanan dan Ketakwaan', deskripsi: 'Keyakinan teguh pada Tuhan YME' },
    { id: 'kewargaan', nama: 'Kewargaan', deskripsi: 'Cinta tanah air, sadar aturan, dan peduli sosial' },
    { id: 'penalaran', nama: 'Penalaran Kritis', deskripsi: 'Berpikir logis dan analitis' },
    { id: 'kreativitas', nama: 'Kreativitas', deskripsi: 'Inovatif dan fleksibel' },
    { id: 'kolaborasi', nama: 'Kolaborasi', deskripsi: 'Bekerja sama mencapai tujuan' },
    { id: 'kemandirian', nama: 'Kemandirian', deskripsi: 'Mampu mengelola diri sendiri' },
    { id: 'kesehatan', nama: 'Kesehatan', deskripsi: 'Fisik prima dan mental sehat' },
    { id: 'komunikasi', nama: 'Komunikasi', deskripsi: 'Efektif menyampaikan ide' }
];

// Jenjang Pendidikan
const JENJANG = {
    SD: { nama: 'SD', kelas: [1, 2, 3, 4, 5, 6] },
    SMP: { nama: 'SMP', kelas: [7, 8, 9] },
    SMA: { nama: 'SMA', kelas: [10, 11, 12] },
    SMK: { nama: 'SMK', kelas: [10, 11, 12] }
};

// Template Mata Pelajaran
const SUBJECT_TEMPLATES = {
    'PAI': { nama: 'Pendidikan Agama Islam dan Budi Pekerti', elemen: ['Al-Quran dan Hadis', 'Aqidah', 'Akhlak', 'Fikih', 'Sejarah Peradaban Islam'] },
    'PKN': { nama: 'Pendidikan Pancasila dan Kewarganegaraan', elemen: ['Pancasila', 'UUD 1945', 'NKRI', 'Bhinneka Tunggal Ika'] },
    'INDONESIA': { nama: 'Bahasa Indonesia', elemen: ['Menyimak', 'Membaca', 'Memirsa', 'Berbicara', 'Menulis'] },
    'MATEMATIKA': { nama: 'Matematika', elemen: ['Bilangan', 'Aljabar', 'Geometri', 'Pengukuran', 'Analisis Data'] },
    'IPA': { nama: 'Ilmu Pengetahuan Alam', elemen: ['Makhluk Hidup', 'Zat dan Perubahannya', 'Energi', 'Bumi dan Antariksa'] },
    'IPS': { nama: 'Ilmu Pengetahuan Sosial', elemen: ['Geografi', 'Ekonomi', 'Sosiologi', 'Sejarah'] },
    'INGGRIS': { nama: 'Bahasa Inggris', elemen: ['Listening', 'Speaking', 'Reading', 'Writing'] },
    'SENI': { nama: 'Seni Budaya', elemen: ['Seni Rupa', 'Seni Musik', 'Seni Tari', 'Seni Teater'] },
    'PJOK': { nama: 'Pendidikan Jasmani', elemen: ['Gerak Dasar', 'Aktivitas Fisik', 'Kesehatan', 'Kebugaran'] },
    'INFORMATIKA': { nama: 'Informatika', elemen: ['Berpikir Komputasional', 'Teknologi Informasi', 'Praktik Lintas Bidang'] }
};

console.log('Firebase Config Loaded');

// =====================================================
// UTILITY FUNCTIONS
// =====================================================
const Utils = {
    generateId: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
    
    formatDate: (date) => new Date(date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }),
    
    formatDateShort: (date) => new Date(date).toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' }),
    
    getDayName: (dayIndex) => ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'][dayIndex],
    
    getMonthName: (monthIndex) => ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'][monthIndex],

    showLoading: (message = 'Memuat...') => {
        const loadingEl = document.getElementById('loading-overlay');
        if (loadingEl) {
            loadingEl.querySelector('span').textContent = message;
            loadingEl.classList.remove('hidden');
        }
    },

    hideLoading: () => {
        const loadingEl = document.getElementById('loading-overlay');
        if (loadingEl) loadingEl.classList.add('hidden');
    },

    showNotification: (message, type = 'success') => {
        const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.classList.add('animate-fade-out');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    },

    confirm: (message) => {
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                    <p class="text-gray-800 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="btn-cancel px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Batal</button>
                        <button class="btn-confirm px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Ya</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('.btn-cancel').onclick = () => { modal.remove(); resolve(false); };
            modal.querySelector('.btn-confirm').onclick = () => { modal.remove(); resolve(true); };
        });
    },

    validateNPSN: (npsn) => /^\d{8}$/.test(npsn),
    
    getTahunAjaran: () => {
        const now = new Date();
        const year = now.getFullYear();
        return now.getMonth() >= 6 ? `${year}/${year + 1}` : `${year - 1}/${year}`;
    },
    
    getSemester: () => new Date().getMonth() >= 6 ? 1 : 2,

    printDocument: (elementId, title) => {
        const element = document.getElementById(elementId);
        if (!element) return;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html><html><head><title>${title}</title>
            <style>
                @page { size: A4; margin: 2cm; }
                body { font-family: 'Times New Roman', serif; font-size: 12pt; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #000; padding: 8px; }
                th { background: #f0f0f0; }
            </style>
            </head><body>${element.innerHTML}</body></html>
        `);
        printWindow.document.close();
        printWindow.onload = () => printWindow.print();
    }
};

console.log('Utils Loaded');

// =====================================================
// AUTHENTICATION MODULE - FIXED VERSION
// =====================================================
const Auth = {
    currentUser: null,
    userData: null,

    init: () => {
        Auth.renderAuthForm();
        Auth.setupAuthListener();
        Auth.setupCompleteProfileForm();
    },

    renderAuthForm: () => {
        const container = document.getElementById('auth-container');
        container.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
                <div class="flex border-b">
                    <button id="login-tab" class="flex-1 py-4 text-center font-semibold text-primary border-b-2 border-primary">Masuk</button>
                    <button id="register-tab" class="flex-1 py-4 text-center font-semibold text-gray-500 hover:text-primary">Daftar</button>
                </div>

                <div id="login-form" class="p-8">
                    <div class="text-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-800">üéì Guru Smart</h1>
                        <p class="text-gray-500">Aplikasi Administrasi Guru Modern</p>
                    </div>
                    
                    <form id="login-form-submit" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="login-email" required
                                class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                placeholder="email@sekolah.sch.id">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="login-password" required
                                class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <button type="submit" 
                            class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                            Masuk
                        </button>
                    </form>
                </div>

                <div id="register-form" class="p-8 hidden">
                    <div class="text-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-800">Daftar Akun Baru</h1>
                        <p class="text-gray-500">Bergabung dengan Guru Smart</p>
                    </div>
                    
                    <form id="register-form-submit" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                            <input type="text" id="reg-nama" required
                                class="w-full px-4 py-3 border rounded-lg"
                                placeholder="Nama lengkap dengan gelar">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">NPSN Sekolah</label>
                            <input type="text" id="reg-npsn" required maxlength="8"
                                class="w-full px-4 py-3 border rounded-lg"
                                placeholder="8 digit NPSN">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Jenjang</label>
                            <select id="reg-jenjang" required class="w-full px-4 py-3 border rounded-lg">
                                <option value="">Pilih Jenjang</option>
                                <option value="SD">SD</option>
                                <option value="SMP">SMP</option>
                                <option value="SMA">SMA</option>
                                <option value="SMK">SMK</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Sekolah</label>
                            <input type="text" id="reg-sekolah" required
                                class="w-full px-4 py-3 border rounded-lg"
                                placeholder="Nama lengkap sekolah">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="reg-email" required
                                class="w-full px-4 py-3 border rounded-lg"
                                placeholder="email@sekolah.sch.id">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="reg-password" required minlength="6"
                                class="w-full px-4 py-3 border rounded-lg"
                                placeholder="Minimal 6 karakter">
                        </div>
                        <button type="submit" 
                            class="w-full bg-accent text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition">
                            Daftar
                        </button>
                    </form>
                </div>
            </div>
        `;

        // Tab switching
        document.getElementById('login-tab').addEventListener('click', () => {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('login-tab').classList.add('border-b-2', 'border-primary', 'text-primary');
            document.getElementById('login-tab').classList.remove('text-gray-500');
            document.getElementById('register-tab').classList.remove('border-b-2', 'border-primary', 'text-primary');
            document.getElementById('register-tab').classList.add('text-gray-500');
        });

        document.getElementById('register-tab').addEventListener('click', () => {
            document.getElementById('register-form').classList.remove('hidden');
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-tab').classList.add('border-b-2', 'border-primary', 'text-primary');
            document.getElementById('register-tab').classList.remove('text-gray-500');
            document.getElementById('login-tab').classList.remove('border-b-2', 'border-primary', 'text-primary');
            document.getElementById('login-tab').classList.add('text-gray-500');
        });

        document.getElementById('login-form-submit').addEventListener('submit', Auth.handleLogin);
        document.getElementById('register-form-submit').addEventListener('submit', Auth.handleRegister);
    },

    setupCompleteProfileForm: () => {
        document.getElementById('complete-profile-form').addEventListener('submit', Auth.handleCompleteProfile);
    },

    handleLogin: async (e) => {
        e.preventDefault();
        Utils.showLoading('Memproses login...');

        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        try {
            await auth.signInWithEmailAndPassword(email, password);
            Utils.showNotification('Login berhasil!', 'success');
        } catch (error) {
            console.error('Login error:', error);
            let errorMessage = 'Login gagal. ';
            switch (error.code) {
                case 'auth/user-not-found': errorMessage += 'Email tidak terdaftar.'; break;
                case 'auth/wrong-password': errorMessage += 'Password salah.'; break;
                case 'auth/invalid-email': errorMessage += 'Format email tidak valid.'; break;
                case 'auth/too-many-requests': errorMessage += 'Terlalu banyak percobaan. Coba lagi nanti.'; break;
                default: errorMessage += error.message;
            }
            Utils.showNotification(errorMessage, 'error');
        } finally {
            Utils.hideLoading();
        }
    },

    handleRegister: async (e) => {
        e.preventDefault();
        Utils.showLoading('Membuat akun...');

        const nama = document.getElementById('reg-nama').value;
        const npsn = document.getElementById('reg-npsn').value;
        const jenjang = document.getElementById('reg-jenjang').value;
        const sekolah = document.getElementById('reg-sekolah').value;
        const email = document.getElementById('reg-email').value;
        const password = document.getElementById('reg-password').value;

        if (!Utils.validateNPSN(npsn)) {
            Utils.showNotification('NPSN harus 8 digit angka', 'error');
            Utils.hideLoading();
            return;
        }

        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;

            // Create school document
            const schoolRef = db.collection(COLLECTIONS.SCHOOLS).doc(npsn);
            const schoolDoc = await schoolRef.get();
            if (!schoolDoc.exists) {
                await schoolRef.set({
                    npsn: npsn,
                    nama: sekolah,
                    jenjang: jenjang,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            // Create user document
            await db.collection(COLLECTIONS.USERS).doc(user.uid).set({
                uid: user.uid,
                email: email,
                nama: nama,
                npsn: npsn,
                jenjang: jenjang,
                namaSekolah: sekolah,
                role: 'guru',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            Utils.showNotification('Pendaftaran berhasil! Selamat datang ' + nama, 'success');
        } catch (error) {
            console.error('Register error:', error);
            let errorMessage = 'Pendaftaran gagal. ';
            switch (error.code) {
                case 'auth/email-already-in-use': 
                    errorMessage = '‚ö†Ô∏è Email sudah terdaftar! Silakan LOGIN dengan email ini.'; 
                    break;
                case 'auth/weak-password': errorMessage += 'Password terlalu lemah.'; break;
                default: errorMessage += error.message;
            }
            Utils.showNotification(errorMessage, 'error');
        } finally {
            Utils.hideLoading();
        }
    },

    // Handle completing profile for users without Firestore data
    handleCompleteProfile: async (e) => {
        e.preventDefault();
        Utils.showLoading('Menyimpan profil...');

        const nama = document.getElementById('profile-nama').value;
        const npsn = document.getElementById('profile-npsn').value;
        const jenjang = document.getElementById('profile-jenjang').value;
        const sekolah = document.getElementById('profile-sekolah').value;

        if (!Utils.validateNPSN(npsn)) {
            Utils.showNotification('NPSN harus 8 digit angka', 'error');
            Utils.hideLoading();
            return;
        }

        try {
            const user = Auth.currentUser;

            // Create school document if not exists
            const schoolRef = db.collection(COLLECTIONS.SCHOOLS).doc(npsn);
            const schoolDoc = await schoolRef.get();
            if (!schoolDoc.exists) {
                await schoolRef.set({
                    npsn: npsn,
                    nama: sekolah,
                    jenjang: jenjang,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            // Create user document
            await db.collection(COLLECTIONS.USERS).doc(user.uid).set({
                uid: user.uid,
                email: user.email,
                nama: nama,
                npsn: npsn,
                jenjang: jenjang,
                namaSekolah: sekolah,
                role: 'guru',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            Auth.userData = {
                uid: user.uid,
                email: user.email,
                nama: nama,
                npsn: npsn,
                jenjang: jenjang,
                namaSekolah: sekolah,
                role: 'guru'
            };

            document.getElementById('complete-profile-modal').classList.add('hidden');
            Utils.showNotification('Profil berhasil disimpan!', 'success');
            Auth.showApp();
        } catch (error) {
            console.error('Error saving profile:', error);
            Utils.showNotification('Gagal menyimpan profil: ' + error.message, 'error');
        } finally {
            Utils.hideLoading();
        }
    },

    setupAuthListener: () => {
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                Auth.currentUser = user;
                console.log('User logged in:', user.email);
                
                try {
                    // Try to get user data from Firestore
                    const userDoc = await db.collection(COLLECTIONS.USERS).doc(user.uid).get();
                    
                    if (userDoc.exists) {
                        Auth.userData = userDoc.data();
                        console.log('User data found:', Auth.userData);
                        Auth.showApp();
                    } else {
                        // User exists in Auth but not in Firestore
                        // Show complete profile modal
                        console.log('User data not found in Firestore. Showing complete profile form.');
                        Auth.showCompleteProfileModal();
                    }
                } catch (error) {
                    console.error('Error getting user data:', error);
                    Utils.showNotification('Error mengambil data: ' + error.message, 'error');
                    // Still show complete profile modal as fallback
                    Auth.showCompleteProfileModal();
                }
            } else {
                Auth.currentUser = null;
                Auth.userData = null;
                Auth.showAuth();
            }
        });
    },

    showCompleteProfileModal: () => {
        document.getElementById('auth-container').classList.add('hidden');
        document.getElementById('app-container').classList.add('hidden');
        document.getElementById('complete-profile-modal').classList.remove('hidden');
    },

    showApp: () => {
        document.getElementById('auth-container').classList.add('hidden');
        document.getElementById('complete-profile-modal').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        App.init();
    },

    showAuth: () => {
        document.getElementById('auth-container').classList.remove('hidden');
        document.getElementById('app-container').classList.add('hidden');
        document.getElementById('complete-profile-modal').classList.add('hidden');
    },

    logout: async () => {
        const confirm = await Utils.confirm('Yakin ingin keluar?');
        if (confirm) {
            await auth.signOut();
            Utils.showNotification('Berhasil logout', 'success');
        }
    }
};

// =====================================================
// MAIN APPLICATION CONTROLLER
// =====================================================
const App = {
    currentTab: 'dashboard',

    init: async () => {
        console.log('Initializing App for user:', Auth.userData?.nama);
        
        document.getElementById('user-name').textContent = Auth.userData?.nama || 'User';
        document.getElementById('school-name').textContent = Auth.userData?.namaSekolah || 'Sekolah';
        document.getElementById('tahun-ajaran').textContent = `TA ${Utils.getTahunAjaran()}`;

        App.setupNavigation();
        App.renderProfilLulusan();

        await MasterData.init();
        await AtpKktp.init();
        await CalendarSchedule.init();
        await ProtaPromes.init();
        await ModulAjar.init();
        await BankSoal.init();

        await App.loadDashboardStats();

        document.getElementById('btn-print-current').addEventListener('click', () => App.printCurrentTab());

        console.log('App initialized successfully');
    },

    setupNavigation: () => {
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => App.switchTab(link.dataset.tab));
        });
        document.getElementById('toggle-sidebar')?.addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
    },

    switchTab: (tabName) => {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.getElementById(`tab-${tabName}`)?.classList.add('active');
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('bg-gray-700');
            if (link.dataset.tab === tabName) link.classList.add('bg-gray-700');
        });

        const titles = {
            'dashboard': 'Dashboard',
            'master-data': 'Master Data & Capaian Pembelajaran',
            'atp': 'Alur Tujuan Pembelajaran (ATP)',
            'kktp': 'Kriteria Ketercapaian Tujuan Pembelajaran',
            'calendar': 'Kalender Pendidikan',
            'schedule': 'Jadwal Pelajaran',
            'prota': 'Program Tahunan (Prota)',
            'promes': 'Program Semester (Promes)',
            'modul': 'Modul Ajar',
            'bank-soal': 'Bank Soal'
        };
        document.getElementById('page-title').textContent = titles[tabName] || tabName;
        App.currentTab = tabName;
    },

    renderProfilLulusan: () => {
        const container = document.getElementById('profil-lulusan-grid');
        const colors = ['purple', 'red', 'blue', 'yellow', 'green', 'indigo', 'pink', 'orange'];
        container.innerHTML = PROFIL_LULUSAN.map((p, i) => `
            <div class="p-4 bg-${colors[i]}-50 rounded-lg border border-${colors[i]}-200">
                <h4 class="font-semibold text-${colors[i]}-800 text-sm">${p.nama}</h4>
                <p class="text-xs text-${colors[i]}-600 mt-1">${p.deskripsi}</p>
            </div>
        `).join('');
    },

    loadDashboardStats: async () => {
        try {
            const userId = Auth.currentUser.uid;
            const [cpSnap, atpSnap, modulSnap, soalSnap] = await Promise.all([
                db.collection(COLLECTIONS.CP_DATA).where('userId', '==', userId).get(),
                db.collection(COLLECTIONS.ATP).where('userId', '==', userId).get(),
                db.collection(COLLECTIONS.MODUL_AJAR).where('userId', '==', userId).get(),
                db.collection(COLLECTIONS.BANK_SOAL).where('userId', '==', userId).get()
            ]);
            document.getElementById('stat-cp').textContent = cpSnap.size;
            document.getElementById('stat-atp').textContent = atpSnap.size;
            document.getElementById('stat-modul').textContent = modulSnap.size;
            document.getElementById('stat-soal').textContent = soalSnap.size;
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    },

    printCurrentTab: () => {
        Utils.printDocument(`tab-${App.currentTab}`, App.currentTab);
    }
};

// =====================================================
// MASTER DATA MODULE
// =====================================================
const MasterData = {
    subjects: [],
    cpData: [],
    rombel: [],

    init: async () => {
        MasterData.render();
        await MasterData.loadSubjects();
        await MasterData.loadRombel();
        await MasterData.loadCPData();
    },

    render: () => {
        const container = document.getElementById('tab-master-data');
        const jenjang = Auth.userData?.jenjang || 'SMP';
        const kelasOptions = JENJANG[jenjang]?.kelas || [7, 8, 9];
        
        container.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">üìö Mata Pelajaran</h3>
                        <div class="space-y-4">
                            <select id="subject-template" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">-- Pilih Template Mapel --</option>
                                ${Object.entries(SUBJECT_TEMPLATES).map(([k, v]) => `<option value="${k}">${v.nama}</option>`).join('')}
                            </select>
                            <button onclick="MasterData.addSubject()" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-blue-700">
                                Tambah Mata Pelajaran
                            </button>
                        </div>
                        <div class="mt-4">
                            <h4 class="font-medium text-gray-700 mb-2">Mata Pelajaran Saya:</h4>
                            <div id="my-subjects-list" class="space-y-2 max-h-48 overflow-y-auto">
                                <p class="text-gray-400 text-sm">Memuat...</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">üë• Rombongan Belajar</h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-3">
                                <select id="rombel-kelas" class="px-3 py-2 border rounded-lg">
                                    ${kelasOptions.map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}
                                </select>
                                <input type="text" id="rombel-nama" placeholder="A, B, C..." class="px-3 py-2 border rounded-lg">
                            </div>
                            <button onclick="MasterData.addRombel()" class="w-full bg-accent text-white py-2 rounded-lg hover:bg-green-600">
                                Tambah Rombel
                            </button>
                        </div>
                        <div class="mt-4">
                            <h4 class="font-medium text-gray-700 mb-2">Rombel Saya:</h4>
                            <div id="my-rombel-list" class="flex flex-wrap gap-2">
                                <p class="text-gray-400 text-sm">Memuat...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">üìù Input Capaian Pembelajaran (CP)</h3>
                        <form id="cp-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <select id="cp-mapel" required class="px-3 py-2 border rounded-lg">
                                    <option value="">Pilih Mata Pelajaran</option>
                                </select>
                                <select id="cp-kelas" required class="px-3 py-2 border rounded-lg">
                                    <option value="">Pilih Kelas</option>
                                    ${kelasOptions.map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}
                                </select>
                            </div>
                            <select id="cp-elemen" required class="w-full px-3 py-2 border rounded-lg">
                                <option value="">Pilih Elemen</option>
                            </select>
                            <textarea id="cp-text" rows="4" required class="w-full px-3 py-2 border rounded-lg" placeholder="Masukkan Capaian Pembelajaran..."></textarea>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Dimensi Profil Lulusan</label>
                                <div class="grid grid-cols-2 gap-2">
                                    ${PROFIL_LULUSAN.map(p => `
                                        <label class="flex items-center space-x-2 p-2 border rounded hover:bg-gray-50 cursor-pointer">
                                            <input type="checkbox" name="profil-lulusan" value="${p.id}" class="rounded">
                                            <span class="text-sm">${p.nama}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-blue-700">
                                üíæ Simpan CP
                            </button>
                        </form>
                    </div>

                    <div class="bg-white rounded-xl shadow p-6 mt-6">
                        <h3 class="text-lg font-semibold mb-4">üìã Daftar Capaian Pembelajaran</h3>
                        <div id="cp-list" class="space-y-3 max-h-96 overflow-y-auto">
                            <p class="text-gray-400 text-center py-8">Memuat...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('cp-mapel').addEventListener('change', MasterData.handleMapelChange);
        document.getElementById('cp-form').addEventListener('submit', MasterData.saveCP);
    },

    handleMapelChange: (e) => {
        const subject = MasterData.subjects.find(s => s.id === e.target.value);
        const elemenSelect = document.getElementById('cp-elemen');
        elemenSelect.innerHTML = '<option value="">Pilih Elemen</option>' + 
            (subject ? subject.elemen.map(el => `<option value="${el}">${el}</option>`).join('') : '');
    },

    addSubject: async () => {
        const template = document.getElementById('subject-template').value;
        if (!template) { Utils.showNotification('Pilih template mata pelajaran', 'warning'); return; }

        Utils.showLoading('Menyimpan...');
        try {
            await db.collection(COLLECTIONS.SUBJECTS).add({
                userId: Auth.currentUser.uid,
                npsn: Auth.userData.npsn,
                kode: template,
                ...SUBJECT_TEMPLATES[template],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            Utils.showNotification('Mata pelajaran ditambahkan', 'success');
            document.getElementById('subject-template').value = '';
            await MasterData.loadSubjects();
        } catch (error) {
            Utils.showNotification('Gagal: ' + error.message, 'error');
        } finally {
            Utils.hideLoading();
        }
    },

    loadSubjects: async () => {
        try {
            const snapshot = await db.collection(COLLECTIONS.SUBJECTS).where('userId', '==', Auth.currentUser.uid).get();
            MasterData.subjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            MasterData.renderSubjectsList();
            MasterData.updateMapelDropdowns();
        } catch (error) { console.error('Error loading subjects:', error); }
    },

    renderSubjectsList: () => {
        const container = document.getElementById('my-subjects-list');
        if (!container) return;
        container.innerHTML = MasterData.subjects.length === 0 
            ? '<p class="text-gray-400 text-sm">Belum ada mata pelajaran</p>'
            : MasterData.subjects.map(s => `
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                    <div>
                        <span class="font-medium text-sm">${s.nama}</span>
                        <span class="text-xs text-gray-500 block">${s.elemen?.length || 0} elemen</span>
                    </div>
                    <button onclick="MasterData.deleteSubject('${s.id}')" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                </div>
            `).join('');
    },

    updateMapelDropdowns: () => {
        const options = MasterData.subjects.map(s => `<option value="${s.id}">${s.nama}</option>`).join('');
        const cpMapel = document.getElementById('cp-mapel');
        if (cpMapel) cpMapel.innerHTML = '<option value="">Pilih Mata Pelajaran</option>' + options;
    },

    deleteSubject: async (id) => {
        if (!(await Utils.confirm('Hapus mata pelajaran ini?'))) return;
        try {
            await db.collection(COLLECTIONS.SUBJECTS).doc(id).delete();
            Utils.showNotification('Dihapus', 'success');
            await MasterData.loadSubjects();
        } catch (error) { Utils.showNotification('Gagal', 'error'); }
    },

    addRombel: async () => {
        const kelas = document.getElementById('rombel-kelas').value;
        const nama = document.getElementById('rombel-nama').value.trim().toUpperCase();
        if (!nama) { Utils.showNotification('Masukkan nama rombel', 'warning'); return; }

        Utils.showLoading('Menyimpan...');
        try {
            await db.collection(COLLECTIONS.ROMBEL).add({
                userId: Auth.currentUser.uid,
                npsn: Auth.userData.npsn,
                kelas: parseInt(kelas),
                nama: `${kelas}${nama}`,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            Utils.showNotification('Rombel ditambahkan', 'success');
            document.getElementById('rombel-nama').value = '';
            await MasterData.loadRombel();
        } catch (error) { Utils.showNotification('Gagal', 'error'); }
        finally { Utils.hideLoading(); }
    },

    loadRombel: async () => {
        try {
            const snapshot = await db.collection(COLLECTIONS.ROMBEL).where('userId', '==', Auth.currentUser.uid).get();
            MasterData.rombel = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            MasterData.renderRombelList();
        } catch (error) { console.error('Error loading rombel:', error); }
    },

    renderRombelList: () => {
        const container = document.getElementById('my-rombel-list');
        if (!container) return;
        container.innerHTML = MasterData.rombel.length === 0 
            ? '<p class="text-gray-400 text-sm">Belum ada rombel</p>'
            : MasterData.rombel.map(r => `
                <span class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                    ${r.nama}
                    <button onclick="MasterData.deleteRombel('${r.id}')" class="ml-2 hover:text-red-600">‚úï</button>
                </span>
            `).join('');
    },

    deleteRombel: async (id) => {
        if (!(await Utils.confirm('Hapus rombel ini?'))) return;
        try {
            await db.collection(COLLECTIONS.ROMBEL).doc(id).delete();
            Utils.showNotification('Dihapus', 'success');
            await MasterData.loadRombel();
        } catch (error) { Utils.showNotification('Gagal', 'error'); }
    },

    saveCP: async (e) => {
        e.preventDefault();
        const mapelId = document.getElementById('cp-mapel').value;
        const kelas = document.getElementById('cp-kelas').value;
        const elemen = document.getElementById('cp-elemen').value;
        const cpText = document.getElementById('cp-text').value.trim();
        const profilLulusan = Array.from(document.querySelectorAll('input[name="profil-lulusan"]:checked')).map(cb => cb.value);

        if (!mapelId || !kelas || !elemen || !cpText) {
            Utils.showNotification('Lengkapi semua field', 'warning');
            return;
        }

        const subject = MasterData.subjects.find(s => s.id === mapelId);
        Utils.showLoading('Menyimpan...');

        try {
            await db.collection(COLLECTIONS.CP_DATA).add({
                userId: Auth.currentUser.uid,
                npsn: Auth.userData.npsn,
                mapelId, mapelNama: subject.nama,
                kelas: parseInt(kelas), elemen,
                capaianPembelajaran: cpText,
                profilLulusan,
                tahunAjaran: Utils.getTahunAjaran(),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            Utils.showNotification('CP berhasil disimpan', 'success');
            e.target.reset();
            await MasterData.loadCPData();
            App.loadDashboardStats();
        } catch (error) { Utils.showNotification('Gagal: ' + error.message, 'error'); }
        finally { Utils.hideLoading(); }
    },

    loadCPData: async () => {
        try {
            const snapshot = await db.collection(COLLECTIONS.CP_DATA).where('userId', '==', Auth.currentUser.uid).get();
            MasterData.cpData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            MasterData.renderCPList();
        } catch (error) { console.error('Error loading CP:', error); }
    },

    renderCPList: () => {
        const container = document.getElementById('cp-list');
        if (!container) return;
        container.innerHTML = MasterData.cpData.length === 0 
            ? '<p class="text-gray-400 text-center py-8">Belum ada data CP</p>'
            : MasterData.cpData.map(cp => `
                <div class="border rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex flex-wrap gap-2 mb-2">
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">${cp.mapelNama}</span>
                                <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">Kelas ${cp.kelas}</span>
                                <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs">${cp.elemen}</span>
                            </div>
                            <p class="text-gray-700 text-sm">${cp.capaianPembelajaran}</p>
                        </div>
                        <button onclick="MasterData.deleteCP('${cp.id}')" class="text-red-500 hover:text-red-700 ml-4">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
    },

    deleteCP: async (id) => {
        if (!(await Utils.confirm('Hapus CP ini?'))) return;
        try {
            await db.collection(COLLECTIONS.CP_DATA).doc(id).delete();
            Utils.showNotification('Dihapus', 'success');
            await MasterData.loadCPData();
            App.loadDashboardStats();
        } catch (error) { Utils.showNotification('Gagal', 'error'); }
    }
};

// =====================================================
// SIMPLIFIED PLACEHOLDER MODULES
// =====================================================
const AtpKktp = {
    init: async () => {
        document.getElementById('tab-atp').innerHTML = `<div class="bg-white rounded-xl shadow p-6"><h3 class="text-lg font-semibold mb-4">üéØ Alur Tujuan Pembelajaran (ATP)</h3><p class="text-gray-500">Tambahkan CP dan Rombel terlebih dahulu di Master Data.</p></div>`;
        document.getElementById('tab-kktp').innerHTML = `<div class="bg-white rounded-xl shadow p-6"><h3 class="text-lg font-semibold mb-4">‚úÖ KKTP</h3><p class="text-gray-500">Buat ATP terlebih dahulu untuk membuat KKTP.</p></div>`;
    }
};

const CalendarSchedule = {
    init: async () => {
        document.getElementById('tab-calendar').innerHTML = `<div class="bg-white rounded-xl shadow p-6"><h3 class="text-lg font-semibold mb-4">üìÖ Kalender Pendidikan</h3><p class="text-gray-500">Kalender pendidikan kolaboratif (NPSN: ${Auth.userData?.npsn || '-'}).</p></div>`;
        document.getElementById('tab-schedule').innerHTML = `<div class="bg-white rounded-xl shadow p-6"><h3 class="text-lg font-semibold mb-4">üïê Jadwal Pelajaran</h3><p class="text-gray-500">Kelola jadwal dengan validasi anti-bentrok.</p></div>`;
    }
};

const ProtaPromes = {
    init: async () => {
        document.getElementById('tab-prota').innerHTML = `<div class="bg-white rounded-xl shadow p-6"><h3 class="text-lg font-semibold mb-4">üìã Program Tahunan</h3><p class="text-gray-500">Buat Prota per mata pelajaran dan rombel.</p></div>`;
        document.getElementById('tab-promes').innerHTML = `<div class="bg-white rounded-xl shadow p-6"><h3 class="text-lg font-semibold mb-4">üìÜ Program Semester</h3><p class="text-gray-500">Distribusi materi ke minggu pembelajaran.</p></div>`;
    }
};

const ModulAjar = {
    init: async () => {
        document.getElementById('tab-modul').innerHTML = `<div class="bg-white rounded-xl shadow p-6"><h3 class="text-lg font-semibold mb-4">üìö Modul Ajar</h3><p class="text-gray-500">Buat modul ajar dengan format Kurikulum Merdeka.</p></div>`;
    }
};

const BankSoal = {
    init: async () => {
        document.getElementById('tab-bank-soal').innerHTML = `<div class="bg-white rounded-xl shadow p-6"><h3 class="text-lg font-semibold mb-4">‚ùì Bank Soal</h3><p class="text-gray-500">Kelola bank soal dengan berbagai tipe.</p></div>`;
    }
};

// =====================================================
// INITIALIZE
// =====================================================
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM Loaded, initializing Auth...');
    Auth.init();
});
    </script>
</body>
</html>
