<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Guru Super App</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        secondary: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        arabic: ['Amiri', 'serif']
                    }
                }
            }
        }
    </script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Custom Styles */
        body {
            font-family: 'Inter', system-ui, sans-serif;
        }
        
        .rtl-text {
            direction: rtl;
            font-family: 'Amiri', serif;
            text-align: right;
        }
        
        /* Sidebar */
        .sidebar {
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
        }
        
        .sidebar.collapsed {
            transform: translateX(-100%);
        }
        
        @media (min-width: 1024px) {
            .sidebar.collapsed {
                transform: translateX(0);
                width: 5rem;
            }
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast Notifications */
        .toast {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block !important;
            }
            
            body {
                font-size: 11pt;
            }
            
            .print-page {
                page-break-after: always;
            }
        }
        
        /* Tooltips */
        .tooltip {
            position: relative;
        }
        
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 50;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* Table Styles */
        .table-auto-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- ==================== LOGIN SCREEN ==================== -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-primary-500 to-primary-700 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md text-center">
            <!-- Logo -->
            <div class="mb-6">
                <div class="w-20 h-20 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-chalkboard-teacher text-3xl text-primary-600"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Admin Guru Super App</h1>
                <p class="text-gray-500 mt-2">Single Input ‚Üí Multi Output System</p>
            </div>
            
            <!-- Features Preview -->
            <div class="bg-gray-50 rounded-xl p-4 mb-6">
                <div class="grid grid-cols-4 gap-2 text-xs text-gray-600">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-calendar-alt text-primary-500 mb-1"></i>
                        <span>Kalender</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <i class="fas fa-book text-primary-500 mb-1"></i>
                        <span>ATP</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <i class="fas fa-tasks text-primary-500 mb-1"></i>
                        <span>Promes</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <i class="fas fa-file-alt text-primary-500 mb-1"></i>
                        <span>Modul</span>
                    </div>
                </div>
            </div>
            
            <!-- Login Button -->
            <button id="btnGoogleLogin" class="w-full bg-white border-2 border-gray-200 hover:border-primary-500 text-gray-700 font-medium py-3 px-6 rounded-xl flex items-center justify-center gap-3 transition-all duration-200 hover:shadow-lg">
                <img src="https://www.google.com/favicon.ico" alt="Google" class="w-5 h-5">
                <span>Masuk dengan Google</span>
            </button>
            
            <!-- Loading State -->
            <div id="loginLoading" class="hidden mt-4">
                <div class="spinner mx-auto"></div>
                <p class="text-gray-500 text-sm mt-2">Memproses login...</p>
            </div>
            
            <!-- Footer -->
            <p class="text-xs text-gray-400 mt-6">
                Khusus untuk guru Indonesia üáÆüá©
            </p>
        </div>
    </div>
    
    <!-- ==================== MAIN APP ==================== -->
    <div id="mainApp" class="hidden">
        
        <!-- Mobile Header -->
        <header class="lg:hidden fixed top-0 left-0 right-0 bg-white shadow-sm z-40 no-print">
            <div class="flex items-center justify-between p-4">
                <button id="btnToggleSidebar" class="p-2 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-bars text-gray-600"></i>
                </button>
                <h1 class="font-semibold text-gray-800">Admin Guru</h1>
                <button id="btnMobileProfile" class="p-2">
                    <img id="mobileUserPhoto" src="" alt="User" class="w-8 h-8 rounded-full">
                </button>
            </div>
        </header>
        
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar fixed left-0 top-0 h-full w-64 bg-white shadow-lg z-50 lg:translate-x-0 -translate-x-full no-print">
            <!-- Sidebar Header -->
            <div class="p-4 border-b">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-primary-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chalkboard-teacher text-primary-600"></i>
                    </div>
                    <div class="sidebar-text">
                        <h2 class="font-bold text-gray-800">AGSA</h2>
                        <p class="text-xs text-gray-500">Admin Guru Super App</p>
                    </div>
                </div>
            </div>
            
            <!-- User Info -->
            <div class="p-4 border-b bg-gray-50">
                <div class="flex items-center gap-3">
                    <img id="sidebarUserPhoto" src="" alt="User" class="w-10 h-10 rounded-full">
                    <div class="sidebar-text overflow-hidden">
                        <p id="sidebarUserName" class="font-medium text-gray-800 truncate"></p>
                        <span id="sidebarUserPlan" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-200 text-gray-700">
                            Free
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Navigation -->
            <nav class="p-4 overflow-y-auto" style="height: calc(100% - 200px);">
                <ul class="space-y-1">
                    <!-- Dashboard -->
                    <li>
                        <a href="#" data-page="dashboard" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-home w-5 text-center"></i>
                            <span class="sidebar-text">Dashboard</span>
                        </a>
                    </li>
                    
                    <!-- Input Data Section -->
                    <li class="pt-4">
                        <p class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider sidebar-text">Input Data</p>
                    </li>
                    <li>
                        <a href="#" data-page="profile" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-user-circle w-5 text-center"></i>
                            <span class="sidebar-text">Profil & Sekolah</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="calendar" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-calendar-alt w-5 text-center"></i>
                            <span class="sidebar-text">Kalender Pendidikan</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="schedule" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-clock w-5 text-center"></i>
                            <span class="sidebar-text">Jadwal Pelajaran</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="students" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-users w-5 text-center"></i>
                            <span class="sidebar-text">Data Siswa</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="cp-database" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-database w-5 text-center"></i>
                            <span class="sidebar-text">Database CP</span>
                        </a>
                    </li>
                    
                    <!-- Generated Docs Section -->
                    <li class="pt-4">
                        <p class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider sidebar-text">Dokumen Otomatis</p>
                    </li>
                    <li>
                        <a href="#" data-page="atp" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-route w-5 text-center"></i>
                            <span class="sidebar-text">ATP</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="prota" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-calendar-check w-5 text-center"></i>
                            <span class="sidebar-text">Prota</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="promes" class="nav-link premium-feature flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-tasks w-5 text-center"></i>
                            <span class="sidebar-text">Promes</span>
                            <i class="fas fa-crown text-yellow-500 text-xs sidebar-text"></i>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="modul-ajar" class="nav-link premium-feature flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-book-open w-5 text-center"></i>
                            <span class="sidebar-text">Modul Ajar</span>
                            <i class="fas fa-crown text-yellow-500 text-xs sidebar-text"></i>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="jurnal" class="nav-link premium-feature flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-journal-whills w-5 text-center"></i>
                            <span class="sidebar-text">Jurnal</span>
                            <i class="fas fa-crown text-yellow-500 text-xs sidebar-text"></i>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="kktp" class="nav-link premium-feature flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-check-double w-5 text-center"></i>
                            <span class="sidebar-text">KKTP</span>
                            <i class="fas fa-crown text-yellow-500 text-xs sidebar-text"></i>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="nilai" class="nav-link premium-feature flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-star w-5 text-center"></i>
                            <span class="sidebar-text">Daftar Nilai</span>
                            <i class="fas fa-crown text-yellow-500 text-xs sidebar-text"></i>
                        </a>
                    </li>
                    
                    <!-- Tools Section -->
                    <li class="pt-4">
                        <p class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider sidebar-text">Tools</p>
                    </li>
                    <li>
                        <a href="#" data-page="ai-assistant" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-robot w-5 text-center"></i>
                            <span class="sidebar-text">AI Assistant</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="subscription" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-crown w-5 text-center text-yellow-500"></i>
                            <span class="sidebar-text">Upgrade Premium</span>
                        </a>
                    </li>
                    
                    <!-- Admin Section (Hidden by default) -->
                    <li id="adminMenuSection" class="hidden pt-4">
                        <p class="px-3 text-xs font-semibold text-red-400 uppercase tracking-wider sidebar-text">Super Admin</p>
                    </li>
                    <li id="adminMenuLink" class="hidden">
                        <a href="#" data-page="admin" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-red-600 hover:bg-red-50 transition-colors">
                            <i class="fas fa-shield-alt w-5 text-center"></i>
                            <span class="sidebar-text">Panel Admin</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <!-- Sidebar Footer -->
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t bg-white">
                <button id="btnLogout" class="w-full flex items-center justify-center gap-2 px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="sidebar-text">Keluar</span>
                </button>
            </div>
        </aside>
        
        <!-- Sidebar Overlay (Mobile) -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>
        
        <!-- Main Content -->
        <main id="mainContent" class="lg:ml-64 min-h-screen pt-16 lg:pt-0">
            <!-- Page content will be injected here -->
        </main>
        
    </div>
    
    <!-- ==================== PAGE TEMPLATES ==================== -->
    
    <!-- Dashboard Template -->
    <template id="tplDashboard">
        <div class="p-4 lg:p-8">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Selamat Datang, <span id="dashboardUserName"></span>! üëã</h1>
                <p class="text-gray-500 mt-1">Kelola administrasi pembelajaran Anda dengan mudah</p>
            </div>
            
            <!-- Quick Stats -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-users text-blue-600"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-gray-800" id="statStudents">0</p>
                            <p class="text-xs text-gray-500">Total Siswa</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-book text-green-600"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-gray-800" id="statClasses">0</p>
                            <p class="text-xs text-gray-500">Kelas Diampu</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-file-alt text-purple-600"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-gray-800" id="statDocs">0</p>
                            <p class="text-xs text-gray-500">Dokumen</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calendar text-yellow-600"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-gray-800" id="statWeeks">0</p>
                            <p class="text-xs text-gray-500">Minggu Efektif</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Mulai dari Sini</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="quick-action-card p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-primary-400 hover:bg-primary-50 cursor-pointer transition-all" data-action="profile">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-primary-100 rounded-xl flex items-center justify-center">
                                <span class="text-xl">1Ô∏è‚É£</span>
                            </div>
                            <div>
                                <h3 class="font-medium text-gray-800">Lengkapi Profil</h3>
                                <p class="text-sm text-gray-500">Data guru & sekolah</p>
                            </div>
                        </div>
                    </div>
                    <div class="quick-action-card p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-primary-400 hover:bg-primary-50 cursor-pointer transition-all" data-action="calendar">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-primary-100 rounded-xl flex items-center justify-center">
                                <span class="text-xl">2Ô∏è‚É£</span>
                            </div>
                            <div>
                                <h3 class="font-medium text-gray-800">Atur Kalender</h3>
                                <p class="text-sm text-gray-500">Kalender pendidikan</p>
                            </div>
                        </div>
                    </div>
                    <div class="quick-action-card p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-primary-400 hover:bg-primary-50 cursor-pointer transition-all" data-action="schedule">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-primary-100 rounded-xl flex items-center justify-center">
                                <span class="text-xl">3Ô∏è‚É£</span>
                            </div>
                            <div>
                                <h3 class="font-medium text-gray-800">Input Jadwal</h3>
                                <p class="text-sm text-gray-500">Jadwal mengajar</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sync Status -->
            <div class="bg-gradient-to-r from-primary-500 to-primary-600 rounded-xl p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-semibold mb-1">Sistem Sinkronisasi Otomatis</h2>
                        <p class="text-primary-100 text-sm">Semua dokumen saling terhubung secara real-time</p>
                    </div>
                    <div class="hidden lg:flex items-center gap-2">
                        <div class="flex items-center gap-1 bg-white/20 px-3 py-1 rounded-full text-sm">
                            <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                            <span>Live Sync</span>
                        </div>
                    </div>
                </div>
                <div class="mt-4 grid grid-cols-4 lg:grid-cols-8 gap-2 text-center text-xs">
                    <div class="bg-white/10 rounded-lg p-2">
                        <i class="fas fa-route mb-1"></i>
                        <p>ATP</p>
                    </div>
                    <div class="bg-white/10 rounded-lg p-2">
                        <i class="fas fa-arrow-right mb-1"></i>
                        <p></p>
                    </div>
                    <div class="bg-white/10 rounded-lg p-2">
                        <i class="fas fa-calendar-check mb-1"></i>
                        <p>Prota</p>
                    </div>
                    <div class="bg-white/10 rounded-lg p-2">
                        <i class="fas fa-arrow-right mb-1"></i>
                        <p></p>
                    </div>
                    <div class="bg-white/10 rounded-lg p-2">
                        <i class="fas fa-tasks mb-1"></i>
                        <p>Promes</p>
                    </div>
                    <div class="bg-white/10 rounded-lg p-2">
                        <i class="fas fa-arrow-right mb-1"></i>
                        <p></p>
                    </div>
                    <div class="bg-white/10 rounded-lg p-2">
                        <i class="fas fa-book-open mb-1"></i>
                        <p>Modul</p>
                    </div>
                    <div class="bg-white/10 rounded-lg p-2">
                        <i class="fas fa-arrow-right mb-1"></i>
                        <p></p>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Profile Template -->
    <template id="tplProfile">
        <div class="p-4 lg:p-8 max-w-4xl mx-auto">
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Profil & Data Sekolah</h1>
                <p class="text-gray-500">Lengkapi data berikut untuk generate dokumen otomatis</p>
            </div>
            
            <form id="formProfile" class="space-y-6">
                <!-- Tahun Ajar -->
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-calendar-alt text-primary-500"></i>
                        Tahun Ajar
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tahun Awal</label>
                            <input type="number" id="tahunAjarAwal" name="tahunAjarAwal" min="2020" max="2030" placeholder="2024" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" required>
                            <p class="text-xs text-gray-500 mt-1">Sistem akan otomatis format menjadi "2024/2025"</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Preview</label>
                            <div id="tahunAjarPreview" class="px-4 py-2 bg-gray-100 rounded-lg text-gray-800 font-medium">
                                -
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Data Guru -->
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-user text-primary-500"></i>
                        Data Guru
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap Guru</label>
                            <input type="text" id="namaGuru" name="namaGuru" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">NIP Guru</label>
                            <input type="text" id="nipGuru" name="nipGuru" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Link Tanda Tangan Guru (URL Gambar)</label>
                            <input type="url" id="linkTTDGuru" name="linkTTDGuru" placeholder="https://..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">Upload gambar ke Google Drive, ubah akses jadi publik, lalu paste link-nya</p>
                        </div>
                    </div>
                </div>
                
                <!-- Data Kepala Sekolah -->
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-user-tie text-primary-500"></i>
                        Data Kepala Sekolah
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kepala Sekolah</label>
                            <input type="text" id="namaKepalaSekolah" name="namaKepalaSekolah" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">NIP Kepala Sekolah</label>
                            <input type="text" id="nipKepalaSekolah" name="nipKepalaSekolah" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Link Tanda Tangan Kepala Sekolah (URL Gambar)</label>
                            <input type="url" id="linkTTDKepsek" name="linkTTDKepsek" placeholder="https://..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        </div>
                    </div>
                </div>
                
                <!-- Data Sekolah -->
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-school text-primary-500"></i>
                        Data Satuan Pendidikan
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Satuan Pendidikan</label>
                            <input type="text" id="namaSatuan" name="namaSatuan" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">NPSN</label>
                            <input type="text" id="npsn" name="npsn" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Jenjang</label>
                            <select id="jenjang" name="jenjang" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" required>
                                <option value="">Pilih Jenjang</option>
                                <option value="SD">SD</option>
                                <option value="SMP">SMP</option>
                                <option value="SMA">SMA</option>
                                <option value="SMK">SMK</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Alamat</label>
                            <textarea id="alamat" name="alamat" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kabupaten/Kota</label>
                            <input type="text" id="kabupaten" name="kabupaten" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Provinsi</label>
                            <input type="text" id="provinsi" name="provinsi" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Pengesahan Dokumen</label>
                            <input type="date" id="tanggalPengesahan" name="tanggalPengesahan" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Link Logo Sekolah (URL Gambar)</label>
                            <input type="url" id="linkLogo" name="linkLogo" placeholder="https://..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        </div>
                    </div>
                </div>
                
                <!-- Submit Button -->
                <div class="flex justify-end gap-3">
                    <button type="submit" class="px-6 py-2.5 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center gap-2">
                        <i class="fas fa-save"></i>
                        <span>Simpan Profil</span>
                    </button>
                </div>
            </form>
        </div>
    </template>
    
    <!-- Calendar Template -->
    <template id="tplCalendar">
        <div class="p-4 lg:p-8">
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Kalender Pendidikan</h1>
                <p class="text-gray-500">Atur hari libur dan minggu efektif</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Semester Settings -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Semester Ganjil -->
                    <div class="bg-white rounded-xl shadow-sm border p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-calendar text-blue-500"></i>
                            Semester Ganjil
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai</label>
                                <input type="date" id="semGanjilMulai" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Selesai</label>
                                <input type="date" id="semGanjilSelesai" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-800">
                                <i class="fas fa-info-circle mr-1"></i>
                                Minggu Efektif: <strong id="mingguEfektifGanjil">0</strong> minggu
                            </p>
                        </div>
                    </div>
                    
                    <!-- Semester Genap -->
                    <div class="bg-white rounded-xl shadow-sm border p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-calendar text-green-500"></i>
                            Semester Genap
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai</label>
                                <input type="date" id="semGenapMulai" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Selesai</label>
                                <input type="date" id="semGenapSelesai" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-green-50 rounded-lg">
                            <p class="text-sm text-green-800">
                                <i class="fas fa-info-circle mr-1"></i>
                                Minggu Efektif: <strong id="mingguEfektifGenap">0</strong> minggu
                            </p>
                        </div>
                    </div>
                    
                    <!-- Kelas Akhir -->
                    <div class="bg-white rounded-xl shadow-sm border p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-graduation-cap text-yellow-500"></i>
                            Kelas Akhir (6, 9, 12)
                        </h2>
                        <p class="text-sm text-gray-500 mb-4">Semester genap lebih cepat untuk persiapan kelulusan</p>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Selesai Sem. Genap Kelas Akhir</label>
                            <input type="date" id="kelasAkhirSelesai" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                        </div>
                    </div>
                </div>
                
                <!-- Holidays Section -->
                <div class="space-y-6">
                    <!-- Hari Libur Nasional -->
                    <div class="bg-white rounded-xl shadow-sm border p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-flag text-red-500"></i>
                            Libur Nasional
                        </h2>
                        <div id="liburNasionalList" class="space-y-2 max-h-60 overflow-y-auto">
                            <!-- Will be populated -->
                        </div>
                        <p class="text-xs text-gray-500 mt-3">
                            <i class="fas fa-info-circle"></i> Data libur nasional terisi otomatis
                        </p>
                    </div>
                    
                    <!-- Hari Libur Lokal -->
                    <div class="bg-white rounded-xl shadow-sm border p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-calendar-times text-orange-500"></i>
                            Libur Lokal/Khusus
                        </h2>
                        <div id="liburLokalList" class="space-y-2 max-h-40 overflow-y-auto mb-4">
                            <!-- Will be populated -->
                        </div>
                        <button type="button" id="btnAddLiburLokal" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-primary-400 hover:text-primary-600 transition-colors">
                            <i class="fas fa-plus mr-1"></i> Tambah Libur
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Save Button -->
            <div class="mt-6 flex justify-end">
                <button id="btnSaveCalendar" class="px-6 py-2.5 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center gap-2">
                    <i class="fas fa-save"></i>
                    <span>Simpan Kalender</span>
                </button>
            </div>
        </div>
    </template>
    
    <!-- Schedule Template -->
    <template id="tplSchedule">
        <div class="p-4 lg:p-8">
            <div class="mb-6 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Jadwal Pelajaran</h1>
                    <p class="text-gray-500">Atur jadwal mengajar dengan validasi anti-bentrok</p>
                </div>
                <div class="flex items-center gap-3">
                    <select id="selectSemesterSchedule" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                        <option value="1">Semester Ganjil</option>
                        <option value="2">Semester Genap</option>
                    </select>
                </div>
            </div>
            
            <!-- Duration Settings -->
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Pengaturan Waktu</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Durasi Per Jam (menit)</label>
                        <input type="number" id="durasiJam" value="35" min="25" max="60" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jam Mulai</label>
                        <input type="time" id="jamMulai" value="07:00" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Jam Per Hari</label>
                        <input type="number" id="jumlahJam" value="8" min="4" max="12" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                    </div>
                </div>
            </div>
            
            <!-- Schedule Table -->
            <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                <div class="p-4 border-b flex items-center justify-between">
                    <h2 class="font-semibold text-gray-800">Jadwal Mingguan</h2>
                    <button id="btnAddScheduleEntry" class="px-4 py-2 bg-primary-600 text-white text-sm rounded-lg hover:bg-primary-700 transition-colors">
                        <i class="fas fa-plus mr-1"></i> Tambah Jadwal
                    </button>
                </div>
                <div class="table-auto-scroll">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hari</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jam Ke</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Waktu</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kelas</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mapel</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTableBody" class="divide-y divide-gray-200">
                            <!-- Will be populated -->
                        </tbody>
                    </table>
                </div>
                <div id="scheduleEmpty" class="p-8 text-center text-gray-500">
                    <i class="fas fa-calendar-plus text-4xl mb-3"></i>
                    <p>Belum ada jadwal. Klik "Tambah Jadwal" untuk memulai.</p>
                </div>
            </div>
            
            <!-- Conflict Warning -->
            <div id="conflictWarning" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-xl">
                <div class="flex items-center gap-2 text-red-800">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span class="font-medium">Peringatan Konflik!</span>
                </div>
                <p id="conflictMessage" class="text-sm text-red-600 mt-1"></p>
            </div>
            
            <!-- Save Button -->
            <div class="mt-6 flex justify-end">
                <button id="btnSaveSchedule" class="px-6 py-2.5 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center gap-2">
                    <i class="fas fa-save"></i>
                    <span>Simpan Jadwal</span>
                </button>
            </div>
        </div>
    </template>
    
    <!-- CP Database Template -->
    <template id="tplCPDatabase">
        <div class="p-4 lg:p-8">
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Database Capaian Pembelajaran (CP)</h1>
                <p class="text-gray-500">Kelola CP berdasarkan jenjang dan mata pelajaran</p>
            </div>
            
            <!-- Filter Section -->
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenjang</label>
                        <select id="cpFilterJenjang" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="">Pilih Jenjang</option>
                            <option value="SD">SD (Kelas 1-6)</option>
                            <option value="SMP">SMP (Kelas 7-9)</option>
                            <option value="SMA">SMA (Kelas 10-12)</option>
                            <option value="SMK">SMK (Kelas 10-12)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mata Pelajaran</label>
                        <select id="cpFilterMapel" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500" disabled>
                            <option value="">Pilih Jenjang Dulu</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                        <select id="cpFilterKelas" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500" disabled>
                            <option value="">Semua Kelas</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnLoadCP" class="w-full px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                            <i class="fas fa-download mr-1"></i> Muat CP
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Loading State -->
            <div id="cpLoading" class="hidden text-center py-12">
                <div class="spinner mx-auto mb-4"></div>
                <p class="text-gray-500">Memuat data CP...</p>
            </div>
            
            <!-- CP Table -->
            <div id="cpTableContainer" class="hidden bg-white rounded-xl shadow-sm border overflow-hidden">
                <div class="p-4 border-b flex items-center justify-between">
                    <h2 class="font-semibold text-gray-800">Data CP</h2>
                    <span id="cpCount" class="text-sm text-gray-500"></span>
                </div>
                <div class="table-auto-scroll">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fase</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kelas</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sem</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Elemen</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase" style="min-width: 300px;">CP</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase" style="min-width: 300px;">TP</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dimensi</th>
                            </tr>
                        </thead>
                        <tbody id="cpTableBody" class="divide-y divide-gray-200">
                            <!-- Will be populated -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Custom CP Section -->
            <div class="mt-6 bg-white rounded-xl shadow-sm border p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-edit text-primary-500"></i>
                    Custom CP (Paste CSV)
                </h2>
                <p class="text-sm text-gray-500 mb-4">
                    Format: <code class="bg-gray-100 px-2 py-1 rounded">Mata Pelajaran;Fase;Kelas;Semester;Elemen/Bab;CP Panjang;TP;8 Dimensi Profil Lulusan</code>
                </p>
                <textarea id="customCPInput" rows="6" class="w-full px-4 py-2 border rounded-lg font-mono text-sm focus:ring-2 focus:ring-primary-500" placeholder="Paste data CSV di sini..."></textarea>
                <div class="mt-4 flex justify-end">
                    <button id="btnImportCustomCP" class="px-4 py-2 bg-secondary-600 text-white rounded-lg hover:bg-secondary-700 transition-colors">
                        <i class="fas fa-file-import mr-1"></i> Import Custom CP
                    </button>
                </div>
            </div>
        </div>
    </template>
    
    <!-- ATP Template -->
    <template id="tplATP">
        <div class="p-4 lg:p-8">
            <div class="mb-6 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Alur Tujuan Pembelajaran (ATP)</h1>
                    <p class="text-gray-500">Generate ATP otomatis dari database CP</p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="btnGenerateATP" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                        <i class="fas fa-magic mr-1"></i> Generate ATP
                    </button>
                    <button id="btnPrintATP" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        <i class="fas fa-print mr-1"></i> Cetak
                    </button>
                </div>
            </div>
            
            <!-- Filter -->
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mata Pelajaran</label>
                        <select id="atpFilterMapel" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="">Pilih Mapel</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                        <select id="atpFilterKelas" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="">Pilih Kelas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fase</label>
                        <select id="atpFilterFase" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="">Auto dari Kelas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tahun Ajar</label>
                        <input type="text" id="atpTahunAjar" class="w-full px-4 py-2 border rounded-lg bg-gray-100" readonly>
                    </div>
                </div>
            </div>
            
            <!-- ATP Content -->
            <div id="atpContent" class="bg-white rounded-xl shadow-sm border overflow-hidden">
                <div class="p-4 border-b">
                    <h2 class="font-semibold text-gray-800">Data ATP</h2>
                </div>
                <div id="atpEmpty" class="p-12 text-center text-gray-500">
                    <i class="fas fa-route text-4xl mb-3"></i>
                    <p>Pilih filter di atas lalu klik "Generate ATP"</p>
                </div>
                <div id="atpTableContainer" class="hidden table-auto-scroll">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sem</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Elemen</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase" style="min-width: 300px;">Capaian Pembelajaran</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase" style="min-width: 300px;">Tujuan Pembelajaran</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">JP</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dimensi P5</th>
                            </tr>
                        </thead>
                        <tbody id="atpTableBody" class="divide-y divide-gray-200">
                            <!-- Will be populated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Promes Template (Premium) -->
    <template id="tplPromes">
        <div class="p-4 lg:p-8">
            <div class="mb-6 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Program Semester (Promes)</h1>
                    <p class="text-gray-500">Sinkronisasi otomatis dengan Prota, Kalender & Jadwal</p>
                </div>
                <div class="flex items-center gap-3">
                    <select id="selectSemesterPromes" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                        <option value="1">Semester Ganjil</option>
                        <option value="2">Semester Genap</option>
                    </select>
                    <button id="btnGeneratePromes" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                        <i class="fas fa-sync mr-1"></i> Sync & Generate
                    </button>
                    <button id="btnPrintPromes" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        <i class="fas fa-print mr-1"></i> Cetak
                    </button>
                </div>
            </div>
            
            <!-- Summary Cards -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-xl p-4 shadow-sm border">
                    <p class="text-sm text-gray-500">Minggu Efektif</p>
                    <p class="text-2xl font-bold text-primary-600" id="promesMingguEfektif">0</p>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border">
                    <p class="text-sm text-gray-500">Total JP</p>
                    <p class="text-2xl font-bold text-green-600" id="promesTotalJP">0</p>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border">
                    <p class="text-sm text-gray-500">JP Terpakai</p>
                    <p class="text-2xl font-bold text-blue-600" id="promesJPTerpakai">0</p>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border">
                    <p class="text-sm text-gray-500">JP Sisa</p>
                    <p class="text-2xl font-bold text-yellow-600" id="promesJPSisa">0</p>
                </div>
            </div>
            
            <!-- Promes Table -->
            <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                <div class="p-4 border-b flex items-center justify-between">
                    <h2 class="font-semibold text-gray-800">Detail Mingguan</h2>
                    <span class="text-sm text-gray-500">Auto-sync dengan jadwal & kalender</span>
                </div>
                <div class="table-auto-scroll">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Minggu</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hari Efektif</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">JP</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase" style="min-width: 200px;">Materi/TP</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kegiatan</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Keterangan</th>
                            </tr>
                        </thead>
                        <tbody id="promesTableBody" class="divide-y divide-gray-200">
                            <!-- Will be populated -->
                        </tbody>
                    </table>
                </div>
                <div id="promesEmpty" class="p-12 text-center text-gray-500">
                    <i class="fas fa-tasks text-4xl mb-3"></i>
                    <p>Klik "Sync & Generate" untuk membuat Promes otomatis</p>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Subscription Template -->
    <template id="tplSubscription">
        <div class="p-4 lg:p-8 max-w-4xl mx-auto">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-gray-800">Upgrade ke Premium</h1>
                <p class="text-gray-500 mt-2">Akses semua fitur untuk administrasi yang lebih lengkap</p>
            </div>
            
            <!-- Plans -->
            <div class="grid md:grid-cols-2 gap-6 mb-8">
                <!-- Free Plan -->
                <div class="bg-white rounded-2xl shadow-sm border-2 border-gray-200 p-6">
                    <div class="text-center mb-6">
                        <span class="inline-block px-3 py-1 bg-gray-100 text-gray-600 text-sm font-medium rounded-full mb-3">Free</span>
                        <p class="text-3xl font-bold text-gray-800">Rp 0</p>
                        <p class="text-gray-500 text-sm">Selamanya</p>
                    </div>
                    <ul class="space-y-3 mb-6">
                        <li class="flex items-center gap-2 text-gray-600">
                            <i class="fas fa-check text-green-500"></i>
                            <span>Kalender Pendidikan</span>
                        </li>
                        <li class="flex items-center gap-2 text-gray-600">
                            <i class="fas fa-check text-green-500"></i>
                            <span>Jadwal Pelajaran</span>
                        </li>
                        <li class="flex items-center gap-2 text-gray-600">
                            <i class="fas fa-check text-green-500"></i>
                            <span>ATP Generator</span>
                        </li>
                        <li class="flex items-center gap-2 text-gray-600">
                            <i class="fas fa-check text-green-500"></i>
                            <span>Prota Generator</span>
                        </li>
                        <li class="flex items-center gap-2 text-gray-400">
                            <i class="fas fa-times"></i>
                            <span>Promes (Premium)</span>
                        </li>
                        <li class="flex items-center gap-2 text-gray-400">
                            <i class="fas fa-times"></i>
                            <span>Modul Ajar (Premium)</span>
                        </li>
                        <li class="flex items-center gap-2 text-gray-400">
                            <i class="fas fa-times"></i>
                            <span>Jurnal Otomatis (Premium)</span>
                        </li>
                    </ul>
                    <button class="w-full py-3 bg-gray-100 text-gray-500 rounded-xl font-medium" disabled>
                        Paket Aktif
                    </button>
                </div>
                
                <!-- Premium Plan -->
                <div class="bg-gradient-to-br from-primary-500 to-primary-600 rounded-2xl shadow-lg p-6 text-white relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
                    <div class="text-center mb-6 relative">
                        <span class="inline-block px-3 py-1 bg-white/20 text-white text-sm font-medium rounded-full mb-3">
                            <i class="fas fa-crown mr-1"></i> Premium
                        </span>
                        <p class="text-3xl font-bold">Rp <span id="premiumPrice">99.000</span></p>
                        <p class="text-primary-100 text-sm">Per tahun</p>
                    </div>
                    <ul class="space-y-3 mb-6 relative">
                        <li class="flex items-center gap-2">
                            <i class="fas fa-check"></i>
                            <span>Semua fitur Free</span>
                        </li>
                        <li class="flex items-center gap-2">
                            <i class="fas fa-check"></i>
                            <span>Promes + Auto Sync</span>
                        </li>
                        <li class="flex items-center gap-2">
                            <i class="fas fa-check"></i>
                            <span>Modul Ajar + LKPD</span>
                        </li>
                        <li class="flex items-center gap-2">
                            <i class="fas fa-check"></i>
                            <span>Jurnal Otomatis</span>
                        </li>
                        <li class="flex items-center gap-2">
                            <i class="fas fa-check"></i>
                            <span>KKTP Management</span>
                        </li>
                        <li class="flex items-center gap-2">
                            <i class="fas fa-check"></i>
                            <span>Daftar Nilai + Rapor</span>
                        </li>
                        <li class="flex items-center gap-2">
                            <i class="fas fa-check"></i>
                            <span>TTD Otomatis</span>
                        </li>
                        <li class="flex items-center gap-2">
                            <i class="fas fa-check"></i>
                            <span>Support Prioritas</span>
                        </li>
                    </ul>
                    <button id="btnUpgradePremium" class="w-full py-3 bg-white text-primary-600 rounded-xl font-medium hover:bg-primary-50 transition-colors">
                        <i class="fab fa-whatsapp mr-2"></i> Upgrade via WhatsApp
                    </button>
                </div>
            </div>
            
            <!-- School Package -->
            <div class="bg-white rounded-2xl shadow-sm border p-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                            <i class="fas fa-school text-primary-500"></i>
                            Paket Sekolah
                        </h3>
                        <p class="text-gray-500 text-sm mt-1">Untuk semua guru di satu sekolah dengan harga spesial</p>
                    </div>
                    <button id="btnSchoolPackage" class="px-6 py-2.5 bg-secondary-600 text-white rounded-lg hover:bg-secondary-700 transition-colors">
                        <i class="fab fa-whatsapp mr-2"></i> Hubungi Kami
                    </button>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Admin Panel Template -->
    <template id="tplAdmin">
        <div class="p-4 lg:p-8">
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-shield-alt text-red-500"></i>
                    Super Admin Panel
                </h1>
                <p class="text-gray-500">Kelola subscription dan pengaturan sistem</p>
            </div>
            
            <!-- Admin Stats -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-xl p-4 shadow-sm border">
                    <p class="text-sm text-gray-500">Total Users</p>
                    <p class="text-2xl font-bold text-gray-800" id="adminStatUsers">0</p>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border">
                    <p class="text-sm text-gray-500">Premium Users</p>
                    <p class="text-2xl font-bold text-primary-600" id="adminStatPremium">0</p>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border">
                    <p class="text-sm text-gray-500">School Packages</p>
                    <p class="text-2xl font-bold text-secondary-600" id="adminStatSchools">0</p>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border">
                    <p class="text-sm text-gray-500">This Month</p>
                    <p class="text-2xl font-bold text-green-600" id="adminStatMonth">0</p>
                </div>
            </div>
            
            <!-- Settings -->
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Pengaturan</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nomor WhatsApp</label>
                        <input type="text" id="adminWANumber" placeholder="628xxx" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pesan Default</label>
                        <input type="text" id="adminWAMessage" placeholder="Halo, saya ingin upgrade..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Harga Premium Personal (Rp)</label>
                        <input type="number" id="adminPricePersonal" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Harga Premium Sekolah (Rp)</label>
                        <input type="number" id="adminPriceSchool" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="btnSaveAdminSettings" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                        <i class="fas fa-save mr-1"></i> Simpan Pengaturan
                    </button>
                </div>
            </div>
            
            <!-- Manual Subscription -->
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Aktivasi Premium Manual</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email User</label>
                        <input type="email" id="adminActivateEmail" placeholder="user@email.com" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipe</label>
                        <select id="adminActivateType" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="personal">Personal</option>
                            <option value="school">Sekolah</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Durasi</label>
                        <select id="adminActivateDuration" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="30">1 Bulan</option>
                            <option value="180">6 Bulan</option>
                            <option value="365">1 Tahun</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="btnActivatePremium" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-check-circle mr-1"></i> Aktivasi Premium
                    </button>
                </div>
            </div>
            
            <!-- Recent Subscriptions -->
            <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                <div class="p-4 border-b">
                    <h2 class="font-semibold text-gray-800">Subscription Terbaru</h2>
                </div>
                <div class="table-auto-scroll">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipe</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mulai</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Selesai</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody id="adminSubscriptionTable" class="divide-y divide-gray-200">
                            <!-- Will be populated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>
    
    <!-- AI Assistant Template -->
    <template id="tplAIAssistant">
        <div class="p-4 lg:p-8 max-w-4xl mx-auto">
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-robot text-primary-500"></i>
                    AI Assistant
                </h1>
                <p class="text-gray-500">Generate template dan konversi data dengan bantuan AI</p>
            </div>
            
            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-white rounded-xl shadow-sm border p-6 cursor-pointer hover:border-primary-400 transition-colors" data-ai-action="student-csv">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-users text-blue-600"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-800">Generate CSV Siswa</h3>
                            <p class="text-sm text-gray-500">Format siap upload untuk data siswa</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border p-6 cursor-pointer hover:border-primary-400 transition-colors" data-ai-action="cp-csv">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-database text-green-600"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-800">Generate CSV CP</h3>
                            <p class="text-sm text-gray-500">Template CP sesuai kurikulum</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border p-6 cursor-pointer hover:border-primary-400 transition-colors" data-ai-action="convert-material">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-exchange-alt text-purple-600"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-800">Konversi Materi</h3>
                            <p class="text-sm text-gray-500">Ubah materi mentah ke format sistem</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border p-6 cursor-pointer hover:border-primary-400 transition-colors" data-ai-action="generate-tp">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-lightbulb text-yellow-600"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-800">Generate TP dari CP</h3>
                            <p class="text-sm text-gray-500">Buat Tujuan Pembelajaran otomatis</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Output Area -->
            <div id="aiOutputArea" class="bg-white rounded-xl shadow-sm border p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="font-semibold text-gray-800">Output</h2>
                    <button id="btnCopyAIOutput" class="px-3 py-1 text-sm bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-colors hidden">
                        <i class="fas fa-copy mr-1"></i> Copy
                    </button>
                </div>
                <div id="aiOutputContent" class="bg-gray-50 rounded-lg p-4 min-h-[200px] font-mono text-sm">
                    <p class="text-gray-400 text-center">Pilih aksi di atas untuk generate output</p>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Modul Ajar Template (Premium) -->
    <template id="tplModulAjar">
        <div class="p-4 lg:p-8">
            <div class="mb-6 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Modul Ajar</h1>
                    <p class="text-gray-500">Sinkronisasi otomatis dengan Promes & Jurnal</p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="btnNewModul" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                        <i class="fas fa-plus mr-1"></i> Buat Modul Baru
                    </button>
                </div>
            </div>
            
            <!-- Filter -->
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mapel</label>
                        <select id="modulFilterMapel" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="">Semua Mapel</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                        <select id="modulFilterKelas" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="">Semua Kelas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                        <select id="modulFilterSemester" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="">Semua</option>
                            <option value="1">Ganjil</option>
                            <option value="2">Genap</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnFilterModul" class="w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                            <i class="fas fa-filter mr-1"></i> Filter
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Modul List -->
            <div id="modulList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Will be populated -->
            </div>
            
            <div id="modulEmpty" class="bg-white rounded-xl shadow-sm border p-12 text-center text-gray-500">
                <i class="fas fa-book-open text-4xl mb-3"></i>
                <p>Belum ada modul ajar. Klik "Buat Modul Baru" untuk memulai.</p>
            </div>
        </div>
    </template>
    
    <!-- Students Template -->
    <template id="tplStudents">
        <div class="p-4 lg:p-8">
            <div class="mb-6 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Data Siswa</h1>
                    <p class="text-gray-500">Kelola data siswa per kelas</p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="btnImportStudents" class="px-4 py-2 bg-secondary-600 text-white rounded-lg hover:bg-secondary-700 transition-colors">
                        <i class="fas fa-file-import mr-1"></i> Import CSV
                    </button>
                    <button id="btnAddStudent" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                        <i class="fas fa-plus mr-1"></i> Tambah Siswa
                    </button>
                </div>
            </div>
            
            <!-- Class Selector -->
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pilih Kelas</label>
                        <select id="studentFilterKelas" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="">Semua Kelas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cari Siswa</label>
                        <input type="text" id="studentSearch" placeholder="Nama atau NISN..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div class="flex items-end gap-2">
                        <button id="btnAddClass" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                            <i class="fas fa-plus mr-1"></i> Kelas Baru
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Students Table -->
            <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                <div class="p-4 border-b flex items-center justify-between">
                    <h2 class="font-semibold text-gray-800">Daftar Siswa</h2>
                    <span id="studentCount" class="text-sm text-gray-500"></span>
                </div>
                <div class="table-auto-scroll">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">NISN</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">L/P</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kelas</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody" class="divide-y divide-gray-200">
                            <!-- Will be populated -->
                        </tbody>
                    </table>
                </div>
                <div id="studentsEmpty" class="p-12 text-center text-gray-500">
                    <i class="fas fa-users text-4xl mb-3"></i>
                    <p>Belum ada data siswa</p>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Prota Template -->
    <template id="tplProta">
        <div class="p-4 lg:p-8">
            <div class="mb-6 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Program Tahunan (Prota)</h1>
                    <p class="text-gray-500">Distribusi materi tahunan dari ATP</p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="btnGenerateProta" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                        <i class="fas fa-magic mr-1"></i> Generate Prota
                    </button>
                    <button id="btnPrintProta" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        <i class="fas fa-print mr-1"></i> Cetak
                    </button>
                </div>
            </div>
            
            <!-- Filter -->
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mata Pelajaran</label>
                        <select id="protaFilterMapel" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="">Pilih Mapel</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                        <select id="protaFilterKelas" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="">Pilih Kelas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tahun Ajar</label>
                        <input type="text" id="protaTahunAjar" class="w-full px-4 py-2 border rounded-lg bg-gray-100" readonly>
                    </div>
                </div>
            </div>
            
            <!-- Prota Content -->
            <div id="protaContent" class="bg-white rounded-xl shadow-sm border overflow-hidden">
                <div class="p-4 border-b flex items-center justify-between">
                    <h2 class="font-semibold text-gray-800">Distribusi Program Tahunan</h2>
                </div>
                <div id="protaEmpty" class="p-12 text-center text-gray-500">
                    <i class="fas fa-calendar-check text-4xl mb-3"></i>
                    <p>Pilih filter di atas lalu klik "Generate Prota"</p>
                </div>
                <div id="protaTableContainer" class="hidden table-auto-scroll">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Semester</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bulan</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Minggu</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">JP</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase" style="min-width: 300px;">Materi/TP</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Keterangan</th>
                            </tr>
                        </thead>
                        <tbody id="protaTableBody" class="divide-y divide-gray-200">
                            <!-- Will be populated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Jurnal Template (Premium) -->
    <template id="tplJurnal">
        <div class="p-4 lg:p-8">
            <div class="mb-6 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Jurnal Pembelajaran</h1>
                    <p class="text-gray-500">Auto-generated dari Promes + Absensi</p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="btnGenerateJurnal" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                        <i class="fas fa-sync mr-1"></i> Sync Jurnal
                    </button>
                    <button id="btnPrintJurnal" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        <i class="fas fa-print mr-1"></i> Cetak
                    </button>
                </div>
            </div>
            
            <!-- Filter -->
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mapel</label>
                        <select id="jurnalFilterMapel" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="">Pilih Mapel</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                        <select id="jurnalFilterKelas" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="">Pilih Kelas</option>
                                                </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                        <select id="jurnalFilterSemester" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="1">Ganjil</option>
                            <option value="2">Genap</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bulan</label>
                        <select id="jurnalFilterBulan" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="">Semua Bulan</option>
                            <option value="1">Januari</option>
                            <option value="2">Februari</option>
                            <option value="3">Maret</option>
                            <option value="4">April</option>
                            <option value="5">Mei</option>
                            <option value="6">Juni</option>
                            <option value="7">Juli</option>
                            <option value="8">Agustus</option>
                            <option value="9">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Desember</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Jurnal Table -->
            <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                <div class="p-4 border-b flex items-center justify-between">
                    <h2 class="font-semibold text-gray-800">Jurnal Harian</h2>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-500">TTD Otomatis:</span>
                        <span class="text-sm text-green-600"><i class="fas fa-check-circle"></i> Aktif</span>
                    </div>
                </div>
                <div class="table-auto-scroll">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hari/Tanggal</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jam</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase" style="min-width: 200px;">Materi</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Elemen/CP</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">TP</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kehadiran</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hasil</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ket</th>
                            </tr>
                        </thead>
                        <tbody id="jurnalTableBody" class="divide-y divide-gray-200">
                            <!-- Will be populated -->
                        </tbody>
                    </table>
                </div>
                <div id="jurnalEmpty" class="p-12 text-center text-gray-500">
                    <i class="fas fa-journal-whills text-4xl mb-3"></i>
                    <p>Klik "Sync Jurnal" untuk generate jurnal otomatis dari Promes</p>
                </div>
            </div>
        </div>
    </template>
    
    <!-- KKTP Template (Premium) -->
    <template id="tplKKTP">
        <div class="p-4 lg:p-8">
            <div class="mb-6 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">KKTP (Kriteria Ketercapaian Tujuan Pembelajaran)</h1>
                    <p class="text-gray-500">Sinkronisasi dengan TP dari Promes</p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="btnSyncKKTP" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                        <i class="fas fa-sync mr-1"></i> Sync dari TP
                    </button>
                    <button id="btnPrintKKTP" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        <i class="fas fa-print mr-1"></i> Cetak
                    </button>
                </div>
            </div>
            
            <!-- Filter -->
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mapel</label>
                        <select id="kktpFilterMapel" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="">Pilih Mapel</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                        <select id="kktpFilterKelas" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="">Pilih Kelas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                        <select id="kktpFilterSemester" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="1">Ganjil</option>
                            <option value="2">Genap</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnLoadKKTP" class="w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                            <i class="fas fa-search mr-1"></i> Tampilkan
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- KKTP Table -->
            <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                <div class="p-4 border-b">
                    <h2 class="font-semibold text-gray-800">Kriteria Ketercapaian</h2>
                </div>
                <div class="table-auto-scroll">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase" style="min-width: 250px;">Tujuan Pembelajaran</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase" style="min-width: 200px;">Indikator</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Skor Maks</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bobot (%)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Keterangan</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="kktpTableBody" class="divide-y divide-gray-200">
                            <!-- Will be populated -->
                        </tbody>
                    </table>
                </div>
                <div id="kktpEmpty" class="p-12 text-center text-gray-500">
                    <i class="fas fa-check-double text-4xl mb-3"></i>
                    <p>Pilih filter lalu klik "Sync dari TP"</p>
                </div>
            </div>
            
            <!-- KKTP Summary -->
            <div id="kktpSummary" class="hidden mt-6 bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-6 text-white">
                <h3 class="text-lg font-semibold mb-2">Ringkasan KKTP</h3>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <p class="text-3xl font-bold" id="kktpTotalTP">0</p>
                        <p class="text-green-100 text-sm">Total TP</p>
                    </div>
                    <div>
                        <p class="text-3xl font-bold" id="kktpTotalBobot">100%</p>
                        <p class="text-green-100 text-sm">Total Bobot</p>
                    </div>
                    <div>
                        <p class="text-3xl font-bold" id="kktpStatus">‚úì</p>
                        <p class="text-green-100 text-sm">Status Valid</p>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Nilai Template (Premium) -->
    <template id="tplNilai">
        <div class="p-4 lg:p-8">
            <div class="mb-6 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Daftar Nilai</h1>
                    <p class="text-gray-500">Sumatif, ATS, ASAS & Nilai Rapor otomatis</p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="btnAddNilaiKomponen" class="px-4 py-2 bg-secondary-600 text-white rounded-lg hover:bg-secondary-700 transition-colors">
                        <i class="fas fa-plus mr-1"></i> Tambah Komponen
                    </button>
                    <button id="btnPrintNilai" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        <i class="fas fa-print mr-1"></i> Cetak
                    </button>
                </div>
            </div>
            
            <!-- Filter -->
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mapel</label>
                        <select id="nilaiFilterMapel" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="">Pilih Mapel</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                        <select id="nilaiFilterKelas" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="">Pilih Kelas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                        <select id="nilaiFilterSemester" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="1">Ganjil</option>
                            <option value="2">Genap</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnLoadNilai" class="w-full px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                            <i class="fas fa-search mr-1"></i> Tampilkan
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Komponen Nilai -->
            <div id="komponenNilaiContainer" class="bg-white rounded-xl shadow-sm border p-6 mb-6 hidden">
                <h2 class="font-semibold text-gray-800 mb-4">Komponen Penilaian</h2>
                <div id="komponenNilaiList" class="flex flex-wrap gap-2">
                    <!-- Will be populated -->
                </div>
            </div>
            
            <!-- Nilai Table -->
            <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                <div class="p-4 border-b flex items-center justify-between">
                    <h2 class="font-semibold text-gray-800">Daftar Nilai Siswa</h2>
                    <button id="btnSaveNilai" class="px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors hidden">
                        <i class="fas fa-save mr-1"></i> Simpan Nilai
                    </button>
                </div>
                <div class="table-auto-scroll">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr id="nilaiTableHeader">
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">NISN</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Siswa</th>
                                <!-- Dynamic columns will be added -->
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase bg-yellow-50">NR</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase bg-yellow-50">Predikat</th>
                            </tr>
                        </thead>
                        <tbody id="nilaiTableBody" class="divide-y divide-gray-200">
                            <!-- Will be populated -->
                        </tbody>
                    </table>
                </div>
                <div id="nilaiEmpty" class="p-12 text-center text-gray-500">
                    <i class="fas fa-star text-4xl mb-3"></i>
                    <p>Pilih filter untuk menampilkan data nilai</p>
                </div>
            </div>
        </div>
    </template>
    
    <!-- ==================== MODALS ==================== -->
    
    <!-- Generic Modal Container -->
    <div id="modalContainer" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50" id="modalOverlay"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div id="modalContent" class="relative bg-white rounded-2xl shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
                <!-- Modal content will be injected here -->
            </div>
        </div>
    </div>
    
    <!-- Add Schedule Entry Modal Template -->
    <template id="tplModalScheduleEntry">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">Tambah Jadwal</h3>
                <button class="btn-close-modal text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="formScheduleEntry" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Hari</label>
                    <select id="scheduleHari" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500" required>
                        <option value="">Pilih Hari</option>
                        <option value="Senin">Senin</option>
                        <option value="Selasa">Selasa</option>
                        <option value="Rabu">Rabu</option>
                        <option value="Kamis">Kamis</option>
                        <option value="Jumat">Jumat</option>
                        <option value="Sabtu">Sabtu</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jam Ke (Mulai)</label>
                        <input type="number" id="scheduleJamMulai" min="1" max="12" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jam Ke (Selesai)</label>
                        <input type="number" id="scheduleJamSelesai" min="1" max="12" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                    <select id="scheduleKelas" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500" required>
                        <option value="">Pilih Kelas</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mata Pelajaran</label>
                    <select id="scheduleMapel" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500" required>
                        <option value="">Pilih Mapel</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" class="btn-close-modal px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">Simpan</button>
                </div>
            </form>
        </div>
    </template>
    
    <!-- Add Student Modal Template -->
    <template id="tplModalStudent">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">Tambah Siswa</h3>
                <button class="btn-close-modal text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="formStudent" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">NISN</label>
                    <input type="text" id="studentNISN" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                    <input type="text" id="studentNama" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Kelamin</label>
                        <select id="studentJK" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500" required>
                            <option value="">Pilih</option>
                            <option value="L">Laki-laki</option>
                            <option value="P">Perempuan</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                        <select id="studentKelas" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500" required>
                            <option value="">Pilih Kelas</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tempat Lahir</label>
                        <input type="text" id="studentTempatLahir" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Lahir</label>
                        <input type="date" id="studentTanggalLahir" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Orang Tua</label>
                    <input type="text" id="studentOrtu" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">No. HP</label>
                    <input type="tel" id="studentHP" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" class="btn-close-modal px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">Simpan</button>
                </div>
            </form>
        </div>
    </template>
    
    <!-- Add Class Modal Template -->
    <template id="tplModalClass">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">Tambah Kelas</h3>
                <button class="btn-close-modal text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="formClass" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kelas</label>
                    <input type="text" id="classNama" placeholder="Contoh: 7A, X-IPA1" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tingkat</label>
                        <select id="classTingkat" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500" required>
                            <option value="">Pilih Tingkat</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fase</label>
                        <input type="text" id="classFase" class="w-full px-4 py-2 border rounded-lg bg-gray-100" readonly>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Wali Kelas</label>
                    <input type="text" id="classWali" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" class="btn-close-modal px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">Simpan</button>
                </div>
            </form>
        </div>
    </template>
    
    <!-- Import CSV Modal Template -->
    <template id="tplModalImportCSV">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">Import Data Siswa</h3>
                <button class="btn-close-modal text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-sm text-blue-800 mb-2"><strong>Format CSV:</strong></p>
                    <code class="text-xs bg-blue-100 px-2 py-1 rounded block overflow-x-auto">
                        NISN;Nama;JenisKelamin;TempatLahir;TanggalLahir;NamaOrtu;NoHP
                    </code>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pilih Kelas Tujuan</label>
                    <select id="importKelas" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500" required>
                        <option value="">Pilih Kelas</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Link Google Sheet (CSV)</label>
                    <input type="url" id="importURL" placeholder="https://docs.google.com/spreadsheets/..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
                    <p class="text-xs text-gray-500 mt-1">Atau paste data CSV langsung:</p>
                </div>
                <div>
                    <textarea id="importCSVData" rows="6" class="w-full px-4 py-2 border rounded-lg font-mono text-sm focus:ring-2 focus:ring-primary-500" placeholder="Paste data CSV di sini..."></textarea>
                </div>
                <div id="importPreview" class="hidden">
                    <p class="text-sm font-medium text-gray-700 mb-2">Preview: <span id="importPreviewCount">0</span> siswa</p>
                    <div class="max-h-40 overflow-y-auto bg-gray-50 rounded-lg p-2 text-sm">
                        <ul id="importPreviewList" class="space-y-1"></ul>
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" class="btn-close-modal px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Batal</button>
                    <button type="button" id="btnPreviewImport" class="px-4 py-2 bg-secondary-600 text-white rounded-lg hover:bg-secondary-700">Preview</button>
                    <button type="button" id="btnConfirmImport" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 hidden">Import</button>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Add Holiday Modal Template -->
    <template id="tplModalHoliday">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">Tambah Libur Lokal</h3>
                <button class="btn-close-modal text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="formHoliday" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                    <input type="date" id="holidayDate" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                    <input type="text" id="holidayName" placeholder="Nama kegiatan / alasan libur" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500" required>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" class="btn-close-modal px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">Simpan</button>
                </div>
            </form>
        </div>
    </template>
    
    <!-- Modul Ajar Modal Template -->
    <template id="tplModalModulAjar">
        <div class="p-6 max-w-3xl mx-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">Modul Ajar</h3>
                <button class="btn-close-modal text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="formModulAjar" class="space-y-4">
                <!-- Header Info -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mapel</label>
                        <select id="modulMapel" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-sm" required>
                            <option value="">Pilih</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                        <select id="modulKelas" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-sm" required>
                            <option value="">Pilih</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pertemuan Ke</label>
                        <input type="number" id="modulPertemuan" min="1" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-sm" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Alokasi Waktu</label>
                        <input type="text" id="modulAlokasi" placeholder="2 x 35 menit" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-sm" required>
                    </div>
                </div>
                
                <!-- Main Content -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tujuan Pembelajaran</label>
                    <textarea id="modulTP" rows="2" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-sm" required></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Elemen/CP</label>
                    <input type="text" id="modulElemen" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Dimensi Profil Pelajar Pancasila</label>
                    <input type="text" id="modulDimensi" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-sm" placeholder="Penalaran Kritis, Kolaborasi, dll">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pertanyaan Pemantik</label>
                    <textarea id="modulPemantik" rows="2" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-sm"></textarea>
                </div>
                
                <!-- Kegiatan Pembelajaran -->
                <div class="border rounded-lg p-4 bg-gray-50">
                    <h4 class="font-medium text-gray-800 mb-3">Kegiatan Pembelajaran</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pendahuluan</label>
                            <textarea id="modulPendahuluan" rows="2" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-sm"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kegiatan Inti</label>
                            <textarea id="modulInti" rows="4" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-sm"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Penutup</label>
                            <textarea id="modulPenutup" rows="2" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-sm"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Additional -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Asesmen</label>
                        <textarea id="modulAsesmen" rows="2" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sumber Belajar</label>
                        <textarea id="modulSumber" rows="2" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-sm"></textarea>
                    </div>
                </div>
                
                <!-- RTL Content (for PAI) -->
                <div id="rtlSection" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Konten Arab (RTL)</label>
                    <textarea id="modulArab" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-sm rtl-text" dir="rtl"></textarea>
                </div>
                
                <!-- LKPD Toggle -->
                <div class="flex items-center gap-3 p-4 bg-blue-50 rounded-lg">
                    <input type="checkbox" id="modulHasLKPD" class="w-5 h-5 text-primary-600 rounded focus:ring-primary-500">
                    <div>
                        <label for="modulHasLKPD" class="font-medium text-gray-800">Sertakan LKPD</label>
                        <p class="text-sm text-gray-500">Generate Lembar Kerja Peserta Didik otomatis</p>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" class="btn-close-modal px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Batal</button>
                    <button type="button" id="btnPreviewModul" class="px-4 py-2 bg-secondary-600 text-white rounded-lg hover:bg-secondary-700">
                        <i class="fas fa-eye mr-1"></i> Preview
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                        <i class="fas fa-save mr-1"></i> Simpan
                    </button>
                </div>
            </form>
        </div>
    </template>
    
    <!-- Confirm Modal Template -->
    <template id="tplModalConfirm">
        <div class="p-6 text-center">
            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-2xl text-yellow-600"></i>
            </div>
            <h3 id="confirmTitle" class="text-xl font-bold text-gray-800 mb-2">Konfirmasi</h3>
            <p id="confirmMessage" class="text-gray-500 mb-6">Apakah Anda yakin?</p>
            <div class="flex justify-center gap-3">
                <button class="btn-close-modal px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Batal</button>
                <button id="btnConfirmAction" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Lanjutkan</button>
            </div>
        </div>
    </template>
    
    <!-- Premium Required Modal Template -->
    <template id="tplModalPremium">
        <div class="p-6 text-center">
            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-crown text-2xl text-yellow-500"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Fitur Premium</h3>
            <p class="text-gray-500 mb-6">Fitur ini hanya tersedia untuk pengguna Premium. Upgrade sekarang untuk akses penuh!</p>
            <div class="flex justify-center gap-3">
                <button class="btn-close-modal px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Nanti</button>
                <button id="btnGoToPremium" class="px-6 py-2 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white rounded-lg hover:from-yellow-600 hover:to-yellow-700">
                    <i class="fas fa-crown mr-1"></i> Upgrade Premium
                </button>
            </div>
        </div>
    </template>
    
    <!-- ==================== TOAST NOTIFICATIONS ==================== -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    
    <!-- Toast Template -->
    <template id="tplToast">
        <div class="toast flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg min-w-[280px] max-w-md">
            <i class="toast-icon text-xl"></i>
            <p class="toast-message flex-1 text-sm"></p>
            <button class="toast-close text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </template>
    
    <!-- ==================== PRINT TEMPLATES ==================== -->
    <div id="printArea" class="hidden print-only"></div>
    
    <!-- ==================== SCRIPTS ==================== -->
    
    <!-- Firebase SDK -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            onAuthStateChanged, 
            signOut 
        } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            query, 
            where, 
            orderBy,
            onSnapshot,
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        // ==================== FIREBASE CONFIG ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDe4ie2wSPEpNbAgWP-q03vTuHyxc9Jj3E",
            authDomain: "agsa-e5b08.firebaseapp.com",
            projectId: "agsa-e5b08",
            storageBucket: "agsa-e5b08.firebasestorage.app",
            messagingSenderId: "916052746331",
            appId: "1:916052746331:web:357cbadbfd8658f1689f7e",
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // ==================== CONSTANTS ====================
        const SUPER_ADMIN_EMAIL = 'afifaro@gmail.com';
        
        const CP_LINKS = {
            SD: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1925091593&single=true&output=csv',
            SMP: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1962203786&single=true&output=csv',
            SMA: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=260922290&single=true&output=csv',
            SMK: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=260922290&single=true&output=csv'
        };

        const DIMENSI_P5 = [
            'Beriman, Bertakwa kepada Tuhan YME, dan Berakhlak Mulia',
            'Berkebinekaan Global',
            'Bergotong Royong',
            'Mandiri',
            'Bernalar Kritis',
            'Kreatif'
        ];

        const HARI_LIBUR_NASIONAL_2024_2025 = [
            { tanggal: '2024-08-17', nama: 'Hari Kemerdekaan RI' },
            { tanggal: '2024-09-16', nama: 'Maulid Nabi Muhammad SAW' },
            { tanggal: '2024-12-25', nama: 'Hari Natal' },
            { tanggal: '2025-01-01', nama: 'Tahun Baru 2025' },
            { tanggal: '2025-01-29', nama: 'Tahun Baru Imlek' },
            { tanggal: '2025-03-29', nama: 'Hari Raya Nyepi' },
            { tanggal: '2025-03-31', nama: 'Idul Fitri 1446 H' },
            { tanggal: '2025-04-01', nama: 'Idul Fitri 1446 H' },
            { tanggal: '2025-04-18', nama: 'Wafat Isa Al-Masih' },
            { tanggal: '2025-05-01', nama: 'Hari Buruh' },
            { tanggal: '2025-05-12', nama: 'Hari Raya Waisak' },
            { tanggal: '2025-05-29', nama: 'Kenaikan Isa Al-Masih' },
            { tanggal: '2025-06-01', nama: 'Hari Lahir Pancasila' },
            { tanggal: '2025-06-07', nama: 'Idul Adha 1446 H' },
            { tanggal: '2025-06-27', nama: 'Tahun Baru Islam 1447 H' }
        ];

        const KELAS_PER_JENJANG = {
            SD: ['1', '2', '3', '4', '5', '6'],
            SMP: ['7', '8', '9'],
            SMA: ['10', '11', '12'],
            SMK: ['10', '11', '12']
        };

        const FASE_PER_KELAS = {
            '1': 'A', '2': 'A',
            '3': 'B', '4': 'B',
            '5': 'C', '6': 'C',
            '7': 'D', '8': 'D', '9': 'D',
            '10': 'E', '11': 'F', '12': 'F'
        };

        const FREE_FEATURES = ['dashboard', 'profile', 'calendar', 'schedule', 'students', 'cp-database', 'atp', 'prota', 'ai-assistant', 'subscription'];
        const PREMIUM_FEATURES = ['promes', 'modul-ajar', 'jurnal', 'kktp', 'nilai'];

        // ==================== STATE MANAGEMENT ====================
        const AppState = {
            user: null,
            profile: null,
            subscription: { plan: 'free', type: 'personal' },
            currentPage: 'dashboard',
            isLoading: false,
            cpData: [],
            classes: [],
            students: [],
            schedules: [],
            calendar: null
        };

        // ==================== UTILITY FUNCTIONS ====================
        const Utils = {
            // Format tahun ajar
            formatTahunAjar(tahunAwal) {
                const tahun = parseInt(tahunAwal);
                return `${tahun}/${tahun + 1}`;
            },

            // Format tanggal Indonesia
            formatTanggal(dateString, format = 'long') {
                const date = new Date(dateString);
                const options = format === 'long' 
                    ? { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }
                    : { day: '2-digit', month: '2-digit', year: 'numeric' };
                return date.toLocaleDateString('id-ID', options);
            },

            // Get nama hari
            getNamaHari(dateString) {
                const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                return days[new Date(dateString).getDay()];
            },

            // Calculate weeks between dates
            getWeeksBetween(startDate, endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return Math.ceil(diffDays / 7);
            },

            // Get effective days in a week
            getEffectiveDays(weekStart, weekEnd, holidays = []) {
                let count = 0;
                const current = new Date(weekStart);
                const end = new Date(weekEnd);
                
                while (current <= end) {
                    const day = current.getDay();
                    const dateStr = current.toISOString().split('T')[0];
                    
                    // Skip Sunday (0) and holidays
                    if (day !== 0 && !holidays.includes(dateStr)) {
                        count++;
                    }
                    current.setDate(current.getDate() + 1);
                }
                return count;
            },

            // Parse CSV
            parseCSV(csvText, delimiter = ';') {
                const lines = csvText.trim().split('\n');
                const headers = lines[0].split(delimiter).map(h => h.trim());
                const data = [];

                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(delimiter).map(v => v.trim());
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        data.push(row);
                    }
                }
                return data;
            },

            // Calculate time
            calculateTime(startTime, durationMinutes, jamKe) {
                const [hours, minutes] = startTime.split(':').map(Number);
                const startMinutes = hours * 60 + minutes + (jamKe - 1) * durationMinutes;
                const endMinutes = startMinutes + durationMinutes;
                
                const startH = Math.floor(startMinutes / 60).toString().padStart(2, '0');
                const startM = (startMinutes % 60).toString().padStart(2, '0');
                const endH = Math.floor(endMinutes / 60).toString().padStart(2, '0');
                const endM = (endMinutes % 60).toString().padStart(2, '0');
                
                return {
                    mulai: `${startH}:${startM}`,
                    selesai: `${endH}:${endM}`
                };
            },

            // Generate unique ID
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            },

            // Debounce function
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // ==================== TOAST NOTIFICATIONS ====================
        const Toast = {
            show(message, type = 'info') {
                const container = document.getElementById('toastContainer');
                const template = document.getElementById('tplToast');
                const clone = template.content.cloneNode(true);
                const toast = clone.querySelector('.toast');
                const icon = toast.querySelector('.toast-icon');
                const msg = toast.querySelector('.toast-message');
                const closeBtn = toast.querySelector('.toast-close');

                msg.textContent = message;

                const styles = {
                    success: { bg: 'bg-green-500', icon: 'fas fa-check-circle' },
                    error: { bg: 'bg-red-500', icon: 'fas fa-times-circle' },
                    warning: { bg: 'bg-yellow-500', icon: 'fas fa-exclamation-circle' },
                    info: { bg: 'bg-blue-500', icon: 'fas fa-info-circle' }
                };

                toast.classList.add(styles[type].bg, 'text-white');
                icon.className = `toast-icon text-xl ${styles[type].icon}`;

                container.appendChild(clone);
                const addedToast = container.lastElementChild;

                closeBtn.addEventListener('click', () => addedToast.remove());
                
                setTimeout(() => {
                    if (addedToast.parentNode) {
                        addedToast.remove();
                    }
                }, 4000);
            },

            success(message) { this.show(message, 'success'); },
            error(message) { this.show(message, 'error'); },
            warning(message) { this.show(message, 'warning'); },
            info(message) { this.show(message, 'info'); }
        };

        // ==================== MODAL MANAGEMENT ====================
        const Modal = {
            container: null,
            overlay: null,
            content: null,

            init() {
                this.container = document.getElementById('modalContainer');
                this.overlay = document.getElementById('modalOverlay');
                this.content = document.getElementById('modalContent');

                this.overlay.addEventListener('click', () => this.close());
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.close();
                });
            },

            open(templateId, data = {}) {
                const template = document.getElementById(templateId);
                if (!template) return;

                this.content.innerHTML = '';
                const clone = template.content.cloneNode(true);
                this.content.appendChild(clone);

                // Setup close buttons
                this.content.querySelectorAll('.btn-close-modal').forEach(btn => {
                    btn.addEventListener('click', () => this.close());
                });

                this.container.classList.remove('hidden');
                document.body.style.overflow = 'hidden';

                return this.content;
            },

            close() {
                this.container.classList.add('hidden');
                document.body.style.overflow = '';
                this.content.innerHTML = '';
            }
        };

        // ==================== ROUTER ====================
        const Router = {
            navigate(page) {
                // Check premium features
                if (PREMIUM_FEATURES.includes(page) && AppState.subscription.plan !== 'premium') {
                    Modal.open('tplModalPremium');
                    document.getElementById('btnGoToPremium')?.addEventListener('click', () => {
                        Modal.close();
                        this.navigate('subscription');
                    });
                    return;
                }

                AppState.currentPage = page;
                this.render(page);
                this.updateActiveNav(page);
            },

            render(page) {
                const mainContent = document.getElementById('mainContent');
                const template = document.getElementById(`tpl${this.capitalize(page.replace(/-/g, ''))}`);

                if (template) {
                    mainContent.innerHTML = '';
                    const clone = template.content.cloneNode(true);
                    mainContent.appendChild(clone);
                    this.initPage(page);
                }
            },

            capitalize(str) {
                return str.charAt(0).toUpperCase() + str.slice(1);
            },

            updateActiveNav(page) {
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('bg-primary-50', 'text-primary-600');
                    if (link.dataset.page === page) {
                        link.classList.add('bg-primary-50', 'text-primary-600');
                    }
                });
            },

            initPage(page) {
                switch (page) {
                    case 'dashboard':
                        Pages.Dashboard.init();
                        break;
                    case 'profile':
                        Pages.Profile.init();
                        break;
                    case 'calendar':
                        Pages.Calendar.init();
                        break;
                    case 'schedule':
                        Pages.Schedule.init();
                        break;
                    case 'students':
                        Pages.Students.init();
                        break;
                    case 'cp-database':
                        Pages.CPDatabase.init();
                        break;
                    case 'atp':
                        Pages.ATP.init();
                        break;
                    case 'prota':
                        Pages.Prota.init();
                        break;
                    case 'promes':
                        Pages.Promes.init();
                        break;
                    case 'modul-ajar':
                        Pages.ModulAjar.init();
                        break;
                    case 'jurnal':
                        Pages.Jurnal.init();
                        break;
                    case 'kktp':
                        Pages.KKTP.init();
                        break;
                    case 'nilai':
                        Pages.Nilai.init();
                        break;
                    case 'ai-assistant':
                        Pages.AIAssistant.init();
                        break;
                    case 'subscription':
                        Pages.Subscription.init();
                        break;
                    case 'admin':
                        Pages.Admin.init();
                        break;
                }
            }
        };

        // ==================== AUTH MODULE ====================
        const Auth = {
            async login() {
                const loginBtn = document.getElementById('btnGoogleLogin');
                const loading = document.getElementById('loginLoading');
                
                loginBtn.disabled = true;
                loading.classList.remove('hidden');

                try {
                    const result = await signInWithPopup(auth, provider);
                    Toast.success('Login berhasil!');
                } catch (error) {
                    console.error('Login error:', error);
                    Toast.error('Gagal login. Silakan coba lagi.');
                    loginBtn.disabled = false;
                    loading.classList.add('hidden');
                }
            },

            async logout() {
                try {
                    await signOut(auth);
                    AppState.user = null;
                    AppState.profile = null;
                    Toast.info('Anda telah keluar');
                } catch (error) {
                    console.error('Logout error:', error);
                    Toast.error('Gagal logout');
                }
            },

            async checkSubscription(userId) {
                try {
                    const userDoc = await getDoc(doc(db, 'users', userId));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (userData.subscription) {
                            // Check if subscription is still valid
                            if (userData.subscription.endDate) {
                                const endDate = userData.subscription.endDate.toDate();
                                if (endDate > new Date()) {
                                    AppState.subscription = userData.subscription;
                                } else {
                                    // Subscription expired
                                    AppState.subscription = { plan: 'free', type: 'personal' };
                                    await updateDoc(doc(db, 'users', userId), {
                                        'subscription.status': 'expired'
                                    });
                                }
                            } else {
                                AppState.subscription = userData.subscription;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error checking subscription:', error);
                }
            },

            isSuperAdmin() {
                return AppState.user?.email === SUPER_ADMIN_EMAIL;
            }
        };

        // ==================== FIRESTORE SERVICE ====================
        const FirestoreService = {
            // Profile
            async getProfile(userId) {
                try {
                    const docRef = doc(db, 'profiles', userId);
                    const docSnap = await getDoc(docRef);
                    return docSnap.exists() ? docSnap.data() : null;
                } catch (error) {
                    console.error('Error getting profile:', error);
                    return null;
                }
            },

            async saveProfile(userId, data) {
                try {
                    await setDoc(doc(db, 'profiles', userId), {
                        ...data,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    return true;
                } catch (error) {
                    console.error('Error saving profile:', error);
                    return false;
                }
            },

            // Calendar
            async getCalendar(userId, tahunAjar) {
                try {
                    const q = query(
                        collection(db, 'calendars'),
                        where('userId', '==', userId),
                        where('tahunAjar', '==', tahunAjar)
                    );
                    const snapshot = await getDocs(q);
                    if (!snapshot.empty) {
                        return { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                    }
                    return null;
                } catch (error) {
                    console.error('Error getting calendar:', error);
                    return null;
                }
            },

            async saveCalendar(userId, data) {
                try {
                    const existingCalendar = await this.getCalendar(userId, data.tahunAjar);
                    if (existingCalendar) {
                        await updateDoc(doc(db, 'calendars', existingCalendar.id), data);
                    } else {
                        await addDoc(collection(db, 'calendars'), {
                            ...data,
                            userId,
                            createdAt: serverTimestamp()
                        });
                    }
                    return true;
                } catch (error) {
                    console.error('Error saving calendar:', error);
                    return false;
                }
            },

            // Classes
            async getClasses(userId) {
                try {
                    const q = query(
                        collection(db, 'classes'),
                        where('userId', '==', userId)
                    );
                    const snapshot = await getDocs(q);
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Error getting classes:', error);
                    return [];
                }
            },

            async addClass(userId, data) {
                try {
                    const docRef = await addDoc(collection(db, 'classes'), {
                        ...data,
                        userId,
                        createdAt: serverTimestamp()
                    });
                    return docRef.id;
                } catch (error) {
                    console.error('Error adding class:', error);
                    return null;
                }
            },

            // Students
            async getStudents(userId, classId = null) {
                try {
                    let q;
                    if (classId) {
                        q = query(
                            collection(db, 'students'),
                            where('userId', '==', userId),
                            where('classId', '==', classId)
                        );
                    } else {
                        q = query(
                            collection(db, 'students'),
                            where('userId', '==', userId)
                        );
                    }
                    const snapshot = await getDocs(q);
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Error getting students:', error);
                    return [];
                }
            },

            async addStudent(userId, data) {
                try {
                    const docRef = await addDoc(collection(db, 'students'), {
                        ...data,
                        userId,
                        createdAt: serverTimestamp()
                    });
                    return docRef.id;
                } catch (error) {
                    console.error('Error adding student:', error);
                    return null;
                }
            },

            async addStudentsBatch(userId, students) {
                try {
                    const promises = students.map(student => 
                        addDoc(collection(db, 'students'), {
                            ...student,
                            userId,
                            createdAt: serverTimestamp()
                        })
                    );
                    await Promise.all(promises);
                    return true;
                } catch (error) {
                    console.error('Error batch adding students:', error);
                    return false;
                }
            },

            // Schedules
            async getSchedules(userId, semester = null) {
                try {
                    let q;
                    if (semester) {
                        q = query(
                            collection(db, 'schedules'),
                            where('userId', '==', userId),
                            where('semester', '==', semester)
                        );
                    } else {
                        q = query(
                            collection(db, 'schedules'),
                            where('userId', '==', userId)
                        );
                    }
                    const snapshot = await getDocs(q);
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Error getting schedules:', error);
                    return [];
                }
            },

            async saveSchedule(userId, data) {
                try {
                    // Check for existing schedule
                    const existing = await this.getSchedules(userId, data.semester);
                    if (existing.length > 0) {
                        await updateDoc(doc(db, 'schedules', existing[0].id), data);
                    } else {
                        await addDoc(collection(db, 'schedules'), {
                            ...data,
                            userId,
                            createdAt: serverTimestamp()
                        });
                    }
                    return true;
                } catch (error) {
                    console.error('Error saving schedule:', error);
                    return false;
                }
            },

            // ATP
            async saveATP(userId, data) {
                try {
                    const q = query(
                        collection(db, 'atp'),
                        where('userId', '==', userId),
                        where('tahunAjar', '==', data.tahunAjar),
                        where('mapel', '==', data.mapel),
                        where('kelas', '==', data.kelas)
                    );
                    const snapshot = await getDocs(q);
                    
                    if (!snapshot.empty) {
                        await updateDoc(doc(db, 'atp', snapshot.docs[0].id), data);
                        return snapshot.docs[0].id;
                    } else {
                        const docRef = await addDoc(collection(db, 'atp'), {
                            ...data,
                            userId,
                            createdAt: serverTimestamp()
                        });
                        return docRef.id;
                    }
                } catch (error) {
                    console.error('Error saving ATP:', error);
                    return null;
                }
            },

            async getATP(userId, mapel, kelas) {
                try {
                    const q = query(
                        collection(db, 'atp'),
                        where('userId', '==', userId),
                        where('mapel', '==', mapel),
                        where('kelas', '==', kelas)
                    );
                    const snapshot = await getDocs(q);
                    if (!snapshot.empty) {
                        return { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                    }
                    return null;
                } catch (error) {
                    console.error('Error getting ATP:', error);
                    return null;
                }
            },

            // Generic save/get for other collections
            async saveDocument(collectionName, docId, data) {
                try {
                    if (docId) {
                        await setDoc(doc(db, collectionName, docId), data, { merge: true });
                        return docId;
                    } else {
                        const docRef = await addDoc(collection(db, collectionName), {
                            ...data,
                            createdAt: serverTimestamp()
                        });
                        return docRef.id;
                    }
                } catch (error) {
                    console.error(`Error saving to ${collectionName}:`, error);
                    return null;
                }
            },

            async getDocuments(collectionName, conditions = []) {
                try {
                    let q = collection(db, collectionName);
                    if (conditions.length > 0) {
                        q = query(q, ...conditions);
                    }
                    const snapshot = await getDocs(q);
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error(`Error getting from ${collectionName}:`, error);
                    return [];
                }
            },

            async deleteDocument(collectionName, docId) {
                try {
                    await deleteDoc(doc(db, collectionName, docId));
                    return true;
                } catch (error) {
                    console.error(`Error deleting from ${collectionName}:`, error);
                    return false;
                }
            }
        };

        // ==================== CSV SERVICE ====================
        const CSVService = {
            async fetchCSV(url) {
                try {
                    const response = await fetch(url);
                    const text = await response.text();
                    return Utils.parseCSV(text);
                } catch (error) {
                    console.error('Error fetching CSV:', error);
                    return [];
                }
            },

            async loadCPData(jenjang) {
                const url = CP_LINKS[jenjang];
                if (!url) return [];
                
                const data = await this.fetchCSV(url);
                AppState.cpData = data;
                return data;
            },

            parseStudentCSV(csvText) {
                const lines = csvText.trim().split('\n');
                const students = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const values = line.split(';').map(v => v.trim());
                    if (values.length >= 2) {
                        students.push({
                            nisn: values[0] || '',
                            nama: values[1] || '',
                            jenisKelamin: values[2] || 'L',
                            tempatLahir: values[3] || '',
                            tanggalLahir: values[4] || '',
                            namaOrangTua: values[5] || '',
                            noHP: values[6] || ''
                        });
                    }
                }
                return students;
            }
        };

        // ==================== PAGE MODULES ====================
        const Pages = {
            // Dashboard Page
            Dashboard: {
                async init() {
                    const nameEl = document.getElementById('dashboardUserName');
                    if (nameEl && AppState.user) {
                        nameEl.textContent = AppState.user.displayName?.split(' ')[0] || 'Guru';
                    }

                    // Load stats
                    await this.loadStats();

                    // Quick actions
                    document.querySelectorAll('.quick-action-card').forEach(card => {
                        card.addEventListener('click', () => {
                            const action = card.dataset.action;
                            if (action) Router.navigate(action);
                        });
                    });
                },

                async loadStats() {
                    if (!AppState.user) return;

                    const students = await FirestoreService.getStudents(AppState.user.uid);
                    const classes = await FirestoreService.getClasses(AppState.user.uid);
                    
                    document.getElementById('statStudents').textContent = students.length;
                    document.getElementById('statClasses').textContent = classes.length;
                    
                    // Calculate docs and weeks
                    // ... additional stats
                }
            },

            // Profile Page
            Profile: {
                async init() {
                    await this.loadProfile();
                    this.setupForm();
                    this.setupTahunAjarPreview();
                },

                async loadProfile() {
                    if (!AppState.user) return;
                    
                    const profile = await FirestoreService.getProfile(AppState.user.uid);
                    if (profile) {
                        AppState.profile = profile;
                        this.fillForm(profile);
                    }
                },

                fillForm(profile) {
                    const fields = [
                        'tahunAjarAwal', 'namaGuru', 'nipGuru', 'linkTTDGuru',
                        'namaKepalaSekolah', 'nipKepalaSekolah', 'linkTTDKepsek',
                        'namaSatuan', 'npsn', 'jenjang', 'alamat', 'kabupaten',
                        'provinsi', 'tanggalPengesahan', 'linkLogo'
                    ];

                    fields.forEach(field => {
                        const el = document.getElementById(field);
                        if (el && profile[field]) {
                            el.value = profile[field];
                        }
                    });

                    // Update tahun ajar preview
                    if (profile.tahunAjarAwal) {
                        document.getElementById('tahunAjarPreview').textContent = 
                            Utils.formatTahunAjar(profile.tahunAjarAwal);
                    }
                },

                setupTahunAjarPreview() {
                    const input = document.getElementById('tahunAjarAwal');
                    const preview = document.getElementById('tahunAjarPreview');
                    
                    input?.addEventListener('input', () => {
                        if (input.value) {
                            preview.textContent = Utils.formatTahunAjar(input.value);
                        } else {
                            preview.textContent = '-';
                        }
                    });
                },

                setupForm() {
                    const form = document.getElementById('formProfile');
                    form?.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        const formData = new FormData(form);
                        const data = Object.fromEntries(formData.entries());
                        data.tahunAjar = Utils.formatTahunAjar(data.tahunAjarAwal);

                        const success = await FirestoreService.saveProfile(AppState.user.uid, data);
                        
                        if (success) {
                            AppState.profile = data;
                            Toast.success('Profil berhasil disimpan!');
                        } else {
                            Toast.error('Gagal menyimpan profil');
                        }
                    });
                }
            },

            // Calendar Page
            Calendar: {
                liburLokal: [],

                async init() {
                    await this.loadCalendar();
                    this.renderLiburNasional();
                    this.renderLiburLokal();
                    this.setupEventListeners();
                },

                async loadCalendar() {
                    if (!AppState.user || !AppState.profile?.tahunAjar) return;

                    const calendar = await FirestoreService.getCalendar(
                        AppState.user.uid, 
                        AppState.profile.tahunAjar
                    );

                    if (calendar) {
                        AppState.calendar = calendar;
                        this.fillForm(calendar);
                    } else {
                        // Set default dates
                        this.setDefaultDates();
                    }
                },

                setDefaultDates() {
                    const tahunAwal = AppState.profile?.tahunAjarAwal || new Date().getFullYear();
                    
                    document.getElementById('semGanjilMulai').value = `${tahunAwal}-07-15`;
                    document.getElementById('semGanjilSelesai').value = `${tahunAwal}-12-20`;
                    document.getElementById('semGenapMulai').value = `${parseInt(tahunAwal) + 1}-01-06`;
                    document.getElementById('semGenapSelesai').value = `${parseInt(tahunAwal) + 1}-06-20`;
                    document.getElementById('kelasAkhirSelesai').value = `${parseInt(tahunAwal) + 1}-04-15`;
                    
                    this.calculateMingguEfektif();
                },

                fillForm(calendar) {
                    if (calendar.semesterGanjil) {
                        document.getElementById('semGanjilMulai').value = calendar.semesterGanjil.mulai;
                        document.getElementById('semGanjilSelesai').value = calendar.semesterGanjil.selesai;
                    }
                    if (calendar.semesterGenap) {
                        document.getElementById('semGenapMulai').value = calendar.semesterGenap.mulai;
                        document.getElementById('semGenapSelesai').value = calendar.semesterGenap.selesai;
                    }
                    if (calendar.kelasAkhir) {
                        document.getElementById('kelasAkhirSelesai').value = calendar.kelasAkhir.semesterGenapSelesai;
                    }
                    if (calendar.hariLiburLokal) {
                        this.liburLokal = calendar.hariLiburLokal;
                    }
                    
                    this.calculateMingguEfektif();
                },

                renderLiburNasional() {
                    const container = document.getElementById('liburNasionalList');
                    container.innerHTML = HARI_LIBUR_NASIONAL_2024_2025.map(libur => `
                        <div class="flex items-center justify-between py-1.5 px-2 bg-red-50 rounded text-sm">
                            <span class="text-red-800">${libur.nama}</span>
                            <span class="text-red-600 text-xs">${Utils.formatTanggal(libur.tanggal, 'short')}</span>
                        </div>
                    `).join('');
                },

                renderLiburLokal() {
                    const container = document.getElementById('liburLokalList');
                    container.innerHTML = this.liburLokal.map((libur, index) => `
                        <div class="flex items-center justify-between py-1.5 px-2 bg-orange-50 rounded text-sm">
                            <span class="text-orange-800">${libur.nama}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-orange-600 text-xs">${Utils.formatTanggal(libur.tanggal, 'short')}</span>
                                <button class="text-red-500 hover:text-red-700" data-index="${index}" onclick="Pages.Calendar.removeLiburLokal(${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                },

                removeLiburLokal(index) {
                    this.liburLokal.splice(index, 1);
                    this.renderLiburLokal();
                },

                calculateMingguEfektif() {
                    const ganjilMulai = document.getElementById('semGanjilMulai').value;
                    const ganjilSelesai = document.getElementById('semGanjilSelesai').value;
                    const genapMulai = document.getElementById('semGenapMulai').value;
                    const genapSelesai = document.getElementById('semGenapSelesai').value;

                    if (ganjilMulai && ganjilSelesai) {
                        const weeks = Utils.getWeeksBetween(ganjilMulai, ganjilSelesai);
                        document.getElementById('mingguEfektifGanjil').textContent = weeks;
                    }

                    if (genapMulai && genapSelesai) {
                        const weeks = Utils.getWeeksBetween(genapMulai, genapSelesai);
                        document.getElementById('mingguEfektifGenap').textContent = weeks;
                    }
                },

                setupEventListeners() {
                    // Date change listeners
                    ['semGanjilMulai', 'semGanjilSelesai', 'semGenapMulai', 'semGenapSelesai'].forEach(id => {
                        document.getElementById(id)?.addEventListener('change', () => this.calculateMingguEfektif());
                    });

                    // Add local holiday button
                    document.getElementById('btnAddLiburLokal')?.addEventListener('click', () => {
                        const modal = Modal.open('tplModalHoliday');
                        const form = document.getElementById('formHoliday');
                        
                        form?.addEventListener('submit', (e) => {
                            e.preventDefault();
                            const tanggal = document.getElementById('holidayDate').value;
                            const nama = document.getElementById('holidayName').value;
                            
                            if (tanggal && nama) {
                                this.liburLokal.push({ tanggal, nama });
                                this.renderLiburLokal();
                                Modal.close();
                                Toast.success('Libur lokal ditambahkan');
                            }
                        });
                    });

                    // Save calendar
                    document.getElementById('btnSaveCalendar')?.addEventListener('click', async () => {
                        const data = {
                            tahunAjar: AppState.profile?.tahunAjar,
                            jenjang: AppState.profile?.jenjang,
                            hariLiburNasional: HARI_LIBUR_NASIONAL_2024_2025,
                            hariLiburLokal: this.liburLokal,
                            semesterGanjil: {
                                mulai: document.getElementById('semGanjilMulai').value,
                                selesai: document.getElementById('semGanjilSelesai').value,
                                mingguEfektif: parseInt(document.getElementById('mingguEfektifGanjil').textContent)
                            },
                            semesterGenap: {
                                mulai: document.getElementById('semGenapMulai').value,
                                selesai: document.getElementById('semGenapSelesai').value,
                                mingguEfektif: parseInt(document.getElementById('mingguEfektifGenap').textContent)
                            },
                            kelasAkhir: {
                                semesterGenapSelesai: document.getElementById('kelasAkhirSelesai').value,
                                kelas: AppState.profile?.jenjang === 'SD' ? [6] : 
                                       AppState.profile?.jenjang === 'SMP' ? [9] : [12]
                            }
                        };

                        const success = await FirestoreService.saveCalendar(AppState.user.uid, data);
                        if (success) {
                            AppState.calendar = data;
                            Toast.success('Kalender berhasil disimpan!');
                        } else {
                            Toast.error('Gagal menyimpan kalender');
                        }
                    });
                }
            },

            // Schedule Page
            Schedule: {
                jadwalEntries: [],
                currentSemester: 1,

                async init() {
                    this.setupSemesterSelector();
                    await this.loadSchedule();
                    this.setupEventListeners();
                },

                setupSemesterSelector() {
                    document.getElementById('selectSemesterSchedule')?.addEventListener('change', (e) => {
                        this.currentSemester = parseInt(e.target.value);
                        this.loadSchedule();
                    });
                },

                async loadSchedule() {
                    if (!AppState.user) return;

                    const schedules = await FirestoreService.getSchedules(AppState.user.uid, this.currentSemester);
                    
                    if (schedules.length > 0 && schedules[0].jadwal) {
                        this.jadwalEntries = schedules[0].jadwal;
                        
                        // Fill settings
                        document.getElementById('durasiJam').value = schedules[0].durasiJam || 35;
                        document.getElementById('jamMulai').value = schedules[0].jamMulai || '07:00';
                        document.getElementById('jumlahJam').value = schedules[0].jumlahJam || 8;
                    } else {
                        this.jadwalEntries = [];
                    }
                    
                    this.renderTable();
                },

                renderTable() {
                    const tbody = document.getElementById('scheduleTableBody');
                    const emptyState = document.getElementById('scheduleEmpty');
                    
                    if (this.jadwalEntries.length === 0) {
                        tbody.innerHTML = '';
                        emptyState?.classList.remove('hidden');
                        return;
                    }

                    emptyState?.classList.add('hidden');
                    
                    const durasiJam = parseInt(document.getElementById('durasiJam').value) || 35;
                    const jamMulai = document.getElementById('jamMulai').value || '07:00';
                    
                    tbody.innerHTML = this.jadwalEntries.map((entry, index) => {
                        const waktu = Utils.calculateTime(jamMulai, durasiJam, entry.jamKe);
                        return `
                            <tr>
                                <td class="px-4 py-3 text-sm">${entry.hari}</td>
                                <td class="px-4 py-3 text-sm">${entry.jamKe}${entry.jamKeSelesai ? '-' + entry.jamKeSelesai : ''}</td>
                                <td class="px-4 py-3 text-sm text-gray-500">${waktu.mulai} - ${waktu.selesai}</td>
                                <td class="px-4 py-3 text-sm font-medium">${entry.kelas}</td>
                                <td class="px-4 py-3 text-sm">${entry.mapel}</td>
                                <td class="px-4 py-3 text-center">
                                    <button class="text-red-500 hover:text-red-700" onclick="Pages.Schedule.removeEntry(${index})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                },

                removeEntry(index) {
                    this.jadwalEntries.splice(index, 1);
                    this.renderTable();
                },

                checkConflict(newEntry) {
                    const conflicts = [];
                    
                    for (const entry of this.jadwalEntries) {
                        if (entry.hari !== newEntry.hari) continue;
                        
                        // Check jam overlap
                        const newStart = newEntry.jamKe;
                        const newEnd = newEntry.jamKeSelesai || newEntry.jamKe;
                        const existStart = entry.jamKe;
                        const existEnd = entry.jamKeSelesai || entry.jamKe;
                        
                        const hasOverlap = !(newEnd < existStart || newStart > existEnd);
                        
                        if (hasOverlap) {
                            // Same class, different subject at same time
                            if (entry.kelas === newEntry.kelas && entry.mapel !== newEntry.mapel) {
                                conflicts.push(`Kelas ${entry.kelas} sudah ada mapel ${entry.mapel} di jam tersebut`);
                            }
                            // Same subject, different class at same time (teacher conflict)
                            if (entry.mapel === newEntry.mapel && entry.kelas !== newEntry.kelas) {
                                conflicts.push(`Anda sudah mengajar ${entry.mapel} di kelas ${entry.kelas} pada jam tersebut`);
                            }
                        }
                    }
                    
                    return conflicts;
                },

                async setupEventListeners() {
                    // Load classes for modal
                    const classes = await FirestoreService.getClasses(AppState.user.uid);
                    AppState.classes = classes;

                    // Add schedule button
                    document.getElementById('btnAddScheduleEntry')?.addEventListener('click', async () => {
                        const modal = Modal.open('tplModalScheduleEntry');
                        
                        // Populate class dropdown
                        const kelasSelect = document.getElementById('scheduleKelas');
                        kelasSelect.innerHTML = '<option value="">Pilih Kelas</option>' + 
                            classes.map(c => `<option value="${c.nama}">${c.nama}</option>`).join('');
                        
                        // Populate mapel from CP data
                        const mapels = [...new Set(AppState.cpData.map(cp => cp['Mata Pelajaran']))].filter(Boolean);
                        const mapelSelect = document.getElementById('scheduleMapel');
                        mapelSelect.innerHTML = '<option value="">Pilih Mapel</option>' + 
                            mapels.map(m => `<option value="${m}">${m}</option>`).join('');

                        // Form submit
                        document.getElementById('formScheduleEntry')?.addEventListener('submit', (e) => {
                            e.preventDefault();
                            
                            const newEntry = {
                                hari: document.getElementById('scheduleHari').value,
                                jamKe: parseInt(document.getElementById('scheduleJamMulai').value),
                                jamKeSelesai: parseInt(document.getElementById('scheduleJamSelesai').value),
                                kelas: document.getElementById('scheduleKelas').value,
                                mapel: document.getElementById('scheduleMapel').value
                            };

                            // Check conflicts
                            const conflicts = this.checkConflict(newEntry);
                            if (conflicts.length > 0) {
                                document.getElementById('conflictWarning').classList.remove('hidden');
                                document.getElementById('conflictMessage').textContent = conflicts.join('. ');
                                return;
                            }

                            this.jadwalEntries.push(newEntry);
                            this.renderTable();
                            Modal.close();
                            Toast.success('Jadwal ditambahkan');
                        });
                    });

                    // Duration change
                    document.getElementById('durasiJam')?.addEventListener('change', () => this.renderTable());
                    document.getElementById('jamMulai')?.addEventListener('change', () => this.renderTable());

                    // Save schedule
                    document.getElementById('btnSaveSchedule')?.addEventListener('click', async () => {
                        const data = {
                            tahunAjar: AppState.profile?.tahunAjar,
                            semester: this.currentSemester,
                            durasiJam: parseInt(document.getElementById('durasiJam').value),
                            jamMulai: document.getElementById('jamMulai').value,
                            jumlahJam: parseInt(document.getElementById('jumlahJam').value),
                            jadwal: this.jadwalEntries
                        };

                        const success = await FirestoreService.saveSchedule(AppState.user.uid, data);
                        if (success) {
                            Toast.success('Jadwal berhasil disimpan!');
                        } else {
                            Toast.error('Gagal menyimpan jadwal');
                        }
                    });
                }
            },

            // Students Page
            Students: {
                async init() {
                    await this.loadClasses();
                    await this.loadStudents();
                    this.setupEventListeners();
                },

                async loadClasses() {
                    if (!AppState.user) return;
                    
                    const classes = await FirestoreService.getClasses(AppState.user.uid);
                    AppState.classes = classes;
                    
                    const select = document.getElementById('studentFilterKelas');
                    select.innerHTML = '<option value="">Semua Kelas</option>' + 
                        classes.map(c => `<option value="${c.id}">${c.nama}</option>`).join('');
                },

                async loadStudents(classId = null) {
                    if (!AppState.user) return;
                    
                    const students = await FirestoreService.getStudents(AppState.user.uid, classId);
                    AppState.students = students;
                    this.renderTable(students);
                },

                renderTable(students) {
                    const tbody = document.getElementById('studentsTableBody');
                    const emptyState = document.getElementById('studentsEmpty');
                    const countEl = document.getElementById('studentCount');
                    
                    countEl.textContent = `${students.length} siswa`;
                    
                    if (students.length === 0) {
                        tbody.innerHTML = '';
                        emptyState?.classList.remove('hidden');
                        return;
                    }

                    emptyState?.classList.add('hidden');
                    
                    // Get class names
                    const classMap = {};
                    AppState.classes.forEach(c => classMap[c.id] = c.nama);
                    
                    tbody.innerHTML = students.map((student, index) => `
                        <tr>
                            <td class="px-4 py-3 text-sm">${index + 1}</td>
                            <td class="px-4 py-3 text-sm font-mono">${student.nisn}</td>
                            <td class="px-4 py-3 text-sm font-medium">${student.nama}</td>
                            <td class="px-4 py-3 text-sm text-center">${student.jenisKelamin}</td>
                            <td class="px-4 py-3 text-sm">${classMap[student.classId] || '-'}</td>
                            <td class="px-4 py-3 text-center">
                                <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="Pages.Students.editStudent('${student.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-red-500 hover:text-red-700" onclick="Pages.Students.deleteStudent('${student.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                },

                editStudent(id) {
                    // TODO: Implement edit
                    Toast.info('Fitur edit akan segera hadir');
                },

                async deleteStudent(id) {
                    if (confirm('Yakin ingin menghapus siswa ini?')) {
                        const success = await FirestoreService.deleteDocument('students', id);
                        if (success) {
                            Toast.success('Siswa dihapus');
                            this.loadStudents(document.getElementById('studentFilterKelas').value || null);
                        }
                    }
                },

                setupEventListeners() {
                    // Filter by class
                    document.getElementById('studentFilterKelas')?.addEventListener('change', (e) => {
                        this.loadStudents(e.target.value || null);
                    });

                    // Search
                    document.getElementById('studentSearch')?.addEventListener('input', Utils.debounce((e) => {
                        const query = e.target.value.toLowerCase();
                        const filtered = AppState.students.filter(s => 
                            s.nama.toLowerCase().includes(query) || 
                            s.nisn.includes(query)
                        );
                        this.renderTable(filtered);
                    }, 300));

                    // Add class button
                    document.getElementById('btnAddClass')?.addEventListener('click', () => {
                        const modal = Modal.open('tplModalClass');
                        
                        // Populate tingkat based on jenjang
                        const jenjang = AppState.profile?.jenjang || 'SMP';
                        const tingkats = KELAS_PER_JENJANG[jenjang];
                        const tingkatSelect = document.getElementById('classTingkat');
                        tingkatSelect.innerHTML = '<option value="">Pilih Tingkat</option>' + 
                            tingkats.map(t => `<option value="${t}">${t}</option>`).join('');
                        
                        // Auto-fill fase
                        tingkatSelect.addEventListener('change', () => {
                            const fase = FASE_PER_KELAS[tingkatSelect.value] || '';
                            document.getElementById('classFase').value = fase;
                        });

                        // Form submit
                        document.getElementById('formClass')?.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            
                            const data = {
                                nama: document.getElementById('classNama').value,
                                tingkat: parseInt(document.getElementById('classTingkat').value),
                                fase: document.getElementById('classFase').value,
                                waliKelas: document.getElementById('classWali').value,
                                tahunAjar: AppState.profile?.tahunAjar,
                                jumlahSiswa: 0
                            };

                            const id = await FirestoreService.addClass(AppState.user.uid, data);
                            if (id) {
                                Toast.success('Kelas berhasil ditambahkan');
                                Modal.close();
                                this.loadClasses();
                            }
                        });
                    });

                    // Add student button
                    document.getElementById('btnAddStudent')?.addEventListener('click', () => {
                        const modal = Modal.open('tplModalStudent');
                        
                        // Populate class dropdown
                        const kelasSelect = document.getElementById('studentKelas');
                        kelasSelect.innerHTML = '<option value="">Pilih Kelas</option>' + 
                            AppState.classes.map(c => `<option value="${c.id}">${c.nama}</option>`).join('');

                        // Form submit
                        document.getElementById('formStudent')?.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            
                            const data = {
                                classId: document.getElementById('studentKelas').value,
                                nisn: document.getElementById('studentNISN').value,
                                nama: document.getElementById('studentNama').value,
                                jenisKelamin: document.getElementById('studentJK').value,
                                tempatLahir: document.getElementById('studentTempatLahir').value,
                                tanggalLahir: document.getElementById('studentTanggalLahir').value,
                                namaOrangTua: document.getElementById('studentOrtu').value,
                                noHP: document.getElementById('studentHP').value
                            };

                            const id = await FirestoreService.addStudent(AppState.user.uid, data);
                            if (id) {
                                Toast.success('Siswa berhasil ditambahkan');
                                Modal.close();
                                this.loadStudents();
                            }
                        });
                    });

                    // Import CSV button
                    document.getElementById('btnImportStudents')?.addEventListener('click', () => {
                        const modal = Modal.open('tplModalImportCSV');
                        
                        // Populate class dropdown
                        const kelasSelect = document.getElementById('importKelas');
                        kelasSelect.innerHTML = '<option value="">Pilih Kelas</option>' + 
                            AppState.classes.map(c => `<option value="${c.id}">${c.nama}</option>`).join('');

                        // Preview button
                        document.getElementById('btnPreviewImport')?.addEventListener('click', async () => {
                            const csvData = document.getElementById('importCSVData').value;
                            const csvUrl = document.getElementById('importURL').value;
                            
                            let students = [];
                            
                            if (csvData.trim()) {
                                students = CSVService.parseStudentCSV(csvData);
                            } else if (csvUrl) {
                                const data = await CSVService.fetchCSV(csvUrl);
                                students = data.map(row => ({
                                    nisn: row.NISN || row.nisn || '',
                                    nama: row.Nama || row.nama || '',
                                    jenisKelamin: row.JenisKelamin || row.jk || 'L',
                                    tempatLahir: row.TempatLahir || '',
                                    tanggalLahir: row.TanggalLahir || '',
                                    namaOrangTua: row.NamaOrtu || '',
                                    noHP: row.NoHP || ''
                                }));
                            }
                            
                            if (students.length > 0) {
                                document.getElementById('importPreview').classList.remove('hidden');
                                document.getElementById('importPreviewCount').textContent = students.length;
                                document.getElementById('importPreviewList').innerHTML = 
                                    students.slice(0, 5).map(s => `<li>${s.nisn} - ${s.nama}</li>`).join('') +
                                    (students.length > 5 ? `<li>... dan ${students.length - 5} lainnya</li>` : '');
                                
                                document.getElementById('btnConfirmImport').classList.remove('hidden');
                                document.getElementById('btnConfirmImport').onclick = async () => {
                                    const classId = document.getElementById('importKelas').value;
                                    if (!classId) {
                                        Toast.warning('Pilih kelas tujuan terlebih dahulu');
                                        return;
                                    }
                                    
                                    const studentsWithClass = students.map(s => ({ ...s, classId }));
                                    const success = await FirestoreService.addStudentsBatch(
                                        AppState.user.uid, 
                                        studentsWithClass
                                    );
                                    
                                    if (success) {
                                        Toast.success(`${students.length} siswa berhasil diimport`);
                                        Modal.close();
                                        this.loadStudents();
                                    }
                                };
                            } else {
                                Toast.warning('Tidak ada data valid untuk diimport');
                            }
                        });
                    });
                }
            },

            // CP Database Page
            CPDatabase: {
                async init() {
                    this.setupFilters();
                    this.setupCustomCP();
                },

                setupFilters() {
                    const jenjangSelect = document.getElementById('cpFilterJenjang');
                    const mapelSelect = document.getElementById('cpFilterMapel');
                    const kelasSelect = document.getElementById('cpFilterKelas');

                    jenjangSelect?.addEventListener('change', async () => {
                        const jenjang = jenjangSelect.value;
                        if (!jenjang) return;

                        // Enable and populate kelas
                        const kelasList = KELAS_PER_JENJANG[jenjang];
                        kelasSelect.disabled = false;
                        kelasSelect.innerHTML = '<option value="">Semua Kelas</option>' + 
                            kelasList.map(k => `<option value="${k}">${k}</option>`).join('');

                        // Load CP data
                        document.getElementById('cpLoading').classList.remove('hidden');
                        document.getElementById('cpTableContainer').classList.add('hidden');
                        
                        const cpData = await CSVService.loadCPData(jenjang);
                        
                        // Populate mapel
                        const mapels = [...new Set(cpData.map(cp => cp['Mata Pelajaran']))].filter(Boolean).sort();
                        mapelSelect.disabled = false;
                        mapelSelect.innerHTML = '<option value="">Semua Mapel</option>' + 
                            mapels.map(m => `<option value="${m}">${m}</option>`).join('');

                        document.getElementById('cpLoading').classList.add('hidden');
                    });

                    // Load CP button
                    document.getElementById('btnLoadCP')?.addEventListener('click', () => {
                        const mapel = mapelSelect.value;
                        const kelas = kelasSelect.value;
                        
                        let filtered = AppState.cpData;
                        
                        if (mapel) {
                            filtered = filtered.filter(cp => cp['Mata Pelajaran'] === mapel);
                        }
                        if (kelas) {
                            filtered = filtered.filter(cp => cp['Kelas'] === kelas);
                        }
                        
                        this.renderTable(filtered);
                    });
                },

                renderTable(data) {
                    const container = document.getElementById('cpTableContainer');
                    const tbody = document.getElementById('cpTableBody');
                    const countEl = document.getElementById('cpCount');
                    
                    container.classList.remove('hidden');
                    countEl.textContent = `${data.length} data`;
                    
                    tbody.innerHTML = data.map(cp => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm">${cp['Fase'] || '-'}</td>
                            <td class="px-4 py-3 text-sm">${cp['Kelas'] || '-'}</td>
                            <td class="px-4 py-3 text-sm">${cp['Semester'] || '-'}</td>
                            <td class="px-4 py-3 text-sm">${cp['Elemen/Bab'] || '-'}</td>
                            <td class="px-4 py-3 text-sm">${cp['CP Panjang'] || '-'}</td>
                            <td class="px-4 py-3 text-sm">${cp['TP'] || '-'}</td>
                            <td class="px-4 py-3 text-sm text-xs">${cp['8 Dimensi Profil Lulusan'] || '-'}</td>
                        </tr>
                    `).join('');
                },

                setupCustomCP() {
                    document.getElementById('btnImportCustomCP')?.addEventListener('click', () => {
                        const csvText = document.getElementById('customCPInput').value;
                        if (!csvText.trim()) {
                            Toast.warning('Masukkan data CSV terlebih dahulu');
                            return;
                        }

                        try {
                            const customData = Utils.parseCSV(csvText);
                            if (customData.length > 0) {
                                AppState.cpData = [...AppState.cpData, ...customData];
                                Toast.success(`${customData.length} CP berhasil diimport`);
                                this.renderTable(AppState.cpData);
                            }
                        } catch (error) {
                            Toast.error('Format CSV tidak valid');
                        }
                    });
                }
            },

            // ATP Page
            ATP: {
                async init() {
                    await this.setupFilters();
                    this.setupEventListeners();
                },

                async setupFilters() {
                    // Populate tahun ajar
                    document.getElementById('atpTahunAjar').value = AppState.profile?.tahunAjar || '';
                    
                    // Load CP data if not loaded
                    if (AppState.cpData.length === 0 && AppState.profile?.jenjang) {
                        await CSVService.loadCPData(AppState.profile.jenjang);
                    }
                    
                    // Populate mapel
                    const mapels = [...new Set(AppState.cpData.map(cp => cp['Mata Pelajaran']))].filter(Boolean).sort();
                    const mapelSelect = document.getElementById('atpFilterMapel');
                    mapelSelect.innerHTML = '<option value="">Pilih Mapel</option>' + 
                        mapels.map(m => `<option value="${m}">${m}</option>`).join('');

                    // Populate kelas
                    const kelasList = KELAS_PER_JENJANG[AppState.profile?.jenjang || 'SMP'];
                    const kelasSelect = document.getElementById('atpFilterKelas');
                    kelasSelect.innerHTML = '<option value="">Pilih Kelas</option>' + 
                        kelasList.map(k => `<option value="${k}">${k}</option>`).join('');

                    // Auto-fill fase
                    kelasSelect.addEventListener('change', () => {
                        const fase = FASE_PER_KELAS[kelasSelect.value] || '';
                        document.getElementById('atpFilterFase').value = fase;
                    });
                },

                setupEventListeners() {
                    document.getElementById('btnGenerateATP')?.addEventListener('click', () => this.generateATP());
                    document.getElementById('btnPrintATP')?.addEventListener('click', () => this.printATP());
                },

                async generateATP() {
                    const mapel = document.getElementById('atpFilterMapel').value;
                    const kelas = document.getElementById('atpFilterKelas').value;
                    
                    if (!mapel || !kelas) {
                        Toast.warning('Pilih mapel dan kelas terlebih dahulu');
                        return;
                    }

                    // Filter CP data
                    const filtered = AppState.cpData.filter(cp => 
                        cp['Mata Pelajaran'] === mapel && 
                        cp['Kelas'] === kelas
                    );

                    if (filtered.length === 0) {
                        Toast.warning('Tidak ada data CP untuk filter yang dipilih');
                        return;
                    }

                    // Generate ATP items
                    const atpItems = filtered.map((cp, index) => ({
                        semester: parseInt(cp['Semester']) || 1,
                        elemen: cp['Elemen/Bab'] || '',
                        cp: cp['CP Panjang'] || '',
                        tp: cp['TP'] || '',
                        jpPerTP: 4, // Default JP per TP
                        dimensi: cp['8 Dimensi Profil Lulusan'] || '',
                        urutan: index + 1
                    }));

                    // Save ATP
                    const atpData = {
                        tahunAjar: AppState.profile?.tahunAjar,
                        mapel,
                        kelas,
                        fase: FASE_PER_KELAS[kelas] || '',
                        items: atpItems,
                        status: 'draft'
                    };

                    const atpId = await FirestoreService.saveATP(AppState.user.uid, atpData);
                    
                    if (atpId) {
                        Toast.success('ATP berhasil di-generate!');
                        this.renderTable(atpItems);
                    }
                },

                renderTable(items) {
                    document.getElementById('atpEmpty').classList.add('hidden');
                    document.getElementById('atpTableContainer').classList.remove('hidden');
                    
                    const tbody = document.getElementById('atpTableBody');
                    tbody.innerHTML = items.map((item, index) => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm">${index + 1}</td>
                            <td class="px-4 py-3 text-sm">${item.semester}</td>
                            <td class="px-4 py-3 text-sm">${item.elemen}</td>
                            <td class="px-4 py-3 text-sm">${item.cp}</td>
                            <td class="px-4 py-3 text-sm">${item.tp}</td>
                            <td class="px-4 py-3 text-sm text-center">
                                <input type="number" value="${item.jpPerTP}" min="1" max="20" 
                                    class="w-16 px-2 py-1 border rounded text-center" 
                                    data-index="${index}">
                            </td>
                            <td class="px-4 py-3 text-sm text-xs">${item.dimensi}</td>
                        </tr>
                    `).join('');
                },

                printATP() {
                    Toast.info('Fitur cetak akan segera hadir');
                }
            },

            // Prota Page
            Prota: {
                async init() {
                    await this.setupFilters();
                    this.setupEventListeners();
                },

                async setupFilters() {
                    // Similar to ATP
                    document.getElementById('protaTahunAjar').value = AppState.profile?.tahunAjar || '';
                    
                    if (AppState.cpData.length === 0 && AppState.profile?.jenjang) {
                        await CSVService.loadCPData(AppState.profile.jenjang);
                    }
                    
                    const mapels = [...new Set(AppState.cpData.map(cp => cp['Mata Pelajaran']))].filter(Boolean).sort();
                    document.getElementById('protaFilterMapel').innerHTML = '<option value="">Pilih Mapel</option>' + 
                        mapels.map(m => `<option value="${m}">${m}</option>`).join('');

                    const kelasList = KELAS_PER_JENJANG[AppState.profile?.jenjang || 'SMP'];
                    document.getElementById('protaFilterKelas').innerHTML = '<option value="">Pilih Kelas</option>' + 
                        kelasList.map(k => `<option value="${k}">${k}</option>`).join('');
                },

                setupEventListeners() {
                    document.getElementById('btnGenerateProta')?.addEventListener('click', () => this.generateProta());
                    document.getElementById('btnPrintProta')?.addEventListener('click', () => this.printProta());
                },

                async generateProta() {
                    const mapel = document.getElementById('protaFilterMapel').value;
                    const kelas = document.getElementById('protaFilterKelas').value;
                    
                    if (!mapel || !kelas) {
                        Toast.warning('Pilih mapel dan kelas terlebih dahulu');
                        return;
                    }

                    // Get ATP data
                    const atp = await FirestoreService.getATP(AppState.user.uid, mapel, kelas);
                    
                    if (!atp) {
                        Toast.warning('Generate ATP terlebih dahulu');
                        return;
                    }

                    // Generate Prota from ATP
                    const distribusi = [];
                    const bulanGanjil = ['Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                    const bulanGenap = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni'];
                    
                    let mingguKe = 1;
                    
                    // Semester 1
                    const itemsSem1 = atp.items.filter(i => i.semester === 1);
                    bulanGanjil.forEach(bulan => {
                        for (let w = 1; w <= 4; w++) {
                            const item = itemsSem1[mingguKe - 1];
                            if (item) {
                                distribusi.push({
                                    semester: 1,
                                    bulan,
                                    mingguKe: w,
                                    jp: item.jpPerTP,
                                    materi: item.tp,
                                    tp: item.tp,
                                    keterangan: ''
                                });
                            }
                            mingguKe++;
                        }
                    });

                    // Semester 2
                    mingguKe = 1;
                    const itemsSem2 = atp.items.filter(i => i.semester === 2);
                    bulanGenap.forEach(bulan => {
                        for (let w = 1; w <= 4; w++) {
                            const item = itemsSem2[mingguKe - 1];
                            if (item) {
                                distribusi.push({
                                    semester: 2,
                                    bulan,
                                    mingguKe: w,
                                    jp: item.jpPerTP,
                                    materi: item.tp,
                                    tp: item.tp,
                                    keterangan: ''
                                });
                            }
                            mingguKe++;
                        }
                    });

                    // Save Prota
                    const protaData = {
                        userId: AppState.user.uid,
                        atpId: atp.id,
                        tahunAjar: AppState.profile?.tahunAjar,
                        mapel,
                        kelas,
                        distribusi
                    };

                    await FirestoreService.saveDocument('prota', null, protaData);
                    Toast.success('Prota berhasil di-generate!');
                    this.renderTable(distribusi);
                },

                renderTable(distribusi) {
                    document.getElementById('protaEmpty').classList.add('hidden');
                    document.getElementById('protaTableContainer').classList.remove('hidden');
                    
                    const tbody = document.getElementById('protaTableBody');
                    tbody.innerHTML = distribusi.map(item => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm">${item.semester}</td>
                            <td class="px-4 py-3 text-sm">${item.bulan}</td>
                            <td class="px-4 py-3 text-sm">${item.mingguKe}</td>
                            <td class="px-4 py-3 text-sm text-center">${item.jp}</td>
                            <td class="px-4 py-3 text-sm">${item.materi}</td>
                            <td class="px-4 py-3 text-sm">${item.keterangan}</td>
                        </tr>
                    `).join('');
                },

                printProta() {
                    Toast.info('Fitur cetak akan segera hadir');
                }
            },

            // Promes Page (Premium)
            Promes: {
                async init() {
                    // Similar structure to ATP/Prota but with calendar integration
                    Toast.info('Promes akan sync dengan Kalender & Jadwal');
                    // Implementation similar to above
                },
            },

            // Modul Ajar Page (Premium)
            ModulAjar: {
                async init() {
                    this.setupEventListeners();
                    await this.loadModuls();
                },

                setupEventListeners() {
                    document.getElementById('btnNewModul')?.addEventListener('click', () => {
                        Modal.open('tplModalModulAjar');
                        // Setup form handlers
                    });
                },

                async loadModuls() {
                    // Load existing moduls
                }
            },

            // Jurnal Page (Premium)
            Jurnal: {
                async init() {
                    this.setupEventListeners();
                },

                setupEventListeners() {
                    document.getElementById('btnGenerateJurnal')?.addEventListener('click', () => {
                        Toast.info('Jurnal akan di-generate dari Promes');
                    });
                }
            },

            // KKTP Page (Premium)
            KKTP: {
                async init() {
                    this.setupEventListeners();
                },

                setupEventListeners() {
                    document.getElementById('btnSyncKKTP')?.addEventListener('click', () => {
                        Toast.info('KKTP akan sync dengan TP dari Promes');
                    });
                }
            },

            // Nilai Page (Premium)
            Nilai: {
                async init() {
                    this.setupEventListeners();
                },

                setupEventListeners() {
                    document.getElementById('btnLoadNilai')?.addEventListener('click', () => {
                        Toast.info('Data nilai akan dimuat');
                    });
                }
            },

            // AI Assistant Page
            AIAssistant: {
                init() {
                    this.setupEventListeners();
                },

                setupEventListeners() {
                    document.querySelectorAll('[data-ai-action]').forEach(card => {
                        card.addEventListener('click', () => {
                            const action = card.dataset.aiAction;
                            this.handleAction(action);
                        });
                    });
                },

                handleAction(action) {
                    const outputContent = document.getElementById('aiOutputContent');
                    const copyBtn = document.getElementById('btnCopyAIOutput');
                    
                    let output = '';
                    
                    switch (action) {
                        case 'student-csv':
                            output = 'NISN;Nama;JenisKelamin;TempatLahir;TanggalLahir;NamaOrtu;NoHP\n';
                            output += '0012345678;Ahmad Fauzi;L;Jakarta;2010-05-15;Budi Santoso;081234567890\n';
                            output += '0012345679;Siti Aminah;P;Bandung;2010-03-22;Dewi Lestari;081234567891';
                            break;
                        case 'cp-csv':
                            output = 'Mata Pelajaran;Fase;Kelas;Semester;Elemen/Bab;CP Panjang;TP;8 Dimensi Profil Lulusan\n';
                            output += 'Matematika;D;7;1;Bilangan;Siswa dapat memahami...;Siswa mampu menghitung...;Bernalar Kritis';
                            break;
                        case 'convert-material':
                            output = '// Paste materi mentah Anda, lalu gunakan format berikut:\n';
                            output += '// Judul Materi | Tujuan | Kegiatan | Asesmen\n';
                            output += '// Sistem akan mengkonversi ke format Modul Ajar';
                            break;
                        case 'generate-tp':
                            output = '// Contoh generate TP dari CP:\n';
                            output += '// CP: Siswa dapat memahami konsep bilangan bulat\n';
                            output += '// TP 1: Siswa dapat mengidentifikasi bilangan bulat positif dan negatif\n';
                            output += '// TP 2: Siswa dapat membandingkan dua bilangan bulat\n';
                            output += '// TP 3: Siswa dapat melakukan operasi hitung bilangan bulat';
                            break;
                    }
                    
                    outputContent.innerHTML = `<pre class="whitespace-pre-wrap">${output}</pre>`;
                    copyBtn.classList.remove('hidden');
                    
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(output);
                        Toast.success('Berhasil disalin ke clipboard');
                    };
                }
            },

            // Subscription Page
            Subscription: {
                init() {
                    this.setupEventListeners();
                    this.loadPricing();
                },

                async loadPricing() {
                    try {
                        const settingsDoc = await getDoc(doc(db, 'admin', 'settings'));
                        if (settingsDoc.exists()) {
                            const settings = settingsDoc.data();
                            document.getElementById('premiumPrice').textContent = 
                                (settings.premiumPrice?.personal || 99000).toLocaleString('id-ID');
                        }
                    } catch (error) {
                        console.error('Error loading pricing:', error);
                    }
                },

                setupEventListeners() {
                    document.getElementById('btnUpgradePremium')?.addEventListener('click', () => {
                        this.redirectToWhatsApp('personal');
                    });

                    document.getElementById('btnSchoolPackage')?.addEventListener('click', () => {
                        this.redirectToWhatsApp('school');
                    });
                },

                async redirectToWhatsApp(type) {
                    try {
                        const settingsDoc = await getDoc(doc(db, 'admin', 'settings'));
                        let waNumber = '6281234567890';
                        let waMessage = `Halo, saya ingin upgrade ke Premium (${type})`;
                        
                        if (settingsDoc.exists()) {
                            const settings = settingsDoc.data();
                            waNumber = settings.waNumber || waNumber;
                            waMessage = settings.waMessage || waMessage;
                        }
                        
                        waMessage += `\n\nEmail: ${AppState.user?.email}`;
                        waMessage += `\nNama: ${AppState.user?.displayName}`;
                        
                        const url = `https://wa.me/${waNumber}?text=${encodeURIComponent(waMessage)}`;
                        window.open(url, '_blank');
                    } catch (error) {
                        console.error('Error:', error);
                        Toast.error('Gagal membuka WhatsApp');
                    }
                }
            },

            // Admin Page
            Admin: {
                async init() {
                    if (!Auth.isSuperAdmin()) {
                        Router.navigate('dashboard');
                        Toast.error('Akses ditolak');
                        return;
                    }

                    await this.loadStats();
                    await this.loadSettings();
                    await this.loadSubscriptions();
                    this.setupEventListeners();
                },

                async loadStats() {
                    // Load admin statistics
                    const users = await FirestoreService.getDocuments('users');
                    const premiumUsers = users.filter(u => u.subscription?.plan === 'premium');
                    const schoolPackages = users.filter(u => u.subscription?.type === 'school');
                    
                    document.getElementById('adminStatUsers').textContent = users.length;
                    document.getElementById('adminStatPremium').textContent = premiumUsers.length;
                    document.getElementById('adminStatSchools').textContent = schoolPackages.length;
                },

                async loadSettings() {
                    try {
                        const settingsDoc = await getDoc(doc(db, 'admin', 'settings'));
                        if (settingsDoc.exists()) {
                            const settings = settingsDoc.data();
                            document.getElementById('adminWANumber').value = settings.waNumber || '';
                            document.getElementById('adminWAMessage').value = settings.waMessage || '';
                            document.getElementById('adminPricePersonal').value = settings.premiumPrice?.personal || 99000;
                            document.getElementById('adminPriceSchool').value = settings.premiumPrice?.school || 499000;
                        }
                    } catch (error) {
                        console.error('Error loading settings:', error);
                    }
                },

                async loadSubscriptions() {
                    const subs = await FirestoreService.getDocuments('admin/subscriptions');
                    const tbody = document.getElementById('adminSubscriptionTable');
                    
                    tbody.innerHTML = subs.slice(0, 10).map(sub => `
                        <tr>
                            <td class="px-4 py-3 text-sm">${sub.email}</td>
                            <td class="px-4 py-3 text-sm">${sub.type}</td>
                            <td class="px-4 py-3 text-sm">${sub.startDate ? Utils.formatTanggal(sub.startDate.toDate(), 'short') : '-'}</td>
                            <td class="px-4 py-3 text-sm">${sub.endDate ? Utils.formatTanggal(sub.endDate.toDate(), 'short') : '-'}</td>
                            <td class="px-4 py-3 text-sm">
                                <span class="px-2 py-1 text-xs rounded-full ${sub.paymentStatus === 'confirmed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${sub.paymentStatus}
                                </span>
                            </td>
                        </tr>
                    `).join('');
                },

                setupEventListeners() {
                    // Save settings
                    document.getElementById('btnSaveAdminSettings')?.addEventListener('click', async () => {
                        const settings = {
                            waNumber: document.getElementById('adminWANumber').value,
                            waMessage: document.getElementById('adminWAMessage').value,
                            premiumPrice: {
                                personal: parseInt(document.getElementById('adminPricePersonal').value),
                                school: parseInt(document.getElementById('adminPriceSchool').value)
                            },
                            updatedAt: serverTimestamp()
                        };

                        await setDoc(doc(db, 'admin', 'settings'), settings);
                        Toast.success('Pengaturan disimpan');
                    });

                    // Activate premium
                    document.getElementById('btnActivatePremium')?.addEventListener('click', async () => {
                        const email = document.getElementById('adminActivateEmail').value;
                        const type = document.getElementById('adminActivateType').value;
                        const days = parseInt(document.getElementById('adminActivateDuration').value);

                        if (!email) {
                            Toast.warning('Masukkan email user');
                            return;
                        }

                        // Find user by email
                        const users = await FirestoreService.getDocuments('users', [
                            where('email', '==', email)
                        ]);

                        if (users.length === 0) {
                            Toast.error('User tidak ditemukan');
                            return;
                        }

                        const userId = users[0].id;
                        const startDate = new Date();
                        const endDate = new Date();
                        endDate.setDate(endDate.getDate() + days);

                        // Update user subscription
                        await updateDoc(doc(db, 'users', userId), {
                            subscription: {
                                plan: 'premium',
                                type,
                                startDate: serverTimestamp(),
                                endDate,
                                status: 'active'
                            }
                        });

                        // Add to subscriptions log
                        await addDoc(collection(db, 'admin/subscriptions'), {
                            userId,
                            email,
                            type,
                            startDate: serverTimestamp(),
                            endDate,
                            paymentStatus: 'confirmed',
                            createdAt: serverTimestamp()
                        });

                        Toast.success('Premium berhasil diaktifkan');
                        this.loadStats();
                        this.loadSubscriptions();
                    });
                }
            }
        };

        // Make Pages global for onclick handlers
        window.Pages = Pages;

        // ==================== APP INITIALIZATION ====================
        const App = {
            async init() {
                Modal.init();
                
                // Auth state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        AppState.user = user;
                        
                        // Create/update user document
                        await setDoc(doc(db, 'users', user.uid), {
                            email: user.email,
                            displayName: user.displayName,
                            photoURL: user.photoURL,
                            lastLogin: serverTimestamp()
                        }, { merge: true });

                        // Check subscription
                        await Auth.checkSubscription(user.uid);
                        
                        // Load profile
                        AppState.profile = await FirestoreService.getProfile(user.uid);
                        
                        // Load CP data if profile exists
                        if (AppState.profile?.jenjang) {
                            await CSVService.loadCPData(AppState.profile.jenjang);
                        }

                        // Show main app
                        this.showMainApp(user);
                        Router.navigate('dashboard');
                    } else {
                        this.showLoginScreen();
                    }
                });

                // Login button
                document.getElementById('btnGoogleLogin')?.addEventListener('click', () => Auth.login());
            },

            showLoginScreen() {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            },

            showMainApp(user) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');

                // Update user info in sidebar
                const updateUserInfo = (prefix) => {
                    const photo = document.getElementById(`${prefix}UserPhoto`);
                    const name = document.getElementById(`${prefix}UserName`);
                    const plan = document.getElementById(`${prefix}UserPlan`);
                    
                    if (photo) photo.src = user.photoURL || '';
                    if (name) name.textContent = user.displayName || user.email;
                    if (plan) {
                        plan.textContent = AppState.subscription.plan === 'premium' ? 'Premium' : 'Free';
                        plan.className = AppState.subscription.plan === 'premium' 
                            ? 'inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800'
                            : 'inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-200 text-gray-700';
                    }
                };

                updateUserInfo('sidebar');
                updateUserInfo('mobile');

                // Show admin menu if super admin
                if (Auth.isSuperAdmin()) {
                    document.getElementById('adminMenuSection')?.classList.remove('hidden');
                                        document.getElementById('adminMenuLink')?.classList.remove('hidden');
                }

                // Setup navigation
                this.setupNavigation();
                
                // Setup sidebar toggle
                this.setupSidebar();
                
                // Setup logout
                document.getElementById('btnLogout')?.addEventListener('click', () => Auth.logout());
            },

            setupNavigation() {
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = link.dataset.page;
                        if (page) {
                            Router.navigate(page);
                            // Close sidebar on mobile
                            if (window.innerWidth < 1024) {
                                this.closeSidebar();
                            }
                        }
                    });
                });
            },

            setupSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                const toggleBtn = document.getElementById('btnToggleSidebar');
                const mobileProfileBtn = document.getElementById('btnMobileProfile');

                toggleBtn?.addEventListener('click', () => {
                    sidebar.classList.toggle('-translate-x-full');
                    overlay.classList.toggle('hidden');
                });

                overlay?.addEventListener('click', () => this.closeSidebar());

                mobileProfileBtn?.addEventListener('click', () => {
                    Router.navigate('profile');
                });
            },

            closeSidebar() {
                document.getElementById('sidebar')?.classList.add('-translate-x-full');
                document.getElementById('sidebarOverlay')?.classList.add('hidden');
            }
        };

        // Start the app
        App.init();
    </script>
</body>
</html>