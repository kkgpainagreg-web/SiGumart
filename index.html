<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGSA - Admin Guru Super App</title>
    
    <!-- Tailwind CSS CDN (untuk prototipe, ganti dengan CLI untuk production) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    
    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        dark: {
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        /* ===== BASE STYLES ===== */
        * { box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9; 
            overflow: hidden;
        }
        
        /* ===== SCROLLBAR STYLES ===== */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* ===== DOCUMENT PREVIEW STYLES ===== */
        .paper-preview {
            background: white;
            margin: 20px auto;
            padding: 20mm;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            max-width: 210mm;
            min-height: 297mm;
            position: relative;
        }
        .paper-preview.landscape {
            max-width: 297mm;
            min-height: 210mm;
        }
        
        /* ===== DOCUMENT TABLE STYLES ===== */
        .doc-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10pt;
            margin-bottom: 20px;
        }
        .doc-table th, .doc-table td {
            border: 1px solid #374151;
            padding: 6px 8px;
            text-align: left;
            vertical-align: top;
        }
        .doc-table th {
            background-color: #f1f5f9;
            font-weight: 600;
            text-align: center;
        }
        
        /* ===== EDITABLE CONTENT ===== */
        [contenteditable="true"]:hover {
            background-color: #fef9c3;
            outline: 2px dashed #eab308;
            cursor: text;
            transition: all 0.2s ease;
        }
        [contenteditable="true"]:focus {
            background-color: #fef9c3;
            outline: 2px solid #eab308;
        }
        
        /* ===== SIGNATURE AREA ===== */
        .signature-area {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            page-break-inside: avoid;
            padding: 0 3%;
        }
        .signature-box {
            text-align: center;
            font-size: 11pt;
            min-width: 220px;
        }
        .signature-name {
            text-decoration: underline;
            font-weight: bold;
            margin-top: 70px;
        }
        
        /* ===== PROMES VERTICAL TEXT ===== */
        .event-cell {
            vertical-align: middle !important;
            text-align: center !important;
            height: 140px;
            padding: 0 !important;
            background-color: #e2e8f0 !important;
        }
        .vertical-event {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            margin: auto;
            font-size: 8pt;
            font-weight: bold;
            letter-spacing: 1.5px;
            color: #1e293b;
            white-space: nowrap;
            display: inline-block;
        }
        
        /* ===== KKTP STYLES ===== */
        .kktp-val {
            background-color: #fefce8;
            font-weight: bold;
            color: #1d4ed8;
            cursor: text;
            text-align: center;
        }
        .kktp-hasil {
            background-color: #dbeafe;
            color: #1e40af;
            font-size: 11pt;
            text-align: center;
            font-weight: bold;
        }
        
        /* ===== RTL SUPPORT (Arabic) ===== */
        .rtl-support {
            direction: rtl;
            text-align: right;
            font-family: 'Traditional Arabic', 'Arabic Typesetting', serif;
        }
        
        /* ===== LOADING STATES ===== */
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ===== TOAST NOTIFICATIONS ===== */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }
        .toast.success { background: #059669; }
        .toast.error { background: #dc2626; }
        .toast.info { background: #2563eb; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* ===== MODAL STYLES ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white;
            width: 90%;
            max-width: 700px;
            border-radius: 16px;
            padding: 24px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.3s ease;
        }
        @keyframes modalIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* ===== SUBSCRIPTION BADGES ===== */
        .badge-free {
            background: linear-gradient(135deg, #94a3b8, #64748b);
        }
        .badge-premium {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        /* ===== NAVIGATION TABS ===== */
        .nav-tab {
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }
        .nav-tab:hover {
            background-color: #f1f5f9;
        }
        .nav-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            background-color: #eff6ff;
        }
        
        /* ===== PRINT STYLES ===== */
        @media print {
            body { 
                background: white; 
                overflow: visible; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
            }
            #sidebar, #topbar, .no-print, #login-screen, #super-admin-panel { 
                display: none !important; 
            }
            #main-content { 
                margin: 0; 
                padding: 0; 
                width: 100%; 
                overflow: visible; 
            }
            .paper-preview { 
                margin: 0; 
                padding: 15mm; 
                box-shadow: none; 
                max-width: 100%; 
                page-break-after: always; 
            }
            .paper-preview:last-child { 
                page-break-after: auto; 
            }
            [contenteditable="true"]:hover { 
                background-color: transparent; 
                outline: none; 
            }
            .kktp-val { 
                background-color: transparent !important; 
                color: black; 
            }
            @page { 
                size: A4; 
                margin: 0; 
            }
        }
    </style>
</head>
<body class="flex h-screen text-slate-800">

    <!-- ============================================= -->
    <!-- LOGIN SCREEN -->
    <!-- ============================================= -->
    <div id="login-screen" class="fixed inset-0 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 z-[100] flex flex-col items-center justify-center">
        <div class="text-center mb-8">
            <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/30">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                </svg>
            </div>
            <h1 class="text-4xl font-bold text-white mb-2">AGSA</h1>
            <p class="text-blue-400 font-medium">Admin Guru Super App</p>
        </div>
        
        <div class="bg-slate-800/50 backdrop-blur-xl p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 border border-slate-700">
            <h2 class="text-xl font-semibold text-white text-center mb-2">Selamat Datang</h2>
            <p class="text-slate-400 text-center mb-6 text-sm">Sistem Administrasi Cerdas untuk Guru Indonesia</p>
            
            <button id="btn-google-login" class="w-full bg-white hover:bg-gray-50 text-slate-800 font-semibold py-3.5 px-4 rounded-xl flex items-center justify-center gap-3 transition shadow-lg hover:shadow-xl active:scale-[0.98]">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Masuk dengan Google
            </button>
            
            <div class="mt-6 pt-6 border-t border-slate-700">
                <div class="flex items-center justify-center gap-4 text-xs text-slate-500">
                    <span>‚úì Gratis untuk fitur dasar</span>
                    <span>‚úì Data tersimpan aman</span>
                </div>
            </div>
        </div>
        
        <p class="text-slate-500 text-xs mt-8">¬© 2025 AGSA. Dibuat untuk Guru Indonesia.</p>
    </div>

    <!-- ============================================= -->
    <!-- SIDEBAR -->
    <!-- ============================================= -->
    <aside id="sidebar" class="w-80 min-w-[320px] bg-slate-900 text-slate-300 flex-col h-full border-r border-slate-800 hidden">
        
        <!-- Sidebar Header -->
        <div class="p-4 border-b border-slate-800">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                </div>
                <div class="flex-1">
                    <h2 class="text-lg font-bold text-white">AGSA</h2>
                    <div class="flex items-center gap-2">
                        <span id="user-plan-badge" class="px-2 py-0.5 rounded text-[10px] font-bold text-white badge-free">FREE</span>
                        <span id="user-email-display" class="text-xs text-slate-400 truncate max-w-[120px]">guest</span>
                    </div>
                </div>
                <button id="btn-logout" class="p-2 hover:bg-slate-800 rounded-lg transition" title="Logout">
                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Sidebar Content -->
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
            
            <!-- Quick Actions -->
            <div class="grid grid-cols-2 gap-2">
                <button onclick="AGSA.openModal('siswa')" class="bg-emerald-600 hover:bg-emerald-500 text-white font-semibold py-2.5 px-3 rounded-lg shadow transition flex items-center justify-center gap-2 text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                    Data Siswa
                </button>
                <button onclick="AGSA.openModal('profil')" class="bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2.5 px-3 rounded-lg shadow transition flex items-center justify-center gap-2 text-sm border border-slate-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                    Profil
                </button>
            </div>
            
            <!-- Section: Tipe Guru -->
            <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700">
                <label class="text-[10px] text-amber-400 uppercase font-bold tracking-wider">Tipe Guru</label>
                <select id="in-tipe-guru" class="w-full mt-1 bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none text-white font-semibold cursor-pointer">
                    <option value="mapel" selected>Guru Mata Pelajaran</option>
                    <option value="kelas">Guru Kelas</option>
                </select>
            </div>
            
            <!-- Section 1: Database Kurikulum -->
            <div class="bg-gradient-to-br from-amber-500/10 to-orange-500/10 rounded-xl p-3 border border-amber-500/30">
                <h3 class="text-xs font-bold text-amber-400 mb-3 flex items-center gap-2">
                    <span class="w-5 h-5 bg-amber-500 rounded-full flex items-center justify-center text-white text-[10px]">1</span>
                    DATABASE KURIKULUM
                </h3>
                <select id="in-jenjang" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-sm focus:border-amber-500 outline-none text-white font-semibold cursor-pointer mb-2">
                    <option value="SD">SD / MI</option>
                    <option value="SMP">SMP / MTs</option>
                    <option value="SMA">SMA / SMK / MA</option>
                </select>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="AGSA.Curriculum.loadFromCloud()" class="bg-amber-600 hover:bg-amber-500 text-white font-semibold py-2 rounded-lg text-xs transition flex items-center justify-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/></svg>
                        Load Cloud
                    </button>
                    <div class="relative">
                        <input type="file" accept=".csv" onchange="AGSA.Curriculum.uploadCSV(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <button class="w-full bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 rounded-lg text-xs transition border border-slate-500 flex items-center justify-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                            Upload CSV
                        </button>
                    </div>
                </div>
                <div id="csv-status" class="hidden mt-2 p-2 rounded-lg text-xs"></div>
            </div>
            
            <!-- Section 2: Pilih Mapel & Kelas -->
            <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700">
                <h3 class="text-xs font-bold text-blue-400 mb-3 flex items-center gap-2">
                    <span class="w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center text-white text-[10px]">2</span>
                    PILIH MAPEL & KELAS
                </h3>
                <div class="space-y-2">
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-semibold">Mata Pelajaran</label>
                        <select id="in-mapel" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-sm focus:border-blue-500 outline-none font-semibold text-blue-400 cursor-pointer">
                            <option value="">-- Pilih Mata Pelajaran --</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-semibold">Kelas</label>
                            <select id="in-kelas" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-sm focus:border-blue-500 outline-none cursor-pointer">
                                <option value="">-</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-semibold">Semester</label>
                            <select id="in-semester" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-sm focus:border-blue-500 outline-none cursor-pointer">
                                <option value="">-</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-semibold">Bab / Elemen (untuk Modul)</label>
                        <select id="in-elemen" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-sm focus:border-blue-500 outline-none cursor-pointer">
                            <option value="">-</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Section 3: Identitas Sekolah -->
            <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700">
                <h3 class="text-xs font-bold text-emerald-400 mb-3 flex items-center gap-2">
                    <span class="w-5 h-5 bg-emerald-500 rounded-full flex items-center justify-center text-white text-[10px]">3</span>
                    IDENTITAS SEKOLAH
                </h3>
                <div class="space-y-2">
                    <input type="text" id="in-sekolah" placeholder="Nama Sekolah" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-sm focus:border-emerald-500 outline-none" value="SDN Cerdas Bangsa">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="in-kepsek" placeholder="Nama Kepala Sekolah" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-sm focus:border-emerald-500 outline-none" value="Budi, S.Pd., M.Pd.">
                        <input type="text" id="in-nip-kepsek" placeholder="NIP Kepsek" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-sm focus:border-emerald-500 outline-none" value="19800101 200501 1 001">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="in-guru" placeholder="Nama Guru" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-sm focus:border-emerald-500 outline-none" value="Siti Aminah, S.Pd.">
                        <input type="text" id="in-nip-guru" placeholder="NIP Guru" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-sm focus:border-emerald-500 outline-none" value="19900202 201502 2 002">
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <input type="text" id="in-rombel" placeholder="Rombel" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-sm focus:border-emerald-500 outline-none text-center" value="A">
                        <input type="number" id="in-tahun" placeholder="Tahun" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-sm focus:border-emerald-500 outline-none text-center" value="2025">
                        <input type="text" id="in-tempat" placeholder="Kota" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-sm focus:border-emerald-500 outline-none text-center" value="Jakarta">
                    </div>
                </div>
            </div>
            
            <!-- Section 4: Kalender Pendidikan -->
            <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700">
                <h3 class="text-xs font-bold text-purple-400 mb-3 flex items-center gap-2">
                    <span class="w-5 h-5 bg-purple-500 rounded-full flex items-center justify-center text-white text-[10px]">4</span>
                    KALENDER & JADWAL
                </h3>
                <div class="space-y-2">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-semibold">Hari Mengajar</label>
                            <select id="in-hari" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-sm focus:border-purple-500 outline-none cursor-pointer">
                                <option value="1" selected>Senin</option>
                                <option value="2">Selasa</option>
                                <option value="3">Rabu</option>
                                <option value="4">Kamis</option>
                                <option value="5">Jum'at</option>
                                <option value="6">Sabtu</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-semibold">JP/Pertemuan</label>
                            <input type="number" id="in-jp" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-sm focus:border-purple-500 outline-none text-center" value="4" min="1" max="10">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] text-amber-400 uppercase font-bold">Agenda & Libur (YYYY-MM-DD = Kegiatan)</label>
                        <textarea id="in-libur" rows="4" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-xs focus:border-purple-500 outline-none text-slate-200 mt-1" placeholder="2025-07-15 = MPLS">2025-07-15 = MPLS
2025-09-23 = Sumatif Tengah Smt (STS)
2025-12-09 = Sumatif Akhir Smt (SAS)
2025-12-23 = Libur Semester</textarea>
                    </div>
                </div>
            </div>
            
            <!-- Premium Upgrade Banner -->
            <div id="upgrade-banner" class="bg-gradient-to-r from-amber-500/20 to-orange-500/20 rounded-xl p-4 border border-amber-500/30">
                <div class="flex items-center gap-3 mb-2">
                    <span class="text-2xl">‚≠ê</span>
                    <div>
                        <h4 class="font-bold text-amber-400">Upgrade ke Premium</h4>
                        <p class="text-xs text-slate-400">Akses semua fitur tanpa batas</p>
                    </div>
                </div>
                <button onclick="AGSA.Subscription.upgrade()" class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold py-2.5 rounded-lg text-sm hover:from-amber-400 hover:to-orange-400 transition shadow-lg">
                    Upgrade Sekarang
                </button>
            </div>
            
        </div>
        
        <!-- Sidebar Footer -->
        <div class="p-4 border-t border-slate-800">
            <button onclick="AGSA.renderAll()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/25 transition transform active:scale-[0.98] flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                RENDER DOKUMEN
            </button>
        </div>
    </aside>

    <!-- ============================================= -->
    <!-- MAIN CONTENT AREA -->
    <!-- ============================================= -->
    <main class="flex-1 flex flex-col hidden" id="main-wrapper">
        
        <!-- Top Navigation Bar -->
        <header id="topbar" class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-4 no-print shadow-sm">
            <div class="flex items-center gap-1 overflow-x-auto">
                <button onclick="AGSA.UI.switchTab('atp')" data-tab="atp" class="nav-tab px-4 py-2 text-sm font-semibold rounded-lg active">ATP & Prota</button>
                <button onclick="AGSA.UI.switchTab('promes')" data-tab="promes" class="nav-tab px-4 py-2 text-sm font-semibold rounded-lg">Promes</button>
                <button onclick="AGSA.UI.switchTab('modul')" data-tab="modul" class="nav-tab px-4 py-2 text-sm font-semibold rounded-lg premium-feature">Modul & LKPD</button>
                <button onclick="AGSA.UI.switchTab('jurnal')" data-tab="jurnal" class="nav-tab px-4 py-2 text-sm font-semibold rounded-lg premium-feature">Jurnal</button>
                <button onclick="AGSA.UI.switchTab('absensi')" data-tab="absensi" class="nav-tab px-4 py-2 text-sm font-semibold rounded-lg premium-feature">Absensi</button>
                <button onclick="AGSA.UI.switchTab('kktp')" data-tab="kktp" class="nav-tab px-4 py-2 text-sm font-semibold rounded-lg premium-feature">KKTP & Nilai</button>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="AGSA.openModal('ai-assistant')" class="bg-purple-100 text-purple-700 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-purple-200 transition flex items-center gap-2">
                    <span>ü§ñ</span> AI Assistant
                </button>
                <button onclick="window.print()" class="bg-slate-800 text-white px-5 py-2 rounded-lg text-sm font-semibold hover:bg-slate-700 transition flex items-center gap-2 shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                    </svg>
                    Cetak / PDF
                </button>
            </div>
        </header>
        
        <!-- Main Content -->
        <div id="main-content" class="flex-1 overflow-y-auto p-6 bg-slate-100">
            
            <!-- ===== VIEW: ATP & PROTA ===== -->
            <div id="view-atp" class="view-section">
                <div class="no-print mb-4 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-slate-700">üìã ATP & Program Tahunan</h2>
                    <select id="in-atp-mode" onchange="AGSA.renderAll()" class="p-2.5 border border-slate-300 rounded-lg text-sm outline-none bg-white font-semibold text-blue-700 shadow-sm cursor-pointer">
                        <option value="semester">Cetak 1 Semester (Aktif)</option>
                        <option value="tahun">Cetak 1 Tahun Penuh</option>
                    </select>
                </div>
                
                <!-- ATP Document -->
                <div class="paper-preview landscape">
                    <h1 class="text-center text-[14pt] font-bold mb-6 uppercase" contenteditable="true">
                        ALUR TUJUAN PEMBELAJARAN (ATP)<br>
                        TAHUN PELAJARAN <span class="v-tahun-ajar"></span>
                    </h1>
                    <div class="flex justify-between mb-4 text-[11pt] font-semibold" contenteditable="true">
                        <table class="text-left" style="line-height: 1.6;">
                            <tr><td class="pr-4">SATUAN PENDIDIKAN</td><td>: <span class="v-sekolah"></span></td></tr>
                            <tr><td>MATA PELAJARAN</td><td>: <span class="v-mapel text-blue-700 uppercase"></span></td></tr>
                            <tr><td>FASE</td><td>: <span class="v-fase"></span></td></tr>
                        </table>
                        <table class="text-left" style="line-height: 1.6;">
                            <tr><td class="pr-4">KELAS</td><td>: <span class="v-kelas"></span></td></tr>
                            <tr><td>SEMESTER</td><td>: <span class="v-semester"></span></td></tr>
                        </table>
                    </div>
                    <table class="doc-table">
                        <thead>
                            <tr>
                                <th width="4%">NO</th>
                                <th width="18%">ELEMEN / CP</th>
                                <th width="25%">TUJUAN PEMBELAJARAN (TP)</th>
                                <th width="18%">PROFIL PELAJAR PANCASILA</th>
                                <th width="10%">KOMPETENSI</th>
                                <th width="8%">ALOKASI WAKTU</th>
                            </tr>
                        </thead>
                        <tbody id="out-atp"></tbody>
                    </table>
                    <div class="signature-area" contenteditable="true">
                        <div class="signature-box">
                            Mengetahui,<br>Kepala Sekolah
                            <div class="signature-name v-kepsek"></div>
                            NIP. <span class="v-nip-kepsek"></span>
                        </div>
                        <div class="signature-box">
                            <span class="v-tempat"></span>, <span class="v-tanggal-ttd"></span><br>
                            Guru Mata Pelajaran
                            <div class="signature-name v-guru"></div>
                            NIP. <span class="v-nip-guru"></span>
                        </div>
                    </div>
                </div>
                
                <!-- PROTA Document -->
                <div class="paper-preview portrait mt-8">
                    <h1 class="text-center text-[14pt] font-bold mb-6 uppercase" contenteditable="true">
                        PROGRAM TAHUNAN (PROTA)<br>
                        <span class="v-mapel uppercase"></span>
                    </h1>
                    <table class="mb-5 text-[11pt] font-semibold w-full" contenteditable="true">
                        <tr><td width="180">Satuan Pendidikan</td><td>: <span class="v-sekolah"></span></td></tr>
                        <tr><td>Fase / Kelas</td><td>: <span class="v-fase"></span> / <span class="v-kelas"></span></td></tr>
                        <tr><td>Tahun Pelajaran</td><td>: <span class="v-tahun-ajar"></span></td></tr>
                    </table>
                    <table class="doc-table">
                        <thead>
                            <tr>
                                <th width="10%">SEMESTER</th>
                                <th width="25%">ELEMEN / BAB</th>
                                <th width="50%">TUJUAN PEMBELAJARAN</th>
                                <th width="10%">JP</th>
                            </tr>
                        </thead>
                        <tbody id="out-prota"></tbody>
                    </table>
                    <div class="signature-area" contenteditable="true">
                        <div class="signature-box">
                            Mengetahui,<br>Kepala Sekolah
                            <div class="signature-name v-kepsek"></div>
                            NIP. <span class="v-nip-kepsek"></span>
                        </div>
                        <div class="signature-box">
                            <span class="v-tempat"></span>, <span class="v-tanggal-ttd"></span><br>
                            Guru Mata Pelajaran
                            <div class="signature-name v-guru"></div>
                            NIP. <span class="v-nip-guru"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ===== VIEW: PROMES ===== -->
            <div id="view-promes" class="view-section hidden">
                <div class="no-print mb-4">
                    <h2 class="text-lg font-bold text-slate-700">üìÖ Program Semester (PROMES)</h2>
                </div>
                <div class="paper-preview landscape">
                    <h1 class="text-center text-[14pt] font-bold mb-6 uppercase" contenteditable="true">
                        PROGRAM SEMESTER (PROMES)<br>
                        SEMESTER <span class="v-semester uppercase"></span>
                    </h1>
                    <table class="mb-4 text-[11pt] font-semibold w-1/2" contenteditable="true">
                        <tr><td width="160">Mata Pelajaran</td><td>: <span class="v-mapel text-blue-700"></span></td></tr>
                        <tr><td>Kelas / Rombel</td><td>: <span class="v-kelas"></span> / <span class="v-rombel"></span></td></tr>
                        <tr><td>Tahun Pelajaran</td><td>: <span class="v-tahun-ajar"></span></td></tr>
                    </table>
                    <table class="doc-table text-[8pt]">
                        <thead id="out-promes-head"></thead>
                        <tbody id="out-promes-body"></tbody>
                    </table>
                    <div class="signature-area" contenteditable="true">
                        <div class="signature-box">
                            Mengetahui,<br>Kepala Sekolah
                            <div class="signature-name v-kepsek"></div>
                            NIP. <span class="v-nip-kepsek"></span>
                        </div>
                        <div class="signature-box">
                            <span class="v-tempat"></span>, <span class="v-tanggal-ttd"></span><br>
                            Guru Mata Pelajaran
                            <div class="signature-name v-guru"></div>
                            NIP. <span class="v-nip-guru"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ===== VIEW: MODUL AJAR ===== -->
            <div id="view-modul" class="view-section hidden">
                <div class="no-print mb-4 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-slate-700">üìñ Modul Ajar & LKPD</h2>
                    <label class="flex items-center gap-2 text-sm font-semibold cursor-pointer bg-white px-4 py-2 rounded-lg shadow-sm border">
                        <input type="checkbox" id="toggle-lkpd" checked class="w-4 h-4 text-blue-600 rounded"> 
                        Tampilkan LKPD
                    </label>
                </div>
                
                <!-- Modul Ajar Document -->
                <div class="paper-preview portrait">
                    <h1 class="text-center text-[14pt] font-bold mb-6 uppercase" contenteditable="true">
                        MODUL AJAR KURIKULUM MERDEKA
                    </h1>
                    
                    <div class="font-bold text-[11pt] bg-slate-100 p-2 border-l-4 border-blue-600 mb-3">A. IDENTITAS MODUL</div>
                    <table class="text-[11pt] font-semibold w-full mb-4" contenteditable="true">
                        <tr><td width="180">Penyusun</td><td>: <span class="v-guru"></span> (<span class="v-sekolah"></span>)</td></tr>
                        <tr><td>Mata Pelajaran</td><td>: <span class="v-mapel"></span></td></tr>
                        <tr><td>Kelas / Semester / Rombel</td><td>: <span class="v-kelas"></span> / <span class="v-semester"></span> / <span class="v-rombel"></span></td></tr>
                        <tr><td>Materi Pokok</td><td>: <span class="v-elemen text-blue-700 font-bold"></span></td></tr>
                        <tr><td>Alokasi Waktu</td><td>: <span class="v-jp-total"></span> JP</td></tr>
                    </table>
                    
                    <div class="font-bold text-[11pt] bg-slate-100 p-2 border-l-4 border-blue-600 mb-3">B. CAPAIAN & TUJUAN PEMBELAJARAN</div>
                    <div class="pl-4 mb-4" contenteditable="true">
                        <p class="font-bold text-slate-700 mb-1">Capaian Pembelajaran (CP):</p>
                        <p id="out-modul-cp" class="bg-blue-50 p-3 rounded-lg border border-blue-100 text-sm text-justify mb-4"></p>
                        <p class="font-bold text-slate-700 mb-1">Tujuan Pembelajaran (TP):</p>
                        <ul id="out-modul-tp" class="list-disc pl-5 text-sm space-y-1"></ul>
                    </div>
                    
                    <div class="font-bold text-[11pt] bg-slate-100 p-2 border-l-4 border-blue-600 mb-3">C. LANGKAH-LANGKAH PEMBELAJARAN</div>
                    <div id="out-modul-langkah" class="pl-4 text-sm" contenteditable="true"></div>
                    
                    <div class="signature-area mt-8" contenteditable="true">
                        <div class="signature-box">
                            Mengetahui,<br>Kepala Sekolah
                            <div class="signature-name v-kepsek"></div>
                            NIP. <span class="v-nip-kepsek"></span>
                        </div>
                        <div class="signature-box">
                            <span class="v-tempat"></span>, <span class="v-tanggal-ttd"></span><br>
                            Guru Mata Pelajaran
                            <div class="signature-name v-guru"></div>
                            NIP. <span class="v-nip-guru"></span>
                        </div>
                    </div>
                </div>
                
                <!-- LKPD Document -->
                <div id="wrapper-lkpd" class="paper-preview portrait mt-8">
                    <div class="border-2 border-dashed border-blue-500 p-6 rounded-xl bg-slate-50 min-h-[90%]">
                        <h1 class="text-center text-[16pt] font-bold text-blue-800 mb-4 uppercase" contenteditable="true">
                            LEMBAR KERJA PESERTA DIDIK (LKPD)
                        </h1>
                        <div class="flex justify-between border-b-2 border-slate-400 pb-2 mb-4 font-bold" contenteditable="true">
                            <span>Nama / Kelompok : .................................</span>
                            <span>Kelas: <span class="v-kelas"></span>/<span class="v-rombel"></span></span>
                            <span>Nilai: ........</span>
                        </div>
                        <p class="font-bold text-blue-700">Mata Pelajaran: <span class="v-mapel"></span></p>
                        <p class="font-bold text-blue-700 mb-4">Materi: <span class="v-elemen"></span></p>
                        
                        <div contenteditable="true">
                            <p class="font-bold text-blue-800 text-[11pt] mt-4 mb-2">A. Tujuan Pembelajaran:</p>
                            <ul id="out-lkpd-tp" class="bg-white p-3 border rounded-lg list-disc pl-6 text-sm mb-4"></ul>
                            
                            <p class="font-bold text-blue-800 text-[11pt] mb-2">B. Petunjuk Pengerjaan:</p>
                            <ol class="list-decimal pl-6 mb-6 text-sm space-y-1">
                                <li>Berdoalah terlebih dahulu sebelum mengerjakan.</li>
                                <li>Baca dan pahami setiap instruksi dengan seksama.</li>
                                <li>Tuliskan jawaban dengan rapi dan jelas.</li>
                                <li>Diskusikan dengan teman jika diperbolehkan oleh guru.</li>
                            </ol>
                            
                            <p class="font-bold text-blue-800 text-[11pt] border-b-2 border-slate-300 pb-2 mb-4">C. Kegiatan / Tantangan:</p>
                            <div class="space-y-5">
                                <div>
                                    <p class="font-bold text-sm mb-2">1. Jelaskan pemahaman utamamu tentang materi hari ini!</p>
                                    <div class="border-2 border-slate-300 bg-white p-4 rounded-lg min-h-[100px]"></div>
                                </div>
                                <div>
                                    <p class="font-bold text-sm mb-2">2. Berikan 2 contoh penerapan materi ini dalam kehidupan sehari-hari!</p>
                                    <div class="border-2 border-slate-300 bg-white p-4 rounded-lg min-h-[100px]"></div>
                                </div>
                                <div>
                                    <p class="font-bold text-sm mb-2">3. Apa kesulitan yang kamu temui saat mempelajari materi ini?</p>
                                    <div class="border-2 border-slate-300 bg-white p-4 rounded-lg min-h-[80px]"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ===== VIEW: JURNAL ===== -->
            <div id="view-jurnal" class="view-section hidden">
                <div class="no-print mb-4">
                    <h2 class="text-lg font-bold text-slate-700">üìù Jurnal Pembelajaran</h2>
                    <p class="text-sm text-slate-500">Jurnal dikelompokkan per bulan secara otomatis</p>
                </div>
                <div id="jurnal-container"></div>
            </div>
            
            <!-- ===== VIEW: ABSENSI ===== -->
            <div id="view-absensi" class="view-section hidden">
                <div class="no-print mb-4">
                    <h2 class="text-lg font-bold text-slate-700">‚úÖ Daftar Hadir / Absensi</h2>
                    <p class="text-sm text-slate-500">Klik status kehadiran untuk mengubah (H/S/I/A)</p>
                </div>
                <div id="absensi-container"></div>
            </div>
            
            <!-- ===== VIEW: KKTP & NILAI ===== -->
            <div id="view-kktp" class="view-section hidden">
                <div class="no-print mb-4">
                    <h2 class="text-lg font-bold text-slate-700">üìä KKTP & Daftar Nilai</h2>
                </div>
                
                <!-- KKTP Document -->
                <div class="paper-preview portrait">
                    <h1 class="text-center text-[14pt] font-bold mb-6 uppercase" contenteditable="true">
                        KRITERIA KETERCAPAIAN TUJUAN PEMBELAJARAN (KKTP)
                    </h1>
                    <table class="mb-5 text-[11pt] font-semibold w-full" contenteditable="true">
                        <tr><td width="180">Mata Pelajaran</td><td>: <span class="v-mapel"></span></td></tr>
                        <tr><td>Kelas / Semester</td><td>: <span class="v-kelas"></span> / <span class="v-semester"></span></td></tr>
                        <tr><td>Tahun Pelajaran</td><td>: <span class="v-tahun-ajar"></span></td></tr>
                    </table>
                    <table class="doc-table">
                        <thead>
                            <tr>
                                <th rowspan="2" width="5%">No</th>
                                <th rowspan="2" width="45%">Tujuan Pembelajaran</th>
                                <th colspan="3">Kriteria (Klik untuk Edit)</th>
                                <th rowspan="2" width="10%">KKTP</th>
                            </tr>
                            <tr>
                                <th class="text-[8pt]">Kompleksitas</th>
                                <th class="text-[8pt]">Daya Dukung</th>
                                <th class="text-[8pt]">Intake Siswa</th>
                            </tr>
                        </thead>
                        <tbody id="out-kktp"></tbody>
                    </table>
                    <div class="signature-area" contenteditable="true">
                        <div class="signature-box">
                            Mengetahui,<br>Kepala Sekolah
                            <div class="signature-name v-kepsek"></div>
                            NIP. <span class="v-nip-kepsek"></span>
                        </div>
                        <div class="signature-box">
                            <span class="v-tempat"></span>, <span class="v-tanggal-ttd"></span><br>
                            Guru Mata Pelajaran
                            <div class="signature-name v-guru"></div>
                            NIP. <span class="v-nip-guru"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Daftar Nilai Document -->
                <div class="paper-preview landscape mt-8">
                    <h1 class="text-center text-[14pt] font-bold mb-6 uppercase" contenteditable="true">
                        DAFTAR NILAI SUMATIF & RAPOR
                    </h1>
                    <table class="mb-4 text-[11pt] font-semibold w-1/3" contenteditable="true">
                        <tr><td width="160">Mata Pelajaran</td><td>: <span class="v-mapel"></span></td></tr>
                        <tr><td>Kelas / Semester</td><td>: <span class="v-kelas"></span> / <span class="v-semester"></span></td></tr>
                    </table>
                    <table class="doc-table text-[9pt] text-center">
                        <thead>
                            <tr>
                                <th rowspan="2" width="4%">No</th>
                                <th rowspan="2" width="22%" class="text-left">Nama Siswa</th>
                                <th colspan="5">Nilai Sumatif (Per TP/Bab)</th>
                                <th rowspan="2" width="6%">STS</th>
                                <th rowspan="2" width="6%">SAS</th>
                                <th rowspan="2" width="8%" class="bg-blue-100 text-blue-800">Nilai Rapor</th>
                            </tr>
                            <tr>
                                <th>S1</th>
                                <th>S2</th>
                                <th>S3</th>
                                <th>S4</th>
                                <th>Rata¬≤</th>
                            </tr>
                        </thead>
                        <tbody id="out-nilai"></tbody>
                    </table>
                    <div class="signature-area" contenteditable="true">
                        <div class="signature-box">
                            Mengetahui,<br>Kepala Sekolah
                            <div class="signature-name v-kepsek"></div>
                            NIP. <span class="v-nip-kepsek"></span>
                        </div>
                        <div class="signature-box">
                            <span class="v-tempat"></span>, <span class="v-tanggal-ttd"></span><br>
                            Guru Mata Pelajaran
                            <div class="signature-name v-guru"></div>
                            NIP. <span class="v-nip-guru"></span>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </main>

    <!-- ============================================= -->
    <!-- MODALS -->
    <!-- ============================================= -->
    
    <!-- Modal: Data Siswa -->
    <div id="modal-siswa" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-emerald-600 flex items-center gap-2">
                    <span>üë•</span> Input Data Siswa
                </h2>
                <button onclick="AGSA.closeModal('siswa')" class="w-8 h-8 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg font-bold transition">‚úï</button>
            </div>
            <p class="text-sm text-slate-600 mb-4 bg-blue-50 p-3 rounded-lg border border-blue-100">
                <strong>üí° Tips:</strong> Paste (tempel) daftar nama siswa dari Excel atau Notepad.<br>
                Format: <strong>1 baris = 1 nama siswa</strong>. Nomor urut akan dihapus otomatis.
            </p>
            <textarea id="in-data-siswa" rows="12" class="w-full border-2 border-slate-200 rounded-xl p-4 text-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none resize-none" placeholder="Ahmad Fulan&#10;Siti Fulanah&#10;Budi Santoso"></textarea>
            <div class="flex gap-2 mt-4">
                <button onclick="AGSA.Students.save()" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg transition">
                    üíæ Simpan Data Siswa
                </button>
                <button onclick="AGSA.Students.loadFromCSV()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-6 rounded-xl transition">
                    üìÅ Import CSV
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Profil Guru & Sekolah -->
    <div id="modal-profil" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-blue-600 flex items-center gap-2">
                    <span>üë§</span> Profil Guru & Sekolah
                </h2>
                <button onclick="AGSA.closeModal('profil')" class="w-8 h-8 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg font-bold transition">‚úï</button>
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">Nama Guru</label>
                        <input type="text" id="modal-guru" class="w-full border-2 border-slate-200 rounded-lg p-3 focus:border-blue-500 outline-none mt-1">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">NIP Guru</label>
                        <input type="text" id="modal-nip-guru" class="w-full border-2 border-slate-200 rounded-lg p-3 focus:border-blue-500 outline-none mt-1">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">Nama Kepala Sekolah</label>
                        <input type="text" id="modal-kepsek" class="w-full border-2 border-slate-200 rounded-lg p-3 focus:border-blue-500 outline-none mt-1">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">NIP Kepala Sekolah</label>
                        <input type="text" id="modal-nip-kepsek" class="w-full border-2 border-slate-200 rounded-lg p-3 focus:border-blue-500 outline-none mt-1">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">Nama Sekolah</label>
                        <input type="text" id="modal-sekolah" class="w-full border-2 border-slate-200 rounded-lg p-3 focus:border-blue-500 outline-none mt-1">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">NPSN</label>
                        <input type="text" id="modal-npsn" class="w-full border-2 border-slate-200 rounded-lg p-3 focus:border-blue-500 outline-none mt-1">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">Lokasi (Kota)</label>
                        <input type="text" id="modal-lokasi" class="w-full border-2 border-slate-200 rounded-lg p-3 focus:border-blue-500 outline-none mt-1">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">Jenjang</label>
                        <select id="modal-jenjang" class="w-full border-2 border-slate-200 rounded-lg p-3 focus:border-blue-500 outline-none mt-1 cursor-pointer">
                            <option value="SD">SD / MI</option>
                            <option value="SMP">SMP / MTs</option>
                            <option value="SMA">SMA / SMK / MA</option>
                        </select>
                    </div>
                </div>
            </div>
            <button onclick="AGSA.Profile.save()" class="w-full mt-6 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg transition">
                üíæ Simpan Profil
            </button>
        </div>
    </div>
    
    <!-- Modal: AI Assistant -->
    <div id="modal-ai-assistant" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-purple-600 flex items-center gap-2">
                    <span>ü§ñ</span> AI Assistant
                </h2>
                <button onclick="AGSA.closeModal('ai-assistant')" class="w-8 h-8 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg font-bold transition">‚úï</button>
            </div>
            <p class="text-sm text-slate-600 mb-4">Pilih bantuan yang Anda butuhkan:</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="AGSA.AI.generateStudentCSV()" class="p-4 border-2 border-slate-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition text-left">
                    <span class="text-2xl mb-2 block">üìã</span>
                    <span class="font-bold text-slate-700">Format CSV Siswa</span>
                    <p class="text-xs text-slate-500 mt-1">Generate template CSV untuk data siswa</p>
                </button>
                <button onclick="AGSA.AI.generateCPTemplate()" class="p-4 border-2 border-slate-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition text-left">
                    <span class="text-2xl mb-2 block">üìö</span>
                    <span class="font-bold text-slate-700">Template CP/TP</span>
                    <p class="text-xs text-slate-500 mt-1">Generate format CP sesuai kurikulum</p>
                </button>
                <button onclick="AGSA.AI.convertMaterial()" class="p-4 border-2 border-slate-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition text-left">
                    <span class="text-2xl mb-2 block">üîÑ</span>
                    <span class="font-bold text-slate-700">Konversi Materi</span>
                    <p class="text-xs text-slate-500 mt-1">Convert materi mentah ke format sistem</p>
                </button>
                <button onclick="AGSA.AI.help()" class="p-4 border-2 border-slate-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition text-left">
                    <span class="text-2xl mb-2 block">‚ùì</span>
                    <span class="font-bold text-slate-700">Panduan Lengkap</span>
                    <p class="text-xs text-slate-500 mt-1">Lihat dokumentasi & tutorial</p>
                </button>
            </div>
            <div id="ai-output" class="hidden mt-4 p-4 bg-slate-100 rounded-xl border">
                <pre id="ai-output-text" class="text-xs overflow-x-auto whitespace-pre-wrap"></pre>
                <button onclick="AGSA.AI.copyOutput()" class="mt-2 bg-slate-700 text-white px-4 py-2 rounded-lg text-sm font-semibold">üìã Copy</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Upgrade Premium -->
    <div id="modal-upgrade" class="modal-overlay">
        <div class="modal-content text-center">
            <span class="text-6xl mb-4 block">‚≠ê</span>
            <h2 class="text-2xl font-bold text-amber-600 mb-2">Upgrade ke Premium</h2>
            <p class="text-slate-600 mb-6">Dapatkan akses penuh ke semua fitur AGSA!</p>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-4 border-2 border-slate-200 rounded-xl">
                    <p class="font-bold text-2xl text-slate-800">Rp 50.000</p>
                    <p class="text-sm text-slate-500">Per Bulan</p>
                </div>
                <div class="p-4 border-2 border-amber-400 rounded-xl bg-amber-50">
                    <p class="font-bold text-2xl text-amber-600">Rp 500.000</p>
                    <p class="text-sm text-amber-600">Per Tahun (Hemat 17%)</p>
                </div>
            </div>
            <p class="text-sm text-slate-500 mb-4">Atau hubungi untuk <strong>Paket Sekolah</strong></p>
            <button onclick="AGSA.Subscription.contactWA()" class="w-full bg-green-500 hover:bg-green-400 text-white font-bold py-3 rounded-xl shadow-lg transition flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                Hubungi via WhatsApp
            </button>
            <button onclick="AGSA.closeModal('upgrade')" class="mt-3 text-slate-500 hover:text-slate-700 text-sm font-semibold">Nanti Saja</button>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- SUPER ADMIN PANEL (hidden by default) -->
    <!-- ============================================= -->
    <div id="super-admin-panel" class="fixed inset-0 bg-slate-900/95 z-[200] hidden overflow-y-auto">
        <div class="max-w-4xl mx-auto p-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-2xl font-bold text-white flex items-center gap-3">
                    <span class="text-3xl">üëë</span> Super Admin Panel
                </h1>
                <button onclick="AGSA.Admin.close()" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold">Tutup</button>
            </div>
            
            <div class="grid grid-cols-2 gap-6">
                <!-- Settings Card -->
                <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
                    <h3 class="text-lg font-bold text-white mb-4">‚öôÔ∏è Pengaturan Global</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-slate-400">Nomor WhatsApp Upgrade</label>
                            <input type="text" id="admin-wa" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white mt-1" placeholder="6281234567890">
                        </div>
                        <button onclick="AGSA.Admin.saveSettings()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold">Simpan</button>
                    </div>
                </div>
                
                <!-- Stats Card -->
                <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
                    <h3 class="text-lg font-bold text-white mb-4">üìä Statistik</h3>
                    <div class="space-y-2 text-slate-300">
                        <p>Total Users: <span id="stat-users" class="font-bold text-white">-</span></p>
                        <p>Premium Users: <span id="stat-premium" class="font-bold text-amber-400">-</span></p>
                        <p>Free Users: <span id="stat-free" class="font-bold text-slate-400">-</span></p>
                    </div>
                </div>
            </div>
            
            <!-- Users Table -->
            <div class="bg-slate-800 rounded-xl p-6 border border-slate-700 mt-6">
                <h3 class="text-lg font-bold text-white mb-4">üë• Daftar Pengguna</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-slate-300">
                        <thead>
                            <tr class="border-b border-slate-700">
                                <th class="py-2 text-left">Email</th>
                                <th class="py-2 text-left">Nama</th>
                                <th class="py-2 text-left">Plan</th>
                                <th class="py-2 text-left">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="admin-users-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- MAIN JAVASCRIPT -->
    <!-- ============================================= -->
    <script>
        // =============================================
        // FIREBASE CONFIGURATION
        // =============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDe4ie2wSEpNbAgWP-q03vTuHyxc9Jj3E",
            authDomain: "agsa-e5b08.firebaseapp.com",
            projectId: "agsa-e5b08",
            storageBucket: "agsa-e5b08.firebasestorage.app",
            messagingSenderId: "916052746331",
            appId: "1:916052746331:web:357cbadbfd8658f1689f7e",
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // =============================================
        // CONSTANTS
        // =============================================
        const CP_LINKS = {
            "SD": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1925091593&single=true&output=csv",
            "SMP": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1962203786&single=true&output=csv",
            "SMA": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=260922290&single=true&output=csv"
        };
        
        const BULAN = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const HARI = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jum'at", "Sabtu"];
        const SUPER_ADMIN_EMAIL = "afifaro@gmail.com";
        const PROFIL_LULUSAN = ["Keimanan", "Kewargaan", "Penalaran Kritis", "Kreativitas", "Kolaborasi", "Kemandirian", "Kesehatan", "Komunikasi"];
        
        // =============================================
        // MAIN APPLICATION OBJECT
        // =============================================
        const AGSA = {
            // State
            user: null,
            subscription: { plan: "free" },
            curriculumData: {},
            students: [],
            promesRows: [],
            settings: { whatsappNumber: "6281234567890" },
            
            // =========================================
            // INITIALIZATION
            // =========================================
            init: function() {
                this.setupAuthListener();
                this.setupEventListeners();
                this.loadLocalData();
            },
            
            setupAuthListener: function() {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        this.user = user;
                        await this.loadUserData();
                        this.showMainApp();
                        this.Curriculum.loadFromCloud();
                    } else {
                        this.showLoginScreen();
                    }
                });
            },
            
            setupEventListeners: function() {
                // Login button
                document.getElementById('btn-google-login')?.addEventListener('click', () => this.Auth.loginWithGoogle());
                
                // Logout button
                document.getElementById('btn-logout')?.addEventListener('click', () => this.Auth.logout());
                
                // Dropdown changes
                document.getElementById('in-jenjang')?.addEventListener('change', () => this.Curriculum.loadFromCloud());
                document.getElementById('in-mapel')?.addEventListener('change', () => this.Curriculum.updateKelasList());
                document.getElementById('in-kelas')?.addEventListener('change', () => this.Curriculum.updateSemesterList());
                document.getElementById('in-semester')?.addEventListener('change', () => this.Curriculum.updateElemenList());
                document.getElementById('in-elemen')?.addEventListener('change', () => this.renderAll());
                
                // LKPD toggle
                document.getElementById('toggle-lkpd')?.addEventListener('change', function() {
                    document.getElementById('wrapper-lkpd').classList.toggle('hidden', !this.checked);
                });
            },
            
            loadLocalData: function() {
                const savedStudents = localStorage.getItem('agsa_students');
                if (savedStudents) {
                    this.students = JSON.parse(savedStudents);
                    document.getElementById('in-data-siswa').value = this.students.join('\n');
                } else {
                    this.students = ["Ahmad Fulan", "Siti Fulanah", "Budi Santoso"];
                }
            },
            
            async loadUserData() {
                if (!this.user) return;
                
                try {
                    const userDoc = await db.collection('users').doc(this.user.uid).get();
                    if (userDoc.exists) {
                        const data = userDoc.data();
                        this.subscription = data.subscription || { plan: "free" };
                        
                        // Load saved profile
                        if (data.profile) {
                            document.getElementById('in-sekolah').value = data.profile.schoolName || "";
                            document.getElementById('in-guru').value = data.profile.teacherName || "";
                            document.getElementById('in-nip-guru').value = data.profile.teacherNIP || "";
                            document.getElementById('in-kepsek').value = data.profile.principalName || "";
                            document.getElementById('in-nip-kepsek').value = data.profile.principalNIP || "";
                            document.getElementById('in-tempat').value = data.profile.location || "";
                            document.getElementById('in-jenjang').value = data.profile.jenjang || "SD";
                        }
                    } else {
                        // Create new user document
                        await db.collection('users').doc(this.user.uid).set({
                            email: this.user.email,
                            displayName: this.user.displayName,
                            photoURL: this.user.photoURL,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            subscription: { plan: "free" },
                            profile: {}
                        });
                    }
                    
                    this.updateUIForSubscription();
                    
                    // Check if super admin
                    if (this.user.email === SUPER_ADMIN_EMAIL) {
                        this.subscription.plan = "premium";
                    }
                    
                } catch (error) {
                    console.error("Error loading user data:", error);
                }
            },
            
            updateUIForSubscription: function() {
                const badge = document.getElementById('user-plan-badge');
                const banner = document.getElementById('upgrade-banner');
                
                if (this.subscription.plan === "premium") {
                    badge.textContent = "PREMIUM";
                    badge.classList.remove('badge-free');
                    badge.classList.add('badge-premium');
                    banner?.classList.add('hidden');
                } else {
                    badge.textContent = "FREE";
                    badge.classList.remove('badge-premium');
                    badge.classList.add('badge-free');
                    banner?.classList.remove('hidden');
                }
                
                document.getElementById('user-email-display').textContent = this.user?.email || "guest";
            },
            
            showLoginScreen: function() {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('main-wrapper').classList.add('hidden');
            },
            
            showMainApp: function() {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('sidebar').classList.add('flex');
                document.getElementById('main-wrapper').classList.remove('hidden');
            },
            
            // =========================================
            // MODAL HANDLERS
            // =========================================
            openModal: function(id) {
                document.getElementById(`modal-${id}`).style.display = 'flex';
            },
            
            closeModal: function(id) {
                document.getElementById(`modal-${id}`).style.display = 'none';
            },
            
            // =========================================
            // TOAST NOTIFICATIONS
            // =========================================
            toast: function(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            },
            
            // =========================================
            // AUTH MODULE
            // =========================================
            Auth: {
                loginWithGoogle: async function() {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    try {
                        await auth.signInWithPopup(provider);
                        AGSA.toast("Login berhasil!", "success");
                    } catch (error) {
                        console.error("Login error:", error);
                        AGSA.toast("Gagal login: " + error.message, "error");
                    }
                },
                
                logout: async function() {
                    try {
                        await auth.signOut();
                        AGSA.toast("Logout berhasil", "info");
                    } catch (error) {
                        console.error("Logout error:", error);
                    }
                }
            },
            
            // =========================================
            // UI MODULE
            // =========================================
            UI: {
                switchTab: function(tabId) {
                    // Check premium access
                    const premiumTabs = ['modul', 'jurnal', 'absensi', 'kktp'];
                    if (premiumTabs.includes(tabId) && AGSA.subscription.plan !== 'premium') {
                        AGSA.openModal('upgrade');
                        return;
                    }
                    
                    // Hide all views
                    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                    
                    // Remove active class from all tabs
                    document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
                    
                    // Show selected view and activate tab
                    document.getElementById(`view-${tabId}`).classList.remove('hidden');
                    document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
                }
            },
            
            // =========================================
            // CURRICULUM MODULE
            // =========================================
            Curriculum: {
                loadFromCloud: async function() {
                    const jenjang = document.getElementById('in-jenjang').value || "SD";
                    const url = CP_LINKS[jenjang];
                    const status = document.getElementById('csv-status');
                    
                    status.classList.remove('hidden');
                    status.className = 'mt-2 p-2 rounded-lg text-xs bg-blue-500 text-white';
                    status.textContent = '‚è≥ Memuat data kurikulum...';
                    
                    try {
                        let response = await fetch(url);
                        if (!response.ok) throw new Error("Fetch failed");
                        this.parseCSV(await response.text());
                        status.className = 'mt-2 p-2 rounded-lg text-xs bg-emerald-500 text-white';
                        status.textContent = '‚úÖ Data kurikulum berhasil dimuat!';
                        setTimeout(() => status.classList.add('hidden'), 2000);
                    } catch (error) {
                        // Try with proxy
                        try {
                            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                            const proxyRes = await fetch(proxyUrl);
                            const data = await proxyRes.json();
                            this.parseCSV(data.contents);
                            status.className = 'mt-2 p-2 rounded-lg text-xs bg-emerald-500 text-white';
                            status.textContent = '‚úÖ Data kurikulum berhasil dimuat!';
                            setTimeout(() => status.classList.add('hidden'), 2000);
                        } catch (err) {
                            status.className = 'mt-2 p-2 rounded-lg text-xs bg-red-500 text-white';
                            status.textContent = '‚ùå Gagal memuat. Gunakan Upload CSV Manual.';
                        }
                    }
                },
                
                uploadCSV: function(input) {
                    const file = input.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.parseCSV(e.target.result);
                        input.value = '';
                        AGSA.toast("CSV berhasil diupload!", "success");
                    };
                    reader.readAsText(file);
                },
                
                parseCSV: function(csvText) {
                    const lines = csvText.split('\n');
                    AGSA.curriculumData = {};
                    
                    for (let i = 1; i < lines.length; i++) {
                        const row = lines[i].trim();
                        if (!row) continue;
                        
                        // Parse CSV with proper handling of quoted values
                        const cols = [];
                        const regex = /("([^"]*)"|[^,;]+)(?=[,;]|$)/g;
                        let match;
                        while ((match = regex.exec(row)) !== null) {
                            cols.push(match[2] !== undefined ? match[2] : match[1]);
                        }
                        
                        if (cols.length < 5) continue;
                        
                        const [mapel, fase, kelas, semester, elemen, cp, tp, profil] = cols.map(c => c?.trim() || "");
                        
                        if (!AGSA.curriculumData[mapel]) AGSA.curriculumData[mapel] = {};
                        if (!AGSA.curriculumData[mapel][kelas]) AGSA.curriculumData[mapel][kelas] = {};
                        if (!AGSA.curriculumData[mapel][kelas][semester]) AGSA.curriculumData[mapel][kelas][semester] = {};
                        if (!AGSA.curriculumData[mapel][kelas][semester][elemen]) {
                            AGSA.curriculumData[mapel][kelas][semester][elemen] = { fase, cp, tps: [] };
                        }
                        AGSA.curriculumData[mapel][kelas][semester][elemen].tps.push({ tp: tp || cp, profil: profil || "" });
                    }
                    
                    this.initDropdowns();
                },
                
                initDropdowns: function() {
                    const mapelSelect = document.getElementById('in-mapel');
                    mapelSelect.innerHTML = '<option value="">-- Pilih Mata Pelajaran --</option>';
                    
                    Object.keys(AGSA.curriculumData).forEach(mapel => {
                        mapelSelect.appendChild(new Option(mapel, mapel));
                    });
                    
                    this.updateKelasList();
                },
                
                updateKelasList: function() {
                    const mapel = document.getElementById('in-mapel').value;
                    const kelasSelect = document.getElementById('in-kelas');
                    kelasSelect.innerHTML = '<option value="">-</option>';
                    
                    if (mapel && AGSA.curriculumData[mapel]) {
                        Object.keys(AGSA.curriculumData[mapel]).sort((a, b) => parseInt(a) - parseInt(b)).forEach(kelas => {
                            kelasSelect.appendChild(new Option(kelas, kelas));
                        });
                    }
                    
                    this.updateSemesterList();
                },
                
                updateSemesterList: function() {
                    const mapel = document.getElementById('in-mapel').value;
                    const kelas = document.getElementById('in-kelas').value;
                    const semesterSelect = document.getElementById('in-semester');
                    semesterSelect.innerHTML = '<option value="">-</option>';
                    
                    if (mapel && kelas && AGSA.curriculumData[mapel]?.[kelas]) {
                        Object.keys(AGSA.curriculumData[mapel][kelas]).forEach(semester => {
                            semesterSelect.appendChild(new Option(semester, semester));
                        });
                    }
                    
                    this.updateElemenList();
                },
                
                updateElemenList: function() {
                    const mapel = document.getElementById('in-mapel').value;
                    const kelas = document.getElementById('in-kelas').value;
                    const semester = document.getElementById('in-semester').value;
                    const elemenSelect = document.getElementById('in-elemen');
                    elemenSelect.innerHTML = '<option value="">-</option>';
                    
                    if (mapel && kelas && semester && AGSA.curriculumData[mapel]?.[kelas]?.[semester]) {
                        Object.keys(AGSA.curriculumData[mapel][kelas][semester]).forEach(elemen => {
                            elemenSelect.appendChild(new Option(elemen, elemen));
                        });
                    }
                    
                    AGSA.renderAll();
                }
            },
            
            // =========================================
            // STUDENTS MODULE
            // =========================================
            Students: {
                save: function() {
                    const input = document.getElementById('in-data-siswa').value;
                    const list = input.split('\n')
                        .map(s => s.replace(/^[0-9]+[\.\)\-]\s*/, '').split(/[\t;]/)[0].trim())
                        .filter(s => s.length > 0);
                    
                    if (list.length > 0) {
                        AGSA.students = list;
                        localStorage.setItem('agsa_students', JSON.stringify(list));
                        AGSA.closeModal('siswa');
                        AGSA.toast(`‚úÖ Berhasil menyimpan ${list.length} siswa!`, "success");
                        AGSA.renderAll();
                    } else {
                        AGSA.toast("Data siswa kosong!", "error");
                    }
                },
                
                loadFromCSV: function() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.csv';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            document.getElementById('in-data-siswa').value = ev.target.result;
                            AGSA.toast("CSV dimuat. Klik Simpan untuk menyimpan.", "info");
                        };
                        reader.readAsText(file);
                    };
                    input.click();
                }
            },
            
            // =========================================
            // PROFILE MODULE
            // =========================================
            Profile: {
                save: async function() {
                    if (!AGSA.user) return;
                    
                    const profile = {
                        teacherName: document.getElementById('modal-guru')?.value || "",
                        teacherNIP: document.getElementById('modal-nip-guru')?.value || "",
                        principalName: document.getElementById('modal-kepsek')?.value || "",
                        principalNIP: document.getElementById('modal-nip-kepsek')?.value || "",
                        schoolName: document.getElementById('modal-sekolah')?.value || "",
                        npsn: document.getElementById('modal-npsn')?.value || "",
                        location: document.getElementById('modal-lokasi')?.value || "",
                        jenjang: document.getElementById('modal-jenjang')?.value || "SD"
                    };
                    
                    try {
                        await db.collection('users').doc(AGSA.user.uid).update({ profile });
                        
                        // Update sidebar inputs
                        document.getElementById('in-sekolah').value = profile.schoolName;
                        document.getElementById('in-guru').value = profile.teacherName;
                        document.getElementById('in-nip-guru').value = profile.teacherNIP;
                        document.getElementById('in-kepsek').value = profile.principalName;
                        document.getElementById('in-nip-kepsek').value = profile.principalNIP;
                        document.getElementById('in-tempat').value = profile.location;
                        document.getElementById('in-jenjang').value = profile.jenjang;
                        
                        AGSA.closeModal('profil');
                        AGSA.toast("Profil berhasil disimpan!", "success");
                        AGSA.renderAll();
                    } catch (error) {
                        AGSA.toast("Gagal menyimpan: " + error.message, "error");
                    }
                }
            },
            
            // =========================================
            // SUBSCRIPTION MODULE
            // =========================================
            Subscription: {
                upgrade: function() {
                    AGSA.openModal('upgrade');
                },
                
                contactWA: function() {
                    const phone = AGSA.settings.whatsappNumber || "6281234567890";
                    const message = encodeURIComponent(`Halo, saya ingin upgrade ke AGSA Premium.\nEmail: ${AGSA.user?.email || "-"}`);
                    window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
                }
            },
            
            // =========================================
            // AI ASSISTANT MODULE
            // =========================================
            AI: {
                generateStudentCSV: function() {
                    const template = `NISN,Nama Lengkap,Jenis Kelamin
1234567890,Ahmad Fulan,L
1234567891,Siti Fulanah,P
1234567892,Budi Santoso,L`;
                    this.showOutput(template);
                },
                
                generateCPTemplate: function() {
                    const template = `Mata Pelajaran;Fase;Kelas;Semester;Elemen/Bab;CP;TP;Profil Lulusan
Matematika;C;6;Ganjil;Bilangan;Peserta didik dapat memahami konsep bilangan bulat;Menjelaskan konsep bilangan bulat positif dan negatif;Penalaran Kritis
Matematika;C;6;Ganjil;Bilangan;Peserta didik dapat memahami konsep bilangan bulat;Melakukan operasi hitung bilangan bulat;Penalaran Kritis`;
                    this.showOutput(template);
                },
                
                convertMaterial: function() {
                    AGSA.toast("Fitur ini memerlukan input materi. Coming soon!", "info");
                },
                
                help: function() {
                    const help = `=== PANDUAN AGSA ===

1. DATABASE KURIKULUM
   - Pilih jenjang (SD/SMP/SMA)
   - Klik "Load Cloud" untuk memuat data CP/TP
   - Atau upload file CSV manual

2. FORMAT CSV KURIKULUM
   Kolom: Mata Pelajaran;Fase;Kelas;Semester;Elemen;CP;TP;Profil

3. INPUT DATA SISWA
   - Paste dari Excel/Notepad
   - 1 baris = 1 nama siswa

4. KALENDER & JADWAL
   - Format: YYYY-MM-DD = Nama Kegiatan
   - Sistem otomatis hitung tanggal efektif

5. FITUR FREE vs PREMIUM
   FREE: ATP, Prota, Kalender, Jadwal
   PREMIUM: Promes, Modul, LKPD, Jurnal, Absensi, KKTP, Nilai

6. CETAK DOKUMEN
   - Klik "Cetak / PDF"
   - Pilih "Save as PDF" di print dialog`;
                    this.showOutput(help);
                },
                
                showOutput: function(text) {
                    const output = document.getElementById('ai-output');
                    const outputText = document.getElementById('ai-output-text');
                    output.classList.remove('hidden');
                    outputText.textContent = text;
                },
                
                copyOutput: function() {
                    const text = document.getElementById('ai-output-text').textContent;
                    navigator.clipboard.writeText(text).then(() => {
                        AGSA.toast("Berhasil di-copy!", "success");
                    });
                }
            },
            
            // =========================================
            // ADMIN MODULE
            // =========================================
            Admin: {
                open: async function() {
                    if (AGSA.user?.email !== SUPER_ADMIN_EMAIL) {
                        AGSA.toast("Akses ditolak!", "error");
                        return;
                    }
                    
                    document.getElementById('super-admin-panel').classList.remove('hidden');
                    
                    // Load settings
                    try {
                        const settingsDoc = await db.collection('settings').doc('global').get();
                        if (settingsDoc.exists) {
                            AGSA.settings = settingsDoc.data();
                            document.getElementById('admin-wa').value = AGSA.settings.whatsappNumber || "";
                        }
                    } catch (e) {}
                    
                    // Load stats
                    try {
                        const usersSnap = await db.collection('users').get();
                        let total = 0, premium = 0;
                        usersSnap.forEach(doc => {
                            total++;
                            if (doc.data().subscription?.plan === 'premium') premium++;
                        });
                        document.getElementById('stat-users').textContent = total;
                        document.getElementById('stat-premium').textContent = premium;
                        document.getElementById('stat-free').textContent = total - premium;
                        
                        // Users table
                        let tableHtml = '';
                        usersSnap.forEach(doc => {
                            const u = doc.data();
                            tableHtml += `<tr class="border-b border-slate-700">
                                <td class="py-2">${u.email}</td>
                                <td>${u.displayName || '-'}</td>
                                <td><span class="px-2 py-1 rounded text-xs ${u.subscription?.plan === 'premium' ? 'bg-amber-500' : 'bg-slate-600'}">${u.subscription?.plan || 'free'}</span></td>
                                <td><button onclick="AGSA.Admin.togglePremium('${doc.id}', '${u.subscription?.plan}')" class="text-blue-400 hover:underline">Toggle</button></td>
                            </tr>`;
                        });
                        document.getElementById('admin-users-table').innerHTML = tableHtml;
                    } catch (e) {}
                },
                
                close: function() {
                    document.getElementById('super-admin-panel').classList.add('hidden');
                },
                
                saveSettings: async function() {
                    const waNumber = document.getElementById('admin-wa').value;
                    try {
                        await db.collection('settings').doc('global').set({
                            whatsappNumber: waNumber,
                            superAdminEmail: SUPER_ADMIN_EMAIL,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                        AGSA.settings.whatsappNumber = waNumber;
                        AGSA.toast("Settings saved!", "success");
                    } catch (e) {
                        AGSA.toast("Error: " + e.message, "error");
                    }
                },
                
                togglePremium: async function(userId, currentPlan) {
                    const newPlan = currentPlan === 'premium' ? 'free' : 'premium';
                    try {
                        await db.collection('users').doc(userId).update({
                            'subscription.plan': newPlan
                        });
                        AGSA.toast(`Plan updated to ${newPlan}`, "success");
                        this.open(); // Refresh
                    } catch (e) {
                        AGSA.toast("Error: " + e.message, "error");
                    }
                }
            },
            
            // =========================================
            // UTILITIES
            // =========================================
            Utils: {
                getFase: function(jenjang, kelas) {
                    const k = parseInt(kelas);
                    if (jenjang === "SD") {
                        if (k <= 2) return "A";
                        if (k <= 4) return "B";
                        return "C";
                    }
                    if (jenjang === "SMP") return "D";
                    return k <= 11 ? "E" : "F";
                },
                
                getLastWorkingDay: function(year, month, holidays) {
                    let date = new Date(year, month + 1, 0); // Last day of month
                    while (date.getDay() === 0 || date.getDay() === 6) { // Skip weekends
                        date.setDate(date.getDate() - 1);
                    }
                    return `${String(date.getDate()).padStart(2, '0')} ${BULAN[month]} ${year}`;
                },
                
                formatDate: function(date) {
                    return `${String(date.getDate()).padStart(2, '0')} ${BULAN[date.getMonth()]} ${date.getFullYear()}`;
                }
            },
            
                        // =========================================
            // MAIN RENDER FUNCTION (CONTINUED)
            // =========================================
            renderAll: function() {
                const mapel = document.getElementById('in-mapel')?.value || "";
                const kelas = document.getElementById('in-kelas')?.value || "";
                const semester = document.getElementById('in-semester')?.value || "";
                const elemen = document.getElementById('in-elemen')?.value || "";
                
                if (!mapel || !kelas || !semester) return;
                
                // Get common values
                const tahunAwal = parseInt(document.getElementById('in-tahun')?.value) || 2025;
                const tahunAjar = `${tahunAwal}/${tahunAwal + 1}`;
                const jp = parseInt(document.getElementById('in-jp')?.value) || 4;
                const hariTarget = parseInt(document.getElementById('in-hari')?.value) || 1;
                const jenjang = document.getElementById('in-jenjang')?.value || "SD";
                const fase = this.Utils.getFase(jenjang, kelas);
                
                // Fill common fields across all documents
                this.fillCommonFields(tahunAjar, fase);
                
                // Parse calendar events
                const liburText = document.getElementById('in-libur')?.value || "";
                const { calEvents, holidays } = this.parseCalendarEvents(liburText);
                
                // Calculate active dates for semester
                const bulanAwal = semester === "Ganjil" ? 6 : 0; // Juli atau Januari
                const activeDates = this.calculateActiveDates(tahunAwal, bulanAwal, hariTarget, calEvents, semester);
                
                // Render all documents
                this.renderATPProta(mapel, kelas, semester, jp, activeDates, fase);
                this.renderPromes(jp, calEvents, semester, bulanAwal, tahunAwal);
                this.renderJurnal(mapel, kelas, semester, tahunAwal, holidays);
                this.renderAbsensi(mapel, kelas, semester, tahunAwal, holidays);
                this.renderKKTP(mapel, kelas, semester);
                this.renderNilai();
                
                if (elemen) {
                    this.renderModul(mapel, kelas, semester, elemen, jp);
                }
            },
            
            // =========================================
            // FILL COMMON FIELDS
            // =========================================
            fillCommonFields: function(tahunAjar, fase) {
                const fields = {
                    'v-tahun-ajar': tahunAjar,
                    'v-sekolah': document.getElementById('in-sekolah')?.value || "",
                    'v-kepsek': document.getElementById('in-kepsek')?.value || "",
                    'v-nip-kepsek': document.getElementById('in-nip-kepsek')?.value || "",
                    'v-guru': document.getElementById('in-guru')?.value || "",
                    'v-nip-guru': document.getElementById('in-nip-guru')?.value || "",
                    'v-mapel': document.getElementById('in-mapel')?.value || "",
                    'v-kelas': document.getElementById('in-kelas')?.value || "",
                    'v-semester': document.getElementById('in-semester')?.value || "",
                    'v-rombel': document.getElementById('in-rombel')?.value || "A",
                    'v-tempat': document.getElementById('in-tempat')?.value || "",
                    'v-elemen': document.getElementById('in-elemen')?.value || "",
                    'v-fase': fase,
                    'v-tanggal-ttd': this.Utils.formatDate(new Date())
                };
                
                Object.keys(fields).forEach(className => {
                    document.querySelectorAll(`.${className}`).forEach(el => {
                        el.textContent = fields[className];
                    });
                });
            },
            
            // =========================================
            // PARSE CALENDAR EVENTS
            // =========================================
            parseCalendarEvents: function(text) {
                const calEvents = {};
                const holidays = [];
                
                text.split('\n').forEach(line => {
                    const parts = line.split('=');
                    if (parts.length >= 2) {
                        const dateStr = parts[0].trim();
                        const eventName = parts[1].trim();
                        calEvents[dateStr] = eventName;
                        holidays.push(dateStr);
                    } else if (parts[0].trim()) {
                        calEvents[parts[0].trim()] = "LIBUR";
                        holidays.push(parts[0].trim());
                    }
                });
                
                return { calEvents, holidays };
            },
            
            // =========================================
            // CALCULATE ACTIVE DATES
            // =========================================
            calculateActiveDates: function(tahunAwal, bulanAwal, hariTarget, calEvents, semester) {
                const activeDates = [];
                const colEvents = new Array(30).fill(null);
                
                // Map events to columns
                Object.keys(calEvents).forEach(dateStr => {
                    const parts = dateStr.split('-');
                    if (parts.length === 3) {
                        const y = parseInt(parts[0]);
                        const mo = parseInt(parts[1]) - 1;
                        const d = parseInt(parts[2]);
                        
                        let mIdx = mo - bulanAwal;
                        if (semester === "Ganjil" && mIdx < 0) mIdx += 12;
                        if (semester === "Genap" && mIdx < 0) mIdx += 12;
                        
                        if (mIdx >= 0 && mIdx < 6) {
                            const wIdx = Math.min(Math.ceil(d / 7) - 1, 4);
                            const cIdx = mIdx * 5 + wIdx;
                            colEvents[cIdx] = calEvents[dateStr];
                        }
                    }
                });
                
                // Calculate active dates
                for (let i = 0; i < 6; i++) {
                    let curBulan = bulanAwal + i;
                    let curYear = tahunAwal;
                    
                    if (semester === "Ganjil" && curBulan > 11) {
                        curYear++;
                        curBulan -= 12;
                    }
                    if (semester === "Genap" && curBulan > 11) {
                        curYear++;
                        curBulan -= 12;
                    }
                    
                    const daysInMonth = new Date(curYear, curBulan + 1, 0).getDate();
                    
                    for (let tgl = 1; tgl <= daysInMonth; tgl++) {
                        const date = new Date(curYear, curBulan, tgl);
                        if (date.getDay() === hariTarget) {
                            const wIdx = Math.min(Math.ceil(tgl / 7) - 1, 4);
                            const cIdx = i * 5 + wIdx;
                            if (colEvents[cIdx] === null) {
                                activeDates.push(date);
                            }
                        }
                    }
                }
                
                return activeDates;
            },
            
            // =========================================
            // RENDER ATP & PROTA
            // =========================================
            renderATPProta: function(mapel, kelas, semester, jp, activeDates, fase) {
                const mode = document.getElementById('in-atp-mode')?.value || "semester";
                const dataRender = [];
                
                // Collect data based on mode
                if (mode === "tahun" && this.curriculumData[mapel]?.[kelas]) {
                    ["Ganjil", "Genap"].forEach(smt => {
                        if (this.curriculumData[mapel][kelas][smt]) {
                            Object.keys(this.curriculumData[mapel][kelas][smt]).forEach(bab => {
                                dataRender.push({
                                    semester: smt,
                                    bab: bab,
                                    data: this.curriculumData[mapel][kelas][smt][bab]
                                });
                            });
                        }
                    });
                } else if (this.curriculumData[mapel]?.[kelas]?.[semester]) {
                    Object.keys(this.curriculumData[mapel][kelas][semester]).forEach(bab => {
                        dataRender.push({
                            semester: semester,
                            bab: bab,
                            data: this.curriculumData[mapel][kelas][semester][bab]
                        });
                    });
                }
                
                // Build ATP HTML
                let atpHtml = "";
                let protaHtml = "";
                let dateIdx = 0;
                this.promesRows = [];
                
                dataRender.forEach((item, idx) => {
                    const tpCount = item.data.tps.length;
                    const totalJp = tpCount * jp;
                    
                    item.data.tps.forEach((tpObj, tpIdx) => {
                        // ATP Row
                        atpHtml += `<tr>`;
                        if (tpIdx === 0) {
                            atpHtml += `<td rowspan="${tpCount}" class="text-center align-middle font-bold">${idx + 1}</td>`;
                            atpHtml += `<td rowspan="${tpCount}" class="bg-slate-50 align-middle"><strong>${item.bab}</strong><br><span class="text-xs text-slate-500">${item.data.cp?.substring(0, 100) || ""}...</span></td>`;
                        }
                        atpHtml += `<td contenteditable="true">${tpObj.tp}</td>`;
                        atpHtml += `<td class="text-xs text-center">${tpObj.profil || "Penalaran Kritis"}</td>`;
                        atpHtml += `<td class="font-semibold text-amber-600 text-center">Memahami<br>Menerapkan</td>`;
                        if (tpIdx === 0) {
                            atpHtml += `<td rowspan="${tpCount}" class="text-center align-middle font-bold text-blue-600">${totalJp} JP</td>`;
                        }
                        atpHtml += `</tr>`;
                        
                        // PROTA Row
                        protaHtml += `<tr>`;
                        if (tpIdx === 0) {
                            protaHtml += `<td rowspan="${tpCount}" class="font-bold text-center align-middle">${item.semester}</td>`;
                            protaHtml += `<td rowspan="${tpCount}" class="bg-slate-50 font-semibold text-center align-middle">${item.bab}</td>`;
                        }
                        protaHtml += `<td contenteditable="true">${tpObj.tp}</td>`;
                        if (tpIdx === 0) {
                            protaHtml += `<td rowspan="${tpCount}" class="font-bold text-center align-middle text-blue-600">${totalJp} JP</td>`;
                        }
                        protaHtml += `</tr>`;
                        
                        // Build promes rows data
                        if (mode === "semester" || item.semester === semester) {
                            let dt = null;
                            if (activeDates && dateIdx < activeDates.length) {
                                dt = activeDates[dateIdx];
                                dateIdx++;
                            }
                            this.promesRows.push({
                                bab: tpIdx === 0 ? item.bab : "",
                                tp: tpObj.tp,
                                jp: jp,
                                date: dt,
                                rowspan: tpIdx === 0 ? tpCount : 0
                            });
                        }
                    });
                });
                
                // Empty state
                if (!atpHtml) {
                    atpHtml = `<tr><td colspan="6" class="text-center text-slate-400 italic py-8">Pilih Mata Pelajaran, Kelas, dan Semester untuk menampilkan data</td></tr>`;
                    protaHtml = `<tr><td colspan="4" class="text-center text-slate-400 italic py-8">Pilih Mata Pelajaran, Kelas, dan Semester untuk menampilkan data</td></tr>`;
                }
                
                document.getElementById('out-atp').innerHTML = atpHtml;
                document.getElementById('out-prota').innerHTML = protaHtml;
            },
            
            // =========================================
            // RENDER PROMES
            // =========================================
            renderPromes: function(jp, calEvents, semester, bulanAwal, tahunAwal) {
                const namaBulan = semester === "Ganjil" 
                    ? ["Jul", "Ags", "Sep", "Okt", "Nov", "Des"]
                    : ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun"];
                
                // Build header
                let thead = `<tr>
                    <th rowspan="2" width="12%">Bab / Elemen</th>
                    <th rowspan="2" width="25%">Tujuan Pembelajaran (TP)</th>
                    <th rowspan="2" width="4%">JP</th>`;
                namaBulan.forEach(b => thead += `<th colspan="5">${b}</th>`);
                thead += `</tr><tr>`;
                for (let i = 0; i < 6; i++) {
                    for (let w = 1; w <= 5; w++) {
                        thead += `<th class="text-[7pt]">${w}</th>`;
                    }
                }
                thead += `</tr>`;
                
                // Map column events
                const colEvents = new Array(30).fill(null);
                Object.keys(calEvents).forEach(dateStr => {
                    const parts = dateStr.split('-');
                    if (parts.length === 3) {
                        const mo = parseInt(parts[1]) - 1;
                        const d = parseInt(parts[2]);
                        let mIdx = mo - bulanAwal;
                        if (semester === "Ganjil" && mIdx < 0) mIdx += 12;
                        if (mIdx >= 0 && mIdx < 6) {
                            const wIdx = Math.min(Math.ceil(d / 7) - 1, 4);
                            colEvents[mIdx * 5 + wIdx] = calEvents[dateStr];
                        }
                    }
                });
                
                // Build body
                let tbody = "";
                const rows = this.promesRows;
                
                if (rows.length > 0) {
                    rows.forEach((row, idx) => {
                        tbody += `<tr>`;
                        if (row.rowspan > 0) {
                            tbody += `<td rowspan="${row.rowspan}" class="bg-slate-50 font-bold text-center align-middle text-[9pt]" contenteditable="true">${row.bab}</td>`;
                        }
                        tbody += `<td contenteditable="true" class="text-[8pt]">${row.tp}</td>`;
                        tbody += `<td class="text-center font-bold align-middle">${row.jp}</td>`;
                        
                        for (let c = 0; c < 30; c++) {
                            if (colEvents[c]) {
                                // Event cell (vertical text)
                                if (idx === 0) {
                                    tbody += `<td rowspan="${rows.length}" class="event-cell"><div class="vertical-event">${colEvents[c].toUpperCase()}</div></td>`;
                                }
                            } else {
                                // Normal cell - check if date matches
                                const mIdx = Math.floor(c / 5);
                                const wIdx = (c % 5) + 1;
                                let curBulan = bulanAwal + mIdx;
                                if (curBulan > 11) curBulan -= 12;
                                
                                if (row.date && row.date.getMonth() === curBulan && Math.min(Math.ceil(row.date.getDate() / 7), 5) === wIdx) {
                                    tbody += `<td class="bg-blue-100 text-center font-bold text-blue-800 align-middle text-[8pt]" contenteditable="true">${row.date.getDate()}</td>`;
                                } else {
                                    tbody += `<td contenteditable="true"></td>`;
                                }
                            }
                        }
                        tbody += `</tr>`;
                    });
                } else {
                    tbody = `<tr><td colspan="33" class="text-center text-slate-400 italic py-8">Data kosong. Pilih mapel dan kelas terlebih dahulu.</td></tr>`;
                }
                
                document.getElementById('out-promes-head').innerHTML = thead;
                document.getElementById('out-promes-body').innerHTML = tbody;
            },
            
            // =========================================
            // RENDER JURNAL
            // =========================================
            renderJurnal: function(mapel, kelas, semester, tahunAwal, holidays) {
                const tipeGuru = document.getElementById('in-tipe-guru')?.value || "mapel";
                const rombel = document.getElementById('in-rombel')?.value || "A";
                const tempat = document.getElementById('in-tempat')?.value || "";
                const guru = document.getElementById('in-guru')?.value || "";
                const nipGuru = document.getElementById('in-nip-guru')?.value || "";
                const kepsek = document.getElementById('in-kepsek')?.value || "";
                const nipKepsek = document.getElementById('in-nip-kepsek')?.value || "";
                
                const colHeader = tipeGuru === "mapel" ? "Kelas/Rombel" : "Mata Pelajaran";
                const colValue = tipeGuru === "mapel" ? `${kelas}/${rombel}` : mapel;
                
                // Group by month
                const jurnalPerBulan = {};
                let currentBab = "";
                
                this.promesRows.forEach(row => {
                    if (row.date) {
                        const key = `${row.date.getMonth()}-${row.date.getFullYear()}`;
                        if (!jurnalPerBulan[key]) jurnalPerBulan[key] = [];
                        if (row.bab) currentBab = row.bab;
                        jurnalPerBulan[key].push({
                            ...row,
                            bab: currentBab
                        });
                    }
                });
                
                let html = "";
                
                Object.keys(jurnalPerBulan).forEach(key => {
                    const [moStr, yrStr] = key.split('-');
                    const mo = parseInt(moStr);
                    const yr = parseInt(yrStr);
                    const items = jurnalPerBulan[key];
                    const tglTtd = this.Utils.getLastWorkingDay(yr, mo, holidays);
                    
                    html += `
                    <div class="paper-preview landscape mb-8">
                        <h1 class="text-center text-[14pt] font-bold mb-6 uppercase" contenteditable="true">
                            JURNAL PELAKSANAAN PEMBELAJARAN<br>
                            BULAN ${BULAN[mo].toUpperCase()} ${yr}
                        </h1>
                        <table class="doc-table text-sm">
                            <thead>
                                <tr>
                                    <th width="10%">Tanggal</th>
                                    <th width="12%">${colHeader}</th>
                                    <th width="18%">Materi/Bab</th>
                                    <th width="30%">Tujuan Pembelajaran</th>
                                    <th width="12%">Kehadiran</th>
                                    <th width="18%">Keterangan</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    items.forEach(item => {
                        const dateStr = `${String(item.date.getDate()).padStart(2, '0')}/${String(mo + 1).padStart(2, '0')}/${yr}`;
                        html += `
                            <tr>
                                <td class="text-center font-semibold">${dateStr}</td>
                                <td contenteditable="true" class="text-center">${colValue}</td>
                                <td contenteditable="true">${item.bab}</td>
                                <td contenteditable="true">${item.tp}</td>
                                <td contenteditable="true" class="text-center font-bold text-emerald-600">Hadir Semua</td>
                                <td contenteditable="true">KBM berjalan lancar</td>
                            </tr>`;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                        <div class="signature-area" contenteditable="true">
                            <div class="signature-box">
                                Mengetahui,<br>Kepala Sekolah
                                <div class="signature-name">${kepsek}</div>
                                NIP. ${nipKepsek}
                            </div>
                            <div class="signature-box">
                                ${tempat}, ${tglTtd}<br>
                                Guru Mata Pelajaran
                                <div class="signature-name">${guru}</div>
                                NIP. ${nipGuru}
                            </div>
                        </div>
                    </div>`;
                });
                
                if (!html) {
                    html = `<div class="paper-preview text-center py-16 text-slate-400 italic">
                        Data jurnal tidak ditemukan.<br>Pastikan setting kalender dan jadwal sudah benar.
                    </div>`;
                }
                
                document.getElementById('jurnal-container').innerHTML = html;
            },
            
            // =========================================
            // RENDER ABSENSI
            // =========================================
            renderAbsensi: function(mapel, kelas, semester, tahunAwal, holidays) {
                const rombel = document.getElementById('in-rombel')?.value || "A";
                const tempat = document.getElementById('in-tempat')?.value || "";
                const guru = document.getElementById('in-guru')?.value || "";
                const nipGuru = document.getElementById('in-nip-guru')?.value || "";
                const kepsek = document.getElementById('in-kepsek')?.value || "";
                const nipKepsek = document.getElementById('in-nip-kepsek')?.value || "";
                
                // Group by month
                const absenPerBulan = {};
                this.promesRows.forEach(row => {
                    if (row.date) {
                        const key = `${row.date.getMonth()}-${row.date.getFullYear()}`;
                        if (!absenPerBulan[key]) absenPerBulan[key] = [];
                        absenPerBulan[key].push(row.date);
                    }
                });
                
                let html = "";
                const students = this.students.length > 0 ? this.students : ["Siswa 1", "Siswa 2", "Siswa 3"];
                
                Object.keys(absenPerBulan).forEach(key => {
                    const [moStr, yrStr] = key.split('-');
                    const mo = parseInt(moStr);
                    const yr = parseInt(yrStr);
                    const dates = absenPerBulan[key];
                    const tglTtd = this.Utils.getLastWorkingDay(yr, mo, holidays);
                    
                    // Date headers
                    let dateHeaders = "";
                    dates.forEach(d => {
                        dateHeaders += `<th class="text-[8pt]">${d.getDate()}</th>`;
                    });
                    
                    html += `
                    <div class="paper-preview portrait mb-8">
                        <h1 class="text-center text-[14pt] font-bold mb-6 uppercase" contenteditable="true">
                            DAFTAR HADIR / PRESENSI SISWA<br>
                            BULAN ${BULAN[mo].toUpperCase()} ${yr}
                        </h1>
                        <table class="mb-4 text-[11pt] font-semibold w-full" contenteditable="true">
                            <tr><td width="180">Mata Pelajaran</td><td>: ${mapel}</td></tr>
                            <tr><td>Kelas / Rombel</td><td>: ${kelas} / ${rombel}</td></tr>
                        </table>
                        <table class="doc-table text-[9pt] text-center">
                            <thead>
                                <tr>
                                    <th rowspan="2" width="5%">No</th>
                                    <th rowspan="2" width="30%" class="text-left">Nama Siswa</th>
                                    <th colspan="${dates.length}">Tanggal Pertemuan</th>
                                    <th colspan="4" class="bg-slate-100">Rekap</th>
                                </tr>
                                <tr>
                                    ${dateHeaders}
                                    <th class="text-[7pt] bg-blue-50">H</th>
                                    <th class="text-[7pt] bg-amber-50">S</th>
                                    <th class="text-[7pt] bg-purple-50">I</th>
                                    <th class="text-[7pt] bg-red-50">A</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    students.forEach((name, idx) => {
                        html += `<tr>
                            <td class="font-semibold">${idx + 1}</td>
                            <td class="text-left" contenteditable="true">${name}</td>`;
                        
                        for (let c = 0; c < dates.length; c++) {
                            html += `<td><div onclick="AGSA.toggleAbsen(this)" class="cursor-pointer font-bold text-blue-600 hover:bg-blue-100 rounded p-1">H</div></td>`;
                        }
                        
                        html += `
                            <td class="bg-blue-50 font-bold" contenteditable="true">${dates.length}</td>
                            <td class="bg-amber-50" contenteditable="true">0</td>
                            <td class="bg-purple-50" contenteditable="true">0</td>
                            <td class="bg-red-50" contenteditable="true">0</td>
                        </tr>`;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                        <p class="text-xs text-slate-500 mt-2">Keterangan: H=Hadir, S=Sakit, I=Izin, A=Alpa (Klik status untuk mengubah)</p>
                        <div class="signature-area" contenteditable="true">
                            <div class="signature-box">
                                Mengetahui,<br>Kepala Sekolah
                                <div class="signature-name">${kepsek}</div>
                                NIP. ${nipKepsek}
                            </div>
                            <div class="signature-box">
                                ${tempat}, ${tglTtd}<br>
                                Guru Mata Pelajaran
                                <div class="signature-name">${guru}</div>
                                NIP. ${nipGuru}
                            </div>
                        </div>
                    </div>`;
                });
                
                if (!html) {
                    html = `<div class="paper-preview text-center py-16 text-slate-400 italic">
                        Data absensi tidak ditemukan.<br>Pastikan setting kalender dan jadwal sudah benar.
                    </div>`;
                }
                
                document.getElementById('absensi-container').innerHTML = html;
            },
            
            // Toggle absensi status
            toggleAbsen: function(el) {
                const states = {
                    'H': { next: 'S', color: 'text-amber-500' },
                    'S': { next: 'I', color: 'text-purple-500' },
                    'I': { next: 'A', color: 'text-red-600' },
                    'A': { next: 'H', color: 'text-blue-600' }
                };
                
                const current = el.innerText.trim();
                const next = states[current] || states['A'];
                el.innerText = next.next;
                el.className = `cursor-pointer font-bold ${next.color} hover:bg-blue-100 rounded p-1`;
            },
            
            // =========================================
            // RENDER KKTP
            // =========================================
            renderKKTP: function(mapel, kelas, semester) {
                const data = this.curriculumData[mapel]?.[kelas]?.[semester];
                if (!data) {
                    document.getElementById('out-kktp').innerHTML = `<tr><td colspan="6" class="text-center text-slate-400 italic py-8">Pilih mapel, kelas, dan semester</td></tr>`;
                    return;
                }
                
                let html = "";
                let no = 1;
                
                Object.keys(data).forEach(elemen => {
                    const tps = data[elemen].tps;
                    tps.forEach((tpObj, idx) => {
                        html += `<tr>`;
                        html += `<td class="text-center font-semibold">${no++}</td>`;
                        html += `<td contenteditable="true">${tpObj.tp}</td>`;
                        html += `<td class="kktp-val" contenteditable="true" oninput="AGSA.calcKKTP(this)">75</td>`;
                        html += `<td class="kktp-val" contenteditable="true" oninput="AGSA.calcKKTP(this)">75</td>`;
                        html += `<td class="kktp-val" contenteditable="true" oninput="AGSA.calcKKTP(this)">75</td>`;
                        html += `<td class="kktp-hasil">75</td>`;
                        html += `</tr>`;
                    });
                });
                
                if (!html) {
                    html = `<tr><td colspan="6" class="text-center text-slate-400 italic py-8">Data TP tidak ditemukan</td></tr>`;
                }
                
                document.getElementById('out-kktp').innerHTML = html;
            },
            
            // Calculate KKTP
            calcKKTP: function(el) {
                const row = el.closest('tr');
                const vals = row.querySelectorAll('.kktp-val');
                const hasil = row.querySelector('.kktp-hasil');
                
                if (vals.length === 3 && hasil) {
                    const avg = Math.round(
                        ((parseFloat(vals[0].innerText) || 0) +
                        (parseFloat(vals[1].innerText) || 0) +
                        (parseFloat(vals[2].innerText) || 0)) / 3
                    );
                    hasil.innerText = avg;
                }
            },
            
            // =========================================
            // RENDER NILAI
            // =========================================
            renderNilai: function() {
                const students = this.students.length > 0 ? this.students : ["Siswa 1", "Siswa 2", "Siswa 3"];
                
                let html = "";
                students.forEach((name, idx) => {
                    html += `
                    <tr>
                        <td class="font-semibold">${idx + 1}</td>
                        <td class="text-left" contenteditable="true">${name}</td>
                        <td contenteditable="true" oninput="AGSA.calcNilai(this)"></td>
                        <td contenteditable="true" oninput="AGSA.calcNilai(this)"></td>
                        <td contenteditable="true" oninput="AGSA.calcNilai(this)"></td>
                        <td contenteditable="true" oninput="AGSA.calcNilai(this)"></td>
                        <td class="bg-slate-100 font-bold nilai-rata"></td>
                        <td contenteditable="true" class="nilai-sts" oninput="AGSA.calcNilai(this)"></td>
                        <td contenteditable="true" class="nilai-sas" oninput="AGSA.calcNilai(this)"></td>
                        <td class="font-bold bg-blue-50 text-blue-800 nilai-rapor"></td>
                    </tr>`;
                });
                
                document.getElementById('out-nilai').innerHTML = html;
            },
            
            // Calculate Nilai
            calcNilai: function(el) {
                const row = el.closest('tr');
                const sumatifCells = Array.from(row.querySelectorAll('td')).slice(2, 6);
                const rataCell = row.querySelector('.nilai-rata');
                const stsCell = row.querySelector('.nilai-sts');
                const sasCell = row.querySelector('.nilai-sas');
                const raporCell = row.querySelector('.nilai-rapor');
                
                // Calculate average of sumatif
                let sum = 0, count = 0;
                sumatifCells.forEach(cell => {
                    const val = parseFloat(cell.innerText);
                    if (!isNaN(val)) {
                        sum += val;
                        count++;
                    }
                });
                const rata = count > 0 ? Math.round(sum / count) : 0;
                rataCell.innerText = rata || "";
                
                // Calculate nilai rapor: 50% rata + 25% STS + 25% SAS
                const sts = parseFloat(stsCell?.innerText) || 0;
                const sas = parseFloat(sasCell?.innerText) || 0;
                
                if (rata || sts || sas) {
                    const nr = Math.round((rata * 0.5) + (sts * 0.25) + (sas * 0.25));
                    raporCell.innerText = nr;
                }
            },
            
            // =========================================
            // RENDER MODUL AJAR
            // =========================================
            renderModul: function(mapel, kelas, semester, elemen, jp) {
                const data = this.curriculumData[mapel]?.[kelas]?.[semester]?.[elemen];
                if (!data) return;
                
                // Set CP
                const cpEl = document.getElementById('out-modul-cp');
                if (cpEl) cpEl.textContent = data.cp || "Capaian Pembelajaran belum diatur";
                
                // Set JP total
                document.querySelectorAll('.v-jp-total').forEach(el => {
                    el.textContent = data.tps.length * jp;
                });
                
                // Set TP list
                let tpHtml = "";
                data.tps.forEach((tpObj, idx) => {
                    tpHtml += `<li><strong>TP ${idx + 1}:</strong> ${tpObj.tp}</li>`;
                });
                
                document.getElementById('out-modul-tp').innerHTML = tpHtml;
                document.getElementById('out-lkpd-tp').innerHTML = tpHtml;
                
                // Generate learning steps
                let langkahHtml = "";
                data.tps.forEach((tpObj, idx) => {
                    langkahHtml += `
                    <div class="mb-6 bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <div class="font-bold text-lg text-blue-800 border-b-2 border-blue-200 pb-2 mb-4">
                            Pertemuan ${idx + 1} (${jp} JP) - ${tpObj.tp.substring(0, 50)}...
                        </div>
                        
                        <div class="mb-4">
                            <p class="font-bold text-slate-700 underline mb-2">A. PENDAHULUAN (¬±15 Menit)</p>
                            <ol class="list-decimal pl-6 space-y-1 text-justify">
                                <li>Guru membuka pembelajaran dengan salam, berdoa bersama, dan mengecek kehadiran siswa.</li>
                                <li>Guru memberikan apersepsi dengan mengaitkan materi sebelumnya atau pengalaman siswa dengan topik <strong>${elemen}</strong>.</li>
                                <li>Guru menyampaikan tujuan pembelajaran yang akan dicapai pada pertemuan ini.</li>
                                <li>Guru memberikan motivasi tentang pentingnya materi yang akan dipelajari.</li>
                            </ol>
                        </div>
                        
                        <div class="mb-4">
                            <p class="font-bold text-slate-700 underline mb-2">B. KEGIATAN INTI (¬±${jp * 35 - 30} Menit)</p>
                            <ol class="list-decimal pl-6 space-y-1 text-justify">
                                <li><strong>Orientasi Masalah:</strong> Peserta didik mengamati tayangan/media/teks yang disajikan guru terkait dengan ${tpObj.tp}.</li>
                                <li><strong>Mengorganisasi Peserta Didik:</strong> Guru membagi siswa ke dalam kelompok (4-5 orang) untuk diskusi.</li>
                                <li><strong>Membimbing Penyelidikan:</strong> Peserta didik mengerjakan LKPD secara berkelompok dengan bimbingan guru.</li>
                                <li><strong>Mengembangkan & Menyajikan:</strong> Setiap kelompok mempresentasikan hasil diskusi di depan kelas.</li>
                                <li><strong>Menganalisis & Evaluasi:</strong> Guru dan siswa melakukan tanya jawab dan memberikan umpan balik.</li>
                            </ol>
                        </div>
                        
                        <div>
                            <p class="font-bold text-slate-700 underline mb-2">C. PENUTUP (¬±15 Menit)</p>
                            <ol class="list-decimal pl-6 space-y-1 text-justify">
                                <li>Peserta didik bersama guru menyimpulkan materi pembelajaran yang telah dipelajari.</li>
                                <li>Guru melakukan refleksi mengenai kesulitan dan bagian yang menyenangkan dari pembelajaran.</li>
                                <li>Guru memberikan penguatan karakter dan motivasi kepada peserta didik.</li>
                                <li>Guru menyampaikan rencana pembelajaran pertemuan selanjutnya.</li>
                                <li>Pembelajaran ditutup dengan doa dan salam.</li>
                            </ol>
                        </div>
                    </div>`;
                });
                
                document.getElementById('out-modul-langkah').innerHTML = langkahHtml;
            }
        };
        
        // =============================================
        // INITIALIZE APPLICATION
        // =============================================
        document.addEventListener('DOMContentLoaded', () => {
            AGSA.init();
            
            // Check for super admin access (double-click on logo area)
            let clickCount = 0;
            document.querySelector('#sidebar > div:first-child')?.addEventListener('click', () => {
                clickCount++;
                if (clickCount >= 5) {
                    AGSA.Admin.open();
                    clickCount = 0;
                }
                setTimeout(() => clickCount = 0, 2000);
            });
        });
    </script>

</body>
</html>