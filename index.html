<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Guru Super App</title>
    <link rel="icon" href="data:,">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; overflow: hidden; }
        
        .paper-preview { background: white; margin: 20px auto; padding: 15mm; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); max-width: 297mm; min-height: 210mm; position: relative; }
        .paper-preview.portrait { max-width: 210mm; min-height: 297mm; }
        
        .doc-table { width: 100%; border-collapse: collapse; font-size: 10pt; margin-bottom: 20px; }
        .doc-table th, .doc-table td { border: 1px solid #1f2937; padding: 6px; text-align: left; vertical-align: top; }
        .doc-table th { background-color: #f1f5f9; font-weight: 600; text-align: center; vertical-align: middle; }
        
        .text-center { text-align: center !important; }
        .align-middle { vertical-align: middle !important; }
        
        /* Modifikasi Sel Promes agar sangat presisi saat diprint */
        .event-cell { vertical-align: middle !important; text-align: center !important; height: 130px; padding: 0 !important; background-color: #fca5a5 !important; }
        .vertical-event { writing-mode: vertical-rl; transform: scale(-1); margin: auto; font-size: 8pt; font-weight: bold; letter-spacing: 1px; color: #7f1d1d; white-space: nowrap; display: inline-block; }
        
        [contenteditable="true"]:hover { background-color: #fef08a; outline: 1px dashed #eab308; cursor: text; transition: 0.2s; }
        
        .kktp-val { background-color: #fdfde8; font-weight: bold; color: #2563eb; cursor: text; text-align: center;}
        .kktp-hasil { background-color: #e0f2fe; color: #1e40af; font-size: 11pt; text-align: center; font-weight: bold;}

        .signature-area { display: flex; justify-content: space-between; margin-top: 30px; page-break-inside: avoid; padding: 0 5%; }
        .signature-box { text-align: center; font-size: 11pt; min-width: 250px; }
        .signature-name { text-decoration: underline; font-weight: bold; margin-top: 80px; }

        .sidebar-scroll::-webkit-scrollbar { width: 5px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .csv-info { padding: 10px; background-color: #047857; border-radius: 6px; font-size: 0.8rem; display: none; margin-top: 5px; line-height: 1.4; color: white;}
        .csv-info.error { background-color: #991b1b; }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 700px; max-width: 90%; border-radius: 10px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }

        @media print {
            body { background: white; overflow: visible; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            #sidebar, #topbar, .no-print, #login-screen { display: none !important; }
            #main-content { margin: 0; padding: 0; width: 100%; overflow: visible; }
            .paper-preview { margin: 0; padding: 15mm; box-shadow: none; max-width: 100%; page-break-after: always; }
            .paper-preview:last-child { page-break-after: auto; }
            [contenteditable="true"]:hover { background-color: transparent; outline: none; }
            .kktp-val { background-color: transparent !important; color: black; }
            .kktp-hasil { background-color: #e0f2fe !important; }
            @page { size: A4 portrait; margin: 10mm; }
            .landscape { @page { size: A4 landscape; } width: 100% !important; }
            .portrait { width: 100% !important; }
        }
    </style>
</head>
<body class="flex h-screen text-slate-800">

    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center text-white">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl max-w-md w-full text-center border border-slate-700">
            <h1 class="text-3xl font-bold text-blue-400 mb-2">Admin Guru Super App</h1>
            <p class="text-slate-400 mb-8 text-sm">Sistem Administrasi Cerdas Terintegrasi</p>
            <button id="btn-login" class="w-full bg-white text-slate-800 font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-3 hover:bg-slate-100 transition shadow-lg">
                Masuk ke Aplikasi
            </button>
        </div>
    </div>

    <div id="modal-siswa" class="modal-overlay">
        <div class="modal-content relative">
            <button onclick="document.getElementById('modal-siswa').style.display='none'" class="absolute top-4 right-4 bg-red-500 text-white px-3 py-1 rounded font-bold hover:bg-red-600">X Tutup</button>
            <h2 class="text-xl font-bold text-emerald-600 mb-2">üìã Input Data Siswa Cepat</h2>
            <p class="text-sm text-slate-600 mb-4">Paste (Tempel) daftar nama siswa Anda. <b>1 baris = 1 nama siswa</b>.</p>
            <textarea id="in-data-siswa" rows="10" class="w-full border border-slate-300 rounded p-3 text-sm focus:border-emerald-500 outline-none" placeholder="1. Ahmad Fulan&#10;2. Siti Fulanah"></textarea>
            <button onclick="Engine.saveStudents()" class="w-full mt-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg shadow transition">Simpan Data Siswa</button>
        </div>
    </div>

    <aside id="sidebar" class="w-[340px] min-w-[340px] bg-slate-900 text-slate-300 flex flex-col h-full border-r border-slate-700 hidden no-print">
        <div class="p-5 border-b border-slate-700 flex justify-between items-center">
            <h2 class="text-xl font-bold text-white">Super App</h2>
            <span class="px-2 py-0.5 rounded text-xs font-semibold bg-emerald-500/20 text-emerald-400">PRO</span>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-5 sidebar-scroll text-sm">
            <button onclick="document.getElementById('modal-siswa').style.display='flex'" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 rounded-lg shadow transition">Input Data Siswa</button>

            <div>
                <label class="text-[10px] text-amber-500 uppercase font-bold">Tipe Guru</label>
                <select id="in-tipe-guru" onchange="Engine.syncAll()" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-amber-500 outline-none text-white font-bold cursor-pointer">
                    <option value="kelas">Guru Kelas</option>
                    <option value="mapel" selected>Guru Mata Pelajaran</option>
                </select>
            </div>

            <div class="border border-dashed border-amber-500 p-3 rounded-lg bg-amber-500/5">
                <h3 class="text-xs font-bold text-amber-500 mb-2">1. DATABASE KURIKULUM</h3>
                <select id="in-jenjang" onchange="Engine.fetchGlobalCSV()" class="w-full bg-slate-950 border border-slate-600 rounded p-2 text-sm focus:border-amber-500 outline-none text-white font-bold cursor-pointer mb-2">
                    <option value="SD">SD / MI</option><option value="SMP">SMP / MTs</option><option value="SMA">SMA / SMK / MA</option>
                </select>
                <div class="flex flex-col gap-2">
                    <button onclick="Engine.fetchGlobalCSV()" class="w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-1.5 rounded text-xs transition">A. Load dari Cloud</button>
                    <div class="relative w-full">
                        <input type="file" accept=".csv" onchange="Engine.uploadCSV(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <button class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-1.5 rounded text-xs transition border border-slate-500">B. Upload CSV Manual</button>
                    </div>
                </div>
                <div id="csvStatus" class="csv-info"></div>
            </div>

            <div>
                <h3 class="text-xs font-bold text-slate-400 mb-2">2. MAPEL & KELAS</h3>
                <div class="space-y-2">
                    <select id="in-mapel" onchange="Engine.updateKelasList()" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none font-bold text-blue-400 cursor-pointer"><option value="">-- Kosong --</option></select>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="in-kelas" onchange="Engine.updateSemesterList()" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none cursor-pointer"><option value="">-</option></select>
                        <select id="in-semester" onchange="Engine.updateBabList()" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none cursor-pointer"><option value="">-</option></select>
                    </div>
                    <select id="in-elemen" onchange="Engine.syncAll()" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none cursor-pointer"><option value="">-</option></select>
                </div>
            </div>

            <div>
                <h3 class="text-xs font-bold text-slate-400 mb-2">3. IDENTITAS SEKOLAH</h3>
                <div class="space-y-2">
                    <input type="text" id="in-sekolah" placeholder="Nama Sekolah" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none" value="SDN Cerdas Bangsa">
                    <input type="text" id="in-kepsek" placeholder="Nama Kepala Sekolah" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none" value="Budi, S.Pd., M.Pd.">
                    <input type="text" id="in-nip-kepsek" placeholder="NIP Kepala Sekolah" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none" value="19800101 200501 1 001">
                    <input type="text" id="in-guru" placeholder="Nama Guru" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none" value="Siti Aminah, S.Pd.">
                    <input type="text" id="in-nip-guru" placeholder="NIP Guru" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none" value="19900202 201502 2 002">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="in-rombel" placeholder="Rombel" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none text-center" value="A">
                        <input type="number" id="in-tahun" placeholder="Tahun Awal" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none text-center" value="2025">
                    </div>
                    <input type="text" id="in-tempat-tgl" placeholder="Tempat TTD" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none" value="Jakarta">
                </div>
            </div>

            <div>
                <h3 class="text-xs font-bold text-slate-400 mb-2">4. KALENDER CERDAS</h3>
                <div class="space-y-2">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase">Hari Mengajar</label>
                            <select id="in-hari" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none cursor-pointer">
                                <option value="1" selected>Senin</option><option value="2">Selasa</option><option value="3">Rabu</option>
                                <option value="4">Kamis</option><option value="5">Jum'at</option><option value="6">Sabtu</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase">JP / Pertemuan</label>
                            <input type="number" id="in-jp" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none text-center" value="4">
                        </div>
                    </div>

                    <div class="p-2 border border-slate-700 bg-slate-800/50 rounded space-y-2 mt-2">
                        <label class="text-[10px] text-emerald-400 uppercase font-bold block mb-1">üìÖ Titik Penetapan Semester</label>
                        <div class="grid grid-cols-2 gap-2">
                            <div title="Tanggal Pertama Masuk Sekolah Bulan Juli">
                                <label class="text-[9px] text-slate-400">Awal Masuk (Juli)</label>
                                <input type="date" id="in-masuk-ganjil" class="w-full bg-slate-900 border border-slate-600 rounded px-1 py-1.5 focus:border-blue-500 text-xs text-slate-200">
                            </div>
                            <div title="Tanggal Rapor Semester Ganjil (Desember)">
                                <label class="text-[9px] text-slate-400">Rapor (Desember)</label>
                                <input type="date" id="in-rapor-ganjil" class="w-full bg-slate-900 border border-slate-600 rounded px-1 py-1.5 focus:border-blue-500 text-xs text-slate-200">
                            </div>
                            <div title="Tanggal Pertama Masuk Semester Genap (Januari)">
                                <label class="text-[9px] text-slate-400">Awal Masuk (Jan)</label>
                                <input type="date" id="in-masuk-genap" class="w-full bg-slate-900 border border-slate-600 rounded px-1 py-1.5 focus:border-blue-500 text-xs text-slate-200">
                            </div>
                            <div title="Tanggal Rapor Semester Genap / Kenaikan (Juni)">
                                <label class="text-[9px] text-slate-400">Rapor (Juni)</label>
                                <input type="date" id="in-rapor-genap" class="w-full bg-slate-900 border border-slate-600 rounded px-1 py-1.5 focus:border-blue-500 text-xs text-slate-200">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] text-amber-500 uppercase font-bold mt-2 block">Agenda Tambahan (YYYY-MM-DD = Libur)</label>
                        <textarea id="in-libur" rows="6" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-xs focus:border-blue-500 outline-none text-slate-200 leading-relaxed"></textarea>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="p-4 border-t border-slate-700">
            <button onclick="Engine.syncAll()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3 rounded-lg shadow-lg shadow-blue-500/30 transition transform active:scale-95">
                üöÄ GENERATE DOKUMEN
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col hidden" id="main-wrapper">
        <header id="topbar" class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 no-print">
            <div class="flex space-x-1 overflow-x-auto">
                <button onclick="UI.switchTab('atp')" class="nav-tab px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600">ATP & Prota</button>
                <button onclick="UI.switchTab('promes')" class="nav-tab px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700">Promes</button>
                <button onclick="UI.switchTab('modul')" class="nav-tab px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700">Modul & LKPD</button>
                <button onclick="UI.switchTab('jurnal')" class="nav-tab px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700">Jurnal</button>
                <button onclick="UI.switchTab('absensi')" class="nav-tab px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700">Absensi</button>
                <button onclick="UI.switchTab('kktp')" class="nav-tab px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700">KKTP & Nilai</button>
                <button onclick="UI.switchTab('kalender')" class="nav-tab px-4 py-2 text-sm font-medium text-emerald-600 border border-emerald-200 bg-emerald-50 rounded ml-2 hover:bg-emerald-100">üìÖ Kalender & Jadwal</button>
            </div>
            <button onclick="window.print()" class="bg-slate-800 text-white px-5 py-2 rounded-md text-sm font-semibold hover:bg-slate-700 shadow flex items-center gap-2 transition">üñ®Ô∏è Cetak PDF</button>
        </header>

        <div id="main-content" class="flex-1 overflow-y-auto p-8">
            
            <div id="view-atp" class="view-section block">
                <div class="no-print mb-4 flex justify-end gap-2">
                    <select id="in-atp-mode" onchange="Engine.syncAll()" class="p-2 border border-slate-300 rounded text-sm outline-none bg-white font-bold text-blue-700 shadow-sm cursor-pointer">
                        <option value="semester">Cetak 1 Semester (Aktif)</option>
                        <option value="tahun">Cetak 1 Tahun Penuh (Ganjil & Genap)</option>
                    </select>
                </div>
                
                <div class="paper-preview landscape">
                    <h1 class="header-title text-center text-[14pt] font-bold mb-5 uppercase" contenteditable="true">ALUR TUJUAN PEMBELAJARAN (ATP)<br>TAHUN PELAJARAN <span class="v-thn"></span></h1>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; font-size: 11pt;" contenteditable="true">
                        <table style="text-align: left; line-height: 1.5;">
                            <tr><td width="160">NAMA SEKOLAH</td><td>: <span class="v-sekolah"></span></td></tr>
                            <tr><td>MATA PELAJARAN</td><td>: <span class="v-mapel text-blue-700 uppercase"></span></td></tr>
                            <tr><td>FASE</td><td>: <span class="v-fase"></span></td></tr>
                        </table>
                        <table style="text-align: left; line-height: 1.5;">
                            <tr><td width="100">KELAS</td><td>: <span class="v-kls"></span></td></tr>
                            <tr><td>SEMESTER</td><td>: <span class="v-smt"></span></td></tr>
                        </table>
                    </div>
                    <table class="doc-table">
                        <thead><tr><th width="3%">NO</th><th width="20%">ELEMEN DAN CAPAIAN PEMBELAJARAN (CP)</th><th width="22%">TUJUAN PEMBELAJARAN (TP)</th><th width="15%">PROFIL LULUSAN</th><th width="10%">KOMPETENSI</th><th width="8%">WAKTU</th></tr></thead>
                        <tbody id="out-atp"><tr><td colspan="6" class="text-center italic text-slate-400">Silakan muat data dan klik tombol Generate...</td></tr></tbody>
                    </table>
                    <div class="signature-area" contenteditable="true">
                        <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name v-kepsek"></div>NIP. <span class="v-nip-kepsek"></span></div>
                        <div class="signature-box"><span class="v-tempat-tgl"></span><br>Guru Mata Pelajaran<br><div class="signature-name v-guru"></div>NIP. <span class="v-nip-guru"></span></div>
                    </div>
                </div>

                <div class="paper-preview portrait mt-10">
                    <h1 class="header-title text-center text-[14pt] font-bold mb-5 uppercase" contenteditable="true">PROGRAM TAHUNAN (PROTA)<br><span class="v-mapel uppercase"></span></h1>
                    <table class="identity-table mb-4" contenteditable="true" style="font-weight: bold; font-size: 11pt; width: 100%;">
                        <tr><td width="150">Satuan Pendidikan</td><td>: <span class="v-sekolah"></span></td></tr>
                        <tr><td>Fase / Kelas</td><td>: <span class="v-fase"></span> / <span class="v-kls"></span></td></tr>
                        <tr><td>Tahun Pelajaran</td><td>: <span class="v-thn"></span></td></tr>
                    </table>
                    <table class="doc-table">
                        <thead><tr><th width="10%">Smt</th><th width="25%">Elemen & Capaian Pembelajaran</th><th width="55%">Tujuan Pembelajaran (TP)</th><th width="10%">JP</th></tr></thead>
                        <tbody id="out-prota"></tbody>
                    </table>
                    <div class="signature-area" contenteditable="true">
                        <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name v-kepsek"></div>NIP. <span class="v-nip-kepsek"></span></div>
                        <div class="signature-box"><span class="v-tempat-tgl"></span><br>Guru Mata Pelajaran<br><div class="signature-name v-guru"></div>NIP. <span class="v-nip-guru"></span></div>
                    </div>
                </div>
            </div>

            <div id="view-promes" class="view-section hidden">
                <div class="paper-preview landscape">
                    <h1 class="header-title text-center text-[14pt] font-bold mb-5 uppercase" contenteditable="true">PROGRAM SEMESTER (PROSEM)<br>SEMESTER <span class="v-smt uppercase"></span></h1>
                    <table class="identity-table w-1/2 mb-4" contenteditable="true" style="font-weight: bold; font-size: 11pt;">
                        <tr><td width="150">Mata Pelajaran</td><td>: <span class="v-mapel text-blue-700"></span></td></tr>
                        <tr><td>Kelas/Rombel</td><td>: <span class="v-kls"></span> / <span class="v-rombel"></span></td></tr>
                    </table>
                    <table class="doc-table text-[8pt]">
                        <thead id="out-promes-head"></thead>
                        <tbody id="out-promes-body"></tbody>
                    </table>
                    <div class="signature-area" contenteditable="true">
                        <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name v-kepsek"></div>NIP. <span class="v-nip-kepsek"></span></div>
                        <div class="signature-box"><span class="v-tempat-tgl"></span><br>Guru Mata Pelajaran<br><div class="signature-name v-guru"></div>NIP. <span class="v-nip-guru"></span></div>
                    </div>
                </div>
            </div>

            <div id="view-modul" class="view-section hidden relative">
                <div class="no-print mb-4 bg-white p-3 rounded shadow flex items-center gap-4 border border-slate-200">
                    <label class="flex items-center gap-2 text-sm font-semibold cursor-pointer text-blue-600">
                        <input type="checkbox" checked onchange="document.getElementById('wrapper-lkpd').classList.toggle('hidden')"> Tampilkan Form LKPD
                    </label>
                </div>
                <div class="paper-preview portrait">
                    <h1 class="header-title text-center text-[14pt] font-bold mb-5 uppercase" contenteditable="true">MODUL AJAR KURIKULUM MERDEKA</h1>
                    <div class="font-bold text-[11pt] bg-slate-100 p-1 border-l-4 border-blue-600 mt-4 mb-2">A. IDENTITAS UMUM</div>
                    <table class="identity-table" contenteditable="true" style="font-weight: bold; font-size: 11pt; width: 100%;">
                        <tr><td width="150">Nama Penyusun</td><td>: <span class="v-guru"></span> (<span class="v-sekolah"></span>)</td></tr>
                        <tr><td>Mata Pelajaran</td><td>: <span class="v-mapel"></span></td></tr>
                        <tr><td>Kelas / Smt / Rombel</td><td>: <span class="v-kls"></span> / <span class="v-smt"></span> / <span class="v-rombel"></span></td></tr>
                        <tr><td>Topik Materi</td><td>: <span class="text-blue-600 font-bold v-bab-aktif"></span></td></tr>
                        <tr><td>Alokasi Waktu</td><td>: <span class="v-jp-bab"></span> JP</td></tr>
                    </table>
                    <div class="font-bold text-[11pt] bg-slate-100 p-1 border-l-4 border-blue-600 mt-4 mb-2">B. CAPAIAN & TUJUAN</div>
                    <div class="pl-4 mb-3" contenteditable="true">
                        <p id="out-modul-cp" class="mb-3 bg-blue-50 p-2 rounded border border-blue-100 text-sm text-justify"></p>
                        <div id="out-modul-tp" class="text-sm font-semibold"></div>
                    </div>
                    <div class="font-bold text-[11pt] bg-slate-100 p-1 border-l-4 border-blue-600 mt-4 mb-2">C. LANGKAH-LANGKAH OPERASIONAL (KBM)</div>
                    <div class="pl-4 mb-3 text-sm" contenteditable="true" id="out-modul-langkah"></div>
                    <div class="signature-area mt-8" contenteditable="true">
                        <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name v-kepsek"></div>NIP. <span class="v-nip-kepsek"></span></div>
                        <div class="signature-box"><span class="v-tempat-tgl"></span><br>Guru Mata Pelajaran<br><div class="signature-name v-guru"></div>NIP. <span class="v-nip-guru"></span></div>
                    </div>
                </div>

                <div id="wrapper-lkpd" class="paper-preview portrait mt-10">
                    <div class="border-2 border-dashed border-blue-600 p-6 rounded-xl bg-slate-50 h-full">
                        <h1 class="header-title text-center text-[16pt] font-bold text-blue-800 mb-4 uppercase" contenteditable="true">LEMBAR KERJA PESERTA DIDIK (LKPD)</h1>
                        <div class="flex justify-between border-b border-black pb-2 mb-4 font-bold" contenteditable="true">
                            <span>Nama Kelompok : .......................</span>
                            <span>Kelas: <span class="v-kls"></span>/<span class="v-rombel"></span></span>
                            <span>Nilai : .....</span>
                        </div>
                        <p class="font-bold text-blue-700">Mata Pelajaran: <span class="v-mapel"></span></p>
                        <p class="font-bold text-blue-700 mb-4">Materi Topik: <span class="v-bab-aktif"></span></p>
                        
                        <div class="content-body" contenteditable="true">
                            <p style="font-weight:bold; color:#1e40af; font-size:11pt;">A. Tujuan Kegiatan Hari Ini:</p>
                            <ul id="out-lkpd-tp" class="mb-4 bg-white p-2 border border-slate-200 rounded list-disc pl-5 text-sm font-semibold"></ul>
                            
                            <p style="font-weight:bold; color:#1e40af; font-size:11pt;">B. Petunjuk Pengerjaan:</p>
                            <ol class="list-decimal pl-5 mb-6 text-sm">
                                <li>Berdoalah terlebih dahulu sebelum memulai aktivitas.</li>
                                <li>Diskusikan instruksi di bawah ini secara seksama bersama kelompokmu.</li>
                                <li>Tuliskan hasil diskusi pada kolom dengan rapi dan jelas.</li>
                            </ol>

                            <p style="font-weight:bold; color:#1e40af; font-size:11pt; border-bottom:2px solid #ccc; padding-bottom:5px;">C. Kolom Pengerjaan / Tantangan:</p>
                            <div class="space-y-6 mt-4">
                                <div>
                                    <p class="font-bold text-sm mb-1">1. Tuliskan pemahaman utamamu mengenai materi ini secara detail!</p>
                                    <div class="border border-slate-400 bg-white p-4 rounded-lg min-h-[120px]"></div>
                                </div>
                                <div>
                                    <p class="font-bold text-sm mb-1">2. Berikan contoh nyata penerapan materi ini di lingkungan sekitarmu!</p>
                                    <div class="border border-slate-400 bg-white p-4 rounded-lg min-h-[120px]"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-jurnal" class="view-section hidden relative">
                <div id="jurnal-container"></div>
            </div>

            <div id="view-absensi" class="view-section hidden relative">
                <div id="absensi-container"></div>
            </div>

            <div id="view-kktp" class="view-section hidden relative">
                <div class="paper-preview portrait">
                    <h1 class="header-title text-center text-[14pt] font-bold mb-5 uppercase" contenteditable="true">KRITERIA KETERCAPAIAN TUJUAN PEMBELAJARAN (KKTP)</h1>
                    <table class="identity-table mb-4" contenteditable="true" style="font-weight: bold; font-size: 11pt; width: 100%;">
                        <tr><td width="150">Mata Pelajaran</td><td>: <span class="v-mapel"></span></td></tr>
                        <tr><td>Kelas/Semester</td><td>: <span class="v-kls"></span> / <span class="v-smt"></span></td></tr>
                    </table>
                    <table class="doc-table">
                        <thead>
                            <tr>
                                <th rowspan="2" width="5%">No</th><th rowspan="2" width="45%">Tujuan Pembelajaran</th>
                                <th colspan="3">Kriteria (Klik Angka Edit)</th><th rowspan="2" width="10%">Nilai KKTP</th>
                            </tr>
                            <tr><th class="text-[8pt]">Kompleksitas</th><th class="text-[8pt]">Daya Dukung</th><th class="text-[8pt]">Intaks Siswa</th></tr>
                        </thead>
                        <tbody id="out-kktp"></tbody>
                    </table>
                    <p class="text-xs italic text-slate-500 mt-2">*Nilai KKTP akhir otomatis menghitung rata-rata dari 3 kriteria.</p>
                    <div class="signature-area" contenteditable="true">
                        <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name v-kepsek"></div>NIP. <span class="v-nip-kepsek"></span></div>
                        <div class="signature-box"><span class="v-tempat-tgl"></span><br>Guru Mata Pelajaran<br><div class="signature-name v-guru"></div>NIP. <span class="v-nip-guru"></span></div>
                    </div>
                </div>
                
                <div class="paper-preview landscape mt-10">
                    <h1 class="header-title text-center text-[14pt] font-bold mb-5 uppercase" contenteditable="true">DAFTAR NILAI SUMATIF & FORMATIF</h1>
                    <table class="identity-table w-1/3 mb-4" contenteditable="true" style="font-weight: bold; font-size: 11pt;">
                        <tr><td width="150">Mata Pelajaran</td><td>: <span class="v-mapel"></span></td></tr>
                        <tr><td>Kelas/Semester</td><td>: <span class="v-kls"></span> / <span class="v-smt"></span></td></tr>
                    </table>
                    <table class="doc-table text-[9pt] text-center">
                        <thead>
                            <tr>
                                <th width="3%" rowspan="2">No</th><th width="20%" rowspan="2" class="text-left">Nama Siswa</th>
                                <th colspan="5">Nilai Sumatif Harian (Per TP/Bab)</th><th width="6%" rowspan="2">STS</th><th width="6%" rowspan="2">SAS</th><th width="6%" rowspan="2" class="bg-blue-100 text-blue-800">Nilai Rapor (NR)</th>
                            </tr>
                            <tr><th>S1</th><th>S2</th><th>S3</th><th>S4</th><th>Rata2</th></tr>
                        </thead>
                        <tbody id="out-nilai"></tbody>
                    </table>
                    <div class="signature-area" contenteditable="true">
                        <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name v-kepsek"></div>NIP. <span class="v-nip-kepsek"></span></div>
                        <div class="signature-box"><span class="v-tempat-tgl"></span><br>Guru Mata Pelajaran<br><div class="signature-name v-guru"></div>NIP. <span class="v-nip-guru"></span></div>
                    </div>
                </div>
            </div>

            <div id="view-kalender" class="view-section hidden relative">
                <div class="paper-preview portrait">
                    <h1 class="header-title text-center text-[14pt] font-bold mb-5 uppercase" contenteditable="true">KALENDER PENDIDIKAN & JADWAL PELAJARAN<br>TAHUN PELAJARAN <span class="v-thn"></span></h1>
                    
                    <table class="identity-table w-full mb-6" contenteditable="true" style="font-weight: bold; font-size: 11pt;">
                        <tr><td width="150">Nama Sekolah</td><td>: <span class="v-sekolah"></span></td></tr>
                        <tr><td>Kelas / Semester</td><td>: <span class="v-kls"></span> / <span class="v-smt"></span></td></tr>
                        <tr><td>Guru</td><td>: <span class="v-guru"></span></td></tr>
                    </table>

                    <div class="flex justify-between items-center bg-slate-100 p-2 border-l-4 border-emerald-600 mt-4 mb-2">
                        <div class="font-bold text-[11pt]">A. JADWAL MENGAJAR GURU</div>
                        <button onclick="Engine.tambahJadwal()" class="no-print bg-blue-600 text-white text-xs px-2 py-1 rounded hover:bg-blue-500">+ Tambah Baris</button>
                    </div>
                    <table class="doc-table text-center" contenteditable="true">
                        <thead>
                            <tr><th width="20%">Hari</th><th width="20%">Waktu / Jam Ke-</th><th width="30%">Mata Pelajaran</th><th width="15%">Kelas</th><th width="15%">JP</th></tr>
                        </thead>
                        <tbody id="out-jadwal-body">
                            <tr>
                                <td class="font-bold text-blue-700"><span id="out-jadwal-hari"></span></td>
                                <td>Menyesuaikan</td>
                                <td class="font-bold"><span class="v-mapel"></span></td>
                                <td><span class="v-kls"></span>-<span class="v-rombel"></span></td>
                                <td><span id="out-jadwal-jp"></span> JP</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="font-bold text-[11pt] bg-slate-100 p-2 border-l-4 border-emerald-600 mt-8 mb-2">B. RINCIAN AGENDA & HARI LIBUR <span class="uppercase text-blue-700 font-bold">(SEMESTER <span class="v-smt"></span>)</span></div>
                    <table class="doc-table text-sm">
                        <thead>
                            <tr><th width="25%">Tanggal</th><th width="75%" class="text-left">Keterangan / Agenda Libur</th></tr>
                        </thead>
                        <tbody id="out-kalender-rincian"></tbody>
                    </table>

                    <div class="signature-area mt-10" contenteditable="true">
                        <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name v-kepsek"></div>NIP. <span class="v-nip-kepsek"></span></div>
                        <div class="signature-box"><span class="v-tempat-tgl"></span><br>Guru Mata Pelajaran<br><div class="signature-name v-guru"></div>NIP. <span class="v-nip-guru"></span></div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        const CP_LINKS = {
            "SD": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1925091593&single=true&output=csv",
            "SMP": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1962203786&single=true&output=csv",
            "SMA": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=260922290&single=true&output=csv"
        };
        const BULAN_IND = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
        const HARI_IND = ["Minggu","Senin","Selasa","Rabu","Kamis","Jum'at","Sabtu"];

        // DEFAULT ESTIMASI LIBUR NASIONAL 2025 - 2028
        const DEFAULT_LIBUR_TEXT = `2025-08-17 = HUT Kemerdekaan RI
2025-09-05 = Maulid Nabi Muhammad SAW
2025-12-25 = Hari Raya Natal
2026-01-01 = Tahun Baru Masehi
2026-01-16 = Isra Mikraj Nabi Muhammad
2026-03-19 = Hari Raya Nyepi
2026-03-20 = Cuti Bersama Idul Fitri
2026-03-21 = Hari Raya Idul Fitri 1447 H
2026-04-03 = Wafat Isa Almasih
2026-05-01 = Hari Buruh Internasional
2026-05-14 = Kenaikan Yesus Kristus
2026-05-27 = Hari Raya Idul Adha 1447 H
2026-06-01 = Hari Lahir Pancasila
2026-06-16 = Tahun Baru Islam 1448 H
2027-02-08 = Isra Mikraj
2027-03-10 = Hari Raya Idul Fitri 1448 H
2028-01-28 = Idul Fitri 1449 H`;

        document.addEventListener("DOMContentLoaded", () => {
            let y = new Date().getFullYear();
            if(document.getElementById('in-masuk-ganjil')) {
                document.getElementById('in-masuk-ganjil').value = `${y}-07-15`;
                document.getElementById('in-rapor-ganjil').value = `${y}-12-20`;
                document.getElementById('in-masuk-genap').value = `${y+1}-01-05`;
                document.getElementById('in-rapor-genap').value = `${y+1}-06-20`;
                document.getElementById('in-libur').value = DEFAULT_LIBUR_TEXT;
            }

            if(document.getElementById('btn-login')) {
                document.getElementById('btn-login').addEventListener('click', () => {
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-wrapper').classList.remove('hidden');
                    document.getElementById('sidebar').classList.remove('hidden');
                    window.Engine.fetchGlobalCSV(); window.Engine.loadStudents();
                });
            }
        });

        const UI = {
            switchTab: function(tabId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.nav-tab').forEach(el => {
                    if(el.innerText.includes('Kalender')) el.className = "nav-tab px-4 py-2 text-sm font-medium text-emerald-600 border border-emerald-200 bg-emerald-50 rounded ml-2 hover:bg-emerald-100";
                    else el.className = "nav-tab px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700";
                });
                document.getElementById(`view-${tabId}`).classList.remove('hidden');
                
                let ct = event.currentTarget;
                if(!ct.innerText.includes('Kalender')) ct.className = "nav-tab px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600";
                else ct.className = "nav-tab px-4 py-2 text-sm font-medium text-white border border-emerald-600 bg-emerald-600 rounded ml-2 shadow";
            }
        };

        window.Engine = {
            data: {}, students: [], faseMap: {}, calEvents: {}, eventList: [], gridPromes: [],

            saveStudents: function() {
                let list = document.getElementById('in-data-siswa').value.split('\n').map(s => s.replace(/^[0-9]+[\.\)\-]\s*/, '').split(/[\t;]/)[0].trim()).filter(s => s.length > 0);
                if(list.length > 0) {
                    this.students = list; localStorage.setItem('sa_students', JSON.stringify(list));
                    alert("‚úÖ Berhasil menyimpan " + list.length + " data siswa!");
                    document.getElementById('modal-siswa').style.display = 'none'; this.syncAll();
                }
            },
            loadStudents: function() {
                let saved = localStorage.getItem('sa_students');
                if(saved) { this.students = JSON.parse(saved); document.getElementById('in-data-siswa').value = this.students.join('\n'); } 
                else { this.students = ["Ahmad Fulan", "Siti Fulanah"]; }
            },
            
            // FUNGSI ABSENSI INTERAKTIF DAN AKUMULASI
            toggleAbsen: function(el) {
                const s = {'H':{t:'S',c:'text-amber-500'},'S':{t:'I',c:'text-purple-500'},'I':{t:'A',c:'text-red-600'},'A':{t:'H',c:'text-blue-600'}};
                let curr = el.innerText.trim(); let n = s[curr] || s['A']; 
                el.innerText = n.t; el.className = `cursor-pointer text-center font-bold w-full h-full block absen-cell ${n.c}`;
                this.kalkulasiAbsen(el.closest('tr'));
            },
            kalkulasiAbsen: function(tr) {
                let cells = tr.querySelectorAll('.absen-cell');
                let hitung = {H:0, S:0, I:0, A:0};
                cells.forEach(c => { let val = c.innerText.trim(); if(hitung[val] !== undefined) hitung[val]++; });
                if(tr.querySelector('.tot-H')) tr.querySelector('.tot-H').innerText = hitung.H;
                if(tr.querySelector('.tot-S')) tr.querySelector('.tot-S').innerText = hitung.S;
                if(tr.querySelector('.tot-I')) tr.querySelector('.tot-I').innerText = hitung.I;
                if(tr.querySelector('.tot-A')) tr.querySelector('.tot-A').innerText = hitung.A;
            },

            tambahJadwal: function() {
                let tbody = document.getElementById('out-jadwal-body');
                let tr = document.createElement('tr');
                tr.innerHTML = `<td contenteditable="true" class="font-bold text-blue-700">Hari...</td>
                                <td contenteditable="true">Waktu...</td>
                                <td contenteditable="true" class="font-bold">Mata Pelajaran...</td>
                                <td contenteditable="true">Kelas...</td>
                                <td contenteditable="true">.. JP</td>`;
                tbody.appendChild(tr);
            },

            uploadCSV: function(inputElement) {
                let file = inputElement.files[0]; if (!file) return;
                let r = new FileReader(); r.onload = e => { window.Engine.parseCSV(e.target.result); inputElement.value=''; }; r.readAsText(file);
            },
            fetchGlobalCSV: async function() {
                let jenjang = document.getElementById('in-jenjang')?.value || "SD";
                let url = CP_LINKS[jenjang]; 
                let statusEl = document.getElementById('csvStatus');
                if(statusEl) { statusEl.style.display = 'block'; statusEl.className = 'csv-info'; statusEl.innerHTML = `‚è≥ Mengunduh Kurikulum...`; }
                try {
                    let res = await fetch(url); if(!res.ok) throw new Error("");
                    this.parseCSV(await res.text());
                } catch(e) {
                    try { let r = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(url)); this.parseCSV(await r.text()); } 
                    catch(err) { if(statusEl) { statusEl.className='csv-info error'; statusEl.innerHTML="‚ùå Gagal mengunduh. Gunakan Upload Manual."; } }
                }
            },
            parseCSV: function(csvText) {
                const lines = csvText.split('\n'); this.data = {}; this.faseMap = {}; let count = 0;
                for(let i=1; i<lines.length; i++) { 
                    let row = lines[i].trim(); if(!row) continue;
                    let cols = []; let match; const regex = new RegExp(`(\"([^\"]*)\"|[^\"\,]+)(?=\,|$)`, 'g');
                    while(match = regex.exec(row)) cols.push(match[2] ? match[2] : match[1]);
                    if(cols.length < 5) continue;
                    let m=cols[0]?.trim()||"", f=cols[1]?.trim()||"", k=cols[2]?.trim()||"", s=cols[3]?.trim()||"", el=cols[4]?.trim()||"", cp=cols[5]?.trim()||"", tp=cols[6]?.trim()||cols[5]?.trim()||"";
                    if(f && k) this.faseMap[k] = f; 
                    if(!this.data[m]) this.data[m] = {}; if(!this.data[m][k]) this.data[m][k] = {}; if(!this.data[m][k][s]) this.data[m][k][s] = {};
                    if(!this.data[m][k][s][el]) this.data[m][k][s][el] = { cp: cp, tps: [] };
                    this.data[m][k][s][el].tps.push({ tp: tp, p3: "" }); count++;
                }
                let statusEl = document.getElementById('csvStatus');
                if(statusEl) { statusEl.className='csv-info'; statusEl.innerHTML=`‚úÖ Sukses memuat <b>${count}</b> TP.`; }
                this.initDropdowns();
            },
            initDropdowns: function() {
                let mSel = document.getElementById('in-mapel'); mSel.innerHTML = "";
                Object.keys(this.data).forEach(m => mSel.appendChild(new Option(m, m)));
                this.updateKelasList();
            },
            updateKelasList: function() {
                let m = document.getElementById('in-mapel')?.value; let kSel = document.getElementById('in-kelas'); kSel.innerHTML = "";
                if(m && this.data[m]) {
                    Object.keys(this.data[m]).sort((a,b)=> {
                        let nA = parseInt(a.replace(/[^0-9]/g, '')); let nB = parseInt(b.replace(/[^0-9]/g, ''));
                        return (!isNaN(nA) && !isNaN(nB)) ? nA - nB : a.localeCompare(b);
                    }).forEach(k => {
                        let lb = this.faseMap[k] || "-";
                        lb = lb.toLowerCase().includes("fase") ? lb : `Fase ${lb}`;
                        kSel.appendChild(new Option(`Kelas ${k} (${lb})`, k));
                    });
                }
                this.updateSemesterList();
            },
            updateSemesterList: function() {
                let m = document.getElementById('in-mapel')?.value; let k = document.getElementById('in-kelas')?.value;
                let sSel = document.getElementById('in-semester'); sSel.innerHTML = "";
                if(m && k && this.data[m][k]) Object.keys(this.data[m][k]).forEach(s => sSel.appendChild(new Option(s, s)));
                this.updateBabList();
            },
            updateBabList: function() {
                let m=document.getElementById('in-mapel')?.value, k=document.getElementById('in-kelas')?.value, s=document.getElementById('in-semester')?.value;
                let eSel = document.getElementById('in-elemen'); eSel.innerHTML = "";
                if(m && k && s && this.data[m][k][s]) Object.keys(this.data[m][k][s]).forEach(b => eSel.appendChild(new Option(b, b)));
                this.syncAll();
            },
            
            calcKktp: function(el) {
                let r = el.closest('tr'); let v = r.querySelectorAll('.kktp-val'); let res = r.querySelector('.kktp-hasil');
                if(v.length === 3 && res) res.innerText = Math.round(((parseFloat(v[0].innerText)||0) + (parseFloat(v[1].innerText)||0) + (parseFloat(v[2].innerText)||0)) / 3);
            },
            
            getLastWorkingDay: function(year, month) {
                let d = new Date(year, month + 1, 0); 
                let dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                while (d.getDay() === 0 || this.calEvents[dateStr]) {
                    d.setDate(d.getDate() - 1);
                    dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                }
                return `${String(d.getDate()).padStart(2,'0')} ${BULAN_IND[d.getMonth()]} ${d.getFullYear()}`;
            },

            generateAutoCalendar: function() {
                this.calEvents = {}; this.eventList = [];
                const addEv = (dt, nm) => { this.calEvents[dt] = nm; this.eventList.push({dt: dt, nm: nm}); };

                let tg = [
                    { id: 'in-masuk-ganjil', nm: "Awal Masuk Tahun Ajaran", pre: "Libur Awal Tahun Ajaran", m: 6, before: true },
                    { id: 'in-rapor-ganjil', nm: "Pembagian Rapor Ganjil", pre: "Libur Akhir Semester Ganjil", m: 11, before: false },
                    { id: 'in-masuk-genap', nm: "Awal Masuk Genap", pre: "Libur Awal Semester Genap", m: 0, before: true },
                    { id: 'in-rapor-genap', nm: "Pembagian Rapor (Kenaikan)", pre: "Libur Akhir Tahun Ajaran", m: 5, before: false }
                ];

                tg.forEach(item => {
                    let val = document.getElementById(item.id)?.value;
                    if(val) {
                        let [y,mo,d] = val.split('-'); let yInt = parseInt(y); let dInt = parseInt(d);
                        if(parseInt(mo)-1 === item.m) {
                            addEv(val, item.nm);
                            if(item.before) {
                                for(let i=1; i<dInt; i++) addEv(`${y}-${mo}-${String(i).padStart(2,'0')}`, item.pre);
                            } else {
                                let lastDay = new Date(yInt, item.m + 1, 0).getDate();
                                for(let i=dInt+1; i<=lastDay; i++) addEv(`${y}-${mo}-${String(i).padStart(2,'0')}`, item.pre);
                            }
                        }
                    }
                });

                let rawLibur = (document.getElementById("in-libur")?.value || "").split('\n');
                rawLibur.forEach(line => {
                    let parts = line.split('=');
                    if(parts.length >= 2) { addEv(parts[0].trim(), parts[1].trim()); }
                });

                this.eventList.sort((a,b) => new Date(a.dt) - new Date(b.dt));
            },

            formatTglIndo: function(tglStr) {
                if(!tglStr) return ""; let [y,m,d] = tglStr.split('-'); return `${parseInt(d)} ${BULAN_IND[parseInt(m)-1]} ${y}`;
            },

            syncAll: function() {
                let m=document.getElementById('in-mapel')?.value||"", k=document.getElementById('in-kelas')?.value||"", s=document.getElementById('in-semester')?.value||"", bAktif=document.getElementById('in-elemen')?.value||"";
                if(!m || !k || !s) return;

                let tAwal = parseInt(document.getElementById('in-tahun')?.value) || new Date().getFullYear();
                let jp = parseInt(document.getElementById('in-jp')?.value) || 4;
                let hTarget = parseInt(document.getElementById('in-hari')?.value) || 1;
                let tAjar = `${tAwal} / ${tAwal + 1}`;
                
                document.getElementById('out-jadwal-hari').innerText = HARI_IND[hTarget];
                document.getElementById('out-jadwal-jp').innerText = jp;

                let lb = this.faseMap[k] || "-";
                document.querySelectorAll('.v-fase').forEach(e=>e.innerText = lb.toLowerCase().includes("fase") ? lb : `Fase ${lb}`);
                document.querySelectorAll('.v-mapel').forEach(e=>e.innerText=m); document.querySelectorAll('.v-kls').forEach(e=>e.innerText=k);
                document.querySelectorAll('.v-smt').forEach(e=>e.innerText=s); document.querySelectorAll('.v-thn').forEach(e=>e.innerText=tAjar);
                document.querySelectorAll('.v-bab-aktif').forEach(e=>e.innerText=bAktif);
                
                document.querySelectorAll('.v-sekolah').forEach(e=>e.innerText=document.getElementById('in-sekolah')?.value||"");
                document.querySelectorAll('.v-kepsek').forEach(e=>e.innerText=document.getElementById('in-kepsek')?.value||"");
                document.querySelectorAll('.v-nip-kepsek').forEach(e=>e.innerText=document.getElementById('in-nip-kepsek')?.value||"");
                document.querySelectorAll('.v-guru').forEach(e=>e.innerText=document.getElementById('in-guru')?.value||"");
                document.querySelectorAll('.v-nip-guru').forEach(e=>e.innerText=document.getElementById('in-nip-guru')?.value||"");
                document.querySelectorAll('.v-rombel').forEach(e=>e.innerText=document.getElementById('in-rombel')?.value||"A");
                let tmpt = document.getElementById('in-tempat-tgl')?.value||"";
                document.querySelectorAll('.v-tempat-tgl').forEach(e=>e.innerText=tmpt + ", ......................");

                let spData = this.data[m]?.[k]?.[s]?.[bAktif];
                document.querySelectorAll('.v-jp-bab').forEach(e=>e.innerText = spData ? spData.tps.length * jp : 0);

                this.generateAutoCalendar();

                // GRID PROMES LOGIC (Presisi Tanggal vs Kolom)
                let bAwal = s === "Ganjil" ? 6 : 0; 
                this.gridPromes = new Array(30).fill(null);
                let activeDates = [];

                for (let i = 0; i < 6; i++) {
                    let curBln = bAwal + i; let cYr = tAwal;
                    if(s === "Ganjil" && curBln > 11) { cYr++; curBln -= 12; }
                    if(s === "Genap" && curBln > 11) { cYr++; curBln -= 12; } 
                    
                    let jHari = new Date(cYr, curBln + 1, 0).getDate();
                    for (let tgl = 1; tgl <= jHari; tgl++) {
                        let dt = new Date(cYr, curBln, tgl);
                        if (dt.getDay() === hTarget) {
                            let wIdx = Math.min(Math.ceil(tgl / 7) - 1, 4);
                            let cIdx = i * 5 + wIdx;
                            let dStr = `${cYr}-${String(curBln+1).padStart(2,'0')}-${String(tgl).padStart(2,'0')}`;
                            
                            if (this.calEvents[dStr]) {
                                // Hari tersebut Libur!
                                let shortTxt = this.calEvents[dStr];
                                if(shortTxt.includes("Libur Akhir Tahun")) shortTxt = "LIBUR SMT 2";
                                else if(shortTxt.includes("Libur Akhir Semester Ganjil")) shortTxt = "LIBUR SMT 1";
                                else if(shortTxt.includes("Libur Awal")) shortTxt = "LIBUR AWAL";
                                this.gridPromes[cIdx] = { isHol: true, text: shortTxt };
                            } else {
                                // Hari KBM Aktif
                                activeDates.push(dt);
                                this.gridPromes[cIdx] = { isHol: false, text: dt.getDate() };
                            }
                        }
                    }
                }

                this.renderATPProta(m, k, s, jp, activeDates);
                this.renderPromes();
                this.renderJurnalAbsensiBulan(m, k, s);
                this.renderDaftarNilai();
                this.renderKalenderList(s, bAwal);
                if(bAktif) this.renderModul(m, k, s, bAktif, jp);
            },

            renderKalenderList: function(smt, bAwal) {
                let html = ""; let smtMonths = [];
                for(let i=0; i<6; i++) { let m = bAwal + i; if(m > 11) m -= 12; smtMonths.push(m); }

                let filtered = this.eventList.filter(ev => {
                    let m = parseInt(ev.dt.split('-')[1]) - 1;
                    return smtMonths.includes(m);
                });

                if(filtered.length === 0) {
                    html = `<tr><td colspan="2" class="text-center italic text-slate-500">Belum ada data kegiatan di semester ini.</td></tr>`;
                } else {
                    let grouped = []; let currEv = null;
                    for(let i=0; i<filtered.length; i++) {
                        let ev = filtered[i];
                        if(!currEv) { currEv = { start: ev.dt, end: ev.dt, nm: ev.nm }; }
                        else if(currEv.nm === ev.nm) { currEv.end = ev.dt; } 
                        else { grouped.push(currEv); currEv = { start: ev.dt, end: ev.dt, nm: ev.nm }; }
                    }
                    if(currEv) grouped.push(currEv);

                    grouped.forEach(g => {
                        let dtTxt = (g.start === g.end) ? this.formatTglIndo(g.start) : `${this.formatTglIndo(g.start)} s.d ${this.formatTglIndo(g.end)}`;
                        let bgClass = g.nm.toLowerCase().includes("libur") ? "bg-red-50 text-red-700" : "bg-white text-slate-800";
                        html += `<tr class="${bgClass}"><td class="font-bold whitespace-nowrap align-middle border-b border-slate-300">${dtTxt}</td><td contenteditable="true" class="border-b border-slate-300">${g.nm}</td></tr>`;
                    });
                }
                document.getElementById('out-kalender-rincian').innerHTML = html;
            },

            renderATPProta: function(m, k, s, jp, aDates) {
                let md = document.getElementById('in-atp-mode')?.value; let dRender = [];
                if(md === "tahun" && this.data[m]?.[k]) {
                    if(this.data[m][k]["Ganjil"]) Object.keys(this.data[m][k]["Ganjil"]).forEach(b => dRender.push({s:"Ganjil", b:b, d:this.data[m][k]["Ganjil"][b]}));
                    if(this.data[m][k]["Genap"]) Object.keys(this.data[m][k]["Genap"]).forEach(b => dRender.push({s:"Genap", b:b, d:this.data[m][k]["Genap"][b]}));
                } else if(this.data[m]?.[k]?.[s]) {
                    Object.keys(this.data[m][k][s]).forEach(b => dRender.push({s:s, b:b, d:this.data[m][k][s][b]}));
                }

                let aHtml="", pHtml=""; let dIdx=0; window.promesRows=[];
                if(dRender.length===0) { aHtml=`<tr><td colspan="6" class="text-center">Kosong</td></tr>`; pHtml=aHtml; }
                
                dRender.forEach((it, i) => {
                    if(!it.d || !it.d.tps) return;
                    let tJp = it.d.tps.length * jp;
                    it.d.tps.forEach((tpO, tI) => {
                        let kompetensi = (tpO.tp.match(/mampu\s+([a-zA-Z\-]+)/i)) ? tpO.tp.match(/mampu\s+([a-zA-Z\-]+)/i)[1] : "Memahami";

                        aHtml += `<tr>`;
                        if(tI===0) aHtml += `<td rowspan="${it.d.tps.length}" class="text-center align-middle">${i+1}</td><td rowspan="${it.d.tps.length}" class="bg-slate-50 align-middle p-2" contenteditable="true"><b class="text-blue-900">${it.b}</b><hr class="my-1 border-slate-300"><span class="text-[8pt] text-slate-600 font-normal text-justify block leading-tight">${it.d.cp}</span></td>`;
                        aHtml += `<td contenteditable="true">${tpO.tp}</td><td class="text-xs text-blue-700">Beriman, Bernalar Kritis</td><td class="font-bold text-amber-600 capitalize">${kompetensi}</td>`;
                        if(tI===0) aHtml += `<td rowspan="${it.d.tps.length}" class="text-center align-middle">${Math.ceil(tJp/jp)} Minggu<br>${tJp} JP</td>`;
                        aHtml += `</tr>`;

                        pHtml += `<tr>`;
                        if(tI===0) pHtml += `<td rowspan="${it.d.tps.length}" class="font-bold text-center align-middle">${it.s}</td><td rowspan="${it.d.tps.length}" class="bg-slate-50 align-middle p-2" contenteditable="true"><b class="block text-center text-blue-900">${it.b}</b><hr class="my-1 border-slate-300"><span class="text-[8pt] text-slate-600 font-normal text-justify block leading-tight">${it.d.cp}</span></td>`;
                        pHtml += `<td contenteditable="true">${tpO.tp}</td>`;
                        if(tI===0) pHtml += `<td rowspan="${it.d.tps.length}" class="font-bold text-center align-middle">${tJp} JP</td>`;
                        pHtml += `</tr>`;

                        if(md === "semester" || it.s === s) {
                            let dt = null; if(aDates && dIdx < aDates.length) { dt=aDates[dIdx]; dIdx++; }
                            window.promesRows.push({ bab: tI===0?it.b:"", tp: tpO.tp, jp: jp, dt: dt, rs: tI===0?it.d.tps.length:0 });
                        }
                    });
                });
                
                document.getElementById('out-atp').innerHTML = aHtml;
                document.getElementById('out-prota').innerHTML = pHtml;
            },

            renderPromes: function() {
                let s = document.getElementById('in-semester')?.value||"";
                let nb = s==="Ganjil" ? ["Jul","Ags","Sep","Okt","Nov","Des"] : ["Jan","Feb","Mar","Apr","Mei","Jun"];
                let th = `<tr><th rowspan="2" width="10%">Bab / Elemen</th><th rowspan="2" width="22%">Tujuan Pembelajaran (TP)</th><th rowspan="2" width="3%">JP</th>`;
                nb.forEach(b=> th+=`<th colspan="5">${b}</th>`); th+=`</tr><tr>`; for(let i=0;i<6;i++) th+=`<th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>`; th+=`</tr>`;
                document.getElementById('out-promes-head').innerHTML = th;

                let tb = ""; let r = window.promesRows || [];
                if(r.length>0) {
                    r.forEach((ro, idx) => {
                        tb+=`<tr>`;
                        if(ro.rs>0) tb+=`<td rowspan="${ro.rs}" class="bg-slate-50 font-bold text-center align-middle" contenteditable="true">${ro.bab}</td>`;
                        tb+=`<td contenteditable="true">${ro.tp}</td><td class="text-center font-bold align-middle">${ro.jp}</td>`;
                        
                        for(let c=0; c<30; c++) {
                            let cellInfo = this.gridPromes[c];
                            if(cellInfo === null) {
                                tb+=`<td></td>`; // Tidak ada hari mengajar di minggu ini
                            } else if (cellInfo.isHol) {
                                if(idx===0) tb+=`<td rowspan="${r.length}" class="event-cell border border-slate-400 align-middle"><div class="vertical-event">${cellInfo.text.toUpperCase()}</div></td>`;
                            } else {
                                // Hari Mengajar, cek apakah TP ini dijadwalkan di tanggal ini
                                if(ro.dt && ro.dt.getDate() === cellInfo.text) {
                                    tb+=`<td class="bg-blue-100 text-center font-bold text-blue-800 align-middle text-xs">${cellInfo.text}</td>`;
                                } else {
                                    tb+=`<td></td>`;
                                }
                            }
                        }
                        tb+=`</tr>`;
                    });
                } else tb = `<tr><td colspan="33" class="text-center">Kosong</td></tr>`;
                document.getElementById('out-promes-body').innerHTML = tb;
            },

            renderJurnalAbsensiBulan: function(m, k, s) {
                let tGuru = document.getElementById('in-tipe-guru').value;
                let cHead = tGuru === 'mapel' ? "Kelas/Rombel" : "Mata Pelajaran";
                let cVal = tGuru === 'mapel' ? k + "/" + (document.getElementById('in-rombel')?.value||"A") : m;
                let tmpt = document.getElementById('in-tempat-tgl')?.value||"";
                
                let dataJurnalPerBulan = {}; 
                (window.promesRows || []).forEach(r => {
                    if(r.dt) {
                        let y = r.dt.getFullYear(); let mo = r.dt.getMonth(); let key = `${mo}-${y}`;
                        if(!dataJurnalPerBulan[key]) dataJurnalPerBulan[key] = [];
                        dataJurnalPerBulan[key].push(r);
                    }
                });

                let jHtml="", aHtml="";
                Object.keys(dataJurnalPerBulan).forEach((key, bIdx) => {
                    let [moStr, yStr] = key.split('-'); let mo = parseInt(moStr); let yr = parseInt(yStr);
                    let tglTtd = this.getLastWorkingDay(yr, mo);
                    let items = dataJurnalPerBulan[key];
                    let currentBab = "";

                    // JURNAL
                    jHtml += `<div class="paper-preview landscape mt-5">
                        <h1 class="header-title text-center text-[14pt] font-bold mb-5 uppercase">JURNAL PELAKSANAAN PEMBELAJARAN<br>BULAN ${BULAN_IND[mo].toUpperCase()} ${yr}</h1>
                        <table class="doc-table text-sm">
                            <thead><tr><th width="8%">Tgl</th><th width="12%">${cHead}</th><th width="15%">Bab/Materi</th><th width="40%">Tujuan Pembelajaran</th><th width="10%">Kehadiran</th><th width="15%">Ket</th></tr></thead>
                            <tbody>`;
                    items.forEach((it, i) => {
                        if(it.bab) currentBab = it.bab;
                        let dStr = `${String(it.dt.getDate()).padStart(2,'0')}/${String(mo+1).padStart(2,'0')}/${yr}`;
                        jHtml += `<tr><td class="text-center font-bold">${dStr}</td><td contenteditable="true" class="text-center">${cVal}</td><td contenteditable="true">${currentBab}</td><td contenteditable="true">${it.tp}</td><td contenteditable="true" class="text-center font-bold text-blue-700 id-hadir-${bIdx}-${i}">Hadir Semua</td><td contenteditable="true">Berjalan Lancar</td></tr>`;
                    });
                    jHtml += `</tbody></table>
                        <div class="signature-area" contenteditable="true">
                            <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name">${document.getElementById('in-kepsek')?.value||""}</div>NIP. ${document.getElementById('in-nip-kepsek')?.value||""}</div>
                            <div class="signature-box">${tmpt}, ${tglTtd}<br>Guru Mata Pelajaran<br><div class="signature-name">${document.getElementById('in-guru')?.value||""}</div>NIP. ${document.getElementById('in-nip-guru')?.value||""}</div>
                        </div></div>`;

                    // ABSENSI DENGAN AKUMULASI
                    let absTglHead = ""; let absCols = items.length;
                    items.forEach((it) => absTglHead += `<th>${it.dt.getDate()}</th>`);
                    
                    aHtml += `<div class="paper-preview portrait mt-5">
                        <h1 class="header-title text-center text-[14pt] font-bold mb-5 uppercase">PRESENSI SISWA - BULAN ${BULAN_IND[mo].toUpperCase()} ${yr}</h1>
                        <table class="doc-table text-[9pt] text-center">
                            <thead>
                                <tr><th rowspan="2" width="3%">No</th><th rowspan="2" width="25%" class="text-left">Nama Siswa</th><th colspan="${absCols}">Tanggal Pertemuan</th><th colspan="4" class="bg-blue-100">Akumulasi</th></tr>
                                <tr>${absTglHead}<th class="bg-blue-50">H</th><th class="bg-blue-50">S</th><th class="bg-blue-50">I</th><th class="bg-blue-50">A</th></tr>
                            </thead><tbody>`;
                    
                    let sList = this.students && this.students.length > 0 ? this.students : ["Siswa 1"];
                    sList.forEach((sn, i) => {
                        aHtml += `<tr><td>${i+1}</td><td class="text-left">${sn}</td>`;
                        for(let c=0; c<absCols; c++) {
                            aHtml += `<td><div onclick="Engine.toggleAbsen(this)" class="cursor-pointer font-bold text-blue-600 block w-full absen-cell">H</div></td>`;
                        }
                        aHtml += `<td class="font-bold tot-H bg-slate-50">${absCols}</td><td class="font-bold tot-S bg-slate-50">0</td><td class="font-bold tot-I bg-slate-50">0</td><td class="font-bold tot-A bg-slate-50">0</td></tr>`;
                    });
                    
                    aHtml += `</tbody></table>
                        <div class="signature-area" contenteditable="true">
                            <div class="signature-box">Mengetahui,<br>Kepala Sekolah<div class="signature-name">${document.getElementById('in-kepsek')?.value||""}</div>NIP. ${document.getElementById('in-nip-kepsek')?.value||""}</div>
                            <div class="signature-box">${tmpt}, ${tglTtd}<br>Guru Mata Pelajaran<br><div class="signature-name">${document.getElementById('in-guru')?.value||""}</div>NIP. ${document.getElementById('in-nip-guru')?.value||""}</div>
                        </div></div>`;
                });

                document.getElementById('jurnal-container').innerHTML = jHtml || `<div class="paper-preview text-center italic text-slate-400">Data jurnal tidak ditemukan. Pastikan setting kalender benar.</div>`;
                document.getElementById('absensi-container').innerHTML = aHtml || `<div class="paper-preview text-center italic text-slate-400">Data absensi tidak ditemukan.</div>`;
            },

            renderDaftarNilai: function() {
                let h=""; let sl = this.students && this.students.length > 0 ? this.students : ["Siswa 1"];
                sl.forEach((n, i) => {
                    h += `<tr><td>${i+1}</td><td class="text-left" contenteditable="true">${n}</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td class="bg-slate-50 font-bold" contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td class="font-bold bg-blue-50 text-blue-800" contenteditable="true"></td></tr>`;
                });
                document.getElementById('out-nilai').innerHTML = h;
            },

            renderModul: function(m, k, s, bAktif, jp) {
                let d = this.data[m]?.[k]?.[s]?.[bAktif]; if(!d) return;
                let cpEl = document.getElementById('out-modul-cp'); if(cpEl) cpEl.innerText = d.cp;
                let mt="", st="", kt="";
                d.tps.forEach((t, i) => {
                    mt += `<li><strong>Pertemuan ${i+1}:</strong> ${t.tp}</li>`;
                    st += `<div class="mb-4 bg-slate-50 p-4 rounded border border-slate-300">
                        <div class="font-bold border-b-2 border-slate-300 pb-2 mb-3 text-blue-800 text-lg">Pertemuan ${i+1} (${jp} JP)</div>
                        <div class="mb-3"><span class="font-bold text-slate-700 underline">A. Pendahuluan (15 Menit)</span><ul class="list-decimal pl-6 mt-1 text-justify"><li>Guru mengucapkan salam, mengajak berdoa, dan mengecek kehadiran.</li><li>Guru memberikan apersepsi yang mengaitkan pengalaman dengan topik <b>${bAktif}</b>.</li></ul></div>
                        <div class="mb-3"><span class="font-bold text-slate-700 underline">B. Kegiatan Inti (60 Menit)</span><ul class="list-decimal pl-6 mt-1 text-justify"><li><b>Orientasi:</b> Siswa mengamati penjelasan guru.</li><li><b>Diskusi:</b> Siswa mengerjakan LKPD berkelompok.</li><li><b>Presentasi:</b> Perwakilan kelompok mempresentasikan hasil.</li></ul></div>
                        <div><span class="font-bold text-slate-700 underline">C. Penutup (15 Menit)</span><ul class="list-decimal pl-6 mt-1 text-justify"><li>Siswa & guru menyimpulkan materi, diakhiri doa.</li></ul></div>
                    </div>`;
                    kt += `<tr>`; if(i===0) kt+=`<td rowspan="${d.tps.length}" class="text-center align-middle">${i+1}</td>`;
                    kt += `<td contenteditable="true">${t.tp}</td><td class="kktp-val" contenteditable="true" oninput="Engine.calcKktp(this)">75</td><td class="kktp-val" contenteditable="true" oninput="Engine.calcKktp(this)">75</td><td class="kktp-val" contenteditable="true" oninput="Engine.calcKktp(this)">75</td><td class="kktp-hasil">75</td></tr>`;
                });
                
                let tpEl = document.getElementById('out-modul-tp'); if(tpEl) tpEl.innerHTML = `<ul>${mt}</ul>`;
                let lkpdTpEl = document.getElementById('out-lkpd-tp'); if(lkpdTpEl) lkpdTpEl.innerHTML = `<ul>${mt}</ul>`;
                let langkahEl = document.getElementById('out-modul-langkah'); if(langkahEl) langkahEl.innerHTML = st;
                let kktpEl = document.getElementById('out-kktp'); if(kktpEl) kktpEl.innerHTML = kt;
            }
        };
    </script>
</body>
</html>