<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGSA - Dashboard</title>
    
    <!-- Tailwind CSS CDN (untuk development, gunakan CLI untuk production) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        
        /* RTL Support */
        .rtl { direction: rtl; text-align: right; }
        
        /* Sidebar transition */
        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* Page transitions */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Print styles */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600">Memuat aplikasi...</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app" class="hidden">
        
        <!-- Mobile Sidebar Overlay -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>
        
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed top-0 left-0 z-40 w-64 h-screen bg-white border-r border-gray-200 sidebar-transition transform -translate-x-full lg:translate-x-0">
            <div class="h-full flex flex-col">
                <!-- Logo -->
                <div class="flex items-center justify-between px-4 py-4 border-b">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-600 to-purple-600 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                        </div>
                        <span class="text-xl font-bold text-gray-800">AGSA</span>
                    </div>
                    <button class="lg:hidden text-gray-500 hover:text-gray-700" id="closeSidebarBtn">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Navigation -->
                <nav class="flex-1 overflow-y-auto custom-scrollbar px-3 py-4">
                    <!-- Dashboard -->
                    <a href="#dashboard" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 mb-1" data-page="dashboard">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        <span>Dashboard</span>
                    </a>
                    
                    <!-- Setup Section -->
                    <div class="mt-4 mb-2 px-4">
                        <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Setup Data</p>
                    </div>
                    
                    <a href="#profil" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 mb-1" data-page="profil">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span>Profil Guru & Sekolah</span>
                    </a>
                    
                    <a href="#kalender" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 mb-1" data-page="kalender">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span>Kalender Pendidikan</span>
                    </a>
                    
                    <a href="#jadwal" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 mb-1" data-page="jadwal">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Jadwal Pelajaran</span>
                    </a>
                    
                    <a href="#siswa" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 mb-1" data-page="siswa">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <span>Data Siswa</span>
                    </a>
                    
                    <a href="#mapel" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 mb-1" data-page="mapel">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                        <span>Mata Pelajaran & CP</span>
                    </a>
                    
                    <!-- Dokumen Section -->
                    <div class="mt-6 mb-2 px-4">
                        <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Dokumen</p>
                    </div>
                    
                    <a href="#atp" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 mb-1" data-page="atp">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>ATP</span>
                        <span class="ml-auto text-xs bg-green-100 text-green-600 px-2 py-0.5 rounded-full">Free</span>
                    </a>
                    
                    <a href="#prota" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 mb-1" data-page="prota">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>Prota</span>
                        <span class="ml-auto text-xs bg-green-100 text-green-600 px-2 py-0.5 rounded-full">Free</span>
                    </a>
                    
                    <a href="#promes" class="nav-link premium-feature flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 mb-1" data-page="promes">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                        </svg>
                        <span>Promes</span>
                        <span class="ml-auto text-xs bg-purple-100 text-purple-600 px-2 py-0.5 rounded-full">Pro</span>
                    </a>
                    
                    <a href="#modul-ajar" class="nav-link premium-feature flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 mb-1" data-page="modul-ajar">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                        <span>Modul Ajar</span>
                        <span class="ml-auto text-xs bg-purple-100 text-purple-600 px-2 py-0.5 rounded-full">Pro</span>
                    </a>
                    
                    <a href="#jurnal" class="nav-link premium-feature flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 mb-1" data-page="jurnal">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        <span>Jurnal</span>
                        <span class="ml-auto text-xs bg-purple-100 text-purple-600 px-2 py-0.5 rounded-full">Pro</span>
                    </a>
                    
                    <a href="#kktp" class="nav-link premium-feature flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 mb-1" data-page="kktp">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>KKTP</span>
                        <span class="ml-auto text-xs bg-purple-100 text-purple-600 px-2 py-0.5 rounded-full">Pro</span>
                    </a>
                    
                    <a href="#nilai" class="nav-link premium-feature flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 mb-1" data-page="nilai">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span>Daftar Nilai</span>
                        <span class="ml-auto text-xs bg-purple-100 text-purple-600 px-2 py-0.5 rounded-full">Pro</span>
                    </a>
                    
                    <!-- Tools Section -->
                    <div class="mt-6 mb-2 px-4">
                        <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Tools</p>
                    </div>
                    
                    <a href="#ai-assistant" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 mb-1" data-page="ai-assistant">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        <span>AI Assistant</span>
                    </a>
                    
                    <!-- Admin Section (Super Admin Only) -->
                    <div id="adminMenu" class="hidden">
                        <div class="mt-6 mb-2 px-4">
                            <p class="text-xs font-semibold text-red-400 uppercase tracking-wider">Admin</p>
                        </div>
                        
                        <a href="#super-admin" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 mb-1" data-page="super-admin">
                            <svg class="w-5 h-5 mr-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <span>Super Admin</span>
                        </a>
                    </div>
                </nav>
                
                <!-- User Profile -->
                <div class="border-t p-4">
                    <div class="flex items-center space-x-3">
                        <img id="userPhoto" src="" alt="User" class="w-10 h-10 rounded-full bg-gray-200">
                        <div class="flex-1 min-w-0">
                            <p id="userName" class="text-sm font-medium text-gray-900 truncate"></p>
                            <p id="userPlan" class="text-xs text-gray-500"></p>
                        </div>
                        <button id="logoutBtn" class="text-gray-400 hover:text-red-500 transition-colors" title="Logout">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <div class="lg:ml-64 min-h-screen">
            <!-- Top Navbar -->
            <header class="bg-white border-b border-gray-200 px-4 py-4 sticky top-0 z-30">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <button id="menuToggleBtn" class="lg:hidden text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                        <h1 id="pageTitle" class="text-xl font-semibold text-gray-800">Dashboard</h1>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <!-- Tahun Ajar Display -->
                        <div id="tahunAjarDisplay" class="hidden md:flex items-center space-x-2 bg-blue-50 px-3 py-1.5 rounded-lg">
                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span id="tahunAjarText" class="text-sm font-medium text-blue-600"></span>
                        </div>
                        
                        <!-- Upgrade Button -->
                        <button id="upgradeBtn" class="hidden bg-gradient-to-r from-purple-600 to-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:shadow-lg transition-all">
                            ‚≠ê Upgrade
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- Page Content Container -->
            <main id="pageContent" class="p-4 md:p-6">
                <!-- Dynamic content will be loaded here -->
            </main>
        </div>
    </div>

    <!-- Modal Container -->
    <div id="modalContainer" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50" id="modalOverlay"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div id="modalContent" class="bg-white rounded-2xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-auto">
                <!-- Modal content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2">
        <!-- Toasts will be added here -->
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // ============================================
        // GLOBAL CONFIGURATION
        // ============================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyDpiK4F4ilnDDNEwO0djGY-ClwgwBl1eFk",
            authDomain: "asap-1d653.firebaseapp.com",
  	    projectId: "asap-1d653",
  	    storageBucket: "asap-1d653.firebasestorage.app",
  	    messagingSenderId: "143263188364",
  	    appId: "1:143263188364:web:47b4c003972b3503e882a9",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Super Admin Email
        const SUPER_ADMIN_EMAIL = 'afifaro@gmail.com';

        // CSV Links for CP Database
        const CSV_LINKS = {
            SD: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1925091593&single=true&output=csv',
            SMP: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=1962203786&single=true&output=csv',
            SMA: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=260922290&single=true&output=csv',
            SMK: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQMR0Vbb2xSEbDOQ708qzRPyGG9I0Vp7RijYHp0NTpjUL7w08EMrVwYy9euEyvyq1Y_XaJBcB668dVi/pub?gid=260922290&single=true&output=csv'
        };

        // ============================================
        // GLOBAL STATE
        // ============================================
        
        window.AGSA = {
            user: null,
            userData: null,
            profil: null,
            currentPage: 'dashboard',
            isPremium: false,
            isSuperAdmin: false,
            db: db,
            auth: auth,
            cpCache: {}
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        // Show/Hide Loading
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // Toast Notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2 transform translate-x-full transition-transform duration-300`;
            toast.innerHTML = `
                <span>${message}</span>
                <button class="ml-2 hover:opacity-75">&times;</button>
            `;
            
            toast.querySelector('button').onclick = () => toast.remove();
            container.appendChild(toast);
            
            // Animate in
            setTimeout(() => toast.classList.remove('translate-x-full'), 10);
            
            // Auto remove
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // Make showToast global
        window.showToast = showToast;

        // Modal Functions
        function showModal(content) {
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modalContainer').classList.remove('hidden');
        }
        
        window.showModal = showModal;

        function closeModal() {
            document.getElementById('modalContainer').classList.add('hidden');
        }
        
        window.closeModal = closeModal;

        // Toggle Sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }
        
        window.toggleSidebar = toggleSidebar;

        // Date utilities
        function getAutoTahunAjar() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            if (month >= 6) {
                return { tahunAwal: year, tahunAkhir: year + 1 };
            } else {
                return { tahunAwal: year - 1, tahunAkhir: year };
            }
        }
        
        window.getAutoTahunAjar = getAutoTahunAjar;

        function formatTahunAjar(tahunAwal) {
            return `${tahunAwal}/${parseInt(tahunAwal) + 1}`;
        }
        
        window.formatTahunAjar = formatTahunAjar;

        function formatDate(date, format = 'DD/MM/YYYY') {
            if (!date) return '';
            const d = date.toDate ? date.toDate() : new Date(date);
            if (isNaN(d.getTime())) return '';
            
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            
            const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                               'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            switch (format) {
                case 'DD/MM/YYYY':
                    return `${day}/${month}/${year}`;
                case 'YYYY-MM-DD':
                    return `${year}-${month}-${day}`;
                case 'DD MMMM YYYY':
                    return `${d.getDate()} ${monthNames[d.getMonth()]} ${year}`;
                case 'dddd, DD MMMM YYYY':
                    return `${dayNames[d.getDay()]}, ${d.getDate()} ${monthNames[d.getMonth()]} ${year}`;
                default:
                    return `${day}/${month}/${year}`;
            }
        }
        
        window.formatDate = formatDate;

        // Parse CSV
        function parseCSV(csvText, delimiter = ';') {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) return { headers: [], data: [] };
            
            const headers = lines[0].split(delimiter).map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = line.split(delimiter);
                const row = {};
                
                headers.forEach((header, index) => {
                    row[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
                });
                
                data.push(row);
            }
            
            return { headers, data };
        }
        
        window.parseCSV = parseCSV;

        // Fetch CSV from URL
        async function fetchCSV(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const text = await response.text();
                return parseCSV(text);
            } catch (error) {
                console.error('Error fetching CSV:', error);
                throw error;
            }
        }
        
        window.fetchCSV = fetchCSV;

        // Get Kelas Options based on jenjang
        function getKelasOptions(jenjang) {
            switch (jenjang) {
                case 'SD': return ['1', '2', '3', '4', '5', '6'];
                case 'SMP': return ['7', '8', '9'];
                case 'SMA':
                case 'SMK': return ['10', '11', '12'];
                default: return [];
            }
        }
        
        window.getKelasOptions = getKelasOptions;

        // Get Fase from Kelas
        function getFaseFromKelas(kelas, jenjang) {
            const kelasNum = parseInt(kelas);
            
            if (jenjang === 'SD') {
                if (kelasNum <= 2) return 'A';
                if (kelasNum <= 4) return 'B';
                return 'C';
            }
            if (jenjang === 'SMP') return 'D';
            if (jenjang === 'SMA' || jenjang === 'SMK') {
                if (kelasNum === 10) return 'E';
                return 'F';
            }
            return '';
        }
        
        window.getFaseFromKelas = getFaseFromKelas;

        // ============================================
        // AUTHENTICATION & DATA LOADING
        // ============================================
        
        async function loadUserData(uid) {
            const userDoc = await db.collection('users').doc(uid).get();
            if (userDoc.exists) {
                return userDoc.data();
            }
            return null;
        }

        async function loadProfil(uid) {
            const profilSnap = await db.collection(`users/${uid}/profil`).limit(1).get();
            if (!profilSnap.empty) {
                const doc = profilSnap.docs[0];
                return { id: doc.id, ...doc.data() };
            }
            return null;
        }

        function handleLogout() {
            if (confirm('Apakah Anda yakin ingin keluar?')) {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                });
            }
        }
        
        window.handleLogout = handleLogout;

        // ============================================
        // ROUTER / PAGE NAVIGATION
        // ============================================
        
        const pageTitles = {
            dashboard: 'Dashboard',
            profil: 'Profil Guru & Sekolah',
            kalender: 'Kalender Pendidikan',
            jadwal: 'Jadwal Pelajaran',
            siswa: 'Data Siswa',
            mapel: 'Mata Pelajaran & CP',
            atp: 'Alur Tujuan Pembelajaran (ATP)',
            prota: 'Program Tahunan (Prota)',
            promes: 'Program Semester (Promes)',
            'modul-ajar': 'Modul Ajar',
            jurnal: 'Jurnal Pembelajaran',
            kktp: 'KKTP',
            nilai: 'Daftar Nilai',
            'ai-assistant': 'AI Assistant',
            'super-admin': 'Super Admin Panel'
        };

        // Premium-only pages
        const premiumPages = ['promes', 'modul-ajar', 'jurnal', 'kktp', 'nilai'];

        function navigateTo(page) {
            // Check premium access
            if (premiumPages.includes(page) && !window.AGSA.isPremium && !window.AGSA.isSuperAdmin) {
                showUpgradeModal();
                return;
            }
            
            window.AGSA.currentPage = page;
            document.getElementById('pageTitle').textContent = pageTitles[page] || 'AGSA';
            
            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-blue-50', 'text-blue-600');
                if (link.dataset.page === page) {
                    link.classList.add('bg-blue-50', 'text-blue-600');
                }
            });
            
            // Render page
            renderPage(page);
            
            // Close mobile sidebar
            if (window.innerWidth < 1024) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
            
            // Update URL hash
            window.location.hash = page;
        }
        
        window.navigateTo = navigateTo;

        function renderPage(page) {
            switch(page) {
                case 'dashboard': renderDashboard(); break;
                case 'profil': renderProfil(); break;
                case 'kalender': renderKalender(); break;
                case 'jadwal': renderJadwal(); break;
                case 'siswa': renderSiswa(); break;
                case 'mapel': renderMapel(); break;
                case 'atp': renderATP(); break;
                case 'prota': renderProta(); break;
                case 'promes': renderPromes(); break;
                case 'modul-ajar': renderModulAjar(); break;
                case 'jurnal': renderJurnal(); break;
                case 'kktp': renderKKTP(); break;
                case 'nilai': renderNilai(); break;
                case 'ai-assistant': renderAIAssistant(); break;
                case 'super-admin': renderSuperAdmin(); break;
                default: renderDashboard();
            }
        }

        // Handle hash change
        window.addEventListener('hashchange', () => {
            const page = window.location.hash.slice(1) || 'dashboard';
            navigateTo(page);
        });

        // ============================================
        // UPGRADE MODAL
        // ============================================
        
        function showUpgradeModal() {
            const content = `
                <div class="p-6">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-purple-600 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900">Upgrade ke Premium</h3>
                        <p class="text-gray-600 mt-2">Akses semua fitur lengkap AGSA</p>
                    </div>
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex items-center space-x-3 text-gray-700">
                            <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            <span>Promes dengan sinkronisasi lengkap</span>
                        </div>
                        <div class="flex items-center space-x-3 text-gray-700">
                            <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            <span>Modul Ajar & LKPD Generator</span>
                        </div>
                        <div class="flex items-center space-x-3 text-gray-700">
                            <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            <span>Jurnal Auto Generate</span>
                        </div>
                        <div class="flex items-center space-x-3 text-gray-700">
                            <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            <span>KKTP & Daftar Nilai</span>
                        </div>
                        <div class="flex items-center space-x-3 text-gray-700">
                            <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            <span>Cetak dokumen + TTD otomatis</span>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="closeModal()" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                            Nanti
                        </button>
                        <button onclick="redirectToWhatsApp()" class="flex-1 px-4 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg font-medium hover:shadow-lg transition-all flex items-center justify-center space-x-2">
                            <span>Hubungi via WhatsApp</span>
                        </button>
                    </div>
                </div>
            `;
            showModal(content);
        }
        
        window.showUpgradeModal = showUpgradeModal;

        function redirectToWhatsApp() {
            const waNumber = '6281234567890';
            const message = encodeURIComponent(`Halo, saya ingin upgrade ke AGSA Premium.\n\nEmail: ${window.AGSA.user?.email || ''}\nNama: ${window.AGSA.user?.displayName || ''}`);
            window.open(`https://wa.me/${waNumber}?text=${message}`, '_blank');
            closeModal();
        }
        
        window.redirectToWhatsApp = redirectToWhatsApp;

        // ============================================
        // PAGE RENDERERS
        // ============================================

        // DASHBOARD
        function renderDashboard() {
            const content = `
                <div class="space-y-6 fade-in">
                    <!-- Welcome Card -->
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-6 text-white">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                            <div>
                                <h2 class="text-2xl font-bold mb-2">Selamat Datang, ${window.AGSA.user?.displayName?.split(' ')[0] || 'Guru'}! üëã</h2>
                                <p class="opacity-90">Kelola administrasi pembelajaran Anda dengan mudah dan cepat.</p>
                            </div>
                            <div class="mt-4 md:mt-0">
                                <a href="#profil" class="inline-flex items-center px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg transition-colors">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    Mulai Setup
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-xl p-4 border border-gray-100 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">ATP</p>
                                    <p id="statATP" class="text-2xl font-bold text-gray-900">0</p>
                                </div>
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl p-4 border border-gray-100 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Modul Ajar</p>
                                    <p id="statModul" class="text-2xl font-bold text-gray-900">0</p>
                                </div>
                                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl p-4 border border-gray-100 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Siswa</p>
                                    <p id="statSiswa" class="text-2xl font-bold text-gray-900">0</p>
                                </div>
                                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl p-4 border border-gray-100 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Kelas</p>
                                    <p id="statKelas" class="text-2xl font-bold text-gray-900">0</p>
                                </div>
                                <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <a href="#atp" class="bg-white rounded-xl p-6 border border-gray-100 hover:border-blue-500 hover:shadow-md transition-all group">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center group-hover:bg-blue-500 transition-colors">
                                    <svg class="w-6 h-6 text-blue-600 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900">Buat ATP Baru</h4>
                                    <p class="text-sm text-gray-500">Generate ATP dari CP</p>
                                </div>
                            </div>
                        </a>
                        
                        <a href="#modul-ajar" class="bg-white rounded-xl p-6 border border-gray-100 hover:border-green-500 hover:shadow-md transition-all group">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center group-hover:bg-green-500 transition-colors">
                                    <svg class="w-6 h-6 text-green-600 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900">Buat Modul Ajar</h4>
                                    <p class="text-sm text-gray-500">Sinkron dengan Promes</p>
                                </div>
                            </div>
                        </a>
                        
                        <a href="#ai-assistant" class="bg-white rounded-xl p-6 border border-gray-100 hover:border-purple-500 hover:shadow-md transition-all group">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center group-hover:bg-purple-500 transition-colors">
                                    <svg class="w-6 h-6 text-purple-600 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900">AI Assistant</h4>
                                    <p class="text-sm text-gray-500">Generate CSV & Template</p>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            `;
            
            document.getElementById('pageContent').innerHTML = content;
            loadDashboardStats();
        }

        async function loadDashboardStats() {
            if (!window.AGSA.user) return;
            const uid = window.AGSA.user.uid;
            
            try {
                const atpSnap = await db.collection(`users/${uid}/atp`).get();
                document.getElementById('statATP').textContent = atpSnap.size;
                
                const modulSnap = await db.collection(`users/${uid}/modulAjar`).get();
                document.getElementById('statModul').textContent = modulSnap.size;
                
                const siswaSnap = await db.collection(`users/${uid}/siswa`).get();
                document.getElementById('statSiswa').textContent = siswaSnap.size;
                
                const kelasSnap = await db.collection(`users/${uid}/kelas`).get();
                document.getElementById('statKelas').textContent = kelasSnap.size;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // ATP PAGE
        function renderATP() {
            const content = `
                <div class="max-w-6xl mx-auto space-y-6 fade-in">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900">Alur Tujuan Pembelajaran (ATP)</h2>
                            <p class="text-gray-600">Generate ATP dari Capaian Pembelajaran</p>
                        </div>
                        <button onclick="showGenerateATPModal()" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Generate ATP Baru
                        </button>
                    </div>

                    <div id="atpList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="col-span-full text-center py-12 text-gray-500">
                            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p>Memuat data ATP...</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('pageContent').innerHTML = content;
            loadATPList();
        }

        async function loadATPList() {
            if (!window.AGSA.user) return;
            const uid = window.AGSA.user.uid;
            
            try {
                const atpSnap = await db.collection(`users/${uid}/atp`).orderBy('createdAt', 'desc').get();
                const atpList = document.getElementById('atpList');
                
                if (atpSnap.empty) {
                    atpList.innerHTML = `
                        <div class="col-span-full text-center py-12 text-gray-500">
                            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p>Belum ada ATP yang dibuat.</p>
                            <p class="text-sm">Klik tombol "Generate ATP Baru" untuk memulai.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                atpSnap.forEach(doc => {
                    const atp = { id: doc.id, ...doc.data() };
                    html += `
                        <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition-shadow">
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <h4 class="font-semibold text-gray-900">${atp.namaMapel || 'Unnamed'}</h4>
                                    <p class="text-sm text-gray-500">Kelas ${atp.kelas || '-'} | Fase ${atp.fase || '-'}</p>
                                </div>
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${atp.status === 'final' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                                    ${atp.status === 'final' ? 'Final' : 'Draft'}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">Total: ${atp.totalJP || 0} JP</p>
                            <div class="flex space-x-2">
                                <button onclick="viewATP('${atp.id}')" class="flex-1 px-3 py-2 text-sm bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors">
                                    Lihat
                                </button>
                                <button onclick="printATP('${atp.id}')" class="px-3 py-2 text-sm bg-gray-50 text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                                    </svg>
                                </button>
                                <button onclick="deleteATP('${atp.id}')" class="px-3 py-2 text-sm bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                atpList.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading ATP:', error);
                showToast('Gagal memuat data ATP', 'error');
            }
        }

        // ATP Functions - Made Global
        function showGenerateATPModal() {
            const jenjang = window.AGSA.profil?.jenjang || 'SMP';
            const kelasOptions = getKelasOptions(jenjang);
            
            const modalContent = `
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">Generate ATP Baru</h3>
                    
                    <form id="formGenerateATP" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Mata Pelajaran</label>
                            <input type="text" id="atpNamaMapel" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                placeholder="Contoh: Matematika">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fase</label>
                                <select id="atpFase" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Fase</option>
                                    <option value="A">Fase A</option>
                                    <option value="B">Fase B</option>
                                    <option value="C">Fase C</option>
                                    <option value="D">Fase D</option>
                                    <option value="E">Fase E</option>
                                    <option value="F">Fase F</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                <select id="atpKelas" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Kelas</option>
                                    ${kelasOptions.map(k => `<option value="${k}">${k}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                            <select id="atpSemester" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="Ganjil-Genap">Ganjil & Genap (1 Tahun)</option>
                                <option value="1">Semester 1 (Ganjil)</option>
                                <option value="2">Semester 2 (Genap)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Capaian Pembelajaran (CP)</label>
                            <textarea id="atpCP" rows="3" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                placeholder="Masukkan CP..."></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tujuan Pembelajaran (pisahkan dengan enter)</label>
                            <textarea id="atpTP" rows="5" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                placeholder="TP 1: ...&#10;TP 2: ...&#10;TP 3: ..."></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Total JP</label>
                            <input type="number" id="atpTotalJP" value="32" min="1"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                Batal
                            </button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Generate ATP
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showModal(modalContent);
            
            document.getElementById('formGenerateATP').addEventListener('submit', handleGenerateATP);
        }
        
        window.showGenerateATPModal = showGenerateATPModal;

        async function handleGenerateATP(e) {
            e.preventDefault();
            
            const namaMapel = document.getElementById('atpNamaMapel').value;
            const fase = document.getElementById('atpFase').value;
            const kelas = document.getElementById('atpKelas').value;
            const semester = document.getElementById('atpSemester').value;
            const cp = document.getElementById('atpCP').value;
            const tpText = document.getElementById('atpTP').value;
            const totalJP = parseInt(document.getElementById('atpTotalJP').value);
            
            // Parse TP
            const tpLines = tpText.split('\n').filter(line => line.trim());
            const tpList = tpLines.map((line, idx) => ({
                kode: `TP.${idx + 1}`,
                deskripsi: line.trim(),
                alokasiWaktu: Math.floor(totalJP / tpLines.length)
            }));
            
            const tahunAjar = window.AGSA.profil?.tahunAjarAwal ? 
                formatTahunAjar(window.AGSA.profil.tahunAjarAwal) : 
                formatTahunAjar(getAutoTahunAjar().tahunAwal);
            
            const atpData = {
                namaMapel,
                fase,
                kelas,
                semester,
                tahunAjar,
                alurTP: [{
                    urutan: 1,
                    elemen: 'Elemen Utama',
                    cp: cp,
                    tp: tpList
                }],
                totalJP,
                status: 'draft',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                showLoading();
                closeModal();
                
                const uid = window.AGSA.user.uid;
                await db.collection(`users/${uid}/atp`).add(atpData);
                
                showToast('ATP berhasil dibuat!', 'success');
                loadATPList();
                
            } catch (error) {
                console.error('Error creating ATP:', error);
                showToast('Gagal membuat ATP', 'error');
            } finally {
                hideLoading();
            }
        }

        async function viewATP(atpId) {
            showToast('Fitur lihat detail ATP dalam pengembangan', 'info');
            // TODO: Implement view ATP detail
        }
        
        window.viewATP = viewATP;

        async function printATP(atpId) {
            showToast('Fitur cetak ATP dalam pengembangan', 'info');
            // TODO: Implement print ATP
        }
        
        window.printATP = printATP;

        async function deleteATP(atpId) {
            if (!confirm('Hapus ATP ini?')) return;
            
            try {
                showLoading();
                const uid = window.AGSA.user.uid;
                await db.collection(`users/${uid}/atp`).doc(atpId).delete();
                showToast('ATP berhasil dihapus', 'success');
                loadATPList();
            } catch (error) {
                console.error('Error deleting ATP:', error);
                showToast('Gagal menghapus ATP', 'error');
            } finally {
                hideLoading();
            }
        }
        
        window.deleteATP = deleteATP;

        // MAPEL PAGE
        function renderMapel() {
            const content = `
                <div class="max-w-6xl mx-auto space-y-6 fade-in">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900">Mata Pelajaran & CP</h2>
                            <p class="text-gray-600">Kelola mata pelajaran dan Capaian Pembelajaran</p>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="loadCPFromDatabase()" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                                Load CP dari Database
                            </button>
                        </div>
                    </div>

                    <!-- Jenjang Selector -->
                    <div class="bg-white rounded-xl border border-gray-200 p-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Jenjang</label>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="selectJenjang('SD')" class="jenjang-btn px-4 py-2 rounded-lg border border-gray-300 hover:border-blue-500 hover:bg-blue-50 transition-colors" data-jenjang="SD">
                                SD (Kelas 1-6)
                            </button>
                            <button onclick="selectJenjang('SMP')" class="jenjang-btn px-4 py-2 rounded-lg border border-gray-300 hover:border-blue-500 hover:bg-blue-50 transition-colors" data-jenjang="SMP">
                                SMP (Kelas 7-9)
                            </button>
                            <button onclick="selectJenjang('SMA')" class="jenjang-btn px-4 py-2 rounded-lg border border-gray-300 hover:border-blue-500 hover:bg-blue-50 transition-colors" data-jenjang="SMA">
                                SMA (Kelas 10-12)
                            </button>
                            <button onclick="selectJenjang('SMK')" class="jenjang-btn px-4 py-2 rounded-lg border border-gray-300 hover:border-blue-500 hover:bg-blue-50 transition-colors" data-jenjang="SMK">
                                SMK (Kelas 10-12)
                            </button>
                        </div>
                    </div>

                    <!-- Mapel List -->
                    <div id="mapelList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="col-span-full text-center py-8 text-gray-500">
                            Pilih jenjang untuk melihat daftar mata pelajaran
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('pageContent').innerHTML = content;
            
            // Auto select jenjang from profil
            if (window.AGSA.profil?.jenjang) {
                selectJenjang(window.AGSA.profil.jenjang);
            }
        }

        async function selectJenjang(jenjang) {
            // Update button states
            document.querySelectorAll('.jenjang-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                if (btn.dataset.jenjang === jenjang) {
                    btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                }
            });
            
            const mapelList = document.getElementById('mapelList');
            mapelList.innerHTML = `
                <div class="col-span-full text-center py-8">
                    <div class="spinner mx-auto"></div>
                    <p class="text-gray-500 mt-4">Memuat data CP ${jenjang}...</p>
                </div>
            `;
            
            try {
                // Check cache first
                if (window.AGSA.cpCache[jenjang]) {
                    renderMapelList(window.AGSA.cpCache[jenjang], jenjang);
                    return;
                }
                
                const csvUrl = CSV_LINKS[jenjang];
                const data = await fetchCSV(csvUrl);
                
                // Cache the data
                window.AGSA.cpCache[jenjang] = data;
                
                renderMapelList(data, jenjang);
                
            } catch (error) {
                console.error('Error loading CP:', error);
                mapelList.innerHTML = `
                    <div class="col-span-full text-center py-8 text-red-500">
                        Gagal memuat data. Silakan coba lagi.
                    </div>
                `;
            }
        }
        
        window.selectJenjang = selectJenjang;

        function renderMapelList(data, jenjang) {
            const mapelList = document.getElementById('mapelList');
            
            // Group by mata pelajaran
            const mapelGroups = {};
            data.data.forEach(row => {
                const mapel = row['Mata Pelajaran'];
                if (!mapel) return;
                if (!mapelGroups[mapel]) {
                    mapelGroups[mapel] = [];
                }
                mapelGroups[mapel].push(row);
            });
            
            let html = '';
            Object.keys(mapelGroups).forEach(mapel => {
                const items = mapelGroups[mapel];
                const fases = [...new Set(items.map(i => i.Fase).filter(Boolean))].join(', ');
                
                html += `
                    <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="showMapelDetail('${encodeURIComponent(mapel)}', '${jenjang}')">
                        <div class="flex items-start justify-between">
                            <div>
                                <h4 class="font-semibold text-gray-900">${mapel}</h4>
                                <p class="text-sm text-gray-500 mt-1">Fase: ${fases || '-'}</p>
                                <p class="text-sm text-gray-500">${items.length} CP tersedia</p>
                            </div>
                            <button onclick="event.stopPropagation(); addMapelToATP('${encodeURIComponent(mapel)}', '${jenjang}')" class="text-blue-600 hover:text-blue-800 p-2">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            mapelList.innerHTML = html || '<div class="col-span-full text-center py-8 text-gray-500">Tidak ada data</div>';
        }

        function showMapelDetail(encodedMapel, jenjang) {
            const mapel = decodeURIComponent(encodedMapel);
            const data = window.AGSA.cpCache[jenjang];
            
            if (!data) {
                showToast('Data tidak ditemukan', 'error');
                return;
            }
            
            const items = data.data.filter(row => row['Mata Pelajaran'] === mapel);
            
            const modalContent = `
                <div class="p-6 max-h-[80vh] overflow-auto">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">${mapel}</h3>
                    
                    <div class="space-y-4">
                        ${items.map((item, idx) => `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex justify-between text-sm text-gray-500 mb-2">
                                    <span>Fase ${item.Fase || '-'}</span>
                                    <span>Kelas ${item.Kelas || '-'}</span>
                                    <span>Semester ${item.Semester || '-'}</span>
                                </div>
                                <p class="font-medium text-gray-900 mb-2">${item['Elemen/Bab'] || '-'}</p>
                                <p class="text-gray-700 mb-2"><strong>CP:</strong> ${item.CP || '-'}</p>
                                <p class="text-gray-700 mb-2"><strong>TP:</strong> ${item.TP || '-'}</p>
                                <p class="text-xs text-purple-600">${item['8 Dimensi Profil Lulusan'] || '-'}</p>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="flex justify-end mt-4">
                        <button onclick="closeModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        window.showMapelDetail = showMapelDetail;

        function addMapelToATP(encodedMapel, jenjang) {
            const mapel = decodeURIComponent(encodedMapel);
            showToast(`Fitur tambah ${mapel} ke ATP dalam pengembangan`, 'info');
        }
        
        window.addMapelToATP = addMapelToATP;

        function loadCPFromDatabase() {
            const jenjang = window.AGSA.profil?.jenjang || 'SMP';
            selectJenjang(jenjang);
            showToast('Memuat data CP dari database...', 'info');
        }
        
        window.loadCPFromDatabase = loadCPFromDatabase;

        // Placeholder render functions for other pages
        function renderProfil() {
            document.getElementById('pageContent').innerHTML = `
                <div class="max-w-4xl mx-auto fade-in">
                    <div class="bg-white rounded-xl border p-6">
                        <h2 class="text-xl font-semibold mb-4">Profil Guru & Sekolah</h2>
                        <p class="text-gray-600">Halaman ini dalam pengembangan...</p>
                    </div>
                </div>
            `;
        }

        function renderKalender() {
            document.getElementById('pageContent').innerHTML = `
                <div class="max-w-6xl mx-auto fade-in">
                    <div class="bg-white rounded-xl border p-6">
                        <h2 class="text-xl font-semibold mb-4">Kalender Pendidikan</h2>
                        <p class="text-gray-600">Halaman ini dalam pengembangan...</p>
                    </div>
                </div>
            `;
        }

        function renderJadwal() {
            document.getElementById('pageContent').innerHTML = `
                <div class="max-w-6xl mx-auto fade-in">
                    <div class="bg-white rounded-xl border p-6">
                        <h2 class="text-xl font-semibold mb-4">Jadwal Pelajaran</h2>
                        <p class="text-gray-600">Halaman ini dalam pengembangan...</p>
                    </div>
                </div>
            `;
        }

        function renderSiswa() {
            document.getElementById('pageContent').innerHTML = `
                <div class="max-w-6xl mx-auto fade-in">
                    <div class="bg-white rounded-xl border p-6">
                        <h2 class="text-xl font-semibold mb-4">Data Siswa</h2>
                        <p class="text-gray-600">Halaman ini dalam pengembangan...</p>
                    </div>
                </div>
            `;
        }

        function renderProta() {
            document.getElementById('pageContent').innerHTML = `
                <div class="max-w-6xl mx-auto fade-in">
                    <div class="bg-white rounded-xl border p-6">
                        <h2 class="text-xl font-semibold mb-4">Program Tahunan (Prota)</h2>
                        <p class="text-gray-600">Halaman ini dalam pengembangan...</p>
                    </div>
                </div>
            `;
        }

        function renderPromes() {
            document.getElementById('pageContent').innerHTML = `
                <div class="max-w-6xl mx-auto fade-in">
                    <div class="bg-white rounded-xl border p-6">
                        <h2 class="text-xl font-semibold mb-4">Program Semester (Promes)</h2>
                        <p class="text-gray-600">Halaman ini dalam pengembangan... (Premium Feature)</p>
                    </div>
                </div>
            `;
        }

        function renderModulAjar() {
            document.getElementById('pageContent').innerHTML = `
                <div class="max-w-6xl mx-auto fade-in">
                    <div class="bg-white rounded-xl border p-6">
                        <h2 class="text-xl font-semibold mb-4">Modul Ajar</h2>
                        <p class="text-gray-600">Halaman ini dalam pengembangan... (Premium Feature)</p>
                    </div>
                </div>
            `;
        }

        function renderJurnal() {
            document.getElementById('pageContent').innerHTML = `
                <div class="max-w-6xl mx-auto fade-in">
                    <div class="bg-white rounded-xl border p-6">
                        <h2 class="text-xl font-semibold mb-4">Jurnal Pembelajaran</h2>
                        <p class="text-gray-600">Halaman ini dalam pengembangan... (Premium Feature)</p>
                    </div>
                </div>
            `;
        }

        function renderKKTP() {
            document.getElementById('pageContent').innerHTML = `
                <div class="max-w-6xl mx-auto fade-in">
                    <div class="bg-white rounded-xl border p-6">
                        <h2 class="text-xl font-semibold mb-4">KKTP</h2>
                        <p class="text-gray-600">Halaman ini dalam pengembangan... (Premium Feature)</p>
                    </div>
                </div>
            `;
        }

        function renderNilai() {
            document.getElementById('pageContent').innerHTML = `
                <div class="max-w-6xl mx-auto fade-in">
                    <div class="bg-white rounded-xl border p-6">
                        <h2 class="text-xl font-semibold mb-4">Daftar Nilai</h2>
                        <p class="text-gray-600">Halaman ini dalam pengembangan... (Premium Feature)</p>
                    </div>
                </div>
            `;
        }

        function renderAIAssistant() {
            document.getElementById('pageContent').innerHTML = `
                <div class="max-w-4xl mx-auto fade-in">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-blue-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">AI Assistant</h2>
                        <p class="text-gray-600">Bantu generate format CSV dan template dokumen</p>
                    </div>
                    
                    <div class="bg-white rounded-xl border p-6">
                        <p class="text-gray-600">Fitur AI Assistant dalam pengembangan...</p>
                    </div>
                </div>
            `;
        }

        function renderSuperAdmin() {
            if (!window.AGSA.isSuperAdmin) {
                document.getElementById('pageContent').innerHTML = `
                    <div class="text-center py-12">
                        <p class="text-red-600">Akses ditolak. Anda bukan Super Admin.</p>
                    </div>
                `;
                return;
            }
            
            document.getElementById('pageContent').innerHTML = `
                <div class="max-w-6xl mx-auto fade-in">
                    <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-6">
                        <p class="text-red-800 font-medium">‚ö†Ô∏è Area Super Admin - Hanya untuk pengelolaan sistem</p>
                    </div>
                    <div class="bg-white rounded-xl border p-6">
                        <h2 class="text-xl font-semibold mb-4">Super Admin Panel</h2>
                        <p class="text-gray-600">Halaman ini dalam pengembangan...</p>
                    </div>
                </div>
            `;
        }

        // ============================================
        // EVENT LISTENERS & INITIALIZATION
        // ============================================
        
        // Sidebar toggle events
        document.getElementById('menuToggleBtn').addEventListener('click', toggleSidebar);
        document.getElementById('closeSidebarBtn').addEventListener('click', toggleSidebar);
        document.getElementById('sidebarOverlay').addEventListener('click', toggleSidebar);
        document.getElementById('modalOverlay').addEventListener('click', closeModal);
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        document.getElementById('upgradeBtn').addEventListener('click', showUpgradeModal);

        // Nav link clicks
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = link.getAttribute('href').replace('#', '');
                navigateTo(page);
            });
        });

        // ============================================
        // AUTH STATE LISTENER
        // ============================================
        
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                window.AGSA.user = user;
                
                // Load user data
                const userData = await loadUserData(user.uid);
                window.AGSA.userData = userData;
                
                // Check subscription
                window.AGSA.isPremium = userData?.subscription?.type === 'premium';
                window.AGSA.isSuperAdmin = userData?.role === 'superadmin' || user.email === SUPER_ADMIN_EMAIL;
                
                // Load profil
                const profil = await loadProfil(user.uid);
                window.AGSA.profil = profil;
                
                // Update UI
                document.getElementById('userPhoto').src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'User')}`;
                document.getElementById('userName').textContent = user.displayName || 'User';
                document.getElementById('userPlan').textContent = window.AGSA.isPremium ? '‚≠ê Premium' : 'Free';
                
                // Show/hide admin menu
                if (window.AGSA.isSuperAdmin) {
                    document.getElementById('adminMenu').classList.remove('hidden');
                }
                
                // Show/hide upgrade button
                if (!window.AGSA.isPremium && !window.AGSA.isSuperAdmin) {
                    document.getElementById('upgradeBtn').classList.remove('hidden');
                }
                
                // Set tahun ajar display
                if (profil?.tahunAjarAwal) {
                    document.getElementById('tahunAjarText').textContent = `TA ${profil.tahunAjarAwal}/${profil.tahunAjarAwal + 1}`;
                    document.getElementById('tahunAjarDisplay').classList.remove('hidden');
                }
                
                // Show app
                hideLoading();
                document.getElementById('app').classList.remove('hidden');
                
                // Navigate to initial page
                const hash = window.location.hash.slice(1) || 'dashboard';
                navigateTo(hash);
                
            } else {
                // Not logged in, redirect to login
                window.location.href = 'index.html';
            }
        });

    </script>
</body>
</html>